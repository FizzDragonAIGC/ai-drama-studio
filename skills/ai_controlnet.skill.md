# 🎛️ ControlNet详解 Skill
> 来源：ControlNet论文 + Stable Diffusion社区实践

---

## 📐 ControlNet原理

| 概念 | 说明 |
|------|------|
| 定义 | 神经网络控制模块 |
| 作用 | 精确控制图像生成结构 |
| 原理 | 锁定扩散过程的空间结构 |
| 优势 | 保持创意同时控制构图 |

---

## 🎯 核心控制类型

| 类型 | 输入 | 控制内容 | 适用场景 |
|------|------|----------|----------|
| Canny | 边缘线稿 | 轮廓结构 | 建筑、机械 |
| OpenPose | 人体姿态 | 人物动作 | 角色摆姿 |
| Depth | 深度图 | 空间关系 | 场景构图 |
| Scribble | 涂鸦草图 | 大致布局 | 快速概念 |
| Lineart | 线稿 | 精确线条 | 漫画上色 |
| SoftEdge | 柔边线稿 | 柔和轮廓 | 自然物体 |
| Tile | 纹理细节 | 局部放大 | 高清修复 |
| IP-Adapter | 参考图像 | 风格/角色 | 一致性 |

---

## 🎬 番剧制作应用

### OpenPose（动作控制）
```
【使用场景】
- 角色统一姿势
- 多角度同动作
- 表情差分图

【流程】
1. 绘制/获取骨骼图
2. 加载OpenPose模型
3. 输入骨骼图 + 角色描述
4. 调整Control权重
```

### 骨骼点说明
```
关键点：
- 鼻子、眼睛、耳朵
- 肩膀、肘部、手腕
- 臀部、膝盖、脚踝

颜色编码：
红/黄/绿/蓝等表示不同关节
```

---

## 📋 Depth深度控制

### 深度图解读
```
白色 = 近
黑色 = 远
灰度过渡 = 距离变化
```

### 应用场景
| 场景 | 用法 |
|------|------|
| 室内场景 | 控制前后景关系 |
| 人物构图 | 确定人物位置 |
| 多层背景 | 分层透视 |

### 生成方法
```
- MiDaS深度估计
- 手绘灰度图
- 3D软件渲染
```

---

## 🔧 参数调优

### Control权重（Weight）
| 值 | 效果 |
|----|------|
| 0.3-0.5 | 轻度参考，保留创意 |
| 0.6-0.8 | 平衡，推荐范围 |
| 0.9-1.2 | 严格遵循，可能僵硬 |

### 起止步数
```
Starting Step: 0（从头控制）
Ending Step: 0.8-1.0（控制到什么时候）

技巧：早期控制结构，后期释放细节
```

### Control模式
| 模式 | 说明 |
|------|------|
| Balanced | 平衡，默认选择 |
| More Prompt | 更遵循文字 |
| More Control | 更遵循控制图 |

---

## 🎨 多ControlNet组合

### 组合示例
```
【姿势+场景】
OpenPose（人物姿态）+ Depth（场景空间）
权重：0.7 + 0.5

【线稿+风格】
Lineart（精确轮廓）+ IP-Adapter（风格参考）
权重：0.8 + 0.6
```

### 权重分配原则
```
主控制器：较高权重（0.7-1.0）
辅助控制器：较低权重（0.3-0.6）
总权重建议不超过1.5
```

---

## 📋 常用预处理器

| 预处理器 | 作用 | 输入 |
|----------|------|------|
| canny | 提取边缘 | 任意图片 |
| openpose | 检测姿态 | 人物照片 |
| depth_midas | 估计深度 | 任意图片 |
| lineart_realistic | 提取线稿 | 照片 |
| lineart_anime | 动漫线稿 | 动漫图 |
| scribble_hed | 涂鸦化 | 任意图片 |

---

## 💡 工作流建议

### 角色一致性流程
```
1. 生成角色设定图
2. 使用IP-Adapter提取角色特征
3. 用OpenPose控制新姿势
4. 权重：IP-Adapter 0.6 + OpenPose 0.8
```

### 分镜制作流程
```
1. 绘制分镜草图
2. 提取各帧的控制信息
   - 人物：OpenPose
   - 场景：Depth
   - 构图：Scribble
3. 批量生成
```

---

## ⚠️ 常见问题

| 问题 | 解决 |
|------|------|
| 控制太死板 | 降低权重 |
| 控制不起作用 | 检查模型匹配 |
| 多控制冲突 | 调整权重比例 |
| 预处理失败 | 检查图片质量 |

---

## 🛠️ ComfyUI节点

```
常用节点：
- Load ControlNet Model
- Apply ControlNet
- ControlNet Preprocessor
- Multi-ControlNet Stack
```

---

*Skill版本: 1.0*
*适用: Stable Diffusion WebUI / ComfyUI*
*创建时间: 2026-02-14*
