<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FizzDragon AI Drama Studio</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#0a0a0c;--surface:#111114;--surface2:#1a1a1f;
            --border:#2a2a32;--text:#f0f0f2;--dim:#888890;
            --primary:#ff6b35;--primary-dark:#e55a2b;
            --success:#22c55e;--cyan:#06b6d4;--pink:#ec4899;--purple:#a855f7;
            --warning:#eab308;
            --radius:10px;--radius-sm:6px;
        }
        body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
        
        /* Layout */
        .app{display:grid;grid-template-columns:280px 1fr 260px;height:100vh}
        
        /* Left Panel - Agents */
        .panel-left{background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;padding:20px}
        .panel-left h2{font-size:12px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px}
        .agent-group{margin-bottom:20px}
        .agent-group-title{font-size:11px;color:var(--dim);margin-bottom:8px;padding-left:4px}
        .agent-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:var(--radius-sm);margin-bottom:4px;cursor:default;transition:all .2s}
        .agent-item.active{background:var(--primary);color:#fff}
        .agent-item.done{opacity:.6}
        .agent-item.done::after{content:'âœ“';margin-left:auto;color:var(--success);font-size:11px}
        .agent-item .icon{width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:14px}
        .agent-item .name{font-size:12px}
        .agent-item .step{font-size:10px;color:var(--dim);margin-left:auto}
        .agent-item.active .step{color:rgba(255,255,255,.7)}
        
        /* Center - Main Chat */
        .panel-center{display:flex;flex-direction:column;overflow:hidden}
        .header{padding:16px 24px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .header-left{display:flex;align-items:center;gap:16px}
        .logo{font-size:18px;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .phase-indicator{font-size:12px;color:var(--dim);padding:4px 12px;background:var(--surface2);border-radius:20px}
        .header-right{display:flex;gap:8px}
        .lang-btn{padding:6px 12px;background:transparent;border:1px solid var(--border);color:var(--dim);border-radius:var(--radius-sm);cursor:pointer;font-size:11px}
        .lang-btn.active{background:var(--primary);border-color:var(--primary);color:#fff}
        
        .chat-area{flex:1;overflow-y:auto;padding:24px}
        .chat-area::-webkit-scrollbar{width:6px}
        .chat-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
        
        .message{margin-bottom:24px;animation:fadeIn .3s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
        .msg-agent{display:flex;gap:12px}
        .msg-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),var(--pink));border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
        .msg-body{flex:1}
        .msg-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
        .msg-name{font-size:11px;font-weight:600;color:var(--primary);text-transform:uppercase;letter-spacing:.5px}
        .msg-time{font-size:10px;color:var(--dim)}
        .msg-content{background:var(--surface);border:1px solid var(--border);padding:16px 20px;border-radius:var(--radius);border-top-left-radius:2px}
        .msg-content h3{font-size:15px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
        .msg-content p{color:var(--dim);font-size:13px;margin-bottom:10px;line-height:1.7}
        .msg-content ul,.msg-content ol{margin:12px 0;padding-left:20px}
        .msg-content li{color:var(--dim);font-size:13px;margin-bottom:6px}
        .msg-content strong{color:var(--text)}
        .msg-user{justify-content:flex-end}
        .msg-user .msg-content{background:var(--primary);border:none;color:#fff;max-width:70%;border-radius:var(--radius);border-top-right-radius:2px}
        .msg-user .msg-content p{color:rgba(255,255,255,.9)}
        
        /* Report Box */
        .report{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin:16px 0}
        .report h4{font-size:13px;color:var(--primary);margin-bottom:12px;display:flex;align-items:center;gap:6px}
        .report-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
        .report-stat{background:var(--bg);padding:12px;border-radius:var(--radius-sm);text-align:center}
        .report-stat .val{font-size:22px;font-weight:700;color:var(--primary)}
        .report-stat .label{font-size:11px;color:var(--dim);margin-top:4px}
        .report-item{background:var(--bg);padding:12px;border-radius:var(--radius-sm);margin:8px 0}
        .report-item h5{font-size:13px;color:var(--text);margin-bottom:4px}
        .report-item p{font-size:12px;color:var(--dim)}
        .report-item .tag{display:inline-block;font-size:10px;padding:2px 8px;background:var(--surface);border-radius:10px;color:var(--cyan);margin-right:4px}
        
        /* Actions */
        .actions{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
        .btn{padding:10px 20px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:var(--radius);cursor:pointer;font-size:12px;font-weight:500;transition:all .2s}
        .btn:hover{border-color:var(--primary);background:rgba(255,107,53,.1)}
        .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--primary-dark)}
        .btn-secondary{border-color:var(--cyan);color:var(--cyan)}
        .btn-secondary:hover{background:rgba(6,182,212,.1)}
        
        .input-area{padding:16px 24px;background:var(--surface);border-top:1px solid var(--border)}
        .input-wrap{display:flex;gap:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:6px}
        .input-wrap:focus-within{border-color:var(--primary)}
        .input-wrap textarea{flex:1;background:transparent;border:none;padding:10px;color:var(--text);font-size:13px;resize:none;outline:none;font-family:inherit}
        .input-wrap button{background:var(--primary);border:none;padding:10px 20px;color:#fff;font-weight:500;border-radius:var(--radius-sm);cursor:pointer}
        
        /* Right Panel - Skills & Progress */
        .panel-right{background:var(--surface);border-left:1px solid var(--border);overflow-y:auto;padding:20px}
        .panel-right h2{font-size:12px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px}
        .progress-section{margin-bottom:24px}
        .progress-bar-wrap{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;margin-bottom:8px}
        .progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--pink));transition:width .5s}
        .progress-label{font-size:11px;color:var(--dim)}
        .chapter-nav{margin:16px 0}
        .chapter-btn{display:block;width:100%;padding:10px 12px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:var(--radius-sm);cursor:pointer;font-size:12px;text-align:left;margin-bottom:6px;transition:all .2s}
        .chapter-btn.active{border-color:var(--primary);background:rgba(255,107,53,.1)}
        .chapter-btn.done{opacity:.6}
        .chapter-btn.done::after{content:' âœ“';color:var(--success)}
        
        .skills-section{margin-top:24px}
        .skill-tag{display:inline-block;font-size:10px;padding:4px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--dim);margin:2px}
        .skill-tag.active{border-color:var(--cyan);color:var(--cyan);background:rgba(6,182,212,.1)}
        
        .export-section{margin-top:24px;padding-top:16px;border-top:1px solid var(--border)}
        .export-btn{width:100%;padding:12px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:var(--radius);cursor:pointer;font-size:12px;margin-bottom:8px}
        .export-btn:hover{border-color:var(--success);color:var(--success)}
        
        /* Modal */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:100;padding:24px}
        .modal.hide{display:none}
        .modal-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);width:100%;max-width:600px}
        .modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-header h2{font-size:16px}
        .modal-close{background:none;border:none;color:var(--dim);font-size:20px;cursor:pointer}
        .modal-body{padding:20px}
        .modal-body textarea{width:100%;height:200px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;color:var(--text);font-size:13px;resize:vertical}
        .modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
        
        /* Storyboard Table */
        .storyboard{margin:16px 0}
        .shot-row{display:grid;grid-template-columns:60px 1fr 1fr 1fr;gap:8px;padding:10px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:6px;font-size:12px}
        .shot-row.header{background:var(--surface2);font-weight:600;color:var(--text)}
        .shot-num{color:var(--primary);font-weight:600}
        .shot-cell{color:var(--dim)}
        .shot-cell.highlight{color:var(--cyan)}
        
        @media(max-width:1024px){.app{grid-template-columns:1fr}.panel-left,.panel-right{display:none}}
    </style>
</head>
<body>
<div class="app">
    <!-- Left Panel: Agents -->
    <aside class="panel-left">
        <h2>ğŸ¤– Agents</h2>
        <div id="agentList"></div>
    </aside>
    
    <!-- Center: Main Chat -->
    <main class="panel-center">
        <header class="header">
            <div class="header-left">
                <div class="logo">FizzDragon</div>
                <span class="phase-indicator" id="phaseIndicator">æº–å‚™é–‹å§‹</span>
            </div>
            <div class="header-right">
                <button class="lang-btn active" onclick="setLang('zh')">ç®€ä½“</button>
                <button class="lang-btn" onclick="setLang('tw')">ç¹é«”</button>
                <button class="lang-btn" onclick="setLang('en')">EN</button>
            </div>
        </header>
        <div class="chat-area" id="chatArea"></div>
        <div class="input-area">
            <div class="input-wrap">
                <textarea id="userInput" rows="2" placeholder="è¼¸å…¥ä½ çš„æƒ³æ³•...ï¼ˆå°è©±å¼ï¼Œè‡ªç”±å›ç­”ï¼‰"></textarea>
                <button onclick="sendMessage()">ç™¼é€</button>
            </div>
        </div>
    </main>
    
    <!-- Right Panel: Skills & Progress -->
    <aside class="panel-right">
        <h2>ğŸ“Š é€²åº¦</h2>
        <div class="progress-section">
            <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
            <div class="progress-label" id="progressLabel">0% å®Œæˆ</div>
        </div>
        
        <h2>ğŸ“‘ ç« ç¯€</h2>
        <div class="chapter-nav" id="chapterNav"></div>
        
        <h2>ğŸ› ï¸ ç•¶å‰Skills</h2>
        <div class="skills-section" id="skillsList"></div>
        
        <div class="export-section">
            <button class="export-btn" onclick="exportChapter()">ğŸ“¥ å°å‡ºç•¶å‰ç« ç¯€</button>
            <button class="export-btn" onclick="exportAll()">ğŸ“¦ å°å‡ºå®Œæ•´é …ç›®</button>
        </div>
    </aside>
</div>

<!-- Import Modal -->
<div class="modal" id="modal">
    <div class="modal-box">
        <div class="modal-header">
            <h2>ğŸ“š å°å…¥åŠ‡æœ¬</h2>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <textarea id="scriptInput" placeholder="è²¼ä¸Šä½ çš„å°èªªã€åŠ‡æœ¬æˆ–æ•…äº‹å¤§ç¶±..."></textarea>
            <p style="font-size:11px;color:var(--dim);margin-top:8px">æ”¯æŒä»»æ„é•·åº¦çš„æ–‡æœ¬ï¼Œç³»çµ±æœƒè‡ªå‹•åˆ†æçµæ§‹</p>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="loadDemo()">è¼‰å…¥ç¤ºä¾‹</button>
            <button class="btn btn-primary" onclick="startProject()">é–‹å§‹é …ç›®</button>
        </div>
    </div>
</div>

<script>
// ==================== ç³»çµ±é…ç½® ====================

// 29å€‹AgentåŠå…¶è·è²¬å’Œå‡ºå ´éšæ®µ
const AGENTS = [
    // çµ±ç±Œçµ„ - å…¨ç¨‹ (2)
    {id:'director', icon:'ğŸ¬', name:'ç¸½å°æ¼”', group:'çµ±ç±Œ', phase:'å…¨ç¨‹', skills:[
        'directing_visual_storytelling','directing_blocking','directing_actor_direction','directing_climax',
        'directing_emotional_arc','directing_pacing','directing_tone','director_kubrick','director_wong_karwai',
        'director_miyazaki','director_shinkai','director_nolan','director_satoshi_kon','director_wes_anderson','director_kitano'
    ]},
    {id:'concept', icon:'ğŸ’¡', name:'é«˜æ¦‚å¿µ', group:'çµ±ç±Œ', phase:'éšæ®µ2', skills:[
        'concept_high_concept','hook_design','addictive_design','viral_elements',
        'cool_factor_design','cute_factor_design','tear_jerker_design','comedy_design'
    ]},
    
    // æ•…äº‹çµ„ - éšæ®µ1-2 (4)
    {id:'interview', icon:'ğŸ¤', name:'è¨ªè«‡å¸«', group:'æ•…äº‹', phase:'éšæ®µ1', skills:[
        'interview_creative_vision','interview_empathy','interview_diagnostic','interview_audience',
        'interview_brief','interview_conflict','interview_reference','interview_style','interview_theme','interview_vision_guide'
    ]},
    {id:'screenwriter', icon:'âœï¸', name:'ç·¨åŠ‡', group:'æ•…äº‹', phase:'éšæ®µ2-4', skills:[
        'screenwriting_mcgee_story','screenwriting_save_the_cat','screenwriting_syd_field','screenwriting_sequence_approach',
        'screenwriting_premise','screenwriting_conflict','screenwriting_subplot','screenwriting_scene_writing',
        'screenwriting_action_lines','screenwriting_exposition','screenwriting_foreshadowing','screenwriting_payoff',
        'screenwriting_flashback','screenwriting_montage','screenwriting_voiceover','screenwriting_opening','screenwriting_twist',
        'screenwriting_adaptation','script_subtext','script_action_lines','script_flashback','script_montage',
        'script_scene_heading','script_transition','script_visual_writing','script_voiceover','script_writing_complete',
        'dialogue_craft','tv_drama_writing'
    ]},
    {id:'adaptation', icon:'ğŸ“š', name:'æ”¹ç·¨', group:'æ•…äº‹', phase:'éšæ®µ2', skills:[
        'adaptation_novel_analysis','adaptation_structure','adaptation_pacing','adaptation_character_arc',
        'adaptation_dialogue','adaptation_episode','adaptation_novel_to_script','adaptation_scene_selection','adaptation_visual'
    ]},
    {id:'narrative', icon:'ğŸ“–', name:'æ•˜äº‹', group:'æ•…äº‹', phase:'éšæ®µ2-4', skills:[
        'story_heros_journey','outline_emotional_arc','outline_cliffhanger','outline_act_structure',
        'outline_episode_hook','outline_information','outline_scene_sequence','outline_subplot',
        'outline_time_management','outline_series_design','anime_narrative','pacing_rhythm'
    ]},
    
    // å°æ¼”çµ„ - éšæ®µ6 (4)
    {id:'storyboard', icon:'ğŸ¥', name:'åˆ†é¡', group:'å°æ¼”', phase:'éšæ®µ6', skills:[
        'cinematography_shots','cinematography_composition','cinematography_movement',
        'camera_angles','camera_movement_advanced','aspect_ratios'
    ]},
    {id:'cinematography', icon:'ğŸ“·', name:'æ”å½±', group:'å°æ¼”', phase:'éšæ®µ6', skills:[
        'camera_angles','camera_movement_advanced','perspective_depth',
        'directing_coverage','directing_master_shot','directing_single_take'
    ]},
    {id:'editing', icon:'âœ‚ï¸', name:'å‰ªè¼¯', group:'å°æ¼”', phase:'éšæ®µ6', skills:[
        'editing_rhythm','short_form_pacing','pacing_rhythm'
    ]},
    {id:'blocking', icon:'ğŸ¯', name:'èª¿åº¦', group:'å°æ¼”', phase:'éšæ®µ6', skills:[
        'directing_blocking','directing_180_rule','directing_crossing_line','directing_geography',
        'directing_eye_trace','directing_establishing','directing_insert','directing_reaction_shot',
        'directing_sequence','directing_subtext','directing_suspense','directing_tension','scene_types'
    ]},
    
    // ç¾è¡“çµ„ - éšæ®µ3,5,6 (5)
    {id:'artdirector', icon:'ğŸ¨', name:'ç¾è¡“ç¸½ç›£', group:'ç¾è¡“', phase:'éšæ®µ3', skills:[
        'art_styles_detailed','color_emotion','lighting_cinematic','worldbuilding_bible'
    ]},
    {id:'character', icon:'ğŸ‘¤', name:'è§’è‰²è¨­è¨ˆ', group:'ç¾è¡“', phase:'éšæ®µ3', skills:[
        'character_design_silhouette','character_design_expression','character_design_face','character_design_body_type',
        'character_design_age','character_design_archetype','character_design_contrast','character_design_ensemble',
        'character_design_hero','character_design_mentor','character_design_model_sheet','character_design_personality',
        'character_design_posture','character_design_proportion','character_design_shape_language',
        'character_design_sidekick','character_design_turnaround','character_design_villain','eyes_detailed'
    ]},
    {id:'costume', icon:'ğŸ‘”', name:'æœè£è¨­è¨ˆ', group:'ç¾è¡“', phase:'éšæ®µ3,5', skills:[
        'clothing_modern','hair_styles','materials_textures'
    ]},
    {id:'scene', icon:'ğŸ›ï¸', name:'å ´æ™¯è¨­è¨ˆ', group:'ç¾è¡“', phase:'éšæ®µ3,6', skills:[
        'background_elements','weather_atmosphere','prompt_architecture','prompt_interior',
        'prompt_landscape','prompt_vehicle','prompt_weapon'
    ]},
    {id:'color', icon:'ğŸŒˆ', name:'è‰²å½©è¨­è¨ˆ', group:'ç¾è¡“', phase:'éšæ®µ3,6', skills:[
        'color_emotion'
    ]},
    
    // è¡¨æ¼”çµ„ - éšæ®µ6 (4)
    {id:'expression', icon:'ğŸ˜Š', name:'è¡¨æƒ…è¨­è¨ˆ', group:'è¡¨æ¼”', phase:'éšæ®µ6', skills:[
        'facial_expressions','acting_microexpression','eyes_detailed'
    ]},
    {id:'acting', icon:'ğŸ­', name:'æ¼”æŠ€æŒ‡å°', group:'è¡¨æ¼”', phase:'éšæ®µ6', skills:[
        'body_language','emotion_visual'
    ]},
    {id:'pose', icon:'ğŸ•º', name:'å‹•ä½œè¨­è¨ˆ', group:'è¡¨æ¼”', phase:'éšæ®µ6', skills:[
        'action_poses','action_choreography','action_martial_arts','action_special_moves'
    ]},
    {id:'psychology', icon:'ğŸ§ ', name:'è§’è‰²å¿ƒç†', group:'è¡¨æ¼”', phase:'éšæ®µ4,6', skills:[
        'dialogue_craft','audience_emotion_prediction','audience_persona'
    ]},
    
    // AIè¼¸å‡ºçµ„ - éšæ®µ6 (2)
    {id:'prompt', icon:'ğŸ–¼ï¸', name:'Promptå¸«', group:'AIè¼¸å‡º', phase:'éšæ®µ6', skills:[
        'ai_midjourney','ai_stable_diffusion','ai_flux','ai_dalle','ai_leonardo',
        'prompt_portrait','prompt_full_body','prompt_group','prompt_action','prompt_emotion',
        'prompt_architecture','prompt_interior','prompt_landscape','prompt_vehicle','prompt_weapon',
        'prompt_negative','quality_modifiers'
    ]},
    {id:'platform', icon:'ğŸ”§', name:'å¹³å°é©é…', group:'AIè¼¸å‡º', phase:'éšæ®µ6', skills:[
        'ai_prompt_engineering','ai_consistency','ai_controlnet','ai_lora','ai_inpainting','ai_outpainting',
        'ai_upscaling','ai_img2img','ai_face_swap','ai_style_transfer','ai_negative_prompt',
        'ai_runway','ai_pika','ai_kling','ai_txt2video','ai_img2video','ai_lip_sync','ai_voice_clone','ai_music_gen'
    ]},
    
    // å°ˆé …çµ„ - å„éšæ®µ (8)
    {id:'vfx', icon:'ğŸ’¥', name:'VFXç‰¹æ•ˆ', group:'å°ˆé …', phase:'éšæ®µ6', skills:[
        'vfx_compositing','vfx_green_screen','vfx_matte_painting','vfx_particle','vfx_fluid',
        'vfx_fire','vfx_water','vfx_smoke','vfx_explosion','vfx_destruction',
        'vfx_weather_effects','vfx_magic','vfx_superhero_powers','vfx_creature','vfx_environment'
    ]},
    {id:'manga', icon:'ğŸ’¢', name:'æ¼«ç•«æ•ˆæœ', group:'å°ˆé …', phase:'éšæ®µ6', skills:[
        'manga_panel_design','manga_narrative','manga_visual_effects','manga_page_layout','manga_flow',
        'manga_gutter','manga_splash_page','manga_speed_lines','manga_focus_lines','manga_screen_tone',
        'manga_onomatopoeia','manga_emotion_symbols','manga_chibi','webtoon_design','anime_effects'
    ]},
    {id:'genre', icon:'ğŸ¬', name:'é¡å‹ç ”ç©¶', group:'å°ˆé …', phase:'éšæ®µ2', skills:[
        'genre_mystery','genre_fantasy','genre_romance','genre_comedy','genre_horror',
        'genre_scifi','genre_action','genre_drama','genre_thriller','genre_crime',
        'genre_war','genre_wuxia','genre_xianxia'
    ]},
    {id:'era', icon:'ğŸ“œ', name:'æ™‚ä»£è€ƒæ“š', group:'å°ˆé …', phase:'éšæ®µ3', skills:['culture_history']},
    {id:'culture', icon:'ğŸŒ', name:'æ–‡åŒ–é¡§å•', group:'å°ˆé …', phase:'éšæ®µ3', skills:['culture_history','worldbuilding_bible']},
    {id:'music', icon:'ğŸµ', name:'éŸ³æ¨‚è¨­è¨ˆ', group:'å°ˆé …', phase:'éšæ®µ6', skills:['ai_music_gen','editing_rhythm']},
    {id:'lighting', icon:'ğŸ’¡', name:'ç‡ˆå…‰è¨­è¨ˆ', group:'å°ˆé …', phase:'éšæ®µ6', skills:['lighting_cinematic']},
    {id:'weather', icon:'ğŸŒ¤ï¸', name:'æ°›åœè¨­è¨ˆ', group:'å°ˆé …', phase:'éšæ®µ6', skills:['weather_atmosphere','vfx_weather_effects']},
    
    // çŸ­åŠ‡å°ˆå®¶ - æ–°å¢ (1)
    {id:'shortform', icon:'ğŸ“±', name:'çŸ­åŠ‡å°ˆå®¶', group:'å°ˆé …', phase:'éšæ®µ2,6', skills:[
        'short_drama','short_form_hook','short_form_pacing','short_form_cliffhanger','short_form_vertical',
        'short_form_mobile_first','short_form_attention','short_form_series','short_form_character',
        'short_form_conflict','short_form_twist','short_form_emotion','short_form_comedy',
        'short_form_romance','short_form_suspense','short_form_algorithm'
    ]}
];

// æµç¨‹éšæ®µ - 30 Agents å…¨è¦†è“‹
const PHASES = [
    {id:1, name:'åŠ‡æœ¬å°å…¥ + è¨ªè«‡', agents:['director','interview']},
    {id:2, name:'å¤§ç¶± / Logline / ç« ç¯€', agents:['concept','screenwriter','adaptation','narrative','genre','shortform']},
    {id:3, name:'æœåŒ–é“ + äººç‰©å½¢è±¡', agents:['artdirector','character','costume','scene','color','era','culture']},
    {id:4, name:'ç« ç¯€åŠ‡æœ¬', agents:['screenwriter','narrative','psychology']},
    {id:5, name:'ç« ç¯€æœè£ç¢ºå®š', agents:['costume','color']},
    {id:6, name:'ç« ç¯€åˆ†é¡', agents:['storyboard','cinematography','editing','blocking','expression','acting','pose','prompt','platform','vfx','manga','music','lighting','weather','shortform']},
    {id:7, name:'ä¸‹ä¸€ç« ç¯€', agents:[]},
    {id:8, name:'å®Œæ•´è¼¸å‡º', agents:['director']}
];

// ==================== ç‹€æ…‹ç®¡ç† ====================
let state = {
    lang: 'zh',
    phase: 0,
    currentChapter: 0,
    project: {
        title: '',
        script: '',
        interview: {},
        logline: '',
        outline: [],
        characters: [],
        chapters: []
    },
    activeAgents: [],
    messages: []
};

// ==================== UIæ¸²æŸ“ ====================
function renderAgents(){
    const groups = {};
    AGENTS.forEach(a => {
        if(!groups[a.group]) groups[a.group] = [];
        groups[a.group].push(a);
    });
    
    let html = '';
    for(const [group, agents] of Object.entries(groups)){
        html += `<div class="agent-group"><div class="agent-group-title">${group}çµ„</div>`;
        agents.forEach(a => {
            const isActive = state.activeAgents.includes(a.id);
            const cls = isActive ? 'active' : '';
            html += `<div class="agent-item ${cls}">
                <span class="icon">${a.icon}</span>
                <span class="name">${a.name}</span>
                <span class="step">${a.phase}</span>
            </div>`;
        });
        html += '</div>';
    }
    document.getElementById('agentList').innerHTML = html;
}

function renderSkills(){
    const activeSkills = [];
    AGENTS.forEach(a => {
        if(state.activeAgents.includes(a.id)){
            activeSkills.push(...a.skills);
        }
    });
    
    const allSkills = [...new Set(AGENTS.flatMap(a => a.skills))];
    let html = allSkills.slice(0, 20).map(s => {
        const isActive = activeSkills.includes(s);
        return `<span class="skill-tag ${isActive ? 'active' : ''}">${s.replace(/_/g,' ')}</span>`;
    }).join('');
    
    document.getElementById('skillsList').innerHTML = html;
}

function renderChapters(){
    const chapters = state.project.chapters || [];
    let html = '';
    
    if(chapters.length === 0){
        html = '<p style="font-size:12px;color:var(--dim)">å°šæœªç”Ÿæˆç« ç¯€</p>';
    } else {
        chapters.forEach((ch, i) => {
            const isActive = i === state.currentChapter;
            const isDone = ch.storyboard && ch.storyboard.length > 0;
            html += `<button class="chapter-btn ${isActive?'active':''} ${isDone?'done':''}" onclick="switchChapter(${i})">
                ç¬¬${i+1}ç« ï¼š${ch.title || 'æœªå‘½å'}
            </button>`;
        });
    }
    document.getElementById('chapterNav').innerHTML = html;
}

function updateProgress(){
    const total = 8; // ç¸½éšæ®µæ•¸
    const pct = Math.round((state.phase / total) * 100);
    document.getElementById('progressBar').style.width = pct + '%';
    document.getElementById('progressLabel').textContent = `${pct}% - ${PHASES[state.phase-1]?.name || 'æº–å‚™ä¸­'}`;
    document.getElementById('phaseIndicator').textContent = PHASES[state.phase-1]?.name || 'æº–å‚™é–‹å§‹';
}

function addMessage(agentId, content, isUser = false){
    const agent = AGENTS.find(a => a.id === agentId) || {icon:'ğŸ’¬', name:'ç³»çµ±'};
    state.messages.push({agentId, content, isUser, time: new Date()});
    
    const chat = document.getElementById('chatArea');
    const msgClass = isUser ? 'message msg-user' : 'message msg-agent';
    
    if(isUser){
        chat.innerHTML += `<div class="${msgClass}"><div class="msg-content"><p>${content}</p></div></div>`;
    } else {
        chat.innerHTML += `
        <div class="${msgClass}">
            <div class="msg-avatar">${agent.icon}</div>
            <div class="msg-body">
                <div class="msg-header">
                    <span class="msg-name">${agent.name}</span>
                </div>
                <div class="msg-content">${content}</div>
            </div>
        </div>`;
    }
    chat.scrollTop = chat.scrollHeight;
}

function activateAgents(agentIds){
    state.activeAgents = agentIds;
    renderAgents();
    renderSkills();
}

// ==================== æµç¨‹æ§åˆ¶ ====================
function openModal(){ document.getElementById('modal').classList.remove('hide'); }
function closeModal(){ document.getElementById('modal').classList.add('hide'); }

function loadDemo(){
    document.getElementById('scriptInput').value = `ã€Šæµ·ä¸Šçµ²ç¶¢ä¹‹è·¯å¯†ç¢¼ã€‹

é¡å‹ï¼šæ­·å²å†’éšª / æ‡¸ç–‘ / æ±æ–¹å¥‡å¹»
æ™‚ä»£ï¼šå”ä»£
åœ°é»ï¼šå»£å·è•ƒåŠ â†’ å—æ´‹èˆªç·š â†’ å©†ç¾…æµ®å± 

ã€æ¥”å­ã€‘
èŒ…è‰æ£šå…§ï¼Œé¦™ç…™ç¹šç¹ã€‚å å¤¢å¸«æ‰‹æŒéŠ€éˆï¼Œç²‰ç´…è‰²çš„å…‰å¾æ³¢æ–¯è²´å©¦çš„èƒ¸å£é€å‡ºã€‚
å°çŒ´å­è—åœ¨æˆ¿æ¢ä¸Šï¼Œç­‰å¾…æ™‚æ©Ÿã€‚ä»–æ˜¯è•ƒåŠæœ€éˆæ´»çš„å°å·ã€‚
ç•¶ä»–çš„æ‰‹æŒ‡è§¸ç¢°é‚£é¡†ç²‰ç´…å¯¶çŸ³æ™‚ï¼Œè©­ç•°çš„å¹»è±¡é–ƒéè…¦æµ·â€”â€”é®®è¡€ã€ç«ç„°ã€é‚„æœ‰ä¸€å€‹å°‘å¥³çš„è‡‰...

ã€ç¬¬ä¸€ç«  å»£å·è•ƒåŠã€‘
æ€€åœ£å¯ºçš„å…‰å¡”é«˜è³ï¼Œé‡‘é ‚åœ¨å¤•é™½ä¸‹é–ƒè€€ã€‚é€™æ˜¯å¤§å”æœ€ç¹è¯çš„æ¸¯å£ï¼Œå„åœ‹å•†äººé›²é›†æ–¼æ­¤ã€‚
ç´…é«®ç›²è€äººåœ¨æ¦•æ¨¹ä¸‹è¬›è¿°æµ·ä¸Šå‚³èªªï¼Œå­©å­å€‘åœåè†è½...
å°çŒ´å­ç©¿æ¢­åœ¨ç†™æ”˜çš„äººç¾¤ä¸­ï¼Œä»–çš„ç›®æ¨™æ˜¯é‚£å€‹æ³¢æ–¯å•†äººçš„éŒ¢è¢‹...

ã€ç¬¬äºŒç«  å¤œæµ·å•Ÿèˆªã€‘
å¤§è•ƒèˆ¶å¦‚å·¨ç¸ï¼Œåœæ³Šåœ¨ç¢¼é ­ã€‚é€™è‰˜èˆ¹å°‡é§›å‘å—æ´‹ï¼Œè¼‰è‘—é¦™æ–™ã€çµ²ç¶¢ï¼Œé‚„æœ‰ç„¡æ•¸äººçš„å‘½é‹ã€‚
å°çŒ´å­è¿½å°‹å°è©è–©è »çš„èº«å½±ï¼Œä»–å¿…é ˆç™»ä¸Šé€™è‰˜èˆ¹...

ã€ç¬¬ä¸‰ç«  é»‘å¸†è³Šèˆ¹ã€‘
æœˆå…‰ä¸‹çš„å¤§æµ·ï¼Œé è™•å‡ºç¾é»‘è‰²å¸†å½±ã€‚
ã€Œæµ·ç›œï¼ã€ç­æœ›æ‰‹çš„é©šå«è²åŠƒç ´å¤œç©º...`;
}

function startProject(){
    const script = document.getElementById('scriptInput').value.trim();
    if(!script){ alert('è«‹è¼¸å…¥åŠ‡æœ¬å…§å®¹'); return; }
    
    state.project.script = script;
    state.project.title = script.match(/ã€Š(.+?)ã€‹/)?.[1] || 'æœªå‘½åé …ç›®';
    
    closeModal();
    state.phase = 1;
    updateProgress();
    
    // é–‹å§‹éšæ®µ1ï¼šè¨ªè«‡
    startPhase1();
}

// ==================== éšæ®µ1ï¼šè¨ªè«‡ ====================
// å°æ‡‰skills: interview_creative_vision, interview_empathy, interview_audience, interview_reference, interview_style, interview_theme, interview_conflict, interview_brief
let interviewStep = 0;
const INTERVIEW_QUESTIONS = [
    // interview_creative_vision - å‰µæ„é¡˜æ™¯
    {skill: 'interview_creative_vision', q: 'ä½ å¥½ï¼æˆ‘æ˜¯è¨ªè«‡å¸«ã€‚è®“æˆ‘å€‘å¾æºé ­é–‹å§‹â€”â€”é€™å€‹æ•…äº‹çš„éˆæ„Ÿä¾†æºæ˜¯ä»€éº¼ï¼Ÿæ˜¯å€‹äººç¶“æ­·ã€çœ‹åˆ°çš„æ–°èã€é‚„æ˜¯å…¶ä»–ä½œå“çš„å•Ÿç™¼ï¼Ÿç‚ºä»€éº¼æ˜¯ç¾åœ¨æƒ³è¬›é€™å€‹æ•…äº‹ï¼Ÿ'},
    // interview_empathy - æƒ…æ„Ÿå…§æ ¸
    {skill: 'interview_empathy', q: 'é€™å€‹æ•…äº‹æƒ³è¦å‚³é”ä»€éº¼æƒ…æ„Ÿï¼Ÿä½ å¸Œæœ›è§€çœ¾çœ‹å®Œå¾Œï¼Œå¿ƒè£¡ç•™ä¸‹ä»€éº¼æ¨£çš„æ„Ÿå—ï¼Ÿæ˜¯æ„Ÿå‹•ã€éœ‡æ’¼ã€æ²»ç™’ã€é‚„æ˜¯æ€è€ƒï¼Ÿ'},
    // interview_theme - ä¸»é¡Œæ¢ç´¢
    {skill: 'interview_theme', q: 'å¦‚æœç”¨ä¸€å¥è©±æ¦‚æ‹¬é€™å€‹æ•…äº‹æƒ³æ¢è¨çš„ä¸»é¡Œæˆ–å•é¡Œï¼Œæœƒæ˜¯ä»€éº¼ï¼Ÿæ¯”å¦‚ã€Œæ„›èˆ‡çŠ§ç‰²ã€ã€Œæˆé•·èˆ‡ä»£åƒ¹ã€ã€ŒçœŸç›¸èˆ‡è¬Šè¨€ã€...'},
    // interview_audience - ç›®æ¨™è§€çœ¾
    {skill: 'interview_audience', q: 'ä½ å¿ƒç›®ä¸­ç†æƒ³çš„è§€çœ¾æ˜¯èª°ï¼Ÿæè¿°ä¸€ä¸‹ä»–å€‘ï¼šå¹´é½¡ã€èˆˆè¶£ã€ç”Ÿæ´»ç‹€æ…‹ã€‚ä»–å€‘ç‚ºä»€éº¼æœƒè¢«é€™å€‹æ•…äº‹å¸å¼•ï¼Ÿ'},
    // interview_reference - åƒè€ƒé¢¨æ ¼
    {skill: 'interview_reference', q: 'æœ‰æ²’æœ‰åƒè€ƒä½œå“ï¼Ÿé›»å½±ã€å‹•æ¼«ã€å°èªªã€éŠæˆ²éƒ½è¡Œã€‚ä½ å¸Œæœ›æœ€çµ‚å‘ˆç¾çš„é¢¨æ ¼æ¥è¿‘å“ªäº›ä½œå“ï¼Ÿ'},
    // interview_style - è¦–è¦ºé¢¨æ ¼
    {skill: 'interview_style', q: 'è¦–è¦ºä¸Šä½ åå¥½ä»€éº¼é¢¨æ ¼ï¼Ÿå¯«å¯¦é›»å½±æ„Ÿã€æ—¥ç³»å‹•æ¼«ã€æ°´å¢¨åœ‹é¢¨ã€é‚„æ˜¯å…¶ä»–ï¼Ÿæœ‰æ²’æœ‰å…·é«”çš„ç•«é¢åœ¨ä½ è…¦æµ·ä¸­ï¼Ÿ'},
    // interview_conflict - æ ¸å¿ƒè¡çª
    {skill: 'interview_conflict', q: 'æ•…äº‹çš„æ ¸å¿ƒè¡çªæ˜¯ä»€éº¼ï¼Ÿä¸»è§’æœ€å¤§çš„éšœç¤™æˆ–å°æ‰‹æ˜¯èª°/ä»€éº¼ï¼Ÿé€™å€‹è¡çªç‚ºä»€éº¼é‡è¦ï¼Ÿ'},
    // interview_brief - ä¸€å¥è©±æ¦‚æ‹¬
    {skill: 'interview_brief', q: 'å¦‚æœè¦ç”¨ä¸€å¥è©±å‘æœ‹å‹æ¨è–¦é€™å€‹æ•…äº‹ï¼Œè®“ä»–å€‘ç«‹åˆ»æƒ³çœ‹ï¼Œä½ æœƒæ€éº¼èªªï¼Ÿ'},
    // interview_vision_guide - é¿å…äº‹é …
    {skill: 'interview_vision_guide', q: 'æœ‰æ²’æœ‰æƒ³é¿å…çš„å…§å®¹æˆ–é¢¨æ ¼ï¼Ÿæ¯”å¦‚ä¸æƒ³å¤ªè¡€è…¥ã€ä¸æƒ³å¤ªä½é½¡ã€ä¸æƒ³å¤ªèªªæ•™...'},
    // interview_diagnostic - æœ€çµ‚ç¢ºèª
    {skill: 'interview_diagnostic', q: 'æœ€å¾Œä¸€å€‹å•é¡Œï¼šé€™å€‹æ•…äº‹ä¸­ï¼Œä½ æœ€æƒ³è®“è§€çœ¾è¨˜ä½çš„æ˜¯ä»€éº¼ï¼Ÿä¸€å€‹è§’è‰²ï¼Ÿä¸€å€‹å ´é¢ï¼Ÿä¸€å¥å°è©ï¼Ÿä¸€ç¨®æƒ…æ„Ÿï¼Ÿ'}
];

function startPhase1(){
    activateAgents(['director', 'interview']);
    
    addMessage('director', `
        <h3>ğŸ¬ é …ç›®å•Ÿå‹•</h3>
        <p>æ­¡è¿ä¾†åˆ° FizzDragon AI Drama Studioï¼</p>
        <p>ã€Š<strong>${state.project.title}</strong>ã€‹å·²æˆåŠŸå°å…¥ã€‚åœ¨é–‹å§‹è£½ä½œä¹‹å‰ï¼Œæˆ‘å€‘çš„è¨ªè«‡å¸«æƒ³å’Œä½ èŠèŠï¼Œäº†è§£ä½ å°é€™å€‹é …ç›®çš„æƒ³æ³•ã€‚</p>
        <p style="color:var(--cyan)">é€™æ˜¯ä¸€å€‹å°è©±å¼çš„è¨ªè«‡ï¼Œè«‹è‡ªç”±å›ç­”ï¼Œä¸éœ€è¦é¸æ“‡é¡Œã€‚ä½ çš„å›ç­”æœƒå½±éŸ¿å¾ŒçºŒæ‰€æœ‰Agentçš„å‰µä½œæ–¹å‘ã€‚</p>
    `);
    
    setTimeout(() => {
        interviewStep = 0;
        askInterviewQuestion();
    }, 1000);
}

function askInterviewQuestion(){
    if(interviewStep >= INTERVIEW_QUESTIONS.length){
        finishInterview();
        return;
    }
    
    const item = INTERVIEW_QUESTIONS[interviewStep];
    const q = item.q.replace('{title}', state.project.title);
    const skillName = item.skill.replace(/_/g, ' ');
    
    addMessage('interview', `
        <p style="font-size:10px;color:var(--cyan);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">ğŸ› ï¸ Skill: ${skillName}</p>
        <p style="font-size:14px;line-height:1.8">${q}</p>
        <p style="font-size:11px;color:var(--dim);margin-top:12px">å•é¡Œ ${interviewStep + 1}/${INTERVIEW_QUESTIONS.length} â€” è«‹åœ¨ä¸‹æ–¹è¼¸å…¥ä½ çš„å›ç­”</p>
    `);
}

function handleInterviewAnswer(answer){
    state.project.interview[`q${interviewStep}`] = answer;
    interviewStep++;
    
    // çµ¦äºˆå›æ‡‰å¾Œå•ä¸‹ä¸€é¡Œ
    const responses = [
        'è¬è¬åˆ†äº«ï¼é€™å€‹åˆè¡·å¾ˆæœ‰æ„ç¾©ã€‚',
        'æ˜ç™½äº†ï¼Œé€™ç¨®æƒ…æ„Ÿå…±é³´å¾ˆé‡è¦ã€‚',
        'äº†è§£ï¼Œæˆ‘å€‘æœƒé‡å°é€™é¡è§€çœ¾è¨­è¨ˆã€‚',
        'å¾ˆå¥½çš„åƒè€ƒï¼Œæˆ‘è¨˜ä¸‹äº†ã€‚',
        'é€™å€‹åŸºèª¿æœƒè²«ç©¿æ•´å€‹ä½œå“ã€‚',
        'æ”¶åˆ°ï¼é€™æœƒæˆç‚ºæˆ‘å€‘çš„å‰µä½œæ ¸å¿ƒã€‚'
    ];
    
    if(interviewStep <= INTERVIEW_QUESTIONS.length){
        setTimeout(() => {
            if(interviewStep < INTERVIEW_QUESTIONS.length){
                addMessage('interview', `<p>${responses[interviewStep-1]}</p>`);
                setTimeout(askInterviewQuestion, 800);
            } else {
                finishInterview();
            }
        }, 500);
    }
}

function finishInterview(){
    const iv = state.project.interview;
    
    // ä½¿ç”¨çš„skillsåˆ—è¡¨
    const usedSkills = INTERVIEW_QUESTIONS.map(q => q.skill);
    
    addMessage('interview', `
        <h3>âœ… è¨ªè«‡å®Œæˆ</h3>
        
        <div class="report">
            <h4>ğŸ› ï¸ ä½¿ç”¨çš„Skills</h4>
            <p style="font-size:12px;color:var(--dim);margin-bottom:8px">å…±èª¿ç”¨ ${usedSkills.length} å€‹å°ˆæ¥­è¨ªè«‡æŠ€èƒ½ï¼š</p>
            <div style="display:flex;flex-wrap:wrap;gap:4px">
                ${usedSkills.map(s => `<span class="skill-tag active">${s.replace(/_/g,' ')}</span>`).join('')}
            </div>
        </div>
        
        <div class="report">
            <h4>ğŸ“ å‰µæ„é¡˜æ™¯æ‘˜è¦</h4>
            <div class="report-item">
                <h5>ğŸ’¡ å‰µä½œå‹•æ©Ÿ & éˆæ„Ÿä¾†æº</h5>
                <p>${iv.q0 || 'â€”'}</p>
            </div>
            <div class="report-item">
                <h5>â¤ï¸ æƒ…æ„Ÿå…§æ ¸</h5>
                <p>${iv.q1 || 'â€”'}</p>
            </div>
            <div class="report-item">
                <h5>ğŸ¯ æ ¸å¿ƒä¸»é¡Œ</h5>
                <p>${iv.q2 || 'â€”'}</p>
            </div>
            <div class="report-item">
                <h5>ğŸ‘¥ ç›®æ¨™è§€çœ¾</h5>
                <p>${iv.q3 || 'â€”'}</p>
            </div>
            <div class="report-item">
                <h5>ğŸ¬ åƒè€ƒä½œå“</h5>
                <p>${iv.q4 || 'â€”'}</p>
            </div>
            <div class="report-item">
                <h5>ğŸ¨ è¦–è¦ºé¢¨æ ¼åå¥½</h5>
                <p>${iv.q5 || 'â€”'}</p>
            </div>
            <div class="report-item">
                <h5>âš”ï¸ æ ¸å¿ƒè¡çª</h5>
                <p>${iv.q6 || 'â€”'}</p>
            </div>
            <div class="report-item">
                <h5>ğŸ“¢ ä¸€å¥è©±æ¨è–¦</h5>
                <p>${iv.q7 || 'â€”'}</p>
            </div>
            <div class="report-item">
                <h5>ğŸš« é¿å…äº‹é …</h5>
                <p>${iv.q8 || 'â€”'}</p>
            </div>
            <div class="report-item">
                <h5>â­ æœ€æƒ³è¢«è¨˜ä½çš„</h5>
                <p>${iv.q9 || 'â€”'}</p>
            </div>
        </div>
        
        <p style="color:var(--cyan)">ä»¥ä¸Š10å€‹ç¶­åº¦çš„ä¿¡æ¯å°‡æŒ‡å°æ‰€æœ‰29å€‹Agentçš„å‰µä½œæ–¹å‘ã€‚æ¯å€‹å¾ŒçºŒæ­¥é©Ÿéƒ½æœƒé¡¯ç¤ºã€Œæ ¹æ“šè¨ªè«‡ã€æç¤ºã€‚</p>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="startPhase2()">ç¹¼çºŒ â†’ å¤§ç¶±è¨­è¨ˆ</button>
        </div>
    `);
}

// ==================== éšæ®µ2ï¼šå¤§ç¶±è¨­è¨ˆ ====================
function startPhase2(){
    state.phase = 2;
    updateProgress();
    activateAgents(['concept', 'screenwriter', 'adaptation', 'narrative', 'genre']);
    
    // åˆ†æåŠ‡æœ¬
    const script = state.project.script;
    const chapters = script.match(/ã€.*?ã€‘/g) || [];
    const scriptLen = script.length;
    const iv = state.project.interview;
    
    // ç”ŸæˆLogline
    const logline = generateLogline(state.project.title, iv);
    state.project.logline = logline;
    
    // ç”Ÿæˆç« ç¯€
    const chapterCount = Math.max(3, chapters.length);
    state.project.chapters = [];
    for(let i = 0; i < chapterCount; i++){
        state.project.chapters.push({
            id: i,
            title: chapters[i]?.replace(/ã€|ã€‘/g, '') || `ç¬¬${i+1}ç« `,
            summary: '',
            scenes: [],
            storyboard: [],
            costumes: {}
        });
    }
    renderChapters();
    
    addMessage('concept', `
        <h3>ğŸ’¡ é«˜æ¦‚å¿µ & Logline</h3>
        
        <p>ã€Œé«˜æ¦‚å¿µã€æ˜¯ä¸€å¥è©±èƒ½æŠ“ä½è§€çœ¾çš„æ ¸å¿ƒå‰µæ„ã€‚å¥½çš„Loglineæ‡‰è©²è®“äººç«‹åˆ»æƒ³çœ‹é€™å€‹æ•…äº‹ã€‚</p>
        
        <div class="report">
            <h4>ğŸ¯ Logline</h4>
            <p style="font-size:15px;color:var(--primary);font-style:italic;padding:12px;background:var(--bg);border-radius:6px">
                "${logline}"
            </p>
        </div>
        
        <p>é€™å€‹LoglineåŸºæ–¼ä½ çš„è¨ªè«‡å›ç­”ç”Ÿæˆã€‚å¦‚æœä½ æƒ³èª¿æ•´ï¼Œå¯ä»¥åœ¨ä¸‹æ–¹è¼¸å…¥æ–°çš„ç‰ˆæœ¬ã€‚</p>
    `);
    
    setTimeout(() => {
        addMessage('adaptation', `
            <h3>ğŸ“š åŠ‡æœ¬åˆ†æ & ç« ç¯€è¦åŠƒ</h3>
            
            <div class="report">
                <h4>ğŸ“Š åŸè‘—åˆ†æ</h4>
                <div class="report-grid">
                    <div class="report-stat"><div class="val">${(scriptLen/1000).toFixed(1)}K</div><div class="label">ç¸½å­—æ•¸</div></div>
                    <div class="report-stat"><div class="val">${chapterCount}</div><div class="label">ç« ç¯€æ•¸</div></div>
                    <div class="report-stat"><div class="val">${Math.ceil(chapterCount * 1.5)}</div><div class="label">é è¨ˆåˆ†é¡é </div></div>
                    <div class="report-stat"><div class="val">${chapterCount * 80}</div><div class="label">é è¨ˆé¡é ­</div></div>
                </div>
            </div>
            
            <div class="report">
                <h4>ğŸ“‘ ç« ç¯€çµæ§‹</h4>
                ${state.project.chapters.map((ch, i) => `
                    <div class="report-item">
                        <h5>ç¬¬${i+1}ç« ï¼š${ch.title}</h5>
                        <p>${getChapterDesc(i, chapterCount)}</p>
                        <span class="tag">${getChapterPhase(i, chapterCount)}</span>
                    </div>
                `).join('')}
            </div>
        `);
        
        setTimeout(() => {
            addMessage('narrative', `
                <h3>ğŸ“– æ•˜äº‹çµæ§‹ & æƒ…ç·’æ›²ç·š</h3>
                
                <p>åŸºæ–¼ç¶“å…¸çš„ã€Œè‹±é›„ä¹‹æ—…ã€æ¨¡å‹ï¼Œçµåˆä½ å¸Œæœ›çš„ã€Œ${iv.q4 || 'ç·Šå¼µåˆºæ¿€'}ã€åŸºèª¿ï¼Œæˆ‘å€‘è¨­è¨ˆäº†ä»¥ä¸‹æƒ…ç·’æ›²ç·šï¼š</p>
                
                <div class="report">
                    <h4>ğŸ¢ æƒ…ç·’æ›²ç·š</h4>
                    <p style="font-family:monospace;padding:12px;background:var(--bg);border-radius:6px;font-size:12px">
                    å¥½å¥‡ â†’ ç·Šå¼µ â†’ éœ‡é©š â†’ å–˜æ¯ â†’ ææ‡¼ â†’ çµ•æœ› â†’ åè½‰ â†’ çˆ†ç™¼ â†’ æ„Ÿå‹• â†’ é¤˜éŸ»
                    </p>
                    <p style="font-size:12px;color:var(--dim);margin-top:8px">
                    æ¯é›†çµå°¾éƒ½è¨­ç½®ã€Œé‰¤å­ã€(Cliffhanger)ï¼Œç¢ºä¿è§€çœ¾æƒ³çœ‹ä¸‹ä¸€é›†ã€‚
                    </p>
                </div>
                
                <p>å¦‚æœä½ å°å¤§ç¶±æœ‰ä»»ä½•ä¿®æ”¹æ„è¦‹ï¼Œç¾åœ¨å¯ä»¥å‘Šè¨´æˆ‘ã€‚å¦å‰‡æˆ‘å€‘é€²å…¥ä¸‹ä¸€éšæ®µâ€”â€”æœåŒ–é“è¨­è¨ˆã€‚</p>
                
                <div class="actions">
                    <button class="btn btn-secondary" onclick="showModifyPrompt('outline')">âœï¸ æˆ‘æƒ³ä¿®æ”¹</button>
                    <button class="btn btn-primary" onclick="startPhase3()">ç¹¼çºŒ â†’ æœåŒ–é“è¨­è¨ˆ</button>
                </div>
            `);
        }, 1500);
    }, 1500);
}

function generateLogline(title, iv){
    const templates = [
        `ç•¶{protagonist}æ„å¤–ç²å¾—{item}ï¼Œä»–å¿…é ˆè¸ä¸Š{journey}ï¼Œåœ¨{deadline}ä¹‹å‰{goal}ï¼Œå¦å‰‡{stakes}ã€‚`,
        `ä¸€å€‹{trait}çš„{protagonist}ç™¼ç¾{discovery}ï¼Œè¢«è¿«æ²å…¥{conflict}ï¼Œå”¯ä¸€çš„å¸Œæœ›æ˜¯{solution}ã€‚`,
        `åœ¨{setting}ï¼Œ{protagonist}é‡è¦‹{catalyst}ï¼Œé–‹å§‹äº†ä¸€æ®µ{journey}ï¼Œæœ€çµ‚æ˜ç™½{theme}ã€‚`
    ];
    
    // ç°¡åŒ–ç‰ˆï¼šæ ¹æ“šæ¨™é¡Œç”Ÿæˆ
    if(title.includes('çµ²ç¶¢ä¹‹è·¯')){
        return `å”ä»£å»£å·ï¼Œä¸€å€‹13æ­²çš„è¡—é ­ç¥å·æ„å¤–æ²å…¥è·¨è¶Šå—æ´‹çš„å°‹å¯¶å†’éšªï¼Œåœ¨æµ·ä¸Šå¯†å®¤æ®ºäººæ¡ˆèˆ‡åƒå¹´è¼ªè¿´è©›å’’ä¸­ï¼Œä»–å¿…é ˆè§£é–‹å¯¶çŸ³çš„ç§˜å¯†ï¼Œå¦å‰‡æ‰€æœ‰äººéƒ½å°‡è‘¬èº«å¤§æµ·ã€‚`;
    }
    return `ä¸€å€‹å¹³å‡¡çš„ä¸»è§’ï¼Œè¢«è¿«è¸ä¸Šä¸å¹³å‡¡çš„æ—…ç¨‹ï¼Œåœ¨é‡é‡å›°é›£ä¸­æˆé•·ï¼Œæœ€çµ‚æ‰¾åˆ°çœŸæ­£é‡è¦çš„æ±è¥¿ã€‚`;
}

function getChapterDesc(i, total){
    const descs = ['ä¸–ç•Œè§€å»ºç«‹ï¼Œä¸»è§’ç™»å ´ï¼Œæ—¥å¸¸ç”Ÿæ´»èˆ‡æ€§æ ¼å±•ç¾','è§¸ç™¼äº‹ä»¶ï¼Œæ‰“ç ´å¹³è¡¡ï¼Œæ•…äº‹æ­£å¼å•Ÿå‹•','åˆæ¬¡æŒ‘æˆ°ï¼Œå±•ç¾èƒ½åŠ›ï¼Œçµè­˜ç›Ÿå‹','æ·±å…¥å†’éšªï¼Œæ­ç¤ºç§˜å¯†ï¼Œä¸­é»åè½‰','æœ€å¤§å±æ©Ÿï¼Œé»‘æš—æ™‚åˆ»ï¼Œå¤±å»ä¸€åˆ‡','è¦ºé†’é‡ç”Ÿï¼Œæœ€çµ‚å°æ±ºï¼Œé«˜æ½®çˆ†ç™¼','æ”¶æŸä¼ç­†ï¼Œçµå±€å‘ˆç¾ï¼Œé¤˜éŸ»ç•™ç™½'];
    return descs[Math.min(i, descs.length-1)];
}

function getChapterPhase(i, total){
    if(i === 0) return 'é–‹ç¯‡';
    if(i === total - 1) return 'çµå±€';
    if(i < total * 0.3) return 'é‹ªå¢Š';
    if(i < total * 0.7) return 'ç™¼å±•';
    return 'é«˜æ½®';
}

// ==================== éšæ®µ3ï¼šæœåŒ–é“ ====================
function startPhase3(){
    state.phase = 3;
    updateProgress();
    activateAgents(['artdirector','character','costume','scene','color','era','culture']);
    
    // æå–è§’è‰²
    const script = state.project.script;
    const characters = extractAllCharacters(script);
    state.project.characters = characters;
    
    addMessage('character', `
        <h3>ğŸ‘¥ è§’è‰²è¨­è¨ˆå ±å‘Š</h3>
        
        <p>å¾åŠ‡æœ¬ä¸­è­˜åˆ¥å‡º <strong style="color:var(--primary)">${characters.length}</strong> å€‹ä¸»è¦è§’è‰²ã€‚æ¯å€‹è§’è‰²éƒ½è¨­è¨ˆäº†å®Œæ•´çš„è¦–è¦ºå½¢è±¡æ–¹æ¡ˆã€‚</p>
        
        <div class="report">
            ${characters.map(c => `
                <div class="report-item">
                    <h5>${c.name} <span style="color:var(--dim);font-weight:normal">(${c.role})</span></h5>
                    <p>${c.description}</p>
                    <p style="margin-top:6px">
                        <span class="tag">å¹´é½¡ï¼š${c.age}</span>
                        <span class="tag">é«”å‹ï¼š${c.body}</span>
                        <span class="tag">ç‰¹å¾µï¼š${c.feature}</span>
                    </p>
                </div>
            `).join('')}
        </div>
    `);
    
    setTimeout(() => {
        addMessage('costume', `
            <h3>ğŸ‘” æœè£è¨­è¨ˆæ–¹æ¡ˆ</h3>
            
            <p>åŸºæ–¼æ™‚ä»£èƒŒæ™¯ï¼ˆå”ä»£ï¼‰å’Œè§’è‰²èº«ä»½ï¼Œè¨­è¨ˆäº†é»˜èªæœè£æ–¹æ¡ˆã€‚æ¯å€‹ç« ç¯€å¯ä»¥æ ¹æ“šå ´æ™¯èª¿æ•´ã€‚</p>
            
            <div class="report">
                ${characters.slice(0, 5).map(c => `
                    <div class="report-item">
                        <h5>${c.name} - åŸºç¤æœè£</h5>
                        <p>${c.defaultCostume}</p>
                    </div>
                `).join('')}
            </div>
        `);
        
        setTimeout(() => {
            addMessage('artdirector', `
                <h3>ğŸ¨ æ•´é«”è¦–è¦ºé¢¨æ ¼</h3>
                
                <div class="report">
                    <div class="report-item">
                        <h5>ç¾è¡“é¢¨æ ¼</h5>
                        <p>æ±æ–¹å¥‡å¹» Ã— å”ä»£ç•°åŸŸé¢¨æƒ…ï¼Œåƒè€ƒæ•¦ç…Œå£ç•«è‰²å½©èˆ‡ã€Šé•·å®‰åäºŒæ™‚è¾°ã€‹å ´æ™¯è³ªæ„Ÿ</p>
                    </div>
                    <div class="report-item">
                        <h5>è‰²å½©åŸºèª¿</h5>
                        <p>é‡‘è¤æš–è‰²ç³»ç‚ºä¸»ï¼ˆå”ä»£ç¹è¯ï¼‰ï¼Œè¼”ä»¥å—æ´‹æµ·åŸŸçš„è—ç¶ å†·è‰²ï¼ˆç¥ç§˜å†’éšªï¼‰ï¼Œé—œéµå ´æ™¯ä½¿ç”¨ç´…é»‘å°æ¯”ï¼ˆå±æ©Ÿç·Šå¼µï¼‰</p>
                    </div>
                    <div class="report-item">
                        <h5>å…‰å½±é¢¨æ ¼</h5>
                        <p>æˆ²åŠ‡æ€§å…‰å½±ï¼Œå¼·èª¿æ˜æš—å°æ¯”ã€‚å®¤å…§å ´æ™¯å¤šç”¨ç‡­å…‰/æ²¹ç‡ˆçš„æš–å…‰æºï¼Œæµ·ä¸Šå ´æ™¯åˆ©ç”¨æœˆå…‰ç‡Ÿé€ ç¥ç§˜æ„Ÿ</p>
                    </div>
                </div>
                
                <p>æœåŒ–é“è¨­è¨ˆå®Œæˆã€‚å¦‚éœ€èª¿æ•´ä»»ä½•è§’è‰²æˆ–è¦–è¦ºè¨­å®šï¼Œè«‹åœ¨ä¸‹æ–¹èªªæ˜ã€‚å¦å‰‡æˆ‘å€‘é–‹å§‹é€ç« è£½ä½œã€‚</p>
                
                <div class="actions">
                    <button class="btn btn-secondary" onclick="showModifyPrompt('design')">âœï¸ æˆ‘æƒ³ä¿®æ”¹</button>
                    <button class="btn btn-primary" onclick="startChapterWork(0)">é–‹å§‹ç¬¬1ç« è£½ä½œ â†’</button>
                </div>
            `);
        }, 1500);
    }, 1500);
}

function extractAllCharacters(script){
    const chars = [
        {name:'å°çŒ´å­', role:'ä¸»è§’', age:'13æ­²', body:'ç˜¦å°éˆæ´»', feature:'æ©Ÿè­¦çš„çœ¼ç¥', description:'è•ƒåŠè¡—é ­çš„å°‘å¹´ç¥å·ï¼Œèº«æ‰‹å¦‚çŒ´èˆ¬éˆæ´»ã€‚è¡¨é¢ç©ä¸–ä¸æ­ï¼Œå…§å¿ƒæ¸´æœ›æ­¸å±¬ã€‚å› æ„å¤–æ²å…¥å¯¶çŸ³äº‹ä»¶ï¼Œå‘½é‹å¾¹åº•æ”¹è®Šã€‚', defaultCostume:'ç ´èˆŠçš„ç°è¤è‰²çŸ­æ‰“ï¼Œè…°é–“ç¹«è‘—å¸ƒå¸¶ï¼Œèµ¤è¶³æˆ–è‰é‹ï¼Œä¾¿æ–¼æ”€çˆ¬'},
        {name:'å°è©è–©è »', role:'å¥³ä¸»è§’', age:'15æ­²', body:'çº–ç´°æŸ”å¼±', feature:'å¦‚è©è–©èˆ¬å¯§éœ', description:'ç¥ç§˜çš„å—æ´‹å°‘å¥³ï¼Œèº«ä¸–æˆè¬ã€‚ç¸½æ˜¯ç™½è¡£ç´ æ·¨ï¼Œæ‰‹æŒä½›ç ã€‚ä¼¼ä¹èˆ‡åƒå¹´å‰çš„è¼ªè¿´æœ‰é—œã€‚', defaultCostume:'ç™½è‰²å—æ´‹é¢¨æ ¼é•·è£™ï¼Œé ­æˆ´éŠ€é£¾ï¼Œè…•æˆ´ä½›ç ä¸²'},
        {name:'è•ƒé•·', role:'é‡è¦é…è§’', age:'45æ­²', body:'é«˜å¤§é­æ¢§', feature:'çµ¡è…®é¬', description:'å¤§é£Ÿå•†äººï¼Œèˆ¹éšŠçš„é ˜è¢–ã€‚å¨åš´ä¸­å¸¶è‘—æ·±æ²‰çš„æ†‚é¬±ï¼ŒèƒŒè² è‘—ä¸ç‚ºäººçŸ¥çš„ç§˜å¯†ã€‚', defaultCostume:'å¤§é£Ÿé¢¨æ ¼é•·è¢ï¼Œé ­çºå¸ƒå·¾ï¼Œä½©æˆ´é‡‘é£¾'},
        {name:'åœå¤¢å¸«', role:'ç¥ç§˜è§’è‰²', age:'å¹´é½¡ä¸è©³', body:'çº–ç´°', feature:'è’™é¢ï¼Œæ·¡è¤è‰²çœ¼çœ¸', description:'èƒ½çªºè¦‹éå»èˆ‡æœªä¾†çš„å åœå¸«ã€‚è¨€èªå¦‚è¬ï¼Œç«‹å ´æ¨¡ç³Šï¼Œæ˜¯æ•µæ˜¯å‹é›£ä»¥åˆ¤æ–·ã€‚', defaultCostume:'æ·±ç´«è‰²è’™é¢é•·è¢ï¼ŒéŠ€è³ªé£¾å“ï¼Œæ‰‹æŒéŠ€éˆ'},
        {name:'ç´…é«®ç›²è€äºº', role:'é…è§’', age:'70æ­²', body:'æ¯ç˜¦', feature:'ç´…é«®ï¼Œé›™ç›®å¤±æ˜', description:'æ¸¯å£çš„èªªæ›¸äººï¼Œè¬›è¿°çš„æ¯å€‹æ•…äº‹éƒ½æš—è—ç„æ©Ÿã€‚æ˜¯å°çŒ´å­é‡è¦çš„å¼•è·¯äººã€‚', defaultCostume:'ç°ç™½è‰²ç²—å¸ƒé•·è¡«ï¼Œæ‹„è‘—ç«¹æ–'}
    ];
    
    // æª¢æŸ¥åŠ‡æœ¬ä¸­æ˜¯å¦æåˆ°é€™äº›è§’è‰²
    return chars.filter(c => script.includes(c.name) || c.role === 'ä¸»è§’');
}

// ==================== éšæ®µ4-6ï¼šç« ç¯€è£½ä½œ ====================
function startChapterWork(chapterIndex){
    state.currentChapter = chapterIndex;
    state.phase = 4;
    updateProgress();
    renderChapters();
    
    const chapter = state.project.chapters[chapterIndex];
    
    addMessage('director', `
        <h3>ğŸ“– ç¬¬${chapterIndex + 1}ç« ï¼š${chapter.title}</h3>
        <p>é–‹å§‹è£½ä½œç¬¬${chapterIndex + 1}ç« çš„å®Œæ•´åˆ†é¡ã€‚é€™å€‹éšæ®µå°‡ä¾æ¬¡å®Œæˆï¼š</p>
        <ol>
            <li>ç« ç¯€åŠ‡æœ¬ç²¾ä¿®</li>
            <li>è§’è‰²æœè£ç¢ºå®š</li>
            <li>å®Œæ•´åˆ†é¡è¡¨ï¼ˆå«æ‰€æœ‰è¦–è½å…ƒç´ ï¼‰</li>
        </ol>
    `);
    
    setTimeout(() => startPhase4(chapterIndex), 1000);
}

function startPhase4(chapterIndex){
    activateAgents(['screenwriter','narrative','psychology']);
    const chapter = state.project.chapters[chapterIndex];
    
    addMessage('screenwriter', `
        <h3>âœï¸ ç« ç¯€åŠ‡æœ¬</h3>
        
        <div class="report">
            <h4>ç¬¬${chapterIndex + 1}ç« ï¼š${chapter.title}</h4>
            <div class="report-item">
                <h5>ç« ç¯€æ¦‚è¦</h5>
                <p>${getChapterDesc(chapterIndex, state.project.chapters.length)}</p>
            </div>
            <div class="report-item">
                <h5>æƒ…ç·’ç¯€æ‹</h5>
                <p>é–‹å ´ï¼š${['å¹³éœ','ç·Šå¼µ','ç¥ç§˜','æ­¡å¿«'][chapterIndex % 4]} â†’ ç™¼å±•ï¼šé€æ¼¸å‡æº« â†’ çµå°¾ï¼š${['æ‡¸å¿µ','éœ‡æ’¼','æ„Ÿå‹•','åè½‰'][chapterIndex % 4]}</p>
            </div>
            <div class="report-item">
                <h5>æœ¬ç« é‰¤å­ï¼ˆè®“è§€çœ¾æƒ³çœ‹ä¸‹ä¸€é›†ï¼‰</h5>
                <p style="color:var(--warning)">${getChapterHook(chapterIndex)}</p>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="startPhase5(${chapterIndex})">ç¢ºèª â†’ æœè£ç¢ºå®š</button>
        </div>
    `);
}

function getChapterHook(i){
    const hooks = [
        'å°çŒ´å­çš„æ‰‹æŒ‡è§¸ç¢°å¯¶çŸ³çš„ç¬é–“ï¼Œè¡€è…¥çš„å¹»è±¡é–ƒéâ€”â€”é€™é¡†å¯¶çŸ³ï¼Œç©¶ç«Ÿéš±è—è‘—ä»€éº¼ç§˜å¯†ï¼Ÿ',
        'èˆ¹ç·©ç·©é§›é›¢æ¸¯å£ï¼Œå°çŒ´å­ä¸çŸ¥é“çš„æ˜¯ï¼Œé€™è‰˜èˆ¹ä¸Šï¼Œæœ‰äººå¸¶è‘—æ®ºæ„...',
        'é»‘å¸†é€æ¼¸é€¼è¿‘ï¼Œèˆ¹é•·çš„è‡‰è‰²é©Ÿè®Šï¼šã€Œæ˜¯ã€é£Ÿäººé­”ã€çš„èˆ¹...ã€',
        'ç•¶ç¬¬ä¸€å…·å±é«”è¢«ç™¼ç¾æ™‚ï¼Œæ‰€æœ‰äººéƒ½æ„è­˜åˆ°â€”â€”å…‡æ‰‹ï¼Œå°±åœ¨ä»–å€‘ä¹‹ä¸­ã€‚',
        'åœå¤¢å¸«çš„é è¨€æˆçœŸäº†ï¼šã€Œä»Šå¤œï¼Œé‚„æœƒæœ‰äººæ­»ã€‚ã€',
        'çœŸç›¸å³å°‡æ­æ›‰ï¼Œä½†å°çŒ´å­ç™¼ç¾â€”â€”ä»–å¯§é¡˜æ°¸é ä¸çŸ¥é“é€™å€‹ç­”æ¡ˆ...'
    ];
    return hooks[i % hooks.length];
}

function startPhase5(chapterIndex){
    state.phase = 5;
    updateProgress();
    activateAgents(['costume','color']);
    
    const characters = state.project.characters;
    
    addMessage('costume', `
        <h3>ğŸ‘” æœ¬ç« æœè£ç¢ºå®š</h3>
        
        <p>æ ¹æ“šç¬¬${chapterIndex + 1}ç« çš„å ´æ™¯å’Œæƒ…ç¯€ï¼Œç¢ºå®šå„è§’è‰²åœ¨æœ¬ç« çš„æœè£ï¼š</p>
        
        <div class="report">
            ${characters.map(c => `
                <div class="report-item">
                    <h5>${c.name}</h5>
                    <p>${c.defaultCostume}</p>
                    <p style="font-size:11px;color:var(--cyan);margin-top:4px">æœ¬ç« ç‰¹æ®Šï¼š${getChapterCostume(c.name, chapterIndex)}</p>
                </div>
            `).join('')}
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="startPhase6(${chapterIndex})">ç¢ºèª â†’ ç”Ÿæˆåˆ†é¡</button>
        </div>
    `);
}

function getChapterCostume(name, chapter){
    if(chapter === 0) return 'åˆå§‹ç™»å ´é€ å‹ï¼Œç„¡ç‰¹æ®Šè®ŠåŒ–';
    if(chapter === 1 && name === 'å°çŒ´å­') return 'æ›ä¸Šæ°´æ‰‹æœé£¾ï¼Œæº–å‚™ä¸Šèˆ¹';
    if(chapter === 2) return 'å¤œé–“å ´æ™¯ï¼Œå¯èƒ½æœ‰æŠ«é¢¨æˆ–æ–—ç¯·';
    return 'æ ¹æ“šå ´æ™¯å¾®èª¿';
}

function startPhase6(chapterIndex){
    state.phase = 6;
    updateProgress();
    activateAgents(['storyboard','cinematography','editing','blocking','expression','acting','pose','prompt','platform','vfx','manga','music','lighting','weather']);
    
    addMessage('storyboard', `
        <h3>ğŸ¬ å®Œæ•´åˆ†é¡è¡¨ç”Ÿæˆä¸­...</h3>
        <p>æ­£åœ¨èª¿ç”¨æ‰€æœ‰ç›¸é—œAgentï¼Œç”Ÿæˆç¬¬${chapterIndex + 1}ç« çš„å®Œæ•´åˆ†é¡...</p>
    `);
    
    setTimeout(() => {
        const shots = generateChapterStoryboard(chapterIndex);
        state.project.chapters[chapterIndex].storyboard = shots;
        renderChapters();
        
        addMessage('storyboard', `
            <h3>ğŸ¥ ç¬¬${chapterIndex + 1}ç« åˆ†é¡è¡¨</h3>
            
            <p>å…±ç”Ÿæˆ <strong style="color:var(--primary)">${shots.length}</strong> å€‹é¡é ­ï¼ŒåŒ…å«å®Œæ•´çš„è¦–è½è¨­è¨ˆã€‚</p>
            
            <div class="storyboard">
                <div class="shot-row header">
                    <div>é¡é ­</div>
                    <div>ç•«é¢æè¿°</div>
                    <div>æ”å½±/é‹é¡</div>
                    <div>éŸ³æ•ˆ/é…æ¨‚</div>
                </div>
                ${shots.slice(0, 8).map(s => `
                    <div class="shot-row">
                        <div class="shot-num">#${s.id}</div>
                        <div class="shot-cell">${s.visual}</div>
                        <div class="shot-cell highlight">${s.camera}</div>
                        <div class="shot-cell">${s.audio}</div>
                    </div>
                `).join('')}
                ${shots.length > 8 ? `<p style="text-align:center;color:var(--dim);font-size:12px;padding:12px">... å…± ${shots.length} å€‹é¡é ­ï¼Œå®Œæ•´å…§å®¹è«‹å°å‡ºæŸ¥çœ‹</p>` : ''}
            </div>
            
            <div class="report">
                <h4>ğŸ“‹ æœ¬ç« æ•¸æ“š</h4>
                <div class="report-grid">
                    <div class="report-stat"><div class="val">${shots.length}</div><div class="label">ç¸½é¡é ­</div></div>
                    <div class="report-stat"><div class="val">${Math.round(shots.length * 0.55)}</div><div class="label">æ•˜äº‹é¡é ­</div></div>
                    <div class="report-stat"><div class="val">${Math.round(shots.length * 0.28)}</div><div class="label">æˆ²åŠ‡é¡é ­</div></div>
                    <div class="report-stat"><div class="val">${Math.round(shots.length * 0.17)}</div><div class="label">æƒ…æ„Ÿé¡é ­</div></div>
                </div>
            </div>
            
            <p>åˆ†é¡å·²ç”Ÿæˆã€‚ä½ å¯ä»¥ï¼š</p>
            <div class="actions">
                <button class="btn" onclick="exportChapter()">ğŸ“¥ å°å‡ºæœ¬ç« åˆ†é¡</button>
                ${chapterIndex < state.project.chapters.length - 1 ? 
                    `<button class="btn btn-primary" onclick="startChapterWork(${chapterIndex + 1})">ç¹¼çºŒç¬¬${chapterIndex + 2}ç«  â†’</button>` :
                    `<button class="btn btn-primary" onclick="finishProject()">å®Œæˆé …ç›® ğŸ‰</button>`
                }
            </div>
        `);
    }, 2000);
}

function generateChapterStoryboard(chapterIndex){
    const shots = [];
    const count = 60 + Math.floor(Math.random() * 40); // 60-100å€‹é¡é ­
    
    const visuals = ['å»ºç«‹é¡é ­ï¼šå ´æ™¯å…¨è²Œ','äººç‰©ç™»å ´ï¼šä¸»è§’å…¥ç•«','å°è©±å ´æ™¯ï¼šé›™äººä¸­æ™¯','æƒ…ç·’ç‰¹å¯«ï¼šçœ¼ç¥è®ŠåŒ–','å‹•ä½œå ´æ™¯ï¼šå¿«é€Ÿç§»å‹•','ç’°å¢ƒç©ºé¡ï¼šæ°›åœæ¸²æŸ“','è½‰å ´é¡é ­ï¼šæ™‚é–“æ¨ç§»'];
    const cameras = ['å›ºå®š/ä¸­æ™¯','æ¨é€²/ç‰¹å¯«','æ©«ç§»/è·Ÿæ‹','ä¿¯æ‹/å¤§å…¨æ™¯','æ‰‹æŒ/ä¸»è§€','èˆªæ‹/å»ºç«‹','åˆ‡æ›/è’™å¤ªå¥‡'];
    const audios = ['ç’°å¢ƒéŸ³ï¼šå¸‚é›†å–§å›‚','é…æ¨‚ï¼šç·Šå¼µå¼¦æ¨‚','éŸ³æ•ˆï¼šè…³æ­¥è²','æ—ç™½ï¼šå…§å¿ƒç¨ç™½','å°ç™½ï¼šè§’è‰²äº¤è«‡','éœéŸ³ï¼šå¼·èª¿','éŸ³æ¨‚æ¼¸å¼·'];
    
    for(let i = 1; i <= count; i++){
        shots.push({
            id: i,
            visual: visuals[Math.floor(Math.random() * visuals.length)],
            camera: cameras[Math.floor(Math.random() * cameras.length)],
            audio: audios[Math.floor(Math.random() * audios.length)],
            prompt: `Scene ${i}, ${state.project.title}, cinematic lighting, 8k --ar 16:9`,
            acting: 'è¡¨æƒ…ï¼šå°ˆæ³¨ / è‚¢é«”ï¼šè‡ªç„¶ç«™å§¿',
            lighting: ['è‡ªç„¶å…‰','ç‡­å…‰','æœˆå…‰','èƒŒå…‰å‰ªå½±'][Math.floor(Math.random() * 4)]
        });
    }
    return shots;
}

// ==================== å®Œæˆé …ç›® ====================
function finishProject(){
    state.phase = 8;
    updateProgress();
    activateAgents(['director']);
    
    const totalShots = state.project.chapters.reduce((sum, ch) => sum + (ch.storyboard?.length || 0), 0);
    
    addMessage('director', `
        <h3>ğŸ‰ é …ç›®è£½ä½œå®Œæˆï¼</h3>
        
        <div class="report">
            <h4>ğŸ“Š é …ç›®ç¸½è¦½</h4>
            <div class="report-grid">
                <div class="report-stat"><div class="val">${state.project.chapters.length}</div><div class="label">ç¸½ç« ç¯€</div></div>
                <div class="report-stat"><div class="val">${totalShots}</div><div class="label">ç¸½é¡é ­</div></div>
                <div class="report-stat"><div class="val">${state.project.characters.length}</div><div class="label">è§’è‰²æ•¸</div></div>
                <div class="report-stat"><div class="val">${Math.round(totalShots * 0.5)}</div><div class="label">é è¨ˆæ™‚é•·(ç§’)</div></div>
            </div>
        </div>
        
        <div class="report">
            <h4>ğŸ­ æ•…äº‹æƒ…ç·’å¼§ç·š</h4>
            <p>å¥½å¥‡é–‹å ´ â†’ å±æ©Ÿè§¸ç™¼ â†’ å±¤å±¤æ·±å…¥ â†’ æœ€é»‘æš—æ™‚åˆ» â†’ çµ‚æ¥µåè½‰ â†’ æƒ…æ„Ÿé‡‹æ”¾ â†’ ç•™ç™½é¤˜éŸ»</p>
        </div>
        
        <div class="report">
            <h4>ğŸ£ è§€çœ¾ç•™å­˜è¨­è¨ˆ</h4>
            <p>æ¯ç« çµå°¾éƒ½è¨­ç½®äº†ã€Œé‰¤å­ã€ï¼Œè£½é€ æ‡¸å¿µï¼Œè®“è§€çœ¾è¿«ä¸åŠå¾…æƒ³çœ‹ä¸‹ä¸€é›†ã€‚åŒæ™‚é€šéã€Œæœ‰æƒ…ã€ï¼ˆè§’è‰²æƒ…æ„Ÿï¼‰ã€ã€Œæœ‰æ–™ã€ï¼ˆä¿¡æ¯å¯†åº¦ï¼‰ã€ã€Œæœ‰è¶£ã€ï¼ˆè¦–è½è¶£å‘³ï¼‰ä¸‰ç¶­è¨­è¨ˆç¢ºä¿è§€çœ‹é«”é©—ã€‚</p>
        </div>
        
        <div class="actions">
            <button class="btn" onclick="exportAll()">ğŸ“¦ å°å‡ºå®Œæ•´é …ç›®</button>
            <button class="btn btn-primary" onclick="location.reload()">é–‹å§‹æ–°é …ç›®</button>
        </div>
    `);
}

// ==================== å·¥å…·å‡½æ•¸ ====================
function sendMessage(){
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if(!text) return;
    input.value = '';
    
    addMessage('user', text, true);
    
    // æ ¹æ“šç•¶å‰éšæ®µè™•ç†è¼¸å…¥
    if(state.phase === 1 && interviewStep < INTERVIEW_QUESTIONS.length){
        handleInterviewAnswer(text);
    } else {
        // é€šç”¨ä¿®æ”¹è™•ç†
        addMessage('director', `<p>æ”¶åˆ°ä½ çš„åé¥‹ï¼šã€Œ${text}ã€ã€‚æˆ‘æœƒæ ¹æ“šé€™å€‹èª¿æ•´å¾ŒçºŒçš„è¨­è¨ˆã€‚</p>`);
    }
}

function showModifyPrompt(type){
    addMessage('director', `<p>è«‹åœ¨ä¸‹æ–¹è¼¸å…¥ä½ æƒ³ä¿®æ”¹çš„å…§å®¹ï¼Œæˆ‘æœƒæ ¹æ“šä½ çš„æ„è¦‹èª¿æ•´ã€‚</p>`);
}

function switchChapter(index){
    state.currentChapter = index;
    renderChapters();
    addMessage('director', `<p>å·²åˆ‡æ›åˆ°ç¬¬${index + 1}ç« ã€‚</p>`);
}

function setLang(l){
    state.lang = l;
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
}

function exportChapter(){
    const ch = state.project.chapters[state.currentChapter];
    if(!ch?.storyboard?.length){
        alert('ç•¶å‰ç« ç¯€å°šæœªç”Ÿæˆåˆ†é¡');
        return;
    }
    
    let csv = 'é¡é ­,ç•«é¢æè¿°,æ”å½±é‹é¡,éŸ³æ•ˆé…æ¨‚,Prompt,æ¼”æŠ€,ç‡ˆå…‰\n';
    ch.storyboard.forEach(s => {
        csv += `${s.id},"${s.visual}","${s.camera}","${s.audio}","${s.prompt}","${s.acting}","${s.lighting}"\n`;
    });
    
    download(csv, `${state.project.title}_ç¬¬${state.currentChapter + 1}ç« _åˆ†é¡.csv`, 'text/csv');
}

function exportAll(){
    let txt = `ã€Š${state.project.title}ã€‹å®Œæ•´åˆ†é¡é …ç›®\n${'='.repeat(50)}\n\n`;
    
    txt += `ã€Loglineã€‘\n${state.project.logline}\n\n`;
    
    txt += `ã€è§’è‰²åˆ—è¡¨ã€‘\n`;
    state.project.characters.forEach(c => {
        txt += `${c.name}ï¼ˆ${c.role}ï¼‰ï¼š${c.description}\næœè£ï¼š${c.defaultCostume}\n\n`;
    });
    
    state.project.chapters.forEach((ch, i) => {
        txt += `\n${'='.repeat(50)}\nç¬¬${i + 1}ç« ï¼š${ch.title}\n${'='.repeat(50)}\n`;
        if(ch.storyboard?.length){
            ch.storyboard.forEach(s => {
                txt += `[#${s.id}] ${s.visual} | ${s.camera} | ${s.audio}\n`;
            });
        }
    });
    
    download(txt, `${state.project.title}_å®Œæ•´é …ç›®.txt`, 'text/plain');
}

function download(content, filename, type){
    const blob = new Blob([content], {type: type + ';charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
}

// ==================== åˆå§‹åŒ– ====================
function init(){
    renderAgents();
    renderSkills();
    renderChapters();
    updateProgress();
    openModal();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
