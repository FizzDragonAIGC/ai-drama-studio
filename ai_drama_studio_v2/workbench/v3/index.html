<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FizzDragon AI Drama Studio v3</title>
    <!-- DOCXËß£ÊûêÂ∫´ -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            /* ÈªëÁôΩÁÅ∞Á∫¢‰∏ªÈ¢ò */
            --bg:#050505;--surface:#0a0a0a;--surface2:#141414;
            --border:#252525;--border-glow:#ff0a3520;
            --text:#ffffff;--text-secondary:#e0e0e0;--dim:#808080;
            --primary:#ff0a35;--primary-dark:#cc0828;--primary-glow:#ff0a3540;
            --primary-light:#ff3355;
            /* Áªü‰∏ÄÁî®Á∫¢Ëâ≤Á≥ªÊõø‰ª£ÂÖ∂‰ªñÈ¢úËâ≤ */
            --secondary:#ff2d55;--accent:#ff0a35;
            --success:#ff0a35;--cyan:#ff0a35;--pink:#ff0a35;--purple:#ff0a35;
            --warning:#ff0a35;--error:#ff0a35;
            --radius:4px;--radius-sm:2px;
            --glow-sm:0 0 10px var(--primary-glow);
            --glow-md:0 0 20px var(--primary-glow);
            --glow-lg:0 0 40px var(--primary-glow);
        }
        
        /* Cyberpunk Base */
        body{
            font-family:'Inter',system-ui,sans-serif;
            background:var(--bg);
            color:var(--text);
            min-height:100vh;
            line-height:1.6;
            background-image:
                linear-gradient(0deg, transparent 24%, rgba(255,10,53,.03) 25%, rgba(255,10,53,.03) 26%, transparent 27%, transparent 74%, rgba(255,10,53,.03) 75%, rgba(255,10,53,.03) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(255,10,53,.03) 25%, rgba(255,10,53,.03) 26%, transparent 27%, transparent 74%, rgba(255,10,53,.03) 75%, rgba(255,10,53,.03) 76%, transparent 77%, transparent);
            background-size:50px 50px;
        }
        
        /* Scanline Effect */
        body::before{
            content:'';position:fixed;top:0;left:0;width:100%;height:100%;
            background:repeating-linear-gradient(0deg,rgba(0,0,0,0.1),rgba(0,0,0,0.1) 1px,transparent 1px,transparent 2px);
            pointer-events:none;z-index:9999;opacity:0.3;
        }
        
        /* Layout */
        .app{display:flex;flex-direction:column;min-height:100vh}
        
        .header{
            padding:16px 24px;
            background:linear-gradient(180deg,var(--surface) 0%,var(--bg) 100%);
            border-bottom:1px solid var(--primary);
            box-shadow:var(--glow-sm);
            display:flex;align-items:center;justify-content:space-between;
            position:relative;
        }
        .header::after{
            content:'';position:absolute;bottom:0;left:0;width:100%;height:1px;
            background:linear-gradient(90deg,transparent,var(--primary),transparent);
        }
        
        .logo{
            font-family:'Orbitron',monospace;
            font-size:22px;font-weight:800;letter-spacing:2px;
            background:linear-gradient(135deg,var(--primary) 0%,var(--pink) 50%,var(--accent) 100%);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
            text-shadow:0 0 30px var(--primary-glow);
            animation:glitch 3s infinite;
        }
        @keyframes glitch{
            0%,90%,100%{text-shadow:0 0 30px var(--primary-glow)}
            92%{text-shadow:-2px 0 var(--cyan),2px 0 var(--pink)}
            94%{text-shadow:2px 0 var(--cyan),-2px 0 var(--pink)}
        }
        
        .header-info{display:flex;gap:12px;align-items:center}
        .badge{
            padding:6px 14px;
            background:var(--surface2);
            border:1px solid var(--border);
            border-radius:0;
            font-size:10px;font-family:'Orbitron',monospace;
            color:var(--dim);
            text-transform:uppercase;
            letter-spacing:1px;
            clip-path:polygon(8px 0,100% 0,100% calc(100% - 8px),calc(100% - 8px) 100%,0 100%,0 8px);
        }
        .badge.active{
            background:var(--primary);
            border-color:var(--primary);
            color:#fff;
            box-shadow:var(--glow-sm);
        }
        
        .main{flex:1;display:grid;grid-template-columns:280px 1fr 320px;gap:0}
        
        /* Left Panel - Progress */
        .panel-left{
            background:linear-gradient(90deg,var(--surface) 0%,var(--bg) 100%);
            border-right:1px solid var(--border);
            padding:20px;overflow-y:auto;
            position:relative;
        }
        .panel-left::after{
            content:'';position:absolute;top:0;right:0;width:1px;height:100%;
            background:linear-gradient(180deg,var(--primary),transparent 30%,transparent 70%,var(--primary));
        }
        .panel-left h2{
            font-family:'Orbitron',monospace;
            font-size:10px;color:var(--primary);
            text-transform:uppercase;letter-spacing:3px;
            margin-bottom:20px;
            padding-bottom:10px;
            border-bottom:1px solid var(--border);
        }
        
        .step-list{list-style:none}
        .step-item{
            display:flex;align-items:center;gap:12px;
            padding:14px 12px;
            border:1px solid transparent;
            margin-bottom:6px;
            cursor:pointer;
            transition:all .3s;
            position:relative;
            clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));
        }
        .step-item::before{
            content:'';position:absolute;top:0;left:0;width:3px;height:0;
            background:var(--primary);transition:height .3s;
        }
        .step-item:hover{background:var(--surface2);border-color:var(--border)}
        .step-item:hover::before{height:100%}
        .step-item.active{
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
            border-color:var(--primary);
            box-shadow:var(--glow-md);
        }
        .step-item.active::before{height:100%;background:var(--accent)}
        .step-item.done{opacity:.6}
        .step-item.done:hover{opacity:1}
        
        .step-num{
            width:32px;height:32px;
            border:1px solid var(--border);
            background:var(--bg);
            display:flex;align-items:center;justify-content:center;
            font-family:'Orbitron',monospace;
            font-size:11px;font-weight:600;
            clip-path:polygon(6px 0,100% 0,100% calc(100% - 6px),calc(100% - 6px) 100%,0 100%,0 6px);
        }
        .step-item.active .step-num{background:rgba(0,0,0,.3);border-color:rgba(255,255,255,.3)}
        .step-item.done .step-num{background:var(--success);border-color:var(--text);color:#000}
        .step-item.done .step-num::after{content:'‚úì'}
        .step-info{flex:1}
        .step-title{font-size:12px;font-weight:600;letter-spacing:0.5px}
        .step-desc{font-size:10px;color:var(--dim);margin-top:2px}
        .step-item.active .step-desc{color:rgba(255,255,255,.7)}
        
        /* Center - Content */
        .panel-center{padding:24px;overflow-y:auto;background:var(--bg)}
        
        .content-card{
            background:var(--surface);
            border:1px solid var(--border);
            padding:28px;
            margin-bottom:20px;
            position:relative;
            clip-path:polygon(0 0,calc(100% - 20px) 0,100% 20px,100% 100%,20px 100%,0 calc(100% - 20px));
        }
        .content-card::before{
            content:'';position:absolute;top:0;left:0;right:0;height:2px;
            background:linear-gradient(90deg,var(--primary),var(--pink),var(--primary));
        }
        .content-card::after{
            content:'';position:absolute;top:20px;right:0;width:2px;height:calc(100% - 20px);
            background:linear-gradient(180deg,var(--primary),transparent);
        }
        .content-card h3{
            font-family:'Orbitron',monospace;
            font-size:14px;font-weight:600;
            letter-spacing:2px;text-transform:uppercase;
            margin-bottom:20px;
            display:flex;align-items:center;gap:10px;
            color:var(--text);
        }
        .content-card h3 .icon{font-size:18px}
        
        .form-group{margin-bottom:20px}
        .form-label{
            display:block;
            font-family:'Orbitron',monospace;
            font-size:9px;color:var(--primary);
            text-transform:uppercase;letter-spacing:2px;
            margin-bottom:10px;
        }
        .form-input{
            width:100%;padding:14px 16px;
            background:var(--bg);
            border:1px solid var(--border);
            color:var(--text);font-size:13px;
            transition:all .3s;
            clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));
        }
        .form-input:focus{
            outline:none;
            border-color:var(--primary);
            box-shadow:var(--glow-sm);
        }
        textarea.form-input{min-height:200px;resize:vertical;font-family:inherit}
        
        .btn{
            padding:12px 28px;
            background:var(--surface2);
            border:1px solid var(--border);
            color:var(--text);
            font-family:'Orbitron',monospace;
            font-size:11px;font-weight:500;
            letter-spacing:1px;text-transform:uppercase;
            cursor:pointer;
            transition:all .3s;
            clip-path:polygon(8px 0,100% 0,100% calc(100% - 8px),calc(100% - 8px) 100%,0 100%,0 8px);
            position:relative;
            overflow:hidden;
        }
        .btn::before{
            content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
            background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);
            transition:left .5s;
        }
        .btn:hover{
            border-color:var(--primary);
            background:var(--surface);
            box-shadow:var(--glow-sm);
        }
        .btn:hover::before{left:100%}
        
        .btn-primary{
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
            border-color:var(--primary);
            color:#fff;
            box-shadow:var(--glow-sm);
        }
        .btn-primary:hover{
            box-shadow:var(--glow-md);
            transform:translateY(-1px);
        }
        
        .quick-reply{
            background:var(--surface2);
            border:1px solid var(--border);
            color:var(--dim);
            padding:8px 14px;
            font-size:11px;
            cursor:pointer;
            transition:all .2s;
            clip-path:polygon(5px 0,100% 0,100% calc(100% - 5px),calc(100% - 5px) 100%,0 100%,0 5px);
        }
        .quick-reply:hover{
            background:var(--primary);
            border-color:var(--primary);
            color:#fff;
            box-shadow:var(--glow-sm);
        }
        .btn-group{display:flex;gap:12px;margin-top:24px}
        
        /* Report Sections */
        .report{
            background:var(--surface2);
            border:1px solid var(--border);
            padding:20px;margin:20px 0;
            position:relative;
            clip-path:polygon(0 0,calc(100% - 15px) 0,100% 15px,100% 100%,15px 100%,0 calc(100% - 15px));
        }
        .report::before{
            content:'';position:absolute;top:0;left:0;width:100%;height:1px;
            background:linear-gradient(90deg,var(--primary),transparent);
        }
        .report h4{
            font-family:'Orbitron',monospace;
            font-size:10px;color:var(--primary);
            letter-spacing:2px;text-transform:uppercase;
            margin-bottom:16px;
        }
        .report-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px}
        .stat-box{
            background:var(--bg);
            border:1px solid var(--border);
            padding:16px 12px;
            text-align:center;
            position:relative;
            clip-path:polygon(5px 0,100% 0,100% calc(100% - 5px),calc(100% - 5px) 100%,0 100%,0 5px);
        }
        .stat-val{
            font-family:'Orbitron',monospace;
            font-size:26px;font-weight:700;
            color:var(--primary);
            text-shadow:0 0 20px var(--primary-glow);
        }
        .stat-label{font-size:9px;color:var(--dim);margin-top:6px;text-transform:uppercase;letter-spacing:1px}
        
        .item-card{
            background:var(--bg);
            border:1px solid var(--border);
            padding:16px;margin:12px 0;
            transition:all .3s;
            clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));
        }
        .item-card:hover{
            border-color:var(--primary);
            box-shadow:var(--glow-sm);
        }
        .item-card h5{font-size:13px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .item-card p{font-size:12px;color:var(--dim);margin:6px 0}
        .tag{
            display:inline-block;
            padding:4px 10px;
            background:var(--surface);
            border:1px solid var(--border);
            font-family:'Orbitron',monospace;
            font-size:9px;
            color:var(--dim);
            margin:3px;
            letter-spacing:0.5px;
        }
        
        /* Right Panel - Output */
        .panel-right{
            background:linear-gradient(270deg,var(--surface) 0%,var(--bg) 100%);
            border-left:1px solid var(--border);
            padding:20px;overflow-y:auto;
            position:relative;
        }
        .panel-right::before{
            content:'';position:absolute;top:0;left:0;width:1px;height:100%;
            background:linear-gradient(180deg,var(--primary),transparent 30%,transparent 70%,var(--primary));
        }
        .panel-right h2{
            font-family:'Orbitron',monospace;
            font-size:10px;color:var(--primary);
            text-transform:uppercase;letter-spacing:3px;
            margin-bottom:16px;
        }
        
        .output-section{margin-bottom:24px}
        .output-file{display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface2);border-radius:var(--radius-sm);margin-bottom:8px;font-size:12px}
        .output-file .icon{color:var(--dim)}
        .output-file .name{flex:1}
        .output-file .size{color:var(--dim)}
        
        .export-btn{
            width:100%;padding:14px;
            background:var(--surface);
            border:1px solid var(--border);
            color:var(--text);
            font-family:'Orbitron',monospace;
            font-size:10px;
            letter-spacing:1px;
            text-transform:uppercase;
            cursor:pointer;
            margin-bottom:8px;
            display:flex;align-items:center;justify-content:center;gap:10px;
            transition:all .3s;
            clip-path:polygon(8px 0,100% 0,100% calc(100% - 8px),calc(100% - 8px) 100%,0 100%,0 8px);
            position:relative;
        }
        .export-btn::before{
            content:'';position:absolute;left:0;top:0;width:100%;height:100%;
            background:linear-gradient(90deg,transparent,rgba(255,10,53,.1),transparent);
            transform:translateX(-100%);transition:transform .3s;
        }
        .export-btn:hover{
            border-color:var(--text);color:var(--text);
            box-shadow:0 0 20px rgba(255,10,53,.2);
        }
        .export-btn:hover::before{transform:translateX(100%)}
        
        /* Storyboard Table - Cyberpunk Style */
        .storyboard-table{width:100%;border-collapse:collapse;font-size:11px}
        .storyboard-table th,.storyboard-table td{
            padding:12px;text-align:left;
            border-bottom:1px solid var(--border);
        }
        .storyboard-table th{
            background:var(--surface);
            color:var(--primary);
            font-family:'Orbitron',monospace;
            font-size:9px;font-weight:500;
            letter-spacing:1px;text-transform:uppercase;
        }
        .storyboard-table tr{transition:all .2s}
        .storyboard-table tr:hover{
            background:var(--surface);
            box-shadow:inset 3px 0 0 var(--primary);
        }
        .shot-id{
            font-family:'Orbitron',monospace;
            color:var(--primary);font-weight:600;
            text-shadow:0 0 10px var(--primary-glow);
        }
        .shot-type{padding:4px 10px;font-size:9px;font-family:'Orbitron',monospace;letter-spacing:0.5px}
        .shot-type.narrative{background:rgba(255,10,53,.15);color:var(--text);border:1px solid rgba(255,10,53,.3)}
        .shot-type.dramatic{background:rgba(255,10,53,.15);color:var(--primary);border:1px solid rgba(255,10,53,.3)}
        .shot-type.emotional{background:rgba(255,10,120,.15);color:var(--primary);border:1px solid rgba(255,10,120,.3)}
        
        /* Agent Thinking Animation - Cyberpunk */
        .agent-thinking{
            background:var(--surface);
            border:1px solid var(--border);
            padding:24px;margin:20px 0;
            position:relative;
            clip-path:polygon(0 0,calc(100% - 15px) 0,100% 15px,100% 100%,15px 100%,0 calc(100% - 15px));
        }
        .agent-thinking::before{
            content:'';position:absolute;top:0;left:0;right:0;height:2px;
            background:linear-gradient(90deg,var(--primary),var(--cyan),var(--primary));
            animation:scanline 2s linear infinite;
        }
        @keyframes scanline{
            0%{background-position:0% 0}
            100%{background-position:200% 0}
        }
        .agent-thinking-header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
        .agent-avatar{
            width:56px;height:56px;
            background:linear-gradient(135deg,var(--primary),var(--pink));
            display:flex;align-items:center;justify-content:center;
            font-size:28px;
            clip-path:polygon(15% 0,85% 0,100% 15%,100% 85%,85% 100%,15% 100%,0 85%,0 15%);
            animation:avatarPulse 2s infinite;
            box-shadow:0 0 30px var(--primary-glow);
        }
        @keyframes avatarPulse{
            0%,100%{box-shadow:0 0 20px var(--primary-glow)}
            50%{box-shadow:0 0 40px var(--primary-glow)}
        }
        .agent-name{
            font-family:'Orbitron',monospace;
            font-weight:600;font-size:14px;
            letter-spacing:1px;
        }
        .agent-status{
            font-family:'Orbitron',monospace;
            font-size:10px;color:var(--dim);
            display:flex;align-items:center;gap:8px;
            letter-spacing:1px;
        }
        .agent-status::before{
            content:'';width:8px;height:8px;
            background:var(--cyan);
            clip-path:polygon(50% 0,100% 50%,50% 100%,0 50%);
            animation:statusBlink 1s infinite;
        }
        @keyframes statusBlink{0%,100%{opacity:1}50%{opacity:0.3}}
        .thinking-process{font-size:12px;color:var(--dim);line-height:2}
        .thinking-step{
            display:flex;gap:10px;margin:10px 0;
            opacity:0;animation:fadeIn 0.5s forwards;
            padding:8px 12px;
            background:var(--bg);
            border-left:2px solid var(--border);
        }
        .thinking-step::before{content:'‚ñπ';color:var(--primary);flex-shrink:0}
        .thinking-step.done{border-left-color:var(--text)}
        .thinking-step.done::before{content:'‚ñ∏';color:var(--text)}
        .thinking-step.current{border-left-color:var(--dim);color:#fff}
        .thinking-dots{display:inline-flex;gap:4px;margin-left:8px}
        .thinking-dots span{
            width:6px;height:6px;background:var(--primary);
            clip-path:polygon(50% 0,100% 50%,50% 100%,0 50%);
            animation:dotBounce 1.4s infinite;
        }
        .thinking-dots span:nth-child(2){animation-delay:0.2s}
        .thinking-dots span:nth-child(3){animation-delay:0.4s}
        
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
        @keyframes fadeIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
        @keyframes dotBounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}
        @keyframes typing{from{width:0}to{width:100%}}
        
        .typewriter{overflow:hidden;white-space:nowrap;animation:typing 2s steps(40,end)}
        .chain-of-thought{
            background:var(--bg);padding:16px;margin:16px 0;
            border:1px solid var(--border);
            border-left:3px solid var(--primary);
            font-size:12px;line-height:1.8;
        }
        .chain-of-thought .step{margin:10px 0;padding-left:20px;position:relative}
        .chain-of-thought .step::before{content:'‚Ä∫';position:absolute;left:0;color:var(--dim);font-weight:bold}
        .chain-of-thought .conclusion{
            color:var(--primary);font-weight:600;
            margin-top:16px;padding-top:16px;
            border-top:1px solid var(--border);
            font-family:'Orbitron',monospace;
            letter-spacing:0.5px;
        }
        
        /* Subject Card - Cyberpunk */
        .subject-card{
            background:var(--bg);
            border:1px solid var(--border);
            padding:14px;margin:10px 0;
            transition:all .3s;
            clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));
        }
        .subject-card:hover{border-color:var(--primary);box-shadow:var(--glow-sm)}
        .subject-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
        .subject-type{
            padding:4px 10px;
            font-family:'Orbitron',monospace;
            font-size:8px;font-weight:500;
            letter-spacing:1px;text-transform:uppercase;
        }
        .subject-type.person{background:rgba(128,128,128,.15);color:var(--dim);border:1px solid rgba(128,128,128,.3)}
        .subject-type.animal{background:rgba(128,128,128,.15);color:var(--dim);border:1px solid rgba(128,128,128,.3)}
        .subject-type.crowd{background:rgba(128,128,128,.15);color:var(--dim);border:1px solid rgba(128,128,128,.3)}
        .subject-name{font-weight:600;letter-spacing:0.5px}
        .subject-detail{font-size:11px;color:var(--dim);margin:6px 0}
        .subject-detail strong{color:var(--text)}
        .dialogue-box{
            background:var(--surface);padding:12px;
            margin-top:10px;
            border-left:3px solid var(--primary);
        }
        .dialogue-box .speaker{
            font-family:'Orbitron',monospace;
            font-size:9px;color:var(--dim);
            margin-bottom:6px;letter-spacing:1px;
        }
        .dialogue-box .line{font-style:italic;color:var(--text)}
        
        /* Scene Card - Cyberpunk */
        .scene-card{
            background:var(--bg);
            border:1px solid var(--border);
            padding:14px;margin:10px 0;
            clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));
        }
        .scene-header{
            font-family:'Orbitron',monospace;
            font-weight:600;margin-bottom:12px;
            font-size:12px;letter-spacing:0.5px;
        }
        .scene-detail{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:10px}
        .scene-detail span{padding:8px 10px;background:var(--surface);border:1px solid var(--border)}
        .scene-detail .label{color:var(--dim);font-family:'Orbitron',monospace;font-size:8px;letter-spacing:1px}
        .scene-detail .value{color:var(--text)}
        
        /* Prompt Box - Cyberpunk */
        .prompt-box{
            background:var(--bg);
            border:1px solid var(--border);
            padding:14px;margin:10px 0;
            font-family:'Fira Code','Consolas',monospace;
            font-size:11px;color:var(--dim);
            word-break:break-all;
            position:relative;
        }
        .prompt-box::before{
            content:'PROMPT';
            position:absolute;top:-8px;left:10px;
            background:var(--bg);padding:0 8px;
            font-family:'Orbitron',monospace;
            font-size:8px;color:var(--primary);
            letter-spacing:2px;
        }
        .prompt-label{
            font-family:'Orbitron',monospace;
            font-size:9px;color:var(--dim);
            margin-bottom:8px;
            display:flex;align-items:center;gap:8px;
            letter-spacing:1px;
        }
        
        /* Tabs - Cyberpunk */
        .tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:24px}
        .tab{
            padding:14px 24px;
            font-family:'Orbitron',monospace;
            font-size:10px;
            letter-spacing:1px;text-transform:uppercase;
            color:var(--dim);cursor:pointer;
            border-bottom:2px solid transparent;
            transition:all .3s;
            position:relative;
        }
        .tab::before{
            content:'';position:absolute;bottom:0;left:50%;width:0;height:2px;
            background:var(--primary);transition:all .3s;transform:translateX(-50%);
        }
        .tab:hover{color:var(--text)}
        .tab:hover::before{width:100%}
        .tab.active{color:var(--primary);border-bottom-color:var(--primary)}
        .tab.active::before{width:100%}
        
        /* Progress Bar - Cyberpunk */
        .progress-wrap{margin-bottom:28px}
        .progress-bar{
            height:6px;
            background:var(--surface);
            border:1px solid var(--border);
            overflow:hidden;
            position:relative;
        }
        .progress-bar::before{
            content:'';position:absolute;top:0;left:0;width:100%;height:100%;
            background:repeating-linear-gradient(90deg,transparent,transparent 10px,rgba(255,255,255,.03) 10px,rgba(255,255,255,.03) 20px);
        }
        .progress-fill{
            height:100%;
            background:linear-gradient(90deg,var(--primary),var(--pink),var(--primary));
            background-size:200% 100%;
            animation:progressGlow 2s linear infinite;
            transition:width .5s;
            box-shadow:0 0 20px var(--primary-glow);
        }
        @keyframes progressGlow{0%{background-position:0% 0}100%{background-position:200% 0}}
        .progress-text{
            font-family:'Orbitron',monospace;
            font-size:10px;color:var(--dim);
            margin-top:10px;text-align:center;
            letter-spacing:2px;
        }
        
        /* Loading - Cyberpunk */
        .loading{display:flex;align-items:center;justify-content:center;gap:16px;padding:50px;color:var(--dim)}
        .spinner{
            width:28px;height:28px;
            border:2px solid var(--surface);
            border-top-color:var(--primary);
            border-right-color:var(--primary);
            animation:spin 1s linear infinite;
            clip-path:polygon(50% 0,100% 25%,100% 75%,50% 100%,0 75%,0 25%);
        }
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-spinner{width:24px;height:24px;border:3px solid var(--surface2);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        
        /* Neon Text Effect */
        .neon-text{
            color:var(--primary);
            text-shadow:0 0 10px var(--primary-glow),0 0 20px var(--primary-glow),0 0 40px var(--primary-glow);
        }
        
        /* Responsive */
        @media(max-width:1200px){.main{grid-template-columns:1fr}.panel-left,.panel-right{display:none}}
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <div>
            <div class="logo">FIZZDRAGON_</div>
            <div style="font-family:'Orbitron',monospace;font-size:9px;color:var(--dim);margin-top:6px;letter-spacing:3px;text-transform:uppercase">AI Drama Studio v3.0 // Cyberpunk Edition</div>
        </div>
        <div style="text-align:center">
            <div style="font-family:'Orbitron',monospace;font-size:10px;color:var(--dim);letter-spacing:2px">3-15 MIN/EP ¬∑ AIÂãïÊÖãÊº´Áï´</div>
            <div style="font-size:8px;color:var(--dim);margin-top:4px;letter-spacing:1px">NOT BRAINLESS SHORT DRAMA</div>
        </div>
        <div class="header-info">
            <span class="badge" id="novelStats">STANDBY</span>
            <span class="badge active">256 SKILLS</span>
            <span class="badge">30 AGENTS</span>
        </div>
    </header>
    
    <main class="main">
        <!-- Left Panel: Steps -->
        <aside class="panel-left">
            <h2>üìã Ë£Ω‰ΩúÊµÅÁ®ã</h2>
            <ul class="step-list" id="stepList"></ul>
            
            <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
                <h2>üìä Áï∂ÂâçÈÄ≤Â∫¶</h2>
                <div class="progress-wrap">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
                    <div class="progress-text" id="progressText">0% - Ê∫ñÂÇôÈñãÂßã</div>
                </div>
            </div>
        </aside>
        
        <!-- Center: Content -->
        <section class="panel-center" id="contentArea">
            <!-- Dynamic content will be inserted here -->
        </section>
        
        <!-- Right Panel: Output -->
        <aside class="panel-right">
            <!-- Agent + Skills Ê∏ÖÂñÆ -->
            <div id="agentSkillsPanel" style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)">
                <h2>ü§ñ Áï∂ÂâçÊô∫ËÉΩÈ´î</h2>
                <div id="currentAgentInfo"></div>
            </div>
            
            <h2>üìÅ Ëº∏Âá∫ÊñáÊ™î</h2>
            <div id="outputFiles"></div>
            
            <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
                <h2>üì§ Â∞éÂá∫</h2>
                <button class="export-btn" onclick="exportJSON()">üìÑ Â∞éÂá∫JSON</button>
                <button class="export-btn" onclick="exportCSV()">üìä Â∞éÂá∫CSV</button>
                <button class="export-btn" onclick="exportPrompts()">üñºÔ∏è Â∞éÂá∫Prompts</button>
            </div>
        </aside>
    </main>
</div>

<script>
// ==================== Á≥ªÁµ±ÈÖçÁΩÆ ====================
const STEPS = [
    {id:1, name:'Â∞éÂÖ•Â∞èË™™', desc:'‰∏äÂÇ≥ÊàñË≤ºÂÖ•10Ëê¨Â≠óÂ∞èË™™', icon:'üìñ'},
    {id:2, name:'ÂâµÊÑèË®™Ë´á', desc:'10ÂÄãÂïèÈ°åÊ∑±ÂÖ•‰∫ÜËß£ÊïÖ‰∫ã', icon:'üé§'},
    {id:3, name:'È´òÊ¶ÇÂøµ', desc:'ÁîüÊàêLoglineÂíåÈ°ûÂûãÂÆö‰Ωç', icon:'üí°'},
    {id:4, name:'Á´†ÁØÄÊãÜÂàÜ', desc:'Êô∫ËÉΩÂàÜÊûêÁ´†ÁØÄÁµêÊßã', icon:'üìë'},
    {id:5, name:'ËßíËâ≤Ë®≠Ë®à', desc:'‰∏ªËßí+ÈÖçËßí+Áæ§Êºî', icon:'üë•'},
    {id:6, name:'ÊúçÂåñÈÅì', desc:'ÊúçË£ù„ÄÅÂåñÂ¶ù„ÄÅÈÅìÂÖ∑', icon:'üëî'},
    {id:7, name:'Á´†ÁØÄÂäáÊú¨', desc:'ÈÄêÁ´†Êí∞ÂØ´ÂàÜÂ†¥ÂäáÊú¨', icon:'‚úçÔ∏è'},
    {id:8, name:'ÂàÜÈè°Ë®≠Ë®à', desc:'Â†¥ÊôØ+‰∏ªÈ´î+Prompt', icon:'üé¨'},
    {id:9, name:'ÂÆåÊàêËº∏Âá∫', desc:'Â∞éÂá∫ÂÖ®ÈÉ®Ë£Ω‰ΩúË≥áÊñô', icon:'üéâ'}
];

// ==================== AIÊ∑±Â∫¶ÈòÖËØªÁ≥ªÁªü ====================
// ÈááËÆøAgentÂÖàÈòÖËØªÂ∞èËØ¥ÔºåÁêÜËß£ÂÜÖÂÆπÂêéÂÜçËÆæËÆ°ÈíàÂØπÊÄßÈóÆÈ¢ò

// ÁîüÊàêAIÂàÜÊûêPromptÔºàËÆ©Áî®Êà∑Â§çÂà∂Âà∞ChatGPT/ClaudeÔºâ
function generateAnalysisPrompt() {
    const novel = state.novel;
    if (!novel?.text) return '';
    
    // ÂèñÂ∞èËØ¥ÊëòË¶ÅÔºàÂºÄÂ§¥ + ‰∏≠Èó¥ + ÁªìÂ∞æÔºâ
    const text = novel.text;
    const len = text.length;
    const sampleStart = text.substring(0, Math.min(3000, len));
    const sampleMid = len > 8000 ? text.substring(Math.floor(len/2) - 1500, Math.floor(len/2) + 1500) : '';
    const sampleEnd = len > 5000 ? text.substring(len - 2000) : '';
    
    return `‰Ω†ÊòØ‰∏Ä‰ΩçË≥áÊ∑±Á∑®ÂäáÈ°ßÂïèÔºåÊ≠£Âú®Èñ±ËÆÄ‰∏ÄÈÉ®Â∞èË™™ÔºåÊ∫ñÂÇôËàáÂâµ‰ΩúËÄÖÈÄ≤Ë°åÊ∑±Â∫¶Ë®™Ë´á„ÄÇ

„ÄêÂ∞èË™™Ê®ôÈ°å„Äë${novel.title || 'Êú™ÂëΩÂêç'}
„ÄêÂ≠óÊï∏„ÄëÁ¥Ñ${Math.round(len/10000*10)/10}Ëê¨Â≠ó

„ÄêÂ∞èË™™ÊëòË¶Å„Äë
---ÈñãÈ†≠---
${sampleStart}
${sampleMid ? `\n---‰∏≠ÊÆµ---\n${sampleMid}` : ''}
${sampleEnd ? `\n---ÁµêÂ∞æ---\n${sampleEnd}` : ''}
---

Ë´ãÂàÜÊûêÈÄôÈÉ®Â∞èË™™Ôºå‰ª•JSONÊ†ºÂºèËøîÂõûÔºö

\`\`\`json
{
  "title": "‰ΩúÂìÅÊ®ôÈ°å",
  "genre": "È°ûÂûãÔºàÊ≠¶‰ø†/Ë®ÄÊÉÖ/Êá∏Áñë/Ê≠∑Âè≤/ÁßëÂπªÁ≠âÔºâ",
  "era": "ÊôÇ‰ª£ËÉåÊôØ",
  "setting": "‰∏ªË¶ÅÂ†¥ÊôØÂú∞Èªû",
  "protagonist": {
    "name": "‰∏ªËßíÂßìÂêç",
    "identity": "Ë∫´‰ªΩ/ËÅ∑Ê•≠",
    "trait": "Ê†∏ÂøÉÁâπË≥™Ôºà‰∏ÄÂè•Ë©±Ôºâ",
    "want": "Ë°®Èù¢ÊÉ≥Ë¶Å‰ªÄÈ∫º",
    "wound": "ÂÖßÂøÉÂâµÂÇ∑/Áº∫Èô∑"
  },
  "antagonist": {
    "name": "Â∞çÊâã/ÂèçÊ¥æÂßìÂêç",
    "identity": "Ë∫´‰ªΩ",
    "motivation": "ÂãïÊ©ü"
  },
  "supporting": [
    {"name": "ÈÖçËßí1", "role": "Ëàá‰∏ªËßíÈóú‰øÇ", "function": "Êïò‰∫ãÂäüËÉΩ"}
  ],
  "core_conflict": "‰∏ÄÂè•Ë©±ÊèèËø∞Ê†∏ÂøÉË°ùÁ™Å",
  "theme": "‰∏ªÈ°å/ÊÉ≥Êé¢Ë®éÁöÑË≠∞È°å",
  "key_scenes": [
    {"scene": "ÈóúÈçµÂ†¥ÊôØ1ÊèèËø∞", "why": "ÁÇ∫‰ªÄÈ∫ºÈáçË¶Å"},
    {"scene": "ÈóúÈçµÂ†¥ÊôØ2ÊèèËø∞", "why": "ÁÇ∫‰ªÄÈ∫ºÈáçË¶Å"},
    {"scene": "ÈóúÈçµÂ†¥ÊôØ3ÊèèËø∞", "why": "ÁÇ∫‰ªÄÈ∫ºÈáçË¶Å"}
  ],
  "questions": [
    "Âü∫ÊñºÂäáÊÉÖÁöÑÊé°Ë®™ÂïèÈ°å1ÔºàÈáùÂ∞çÂÖ∑È´î‰∫∫Áâ©/ÊÉÖÁØÄÔºâ",
    "Âü∫ÊñºÂäáÊÉÖÁöÑÊé°Ë®™ÂïèÈ°å2",
    "Âü∫ÊñºÂäáÊÉÖÁöÑÊé°Ë®™ÂïèÈ°å3",
    "Âü∫ÊñºÂäáÊÉÖÁöÑÊé°Ë®™ÂïèÈ°å4",
    "Âü∫ÊñºÂäáÊÉÖÁöÑÊé°Ë®™ÂïèÈ°å5"
  ],
  "adaptation_notes": "ÊîπÁ∑®Âª∫Ë≠∞ÔºàÂì™‰∫õÈÅ©ÂêàË¶ñË¶∫ÂåñÔºåÂì™‰∫õÈúÄË¶ÅË™øÊï¥Ôºâ"
}
\`\`\`

Ê≥®ÊÑèÔºö
1. questionsÂøÖÈ†àÊòØÈáùÂ∞çÈÄôÂÄãÂÖ∑È´îÊïÖ‰∫ãÁöÑÂïèÈ°åÔºå‰æãÂ¶Ç„ÄåÂ∞èÁå¥Â≠êÁÇ∫‰ªÄÈ∫ºÈÅ∏ÊìáÈõ¢ÈñãËïÉÈÉ®Ôºü„ÄçËÄå‰∏çÊòØ„Äå‰∏ªËßíÁÇ∫‰ªÄÈ∫ºÈõ¢ÈñãÂÆ∂ÈÑâÔºü„Äç
2. ÂïèÈ°åË¶ÅËÉΩÊåñÊéòÂâµ‰ΩúËÄÖÁöÑÊ∑±Â±§ÊÑèÂúñÔºåËÄå‰∏çÊòØÂ∞èË™™Ë£°Â∑≤Á∂ìÂØ´ÊòéÁöÑÂÖßÂÆπ
3. Ë´ãÁî®ÁπÅÈ´î‰∏≠ÊñáÂõûÁ≠î`;
}

// Ëß£ÊûêAIËøîÂõûÁöÑÂàÜÊûêÁªìÊûú
function parseAIAnalysis(text) {
    try {
        // Â∞ùËØïÊèêÂèñJSONÂùó
        const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || 
                         text.match(/```\s*([\s\S]*?)\s*```/) ||
                         text.match(/\{[\s\S]*\}/);
        
        if (jsonMatch) {
            const jsonStr = jsonMatch[1] || jsonMatch[0];
            return JSON.parse(jsonStr);
        }
    } catch (e) {
        console.error('Ëß£ÊûêAIÂàÜÊûêÂ§±Êïó:', e);
    }
    return null;
}

// Âü∫‰∫éAIÂàÜÊûêÁîüÊàêÁúüÊ≠£ÈíàÂØπÊÄßÁöÑÈááËÆøÈóÆÈ¢ò
function generateQuestionsFromAnalysis(analysis) {
    const questions = [];
    
    // Â¶ÇÊûúAIÂ∑≤ÁªèÁîüÊàê‰∫ÜÈóÆÈ¢òÔºåÁõ¥Êé•‰ΩøÁî®
    if (analysis.questions && analysis.questions.length > 0) {
        analysis.questions.forEach((q, i) => {
            questions.push({
                id: `ai_q_${i}`,
                layer: 'ü§ñ AIÈñ±ËÆÄÁêÜËß£',
                question: q,
                usedBy: ['ÂÖ®ÈÉ®Agent'],
                example: 'üí° ÈÄôÊòØAIÂü∫ÊñºÂ∞èË™™ÂÖßÂÆπÁîüÊàêÁöÑÈáùÂ∞çÊÄßÂïèÈ°å',
                fromAI: true
            });
        });
    }
    
    // Ë°•ÂÖÖÂü∫‰∫éÂàÜÊûêÁöÑÁªìÊûÑÂåñÈóÆÈ¢ò
    const p = analysis.protagonist;
    if (p?.name) {
        questions.push({
            id: 'char_design',
            layer: '‚ë° ËßíËâ≤Ë®≠Ë®à',
            question: `„Äå${p.name}„Äç${p.trait ? `Ë¢´Ë®≠ÂÆöÁÇ∫${p.trait}` : ''}ÔºåÈÄôÂÄãËßíËâ≤ÁöÑÂéüÂûã‰æÜËá™Âì™Ë£°ÔºüÁÇ∫‰ªÄÈ∫ºÈÅ∏ÊìáÈÄôÊ®£ÁöÑË®≠ÂÆöÔºü`,
            usedBy: ['üë§ËßíËâ≤', 'üé≠Ë°®Êºî'],
            example: `üí° AIË≠òÂà•Ôºö${p.name}Ôºà${p.identity || '‰∏ªËßí'}Ôºâ- ${p.trait || ''}`
        });
        
        if (p.want && p.wound) {
            questions.push({
                id: 'char_arc',
                layer: '‚ë° ËßíËâ≤Ë®≠Ë®à',
                question: `${p.name}Ë°®Èù¢ËøΩÊ±Ç„Äå${p.want}„ÄçÔºå‰ΩÜÂÖßÂøÉÁöÑÂÇ∑ÁóõÊòØ„Äå${p.wound}„Äç„ÄÇÈÄôÂÖ©ËÄÖÂ¶Ç‰ΩïÂú®ÊïÖ‰∫ã‰∏≠Áî¢ÁîüÂºµÂäõÔºü`,
                usedBy: ['üë§ËßíËâ≤', '‚úçÔ∏èÁ∑®Âäá'],
                example: 'üí° ÂèÉËÄÉMcKeeÔºöWant vs NeedÁöÑÂ∑ÆË∑ùÂâµÈÄ†ËßíËâ≤ÂºßÁ∑ö'
            });
        }
    }
    
    // Ê†∏ÂøÉÂÜ≤Á™ÅÈóÆÈ¢ò
    if (analysis.core_conflict) {
        questions.push({
            id: 'conflict',
            layer: '‚ë£ Ë°ùÁ™ÅÁµêÊßã',
            question: `ÊïÖ‰∫ãÁöÑÊ†∏ÂøÉË°ùÁ™ÅÊòØ„Äå${analysis.core_conflict}„ÄçÔºåÈÄôÂÄãË°ùÁ™ÅÊúÄÁµÇÂ¶Ç‰ΩïËß£Ê±∫Ôºü‰Ω†ÊÉ≥ÂÇ≥ÈÅî‰ªÄÈ∫ºÔºü`,
            usedBy: ['‚úçÔ∏èÁ∑®Âäá', 'üé¨Á∏ΩÂ∞éÊºî'],
            example: 'üí° AIË≠òÂà•ÁöÑÊ†∏ÂøÉË°ùÁ™Å'
        });
    }
    
    // ÂÖ≥ÈîÆÂú∫ÊôØÈóÆÈ¢ò
    if (analysis.key_scenes?.length > 0) {
        const sceneNames = analysis.key_scenes.map(s => s.scene).join('„ÄÅ');
        questions.push({
            id: 'key_scenes',
            layer: '‚ë£ Ë°ùÁ™ÅÁµêÊßã',
            question: `AIË≠òÂà•Âá∫ÁöÑÈóúÈçµÂ†¥ÊôØÔºö${sceneNames}„ÄÇÂ¶ÇÊûúÂè™ËÉΩ‰øùÁïôÂÖ∂‰∏≠‰∏âÂ†¥Ôºå‰Ω†ÊúÉÊÄéÈ∫ºÈÅ∏ÔºüÁÇ∫‰ªÄÈ∫ºÔºü`,
            usedBy: ['üé¨Á∏ΩÂ∞éÊºî', 'üé•ÂàÜÈè°'],
            example: 'üí° ÈÄô‰∫õÂ†¥ÊôØÊòØÊïò‰∫ãÊ†∏ÂøÉÔºåÊîπÁ∑®ÊôÇÈúÄË¶ÅÈáçÈªûËôïÁêÜ'
        });
    }
    
    // ‰∏ªÈ¢òÈóÆÈ¢ò
    if (analysis.theme) {
        questions.push({
            id: 'theme',
            layer: '‚ë† Ââµ‰ΩúÊÑèÂúñ',
            question: `ÈÄôÂÄãÊïÖ‰∫ãÁöÑ‰∏ªÈ°åÊòØ„Äå${analysis.theme}„ÄçÂóéÔºüÈÇÑÊòØ‰Ω†ÊÉ≥Âº∑Ë™øÂÖ∂‰ªñÈù¢ÂêëÔºü`,
            usedBy: ['üí°È´òÊ¶ÇÂøµ', '‚úçÔ∏èÁ∑®Âäá'],
            example: 'üí° AIÂ∞ç‰∏ªÈ°åÁöÑÁêÜËß£ÔºåÈúÄË¶ÅÂâµ‰ΩúËÄÖÁ¢∫Ë™ç'
        });
    }
    
    // ÊîπÁºñËæπÁïåÈóÆÈ¢ò
    questions.push({
        id: 'must_keep',
        layer: '‚ë§ Ââµ‰ΩúÈÇäÁïå',
        question: `ÊîπÁ∑®ÊàêÁï™ÂäáÊôÇÔºåÂì™‰∫õÂÖÉÁ¥†ÁµïÂ∞ç‰∏çËÉΩÂãïÔºüÔºàËßíËâ≤„ÄÅÂè∞Ë©û„ÄÅÂ†¥ÊôØ„ÄÅÁµêÂ±Ä‚Ä¶Ôºâ`,
        usedBy: ['üé¨Á∏ΩÂ∞éÊºî', 'üìöÊîπÁ∑®'],
        example: 'üí° ÊòéÁ¢∫Ââµ‰ΩúÁ¥ÖÁ∑öÔºåÈÅøÂÖçÊîπÁ∑®ÂÅèÈõ¢ÂéüÊÑè'
    });
    
    questions.push({
        id: 'can_change',
        layer: '‚ë§ Ââµ‰ΩúÈÇäÁïå',
        question: `Âì™‰∫õÂú∞ÊñπÂèØ‰ª•Â§ßËÜΩÊîπÂãïÔºüÊúâÊ≤íÊúâÂéü‰ΩúÊ≤íÂ±ïÈñã„ÄÅÂ∏åÊúõÊîπÁ∑®ËÉΩË£úÂÖÖÁöÑÔºü`,
        usedBy: ['üìöÊîπÁ∑®', '‚úçÔ∏èÁ∑®Âäá'],
        example: 'üí° ‰æãÂ¶ÇÔºöÊÑüÊÉÖÁ∑öÂä†Âº∑„ÄÅÈÖçËßíÂêà‰Ωµ„ÄÅÁØÄÂ•èË™øÊï¥'
    });
    
    questions.push({
        id: 'reference',
        layer: '‚ë§ È¢®Ê†ºÊñπÂêë',
        question: `ÊúâÂèÉËÄÉ‰ΩúÂìÅÂóéÔºüÂ∏åÊúõË¶ñË¶∫È¢®Ê†ºÊé•Ëøë‰ªÄÈ∫ºÔºüÂèØ‰ª•Áî®„ÄåA + B„ÄçÊèèËø∞„ÄÇ`,
        usedBy: ['üé¨Á∏ΩÂ∞éÊºî', 'üé®ÁæéË°ì', 'üñºÔ∏èPrompt'],
        example: 'üí° ‰æãÂ¶ÇÔºö„ÄäÁëØÁêäÊ¶ú„ÄãÁöÑÊ∞õÂúç + „ÄäÈ¨ºÊªÖ„ÄãÁöÑÊà∞È¨•ÁæéÂ≠∏'
    });
    
    return questions;
}

// ÂÖºÂÆπÊóß‰ª£Á†ÅÁöÑÂõ∫ÂÆöÈóÆÈ¢òÔºàÂ§áÁî®Ôºâ
const INTERVIEW_QUESTIONS_FALLBACK = [
    {id:'origin', layer:'‚ë† Ââµ‰ΩúÊÑèÂúñ', question:'ÁÇ∫‰ªÄÈ∫ºÊÉ≥Ë¨õÈÄôÂÄãÊïÖ‰∫ãÔºüÈùàÊÑü‰æÜËá™Âì™Ë£°Ôºü', 
     usedBy:['üí°È´òÊ¶ÇÂøµ'], example:'üí° Ë´ãÊèèËø∞Ââµ‰ΩúÁöÑËµ∑Èªû'},
    {id:'emotion', layer:'‚ë† Ââµ‰ΩúÊÑèÂúñ', question:'‰Ω†Â∏åÊúõËßÄÁúæÁúãÂÆåÂæåÔºåÂøÉË£°Áïô‰∏ã‰ªÄÈ∫ºÊÑüÂèóÔºü', 
     usedBy:['üí°È´òÊ¶ÇÂøµ','üé®ÁæéË°ì'], example:'üí° Ê∫´ÊöñÊ≤ªÁôíÔºüÈúáÊíºÂèçÊÄùÔºüÁàΩÂø´Ëß£Â£ìÔºü'},
    {id:'must_keep', layer:'‚ë§ Ââµ‰ΩúÈÇäÁïå', question:'ÊîπÁ∑®ÊôÇÂì™‰∫õÂÖÉÁ¥†ÁµïÂ∞ç‰∏çËÉΩÂãïÔºü', 
     usedBy:['üé¨Á∏ΩÂ∞éÊºî'], example:'üí° ËßíËâ≤„ÄÅÂè∞Ë©û„ÄÅÂ†¥ÊôØ„ÄÅÁµêÂ±Ä...'},
    {id:'reference', layer:'‚ë§ È¢®Ê†ºÊñπÂêë', question:'ÊúâÂèÉËÄÉ‰ΩúÂìÅÂóéÔºüÂ∏åÊúõÈ¢®Ê†ºÊé•Ëøë‰ªÄÈ∫ºÔºü', 
     usedBy:['üé®ÁæéË°ì','üñºÔ∏èPrompt'], example:'üí° Áî®„ÄåA + B„ÄçÊèèËø∞'}
];

// ÊóßÁöÑ generateDynamicQuestions Â∑≤ÁßªËá≥ generateQuestionsFromAnalysis

// ‰∏ªÈ´îÈ°ûÂûã
const SUBJECT_TYPES = {
    person: {label:'‰∫∫Áâ©', color:'primary', icon:'üë§'},
    animal: {label:'ÂãïÁâ©', color:'dim', icon:'üêæ'},
    crowd: {label:'Áæ§Êºî', color:'warning', icon:'üë•'},
    object: {label:'Áâ©È´î', color:'dim', icon:'üì¶'},
    none: {label:'Á©∫Èè°', color:'dim', icon:'üèûÔ∏è'}
};

// ÁãÄÊÖã
let state = {
    currentStep: 1,
    novel: {
        text: '',
        title: '',
        wordCount: 0
    },
    aiAnalysis: null,      // AIÊ∑±Â∫¶Èñ±ËÆÄÂàÜÊûêÁµêÊûú
    aiAnalysisRaw: '',     // ÂéüÂßãJSONÊñáÊú¨
    interview: {},         // Ë®™Ë´áÂõûÁ≠î
    concept: {
        logline: '',
        genre: '',
        theme: '',
        audience: ''
    },
    chapters: [],
    characters: {
        main: [],      // ‰∏ªËßí
        supporting: [], // ÈÖçËßí
        extras: []      // Áæ§Êºî
    },
    costumes: {},
    scripts: [],
    storyboard: []
};

// ==================== ÂàùÂßãÂåñ ====================
function init(){
    renderSteps();
    showStep(1);
    updateProgress();
    updateAgentSkillsPanel(1);
}

function renderSteps(){
    const html = STEPS.map(s => `
        <li class="step-item ${s.id === state.currentStep ? 'active' : ''} ${s.id < state.currentStep ? 'done' : ''}" 
            onclick="goToStep(${s.id})">
            <div class="step-num">${s.id < state.currentStep ? '' : s.id}</div>
            <div class="step-info">
                <div class="step-title">${s.icon} ${s.name}</div>
                <div class="step-desc">${s.desc}</div>
            </div>
        </li>
    `).join('');
    document.getElementById('stepList').innerHTML = html;
}

function updateProgress(){
    const total = STEPS.length;
    const pct = Math.round(((state.currentStep - 1) / (total - 1)) * 100);
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressText').textContent = `${pct}% - ${STEPS[state.currentStep-1]?.name || ''}`;
}

function goToStep(step){
    if(step <= state.currentStep){
        state.currentStep = step;
        renderSteps();
        showStep(step);
        updateProgress();
    }
}

function nextStep(){
    if(state.currentStep < STEPS.length){
        state.currentStep++;
        renderSteps();
        showStep(state.currentStep);
        updateProgress();
    }
}

// ==================== Ê≠•È©üÂÖßÂÆπ ====================
function showStep(step){
    const content = document.getElementById('contentArea');
    
    switch(step){
        case 1: content.innerHTML = renderStep1(); break;
        case 2: 
            content.innerHTML = renderStepInterview(); 
            break;
        case 3: content.innerHTML = renderStep2(); break;  // È´òÊ¶ÇÂøµ
        case 4: content.innerHTML = renderStep3(); break;  // Á´†ÁØÄ
        case 5: // ËßíËâ≤ - Â∏∂ÊÄùËÄÉÈÅéÁ®ã
            content.innerHTML = renderStep4();
            // Â¶ÇÊûúÈúÄË¶ÅÁîüÊàêËßíËâ≤ÔºåÂïüÂãïÊÄùËÄÉÂãïÁï´
            if(!state.characters?.main?.length && document.getElementById('characterThinking')){
                showAgentThinking('characterThinking', 'character', () => {
                    state.characters = extractCharacters();
                    content.innerHTML = renderStep4Full();
                });
            }
            break;
        case 6: content.innerHTML = renderStep5(); break;  // ÊúçÂåñÈÅì
        case 7: content.innerHTML = renderStep6(); break;  // ÂäáÊú¨
        case 8: // ÂàÜÈè° - Â∏∂ÊÄùËÄÉÈÅéÁ®ã
            content.innerHTML = renderStep7();
            // Â¶ÇÊûúÈúÄË¶ÅÁîüÊàêÂàÜÈè°ÔºåÂïüÂãïÊÄùËÄÉÂãïÁï´
            if(!state.storyboard?.length && document.getElementById('storyboardThinking')){
                showAgentThinking('storyboardThinking', 'storyboard', () => {
                    state.storyboard = generateStoryboard();
                    content.innerHTML = renderStep7Full();
                });
            }
            break;
        case 9: content.innerHTML = renderStep8(); break;  // Ëº∏Âá∫
    }
    
    updateAgentSkillsPanel(step);
    updateOutputPanel();
}

// ==================== API ÈÖçÁΩÆ ====================
// ÂêéÁ´ØÊúçÂä°Âô®Âú∞ÂùÄ - ÂºÄÂèëÁéØÂ¢É
const API_BASE = 'http://34.58.33.115:3001/api';
let apiMode = 'manual'; // 'api' | 'manual'

async function callAgent(endpoint, data) {
    try {
        const res = await fetch(`${API_BASE}/${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error(`APIÈåØË™§: ${res.status}`);
        return await res.json();
    } catch (err) {
        console.error(`Agent APIÈåØË™§:`, err);
        throw err;
    }
}

async function checkApiHealth() {
    try {
        const res = await fetch(`${API_BASE}/health`);
        const data = await res.json();
        return data.status === 'ok' && data.hasApiKey;
    } catch {
        return false;
    }
}

// ==================== Step 2: ÂâµÊÑèË®™Ë´á ====================
let currentInterviewQ = 0;
let INTERVIEW_QUESTIONS = [];

function renderStepInterview(){
    if(!state.interview) state.interview = {};
    currentInterviewQ = 0;
    
    // Â∑≤ÊúâAIÂàÜÊûêÁµêÊûú ‚Üí Áõ¥Êé•ÈÄ≤ÂÖ•Ë®™Ë´á
    if(state.aiAnalysis && state.interviewReady){
        INTERVIEW_QUESTIONS = generateQuestionsFromAI(state.aiAnalysis);
        return `
            <div class="content-card">
                <h3><span class="icon">üé§</span> ÂâµÊÑèË®™Ë´á</h3>
                <div id="interviewArea">
                    ${renderInterviewQuestion(0)}
                </div>
            </div>
        `;
    }
    
    // È°ØÁ§∫AgentÁïåÈù¢
    return `
        <div class="content-card">
            <h3><span class="icon">ü§ñ</span> Êé°Ë®™Agent</h3>
            
            <div id="agentStatus" style="background:var(--surface2);border-radius:8px;padding:20px;text-align:center">
                <div style="font-size:48px;margin-bottom:12px">üìñ</div>
                <div style="font-size:14px;color:var(--dim);margin-bottom:16px">
                    ÈªûÊìä‰∏ãÊñπÊåâÈàïÔºåËÆìAIÊ∑±Â∫¶Èñ±ËÆÄÂ∞èË™™
                </div>
                <button class="btn btn-primary" onclick="runInterviewAgent()" style="padding:12px 32px;font-size:14px">
                    üöÄ ÈñãÂßãÂàÜÊûê
                </button>
            </div>
            
            <div id="agentProgress" style="display:none;background:var(--surface2);border-radius:8px;padding:20px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <div class="loading-spinner"></div>
                    <div>
                        <div style="font-weight:600" id="agentStatusText">Êé°Ë®™Agent Ê≠£Âú®Èñ±ËÆÄÂ∞èË™™...</div>
                        <div style="font-size:12px;color:var(--dim)" id="agentSubStatus">ÂàÜÊûêËßíËâ≤„ÄÅÂ†¥ÊôØ„ÄÅË°ùÁ™Å...</div>
                    </div>
                </div>
                <div style="background:var(--bg);border-radius:4px;height:4px;overflow:hidden">
                    <div id="agentProgressBar" style="background:var(--primary);height:100%;width:0%;transition:width .5s"></div>
                </div>
            </div>
            
            <div id="agentResult" style="display:none"></div>
        </div>
    `;
}

async function runInterviewAgent(){
    const statusEl = document.getElementById('agentStatus');
    const progressEl = document.getElementById('agentProgress');
    const resultEl = document.getElementById('agentResult');
    const progressBar = document.getElementById('agentProgressBar');
    const statusText = document.getElementById('agentStatusText');
    const subStatus = document.getElementById('agentSubStatus');
    
    statusEl.style.display = 'none';
    progressEl.style.display = 'block';
    progressBar.style.width = '10%';
    
    try {
        // Ê™¢Êü•APIÊòØÂê¶ÂèØÁî®
        const apiOk = await checkApiHealth();
        
        if (apiOk) {
            // ‰ΩøÁî®APIÊ®°Âºè
            statusText.textContent = 'Êé°Ë®™Agent Ê≠£Âú®Èñ±ËÆÄÂ∞èË™™...';
            subStatus.textContent = 'Ë™øÁî® Claude API...';
            progressBar.style.width = '30%';
            
            const result = await callAgent('interview', {
                novel: state.novel.text,
                title: state.novel.title
            });
            
            progressBar.style.width = '100%';
            state.aiAnalysis = result;
            state.interviewReady = true;
            
            // È°ØÁ§∫ÊàêÂäü‰∏¶Ëá™ÂãïÈÄ≤ÂÖ•Ë®™Ë´á
            setTimeout(() => {
                INTERVIEW_QUESTIONS = generateQuestionsFromAI(result);
                showStep(2);
            }, 500);
            
        } else {
            // API‰∏çÂèØÁî® - È°ØÁ§∫ÈåØË™§‰∏¶ÈáçË©¶
            throw new Error('Agent Server ÈÄ£Êé•Â§±ÊïóÔºåË´ãÁ®çÂæåÈáçË©¶');
        }
    } catch (err) {
        progressEl.style.display = 'none';
        resultEl.style.display = 'block';
        resultEl.innerHTML = `
            <div style="background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.3);padding:16px;border-radius:8px;text-align:center">
                <div style="font-size:32px;margin-bottom:12px">‚ö†Ô∏è</div>
                <div style="color:var(--primary);font-weight:600;margin-bottom:8px">ÈÄ£Êé•Â§±Êïó</div>
                <div style="font-size:12px;color:var(--dim);margin-bottom:16px">${err.message}</div>
                <button class="btn btn-primary" onclick="retryInterviewAgent()" style="margin-right:8px">üîÑ ÈáçË©¶</button>
                <button class="btn" onclick="showStep(1)">‚Üê ËøîÂõû</button>
            </div>
        `;
    }
}

function retryInterviewAgent(){
    document.getElementById('agentResult').style.display = 'none';
    document.getElementById('agentStatus').style.display = 'block';
    runInterviewAgent();
}

function renderManualInterviewUI(){
    const prompt = generateClaudeAnalysisPrompt();
    return `
        <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
            <div style="font-size:12px;color:var(--warning);margin-bottom:12px">
                ‚ö†Ô∏è Agent Server Êú™ÂïüÂãïÔºåË´ãÊâãÂãïÊìç‰Ωú
            </div>
            <div style="font-weight:600;margin-bottom:8px">Step 1ÔºöË§áË£Ω Prompt Âà∞ Claude</div>
            <div style="position:relative">
                <textarea id="claudePrompt" class="form-input" style="height:100px;font-size:10px;font-family:monospace" readonly>${prompt}</textarea>
                <button onclick="copyClaudePrompt()" style="position:absolute;top:8px;right:8px;background:var(--primary);border:none;color:#fff;padding:6px 12px;border-radius:4px;font-size:11px;cursor:pointer">üìã Ë§áË£Ω</button>
            </div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
            <div style="font-weight:600;margin-bottom:8px">Step 2ÔºöË≤ºÂõûÁµêÊûú</div>
            <textarea id="claudeResult" class="form-input" style="height:120px" placeholder='Ë≤º‰∏ä Claude ËøîÂõûÁöÑ JSON...'></textarea>
        </div>
        <button class="btn btn-primary" onclick="applyClaudeAnalysis()" style="width:100%">‚úì Á¢∫Ë™ç</button>
    `;
}

// ÁîüÊàêÁµ¶ClaudeÁöÑÂàÜÊûêPrompt
function generateClaudeAnalysisPrompt(){
    const novel = state.novel;
    if(!novel?.text) return '';
    
    const text = novel.text;
    const len = text.length;
    
    // ÂèñÊ®£ÔºöÈñãÈ†≠3000 + ‰∏≠Èñì2000 + ÁµêÂ∞æ2000
    const sample1 = text.substring(0, Math.min(3000, len));
    const sample2 = len > 8000 ? text.substring(Math.floor(len/2)-1000, Math.floor(len/2)+1000) : '';
    const sample3 = len > 5000 ? text.substring(len-2000) : '';
    
    return `‰Ω†ÊòØÂ∞àÊ•≠Á∑®ÂäáÈ°ßÂïèÔºåË´ãÊ∑±Â∫¶Èñ±ËÆÄÈÄôÈÉ®Â∞èË™™ÔºåËøîÂõûJSONÂàÜÊûê„ÄÇ

„ÄêÂ∞èË™™„Äë${novel.title || ''}Ôºà${Math.round(len/10000*10)/10}Ëê¨Â≠óÔºâ

---ÈñãÈ†≠---
${sample1}
${sample2 ? `\n---‰∏≠ÊÆµ---\n${sample2}` : ''}
${sample3 ? `\n---ÁµêÂ∞æ---\n${sample3}` : ''}
---

Ë´ãËøîÂõûJSONÔºàÁõ¥Êé•Ëº∏Âá∫Ôºå‰∏çË¶ÅmarkdownÔºâÔºö
{
  "title": "‰ΩúÂìÅÂêç",
  "genre": "È°ûÂûã",
  "era": "ÊôÇ‰ª£ËÉåÊôØ",
  "characters": [
    {"name": "‰∏ªËßíÂêç", "role": "‰∏ªËßí", "trait": "ÊÄßÊ†ºÁâπÈªû", "want": "ÊÉ≥Ë¶Å‰ªÄÈ∫º", "arc": "ÊàêÈï∑ËÆäÂåñ"},
    {"name": "ËßíËâ≤2", "role": "ÈÖçËßí/ÂèçÊ¥æ", "trait": "ÁâπÈªû", "function": "Êïò‰∫ãÂäüËÉΩ"}
  ],
  "places": [
    {"name": "Âú∞ÈªûÂêç", "significance": "Â∞çÂäáÊÉÖÁöÑÊÑèÁæ©"}
  ],
  "core_conflict": "‰∏ÄÂè•Ë©±Ê†∏ÂøÉË°ùÁ™Å",
  "key_scenes": [
    {"chapter": "Á¨¨XÁ´†", "scene": "Â†¥ÊôØÊèèËø∞", "emotion": "ÊÉÖÁ∑í", "importance": "ÁÇ∫‰ªÄÈ∫ºÈáçË¶Å"}
  ],
  "themes": ["‰∏ªÈ°å1", "‰∏ªÈ°å2"],
  "interview_questions": [
    "Âü∫ÊñºÂäáÊÉÖÁöÑÈáùÂ∞çÊÄßÂïèÈ°å1",
    "Âü∫ÊñºÂäáÊÉÖÁöÑÈáùÂ∞çÊÄßÂïèÈ°å2",
    "Âü∫ÊñºÂäáÊÉÖÁöÑÈáùÂ∞çÊÄßÂïèÈ°å3",
    "Âü∫ÊñºÂäáÊÉÖÁöÑÈáùÂ∞çÊÄßÂïèÈ°å4",
    "Âü∫ÊñºÂäáÊÉÖÁöÑÈáùÂ∞çÊÄßÂïèÈ°å5",
    "Âü∫ÊñºÂäáÊÉÖÁöÑÈáùÂ∞çÊÄßÂïèÈ°å6",
    "Âü∫ÊñºÂäáÊÉÖÁöÑÈáùÂ∞çÊÄßÂïèÈ°å7",
    "Âü∫ÊñºÂäáÊÉÖÁöÑÈáùÂ∞çÊÄßÂïèÈ°å8"
  ]
}

Ê≥®ÊÑèÔºö
1. interview_questionsÂøÖÈ†àÈáùÂ∞çÂÖ∑È´îÂäáÊÉÖÔºå‰æãÂ¶Ç„Äå‰∏ÉÂ®ÉÁÇ∫‰ªÄÈ∫ºÈÅ∏ÊìáÁç®Ëá™ÈÄ≤ÂÖ•Â¶ñÊ¥ûÔºü„Äç
2. ‰∏çË¶ÅÂïèÈÄöÁî®ÂïèÈ°åÂ¶Ç„Äå‰∏ªËßíÁöÑÂãïÊ©üÊòØ‰ªÄÈ∫º„Äç
3. ÂïèÈ°åË¶ÅËÉΩÊåñÊéòÂâµ‰ΩúÊÑèÂúñÔºå‰∏çÊòØË§áËø∞ÂäáÊÉÖ`;
}

function copyClaudePrompt(){
    const textarea = document.getElementById('claudePrompt');
    textarea.select();
    document.execCommand('copy');
    event.target.textContent = '‚úì Â∑≤Ë§áË£Ω';
    setTimeout(() => event.target.textContent = 'üìã Ë§áË£Ω', 2000);
}

function applyClaudeAnalysis(){
    const input = document.getElementById('claudeResult').value.trim();
    if(!input){
        alert('Ë´ãÂÖàË≤ºÂÖ•ClaudeÁöÑÂàÜÊûêÁµêÊûú');
        return;
    }
    
    try {
        // ÂòóË©¶Ëß£ÊûêJSON
        let json = input;
        // ÁßªÈô§ÂèØËÉΩÁöÑmarkdownÊ®ôË®ò
        json = json.replace(/```json\s*/g, '').replace(/```\s*/g, '');
        const analysis = JSON.parse(json);
        
        state.aiAnalysis = analysis;
        state.aiAnalysisRaw = input;
        state.interviewReady = true;
        
        // ÈÄ≤ÂÖ•Ë®™Ë´á
        showStep(2);
    } catch(e) {
        alert('JSONÊ†ºÂºèÈåØË™§ÔºåË´ãÁ¢∫Ë™çClaudeËøîÂõûÁöÑÊòØÊúâÊïàJSON\\n\\nÈåØË™§Ôºö' + e.message);
    }
}

// Âü∫ÊñºAIÂàÜÊûêÁîüÊàêÂïèÈ°å
function generateQuestionsFromAI(analysis){
    const questions = [];
    
    // ÂÑ™ÂÖà‰ΩøÁî®AIÁîüÊàêÁöÑÂïèÈ°å
    if(analysis.interview_questions?.length){
        analysis.interview_questions.forEach((q, i) => {
            questions.push({
                id: `ai_${i}`,
                question: q,
                usedBy: ['ü§ñ AIÊ∑±Â∫¶Èñ±ËÆÄ']
            });
        });
    }
    
    // Ë£úÂÖÖÂü∫ÊñºÂàÜÊûêÁöÑÁµêÊßãÂåñÂïèÈ°å
    if(analysis.characters?.[0]){
        const mc = analysis.characters[0];
        if(!questions.some(q => q.question.includes(mc.name))){
            questions.push({
                id: 'char_main',
                question: `„Äå${mc.name}„Äç${mc.trait ? 'Ôºà'+mc.trait+'Ôºâ' : ''}ÈÄôÂÄãËßíËâ≤ÔºåÂéüÂûã‰æÜËá™Âì™Ë£°Ôºü`,
                usedBy: ['üë§ËßíËâ≤']
            });
        }
    }
    
    if(analysis.core_conflict && questions.length < 10){
        questions.push({
            id: 'conflict',
            question: `„Äå${analysis.core_conflict}„ÄçÈÄôÂÄãË°ùÁ™ÅÔºå‰Ω†Â∏åÊúõËßÄÁúæÁ´ôÂú®Âì™‰∏ÄÈÇäÔºü`,
            usedBy: ['‚úçÔ∏èÁ∑®Âäá']
        });
    }
    
    // ‰øùÂ∫ïÂïèÈ°å
    if(questions.length < 8){
        questions.push({
            id: 'must_keep',
            question: 'ÊîπÁ∑®ÊôÇÂì™‰∫õÁµïÂ∞ç‰∏çËÉΩÂãïÔºüÂì™‰∫õÂèØ‰ª•Â§ßËÜΩÊîπÔºü',
            usedBy: ['üé¨Â∞éÊºî']
        });
        questions.push({
            id: 'style',
            question: 'Ë¶ñË¶∫È¢®Ê†ºÊÉ≥Êé•ËøëÂì™ÈÉ®‰ΩúÂìÅÔºü',
            usedBy: ['üé®ÁæéË°ì']
        });
    }
    
    return questions.slice(0, 10);
}

// Áõ¥Êé•Ê†πÊçÆÂ∞èËØ¥ÂÜÖÂÆπÁîüÊàêÈíàÂØπÊÄßÈóÆÈ¢òÔºàÂÇôÁî®Ôºâ
function generateQuestionsFromNovel(){
    const novel = state.novel;
    if(!novel?.text) return INTERVIEW_QUESTIONS_FALLBACK;
    
    const text = novel.text;
    const questions = [];
    
    // ========== Êô∫ËÉΩÊèêÂèñÊïÖ‰∫ãÂÖÉÁ¥† ==========
    
    // 1. ÊèêÂèñ‰∫∫Áâ©Âêç
    const namePatterns = [
        /[Â§ß‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πù]Â®É/g,  // Â§ßÂ®É„ÄÅ‰∫åÂ®É...‰∏ÉÂ®É
        /Â∞è[\u4e00-\u9fa5]{1,2}(?:Â≠ê|ÂÖí|Â¶π|Âºü|Âßê|Âì•|Â®ò)/g,  // Â∞èÁå¥Â≠ê„ÄÅÂ∞èÂ¶πÂ≠ê
        /[\u4e00-\u9fa5]{1,2}[Èï∑Â∏´Áà∫ÁéãÂÖ¨‰∏ªÂ¶ÉÂ®òÂ´ÇÁ≤æÊÄ™]/g,  // ËïÉÈï∑„ÄÅËõáÁ≤æ
        /ËÄÅ[\u4e00-\u9fa5]{1,2}(?:È†≠|Áà∫|Â§™|‰∫∫|Êº¢)/g,  // ËÄÅ‰∫∫„ÄÅËÄÅÁà∫„ÄÅËÄÅÊº¢
        /Èòø[\u4e00-\u9fa5]{1,2}/g,  // ÈòøÂØ∂„ÄÅÈòøÂº∑
        /[\u4e00-\u9fa5]{2,3}(?:Á≤æ|ÊÄ™|‰ªô|È≠î)/g,  // ËõáÁ≤æ„ÄÅËùéÂ≠êÁ≤æ
    ];
    // ÊéíÈô§Èùû‰∫∫Áâ©ËØç
    const notNames = ['Â∞èËàπ','Â∞èË∑Ø','Â∞èÂæë','Â∞èÂ±ã','Â∞èËåÖÂ±ã','Â∞èÊùë','Â∞èÈéÆ','Â∞èÂ≥∂','Â∞èÂ±±','Â∞èÊ≤≥','Â∞èÊ∫™','Â∞èÊôÇ','Â∞èÂøÉ','Â∞èËÅ≤'];
    
    let allNames = [];
    namePatterns.forEach(p => {
        const matches = text.match(p) || [];
        allNames = allNames.concat(matches);
    });
    
    // È¢ùÂ§ñÊ®°ÂºèÔºö„ÄåXX„ÄçË™™/ÈÅìÔºàÂØπËØù‰∏≠ÁöÑ‰∫∫ÂêçÔºâ
    const dialogNames = text.match(/„Äå[^„Äç]*„Äç([\u4e00-\u9fa5]{2,4})(?:Ë™™|ÈÅì|Âïè|Á¨ë|ÂòÜ)/g) || [];
    dialogNames.forEach(m => {
        const name = m.match(/([\u4e00-\u9fa5]{2,4})(?:Ë™™|ÈÅì|Âïè|Á¨ë|ÂòÜ)/);
        if(name) allNames.push(name[1]);
    });
    
    const names = [...new Set(allNames)]
        .filter(n => n.length >= 2 && n.length <= 4)
        .filter(n => !notNames.includes(n))
        .slice(0, 8);
    
    // 2. ÊèêÂèñÂú∞ÁÇπ
    const placePatterns = [
        /[\u4e00-\u9fa5]{2,6}[ÊùëÈéÆÂüéÊ∏ØÂ≥∂Â±±ÂØ∫ÂªüÂ∫úÊÆøÈÉ®ËêΩ]/g,
        /[\u4e00-\u9fa5]{2,4}(?:Êµ∑|Ëàπ|Á¢ºÈ†≠|Â∏ÇÈõÜ|ÂÆ¢Ê£ß|ÈÖíÊ®ì)/g,
        /Âú®([\u4e00-\u9fa5]{2,6})[Ôºå„ÄÇ]/g,
    ];
    let allPlaces = [];
    placePatterns.forEach(p => {
        const matches = text.match(p) || [];
        allPlaces = allPlaces.concat(matches.map(m => m.replace(/^Âú®|[Ôºå„ÄÇ]$/g, '')));
    });
    const places = [...new Set(allPlaces)].filter(p => p.length >= 2).slice(0, 6);
    
    // 3. ÊèêÂèñÂÖ≥ÈîÆÂä®‰Ωú/‰∫ã‰ª∂
    const eventPatterns = [
        /(Ê±∫ÂÆö|ÈÅ∏Êìá|Èõ¢Èñã|ÈÄÉÈõ¢|ÂõûÂà∞|ÂâçÂæÄ|Â∞ãÊâæ|ËøΩÂ∞ã|ÊîæÊ£Ñ|ÁäßÁâ≤|ËÉåÂèõ|Áõ∏ÈÅá|ÈáçÈÄ¢|ÂëäÂà•|Ê≠ª|ÊÆ∫|Êïë|ÊÑõ|ÊÅ®)[\u4e00-\u9fa5]{0,6}/g,
    ];
    let allEvents = [];
    eventPatterns.forEach(p => {
        const matches = text.match(p) || [];
        allEvents = allEvents.concat(matches);
    });
    const events = [...new Set(allEvents)].slice(0, 5);
    
    // 4. ÊèêÂèñÂØπËØùÁâáÊÆµÔºàÂèØËÉΩÁöÑÈáëÂè•Ôºâ
    const dialogues = text.match(/„Äå[^„Äç]{10,30}„Äç/g) || [];
    const keyDialogues = dialogues.slice(0, 3);
    
    // ========== Âü∫‰∫éÊèêÂèñÂÖÉÁ¥†ÁîüÊàêÈóÆÈ¢ò ==========
    
    // ‰∏ªËßíÈóÆÈ¢ò
    if(names[0]){
        questions.push({
            id: 'q1',
            question: `„Äå${names[0]}„ÄçÁöÑÊ†∏ÂøÉÊÖæÊúõÊòØ‰ªÄÈ∫ºÔºüTAÊúÄÂÆ≥ÊÄï‰ªÄÈ∫ºÔºü`,
            usedBy: ['üë§ËßíËâ≤']
        });
    }
    
    // ËßíËâ≤ÂÖ≥Á≥ªÈóÆÈ¢ò
    if(names[0] && names[1]){
        questions.push({
            id: 'q2',
            question: `${names[0]}Âíå${names[1]}ÁöÑÈóú‰øÇÔºåÁ∂ìÊ≠∑‰∫ÜÊÄéÊ®£ÁöÑËÆäÂåñÔºü`,
            usedBy: ['üë§ËßíËâ≤', '‚úçÔ∏èÁ∑®Âäá']
        });
    }
    
    // Êõ¥Â§öËßíËâ≤ÈóÆÈ¢ò
    if(names[2]){
        questions.push({
            id: 'q3',
            question: `${names[2]}Âú®ÊïÖ‰∫ã‰∏≠ÊâÆÊºî‰ªÄÈ∫ºËßíËâ≤ÔºüÁÇ∫‰ªÄÈ∫ºÈúÄË¶ÅÈÄôÂÄã‰∫∫Áâ©Ôºü`,
            usedBy: ['üë§ËßíËâ≤']
        });
    }
    
    // Âú∫ÊôØÈóÆÈ¢ò
    if(places[0]){
        questions.push({
            id: 'q4',
            question: `ÊïÖ‰∫ãÁÇ∫‰ªÄÈ∫ºÁôºÁîüÂú®„Äå${places[0]}„ÄçÔºüÊèõÂÄãÂú∞ÊñπË°å‰∏çË°åÔºü`,
            usedBy: ['üé®ÁæéË°ì', 'üèõÔ∏èËÄÉÊìö']
        });
    }
    
    if(places[1]){
        questions.push({
            id: 'q5',
            question: `Âæû${places[0]}Âà∞${places[1]}ÔºåÈÄôÊÆµÊóÖÁ®ãË±°Âæµ‰ªÄÈ∫ºÔºü`,
            usedBy: ['‚úçÔ∏èÁ∑®Âäá', 'üé¨Â∞éÊºî']
        });
    }
    
    // ‰∫ã‰ª∂/ÂÜ≤Á™ÅÈóÆÈ¢ò
    if(events[0]){
        questions.push({
            id: 'q6',
            question: `„Äå${events[0]}„ÄçÈÄôÂÄãÊÉÖÁØÄÊòØÊïÖ‰∫ãÁöÑËΩâÊäòÈªûÂóéÔºüÁÇ∫‰ªÄÈ∫ºÈáçË¶ÅÔºü`,
            usedBy: ['‚úçÔ∏èÁ∑®Âäá']
        });
    }
    
    // ÂØπËØù/ÈáëÂè•ÈóÆÈ¢ò
    if(keyDialogues[0]){
        questions.push({
            id: 'q7',
            question: `${keyDialogues[0]} ‚Äî ÈÄôÂè•Ë©±ËÉåÂæåÊÉ≥Ë°®ÈÅî‰ªÄÈ∫ºÔºü`,
            usedBy: ['‚úçÔ∏èÁ∑®Âäá', 'üé≠Ë°®Êºî']
        });
    }
    
    // ‰∏ªÈ¢òÈóÆÈ¢ò
    questions.push({
        id: 'q8',
        question: `ÈÄôÂÄãÊïÖ‰∫ãÊúÄÊÉ≥ËÆìËßÄÁúæÊÄùËÄÉÁöÑÂïèÈ°åÊòØ‰ªÄÈ∫ºÔºü`,
        usedBy: ['üí°È´òÊ¶ÇÂøµ', 'üé¨Â∞éÊºî']
    });
    
    // ÊÉÖÊÑüÈóÆÈ¢ò
    questions.push({
        id: 'q9',
        question: `ÊïÖ‰∫ã‰∏≠ÊúÄËÆì‰Ω†ÊÑüÂãï/ÈúáÊíºÁöÑ‰∏ÄÂπïÊòØÔºüÁÇ∫‰ªÄÈ∫ºÔºü`,
        usedBy: ['üé¨Â∞éÊºî', 'üé®ÁæéË°ì']
    });
    
    // ÊîπÁºñËæπÁïå
    questions.push({
        id: 'q10',
        question: `ÊîπÁ∑®ÊàêÁï™ÂäáÔºåÂì™‰∫õÁµïÂ∞ç‰∏çËÉΩÊîπÔºüÂì™‰∫õÂèØ‰ª•Â§ßËÜΩÊîπÔºü`,
        usedBy: ['üé¨Â∞éÊºî', 'üìöÊîπÁ∑®']
    });
    
    // Á°Æ‰øùËá≥Â∞ë8‰∏™ÈóÆÈ¢ò
    return questions.filter(q => q.question).slice(0, 10);
}

function renderInterviewQuestion(index){
    if(index >= INTERVIEW_QUESTIONS.length){
        return renderInterviewSummary();
    }
    
    const q = INTERVIEW_QUESTIONS[index];
    const prevAnswer = state.interview[q.id] || '';
    
    return `
        <div style="background:var(--surface2);border-radius:12px;padding:20px;margin-bottom:16px">
            <div style="margin-bottom:12px">
                <span style="background:var(--primary);color:#fff;padding:4px 10px;border-radius:12px;font-size:11px">${index+1}/${INTERVIEW_QUESTIONS.length}</span>
            </div>
            
            <p style="font-size:18px;margin-bottom:16px;line-height:1.6;font-weight:500">${q.question}</p>
            
            ${false && q.example ? `
                <div style="font-size:12px;color:var(--dim);margin-bottom:12px;padding:10px;background:var(--bg);border-radius:8px;border-left:3px solid var(--primary);line-height:1.6">
                    ${q.example}
                </div>
            ` : ''}
            
            <div style="font-size:11px;color:var(--dim);margin-bottom:12px;padding:8px;background:var(--bg);border-radius:6px">
                üì§ ‰Ω†ÁöÑÂõûÁ≠îÂ∞áÂΩ±ÈüøÔºö${q.usedBy?.join(' ‚Ä¢ ') || 'ÂÖ®ÈÉ®Agent'}
            </div>
            
            <textarea id="interviewAnswer" class="form-input" style="min-height:100px" placeholder="Ë´ãËá™Áî±ÂõûÁ≠îÔºåË∂äË©≥Á¥∞Ë∂äÂ•Ω...">${prevAnswer}</textarea>
            
            <div class="btn-group" style="margin-top:16px">
                ${index > 0 ? `<button class="btn" onclick="prevInterviewQ()">‚Üê ‰∏ä‰∏ÄÈ°å</button>` : `<button class="btn" onclick="prevStep()">‚Üê ËøîÂõûÂ∞éÂÖ•</button>`}
                <button class="btn btn-primary" onclick="nextInterviewQ()">
                    ${index < INTERVIEW_QUESTIONS.length - 1 ? '‰∏ã‰∏ÄÈ°å ‚Üí' : 'ÂÆåÊàêË®™Ë´á ‚úì'}
                </button>
            </div>
        </div>
        
        <div style="display:flex;gap:4px;justify-content:center">
            ${INTERVIEW_QUESTIONS.map((_, i) => `
                <div style="width:${i===index?'24px':'12px'};height:6px;background:${i<index?'var(--success)':i===index?'var(--primary)':'var(--surface2)'};border-radius:3px;transition:all .3s"></div>
            `).join('')}
        </div>
    `;
}

function renderInterviewSummary(){
    return `
        <div style="background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:12px;padding:20px;margin-bottom:16px">
            <h4 style="color:var(--text);margin-bottom:16px">‚úÖ Ë®™Ë´áÂÆåÊàêÔºÅ</h4>
            
            <div style="display:grid;gap:12px">
                ${INTERVIEW_QUESTIONS.map(q => `
                    <div style="background:var(--surface);padding:12px;border-radius:8px">
                        <div style="font-size:11px;color:var(--dim);margin-bottom:4px;display:flex;align-items:center;gap:6px">
                            ${q.fromAI ? '<span style="color:var(--dim)">ü§ñ</span>' : ''}
                            ${q.question}
                        </div>
                        <div style="font-size:13px">${state.interview[q.id] || 'ÔºàÊú™ÂõûÁ≠îÔºâ'}</div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn" onclick="currentInterviewQ=0;document.getElementById('interviewArea').innerHTML=renderInterviewQuestion(0)">‚úèÔ∏è ‰øÆÊîπÂõûÁ≠î</button>
            <button class="btn btn-primary" onclick="nextStep()">Á¢∫Ë™ç ‚Üí È´òÊ¶ÇÂøµÂàÜÊûê</button>
        </div>
    `;
}

function nextInterviewQ(){
    const answer = document.getElementById('interviewAnswer').value.trim();
    const q = INTERVIEW_QUESTIONS[currentInterviewQ];
    
    // ‰øùÂ≠òÁ≠îÊ°à
    state.interview[q.id] = answer;
    
    currentInterviewQ++;
    document.getElementById('interviewArea').innerHTML = renderInterviewQuestion(currentInterviewQ);
}

function prevInterviewQ(){
    if(currentInterviewQ > 0){
        currentInterviewQ--;
        document.getElementById('interviewArea').innerHTML = renderInterviewQuestion(currentInterviewQ);
    }
}

// ==================== Step 1: Â∞éÂÖ•Â∞èË™™ ====================
function renderStep1(){
    return `
        <div class="content-card">
            <h3><span class="icon">üìñ</span> Â∞éÂÖ•ÊàñÂâµ‰ΩúÂ∞èË™™</h3>
            
            <!-- ÈÅ∏È†ÖÂç° -->
            <div class="tabs" style="margin-bottom:20px">
                <div class="tab active" onclick="showInputMode('upload')">üìÅ ‰∏äÂÇ≥ÊñáÊ™î</div>
                <div class="tab" onclick="showInputMode('paste')">üìù Ë≤ºÂÖ•ÊñáÂ≠ó</div>
                <div class="tab" onclick="showInputMode('generate')">‚ú® AIÂØ´Â∞èË™™</div>
            </div>
            
            <div id="inputModeContent">
                ${renderUploadMode()}
            </div>
        </div>
    `;
}

function showInputMode(mode){
    document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    const content = document.getElementById('inputModeContent');
    switch(mode){
        case 'upload': content.innerHTML = renderUploadMode(); break;
        case 'paste': content.innerHTML = renderPasteMode(); break;
        case 'generate': content.innerHTML = renderGenerateMode(); break;
    }
}

function renderUploadMode(){
    return `
        <p style="color:var(--dim);margin-bottom:20px">ÊîØÊåÅ <strong>TXT„ÄÅWord (.docx)„ÄÅPDF</strong> Ê†ºÂºèÔºåÊúÄÂ§ßÊîØÊåÅ10Ëê¨Â≠ó+</p>
        
        <div class="form-group">
            <label class="form-label">Â∞èË™™Ê®ôÈ°åÔºàÂèØÈÅ∏ÔºåÊúÉËá™ÂãïÂæûÊñáÊ™îÊèêÂèñÔºâ</label>
            <input type="text" class="form-input" id="novelTitle" placeholder="‰æãÔºöÊµ∑‰∏äÁµ≤Á∂¢‰πãË∑ØÂØÜÁ¢º" value="${state.novel.title}">
        </div>
        
        <div style="border:2px dashed var(--border);border-radius:12px;padding:40px;text-align:center;margin:20px 0;cursor:pointer" 
             onclick="document.getElementById('fileInput').click()"
             ondragover="event.preventDefault();this.style.borderColor='var(--primary)'"
             ondragleave="this.style.borderColor='var(--border)'"
             ondrop="handleFileDrop(event)">
            <div style="font-size:48px;margin-bottom:16px">üìÑ</div>
            <p style="font-size:16px;margin-bottom:8px">ÊãñÊîæÊñá‰ª∂Âà∞ÈÄôË£°</p>
            <p style="color:var(--dim);font-size:13px">ÊàñÈªûÊìäÈÅ∏ÊìáÊñá‰ª∂</p>
            <p style="color:var(--dim);font-size:12px;margin-top:12px">ÊîØÊåÅ .txt .docx .pdf</p>
        </div>
        
        <input type="file" id="fileInput" accept=".txt,.docx,.pdf" style="display:none" onchange="handleFileUpload(event)">
        
        <div id="uploadStatus" style="margin:16px 0"></div>
        
        <div class="btn-group">
            <button class="btn" onclick="loadDemoNovel()">üìö ËºâÂÖ•Á§∫‰æã</button>
            <button class="btn btn-primary" onclick="analyzeNovel()" id="analyzeBtn" disabled>ÈñãÂßãÂàÜÊûê ‚Üí</button>
        </div>
    `;
}

function renderPasteMode(){
    setTimeout(() => {
        const textarea = document.getElementById('novelText');
        if(textarea){
            textarea.addEventListener('input', updateWordCount);
            updateWordCount();
        }
    }, 100);
    
    return `
        <p style="color:var(--dim);margin-bottom:20px">Áõ¥Êé•Ë≤ºÂÖ•Â∞èË™™ÂÖ®Êñá</p>
        
        <div class="form-group">
            <label class="form-label">Â∞èË™™Ê®ôÈ°å</label>
            <input type="text" class="form-input" id="novelTitle" placeholder="‰æãÔºöÊµ∑‰∏äÁµ≤Á∂¢‰πãË∑ØÂØÜÁ¢º" value="${state.novel.title || ''}">
        </div>
        
        <div class="form-group">
            <label class="form-label">Â∞èË™™Ê≠£Êñá</label>
            <textarea class="form-input" id="novelText" style="min-height:350px" placeholder="Â∞áÂ∞èË™™ÂÖ®ÊñáË≤ºÂÖ•Ê≠§Ëôï..." oninput="updateWordCount()">${state.novel.text || ''}</textarea>
        </div>
        
        <div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0">
            <span id="wordCount" style="color:var(--dim);font-size:13px">${state.novel.text ? state.novel.text.length + ' Â≠ó' : '0 Â≠ó'}</span>
        </div>
        
        <div class="btn-group">
            <button class="btn" onclick="loadDemoNovelPaste()">üìö ËºâÂÖ•Á§∫‰æã</button>
            <button class="btn btn-primary" onclick="analyzeNovelFromPaste()">ÈñãÂßãÂàÜÊûê ‚Üí</button>
        </div>
    `;
}

function updateWordCount(){
    const textarea = document.getElementById('novelText');
    const countSpan = document.getElementById('wordCount');
    if(textarea && countSpan){
        const count = textarea.value.length;
        countSpan.textContent = count.toLocaleString() + ' Â≠ó';
        countSpan.style.color = count > 1000 ? 'var(--success)' : 'var(--dim)';
    }
}

function loadDemoNovelPaste(){
    const titleInput = document.getElementById('novelTitle');
    const textArea = document.getElementById('novelText');
    
    if(titleInput) titleInput.value = 'Êµ∑‰∏äÁµ≤Á∂¢‰πãË∑ØÂØÜÁ¢º';
    if(textArea) textArea.value = DEMO_NOVEL;
    
    updateWordCount();
}

function renderGenerateMode(){
    return `
        <p style="color:var(--dim);margin-bottom:20px">ÂëäË®¥AI‰Ω†ÊÉ≥Ë¶Å‰ªÄÈ∫ºÊ®£ÁöÑÊïÖ‰∫ãÔºåAIÊúÉÁÇ∫‰Ω†Ââµ‰ΩúÂ∞èË™™</p>
        
        <div class="form-group">
            <label class="form-label">ÊïÖ‰∫ãÈ°ûÂûã</label>
            <select class="form-input" id="storyGenre">
                <option value="Ê≠∑Âè≤ÂÜíÈö™">üèõÔ∏è Ê≠∑Âè≤ÂÜíÈö™</option>
                <option value="‰ªô‰ø†">‚öîÔ∏è ‰ªô‰ø†</option>
                <option value="ÈÉΩÂ∏ÇË®ÄÊÉÖ">üíï ÈÉΩÂ∏ÇË®ÄÊÉÖ</option>
                <option value="Êá∏ÁñëÊé®ÁêÜ">üîç Êá∏ÁñëÊé®ÁêÜ</option>
                <option value="ÁßëÂπª">üöÄ ÁßëÂπª</option>
                <option value="Â•áÂπª">üêâ Â•áÂπª</option>
                <option value="ÊÅêÊÄñ">üëª ÊÅêÊÄñ</option>
                <option value="ËÅ∑Â†¥">üíº ËÅ∑Â†¥</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">ÊïÖ‰∫ãË®≠ÂÆö / ‰Ω†ÁöÑÊÉ≥Ê≥ï</label>
            <textarea class="form-input" id="storyIdea" style="min-height:150px" placeholder="‰æãÂ¶ÇÔºö&#10;- Âîê‰ª£Âª£Â∑ûÔºå‰∏ÄÂÄãÂ∞èÂÅ∑ÂÅ∂ÁÑ∂ÂæóÂà∞Á•ûÁßòÂØ∂Áü≥&#10;- Ë¢´Ëø´Êç≤ÂÖ•Êµ∑‰∏äÁµ≤Á∂¢‰πãË∑ØÁöÑÂÜíÈö™&#10;- ÈÅáÂà∞Á•ûÁßòÂ∞ëÂ•≥ÔºåËß£ÈñãÂçÉÂπ¥Ë©õÂíí‰πãË¨é&#10;- ÊÉ≥Ë¶ÅÊúâÊµ∑Áõú„ÄÅÂØÜÂÆ§ÊÆ∫‰∫∫„ÄÅËº™Ëø¥ÂÖÉÁ¥†"></textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">ÁõÆÊ®ôÁØáÂπÖ</label>
            <select class="form-input" id="storyLength">
                <option value="Áü≠ÁØá">Áü≠ÁØáÔºà1-2Ëê¨Â≠óÔºâ</option>
                <option value="‰∏≠ÁØá" selected>‰∏≠ÁØáÔºà5-10Ëê¨Â≠óÔºâ</option>
                <option value="Èï∑ÁØá">Èï∑ÁØáÔºà20Ëê¨Â≠ó+Ôºâ</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">ÂèÉËÄÉ‰ΩúÂìÅÈ¢®Ê†ºÔºàÂèØÈÅ∏Ôºâ</label>
            <input type="text" class="form-input" id="storyReference" placeholder="‰æãÔºöÂä†ÂãíÊØîÊµ∑Áõú + Èï∑ÂÆâÂçÅ‰∫åÊôÇËæ∞">
        </div>
        
        <div id="generateStatus" style="margin:16px 0"></div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="generateNovel()">‚ú® ÈñãÂßãÂâµ‰ΩúÂ∞èË™™</button>
        </div>
    `;
}

function handleFileUpload(event){
    const file = event.target.files[0];
    if(file){
        processFile(file);
    }
}

function handleFileDrop(event){
    event.preventDefault();
    event.target.style.borderColor = 'var(--border)';
    const file = event.dataTransfer.files[0];
    if(file){
        processFile(file);
    }
}

function processFile(file){
    const statusDiv = document.getElementById('uploadStatus');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const ext = file.name.split('.').pop().toLowerCase();
    
    statusDiv.innerHTML = `<div class="loading"><div class="spinner"></div>Ê≠£Âú®ËÆÄÂèñ ${file.name}...</div>`;
    
    if(ext === 'txt'){
        // TXT Áõ¥Êé•ËÆÄÂèñ
        const reader = new FileReader();
        reader.onload = function(e){
            const text = e.target.result;
            state.novel.text = text;
            state.novel.title = document.getElementById('novelTitle').value || file.name.replace('.txt','');
            showUploadSuccess(file.name, text.length);
        };
        reader.readAsText(file);
    } 
    else if(ext === 'docx'){
        // DOCX ‰ΩøÁî® mammoth.js Ëß£Êûê
        statusDiv.innerHTML = `
            <div style="padding:16px;background:var(--surface2);border-radius:8px">
                <div style="display:flex;align-items:center;gap:12px">
                    <div class="spinner" style="width:24px;height:24px"></div>
                    <div>
                        <p style="color:var(--dim)">üìÑ Ê≠£Âú®Ëß£Êûê Word ÊñáÊ™î...</p>
                        <p style="color:var(--dim);font-size:11px;margin-top:4px">‰ΩøÁî® mammoth.js ÊèêÂèñÊñáÂ≠óÂÖßÂÆπ</p>
                    </div>
                </div>
            </div>
        `;
        
        const reader = new FileReader();
        reader.onload = function(e){
            const arrayBuffer = e.target.result;
            
            // ‰ΩøÁî® mammoth.js Ëß£Êûê DOCX
            if(typeof mammoth !== 'undefined'){
                mammoth.extractRawText({arrayBuffer: arrayBuffer})
                    .then(function(result){
                        const text = result.value;
                        if(text && text.length > 0){
                            state.novel.text = text;
                            state.novel.title = document.getElementById('novelTitle').value || file.name.replace(/\.docx$/i,'').replace(/\.\w+$/,'');
                            showUploadSuccess(file.name, text.length);
                        } else {
                            statusDiv.innerHTML = `
                                <div style="padding:16px;background:rgba(239,68,68,.1);border:1px solid var(--error);border-radius:8px">
                                    <p style="color:var(--error)">‚ùå WordÊñáÊ™îÂÖßÂÆπÁÇ∫Á©∫</p>
                                    <p style="color:var(--dim);font-size:12px;margin-top:8px">Ë´ãÊ™¢Êü•ÊñáÊ™îÊòØÂê¶ÊúâÊñáÂ≠óÂÖßÂÆπÔºåÊàñÂòóË©¶Âè¶Â≠òÁÇ∫TXTÊ†ºÂºè</p>
                                </div>
                            `;
                        }
                    })
                    .catch(function(err){
                        console.error('DOCXËß£ÊûêÈåØË™§:', err);
                        statusDiv.innerHTML = `
                            <div style="padding:16px;background:rgba(239,68,68,.1);border:1px solid var(--error);border-radius:8px">
                                <p style="color:var(--error)">‚ùå WordÊñáÊ™îËß£ÊûêÂ§±Êïó</p>
                                <p style="color:var(--dim);font-size:12px;margin-top:8px">${err.message || 'Ë´ãÂ∞áWordÂè¶Â≠òÁÇ∫TXTÊ†ºÂºèÂæåÈáçÊñ∞‰∏äÂÇ≥'}</p>
                            </div>
                        `;
                    });
            } else {
                statusDiv.innerHTML = `
                    <div style="padding:16px;background:rgba(128,128,128,.1);border:1px solid var(--warning);border-radius:8px">
                        <p style="color:var(--dim)">‚ö†Ô∏è WordËß£ÊûêÂ∫´Âä†ËºâÂ§±Êïó</p>
                        <p style="color:var(--dim);font-size:12px;margin-top:8px">Ë´ãÂ∞áWordÊñáÊ™îÂè¶Â≠òÁÇ∫TXTÊ†ºÂºèÂæåÈáçÊñ∞‰∏äÂÇ≥</p>
                    </div>
                `;
            }
        };
        reader.readAsArrayBuffer(file);
    }
    else if(ext === 'pdf'){
        // PDF ÊèêÁ§∫
        statusDiv.innerHTML = `
            <div style="padding:16px;background:var(--surface2);border-radius:8px">
                <p style="color:var(--dim)">‚ö†Ô∏è PDFÊñáÊ™îËß£Êûê‰∏≠...</p>
                <p style="color:var(--dim);font-size:12px;margin-top:8px">
                    PDFËß£ÊûêÂèØËÉΩ‰∏çÂÆåÊï¥ÔºåÂª∫Ë≠∞‰ΩøÁî®TXTÊàñWordÊ†ºÂºè
                </p>
            </div>
        `;
        setTimeout(() => {
            state.novel.text = "[PDFÊñáÊ™îÂÖßÂÆπ]\n\nË´ãÂ∞áPDFÊñáÊ™îË§áË£ΩÊñáÂ≠óÂæåË≤ºÂÖ•ÔºåÊàñÂè¶Â≠òÁÇ∫TXTÊ†ºÂºè„ÄÇ";
            state.novel.title = file.name.replace('.pdf','');
            showUploadSuccess(file.name, 1000);
        }, 1500);
    }
    else {
        statusDiv.innerHTML = `<p style="color:var(--error)">‚ùå ‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºèÔºö${ext}</p>`;
    }
}

function showUploadSuccess(filename, wordCount){
    const statusDiv = document.getElementById('uploadStatus');
    const analyzeBtn = document.getElementById('analyzeBtn');
    
    statusDiv.innerHTML = `
        <div style="padding:16px;background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:8px">
            <p style="color:var(--text)">‚úÖ Êñá‰ª∂ËÆÄÂèñÊàêÂäüÔºÅ</p>
            <p style="margin-top:8px">
                <span style="color:var(--dim)">Êñá‰ª∂ÂêçÔºö</span>${filename}<br>
                <span style="color:var(--dim)">Â≠óÊï∏Ôºö</span><strong style="color:var(--primary)">${wordCount.toLocaleString()}</strong> Â≠ó
            </p>
        </div>
    `;
    analyzeBtn.disabled = false;
}

function analyzeNovelFromPaste(){
    const titleEl = document.getElementById('novelTitle');
    const textEl = document.getElementById('novelText');
    
    const title = titleEl ? titleEl.value.trim() : '';
    const text = textEl ? textEl.value.trim() : '';
    
    console.log('analyzeNovelFromPaste:', {title, textLength: text.length});
    
    if(!text || text.length < 100){
        alert('Ë´ãËº∏ÂÖ•Â∞èË™™Ê≠£ÊñáÔºàËá≥Â∞ë100Â≠óÔºâ');
        return;
    }
    
    state.novel = {
        title: title || 'Êú™ÂëΩÂêçÂ∞èË™™',
        text: text,
        wordCount: text.length
    };
    
    document.getElementById('novelStats').textContent = `${state.novel.title} | ${(text.length/10000).toFixed(1)}Ëê¨Â≠ó`;
    nextStep();
}

function generateNovel(){
    const genreEl = document.getElementById('storyGenre');
    const ideaEl = document.getElementById('storyIdea');
    const lengthEl = document.getElementById('storyLength');
    const refEl = document.getElementById('storyReference');
    
    const genre = genreEl ? genreEl.value : 'Ê≠∑Âè≤ÂÜíÈö™';
    const idea = ideaEl ? ideaEl.value.trim() : '';
    const length = lengthEl ? lengthEl.value : '‰∏≠ÁØá';
    const reference = refEl ? refEl.value.trim() : '';
    
    console.log('generateNovel:', {genre, idea, length, reference});
    
    if(!idea){
        alert('Ë´ãËº∏ÂÖ•‰Ω†ÁöÑÊïÖ‰∫ãÊÉ≥Ê≥ï');
        return;
    }
    
    const statusDiv = document.getElementById('generateStatus');
    if(!statusDiv){
        console.error('generateStatus not found');
        return;
    }
    
    statusDiv.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>AIÊ≠£Âú®Ââµ‰ΩúÂ∞èË™™...</span>
        </div>
        <div style="margin-top:16px;padding:16px;background:var(--surface2);border-radius:8px">
            <p style="font-size:12px;color:var(--dim)">ü§ñ Ââµ‰ΩúÈÄ≤Â∫¶Ôºö</p>
            <p style="margin-top:8px;font-size:13px" id="genProgress">Ê≠£Âú®ÊßãÊÄùÊïÖ‰∫ãÊ°ÜÊû∂...</p>
        </div>
    `;
    
    // Ê®°Êì¨ÁîüÊàêÈÅéÁ®ã
    const steps = [
        'Ê≠£Âú®ÊßãÊÄùÊïÖ‰∫ãÊ°ÜÊû∂...',
        'Ë®≠Ë®à‰∏ªË¶ÅËßíËâ≤...',
        'Ë¶èÂäÉÁ´†ÁØÄÂ§ßÁ∂±...',
        'Êí∞ÂØ´Á¨¨‰∏ÄÁ´†...',
        'Êí∞ÂØ´Á¨¨‰∫åÁ´†...',
        'Êí∞ÂØ´Á¨¨‰∏âÁ´†...',
        'ÂÆåÂñÑÁ¥∞ÁØÄÊèèÂØ´...',
        'ÁîüÊàêÂÆåÊàêÔºÅ'
    ];
    
    let stepIndex = 0;
    const interval = setInterval(() => {
        stepIndex++;
        if(stepIndex < steps.length){
            document.getElementById('genProgress').textContent = steps[stepIndex];
        } else {
            clearInterval(interval);
            
            // ÁîüÊàêÁ§∫‰æãÂ∞èË™™
            const generatedNovel = generateSampleNovel(genre, idea, reference);
            state.novel = {
                title: generatedNovel.title,
                text: generatedNovel.content,
                wordCount: generatedNovel.content.length
            };
            
            document.getElementById('novelStats').textContent = `${state.novel.title} | ${(state.novel.wordCount/10000).toFixed(1)}Ëê¨Â≠ó`;
            
            statusDiv.innerHTML = `
                <div style="padding:16px;background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:8px">
                    <p style="color:var(--text)">‚úÖ Â∞èË™™Ââµ‰ΩúÂÆåÊàêÔºÅ</p>
                    <p style="margin-top:8px">
                        <span style="color:var(--dim)">Ê®ôÈ°åÔºö</span><strong>${generatedNovel.title}</strong><br>
                        <span style="color:var(--dim)">È°ûÂûãÔºö</span>${genre}<br>
                        <span style="color:var(--dim)">Â≠óÊï∏Ôºö</span><strong style="color:var(--primary)">${state.novel.wordCount.toLocaleString()}</strong> Â≠ó
                    </p>
                </div>
                <div class="btn-group" style="margin-top:16px">
                    <button class="btn" onclick="previewNovel()">üëÅÔ∏è È†êË¶ΩÂ∞èË™™</button>
                    <button class="btn btn-primary" onclick="nextStep()">ÁπºÁ∫åË£Ω‰Ωú ‚Üí</button>
                </div>
            `;
        }
    }, 800);
}

function generateSampleNovel(genre, idea, reference){
    // Ê†πÊìöÁî®Êà∂Ëº∏ÂÖ•ÁîüÊàêÁ§∫‰æãÂ∞èË™™
    let title = 'Êñ∞Ââµ‰ΩúÁöÑÊïÖ‰∫ã';
    let content = '';
    
    if(idea.includes('Âîê') || idea.includes('Áµ≤Á∂¢') || genre === 'Ê≠∑Âè≤ÂÜíÈö™'){
        title = 'Êµ∑‰∏äÁµ≤Á∂¢‰πãË∑ØÂØÜÁ¢º';
        content = DEMO_NOVEL;
    } else if(genre === '‰ªô‰ø†'){
        title = 'ÂäçËµ∑ËíºÁ©π';
        content = `„ÄäÂäçËµ∑ËíºÁ©π„Äã

„ÄêÁ¨¨‰∏ÄÁ´† Âª¢Êü¥Â∞ëÂπ¥„Äë
ÈùíÈõ≤Â±±ÔºåÈùàÂäçÊ¥æ„ÄÇ
ÊûóËªíÁ´ôÂú®Êá∏Â¥ñÈÇäÔºåÁúãËëóËÖ≥‰∏ãÁøªÊπßÁöÑÈõ≤Êµ∑ÔºåÂøÉ‰∏≠ÊªøÊòØËã¶ÊæÄ„ÄÇ
ÂçÅÂÖ≠Ê≠≤‰∫ÜÔºåÈÇÑÊòØÁÖâÊ∞£‰∏ÄÂ±§ÔºåÈÄ£ÊúÄÂü∫Á§éÁöÑÂºïÊ∞£ÂÖ•È´îÈÉΩÂÅö‰∏çÂà∞„ÄÇ
„ÄåÂª¢Áâ©Â∞±ÊòØÂª¢Áâ©„ÄÇ„ÄçË∫´ÂæåÂÇ≥‰æÜÂò≤Ë´∑ÁöÑËÅ≤Èü≥...

„ÄêÁ¨¨‰∫åÁ´† ÊÑèÂ§ñÊ©üÁ∑£„Äë
Ê∑±Â§úÔºåÊûóËªíÁç®Ëá™Âú®ËóèÁ∂ìÈñ£ÊâìÊéÉ„ÄÇ
‰∏ÄÊú¨Á†¥ËàäÁöÑÂè§Á±çÂæûÊõ∏Êû∂È†ÇÁ´ØÊªëËêΩÔºåÁ†∏Âú®‰ªñÈ†≠‰∏ä„ÄÇ
„ÄåÈÄôÊòØ...Â§™‰∏äÈï∑ÁîüË®£Ôºü„Äç...

„ÄêÁ¨¨‰∏âÁ´† ÂàùÈú≤ÈãíËäí„Äë
‰∏âÂÄãÊúàÂæåÔºåÂÆóÈñÄÂ§ßÊØî„ÄÇ
Ê≤íÊúâ‰∫∫Ê≥®ÊÑèÂà∞ËßíËêΩË£°ÈÇ£ÂÄãÊõæÁ∂ìÁöÑÂª¢Áâ©ÔºåÁúº‰∏≠ÈñÉÁàçËëóËá™‰ø°ÁöÑÂÖâËäí...`;
    } else {
        title = 'Êú™ÂëΩÂêçÊïÖ‰∫ã';
        content = `„Ää${title}„Äã

Âü∫Êñº‰Ω†ÁöÑÂâµÊÑèÔºö
${idea}

È°ûÂûãÔºö${genre}
${reference ? 'ÂèÉËÄÉÈ¢®Ê†ºÔºö' + reference : ''}

„ÄêÁ¨¨‰∏ÄÁ´†„Äë
ÊïÖ‰∫ãÈñãÂßã...

ÔºàÈÄôÊòØ‰∏ÄÂÄãÁî±AIÊ†πÊìö‰Ω†ÁöÑÂâµÊÑèÁîüÊàêÁöÑÊïÖ‰∫ãÊ°ÜÊû∂„ÄÇÂú®ÂØ¶ÈöõÊáâÁî®‰∏≠ÔºåAIÊúÉÊ†πÊìö‰Ω†ÁöÑÊèèËø∞Ââµ‰ΩúÂÆåÊï¥ÁöÑÂ∞èË™™ÂÖßÂÆπ„ÄÇÔºâ`;
    }
    
    return { title, content };
}

function previewNovel(){
    alert('Â∞èË™™È†êË¶ΩÔºö\n\n' + state.novel.text.slice(0, 500) + '...');
}

// ==================== ÈáçÊñ∞ÁîüÊàêÂáΩÊï∏ÔºàÂ∞çË©±ÂºèÔºâ ====================
function showRegenerateDialog(type, title){
    const dialog = document.createElement('div');
    dialog.id = 'regenerateDialog';
    dialog.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1000';
    
    // Â∞çË©±ÂºèÊèêÁ§∫Ë™û
    const prompts = {
        concept: 'ÈÄôÂÄãÈ´òÊ¶ÇÂøµÂì™Ë£°‰∏çÊªøÊÑèÔºü‰Ω†Â∏åÊúõÊÄéÈ∫ºË™øÊï¥Ôºü',
        chapters: 'Á´†ÁØÄÊãÜÂàÜÊúâ‰ªÄÈ∫ºÂïèÈ°åÔºüÊÉ≥ÊÄéÈ∫ºÈáçÊñ∞ÂäÉÂàÜÔºü',
        characters: 'ËßíËâ≤Ë®≠Ë®àÂì™Ë£°ÈúÄË¶Å‰øÆÊîπÔºü',
        storyboard: 'ÂàÜÈè°Êúâ‰ªÄÈ∫ºÂïèÈ°åÔºüÊÉ≥ÊÄéÈ∫ºË™øÊï¥Ôºü'
    };
    
    dialog.innerHTML = `
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;width:90%;max-width:480px;overflow:hidden">
            <!-- Â∞çË©±È†≠ÈÉ® -->
            <div style="background:var(--primary);padding:16px 20px;display:flex;align-items:center;gap:12px">
                <div style="width:40px;height:40px;background:rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px">ü§ñ</div>
                <div>
                    <div style="font-weight:600;color:#fff">${title}Agent</div>
                    <div style="font-size:11px;color:rgba(255,255,255,.7)">Ê≠£Âú®ËÅΩÂèñ‰Ω†ÁöÑÊÑèË¶ã...</div>
                </div>
            </div>
            
            <!-- Â∞çË©±ÂÖßÂÆπ -->
            <div style="padding:20px">
                <!-- Agent ÂïèÈ°å -->
                <div style="display:flex;gap:12px;margin-bottom:16px">
                    <div style="width:32px;height:32px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">ü§ñ</div>
                    <div style="background:var(--surface2);padding:12px 16px;border-radius:4px 16px 16px 16px;max-width:85%">
                        <p style="margin:0;line-height:1.6">${prompts[type] || 'Êúâ‰ªÄÈ∫ºÊÉ≥Ë™øÊï¥ÁöÑÔºü'}</p>
                    </div>
                </div>
                
                <!-- Áî®Êà∂Ëº∏ÂÖ• -->
                <div style="display:flex;gap:12px;align-items:flex-end">
                    <div style="flex:1">
                        <textarea id="regenInstruction" class="form-input" style="min-height:80px;border-radius:16px;resize:none" placeholder="Áõ¥Êé•ÂëäË®¥Êàë‰Ω†ÁöÑÊÉ≥Ê≥ï...&#10;‰æãÂ¶ÇÔºöLoglineË¶ÅÊõ¥ÊúâÊá∏ÂøµÊÑü„ÄÅÁ™ÅÂá∫ÊàêÈï∑‰∏ªÈ°å"></textarea>
                    </div>
                </div>
                
                <!-- Âø´Êç∑ÂõûË¶Ü -->
                <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px">
                    <button class="quick-reply" onclick="document.getElementById('regenInstruction').value='‰∏çÂ§†Âê∏Âºï‰∫∫ÔºåË¶ÅÊõ¥ÊúâÂºµÂäõ'">üòê ‰∏çÂ§†Âê∏Âºï</button>
                    <button class="quick-reply" onclick="document.getElementById('regenInstruction').value='È¢®Ê†º‰∏çÂ∞çÔºåÊÉ≥Êõ¥ÊñáËóù‰∏ÄÈªû'">üé® È¢®Ê†º‰∏çÂ∞ç</button>
                    <button class="quick-reply" onclick="document.getElementById('regenInstruction').value='ÂÖßÂÆπÊúâÈåØË™§ÈúÄË¶Å‰øÆÊ≠£'">‚ùå ÊúâÈåØË™§</button>
                    <button class="quick-reply" onclick="document.getElementById('regenInstruction').value='ÊÉ≥ÊèõÂÄãÂÆåÂÖ®‰∏çÂêåÁöÑÊñπÂêëË©¶Ë©¶'">üîÄ ÊèõÊñπÂêë</button>
                </div>
            </div>
            
            <!-- Â∫ïÈÉ®ÊåâÈàï -->
            <div style="padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end">
                <button class="btn" onclick="closeRegenerateDialog()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="doRegenerate('${type}')">ÁôºÈÄÅ ‚úì</button>
            </div>
        </div>
    `;
    document.body.appendChild(dialog);
    
    // ËÅöÁÑ¶Ëº∏ÂÖ•Ê°Ü
    setTimeout(() => document.getElementById('regenInstruction')?.focus(), 100);
}

function closeRegenerateDialog(){
    const dialog = document.getElementById('regenerateDialog');
    if(dialog) dialog.remove();
}

function doRegenerate(type){
    const instruction = document.getElementById('regenInstruction').value.trim();
    
    if(!instruction){
        alert('Ë´ãÂëäË®¥Êàë‰Ω†ÊÉ≥ÊÄéÈ∫ºË™øÊï¥ÔΩû');
        return;
    }
    
    // ‰øùÂ≠òÁî®Êà∂ÂèçÈ•ã
    if(!state.feedback) state.feedback = [];
    state.feedback.push({type, instruction, time: new Date()});
    
    closeRegenerateDialog();
    
    const content = document.getElementById('contentArea');
    content.innerHTML = `
        <div class="content-card">
            <div class="loading">
                <div class="spinner"></div>
                <span>Ê†πÊìö‰Ω†ÁöÑÊÑèË¶ãÈáçÊñ∞ÁîüÊàê...</span>
            </div>
            ${instruction ? `<p style="margin-top:16px;padding:12px;background:var(--surface2);border-radius:8px;font-size:13px;color:var(--dim)">üìù ${instruction}</p>` : ''}
        </div>
    `;
    
    setTimeout(() => {
        switch(type){
            case 'concept':
                state.concept = generateConcept();
                showStep(3);  // È´òÊ¶ÇÂøµÊòØStep 3
                break;
            case 'chapters':
                state.chapters = splitChapters();
                showStep(4);  // Á´†ÁØÄÊòØStep 4
                break;
            case 'characters':
                state.characters = extractCharacters();
                showStep(5);  // ËßíËâ≤ÊòØStep 5
                break;
            case 'storyboard':
                state.storyboard = generateStoryboard();
                showStep(8);  // ÂàÜÈè°ÊòØStep 8
                break;
        }
    }, 2000);
}

function regenerateConcept(){
    showRegenerateDialog('concept', 'È´òÊ¶ÇÂøµ');
}

function regenerateStoryboard(){
    showRegenerateDialog('storyboard', 'ÂàÜÈè°');
}

function resplitChapters(){
    showRegenerateDialog('chapters', 'Á´†ÁØÄ');
}

function reextractCharacters(){
    showRegenerateDialog('characters', 'ËßíËâ≤');
}

function loadDemoNovel(){
    const titleInput = document.getElementById('novelTitle');
    const textArea = document.getElementById('novelText');
    
    if(titleInput) titleInput.value = 'Êµ∑‰∏äÁµ≤Á∂¢‰πãË∑ØÂØÜÁ¢º';
    if(textArea) textArea.value = DEMO_NOVEL;
    
    // Â¶ÇÊûúÊòØ‰∏äÂÇ≥Ê®°ÂºèÔºå‰πüÊõ¥Êñ∞ÁãÄÊÖã
    state.novel.title = 'Êµ∑‰∏äÁµ≤Á∂¢‰πãË∑ØÂØÜÁ¢º';
    state.novel.text = DEMO_NOVEL;
    state.novel.wordCount = DEMO_NOVEL.length;
    
    const statusDiv = document.getElementById('uploadStatus');
    const analyzeBtn = document.getElementById('analyzeBtn');
    
    if(statusDiv){
        statusDiv.innerHTML = `
            <div style="padding:16px;background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:8px">
                <p style="color:var(--text)">‚úÖ Á§∫‰æãÂ∞èË™™Â∑≤ËºâÂÖ•ÔºÅ</p>
                <p style="margin-top:8px">
                    <span style="color:var(--dim)">Ê®ôÈ°åÔºö</span>Êµ∑‰∏äÁµ≤Á∂¢‰πãË∑ØÂØÜÁ¢º<br>
                    <span style="color:var(--dim)">Â≠óÊï∏Ôºö</span><strong style="color:var(--primary)">${DEMO_NOVEL.length.toLocaleString()}</strong> Â≠ó
                </p>
            </div>
        `;
    }
    if(analyzeBtn) analyzeBtn.disabled = false;
}

function analyzeNovel(){
    // Âæû‰∏äÂÇ≥Ê®°ÂºèÂàÜÊûê
    const title = document.getElementById('novelTitle')?.value.trim() || state.novel.title;
    const text = state.novel.text;
    
    if(!text){
        alert('Ë´ãÂÖà‰∏äÂÇ≥ÊàñËºâÂÖ•Â∞èË™™');
        return;
    }
    
    state.novel = {
        title: title || 'Êú™ÂëΩÂêçÂ∞èË™™',
        text: text,
        wordCount: text.length
    };
    
    document.getElementById('novelStats').textContent = `${state.novel.title} | ${(text.length/10000).toFixed(1)}Ëê¨Â≠ó`;
    
    nextStep();
}

// ==================== Step 3: È´òÊ¶ÇÂøµ ====================
function renderStep2(){
    // Â∑≤ÊúâÂàÜÊûêÁµêÊûú ‚Üí È°ØÁ§∫ÁµêÊûú
    if(state.concept?.logline){
        return renderConceptResult();
    }
    
    return `
        <div class="content-card">
            <h3><span class="icon">üí°</span> È´òÊ¶ÇÂøµAgent</h3>
            
            <div id="conceptAgentUI">
                <div style="background:var(--surface2);border-radius:8px;padding:20px;text-align:center">
                    <div style="font-size:48px;margin-bottom:12px">üí°</div>
                    <div style="font-size:14px;color:var(--dim);margin-bottom:16px">
                        Âü∫ÊñºË®™Ë´áÂõûÁ≠îÔºåÁîüÊàêLoglineÂíåÊïÖ‰∫ãÂÆö‰Ωç
                    </div>
                    <button class="btn btn-primary" onclick="runConceptAgent()" style="padding:12px 32px">
                        üöÄ ÁîüÊàêÈ´òÊ¶ÇÂøµ
                    </button>
                </div>
            </div>
        </div>
    `;
}

async function runConceptAgent(){
    const ui = document.getElementById('conceptAgentUI');
    ui.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;padding:20px">
            <div class="loading-spinner"></div>
            <div>
                <div style="font-weight:600">È´òÊ¶ÇÂøµAgent ÁîüÊàê‰∏≠...</div>
                <div style="font-size:12px;color:var(--dim)">ÂàÜÊûêË®™Ë´áÂõûÁ≠îÔºåÊèêÁÖâÊ†∏ÂøÉË≥£Èªû</div>
            </div>
        </div>
    `;
    
    try {
        const apiOk = await checkApiHealth();
        if (apiOk) {
            const result = await callAgent('concept', {
                analysis: state.aiAnalysis,
                interview: state.interview
            });
            state.concept = result;
            showStep(3);
        } else {
            ui.innerHTML = renderManualConceptUI();
        }
    } catch (err) {
        ui.innerHTML = `<div style="color:var(--primary);padding:16px">‚ùå ${err.message}</div>` + renderManualConceptUI();
    }
}

function renderManualConceptUI(){
    const prompt = generateConceptPrompt();
    return `
        <div style="font-size:12px;color:var(--warning);margin-bottom:12px">‚ö†Ô∏è ÊâãÂãïÊ®°Âºè</div>
        <textarea id="conceptPrompt" class="form-input" style="height:80px;font-size:10px" readonly>${prompt}</textarea>
        <button onclick="copyToClipboard('conceptPrompt')" class="btn" style="margin:8px 0">üìã Ë§áË£ΩPrompt</button>
        <textarea id="conceptResult" class="form-input" style="height:100px" placeholder='Ë≤º‰∏äÁµêÊûú...'></textarea>
        <button class="btn btn-primary" onclick="applyConceptResult()" style="width:100%;margin-top:8px">‚úì Á¢∫Ë™ç</button>
    `;
}

function renderConceptResult(){
    const c = state.concept;
    return `
        <div class="content-card">
            <h3><span class="icon">üí°</span> È´òÊ¶ÇÂøµÂàÜÊûê</h3>
            
            <div class="report">
                <h4>üéØ Logline</h4>
                <p style="font-size:16px;color:var(--primary);padding:16px;background:var(--bg);border-radius:8px;font-style:italic;line-height:1.8;border-left:3px solid var(--primary)">
                    "${c.logline}"
                </p>
            </div>
            
            <div class="report">
                <h4>üìä ÊïÖ‰∫ãÂÆö‰Ωç</h4>
                <div class="report-grid">
                    <div class="stat-box"><div class="stat-label">È°ûÂûã</div><div class="stat-val" style="font-size:14px">${c.genre || '-'}</div></div>
                    <div class="stat-box"><div class="stat-label">‰∏ªÈ°å</div><div class="stat-val" style="font-size:14px">${c.theme || '-'}</div></div>
                    <div class="stat-box"><div class="stat-label">ÂèóÁúæ</div><div class="stat-val" style="font-size:14px">${c.audience || '-'}</div></div>
                    <div class="stat-box"><div class="stat-label">ÊôÇ‰ª£</div><div class="stat-val" style="font-size:14px">${c.era || '-'}</div></div>
                </div>
            </div>
            
            <div class="report">
                <h4>üé£ Ê†∏ÂøÉË≥£Èªû</h4>
                <ul style="color:var(--dim);font-size:14px;padding-left:20px">
                    ${(c.hooks || []).map(h => `<li style="margin:8px 0">${h}</li>`).join('')}
                </ul>
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="state.concept=null;showStep(3)">üîÑ ÈáçÊñ∞ÁîüÊàê</button>
                <button class="btn btn-primary" onclick="nextStep()">Á¢∫Ë™ç ‚Üí Á´†ÁØÄÊãÜÂàÜ</button>
            </div>
        </div>
    `;
}

function generateConceptPrompt(){
    const novel = state.novel;
    const iv = state.interview || {};
    const ai = state.aiAnalysis || {};
    
    // Ë®™Ë´áÂõûÁ≠îÊëòË¶Å
    let interviewSummary = '';
    Object.keys(iv).forEach(k => {
        if(iv[k]) interviewSummary += `- ${k}: ${iv[k]}\n`;
    });
    
    return `‰Ω†ÊòØÂ∞àÊ•≠Á∑®ÂäáÔºåË´ãÁÇ∫ÈÄôÈÉ®Â∞èË™™ÁîüÊàêÈ´òÊ¶ÇÂøµÂàÜÊûê„ÄÇ

„ÄêÂ∞èË™™„Äë${novel?.title || ''}Ôºà${Math.round((novel?.text?.length||0)/10000*10)/10}Ëê¨Â≠óÔºâ

„ÄêAIÂàÜÊûêÊëòË¶Å„Äë
${ai.characters ? 'ËßíËâ≤Ôºö' + ai.characters.map(c=>c.name).join('„ÄÅ') : ''}
${ai.core_conflict ? 'Ë°ùÁ™ÅÔºö' + ai.core_conflict : ''}
${ai.themes ? '‰∏ªÈ°åÔºö' + ai.themes.join('„ÄÅ') : ''}

„ÄêÂ∞éÊºîË®™Ë´áÂõûÁ≠î„Äë
${interviewSummary || 'ÔºàÁÑ°Ôºâ'}

Ë´ãËøîÂõûJSONÔºö
{
  "logline": "‰∏ÄÂè•Ë©±ÊïÖ‰∫ãÔºà‰∏ªËßí+Ë°åÂãï+Â∞çÊâã+È¢®Èö™Ôºå30-50Â≠óÔºâ",
  "genre": "È°ûÂûãÔºàÂ¶ÇÔºöÊ≠∑Âè≤ÂÜíÈö™/Êá∏Áñë/Â•áÂπªÔºâ",
  "theme": "Ê†∏ÂøÉ‰∏ªÈ°å",
  "audience": "ÁõÆÊ®ôÂèóÁúæ",
  "era": "ÊôÇ‰ª£ËÉåÊôØ",
  "tone": "Âü∫Ë™øÔºàÁÜ±Ë°Ä/Ê∫´ÊÉÖ/ÈªëÊöó/ÂπΩÈªòÔºâ",
  "hooks": [
    "Ë≥£Èªû1ÔºöXXX",
    "Ë≥£Èªû2ÔºöXXX", 
    "Ë≥£Èªû3ÔºöXXX"
  ],
  "comparable": "Â∞çÊ®ô‰ΩúÂìÅÔºàÂ¶ÇÔºöÊù±ÊñπÁâà„ÄäXXX„Äã+„ÄäYYY„ÄãÁöÑÂÖÉÁ¥†Ôºâ"
}`;
}

function applyConceptResult(){
    const input = document.getElementById('conceptResult').value.trim();
    if(!input){ alert('Ë´ãÂÖàË≤ºÂÖ•ÁµêÊûú'); return; }
    
    try {
        const json = input.replace(/```json\s*/g,'').replace(/```\s*/g,'');
        state.concept = JSON.parse(json);
        showStep(3);
    } catch(e) {
        alert('JSONÊ†ºÂºèÈåØË™§Ôºö' + e.message);
    }
}

// ==================== Step 4: Á´†ÁØÄÊãÜÂàÜ ====================
function renderStep3(){
    // Â∑≤ÊúâÂàÜÊûêÁµêÊûú ‚Üí È°ØÁ§∫ÁµêÊûú
    if(state.chapters?.length > 0 && state.chapters[0].summary?.length > 20){
        return renderChaptersResult();
    }
    
    // ÂÖàÂÅöÂü∫Á§éÁ´†ÁØÄË≠òÂà•
    if(state.chapters.length === 0){
        state.chapters = splitChaptersBasic();
    }
    
    const prompt = generateChaptersPrompt();
    
    return `
        <div class="content-card">
            <h3><span class="icon">üìë</span> Á´†ÁØÄAgent</h3>
            
            <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
                <div style="font-size:13px;color:var(--dim);margin-bottom:12px">
                    üìä Âü∫Á§éË≠òÂà•Ôºö${state.chapters.length} ÂÄãÁ´†ÁØÄÔºå${state.novel.wordCount} Â≠ó
                </div>
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#10b981,#3b82f6);border-radius:50%;display:flex;align-items:center;justify-content:center">üìë</div>
                    <div>
                        <div style="font-weight:600">Step 1ÔºöË§áË£Ω Prompt Âà∞ Claude</div>
                        <div style="font-size:12px;color:var(--dim)">ÂàÜÊûêÊØèÁ´†ÂÖßÂÆπ„ÄÅÊïò‰∫ãÈöéÊÆµ„ÄÅÈâ§Â≠êË®≠Ë®à</div>
                    </div>
                </div>
                <div style="position:relative">
                    <textarea id="chaptersPrompt" class="form-input" style="height:120px;font-size:11px;font-family:monospace" readonly>${prompt}</textarea>
                    <button onclick="copyToClipboard('chaptersPrompt')" style="position:absolute;top:8px;right:8px;background:var(--primary);border:none;color:#fff;padding:8px 16px;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600">
                        üìã Ë§áË£Ω
                    </button>
                </div>
            </div>
            
            <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#10b981,#3b82f6);border-radius:50%;display:flex;align-items:center;justify-content:center">üì•</div>
                    <div>
                        <div style="font-weight:600">Step 2ÔºöË≤ºÂõûÁµêÊûú</div>
                    </div>
                </div>
                <textarea id="chaptersResult" class="form-input" style="height:150px" placeholder='Ë≤º‰∏ä Claude ËøîÂõûÁöÑ JSON...'></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="applyChaptersResult()" style="width:100%">
                ‚úì Á¢∫Ë™çÁ´†ÁØÄÂàÜÊûê
            </button>
        </div>
    `;
}

function renderChaptersResult(){
    return `
        <div class="content-card">
            <h3><span class="icon">üìë</span> Á´†ÁØÄÁµêÊßã</h3>
            
            <div class="report">
                <h4>üìä Êï¥È´îÊï∏Êìö</h4>
                <div class="report-grid">
                    <div class="stat-box"><div class="stat-val">${state.chapters.length}</div><div class="stat-label">Á∏ΩÁ´†ÁØÄ</div></div>
                    <div class="stat-box"><div class="stat-val">${state.novel.wordCount}</div><div class="stat-label">Á∏ΩÂ≠óÊï∏</div></div>
                    <div class="stat-box"><div class="stat-val">${Math.round(state.novel.wordCount / state.chapters.length)}</div><div class="stat-label">Âπ≥ÂùáÂ≠óÊï∏</div></div>
                    <div class="stat-box"><div class="stat-val">${state.chapters.reduce((a,c)=>a+(c.estimatedShots||80),0)}</div><div class="stat-label">È†êË®àÈè°È†≠</div></div>
                </div>
            </div>
            
            <div class="report">
                <h4>üìñ Á´†ÁØÄÂàóË°®</h4>
                ${state.chapters.map((ch, i) => `
                    <div class="item-card" style="cursor:pointer" onclick="toggleChapter(${i})" id="chapter-card-${i}">
                        <h5 style="display:flex;justify-content:space-between">
                            <span><span style="color:var(--primary)">Á¨¨${i+1}Á´†</span> ${ch.title}</span>
                            <span id="chapter-arrow-${i}" style="color:var(--dim)">‚ñº</span>
                        </h5>
                        <p style="color:var(--dim);font-size:12px;margin:8px 0">${ch.summary}</p>
                        <p>
                            <span class="tag">üìù ${ch.wordCount}Â≠ó</span>
                            <span class="tag">üé¨ ${ch.estimatedShots||80}Èè°È†≠</span>
                            <span class="tag">${ch.phase||''}</span>
                            ${ch.hook ? `<span class="tag" style="background:var(--primary);color:#fff">üé£ ${ch.hook}</span>` : ''}
                        </p>
                        <div id="chapter-detail-${i}" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                            <div style="background:var(--surface);padding:12px;border-radius:6px;font-size:12px;line-height:1.8;max-height:200px;overflow-y:auto">${(ch.content||'').substring(0,1000)}...</div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="state.chapters=[];showStep(4)">üîÑ ÈáçÊñ∞ÂàÜÊûê</button>
                <button class="btn btn-primary" onclick="nextStep()">Á¢∫Ë™ç ‚Üí ËßíËâ≤Ë®≠Ë®à</button>
            </div>
        </div>
    `;
}

function generateChaptersPrompt(){
    const chapters = state.chapters;
    const concept = state.concept || {};
    
    // ÁîüÊàêÁ´†ÁØÄÊëòË¶Å‰æõClaudeÂàÜÊûê
    let chapterList = chapters.map((ch, i) => 
        `Á¨¨${i+1}Á´†„Äå${ch.title}„Äç(${ch.wordCount}Â≠ó)Ôºö${(ch.content||'').substring(0,200)}...`
    ).join('\n');
    
    return `‰Ω†ÊòØÂ∞àÊ•≠Á∑®ÂäáÔºåË´ãÂàÜÊûêÈÄôÈÉ®Â∞èË™™ÁöÑÁ´†ÁØÄÁµêÊßã„ÄÇ

„Äê‰ΩúÂìÅ„Äë${state.novel?.title || ''}
„ÄêÈ´òÊ¶ÇÂøµ„Äë${concept.logline || ''}
„ÄêÈ°ûÂûã„Äë${concept.genre || ''}

„ÄêÁ´†ÁØÄÂàóË°®„Äë
${chapterList}

Ë´ãÁÇ∫ÊØèÂÄãÁ´†ÁØÄÂàÜÊûê‰∏¶ËøîÂõûJSONÔºö
{
  "chapters": [
    {
      "id": 1,
      "title": "Á´†ÁØÄÊ®ôÈ°å",
      "summary": "50Â≠óÂÖßÂÆπÊëòË¶Å",
      "phase": "Êïò‰∫ãÈöéÊÆµÔºàÈñãÁØá/Èã™Â¢ä/ÁôºÂ±ï/È´òÊΩÆ/Êî∂Êùü/ÁµêÂ±ÄÔºâ",
      "emotion": "ÊÉÖÁ∑íÂü∫Ë™ø",
      "hook": "Á´†Êú´Èâ§Â≠êÔºàËÆìËßÄÁúæÊÉ≥Áúã‰∏ã‰∏ÄÈõÜÁöÑÊá∏ÂøµÔºâ",
      "estimatedShots": 80,
      "keyScenes": ["ÈóúÈçµÂ†¥ÊôØ1", "ÈóúÈçµÂ†¥ÊôØ2"]
    }
  ],
  "actStructure": {
    "act1": [1,2],
    "act2a": [3,4,5],
    "act2b": [6,7],
    "act3": [8,9,10]
  }
}`;
}

function applyChaptersResult(){
    const input = document.getElementById('chaptersResult').value.trim();
    if(!input){ alert('Ë´ãÂÖàË≤ºÂÖ•ÁµêÊûú'); return; }
    
    try {
        const json = input.replace(/```json\s*/g,'').replace(/```\s*/g,'');
        const result = JSON.parse(json);
        
        // Âêà‰ΩµAIÂàÜÊûêÁµêÊûúÂà∞ÁèæÊúâÁ´†ÁØÄ
        if(result.chapters){
            result.chapters.forEach((aiCh, i) => {
                if(state.chapters[i]){
                    Object.assign(state.chapters[i], aiCh);
                }
            });
        }
        if(result.actStructure){
            state.actStructure = result.actStructure;
        }
        
        showStep(4);
    } catch(e) {
        alert('JSONÊ†ºÂºèÈåØË™§Ôºö' + e.message);
    }
}

// Âü∫Á§éÁ´†ÁØÄË≠òÂà•Ôºà‰∏çÈúÄË¶ÅAIÔºâ
function splitChaptersBasic(){
    const text = state.novel.text;
    const chapters = [];
    
    const patterns = [
        /„Äê(.+?)„Äë/g,
        /Á¨¨[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅÁôæÂçÉ\d]+Á´†\s*[:Ôºö]?\s*(.{0,20})/g,
    ];
    
    let matches = [];
    for(const pattern of patterns){
        const found = [...text.matchAll(pattern)];
        if(found.length > matches.length) matches = found;
    }
    
    if(matches.length > 0){
        for(let i = 0; i < matches.length; i++){
            const start = matches[i].index;
            const end = matches[i+1]?.index || text.length;
            const content = text.slice(start, end);
            chapters.push({
                id: i + 1,
                title: matches[i][1] || `Á¨¨${i+1}Á´†`,
                content: content,
                wordCount: content.length,
                summary: content.slice(0,80) + '...'
            });
        }
    } else {
        const chunkSize = 15000;
        for(let i = 0; i < text.length; i += chunkSize){
            const content = text.slice(i, i + chunkSize);
            chapters.push({
                id: chapters.length + 1,
                title: `Á¨¨${chapters.length + 1}ÈÉ®ÂàÜ`,
                content, wordCount: content.length,
                summary: content.slice(0,80) + '...'
            });
        }
    }
    return chapters;
}

function getChapterPhase(i, total){
    if(i === 0) return 'üé¨ ÈñãÁØá';
    if(i === total - 1) return 'üé≠ ÁµêÂ±Ä';
    if(i < total * 0.25) return 'üìñ Èã™Â¢ä';
    if(i < total * 0.5) return '‚ö° ÁôºÂ±ï';
    if(i < total * 0.75) return 'üî• È´òÊΩÆ';
    return 'üåÖ Êî∂Êùü';
}

function generateChapterSummary(content){
    // Á∞°ÂñÆÊèêÂèñÂâç100Â≠ó‰ΩúÁÇ∫ÊëòË¶Å
    return content.slice(0, 100).replace(/\s+/g, ' ') + '...';
}

// Â±ïÈñã/Êî∂Ëµ∑Á´†ÁØÄ
function toggleChapter(index){
    const detail = document.getElementById(`chapter-detail-${index}`);
    const arrow = document.getElementById(`chapter-arrow-${index}`);
    const card = document.getElementById(`chapter-card-${index}`);
    
    if(detail.style.display === 'none'){
        // Â±ïÈñã
        detail.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
        card.style.background = 'var(--surface2)';
        card.style.borderColor = 'var(--primary)';
    } else {
        // Êî∂Ëµ∑
        detail.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
        card.style.background = '';
        card.style.borderColor = '';
    }
}

// Á∑®ËºØÁ´†ÁØÄ
function editChapter(index){
    const ch = state.chapters[index];
    const newTitle = prompt('Á´†ÁØÄÊ®ôÈ°åÔºö', ch.title);
    if(newTitle !== null){
        state.chapters[index].title = newTitle;
    }
    
    const newPhase = prompt('Á´†ÁØÄÈöéÊÆµÔºàÈñãÁØá/Èã™Â¢ä/ÁôºÂ±ï/È´òÊΩÆ/Êî∂Êùü/ÁµêÂ±ÄÔºâÔºö', ch.phase.replace(/^[^\s]+\s*/, ''));
    if(newPhase !== null){
        const phaseIcons = {'ÈñãÁØá':'üé¨','Èã™Â¢ä':'üìñ','ÁôºÂ±ï':'‚ö°','È´òÊΩÆ':'üî•','Êî∂Êùü':'üåÖ','ÁµêÂ±Ä':'üé≠'};
        const icon = phaseIcons[newPhase] || 'üìñ';
        state.chapters[index].phase = `${icon} ${newPhase}`;
    }
    
    // ÈáçÊñ∞Ê∏≤Êüì
    showStep(4);
}

// È†êË¶ΩÁ´†ÁØÄÂäáÊú¨
function previewChapterScript(index){
    const ch = state.chapters[index];
    const script = state.scripts?.[index];
    
    if(script){
        alert(`„Äê${ch.title}„ÄëÂäáÊú¨È†êË¶Ω\n\n${script.substring(0, 500)}...`);
    } else {
        alert(`„Äê${ch.title}„Äë\n\nÂäáÊú¨Â∞öÊú™ÁîüÊàêÔºåË´ãÂú®„ÄåÁ´†ÁØÄÂäáÊú¨„ÄçÊ≠•È©üÁîüÊàê„ÄÇ\n\nÂéüÊñáÈ†êË¶ΩÔºö\n${ch.content?.substring(0, 300) || ch.summary}...`);
    }
}

// ==================== ÈÄöÁî®Â∑•ÂÖ∑ ====================
function copyToClipboard(elementId){
    const el = document.getElementById(elementId);
    el.select();
    document.execCommand('copy');
    
    // ÊâæÂà∞Â∞çÊáâÁöÑÊåâÈàï‰∏¶Êõ¥Êñ∞
    const btn = el.parentElement.querySelector('button');
    if(btn){
        const orig = btn.innerHTML;
        btn.innerHTML = '‚úì Â∑≤Ë§áË£Ω';
        setTimeout(() => btn.innerHTML = orig, 2000);
    }
}

// ==================== Step 5: ËßíËâ≤Ë®≠Ë®à ====================
function renderStep4(){
    // Â∑≤ÊúâËßíËâ≤Êï∏Êìö ‚Üí È°ØÁ§∫ÁµêÊûú
    if(state.characters?.main?.length > 0){
        return renderCharactersResult();
    }
    
    const prompt = generateCharactersPrompt();
    
    return `
        <div class="content-card">
            <h3><span class="icon">üë•</span> ËßíËâ≤Agent</h3>
            
            <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#ec4899,#8b5cf6);border-radius:50%;display:flex;align-items:center;justify-content:center">üë•</div>
                    <div>
                        <div style="font-weight:600">Step 1ÔºöË§áË£Ω Prompt Âà∞ Claude</div>
                        <div style="font-size:12px;color:var(--dim)">Âü∫Êñº Lajos Egri ‰∏âÁ∂≠ËßíËâ≤ÁêÜË´ñË®≠Ë®à‰∫∫Áâ©</div>
                    </div>
                </div>
                <div style="position:relative">
                    <textarea id="charactersPrompt" class="form-input" style="height:120px;font-size:11px;font-family:monospace" readonly>${prompt}</textarea>
                    <button onclick="copyToClipboard('charactersPrompt')" style="position:absolute;top:8px;right:8px;background:var(--primary);border:none;color:#fff;padding:8px 16px;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600">
                        üìã Ë§áË£Ω
                    </button>
                </div>
            </div>
            
            <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#ec4899,#8b5cf6);border-radius:50%;display:flex;align-items:center;justify-content:center">üì•</div>
                    <div><div style="font-weight:600">Step 2ÔºöË≤ºÂõûÁµêÊûú</div></div>
                </div>
                <textarea id="charactersResult" class="form-input" style="height:150px" placeholder='Ë≤º‰∏ä JSON...'></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="applyCharactersResult()" style="width:100%">
                ‚úì Á¢∫Ë™çËßíËâ≤Ë®≠Ë®à
            </button>
        </div>
    `;
}

function renderCharactersResult(){
    const chars = state.characters;
    return `
        <div class="content-card">
            <h3><span class="icon">üë•</span> ËßíËâ≤Ë®≠Ë®à</h3>
            
            <div class="tabs">
                <div class="tab active" onclick="showCharacterTab('main')">‰∏ªËßí (${chars.main?.length||0})</div>
                <div class="tab" onclick="showCharacterTab('supporting')">ÈÖçËßí (${chars.supporting?.length||0})</div>
            </div>
            
            <div id="characterContent">
                ${renderCharacterList('main')}
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="state.characters={};showStep(5)">üîÑ ÈáçÊñ∞Ë®≠Ë®à</button>
                <button class="btn btn-primary" onclick="nextStep()">Á¢∫Ë™ç ‚Üí ÊúçÂåñÈÅì</button>
            </div>
        </div>
    `;
}

function generateCharactersPrompt(){
    const ai = state.aiAnalysis || {};
    const concept = state.concept || {};
    const iv = state.interview || {};
    
    return `‰Ω†ÊòØËßíËâ≤Ë®≠Ë®àÂ∞àÂÆ∂ÔºåË´ãÂü∫ÊñºLajos Egri‰∏âÁ∂≠ËßíËâ≤ÁêÜË´ñË®≠Ë®à‰∫∫Áâ©„ÄÇ

„Äê‰ΩúÂìÅ„Äë${state.novel?.title || ''}
„ÄêÈ°ûÂûã„Äë${concept.genre || ''}
„ÄêLogline„Äë${concept.logline || ''}

„ÄêAIË≠òÂà•ÁöÑËßíËâ≤„Äë
${ai.characters ? ai.characters.map(c => `- ${c.name}: ${c.role}, ${c.trait}`).join('\n') : 'ÔºàÁÑ°Ôºâ'}

„ÄêÂ∞éÊºîË®™Ë´áÊëòË¶Å„Äë
${Object.keys(iv).map(k => iv[k] ? `- ${k}: ${iv[k]}` : '').filter(Boolean).join('\n') || 'ÔºàÁÑ°Ôºâ'}

Ë´ãË®≠Ë®àËßíËâ≤‰∏¶ËøîÂõûJSONÔºö
{
  "main": [
    {
      "name": "ËßíËâ≤Âêç",
      "role": "‰∏ªËßí",
      "physiology": {"age": 25, "gender": "Áî∑", "appearance": "Â§ñË≤åÊèèËø∞"},
      "sociology": {"occupation": "ËÅ∑Ê•≠", "class": "ÈöéÂ±§", "relationships": "Á§æÊúÉÈóú‰øÇ"},
      "psychology": {"want": "Ë°®Èù¢ÊÖæÊúõ", "need": "Ê∑±Â±§ÈúÄË¶Å", "wound": "ÂøÉÁêÜÂâµÂÇ∑", "arc": "ÊàêÈï∑ÂºßÁ∑ö"},
      "keyTraits": ["ÁâπÈªû1", "ÁâπÈªû2"],
      "voiceStyle": "Ë™™Ë©±È¢®Ê†º"
    }
  ],
  "supporting": [
    {
      "name": "ÈÖçËßíÂêç",
      "role": "ÈÖçËßí/ÂèçÊ¥æ/Â∞éÂ∏´",
      "function": "Êïò‰∫ãÂäüËÉΩÔºàÂ∞çÊâã/Èè°ÂÉè/ÂÇ¨ÂåñÂäëÔºâ",
      "relationToProtag": "Ëàá‰∏ªËßíÈóú‰øÇ",
      "keyTraits": ["ÁâπÈªû"],
      "physiology": {"age": 30, "appearance": "Á∞°Ëø∞"}
    }
  ]
}`;
}

function applyCharactersResult(){
    const input = document.getElementById('charactersResult').value.trim();
    if(!input){ alert('Ë´ãÂÖàË≤ºÂÖ•ÁµêÊûú'); return; }
    
    try {
        const json = input.replace(/```json\s*/g,'').replace(/```\s*/g,'');
        state.characters = JSON.parse(json);
        showStep(5);
    } catch(e) {
        alert('JSONÊ†ºÂºèÈåØË™§Ôºö' + e.message);
    }
}

function showCharacterTab(type){
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('characterContent').innerHTML = renderCharacterList(type);
}

// renderStep4Full ‰øùÁïôÁõ∏ÂÆπÊÄß
function renderStep4Full(){
    return renderCharactersResult();
}

function renderCharacterList(type){
    const chars = state.characters[type] || [];
    
    if(chars.length === 0){
        return '<p style="color:var(--dim);padding:20px">Êö´ÁÑ°ËßíËâ≤</p>';
    }
    
    return chars.map(c => {
        // ‰∏ªËßí/ÈÖçËßíÈ°ØÁ§∫ÂÆåÊï¥Â∞èÂÇ≥
        if((type === 'main' || type === 'supporting') && c.physiology){
            const phy = c.physiology || {};
            const soc = c.sociology || {};
            const psy = c.psychology || {};
            const arc = c.arc || {};
            const emo = psy.emotions || {};
            
            return `
            <div class="item-card" style="padding:0;overflow:hidden;cursor:pointer;transition:all .3s" onclick="openCharacterDialog('${type}', '${c.name}')" onmouseover="this.style.boxShadow='var(--glow-md)'" onmouseout="this.style.boxShadow=''">
                <div style="background:linear-gradient(135deg,var(--primary),#ff8a5c);padding:16px;color:#fff;display:flex;align-items:center;justify-content:space-between">
                    <h5 style="margin:0;display:flex;align-items:center;gap:8px">
                        <span style="background:rgba(255,255,255,.2);padding:4px 8px;border-radius:8px;font-size:10px">${type === 'main' ? '‰∏ªËßí' : 'ÈÖçËßí'}</span>
                        ${c.name}
                        <span style="font-weight:normal;font-size:12px;opacity:.8;margin-left:auto">${c.role}</span>
                    </h5>
                    <span style="font-size:10px;opacity:.7;font-family:'Orbitron',monospace">CLICK TO EDIT</span>
                </div>
                
                <div style="padding:16px">
                    <!-- ÁîüÁêÜÁ∂≠Â∫¶ -->
                    <div style="margin-bottom:16px">
                        <div style="font-size:11px;color:var(--dim);margin-bottom:8px;font-weight:600">üë§ ÁîüÁêÜÁ∂≠Â∫¶</div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;font-size:12px">
                            ${phy.age ? `<div><span style="color:var(--dim)">Âπ¥ÈΩ°Ôºö</span>${phy.age}Ê≠≤</div>` : ''}
                            ${phy.gender ? `<div><span style="color:var(--dim)">ÊÄßÂà•Ôºö</span>${phy.gender}</div>` : ''}
                            ${phy.height ? `<div><span style="color:var(--dim)">Ë∫´È´òÔºö</span>${phy.height}</div>` : ''}
                        </div>
                        ${phy.appearance ? `<p style="font-size:12px;margin:8px 0 0"><span style="color:var(--dim)">Â§ñË≤åÔºö</span>${phy.appearance}</p>` : ''}
                        ${phy.features ? `<p style="font-size:12px;margin:4px 0 0"><span style="color:var(--dim)">ÁâπÂæµÔºö</span>${phy.features}</p>` : ''}
                        ${phy.posture ? `<p style="font-size:12px;margin:4px 0 0"><span style="color:var(--dim)">ÂßøÊÖãÔºö</span>${phy.posture}</p>` : ''}
                        ${phy.habits ? `<p style="font-size:12px;margin:4px 0 0"><span style="color:var(--dim)">ÁøíÊÖ£Ôºö</span>${phy.habits.join('„ÄÅ')}</p>` : ''}
                    </div>
                    
                    <!-- Á§æÊúÉÁ∂≠Â∫¶ -->
                    ${soc.birthplace || soc.family ? `
                    <div style="margin-bottom:16px">
                        <div style="font-size:11px;color:var(--dim);margin-bottom:8px;font-weight:600">üåç Á§æÊúÉÁ∂≠Â∫¶</div>
                        <div style="font-size:12px">
                            ${soc.birthplace ? `<p style="margin:0 0 4px"><span style="color:var(--dim)">Âá∫ÁîüÔºö</span>${soc.birthplace}</p>` : ''}
                            ${soc.family ? `<p style="margin:0 0 4px"><span style="color:var(--dim)">ÂÆ∂Â∫≠Ôºö</span>${soc.family}</p>` : ''}
                            ${soc.skills ? `<p style="margin:0 0 4px"><span style="color:var(--dim)">ÊäÄËÉΩÔºö</span>${soc.skills.join('„ÄÅ')}</p>` : ''}
                            ${soc.status ? `<p style="margin:0"><span style="color:var(--dim)">Âú∞‰ΩçÔºö</span>${soc.status}</p>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ÂøÉÁêÜÁ∂≠Â∫¶ -->
                    <div style="margin-bottom:16px">
                        <div style="font-size:11px;color:var(--primary);margin-bottom:8px;font-weight:600">üß† ÂøÉÁêÜÁ∂≠Â∫¶</div>
                        
                        <!-- ÂñúÊÄíÂìÄÊáº -->
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">
                            ${emo.joy ? `<div style="background:var(--bg);padding:8px;border-radius:6px;font-size:11px">
                                <div style="color:var(--text);font-weight:600">üòä Âñú</div>
                                <div style="color:var(--dim);margin-top:4px">${emo.joy.triggers}</div>
                            </div>` : ''}
                            ${emo.anger ? `<div style="background:var(--bg);padding:8px;border-radius:6px;font-size:11px">
                                <div style="color:var(--primary);font-weight:600">üò† ÊÄí</div>
                                <div style="color:var(--dim);margin-top:4px">${emo.anger.triggers}</div>
                            </div>` : ''}
                            ${emo.sadness ? `<div style="background:var(--bg);padding:8px;border-radius:6px;font-size:11px">
                                <div style="color:var(--dim);font-weight:600">üò¢ ÂìÄ</div>
                                <div style="color:var(--dim);margin-top:4px">${emo.sadness.triggers}</div>
                            </div>` : ''}
                            ${emo.fear ? `<div style="background:var(--bg);padding:8px;border-radius:6px;font-size:11px">
                                <div style="color:var(--dim);font-weight:600">üò® Êáº</div>
                                <div style="color:var(--dim);margin-top:4px">${emo.fear.deep || emo.fear.surface}</div>
                            </div>` : ''}
                        </div>
                        
                        <!-- ÊÑõÊÅ® -->
                        ${psy.love ? `<p style="font-size:12px;margin:0 0 4px"><span style="color:var(--dim)">‚ù§Ô∏è ÁÜ±ÊÑõÔºö</span>${Array.isArray(psy.love) ? psy.love.join('„ÄÅ') : psy.love}</p>` : ''}
                        ${psy.hate ? `<p style="font-size:12px;margin:0 0 8px"><span style="color:var(--dim)">üíî Âé≠ÊÉ°Ôºö</span>${Array.isArray(psy.hate) ? psy.hate.join('„ÄÅ') : psy.hate}</p>` : ''}
                        
                        <!-- Want/Need/Wound -->
                        <div style="background:var(--surface2);padding:12px;border-radius:8px;font-size:12px;border-left:3px solid var(--pink)">
                            ${psy.want ? `<p style="margin:0 0 6px"><strong style="color:var(--primary)">Want</strong>ÔºàÊÉ≥Ë¶ÅÔºâÔºö${psy.want}</p>` : ''}
                            ${psy.need ? `<p style="margin:0 0 6px"><strong style="color:var(--text)">Need</strong>ÔºàÈúÄË¶ÅÔºâÔºö${psy.need}</p>` : ''}
                            ${psy.wound ? `<p style="margin:0 0 6px"><strong style="color:var(--primary)">Wound</strong>ÔºàÂâµÂÇ∑ÔºâÔºö${psy.wound}</p>` : ''}
                            ${psy.ghost ? `<p style="margin:0"><strong style="color:var(--dim)">Ghost</strong>ÔºàÂü∑ÂøµÔºâÔºö${psy.ghost}</p>` : ''}
                        </div>
                    </div>
                    
                    <!-- ËßíËâ≤ÂºßÁ∑ö -->
                    ${arc.start ? `
                    <div style="margin-bottom:16px">
                        <div style="font-size:11px;color:var(--text);margin-bottom:8px;font-weight:600">üìà ËßíËâ≤ÂºßÁ∑ö</div>
                        <div style="font-size:12px;display:flex;align-items:center;gap:8px">
                            <div style="flex:1;background:var(--bg);padding:8px;border-radius:6px;text-align:center">
                                <div style="color:var(--dim);font-size:10px">Ëµ∑Èªû</div>
                                <div style="margin-top:4px">${arc.start}</div>
                            </div>
                            <div style="color:var(--primary)">‚Üí</div>
                            <div style="flex:1;background:var(--bg);padding:8px;border-radius:6px;text-align:center">
                                <div style="color:var(--dim);font-size:10px">ÁµÇÈªû</div>
                                <div style="margin-top:4px">${arc.end}</div>
                            </div>
                        </div>
                        ${arc.falseBelief ? `<p style="font-size:11px;margin:8px 0 0;color:var(--dim)">‚ùå ÈåØË™§‰ø°ÂøµÔºö${arc.falseBelief}</p>` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- Prompt -->
                    <div class="prompt-box" style="margin:0">
                        <div class="prompt-label">üñºÔ∏è AI Prompt</div>
                        ${c.prompt}
                    </div>
                </div>
            </div>`;
        }
        
        // Áæ§ÊºîÁ∞°ÂåñÈ°ØÁ§∫
        return `
        <div class="item-card">
            <h5>
                <span class="subject-type crowd">Áæ§Êºî</span>
                ${c.name}
            </h5>
            <p><strong>Ë∫´‰ªΩÔºö</strong>${c.role}</p>
            <p><strong>Â§ñË≤åÔºö</strong>${c.appearance}</p>
            ${c.props ? `<p><strong>ÈÅìÂÖ∑Ôºö</strong>${c.props.join('„ÄÅ')}</p>` : ''}
            <div class="prompt-box">
                <div class="prompt-label">üñºÔ∏è AI Prompt</div>
                ${c.prompt}
            </div>
        </div>`;
    }).join('');
}

function extractCharacters(){
    const text = state.novel.text;
    
    // Âü∫Êñº Lajos Egri ‰∏âÁ∂≠ËßíËâ≤ÁêÜË´ñÁöÑË©≥Á¥∞ËßíËâ≤Â∞èÂÇ≥
    return {
        main: [
            {
                name: 'Â∞èÁå¥Â≠ê',
                role: '‰∏ªËßí / Â∞ëÂπ¥Á•ûÂÅ∑',
                // ÁîüÁêÜÁ∂≠Â∫¶
                physiology: {
                    age: 13,
                    gender: 'Áî∑',
                    height: '155cm',
                    appearance: 'Áò¶Â∞èÈùàÊ¥ªÔºåÁöÆËÜöÈªùÈªëÂ∏∂Êõ¨ÊñëÔºåÈªëËâ≤Áü≠È´ÆÂáå‰∫Ç',
                    features: 'Ê©üË≠¶ÁöÑÂúìÁúºÁùõÔºåÂ∑¶ËáâÈ†∞Â∞èÁñ§Áóï',
                    posture: 'ÁøíÊÖ£ÊÄßÈßùËÉåÔºåÈö®ÊôÇÊ∫ñÂÇôÈÄÉË∑ë',
                    habits: ['Á∑äÂºµÊôÇÂí¨ÊåáÁî≤', 'ÊÄùËÄÉÊôÇÊ≠™È†≠', 'ÂñúÊ≠°Ëπ≤Âú®È´òËôïËßÄÂØü']
                },
                // Á§æÊúÉÁ∂≠Â∫¶
                sociology: {
                    birthplace: 'Âª£Â∑ûËïÉÂùäË≤ßÊ∞ëÂçÄ',
                    family: 'Â≠§ÂÖíÔºåË¢´‰πû‰∏êËÄÅ‰∫∫Êî∂È§äÔºàÂ∑≤Âéª‰∏ñÔºâ',
                    education: 'ÁÑ°Ê≠£ÂºèÊïôËÇ≤ÔºåËá™Â≠∏ÁîüÂ≠ò',
                    skills: ['ÊîÄÁà¨', 'ÈñãÈéñ', 'ÂÅ∑Á´ä', 'ÂØüË®ÄËßÄËâ≤'],
                    status: 'Á§æÊúÉÂ∫ïÂ±§ÔºåË¢´‰∫∫Áûß‰∏çËµ∑'
                },
                // ÂøÉÁêÜÁ∂≠Â∫¶
                psychology: {
                    emotions: {
                        joy: {triggers: 'ÂÅ∑Âà∞Â•ΩÊù±Ë•ø„ÄÅÂêÉÈ£ΩÈ£Ø„ÄÅË¢´‰∫∫Ë™áËÅ∞Êòé', expression: 'Èú≤Âá∫Áã°Èª†Á¨ëÂÆπ'},
                        anger: {triggers: 'Ë¢´Áúã‰∏çËµ∑„ÄÅË¢´È®ô„ÄÅ‰∏çÂÖ¨Âπ≥Â∞çÂæÖ', expression: 'ÂÖàÂøçËëóÔºåÊâæÊ©üÊúÉÂ†±Âæ©'},
                        sadness: {triggers: 'ÁúãÂà∞Âà•‰∫∫ÊúâÂÆ∂‰∫∫„ÄÅË¢´ÊããÊ£Ñ', expression: 'Ë∫≤Ëµ∑‰æÜÂÅ∑Âì≠'},
                        fear: {surface: 'Ë¢´Êäì‰Ωè„ÄÅÊå®È§ì', deep: 'Ê∞∏ÈÅ†Â≠§Áç®„ÄÅÊ≤í‰∫∫Âú®‰πé'}
                    },
                    love: ['Ëá™Áî±', 'Â•ΩÂêÉÁöÑÈ£üÁâ©', 'È´òËôïÔºàÂÆâÂÖ®ÊÑüÔºâ'],
                    hate: ['Ê¨∫Ë≤†Âº±Â∞èÁöÑ‰∫∫', 'ËôõÂÅΩÁöÑÊúâÈå¢‰∫∫', 'Ë¢´ÈóúËµ∑‰æÜ'],
                    want: 'ÂÅ∑Âà∞ÂÄºÈå¢ÁöÑÊù±Ë•øÔºåÈÅé‰∏äÂ•ΩÊó•Â≠ê',
                    need: 'Ë¢´Êé•Á¥ç„ÄÅË¢´Ë™çÂèØ„ÄÅÊâæÂà∞Ê≠∏Â±¨',
                    wound: 'Ë¢´Ë¶™ÁîüÁà∂ÊØçÊããÊ£ÑÔºåÂæûÂ∞èÁÑ°‰∫∫ÁÖßÈ°ß',
                    ghost: 'ËÄÅ‰πû‰∏êÁöÑÊ≠ª - ÂîØ‰∏ÄÈóúÂøÉ‰ªñÁöÑ‰∫∫Èõ¢Èñã‰∫Ü'
                },
                // ËßíËâ≤ÂºßÁ∑ö
                arc: {
                    start: 'Â≠§Áç®ÁöÑÂ∞èÂÅ∑Ôºå‰∏ç‰ø°‰ªª‰ªª‰Ωï‰∫∫',
                    falseBelief: '‰∫∫ÈÉΩÊòØËá™ÁßÅÁöÑÔºåÂè™ËÉΩÈù†Ëá™Â∑±',
                    end: 'Â≠∏ÊúÉ‰ø°‰ªªÔºåÊâæÂà∞‰∫ÜÂÆ∂‰∫∫Ëà¨ÁöÑÁæàÁµÜ'
                },
                prompt: '13 year old Chinese boy, thin agile, alert round eyes, tanned skin with freckles, messy black hair, small scar on left cheek, ragged brown clothes, Tang dynasty street thief, crouching pose ready to flee, anime style, detailed character design --ar 2:3'
            },
            {
                name: 'Â∞èËè©Ëñ©Ë†ª',
                role: 'Â•≥‰∏ªËßí / Á•ûÁßòÂ∞ëÂ•≥',
                physiology: {
                    age: 15,
                    gender: 'Â•≥',
                    height: '160cm',
                    appearance: 'Ê∏ÖÈ∫óËÑ´‰øóÔºåËÜöÂ¶ÇÂáùËÑÇÔºåÈï∑È´ÆÂèäËÖ∞',
                    features: 'Â¶ÇÊ∞¥ÊùèÁúºÔºåÂîáËßíÊ∞∏ÈÅ†Â∏∂Ê∑∫Á¨ë',
                    posture: 'Á´ôÂßøÁ´ØÊ≠£Â¶ÇËìÆËä±ÔºåÂÑ™ÈõÖÂæûÂÆπ',
                    habits: ['Ë™™Ë©±ÂâçÊúÉÂæÆÂæÆÈñâÁúº', 'ÂñúÊ≠°Êí´Êë∏ÊâãËÖï‰∏äÁöÑÂøµÁè†', 'Â∏∏Â∏∏ÊúõÂêëÈÅ†Êñπ']
                },
                sociology: {
                    birthplace: 'ÂçóÊµ∑ÊüêÁ•ûÁßòÂ≥∂Â∂º',
                    family: 'Ë∫´‰∏ñÊàêË¨éÔºå‰ºº‰πéËàáÂØ∂Áü≥ÊúâÈóú',
                    education: 'Á≤æÈÄöÂ§öÂúãË™ûË®ÄÔºåÁü•Ë≠òÊ∑µÂçö',
                    skills: ['Ëß£ËÆÄÂè§Êñá', 'Âç†Âçú', 'ËçâËó•Áü•Ë≠ò', 'Á•ûÁßòÂäõÈáè'],
                    status: 'Â§ñ‰∫∫Áúº‰∏≠ÁöÑÁ•ûÁßòÂ∞ëÂ•≥'
                },
                psychology: {
                    emotions: {
                        joy: {triggers: 'ÁúãÂà∞ÂñÑËâØÁöÑ‰∫∫„ÄÅËä±ÈñãÁöÑÊôÇÂàª', expression: 'ÂæÆÂæÆ‰∏ÄÁ¨ëÔºåÂ¶ÇÊò•È¢®'},
                        anger: {triggers: 'ÁúãÂà∞ÁîüÂëΩË¢´ËºïË¶ñ', expression: 'Áúº‰∏≠ÈñÉÈÅéÂØíÂÖâÔºåËÅ≤Èü≥ËÆäÂÜ∑'},
                        sadness: {triggers: 'ÂõûÊÜ∂ÈÅéÂéª„ÄÅÁúãÂà∞Ëº™Ëø¥ÁöÑÁÑ°Â•à', expression: 'ÁúºÁú∂Ê≥õÁ¥Ö‰ΩÜ‰∏çËêΩÊ∑ö'},
                        fear: {surface: 'ÂØ∂Áü≥Ë¢´Â•™', deep: 'ÂÜçÊ¨°Â§±ÂéªÈáçË¶ÅÁöÑ‰∫∫'}
                    },
                    love: ['ÊâÄÊúâÁîüÂëΩ', 'Êó•Âá∫Êó•ËêΩ', 'ÁúüË™†ÁöÑÂøÉ'],
                    hate: ['Ë≤™Â©™', 'ËÉåÂèõ', 'ÊØÄÊªÖ'],
                    want: 'ÂÆàË≠∑ÂØ∂Áü≥ÔºåÈòªÊ≠¢ÁÅΩÈõ£',
                    need: 'Êîæ‰∏ãÂü∑ÂøµÔºåÊé•ÂèóÁÑ°Â∏∏',
                    wound: 'Ââç‰∏ñÁöÑË®òÊÜ∂ÔºåÊÑõ‰∫∫ÁöÑÁäßÁâ≤',
                    ghost: 'ÂçÉÂπ¥ÂâçÁöÑÁ¥ÑÂÆöÔºåÊú™ËÉΩÂÆåÊàêÁöÑ‰ΩøÂëΩ'
                },
                arc: {
                    start: 'ËÉåË≤†‰ΩøÂëΩÁöÑÂÆàË≠∑ËÄÖÔºåÁñèÈõ¢‰∫∫Áæ§',
                    falseBelief: 'ÊàëÂøÖÈ†àÁç®Ëá™ÊâøÊìî‰∏ÄÂàá',
                    end: 'Â≠∏ÊúÉ‰æùË≥¥‰ªñ‰∫∫Ôºå‰∏ÄËµ∑ÂÆàË≠∑'
                },
                prompt: '15 year old Southeast Asian girl, ethereal beauty, pale smooth skin, waist-length black hair, almond eyes like still water, gentle smile, white flowing dress, prayer beads on wrist, serene bodhisattva aura, Tang dynasty style, soft lighting, anime --ar 2:3'
            }
        ],
        supporting: [
            {
                name: 'ËïÉÈï∑',
                role: 'Â§ßÈ£üÂïÜ‰∫∫ / ËàπÈöäÈ†òË¢ñ',
                physiology: {
                    age: 45,
                    appearance: 'È´òÂ§ßÈ≠ÅÊ¢ßÔºåÁµ°ËÖÆÈ¨çÔºåÊ∑±Ê≤âÁúºÁ•û',
                    features: 'ÈºªÊ®ëÈ´òÊå∫ÔºåÁöÆËÜöÂè§ÈäÖÔºåÂ∑¶ËÄ≥ÈáëÁí∞'
                },
                psychology: {
                    emotions: {
                        joy: {triggers: 'Ëà™Ë°åÈ†ÜÂà©„ÄÅÂÆ∂‰∫∫Âπ≥ÂÆâ'},
                        fear: {deep: 'Êµ∑‰∏äÁöÑË©õÂíí„ÄÅÈÅéÂéªÁöÑÁΩ™Â≠Ω'}
                    },
                    want: 'ÂÆåÊàêÈÄôË∂üËà™Ë°åÔºåË≥∫ÂèñË≤°ÂØå',
                    need: 'ÊïëË¥ñÈÅéÂéªÁöÑÈåØË™§',
                    wound: 'Âπ¥ËºïÊôÇÁÇ∫‰∫ÜÂà©ÁõäÁäßÁâ≤‰∫ÜÂêå‰º¥'
                },
                prompt: 'Middle Eastern merchant captain, 45yo, tall muscular build, thick black beard, hooked nose, bronze skin, gold earring, turban with jewel, dignified but haunted eyes, Tang dynasty maritime trade, detailed --ar 2:3'
            },
            {
                name: 'ÂçúÂ§¢Â∏´',
                role: 'Âç†ÂçúÂ∏´ / Á•ûÁßò‰∫∫Áâ©',
                physiology: {
                    age: '‰∏çË©≥Ôºà30-60ÁöÜÂèØËÉΩÔºâ',
                    appearance: 'ËíôÈù¢ÔºåÂè™Èú≤Ê∑°Ë§êËâ≤ÁúºÁú∏',
                    features: 'ËÅ≤Èü≥Â¶ÇÂè§‰∫ïÔºåÊâãÊåá‰øÆÈï∑'
                },
                psychology: {
                    emotions: {
                        joy: {triggers: 'ÂëΩÈÅãÊåâËªåË∑°ÈÅãË°å'},
                        fear: {deep: 'È†êË®ÄÂ§±Ê∫ñ„ÄÅÁÑ°Ê≥ïÊéßÂà∂'}
                    },
                    want: 'ÂºïÂ∞éÂëΩÈÅãËµ∞ÂêëÊó¢ÂÆöËªåË∑°',
                    need: '?ÔºàË¨éÂúòÔºå‰∏≠ÂæåÊúüÊè≠ÊõâÔºâ',
                    wound: '?ÔºàËàáÂØ∂Áü≥ÁöÑÈÅéÂéªÊúâÈóúÔºâ'
                },
                prompt: 'Mysterious fortune teller, veiled face revealing only amber eyes, long slender fingers with silver rings, purple robes with strange symbols, surrounded by incense smoke, candlelight, Tang dynasty mystic, ominous atmosphere --ar 2:3'
            },
            {
                name: 'Á¥ÖÈ´ÆÁõ≤ËÄÅ‰∫∫',
                role: 'Ê∏ØÂè£Ë™™Êõ∏‰∫∫ / Êô∫ËÄÖ',
                physiology: {
                    age: 70,
                    appearance: 'ÊûØÁò¶ÔºåÁ¥ÖÈ´ÆÔºàÊ≥¢ÊñØË°ÄÁµ±ÔºâÔºåÈõôÁõÆÂ§±Êòé',
                    features: '‰ΩùÂÉÇ‰ΩÜËÅ≤Èü≥Ê¥™‰∫ÆÔºåÁ∏ΩÂ∏∂ËëóÂæÆÁ¨ë'
                },
                psychology: {
                    emotions: {
                        joy: {triggers: 'Êúâ‰∫∫È°òÊÑèËÅΩÊïÖ‰∫ã'},
                        sadness: {triggers: 'ÊÉ≥Ëµ∑Âπ¥ËºïÊôÇÁöÑÂÜíÈö™'}
                    },
                    want: 'Âú®Ê≠ªÂâçÊääÊâÄÊúâÊïÖ‰∫ãË¨õÂÆå',
                    need: 'ÊâæÂà∞ÂÇ≥ÊâøËÄÖ',
                    wound: 'Êµ∑‰∏äÂ§±ÂéªÈõôÁúºÂíåÊëØÊÑõ'
                },
                prompt: 'Old blind storyteller, 70yo, thin frail body, striking red hair faded with age, milky blind eyes, warm smile, grey tattered robes, bamboo walking cane, sitting under banyan tree, Tang dynasty port atmosphere --ar 2:3'
            }
        ],
        extras: [
            {
                name: 'ËïÉÂùäÂïÜË≤©',
                role: 'ËÉåÊôØÁæ§Êºî',
                appearance: 'ÂêÑÂúãÂïÜ‰∫∫Ê∑∑ÈõúÔºöÊ≥¢ÊñØÂú∞ÊØØÂïÜ„ÄÅÂ§ßÈ£üÈ¶ôÊñôË≤©„ÄÅÂ§©Á´∫Áè†ÂØ∂Âå†',
                props: ['È¶ôÊñôË¢ã', 'ÈäÖÁß§', 'ÂêÑÂúãË≤®Âπ£', 'Âè´Ë≥£ÊãõÁâå'],
                prompt: 'Crowded Tang dynasty Fanfang marketplace, diverse merchants - Persian carpet seller, Arabian spice trader, Indian jeweler, colorful goods everywhere, busy haggling atmosphere, warm afternoon light --ar 16:9'
            },
            {
                name: 'ËàπÂì°Ê∞¥Êâã',
                role: 'ËÉåÊôØÁæ§Êºî',
                appearance: 'Ëµ§ËÜäÊàñÁü≠ÊâìÔºåÁöÆËÜöÈªùÈªëÔºåÊâãËáÇÁ≤óÂ£Ø',
                props: ['Áπ©Á¥¢', 'Êú®Ê°∂', 'ËàπÂ∏Ü', 'Èâ§Â≠ê'],
                prompt: 'Tang dynasty ship crew, muscular sailors with tanned skin, carrying cargo, coiling ropes, wooden ship deck, sea breeze, working hard, sweat glistening --ar 16:9'
            },
            {
                name: 'Êµ∑ÁõúÂúò',
                role: 'ÂèçÊ¥æÁæ§Êºî',
                appearance: 'Èù¢ÁõÆÁåôÁç∞ÔºåÁñ§ÁóïÁ¥ãË∫´ÔºåÊ≠¶Âô®Ê£ÆÊ£Æ',
                props: ['ÂΩéÂàÄ', 'ÈªëÊóó', 'ÁÅ´Êää', 'Áπ©Á∂≤'],
                prompt: 'Fierce Tang dynasty era pirates, scarred faces, tattoos, wielding curved swords, black sailed ship, menacing expressions, torchlight, dangerous atmosphere --ar 16:9'
            }
        ]
    };
}

// ==================== Â∞çË©±ÂºèËßíËâ≤Á∑®ËºØ ====================
function openCharacterDialog(type, name) {
    // ÊâæÂà∞ËßíËâ≤
    const chars = state.characters[type] || [];
    const charIndex = chars.findIndex(c => c.name === name);
    if (charIndex === -1) return;
    
    const char = chars[charIndex];
    
    // ÂàõÂª∫ÂØπËØùÊ°Ü
    const dialog = document.createElement('div');
    dialog.id = 'characterEditDialog';
    dialog.style.cssText = `
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,.85);
        display:flex;align-items:center;justify-content:center;
        z-index:10000;
        backdrop-filter:blur(5px);
    `;
    
    dialog.innerHTML = `
        <div style="background:var(--surface);border:1px solid var(--primary);width:90%;max-width:500px;max-height:80vh;overflow-y:auto;position:relative;clip-path:polygon(0 0,calc(100% - 20px) 0,100% 20px,100% 100%,20px 100%,0 calc(100% - 20px))">
            <div style="background:linear-gradient(135deg,var(--primary),var(--pink));padding:20px;color:#fff">
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <div>
                        <div style="font-family:'Orbitron',monospace;font-size:10px;opacity:.7;letter-spacing:2px">CHARACTER EDIT MODE</div>
                        <div style="font-size:18px;font-weight:600;margin-top:4px">${char.name}</div>
                    </div>
                    <button onclick="closeCharacterDialog()" style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:0;line-height:1">√ó</button>
                </div>
            </div>
            
            <div style="padding:20px">
                <div style="background:var(--bg);border:1px solid var(--border);padding:16px;margin-bottom:20px">
                    <div style="font-family:'Orbitron',monospace;font-size:9px;color:var(--dim);margin-bottom:12px;letter-spacing:2px">üí° Â∞çË©±ÂºèÁ∑®ËºØ</div>
                    <div style="font-size:12px;color:var(--dim);line-height:1.8">
                        Áî®Ëá™ÁÑ∂Ë™ûË®ÄÊèèËø∞‰Ω†ÊÉ≥‰øÆÊîπÁöÑÂÖßÂÆπÔºå‰æãÂ¶ÇÔºö<br>
                        <span style="color:var(--text)">„ÄåÂπ¥ÈΩ°ÊîπÊàê18Ê≠≤„Äç</span><br>
                        <span style="color:var(--text)">„ÄåÂä†‰∏ä‰∏ÄÂÄãÁøíÊÖ£ÔºöÂñúÊ≠°ÁúãÊµ∑„Äç</span><br>
                        <span style="color:var(--text)">„ÄåÂ•πÁöÑÂâµÂÇ∑ÊòØÂ§±Âéª‰∫ÜÊØçË¶™„Äç</span><br>
                        <span style="color:var(--text)">„ÄåÂ§ñË≤åÊõ¥ÂÜ∑Ëâ∑‰∏ÄÈªû„Äç</span>
                    </div>
                </div>
                
                <div style="margin-bottom:16px">
                    <textarea id="charEditInput" class="form-input" style="min-height:100px" placeholder="Ëº∏ÂÖ•‰Ω†ÊÉ≥‰øÆÊîπÁöÑÂÖßÂÆπ..."></textarea>
                </div>
                
                <div id="charEditHistory" style="margin-bottom:16px;max-height:150px;overflow-y:auto"></div>
                
                <div style="display:flex;gap:10px">
                    <button class="btn" onclick="closeCharacterDialog()" style="flex:1">ÂèñÊ∂à</button>
                    <button class="btn btn-primary" onclick="applyCharacterEdit('${type}', ${charIndex})" style="flex:1">ÊáâÁî®‰øÆÊîπ</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
    document.getElementById('charEditInput').focus();
    
    // ESCÂÖ≥Èó≠
    dialog.addEventListener('click', (e) => {
        if (e.target === dialog) closeCharacterDialog();
    });
}

function closeCharacterDialog() {
    const dialog = document.getElementById('characterEditDialog');
    if (dialog) dialog.remove();
}

function applyCharacterEdit(type, index) {
    const input = document.getElementById('charEditInput').value.trim();
    if (!input) {
        alert('Ë´ãËº∏ÂÖ•‰øÆÊîπÂÖßÂÆπ');
        return;
    }
    
    const char = state.characters[type][index];
    const historyDiv = document.getElementById('charEditHistory');
    
    // Ëß£ÊûêÂπ∂Â∫îÁî®‰øÆÊîπÔºàÁÆÄÂçïÁöÑÂÖ≥ÈîÆËØçÂåπÈÖçÔºâ
    let applied = [];
    
    // Âπ¥ÈæÑ
    const ageMatch = input.match(/Âπ¥[ÈΩ°ÈæÑ]\s*[ÊîπÁÇ∫‰∏∫ÊàêÔºö:]*\s*(\d+)/);
    if (ageMatch && char.physiology) {
        char.physiology.age = parseInt(ageMatch[1]);
        applied.push(`Âπ¥ÈΩ° ‚Üí ${ageMatch[1]}Ê≠≤`);
    }
    
    // Ë∫´È´ò
    const heightMatch = input.match(/Ë∫´È´ò\s*[ÊîπÁÇ∫‰∏∫ÊàêÔºö:]*\s*(\d+)/);
    if (heightMatch && char.physiology) {
        char.physiology.height = heightMatch[1] + 'cm';
        applied.push(`Ë∫´È´ò ‚Üí ${heightMatch[1]}cm`);
    }
    
    // ÊÄßÂà´
    if (/ÊÄß[Âà•Âà´]\s*[ÊîπÁÇ∫‰∏∫ÊàêÔºö:]*\s*[Áî∑Â•≥]/.test(input)) {
        const gender = input.includes('Áî∑') ? 'Áî∑' : 'Â•≥';
        if (char.physiology) {
            char.physiology.gender = gender;
            applied.push(`ÊÄßÂà• ‚Üí ${gender}`);
        }
    }
    
    // Â§ñË≤å
    const appearMatch = input.match(/Â§ñ[Ë≤åË°®].*[ÊîπÁÇ∫‰∏∫ÊàêÔºö:]\s*(.+)/);
    if (appearMatch && char.physiology) {
        char.physiology.appearance = appearMatch[1].trim();
        applied.push(`Â§ñË≤å ‚Üí ${appearMatch[1].trim()}`);
    }
    
    // Want
    const wantMatch = input.match(/[Ww]ant.*[ÊîπÁÇ∫‰∏∫ÊàêÔºö:]\s*(.+)/);
    if (wantMatch && char.psychology) {
        char.psychology.want = wantMatch[1].trim();
        applied.push(`Want ‚Üí ${wantMatch[1].trim()}`);
    }
    
    // Need  
    const needMatch = input.match(/[Nn]eed.*[ÊîπÁÇ∫‰∏∫ÊàêÔºö:]\s*(.+)/);
    if (needMatch && char.psychology) {
        char.psychology.need = needMatch[1].trim();
        applied.push(`Need ‚Üí ${needMatch[1].trim()}`);
    }
    
    // ÂâµÂÇ∑/Wound
    const woundMatch = input.match(/[ÂâµÂàõ]ÂÇ∑|[Ww]ound.*[ÊîπÁÇ∫‰∏∫ÊàêÊòØÔºö:]\s*(.+)/);
    if (woundMatch && char.psychology) {
        char.psychology.wound = woundMatch[1]?.trim() || input.replace(/.*[ÊòØÔºö:]/, '').trim();
        applied.push(`Wound ‚Üí ${char.psychology.wound}`);
    }
    
    // ‰π†ÊÉØ
    const habitMatch = input.match(/[Áøí‰π†][ÊÖ£ÊÉØ].*[Âä†‰∏äÊ∑ª].*[Ôºö:„Äå]?\s*(.+?)[„Äç]?$/);
    if (habitMatch && char.physiology?.habits) {
        char.physiology.habits.push(habitMatch[1].trim());
        applied.push(`Êñ∞Â¢ûÁøíÊÖ£Ôºö${habitMatch[1].trim()}`);
    }
    
    // ÊòæÁ§∫ÁªìÊûú
    if (applied.length > 0) {
        historyDiv.innerHTML += `
            <div style="background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);padding:10px;margin-bottom:8px;font-size:12px">
                <div style="color:var(--text);font-weight:600;margin-bottom:4px">‚úì Â∑≤ÊáâÁî®‰øÆÊîπ</div>
                ${applied.map(a => `<div style="color:var(--text)">‚Ä¢ ${a}</div>`).join('')}
            </div>
        `;
        document.getElementById('charEditInput').value = '';
        
        // Êõ¥Êñ∞‰∏ªÁïåÈù¢
        showStep(5);
    } else {
        historyDiv.innerHTML += `
            <div style="background:rgba(128,128,128,.1);border:1px solid rgba(128,128,128,.3);padding:10px;margin-bottom:8px;font-size:12px">
                <div style="color:var(--dim);font-weight:600;margin-bottom:4px">‚ö†Ô∏è ÁÑ°Ê≥ïË≠òÂà•‰øÆÊîπÊÑèÂúñ</div>
                <div style="color:var(--dim)">Ë´ãÂòóË©¶Êõ¥ÊòéÁ¢∫ÁöÑÊèèËø∞ÔºåÂ¶ÇÔºö„ÄåÂπ¥ÈΩ°ÊîπÊàê18Ê≠≤„Äç</div>
            </div>
        `;
    }
}

// ==================== Step 6: ÊúçÂåñÈÅì ====================
function renderStep5(){
    // Â∑≤ÊúâÊï∏Êìö ‚Üí È°ØÁ§∫ÁµêÊûú
    if(state.scenes?.length > 0 && state.scenes[0].structure){
        return renderDesignResult();
    }
    
    const prompt = generateDesignPrompt();
    
    return `
        <div class="content-card">
            <h3><span class="icon">üé®</span> ÁæéË°ìAgent + Â†¥ÊôØAgent</h3>
            
            <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#f59e0b,#10b981);border-radius:50%;display:flex;align-items:center;justify-content:center">üé®</div>
                    <div>
                        <div style="font-weight:600">Step 1ÔºöË§áË£Ω Prompt Âà∞ Claude</div>
                        <div style="font-size:12px;color:var(--dim)">Ë®≠Ë®àÂ†¥ÊôØ„ÄÅÊúçË£ù„ÄÅÈÅìÂÖ∑</div>
                    </div>
                </div>
                <div style="position:relative">
                    <textarea id="designPrompt" class="form-input" style="height:120px;font-size:11px;font-family:monospace" readonly>${prompt}</textarea>
                    <button onclick="copyToClipboard('designPrompt')" style="position:absolute;top:8px;right:8px;background:var(--primary);border:none;color:#fff;padding:8px 16px;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600">
                        üìã Ë§áË£Ω
                    </button>
                </div>
            </div>
            
            <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#f59e0b,#10b981);border-radius:50%;display:flex;align-items:center;justify-content:center">üì•</div>
                    <div><div style="font-weight:600">Step 2ÔºöË≤ºÂõûÁµêÊûú</div></div>
                </div>
                <textarea id="designResult" class="form-input" style="height:150px" placeholder='Ë≤º‰∏ä JSON...'></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="applyDesignResult()" style="width:100%">
                ‚úì Á¢∫Ë™çÊúçÂåñÈÅìË®≠Ë®à
            </button>
        </div>
    `;
}

function renderDesignResult(){
    const scenes = state.scenes || [];
    const costumes = state.costumes || [];
    const props = state.props || [];
    
    return `
        <div class="content-card">
            <h3><span class="icon">üé®</span> ÊúçÂåñÈÅì + Â†¥ÊôØ</h3>
            
            <div class="report">
                <h4>üèõÔ∏è Â†¥ÊôØË®≠Ë®à (${scenes.length})</h4>
                ${scenes.map((s,i) => `
                    <div class="item-card">
                        <h5>${s.icon||'üìç'} ${s.name}</h5>
                        <p style="color:var(--dim);font-size:12px">${s.brief||''}</p>
                        <p><strong>Ê∞õÂúçÔºö</strong>${s.atmosphere||''}</p>
                        <p><strong>ÂÖâÁ∑öÔºö</strong>${s.lighting||''}</p>
                        ${s.props?.length ? `<p><strong>ÈÅìÂÖ∑Ôºö</strong>${s.props.join('„ÄÅ')}</p>` : ''}
                    </div>
                `).join('')}
            </div>
            
            ${costumes.length ? `
            <div class="report">
                <h4>üëî ËßíËâ≤ÊúçË£ù</h4>
                ${costumes.map(c => `
                    <div class="item-card">
                        <h5>${c.character}</h5>
                        <p>${c.description}</p>
                    </div>
                `).join('')}
            </div>
            ` : ''}
            
            ${props.length ? `
            <div class="report">
                <h4>üè∫ ÈóúÈçµÈÅìÂÖ∑</h4>
                ${props.map(p => `
                    <div class="item-card">
                        <h5>${p.name}</h5>
                        <p>${p.description}</p>
                    </div>
                `).join('')}
            </div>
            ` : ''}
            
            <div class="btn-group">
                <button class="btn" onclick="state.scenes=[];state.costumes=[];state.props=[];showStep(6)">üîÑ ÈáçÊñ∞Ë®≠Ë®à</button>
                <button class="btn btn-primary" onclick="nextStep()">Á¢∫Ë™ç ‚Üí Á´†ÁØÄÂäáÊú¨</button>
            </div>
        </div>
    `;
}

function generateDesignPrompt(){
    const concept = state.concept || {};
    const chars = state.characters || {};
    const chapters = state.chapters || [];
    
    const charNames = [...(chars.main||[]), ...(chars.supporting||[])].map(c=>c.name).join('„ÄÅ');
    const places = state.aiAnalysis?.places?.map(p=>p.name).join('„ÄÅ') || '';
    
    return `‰Ω†ÊòØÁæéË°ìÊåáÂ∞éÔºåË´ãË®≠Ë®àÊúçÂåñÈÅìÂíåÂ†¥ÊôØ„ÄÇ

„Äê‰ΩúÂìÅ„Äë${state.novel?.title || ''}
„ÄêÈ°ûÂûã„Äë${concept.genre || ''}
„ÄêÊôÇ‰ª£„Äë${concept.era || ''}
„ÄêËßíËâ≤„Äë${charNames}
„ÄêÂ†¥ÊôØ„Äë${places}

Ë´ãËøîÂõûJSONÔºö
{
  "visualStyle": {
    "tone": "Êï¥È´îË¶ñË¶∫Âü∫Ë™ø",
    "colorPalette": "‰∏ªËâ≤Ë™øÊñπÊ°à",
    "reference": "ÂèÉËÄÉ‰ΩúÂìÅ"
  },
  "scenes": [
    {
      "name": "Â†¥ÊôØÂêç",
      "icon": "emoji",
      "brief": "‰∏ÄÂè•Ë©±ÊèèËø∞",
      "structure": "Á©∫ÈñìÁµêÊßã",
      "lighting": "ÂÖâÁ∑öË®≠Ë®à",
      "atmosphere": "Ê∞õÂúçËâ≤Ë™ø",
      "props": ["ÈÅìÂÖ∑1", "ÈÅìÂÖ∑2"]
    }
  ],
  "costumes": [
    {
      "character": "ËßíËâ≤Âêç",
      "description": "ÊúçË£ùÊèèËø∞",
      "colorScheme": "ÈÖçËâ≤",
      "accessories": "ÈÖçÈ£æ"
    }
  ],
  "keyProps": [
    {
      "name": "ÈÅìÂÖ∑Âêç",
      "description": "Â§ñËßÄ+ÂäüËÉΩÊèèËø∞",
      "significance": "Êïò‰∫ãÊÑèÁæ©"
    }
  ]
}`;
}

function applyDesignResult(){
    const input = document.getElementById('designResult').value.trim();
    if(!input){ alert('Ë´ãÂÖàË≤ºÂÖ•ÁµêÊûú'); return; }
    
    try {
        const json = input.replace(/```json\s*/g,'').replace(/```\s*/g,'');
        const result = JSON.parse(json);
        
        state.scenes = result.scenes || [];
        state.costumes = result.costumes || [];
        state.props = result.keyProps || [];
        state.visualStyle = result.visualStyle || {};
        
        showStep(6);
    } catch(e) {
        alert('JSONÊ†ºÂºèÈåØË™§Ôºö' + e.message);
    }
}

// ==================== Step 7: Á´†ÁØÄÂäáÊú¨ ====================
function renderStep6(){
    // Â∑≤ÊúâÂäáÊú¨ ‚Üí È°ØÁ§∫ÁµêÊûú
    if(state.scripts?.length > 0){
        return renderScriptsResult();
    }
    
    const prompt = generateScriptsPrompt();
    
    return `
        <div class="content-card">
            <h3><span class="icon">‚úçÔ∏è</span> Á∑®ÂäáAgent</h3>
            
            <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-radius:50%;display:flex;align-items:center;justify-content:center">‚úçÔ∏è</div>
                    <div>
                        <div style="font-weight:600">Step 1ÔºöÈÅ∏ÊìáÁ´†ÁØÄÔºåË§áË£Ω Prompt Âà∞ Claude</div>
                        <div style="font-size:12px;color:var(--dim)">Â∞áÂ∞èË™™Á´†ÁØÄÊîπÁ∑®ÁÇ∫ÂäáÊú¨Ê†ºÂºè</div>
                    </div>
                </div>
                
                <div style="margin-bottom:12px">
                    <label style="font-size:12px;color:var(--dim)">ÈÅ∏ÊìáÁ´†ÁØÄÔºö</label>
                    <select id="scriptChapterSelect" onchange="updateScriptPrompt()" class="form-input" style="margin-top:4px">
                        ${(state.chapters||[]).map((ch,i) => `<option value="${i}">Á¨¨${i+1}Á´†Ôºö${ch.title}</option>`).join('')}
                    </select>
                </div>
                
                <div style="position:relative">
                    <textarea id="scriptsPrompt" class="form-input" style="height:120px;font-size:11px;font-family:monospace" readonly>${prompt}</textarea>
                    <button onclick="copyToClipboard('scriptsPrompt')" style="position:absolute;top:8px;right:8px;background:var(--primary);border:none;color:#fff;padding:8px 16px;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600">
                        üìã Ë§áË£Ω
                    </button>
                </div>
            </div>
            
            <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-radius:50%;display:flex;align-items:center;justify-content:center">üì•</div>
                    <div><div style="font-weight:600">Step 2ÔºöË≤ºÂõûÁµêÊûú</div></div>
                </div>
                <textarea id="scriptsResult" class="form-input" style="height:150px" placeholder='Ë≤º‰∏ä JSON...'></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="applyScriptsResult()" style="width:100%">
                ‚úì Á¢∫Ë™çÂäáÊú¨
            </button>
        </div>
    `;
}

function renderScriptsResult(){
    const scripts = state.scripts || [];
    return `
        <div class="content-card">
            <h3><span class="icon">‚úçÔ∏è</span> Á´†ÁØÄÂäáÊú¨</h3>
            
            <div class="tabs">
                ${scripts.map((s,i) => `<div class="tab ${i===0?'active':''}" onclick="showScriptTab(${i})">Á¨¨${s.chapter}Á´†</div>`).join('')}
            </div>
            
            <div id="scriptDisplay">
                ${scripts[0] ? renderScriptDetail(scripts[0]) : '<p>Êö´ÁÑ°ÂäáÊú¨</p>'}
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="state.scripts=[];showStep(7)">+ ÁπºÁ∫åÁîüÊàêÂÖ∂‰ªñÁ´†ÁØÄ</button>
                <button class="btn btn-primary" onclick="nextStep()">Á¢∫Ë™ç ‚Üí ÂàÜÈè°Ë®≠Ë®à</button>
            </div>
        </div>
    `;
}

function renderScriptDetail(script){
    return `
        <div class="report">
            ${(script.scenes||[]).map(sc => `
                <div class="item-card" style="margin-bottom:16px">
                    <div style="background:var(--surface2);padding:12px;margin:-16px -16px 16px;border-bottom:1px solid var(--border)">
                        <strong style="color:var(--primary)">${sc.heading || sc.location || ''}</strong>
                    </div>
                    <div style="color:var(--dim);margin-bottom:12px;font-size:13px">${sc.action || ''}</div>
                    ${(sc.beats||[]).map(b => {
                        if(b.type === 'dialogue') return `<div style="text-align:center;margin:16px 0"><div style="font-weight:bold">${b.character}</div><div style="color:var(--primary)">${b.line}</div></div>`;
                        return `<p style="color:var(--dim)">${b.content||''}</p>`;
                    }).join('')}
                </div>
            `).join('')}
        </div>
    `;
}

function showScriptTab(i){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('scriptDisplay').innerHTML = renderScriptDetail(state.scripts[i]);
}

function generateScriptsPrompt(){
    const chIdx = document.getElementById('scriptChapterSelect')?.value || 0;
    const ch = state.chapters?.[chIdx] || {};
    const chars = state.characters || {};
    const concept = state.concept || {};
    
    return `‰Ω†ÊòØÂ∞àÊ•≠Á∑®ÂäáÔºåË´ãÂ∞áÂ∞èË™™Á´†ÁØÄÊîπÁ∑®ÁÇ∫ÂäáÊú¨Ê†ºÂºè„ÄÇ

„Äê‰ΩúÂìÅ„Äë${state.novel?.title || ''}
„ÄêÈ°ûÂûã„Äë${concept.genre || ''}
„ÄêËßíËâ≤„Äë${[...(chars.main||[]),...(chars.supporting||[])].map(c=>c.name).join('„ÄÅ')}

„ÄêÁ¨¨${parseInt(chIdx)+1}Á´†ÂéüÊñá„Äë
${(ch.content || '').substring(0, 5000)}...

Ë´ãËøîÂõûJSONÔºö
{
  "chapter": ${parseInt(chIdx)+1},
  "title": "${ch.title || ''}",
  "scenes": [
    {
      "heading": "INT./EXT. Â†¥ÊôØ - ÊôÇÈñì",
      "action": "Â†¥ÊôØÊèèËø∞ÔºàË¶ñË¶∫ÂåñÁöÑÂãï‰ΩúÊèèÂØ´Ôºâ",
      "beats": [
        {"type": "action", "content": "Âãï‰ΩúÊèèËø∞"},
        {"type": "dialogue", "character": "ËßíËâ≤Âêç", "parenthetical": "Ë°®ÊºîÊåáÁ§∫", "line": "Âè∞Ë©û"},
        {"type": "reaction", "character": "ËßíËâ≤Âêç", "content": "ÂèçÊáâÊèèËø∞"}
      ],
      "transition": "ËΩâÂ†¥ÔºàCUT TO / DISSOLVE TOÔºâ"
    }
  ]
}`;
}

function updateScriptPrompt(){
    document.getElementById('scriptsPrompt').value = generateScriptsPrompt();
}

function applyScriptsResult(){
    const input = document.getElementById('scriptsResult').value.trim();
    if(!input){ alert('Ë´ãÂÖàË≤ºÂÖ•ÁµêÊûú'); return; }
    
    try {
        const json = input.replace(/```json\s*/g,'').replace(/```\s*/g,'');
        const result = JSON.parse(json);
        
        if(!state.scripts) state.scripts = [];
        state.scripts.push(result);
        
        showStep(7);
    } catch(e) {
        alert('JSONÊ†ºÂºèÈåØË™§Ôºö' + e.message);
    }
}

// ==================== Step 8: ÂàÜÈè°Ë®≠Ë®à ====================
function renderStep7(){
    // Â∑≤ÊúâÂàÜÈè° ‚Üí È°ØÁ§∫ÁµêÊûú
    if(state.storyboard?.length > 0){
        return renderStoryboardResult();
    }
    
    const prompt = generateStoryboardPrompt();
    
    return `
        <div class="content-card">
            <h3><span class="icon">üé¨</span> ÂàÜÈè°Agent</h3>
            
            <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#ef4444,#f59e0b);border-radius:50%;display:flex;align-items:center;justify-content:center">üé¨</div>
                    <div>
                        <div style="font-weight:600">Step 1ÔºöË§áË£Ω Prompt Âà∞ Claude</div>
                        <div style="font-size:12px;color:var(--dim)">ÁîüÊàêÂàÜÈè°Ë°® + AIÁπ™ÂúñPrompt</div>
                    </div>
                </div>
                <div style="position:relative">
                    <textarea id="storyboardPrompt" class="form-input" style="height:120px;font-size:11px;font-family:monospace" readonly>${prompt}</textarea>
                    <button onclick="copyToClipboard('storyboardPrompt')" style="position:absolute;top:8px;right:8px;background:var(--primary);border:none;color:#fff;padding:8px 16px;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600">
                        üìã Ë§áË£Ω
                    </button>
                </div>
            </div>
            
            <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#ef4444,#f59e0b);border-radius:50%;display:flex;align-items:center;justify-content:center">üì•</div>
                    <div><div style="font-weight:600">Step 2ÔºöË≤ºÂõûÁµêÊûú</div></div>
                </div>
                <textarea id="storyboardResult" class="form-input" style="height:150px" placeholder='Ë≤º‰∏ä JSON...'></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="applyStoryboardResult()" style="width:100%">
                ‚úì Á¢∫Ë™çÂàÜÈè°
            </button>
        </div>
    `;
}

function renderStoryboardResult(){
    const shots = state.storyboard || [];
    const totalDuration = shots.reduce((sum,s)=>sum+(parseFloat(s.duration)||6),0);
    
    return `
        <div class="content-card">
            <h3><span class="icon">üé¨</span> ÂàÜÈè°Ë°®</h3>
            
            <div class="report">
                <div class="report-grid">
                    <div class="stat-box"><div class="stat-val">${shots.length}</div><div class="stat-label">Á∏ΩÈè°È†≠</div></div>
                    <div class="stat-box"><div class="stat-val">${Math.round(totalDuration/60)}ÂàÜÈêò</div><div class="stat-label">È†êË®àÊôÇÈï∑</div></div>
                </div>
            </div>
            
            <div class="report">
                ${shots.slice(0,20).map((shot,i) => `
                    <div class="item-card" style="display:grid;grid-template-columns:60px 1fr;gap:12px">
                        <div style="background:var(--primary);color:#fff;padding:8px;text-align:center;font-family:'Orbitron';font-size:12px">
                            #${(shot.id||i+1).toString().padStart(3,'0')}
                        </div>
                        <div>
                            <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
                                <span class="tag">${shot.shotSize||'‰∏≠ÊôØ'}</span>
                                <span class="tag">${shot.angle||'Âπ≥Ë¶ñ'}</span>
                                <span class="tag">${shot.movement||'Âõ∫ÂÆö'}</span>
                                <span class="tag">${shot.duration||6}Áßí</span>
                            </div>
                            <p style="margin-bottom:8px">${shot.description||''}</p>
                            ${shot.aiPrompt ? `
                            <div style="background:var(--bg);padding:8px;font-size:11px;font-family:monospace;color:var(--dim);border-left:2px solid var(--primary)">
                                üñºÔ∏è ${shot.aiPrompt.substring(0,150)}...
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
                ${shots.length > 20 ? `<p style="color:var(--dim);text-align:center">...ÈÇÑÊúâ ${shots.length-20} ÂÄãÈè°È†≠</p>` : ''}
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="state.storyboard=[];showStep(8)">üîÑ ÈáçÊñ∞ÁîüÊàê</button>
                <button class="btn btn-primary" onclick="nextStep()">Á¢∫Ë™ç ‚Üí Ëº∏Âá∫</button>
            </div>
        </div>
    `;
}

function generateStoryboardPrompt(){
    const scripts = state.scripts || [];
    const chars = state.characters || {};
    const style = state.visualStyle || {};
    
    const scriptSample = scripts[0]?.scenes?.slice(0,2).map(s => s.heading + ': ' + s.action).join('\n') || '';
    
    return `‰Ω†ÊòØÂàÜÈè°Â∏´+AIÁπ™ÂúñÂ∞àÂÆ∂ÔºåË´ãÁÇ∫ÂäáÊú¨ÁîüÊàêÂàÜÈè°Ë°®„ÄÇ

„ÄêË¶ñË¶∫È¢®Ê†º„Äë${style.tone || ''}
„ÄêËßíËâ≤„Äë${[...(chars.main||[]),...(chars.supporting||[])].map(c=>c.name).join('„ÄÅ')}

„ÄêÂäáÊú¨ÁâáÊÆµ„Äë
${scriptSample || state.chapters?.[0]?.content?.substring(0,2000) || ''}

Ë´ãÁÇ∫Ââç10ÂÄãÈè°È†≠ËøîÂõûJSONÔºö
{
  "shots": [
    {
      "id": 1,
      "scene": "Â†¥ÊôØÂêç",
      "shotSize": "ÈÅ†ÊôØ/ÂÖ®ÊôØ/‰∏≠ÊôØ/ËøëÊôØ/ÁâπÂØ´",
      "angle": "Âπ≥Ë¶ñ/‰øØÊãç/‰ª∞Êãç/ÂÇæÊñú",
      "movement": "Âõ∫ÂÆö/Êé®/Êãâ/Êêñ/Áßª/Ë∑ü",
      "duration": 6,
      "description": "Èè°È†≠ÂÖßÂÆπÊèèËø∞",
      "subject": "‰∏ªÈ´îÔºà‰∫∫Áâ©/Áâ©È´î/Áí∞Â¢ÉÔºâ",
      "emotion": "ÊÉÖÁ∑íÊ∞õÂúç",
      "aiPrompt": "Midjourney/SD PromptÔºàËã±ÊñáÔºåÂåÖÂê´È¢®Ê†º„ÄÅÂÖâÁ∑ö„ÄÅÊßãÂúñÔºâ"
    }
  ]
}

aiPromptÊ†ºÂºèÔºö[‰∏ªÈ´îÊèèËø∞], [Âãï‰Ωú/ÁãÄÊÖã], [Áí∞Â¢É], [ÂÖâÁ∑ö], [È¢®Ê†º], [Èè°È†≠]
Á§∫‰æãÔºöyoung boy thief hiding in shadows, ancient Chinese harbor market, golden hour lighting, cinematic, wide shot --ar 16:9`;
}

function applyStoryboardResult(){
    const input = document.getElementById('storyboardResult').value.trim();
    if(!input){ alert('Ë´ãÂÖàË≤ºÂÖ•ÁµêÊûú'); return; }
    
    try {
        const json = input.replace(/```json\s*/g,'').replace(/```\s*/g,'');
        const result = JSON.parse(json);
        
        state.storyboard = result.shots || result;
        showStep(8);
    } catch(e) {
        alert('JSONÊ†ºÂºèÈåØË™§Ôºö' + e.message);
    }
}

// ‰øùÁïôÁõ∏ÂÆπÊÄß
function renderStep7Full(){
    return renderStoryboardResult();
}

function renderShotCard(shot){
    const subjectType = SUBJECT_TYPES[shot.subject.type];
    
    return `
        <div class="item-card" style="border-left:3px solid var(--primary)">
            <h5>
                <span class="shot-id">#${shot.id}</span>
                <span class="shot-type ${shot.shotType}">${shot.shotType === 'narrative' ? 'üìñÊïò‰∫ã' : shot.shotType === 'dramatic' ? 'üéØÊà≤Âäá' : 'üé®ÊÉÖÊÑü'}</span>
                <span style="color:var(--dim);font-weight:normal;margin-left:auto">${shot.duration}</span>
            </h5>
            
            <!-- 1Ô∏è‚É£ ÂàÜÈè°AgentÔºöÊÉÖÁØÄ -->
            <div class="agent-output" style="background:rgba(255,107,53,.1);border:1px solid rgba(255,107,53,.3);border-radius:8px;padding:12px;margin:8px 0">
                <div style="font-size:10px;color:var(--primary);font-weight:600;margin-bottom:8px">1Ô∏è‚É£ ÂàÜÈè°Agent | ÊÉÖÁØÄ</div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:12px">
                    <span><strong>È°ûÂûãÔºö</strong>${shot.shotType === 'narrative' ? 'üìñÊïò‰∫ã' : shot.shotType === 'dramatic' ? 'üéØÊà≤Âäá' : 'üé®ÊÉÖÊÑü'}</span>
                    <span><strong>ÊôÇÈï∑Ôºö</strong>${shot.duration}</span>
                    <span><strong>Ê©ü‰ΩçÔºö</strong>${shot.camera.angle}</span>
                </div>
                <div style="font-size:12px;margin-top:8px;color:var(--dim)">
                    <strong>Êïò‰∫ãÂäüËÉΩÔºö</strong>${shot.narrativeFunction || 'Êé®ÈÄ≤ÊÉÖÁØÄÔºåÂª∫Á´ãÂ†¥ÊôØ'}
                </div>
                ${shot.storyboardNote ? `
                <div style="font-size:11px;margin-top:8px;padding:8px;background:var(--bg);border-radius:6px;color:var(--dim);border-left:2px solid var(--warning)">
                    ${shot.storyboardNote}
                </div>
                ` : ''}
            </div>
            
            <!-- üé• ÈÅãÈè°AgentÔºöÊîùÂΩ± -->
            <div class="agent-output" style="background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:8px;padding:12px;margin:8px 0">
                <div style="font-size:10px;color:var(--text);font-weight:600;margin-bottom:8px">üé• ÈÅãÈè°Agent | ÊîùÂΩ±</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;margin-bottom:8px">
                    <span><strong>ÊôØÂà•Ôºö</strong>${shot.camera.frameSize || 'MS'}</span>
                    <span><strong>Èè°È†≠Ôºö</strong>${shot.camera.lens || '50mm'}</span>
                </div>
                <div style="font-size:12px;margin-bottom:8px">
                    <strong>ÈÅãÈè°Ôºö</strong>${shot.camera.movement || 'Âõ∫ÂÆö'}
                </div>
                <div style="font-size:11px;padding:8px;background:var(--bg);border-radius:6px;color:var(--dim)">
                    <strong>üìê ÊßãÂúñÔºö</strong>${shot.camera.composition || '‰∏âÂàÜÊ≥ïÔºå‰∏ªÈ´î‰ΩçÊñºÂè≥ÂÅ¥‰∫§Èªû'}
                    ${shot.camera.depthOfField ? `<br><strong>üîç ÊôØÊ∑±Ôºö</strong>${shot.camera.depthOfField}` : ''}
                    ${shot.camera.equipment ? `<br><strong>üé¨ Ë®≠ÂÇôÔºö</strong>${shot.camera.equipment}` : ''}
                </div>
            </div>
            
            <!-- 2Ô∏è‚É£ ‰∏ªÈ´îAgentÔºöËßíËâ≤ -->
            <div class="agent-output" style="background:rgba(128,128,128,.1);border:1px solid rgba(128,128,128,.3);border-radius:8px;padding:12px;margin:8px 0">
                <div style="font-size:10px;color:var(--dim);font-weight:600;margin-bottom:8px">2Ô∏è‚É£ ‰∏ªÈ´îAgent | ËßíËâ≤</div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span class="subject-type ${shot.subject.type}">${subjectType.icon} ${subjectType.label}</span>
                    <span style="font-weight:600">${shot.subject.name}</span>
                </div>
                ${shot.subject.type !== 'none' ? `
                    <div style="font-size:12px;color:var(--dim)">
                        <p style="margin-bottom:8px"><strong>Âãï‰ΩúÔºö</strong>${shot.subject.action}</p>
                        ${shot.subject.expression ? `<p style="margin-bottom:8px"><strong>Ë°®ÊÉÖÔºö</strong>${shot.subject.expression}</p>` : ''}
                        ${shot.subject.costume ? `<p style="margin-bottom:8px"><strong>ÊúçË£ùÔºö</strong>${shot.subject.costume}</p>` : ''}
                        <p><strong>ÈÅãÈè°Ôºö</strong>${shot.camera.movement}</p>
                    </div>
                ` : `<p style="font-size:12px;color:var(--dim)"><strong>ÂÖßÂÆπÔºö</strong>${shot.subject.action || 'Á©∫Èè°È†≠ÔºåÁí∞Â¢ÉÊèèÂØ´'}</p>`}
                ${shot.subject.dialogue ? `
                    <div style="background:var(--surface);padding:10px;border-radius:6px;margin-top:8px;border-left:3px solid var(--primary)">
                        <div style="font-size:10px;color:var(--dim);margin-bottom:4px">üí¨ ${shot.subject.name} | ${shot.subject.tone}</div>
                        <div style="font-style:italic">"${shot.subject.dialogue}"</div>
                    </div>
                ` : ''}
            </div>
            
            <!-- 3Ô∏è‚É£ Â†¥ÊôØAgentÔºöÁæéË°ì -->
            <div class="agent-output" style="background:rgba(128,128,128,.1);border:1px solid rgba(128,128,128,.3);border-radius:8px;padding:12px;margin:8px 0">
                <div style="font-size:10px;color:var(--dim);font-weight:600;margin-bottom:8px">3Ô∏è‚É£ Â†¥ÊôØAgent | ÁæéË°ì</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;margin-bottom:8px">
                    <span><strong>Âú∞ÈªûÔºö</strong>${shot.scene.location}</span>
                    <span><strong>ÊôÇÈñìÔºö</strong>${shot.scene.time}</span>
                </div>
                <div style="font-size:11px;margin-bottom:8px;padding:8px;background:var(--bg);border-radius:6px">
                    <p style="margin:0 0 4px"><strong style="color:var(--dim)">üé® Ëâ≤Ë™øÔºö</strong>${shot.scene.colorTone}</p>
                    <p style="margin:0"><strong style="color:var(--dim)">üí° ÁáàÂÖâÔºö</strong>${shot.scene.lighting}</p>
                </div>
                <div style="font-size:12px;color:var(--dim);margin-bottom:8px">
                    <strong>Ê∞õÂúçÔºö</strong>${shot.scene.atmosphere || 'Á•ûÁßòÁ∑äÂºµ'}
                </div>
                <div style="font-size:11px;color:var(--dim);padding:8px;background:var(--surface);border-radius:6px">
                    <strong>üé¨ ÈÅìÂÖ∑Ê∏ÖÂñÆÔºö</strong><br>${shot.scene.props || 'È¶ôÁàê„ÄÅÁá≠Âè∞„ÄÅÈäÄÈèà'}
                </div>
            </div>
            
            <!-- 4Ô∏è‚É£ Èü≥Ê®ÇAgentÔºöËÅ≤Èü≥ -->
            <div class="agent-output" style="background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:8px;padding:12px;margin:8px 0">
                <div style="font-size:10px;color:var(--primary);font-weight:600;margin-bottom:8px">4Ô∏è‚É£ Èü≥Ê®ÇAgent | ËÅ≤Èü≥</div>
                <div style="font-size:12px;color:var(--dim)">
                    <p><strong>ÈÖçÊ®ÇÔºö</strong>${shot.audio?.music || 'Êá∏ÁñëÊ∞õÂúçÔºå‰ΩéÊ≤âÂº¶Ê®Ç'}</p>
                    <p><strong>Èü≥ÊïàÔºö</strong>${shot.audio?.sfx || 'È¶ôÁá≠ÁáÉÁáíËÅ≤'}</p>
                    <p><strong>Áí∞Â¢ÉÈü≥Ôºö</strong>${shot.audio?.ambient || 'ÈÅ†ËôïÂ∏ÇÈõÜÂñßÂõÇ'}</p>
                </div>
            </div>
            
            <!-- üñºÔ∏è ÊúÄÁµÇPrompt -->
            <div class="prompt-box">
                <div class="prompt-label">üñºÔ∏è Á∂úÂêàPromptÔºàÂ†¥ÊôØ+‰∏ªÈ´îÔºâ</div>
                ${shot.prompt.mj}
            </div>
        </div>
    `;
}

// generateStoryboard removed - now using Claude integration
function generateStoryboard_legacy(){
    const shots = [];
    const shotTypes = ['narrative', 'narrative', 'dramatic', 'narrative', 'emotional'];
    
    // ÁîüÊàêÁ§∫‰æãÂàÜÈè°ÔºàÂ∞àÊ•≠ÈõªÂΩ±ÂàÜÈè°Ê†ºÂºèÔºâ
    // ÂèÉËÄÉSkills: cinematography_composition, cinematography_shots, directing_blocking
    const sampleShots = [
        {
            scene: {
                location:'ËåÖËçâÊ£öÂÖß', 
                time:'Â§ú', 
                colorTone:'ÊöñÈªÉÁá≠ÂÖâ(CTO+1/2) + Á≤âÁ¥ÖÂØ∂Áü≥ÂÖâ(ÂìÅÁ¥ÖÊøæËâ≤)', 
                lighting:'‰∏ªÂÖâÔºöÁá≠ÂÖâÂÅ¥ÂÖâ45¬∞ / ËºîÂÖâÔºöÂØ∂Áü≥Â∫ïÂÖâ / Ê∞õÂúçÔºöÁÖôÈúßÊï£Â∞Ñ',
                atmosphere:'Á•ûÁßòÁ∑äÂºµÔºåÁ©∫Ê∞£‰∏≠ÁÄ∞Êº´È¶ôÊñôËàáÊÅêÊáºÁöÑÂë≥ÈÅì', 
                props:'ÈäÖÈ¶ôÁàê(ÊåÅÁ∫åÂÜíÁÖô)„ÄÅÁâõÊ≤πË†üÁá≠√ó3„ÄÅËçâÁ∑®ËìÜÂ¢ä„ÄÅÁ´πÁ∞æÈñÄ„ÄÅÈ™®Ë£ΩÂç†ÂçúÂô®ÂÖ∑„ÄÅ‰πæÁá•ËçâËó•Êùü„ÄÅÁ¨¶Á¥ô(ÁâÜ‰∏ä)'
            },
            subject: {
                type:'person', 
                name:'Â∞èÁå¥Â≠ê', 
                action:'Ëú∑Á∏ÆÂú®ÊàøÊ¢ÅÈô∞ÂΩ±ËôïÔºåË∫´È´îÁ∑äË≤ºÊú®Ê®ëÔºåÈõôËÖøÂ§æÁ∑äÔºåÂè≥ÊâãÂ∑≤Ê∫ñÂÇôÂ•ΩÊäìÊè°Áπ©Á¥¢ÔºåÂ∑¶ÊâãËºïÊâ∂Êú®È†≠‰øùÊåÅÂπ≥Ë°°ÔºåÈ†≠ÈÉ®ÂæÆÂÇæ15Â∫¶‰øØË¶ñ‰∏ãÊñπ',
                expression:'Â∞àÊ≥®Á∑äÂºµ‚Äî‚ÄîÁúâÈ†≠ÂæÆÁö∫„ÄÅÁúºÁùõÁû™Â§ßÈä≥Âà©„ÄÅÂò¥ÂîáÁ∑äÊäø„ÄÅÈºªÁøºÂæÆÂºµÔºàÊéßÂà∂ÂëºÂê∏Ôºâ„ÄÅÈ°çÈ†≠ÊúâÁ¥∞Ê±ó',
                dialogue:null, 
                tone:null,
                costume:'Á†¥ËàäÈ∫ªÂ∏ÉÁü≠Ë°´(ÂúüË§êËâ≤)„ÄÅÊùüËÖ≥Ë§≤„ÄÅËµ§ËÖ≥„ÄÅËÖ∞ÈñìÁπ´ËëóÂÅ∑‰æÜÁöÑÂ∞èÂ∏ÉË¢ã'
            },
            camera: {angle:'‰øØÊãç30¬∞', movement:'Á∑©ÊÖ¢Êé®ÈÄ≤(2ÁßíÂÖßÂæû‰∏≠ÊôØÊé®Ëá≥ËøëÊôØ)', frameSize:'MS‚ÜíCU', lens:'50mmÊ®ôÊ∫ñÈè°È†≠', composition:'Â∞çËßíÁ∑öÊßãÂúñÔºåÂ∞èÁå¥Â≠ê‰ΩçÊñºÂè≥‰∏ä‰∏âÂàÜÈªûÔºåÂç†ÂçúÂ†¥ÊôØÂú®Â∑¶‰∏ã', depthOfField:'‰∏≠Á≠âÊôØÊ∑±Ôºå‰∏ªÈ´îÊ∏ÖÊô∞ÔºåËÉåÊôØËºïÂæÆËôõÂåñ', equipment:'ËªåÈÅìËªä+Â∞èÂûãÊêñËáÇ'},
            audio: {music:'Êá∏ÁñëÂº¶Ê®ÇtremoloÔºå‰ΩéÈ†ªÊº∏Âº∑', sfx:'Êú®Ê¢ÅËºïÂæÆÂê±ÂëÄËÅ≤„ÄÅÂ∞èÁå¥Â≠êÂÖãÂà∂ÁöÑÂëºÂê∏ËÅ≤', ambient:'ÈÅ†ËôïËü≤È≥¥„ÄÅÁá≠ÁÅ´ËºïÂæÆÁàÜË£ÇËÅ≤'},
            narrativeFunction:'Âª∫Á´ã‰∏ªËßíPOVÈ´òÂ∫¶Ë¶ñËßíÔºåÂº∑Ë™øÂÖ∂‰ΩúÁÇ∫"ÁçµÊâã"ÁöÑËßÄÂØü‰ΩçÁΩÆÔºåË£ΩÈÄ†"Âç≥Â∞áË°åÂãï"ÁöÑÊá∏ÂøµÂºµÂäõ',
            shotType: 'dramatic',
            storyboardNote:'„ÄêÊßãÂúñ„Äë‰ΩøÁî®Â∞çËßíÁ∑öÊßãÂúñÔºåÂ∞èÁå¥Â≠ê‰ΩçÊñºÁï´Èù¢Âè≥‰∏äÊñπ‰∏âÂàÜÈªûÔºåÂç†ÂçúÂ†¥ÊôØÂú®Â∑¶‰∏ãÊñπÔºåÂΩ¢ÊàêË¶ñÁ∑öÂºïÂ∞é'
        },
        {
            scene: {
                location:'ËåÖËçâÊ£öÂÖß', 
                time:'Â§ú', 
                colorTone:'ÊöñÈªÉ+Á≤âÁ¥Ö‰∏ªÂ∞éÔºåÈô∞ÂΩ±ÂçÄÈùíËóçË£úËâ≤', 
                lighting:'ÂØ¶ÊôØÂÖâÊ∫êÔºöË†üÁá≠Â∫ïÂÖâÊâì‰∫ÆÈù¢ÈÉ® / ÂØ∂Áü≥ÁôºÂá∫ÁöÑÁ≤âÁ¥ÖÂÖâ‰ΩúÁÇ∫ÁúºÁ•ûÂÖâ',
                atmosphere:'Ë©≠Áï∞Á•ûÁßòÔºåÊôÇÈñìÂΩ∑ÂΩøÈùúÊ≠¢', 
                props:'ÈäÄÈèà(Á¥∞ÁØÄÂèØË¶ãËä±Á¥ã)„ÄÅÁ≤âÁ¥ÖÂØ∂Áü≥(ÂçäÈÄèÊòéÔºåÂÖßÊúâÂÖâÊöà)„ÄÅÈäÖÈ¶ôÁàêÈ¶ôÁÖôÂçáËµ∑„ÄÅÁ¥´Ëâ≤Áµ≤Áµ®Â¢ä„ÄÅÊï£ËêΩÁöÑÈäÖÈå¢'
            },
            subject: {
                type:'person', 
                name:'ÂçúÂ§¢Â∏´', 
                action:'Áõ§ËÖøÁ´ØÂùêÔºåËÑäËÉåÊå∫Áõ¥ÔºåÂè≥ÊâãÊåÅÈäÄÈèàÊú´Á´ØÔºåËÆìÂØ∂Áü≥Êá∏Á©∫ÊñºÁúºÂâçÈ´òÂ∫¶ÔºåÂ∑¶ÊâãÁµêÂç∞ÁΩÆÊñºËÜù‰∏äÔºåË∫´È´îËºïÂæÆÂâçÂæåÊêñÊôÉÂ¶ÇÂÖ•ÂÆö',
                expression:'Á•ûÁßòËé´Ê∏¨‚Äî‚ÄîÈù¢Á¥óÈÅÆ‰ΩèÂè£ÈºªÔºåÂè™Èú≤Ê∑°Ë§êËâ≤ÁúºÁú∏ÔºåÁû≥Â≠îÂæÆÁ∏ÆÂèçÂ∞ÑÂØ∂Áü≥ÂÖâËäíÔºåÁúºÂ∞æÊúâÁ¥∞Á¥ãÊöóÁ§∫Âπ¥ÈΩ°ÔºåÁúºÁ•ûÊ∑±ÈÇÉÂ¶ÇÂè§‰∫ï',
                dialogue:'‰Ω†ÁöÑÂëΩÈÅã...Â∑≤Ë¢´ÁúãË¶ã...', 
                tone:'‰ΩéÊ≤âÁ•ûÁßòÔºåË™ûÈÄüÁ∑©ÊÖ¢ÔºåÊØèÂÄãÂ≠ó‰πãÈñìÊúâÊòéÈ°ØÂÅúÈ†ìÔºåÂΩ∑ÂΩøÂæûÂæàÈÅ†ÁöÑÂú∞ÊñπÂÇ≥‰æÜ',
                costume:'Ê∑±Á¥´Ëâ≤ÂØ¨Ë¢ç(Áï∞ÂüüÈ¢®Ê†º)„ÄÅÈù¢Á¥ó(ÈªëËâ≤ËñÑÁ¥ó)„ÄÅÈäÄË≥™ÊâãÈê≤√ó2„ÄÅÈ°çÈñìÊúâÁ•ûÁßòÂç∞Ë®ò'
            },
            camera: {angle:'Âπ≥Ë¶ñ‰∏≠ÊôØ', movement:'Âõ∫ÂÆöÊ©ü‰ΩçÔºåËºïÂæÆÂëºÂê∏ÊÑüÊôÉÂãï', frameSize:'MS', lens:'85mm‰∫∫ÂÉèÈè°È†≠ÔºåÊ∑∫ÊôØÊ∑±', composition:'‰∏≠ÂøÉÊßãÂúñÔºåÂçúÂ§¢Â∏´‰ΩîÊìöÁï´Èù¢‰∏≠Â§ÆÔºåÂ∞çÁ®±ÊÑüÁáüÈÄ†Á•ûÁßò', depthOfField:'Ê∑∫ÊôØÊ∑±f2.0ÔºåÂè™ÊúâÈù¢ÈÉ®ÂíåÂØ∂Áü≥Ê∏ÖÊô∞', equipment:'‰∏âËÖ≥Êû∂+Èò≤ÈúáÂ¢ä'},
            audio: {music:'Á•ûÁßòÂêüÂî±(Áï∞ÂüüÈü≥Èöé)ÔºåÁêµÁê∂ÂñÆÈü≥ÈªûÁ∂¥', sfx:'ÂØ∂Áü≥ÁôºÂá∫‰ΩéÈ†ªÂó°È≥¥(Êº∏Âº∑)„ÄÅÈäÄÈèàËºïÂæÆÊôÉÂãïËÅ≤', ambient:'È¶ôÁÖôÁπöÁπûÁöÑÁÑ°ËÅ≤ÊÑü'},
            narrativeFunction:'Ê≠£Âºè‰ªãÁ¥πÂçúÂ§¢Â∏´ËßíËâ≤ÔºåÂª∫Á´ãÂÖ∂Á•ûÁßòÊ¨äÂ®ÅÊÑüÔºåÈÄöÈÅéÂ∞çË©±Êè≠Á§∫Âç†ÂçúË°åÁÇ∫',
            shotType: 'narrative',
            storyboardNote:'„ÄêË°®ÊºîÈáçÈªû„ÄëÁúºÁ•ûÊòØÂîØ‰∏ÄË°®ÊÉÖÂá∫Âè£ÔºåÈúÄË¶ÅÂÇ≥ÈÅî"ÁúãË¶ã‰∫Ü‰∏çË©≤ÁúãË¶ãÁöÑÊù±Ë•ø"ÁöÑË§áÈõúÊÉÖÁ∑í'
        },
        {
            scene: {
                location:'ËåÖËçâÊ£öÂÖß', 
                time:'Â§ú', 
                colorTone:'Á≤âÁ¥ÖÁÇ∫ÁµïÂ∞ç‰∏ªÂ∞éÔºåÈ´òÂÖâËôïËøëÁôΩÔºåÊöóÈÉ®Ê∑±Á¥´', 
                lighting:'ÂØ∂Áü≥Ëá™ÁôºÂÖâ‰ΩúÁÇ∫ÂîØ‰∏ÄÂÖâÊ∫êÔºåÂâµÈÄ†ÂÖâÊöàÊïàÊûú',
                atmosphere:'Ë∂ÖËá™ÁÑ∂„ÄÅÁ•ûËÅñ„ÄÅÂç±Èö™‰∏¶Â≠ò', 
                props:'Á≤âÁ¥ÖÂØ∂Áü≥(Èè°È†≠ÂÖßÂîØ‰∏ÄÊ∏ÖÊô∞Áâ©È´î)„ÄÅÈäÄÈèàËôõÂåñ„ÄÅËÉåÊôØÂÆåÂÖ®Â§±ÁÑ¶'
            },
            subject: {
                type:'object', 
                name:'Á≤âÁ¥ÖÂØ∂Áü≥', 
                action:'Êá∏Á©∫ËºïÂæÆÊóãËΩâ(ÊØèÁßí5Â∫¶)ÔºåÂÖâËäíÂæûÂÖßÈÉ®ËÑàÂãïËà¨ÊòéÊªÖÔºåÊØèÊ¨°Êòé‰∫ÆÊôÇÂèØË¶ãÂÖßÈÉ®ÊúâÈõ≤ÈúßÁãÄÊµÅÂãï',
                expression:null, 
                dialogue:null, 
                tone:null
            },
            camera: {angle:'ÁâπÂØ´ECU', movement:'Ê•µÁ∑©ÊÖ¢360Â∫¶Áí∞Áπû(15Áßí‰∏ÄÂúà)', frameSize:'ECU', lens:'100mmÂæÆË∑ùÈè°È†≠Ôºåf2.8', composition:'ÊªøÊßãÂúñÔºåÂØ∂Áü≥Â°´ÊªøÁï´Èù¢ÔºåÁÑ°Ë≤†Á©∫Èñì', depthOfField:'Ê•µÊ∑∫ÊôØÊ∑±ÔºåÂÉÖÂØ∂Áü≥Ë°®Èù¢ÊúÄÈ´òÈªûÊ∏ÖÊô∞', equipment:'ÈõªÂãïÁí∞ÂΩ¢ËªåÈÅì+ÂæÆË∑ùÈõ≤Âè∞'},
            audio: {music:'Á©∫ÈùàÂ•≥ËÅ≤ÂìºÂî±ÂñÆÈü≥ÔºåÁÑ°Ê≠åË©ûÔºåÊåÅÁ∫åÂçáË™ø', sfx:'Ê∞¥Êô∂ÊåØÂãïËÅ≤+ÂøÉË∑≥Ëà¨ÁöÑ‰ΩéÈ†ªËÑàÂãï', ambient:'ÂÆåÂÖ®ÈùúÈü≥Âº∑Ë™ø'},
            narrativeFunction:'Ê†∏ÂøÉÈÅìÂÖ∑ÁâπÂØ´‚Äî‚ÄîÈÄôÊòØÊï¥ÈÉ®‰ΩúÂìÅÁöÑMacGuffinÔºåÈúÄË¶ÅËÆìËßÄÁúæË®ò‰Ωè‰∏¶Áî¢ÁîüÂ•ΩÂ•á',
            shotType: 'emotional',
            storyboardNote:'„ÄêË¶ñË¶∫ÁâπÊïà„ÄëÂØ∂Áü≥ÂÖßÈÉ®ÈúÄË¶ÅÂæåÊúüÊ∑ªÂä†ÊµÅÂãïÂÖâÊïàÔºåÂèÉËÄÉ„ÄäÈ≠îÊàí„ÄãËá≥Â∞äÊàíÁöÑË≥™ÊÑü'
        },
        {
            scene: {
                location:'ËïÉÂùäË°óÈÅì', 
                time:'ÈªÉÊòè(magic hour)', 
                colorTone:'ÈáëÈªÉÊöñËâ≤‰∏ªË™ø(Ëâ≤Ê∫´3200K)ÔºåÈÄÜÂÖâËôïÊúâÂìÅÁ¥ÖÈÇäÁ∑£ÂÖâ', 
                lighting:'Ëá™ÁÑ∂ÂÖâÔºöÂ§ïÈôΩ45Â∫¶ÂÅ¥ÈÄÜÂÖâ / Ë£úÂÖâÔºöÂ∫óÈã™ÁáàÁ±†Êï£Â∞Ñ',
                atmosphere:'ÁπÅËèØÁÜ±È¨ßÔºåÂ§öÂÖÉÊñáÂåñ‰∫§ÂåØÁöÑÁîüÂëΩÂäõ', 
                props:'Ê≥¢ÊñØÂú∞ÊØØÊî§„ÄÅÈ¶ôÊñôÈ∫ªË¢ã(Á¥ÖÈªÉÁ∂†ÂêÑËâ≤Á≤âÊú´)„ÄÅÈäÖÂô®Â∫ó„ÄÅÁµ≤Á∂¢Â∏ÉÂåπ„ÄÅÈ®æÈ¶¨„ÄÅËΩéÂ≠ê„ÄÅÂêÑÂúãÊóóÂπüÊãõÁâå„ÄÅÁì∑Âô®„ÄÅÊ∞¥ÊûúÁ≠ê„ÄÅÈäÖÁß§„ÄÅÈ∏öÈµ°Á±†'
            },
            subject: {
                type:'crowd', 
                name:'ËïÉÂùäÂïÜË≤©ËàáÈÅéÂÆ¢', 
                action:'Â§öÂ±§Ê¨°ÂãïÊÖã‚Äî‚ÄîÂâçÊôØÔºöÊ≥¢ÊñØÂïÜ‰∫∫ËàáÂîê‰∫∫Ë®éÂÉπÈÇÑÂÉπÔºõ‰∏≠ÊôØÔºöÈßùÈöäÁ∑©ÊÖ¢ÈÄöÈÅéÔºõÂæåÊôØÔºöÂ≠©Á´•ËøΩÈÄêÂ¨âÊà≤ÔºõÊî§Ë≤©Âè´Ë≥£ÂêÜÂñùÊâãËàûË∂≥Ëπà',
                expression:'ÂøôÁ¢åÁÜ±È¨ßÔºåÊØèÂÄã‰∫∫ÈÉΩÊúâËá™Â∑±ÁöÑÁõÆÁöÑÂíåÊïÖ‰∫ã', 
                dialogue:null, 
                tone:null,
                costume:'Â§öÂÖÉÊ∑∑Êê≠‚Äî‚ÄîÂîê‰∫∫ÂúìÈ†òË¢ç„ÄÅÊ≥¢ÊñØÈï∑Ë¢ç+È†≠Â∑æ„ÄÅÂ§©Á´∫Á¥óÈ∫ó„ÄÅÂ§ßÈ£üÂïÜ‰∫∫ÁôΩË¢ç'
            },
            camera: {angle:'È´òÊ©ü‰ΩçÂ§ßÂÖ®ÊôØ(ÂçáÈôçÊ©ü)', movement:'Á∑©ÊÖ¢‰∏ãÈôç+ÂæÆÊé®(ÂæûÈ≥•Áû∞Âà∞Âπ≥Ë¶ñÔºå8Áßí)', frameSize:'ELS‚ÜíLS', lens:'24mmÂª£Ëßí', composition:'‰øØÁû∞ÂÖ®ÊôØÔºåË°óÈÅìÂëàSÂûãÂºïÂ∞éÁ∑öÔºå‰∫∫ÊµÅÂΩ¢ÊàêÂãïÊÖãÁ¥ãÁêÜ', depthOfField:'Ê∑±ÊôØÊ∑±f11ÔºåÂâç‰∏≠ÂæåÊôØÂÖ®ÈÉ®Ê∏ÖÊô∞', equipment:'15Á±≥ÊêñËáÇ/ÁÑ°‰∫∫Ê©ü'},
            audio: {music:'Áï∞ÂüüÈ¢®ÊÉÖÈÖçÊ®ÇÔºåÂΩàÊí•Ê®Ç+ÊâãÈºìÔºåÁÜ±È¨ßÊ≠°Âø´', sfx:'Â∏ÇÈõÜÂñßÂõÇ„ÄÅÂ§öË™ûË®ÄÂè´Ë≥£ËÅ≤(Ê≥¢ÊñØË™û/ÈòøÊãâ‰ºØË™û/ÂîêË™ûÊ∑∑Èõú)„ÄÅÈáëÂ±¨Á¢∞ÊíûËÅ≤', ambient:'ÈßùÈà¥ËÅ≤„ÄÅÈ¶¨ËπÑËÅ≤„ÄÅÈÅ†ËôïÂØ∫ÂªüÈêòËÅ≤'},
            narrativeFunction:'Âª∫Á´ã‰∏ñÁïåËßÄÁöÑÈóúÈçµÈè°È†≠‚Äî‚ÄîÂ±ïÁ§∫Âîê‰ª£Âª£Â∑ûËïÉÂùäÁöÑÂ§öÂÖÉÁπÅËèØÔºåËÆìËßÄÁúæÊ≤âÊµ∏Âú®ÈÄôÂÄãÊôÇ‰ª£',
            shotType: 'narrative',
            storyboardNote:'„ÄêÂèÉËÄÉ„Äë„ÄäÈï∑ÂÆâÂçÅ‰∫åÊôÇËæ∞„ÄãÈñãÂ†¥Èï∑Èè°È†≠ / ÈúÄË¶ÅÂ§ßÈáèÁæ§ÊºîÂíåÈÅìÂÖ∑È†êÁÆó'
        },
        {
            scene: {
                location:'ËïÉÂùäË°óÈÅì', 
                time:'ÈªÉÊòè', 
                colorTone:'ÈáëÈªÉ‰∏ªË™ø+ÈÅãÂãïÊ®°Á≥ä', 
                lighting:'Â§ïÈôΩÂº∑ÈÄÜÂÖâÔºå‰∏ªÈ´îËº™ÂªìÂÖâÔºåÊ≠£Èù¢Ê¨†Êõù',
                atmosphere:'Á∑äÂºµËøΩÈÄêÔºåËÖé‰∏äËÖ∫Á¥†È£ÜÂçá', 
                props:'Ë¢´ÊíûÁøªÁöÑÈ¶ôÊñôÊî§(Á≤âÊú´È£õÊèö)„ÄÅÊªæËêΩÁöÑÊ∞¥Êûú„ÄÅÈ©öÊÖåÁöÑË∑Ø‰∫∫„ÄÅÈ£õËµ∑ÁöÑÂ∏ÉÂåπ'
            },
            subject: {
                type:'person', 
                name:'Â∞èÁå¥Â≠ê', 
                action:'ÂÖ®ÂäõÂ•îË∑ë‚Äî‚Äî‰ΩéÈáçÂøÉ„ÄÅÊâãËáÇÂ§ßÂπÖÊì∫Âãï„ÄÅÂæûË≤®ËªäÂ∫ïÁ©øÈÅéÊôÇ‰∏ÄÂÄãÂÅ¥ÊªæÁøª„ÄÅÊíûÁøªÈ¶ôÊñôÊî§‰ΩÜ‰∏çÂõûÈ†≠„ÄÅ‰∏ÄË∫çÊäì‰ΩèÊ©´Ê®ëÁøª‰∏äÂ±ãÈ†Ç',
                expression:'Á∑äÂºµ‰ΩÜËá™‰ø°‚Äî‚ÄîÂí¨Á∑äÁâôÈóú„ÄÅÁúºÁùõÂ∞àÊ≥®ÂâçÊñπÂ∞ãÊâæÈÄÉË∑ëË∑ØÁ∑ö„ÄÅÂò¥ËßíÊúâ‰∏ÄÁµ≤ËààÂ•ÆÁöÑÁ¨ëÊÑè',
                dialogue:null, 
                tone:null,
                costume:'ÂêåÂâçÔºå‰ΩÜË°£Ë°´Âõ†Â•îË∑ëËÄåÊï£‰∫ÇÔºåËáâ‰∏äÊ≤æ‰∫ÜÈ¶ôÊñôÁ≤â'
            },
            camera: {angle:'Ë∑üÊãç+‰ª∞Êãç‰∫§Êõø', movement:'ÊâãÊåÅË∑üÈö®(Ë∑ëÂãïÊÑü)„ÄÅÁøª‰∏äÂ±ãÈ†ÇÊôÇÂàá‰ª∞Êãç', frameSize:'MS‚ÜíLS', lens:'35mmÔºåÂø´ÈñÄ1/60Ë£ΩÈÄ†ÂãïÊÖãÊ®°Á≥ä', composition:'ÂãïÊÖãÊßãÂúñÔºå‰∏ªÈ´îÂÅèÂêëÈÅãÂãïÊñπÂêëÔºåÁïôÂá∫ÂâçÈÄ≤Á©∫Èñì', depthOfField:'‰∏≠Á≠âÊôØÊ∑±ÔºåÈÅãÂãïÊ®°Á≥äÂº∑Ë™øÈÄüÂ∫¶ÊÑü', equipment:'Á©©ÂÆöÂô®Ronin+Ë∑üÁÑ¶Âì°'},
            audio: {music:'ÁØÄÂ•èÂä†Âø´(120BPM‰ª•‰∏ä)ÔºåÊâìÊìäÊ®Ç‰∏ªÂ∞éÔºåÂº¶Ê®ÇÁ∑äÂºµÊé®ÈÄ≤', sfx:'ÊÄ•‰øÉËÖ≥Ê≠•ËÅ≤„ÄÅÁ¢∞ÊíûËÅ≤„ÄÅÈ¶ôÊñôË¢ãÁ†¥Ë£ÇËÅ≤„ÄÅË∑Ø‰∫∫È©öÂëº', ambient:'Êº∏Âº±(ËÅ≤Èü≥‰∏ªËßÄÂåñ)'},
            narrativeFunction:'ËøΩÈÄêÂãï‰ΩúÊà≤‚Äî‚ÄîÂ±ïÁ§∫‰∏ªËßíÊïèÊç∑Ë∫´ÊâãÔºåÂª∫Á´ãÂÖ∂‰ΩúÁÇ∫"Á•ûÂÅ∑"ÁöÑÂèØ‰ø°Â∫¶ÔºåÂêåÊôÇÂ¢ûÂä†Â®õÊ®ÇÊÄß',
            shotType: 'dramatic',
            storyboardNote:'„ÄêÂãï‰ΩúË®≠Ë®à„ÄëÈúÄË¶ÅÂàÜÈè°È†êÊºîÔºåÂèÉËÄÉÊàêÈæçÊó©ÊúüÂãï‰ΩúÁâáÁöÑÂüéÂ∏ÇËøΩÈÄêÊÆµËêΩ'
        },
        {
            scene: {
                location:'Ê¶ïÊ®π‰∏ã', 
                time:'Â§ú', 
                colorTone:'ËóçÁ∂†ÂÜ∑Ëâ≤Ë™ø(ÊúàÂÖâËâ≤Ê∫´8000K)ÔºåÊ®πËëâÈñìÈöôÈÄèÂá∫ÊöñÈªÉ(ÈÅ†ËôïÁáàÁÅ´)', 
                lighting:'È†ÇÂÖâÔºöÊúàÂÖâÈÄèÈÅéÊ®πËëâÁöÑÊñëÈßÅÂÖâÂΩ± / ÂæÆÂº±ËºîÂÖâÔºöËû¢ÁÅ´Ëü≤',
                atmosphere:'Á•ûÁßòÂºïÂ∞éÔºåÊôÇÈñì‰ºº‰πéÈùúÊ≠¢Âú®ÈÄô‰∏ÄÂàª', 
                props:'ÁôæÂπ¥ËÄÅÊ¶ïÊ®π(Ê∞£Ê†πÂ¶ÇÁÄëÂ∏É)„ÄÅÈùíÁü≥ÊùøÂá≥(Á£®ÊêçÁôº‰∫Æ)„ÄÅÁ†¥ËàäËçâËìÜ„ÄÅÁ´πË£ΩÁõ≤Êùñ„ÄÅÂúüÈô∂Ëå∂Â£∫„ÄÅËí≤Êâá'
            },
            subject: {
                type:'person', 
                name:'Á¥ÖÈ´ÆÁõ≤ËÄÅ‰∫∫', 
                action:'Áõ§ÂùêÂú®Áü≥Âá≥‰∏äÔºåÊûØÁò¶ÁöÑË∫´ËªÄÂçªÊúâ‰∏ÄÁ®ÆÊ≤âÁ©©ÁöÑÂäõÈáèÊÑüÔºåÈ†≠ÂæÆÂæÆ‰ª∞Ëµ∑"Áúã"ÂêëÂ§úÁ©∫ÔºåÊâãÊåáÁÑ°ÊÑèË≠òÂú∞ËºïÊí´Áõ≤Êùñ',
                expression:'Ê∑±ÈÇÉÊô∫ÊÖß‚Äî‚ÄîÈõñÁÑ∂ÈõôÁõÆÂ§±Êòé(Áû≥Â≠îÊ≥õÁôΩ)Ôºå‰ΩÜÈù¢ÈÉ®Ë°®ÊÉÖÂçªÂÉèÊòØÁúãË¶ã‰∫Ü‰∏ÄÂàáÔºåÂò¥ËßíÂ∏∂ËëóÊÑèÂë≥Ê∑±Èï∑ÁöÑÂæÆÁ¨ë',
                dialogue:'Âú®Êµ∑ÁöÑÈÇ£‰∏ÄÈÇä...Êúâ‰∏ÄÂ∫ßÂ±±...Â±±ÁöÑÈ†Ç‰∏ä...Êúâ‰∏ÄÊâáÈñÄ...', 
                tone:'ËíºËÄÅÁ•ûÁßòÔºåË™ûÈÄüÊ•µÊÖ¢ÔºåÊØèÂè•Ë©±‰πãÈñìÊúâÊ∑±Ê≤âÁöÑÂÅúÈ†ìÔºåÂΩ∑ÂΩøÂú®ÂõûÊÜ∂Âæà‰πÖ‰ª•ÂâçÁöÑ‰∫ã',
                costume:'Ë§™Ëâ≤ÁÅ∞Ë¢ç(ÊõæÁ∂ìËèØË≤¥)„ÄÅÈú≤Âá∫ÁöÑÁ¥ÖÈ´ÆÂú®ÊúàÂÖâ‰∏ãÂ¶ÇÁÜîÂ≤©„ÄÅÁò¶È™®Â∂ôÂ≥ãÁöÑÊâãËÖïÂ∏∂ËëóË§™Ëâ≤ÁöÑÁπ©Áµê'
            },
            camera: {angle:'Âπ≥Ë¶ñ‰∏≠ËøëÊôØ+Á∑©ÊÖ¢Êé®ÈÄ≤', movement:'Âõ∫ÂÆöÊ©ü‰ΩçÔºåÊ•µÁ∑©ÊÖ¢Êé®ÈÄ≤(10ÁßíÂæûMSÂà∞MCU)', frameSize:'MS‚ÜíMCU', lens:'85mm f1.4ÔºåÂ§ßÂÖâÂúà', composition:'Ê°Ü‰∏≠Ê°ÜÊßãÂúñÔºåÊ¶ïÊ®πÊ∞£Ê†π‰ΩúÁÇ∫Ëá™ÁÑ∂Áï´Ê°ÜÂåÖÂúçËÄÅ‰∫∫', depthOfField:'Ê•µÊ∑∫ÊôØÊ∑±ÔºåËÄÅ‰∫∫Ê∏ÖÊô∞ÔºåÊ®πËëâÂÖâÊñëÂΩ¢ÊàêÁæéÈ∫óÊï£ÊôØ', equipment:'ÈõªÂãïÊªëËªå+Ë∑üÁÑ¶Âô®'},
            audio: {music:'Âè§ÁÆèÁç®Â•èÔºå‰∫îËÅ≤Èü≥ÈöéÔºåÊÇ†ÈÅ†Á©∫Èùà', sfx:'Ê®πËëâÊ≤ôÊ≤ôËÅ≤„ÄÅÈÅ†ËôïÁãóÂê†„ÄÅÊ∞£Ê†πËºïÊì∫ËÅ≤', ambient:'ËõôÈ≥¥Ëü≤ËÅ≤(ÊúâÁØÄÂ•èÊÑü)'},
            narrativeFunction:'Â∞éÂ∏´ËßíËâ≤ÁôªÂ†¥‚Äî‚ÄîÁ∂ìÂÖ∏ÁöÑ"Êô∫ËÄÖÊåáË∑Ø"ÁµêÊßãÔºåÁÇ∫ÂæåÁ∫åÂÜíÈö™Âüã‰∏ã‰ºèÁ≠Ü',
            shotType: 'narrative',
            storyboardNote:'„ÄêËßíËâ≤ÂéüÂûã„ÄëÂèÉËÄÉ„ÄäÊòüÈöõÂ§ßÊà∞„ÄãYoda / „ÄäÈ≠îÊàí„ÄãGandalf ÁöÑÊô∫ËÄÖÂΩ¢Ë±°'
        },
        {
            scene: {
                location:'Á¢ºÈ†≠', 
                time:'Ê∏ÖÊô®(ËóçË™øÊôÇÂàª)', 
                colorTone:'ÈùíËóç‰∏ªË™ø(ËóçË™øÊôÇÂàªËâ≤Ê∫´)ÔºåÊ∞¥Èù¢ÂèçÂÖâÂ∏∂ÈäÄËâ≤', 
                lighting:'Â§©ÂÖâÊï£Â∞Ñ„ÄÅÊô®ÈúßÊüîÂåñ‰∏ÄÂàáÈÇäÁ∑£',
                atmosphere:'Â£ØÈóòÂïüËà™ÔºåÂÜíÈö™Âç≥Â∞áÈñãÂßãÁöÑÂÑÄÂºèÊÑü', 
                props:'Â§ßËïÉËà∂(‰∏âÊ°ÖÂ∏ÜËàπÔºåÈòøÊãâ‰ºØÂºèÂ∞ñÈ†≠)„ÄÅÁü≥Á†åÁ¢ºÈ†≠„ÄÅÊú®Ë≥™ÂêäËáÇËµ∑ÈáçÊ©ü„ÄÅÂ†ÜÁñäÁöÑË≤®ÁÆ±ÂíåÊú®Ê°∂„ÄÅÁ∫úÁπ©„ÄÅÊºÅÁ∂≤„ÄÅÊµ∑È∑ó'
            },
            subject: {
                type:'none', 
                name:'Â§ßËïÉËà∂ËàáÁ¢ºÈ†≠ÂÖ®ÊôØ', 
                action:'ËàπÈöªÈùúÊ≥äÊñºÁ¢ºÈ†≠ÔºåÊ°ÖÊùÜ‰∏äÁöÑÊóóÂπüÂú®Êô®È¢®‰∏≠ËºïËºïÈ£ÑÂãïÔºåÂ∑•‰∫∫ÂÄëÂ¶ÇËûûËüªËà¨Êê¨ÈÅãË≤®Áâ©ÔºåÈÅ†ËôïÊúâÂÖ∂‰ªñËàπÈöªÈßõÂÖ•ÈßõÂá∫',
                expression:null, 
                dialogue:null, 
                tone:null
            },
            camera: {angle:'Â§ßÂÖ®ÊôØ(Ëà™ÊãçÊÑü)', movement:'Á∑©ÊÖ¢Ê©´Áßª+ÂæÆÂæÆ‰∏äÂçá(Â±ïÁ§∫Á¢ºÈ†≠ÂÖ®Ë≤å)', frameSize:'ELS', lens:'16mmË∂ÖÂª£Ëßí'},
            audio: {music:'Âè≤Ë©©Âº¶Ê®ÇÔºåÂæûÂØßÈùúÂà∞Êº∏Âº∑ÔºåÈ†êÁ§∫ÂÜíÈö™ÈñãÂßã', sfx:'Êµ∑Êµ™ÊãçÂ≤∏ËÅ≤„ÄÅÊµ∑È∑óÈ≥¥Âè´„ÄÅÈÅ†ËôïËôüËßíËÅ≤', ambient:'Ê∏ØÂè£‰ΩúÊ•≠ËÅ≤(Êê¨Ë≤®/ÂêÜÂñù/ÈåòÊï≤)'},
            narrativeFunction:'Á©∫Èè°ËΩâÂ†¥‚Äî‚ÄîÁµêÊùüÁ¨¨‰∏ÄÂπï(ËïÉÂùä)ÔºåÈñãÂïüÁ¨¨‰∫åÂπï(Êµ∑‰∏ä)ÔºåÈÄôËâòËàπÊòØÂÜíÈö™ÁöÑËºâÈ´î',
            shotType: 'narrative',
            storyboardNote:'„ÄêË¶ñË¶∫ÂèÉËÄÉ„Äë„ÄäÂä†ÂãíÊØîÊµ∑Áõú„ÄãÁöÑÊ∏ØÂè£Â†¥ÊôØ + Êï¶ÁÖåÂ£ÅÁï´‰∏≠ÁöÑÂïÜËàπÂΩ¢Ë±°'
        },
        {
            scene: {
                location:'ËàπËâôÂÖß', 
                time:'Â§ú', 
                colorTone:'ÊöóÁ¥Ö‰∏ªË™ø+ÈùíËâ≤Èô∞ÂΩ±(ÂÜ∑ÊöñÂ∞çÊØî)', 
                lighting:'ÂØ¶ÊôØÊ≤πÁáà(3ÂÄã)ÂÅ¥ÂÖâÊâì‰∫Æ‰∏ÄÂÅ¥Ëáâ/Ëà™Êµ∑ÂúñÔºåÂ§ßÈÉ®ÂàÜÁ©∫ÈñìÂú®Èô∞ÂΩ±‰∏≠',
                atmosphere:'Â£ìÊäë‰∏çÂÆâÔºåÁßòÂØÜËàáÂç±Èö™‰∏¶Â≠ò', 
                props:'ÈäÖÊ≤πÁáà√ó3(ÂêäÊéõ/Ê°å‰∏ä)„ÄÅÂ§ßÂπÖËà™Êµ∑Âúñ(Ê®ôÊ≥®Á•ûÁßòË®òËôü)„ÄÅÁæäÁöÆÁ¥ôÂç∑Ëª∏„ÄÅÈµùÊØõÁ≠Ü„ÄÅÂ¢®Ê∞¥Áì∂„ÄÅÈäÄË≥™ÈÖíÊùØ„ÄÅÊ≥¢ÊñØÂú∞ÊØØ„ÄÅÊú®Ë≥™ÊêñÊ§Ö„ÄÅÂêäÂ∫ä(ËÉåÊôØ)'
            },
            subject: {
                type:'person', 
                name:'ËïÉÈï∑', 
                action:'Á´ôÂú®Ëà™Êµ∑ÂúñÂâçÔºåËÉåÂ∞çÈè°È†≠ÔºåÂè≥ÊâãÊâ∂ËëóÊ§ÖËÉåÔºåÂ∑¶ÊâãÊè°ËëóÂçäÁ©∫ÁöÑÈäÄÈÖíÊùØÔºåËÇ©ËÜÄÂæÆÂæÆ‰∏ãÊ≤âÈ°ØÈú≤Áñ≤ÊÜäÔºåÂÅ∂ÁàæÊä¨È†≠ÁúãÁ™óÂ§ñ',
                expression:'ÊÜÇÈ¨±Ê∑±Ê≤â‚Äî‚ÄîÂæûËÉåÂΩ±Â∞±ËÉΩÊÑüÂèóÂà∞Ê≤âÈáçÁöÑÂøÉ‰∫ãÔºåÁï∂ËΩâÈ†≠ÂÅ¥ËáâÊôÇÂèØË¶ãÁ∑äÈéñÁöÑÁúâÈ†≠ÂíåÁñ≤ÊÜäÁöÑÁúºË¢ã',
                dialogue:'ÈÄôË∂üËà™Ë°å...‰∏çÊúÉÂ§™Âπ≥...', 
                tone:'‰ΩéÊ≤âÂ®ÅÂö¥‰ΩÜÂ∏∂Ëëó‰∏ÄÁµ≤È°´ÊäñÔºåÂΩ∑ÂΩøÂú®Ë™™Áµ¶Ëá™Â∑±ËÅΩÔºåÈÖíÊ∞£ÂæÆÈÜ∫',
                costume:'ËèØË≤¥‰ΩÜ‰∏çÊï¥(Ëß£ÈñãÈ†òÂè£)„ÄÅÈáëÁµ≤Âà∫Áπ°Èï∑Ë¢ç„ÄÅÈ†≠Â∑æÊ≠™Êñú„ÄÅÊøÉÂØÜÈ¨çÈ¨öÊúâÂπæÊ†πÁôΩÈ´Æ'
            },
            camera: {angle:'ËÉåÂΩ±‚ÜíÂÅ¥Ëáâ(Á∑©ÊÖ¢Áí∞Áπû)', movement:'ÂæûËÉåÂΩ±ÈñãÂßãÔºåÁ∑©ÊÖ¢Áí∞Áπû15Â∫¶Âà∞ÂÅ¥ËáâÔºå‰øùÊåÅÊï¨ÁïèË∑ùÈõ¢', frameSize:'MS', lens:'50mmÊ®ôÊ∫ñ'},
            audio: {music:'‰ΩéÊ≤âÂ§ßÊèêÁê¥soloÔºå‰∏çÂíåË´ßÂíåÂº¶Ë£ΩÈÄ†‰∏çÂÆâ', sfx:'ËàπÈ´îÊêñÊôÉÂê±ÂëÄËÅ≤„ÄÅÈÖíÊùØÊîæ‰∏ãËÅ≤„ÄÅÁ™óÂ§ñÊµ∑Êµ™', ambient:'Êµ∑Êµ™ÊãçÊâìËàπË∫´ÁöÑ‰ΩéÊ≤âËΩüÈ≥¥'},
            narrativeFunction:'Ë£ΩÈÄ†Êá∏Âøµ‚Äî‚ÄîËàπÈï∑Áü•ÈÅì‰ªÄÈ∫ºÔºüÊöóÁ§∫ÈÄôË∂üËà™Ë°åÊúâÂç±Èö™/ÁßòÂØÜÔºåÁÇ∫ÂæåÁ∫åË°ùÁ™ÅÂüãÁ∑ö',
            shotType: 'dramatic',
            storyboardNote:'„ÄêË°®ÊºîÈáçÈªû„ÄëËÉåÂΩ±Êà≤ÈúÄË¶ÅÁî®Ë∫´È´îË™ûË®ÄÂÇ≥ÈÅîÊÉÖÁ∑íÔºåÂèÉËÄÉ„ÄäÊïôÁà∂„ÄãÁöÑËÉåÂΩ±ÈÅãÈè°'
        }
    ];
    
    // Ë®àÁÆóÈè°È†≠Êï∏Èáè
    // AIÁï™ÂäáÔºö3-15ÂàÜÈêò/ÈõÜÔºå4-10Áßí/Èè°È†≠
    // È†êË®≠8ÂàÜÈêò = 480ÁßíÔºåÂπ≥Âùá6Áßí/Èè°È†≠ = 80Èè°È†≠
    const episodeDuration = 8 * 60;  // 8ÂàÜÈêò = 480Áßí
    const avgShotDuration = 6;        // Âπ≥Âùá6Áßí/Èè°È†≠
    const targetShots = Math.round(episodeDuration / avgShotDuration);  // ‚âà80Èè°È†≠
    
    // ÁîüÊàêÈè°È†≠ÔºàÊØèÈõÜÁ¥Ñ80Èè°È†≠Ôºâ
    for(let i = 0; i < targetShots; i++){
        const template = sampleShots[i % sampleShots.length];
        const shot = JSON.parse(JSON.stringify(template));
        shot.id = String(i + 1).padStart(3, '0');
        shot.duration = (4 + Math.random() * 6).toFixed(1) + 's';  // 4-10Áßí
        shot.prompt = {
            mj: generateMJPrompt(shot)
        };
        shots.push(shot);
    }
    
    return shots;
}

function generateMJPrompt(shot){
    let prompt = '';
    
    // Â†¥ÊôØÈÉ®ÂàÜ
    prompt += `${shot.scene.location}, ${shot.scene.time}, ${shot.scene.colorTone} color palette, ${shot.scene.lighting}, `;
    
    // ‰∏ªÈ´îÈÉ®ÂàÜ
    if(shot.subject.type === 'person'){
        prompt += `${shot.subject.name} ${shot.subject.action}, ${shot.subject.expression}, `;
    } else if(shot.subject.type === 'crowd'){
        prompt += `${shot.subject.name} ${shot.subject.action}, `;
    } else if(shot.subject.type === 'object'){
        prompt += `${shot.subject.name} ${shot.subject.action}, `;
    }
    
    // ÊîùÂΩ±ÈÉ®ÂàÜ
    prompt += `${shot.camera.angle}, ${shot.camera.movement}, `;
    
    // È¢®Ê†º
    prompt += 'Tang dynasty era, cinematic, anime style, 8K --ar 16:9 --v 6';
    
    return prompt;
}

// ==================== Step 8: ÂÆåÊàêËº∏Âá∫ ====================
function renderStep8(){
    const totalShots = state.storyboard.length;
    const totalChapters = state.chapters.length;
    const totalChars = state.characters.main.length + state.characters.supporting.length;
    
    return `
        <div class="content-card">
            <h3><span class="icon">üéâ</span> Ë£Ω‰ΩúÂÆåÊàêÔºÅ</h3>
            
            <div class="report">
                <h4>üìä È†ÖÁõÆÁ∏ΩË¶Ω</h4>
                <div class="report-grid">
                    <div class="stat-box"><div class="stat-val">${state.novel.wordCount}</div><div class="stat-label">ÂéüËëóÂ≠óÊï∏</div></div>
                    <div class="stat-box"><div class="stat-val">${totalChapters}</div><div class="stat-label">Á´†ÁØÄÊï∏</div></div>
                    <div class="stat-box"><div class="stat-val">${totalChars}</div><div class="stat-label">ËßíËâ≤Êï∏</div></div>
                    <div class="stat-box"><div class="stat-val">${totalShots}</div><div class="stat-label">Á∏ΩÈè°È†≠</div></div>
                </div>
            </div>
            
            <div class="report">
                <h4>üìÅ Ëº∏Âá∫ÊñáÊ™îÊ∏ÖÂñÆ</h4>
                <div class="item-card">
                    <p>üìÑ <strong>concept.json</strong> - È´òÊ¶ÇÂøµÂÆö‰Ωç</p>
                    <p>üìÑ <strong>chapters.json</strong> - Á´†ÁØÄÁµêÊßã</p>
                    <p>üìÑ <strong>characters.json</strong> - ËßíËâ≤Ë®≠Ë®àÔºàÂê´PromptÔºâ</p>
                    <p>üìÑ <strong>costumes.json</strong> - ÊúçÂåñÈÅìË®≠Ë®à</p>
                    <p>üìÑ <strong>storyboard.json</strong> - ÂÆåÊï¥ÂàÜÈè°Ë°®</p>
                    <p>üìÑ <strong>prompts_mj.txt</strong> - Midjourney Prompts</p>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="exportJSON()">üìÑ Â∞éÂá∫JSON</button>
                <button class="btn" onclick="exportCSV()">üìä Â∞éÂá∫CSV</button>
                <button class="btn" onclick="exportPrompts()">üñºÔ∏è Â∞éÂá∫Prompts</button>
                <button class="btn btn-primary" onclick="location.reload()">ÈñãÂßãÊñ∞È†ÖÁõÆ</button>
            </div>
        </div>
    `;
}

// ==================== Â∞éÂá∫ÂäüËÉΩ ====================
function getExportFilename(suffix){
    const title = (state.novel?.title || 'AIÁï™ÂäáÈ†ÖÁõÆ').replace(/[<>:"/\\|?*]/g, '_');
    return `${title}_${suffix}`;
}

function exportJSON(){
    // Á¢∫‰øùÊï∏ÊìöÂÆåÊï¥
    if(!state.storyboard || state.storyboard.length === 0){
        alert('Ë´ãÂÖàÂÆåÊàêÂàÜÈè°Ë®≠Ë®àÂÜçÂ∞éÂá∫');
        return;
    }
    
    const data = {
        meta: {
            title: state.novel?.title || 'AIÁï™ÂäáÈ†ÖÁõÆ',
            exportTime: new Date().toISOString(),
            version: 'v3',
            tool: 'FizzDragon AIÁï™ÂäáÂ∑•‰ΩúÂè∞'
        },
        novel: state.novel,
        aiAnalysis: state.aiAnalysis,
        interview: state.interview,
        concept: state.concept,
        chapters: state.chapters,
        characters: state.characters,
        storyboard: state.storyboard,
        stats: {
            totalShots: state.storyboard.length,
            estimatedDuration: Math.round(state.storyboard.reduce((sum,s)=>sum+parseFloat(s.duration||6),0)/60) + 'ÂàÜÈêò',
            characterCount: (state.characters?.main?.length || 0) + (state.characters?.supporting?.length || 0)
        }
    };
    
    download(JSON.stringify(data, null, 2), getExportFilename('ÂÆåÊï¥Êï∏Êìö.json'), 'application/json');
    alert('‚úÖ JSONÂ∞éÂá∫ÊàêÂäüÔºÅ');
}

function exportCSV(){
    if(!state.storyboard || state.storyboard.length === 0){
        alert('Ë´ãÂÖàÂÆåÊàêÂàÜÈè°Ë®≠Ë®àÂÜçÂ∞éÂá∫');
        return;
    }
    
    let csv = '\uFEFFÈè°È†≠ID,È°ûÂûã,ÊôÇÈï∑,Â†¥ÊôØ,ÊôÇÈñì,Ëâ≤Ë™ø,ÁáàÂÖâ,Ê∞õÂúç,ÈÅìÂÖ∑,‰∏ªÈ´îÈ°ûÂûã,‰∏ªÈ´îÂêçÁ®±,Âãï‰Ωú,Ë°®ÊÉÖ,ÊúçË£ù,Âè∞Ë©û,Ê©ü‰Ωç,ÈÅãÈè°,ÊôØÂà•,Èè°È†≠,Êïò‰∫ãÂäüËÉΩ,Prompt\n';
    
    state.storyboard.forEach(s => {
        const escape = (str) => `"${(str||'').replace(/"/g, '""')}"`;
        csv += [
            s.id,
            s.shotType,
            s.duration,
            escape(s.scene?.location),
            s.scene?.time,
            escape(s.scene?.colorTone),
            escape(s.scene?.lighting),
            escape(s.scene?.atmosphere),
            escape(s.scene?.props),
            s.subject?.type,
            escape(s.subject?.name),
            escape(s.subject?.action),
            escape(s.subject?.expression),
            escape(s.subject?.costume),
            escape(s.subject?.dialogue),
            escape(s.camera?.angle),
            escape(s.camera?.movement),
            escape(s.camera?.frameSize),
            escape(s.camera?.lens),
            escape(s.narrativeFunction),
            escape(s.prompt?.mj)
        ].join(',') + '\n';
    });
    
    download(csv, getExportFilename('ÂàÜÈè°Ë°®.csv'), 'text/csv');
    alert('‚úÖ CSVÂ∞éÂá∫ÊàêÂäüÔºÅÂÖ±' + state.storyboard.length + 'ÂÄãÈè°È†≠');
}

function exportPrompts(){
    if(!state.storyboard || state.storyboard.length === 0){
        alert('Ë´ãÂÖàÂÆåÊàêÂàÜÈè°Ë®≠Ë®àÂÜçÂ∞éÂá∫');
        return;
    }
    
    const title = state.novel?.title || 'AIÁï™ÂäáÈ†ÖÁõÆ';
    let txt = `# ${title} - AI Prompts\n`;
    txt += `# Â∞éÂá∫ÊôÇÈñìÔºö${new Date().toLocaleString()}\n`;
    txt += `# Â∑•ÂÖ∑ÔºöFizzDragon AIÁï™ÂäáÂ∑•‰ΩúÂè∞ v3\n\n`;
    
    txt += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    txt += '## üé≠ ËßíËâ≤Prompts\n';
    txt += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    
    const allChars = [...(state.characters?.main || []), ...(state.characters?.supporting || [])];
    allChars.forEach((c, i) => {
        txt += `### ${i+1}. ${c.name} (${c.role || ''})\n`;
        txt += `${c.prompt}\n\n`;
    });
    
    txt += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    txt += '## üé¨ ÂàÜÈè°Prompts\n';
    txt += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    
    state.storyboard.forEach(s => {
        txt += `### Shot #${s.id} [${s.shotType}] ${s.duration}\n`;
        txt += `Â†¥ÊôØÔºö${s.scene?.location} / ${s.scene?.time}\n`;
        txt += `‰∏ªÈ´îÔºö${s.subject?.name}\n`;
        txt += `PromptÔºö\n${s.prompt?.mj}\n\n`;
    });
    
    download(txt, getExportFilename('Prompts.txt'), 'text/plain');
    alert('‚úÖ PromptsÂ∞éÂá∫ÊàêÂäüÔºÅÂÖ±' + (allChars.length + state.storyboard.length) + 'ÂÄãPrompt');
}

function download(content, filename, type){
    const blob = new Blob([content], {type: type + ';charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// ==================== AgentÊÄùËÄÉÈÅéÁ®ãÂ±ïÁ§∫ ====================
const AGENT_PROFILES = {
    import: {name:'üìñ Â∞éÂÖ•Agent', avatar:'üìñ', skills:['adaptation_novel_analysis']},
    concept: {name:'üí° È´òÊ¶ÇÂøµAgent', avatar:'üí°', skills:['concept_high_concept','screenwriting_mcgee_story','screenwriting_save_the_cat']},
    interview: {name:'üé§ Ë®™Ë´áAgent', avatar:'üé§', skills:['interview_metzler_creative','interview_hitchcock_truffaut','interview_seidman_depth','interview_creative_vision','interview_story_development']},
    chapter: {name:'üìë Á´†ÁØÄAgent', avatar:'üìë', skills:['outline_act_structure','adaptation_episode','outline_episode_hook','outline_cliffhanger']},
    character: {name:'üë§ ËßíËâ≤Agent', avatar:'üë§', skills:['character_bible','psychology_motivation','character_design_expression','character_design_silhouette']},
    costume: {name:'üëî ÊúçÂåñÈÅìAgent', avatar:'üëî', skills:['clothing_modern','hair_styles','culture_history']},
    scene: {name:'üèõÔ∏è Â†¥ÊôØAgent', avatar:'üèõÔ∏è', skills:['scene_description','lighting_cinematic','weather_atmosphere']},
    script: {name:'‚úçÔ∏è Á∑®ÂäáAgent', avatar:'‚úçÔ∏è', skills:['screenwriting_mcgee_story','dialogue_craft','script_action_lines','script_subtext']},
    camera: {name:'üé• ÈÅãÈè°Agent', avatar:'üé•', skills:['cinematography_master','camera_movement_advanced','cinematography_composition','cinematography_shots']},
    prompt: {name:'üñºÔ∏è Prompt Agent', avatar:'üñºÔ∏è', skills:['ai_midjourney','ai_stable_diffusion','ai_flux','ai_prompt_engineering']},
    output: {name:'üéâ Ëº∏Âá∫Agent', avatar:'üéâ', skills:[]}
};

// Ê≠•È©üÂà∞AgentÁöÑÊò†Â∞Ñ
const STEP_AGENT_MAP = {
    1: ['import'],
    2: ['interview'],
    3: ['concept'],
    4: ['chapter'],
    5: ['character'],
    6: ['costume', 'scene'],
    7: ['script'],
    8: ['camera', 'prompt'],
    9: ['output']
};

// Êõ¥Êñ∞Âè≥ÂÅ¥Agent+SkillsÈù¢Êùø
function updateAgentSkillsPanel(step) {
    const panel = document.getElementById('currentAgentInfo');
    if (!panel) return;
    
    const agentKeys = STEP_AGENT_MAP[step] || [];
    if (agentKeys.length === 0) {
        panel.innerHTML = '<div style="color:var(--dim);font-size:12px">Êö´ÁÑ°</div>';
        return;
    }
    
    let html = '';
    agentKeys.forEach(key => {
        const agent = AGENT_PROFILES[key];
        if (!agent) return;
        
        html += `
            <div style="background:var(--surface2);border-radius:8px;padding:12px;margin-bottom:12px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                    <span style="font-size:20px">${agent.avatar}</span>
                    <span style="font-weight:600;font-size:13px">${agent.name}</span>
                </div>
                <div style="font-size:10px;color:var(--dim);margin-bottom:6px">Ë™øÁî®SkillsÔºö</div>
                <div style="display:flex;flex-wrap:wrap;gap:4px">
                    ${agent.skills.map(s => `
                        <span style="background:var(--bg);color:var(--dim);padding:3px 8px;border-radius:4px;font-size:10px;font-family:monospace;cursor:help" title="${s}.skill.md">
                            ${s}
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    // Áµ±Ë®à
    const totalSkills = agentKeys.reduce((sum, key) => sum + (AGENT_PROFILES[key]?.skills?.length || 0), 0);
    html += `
        <div style="font-size:10px;color:var(--dim);text-align:center;padding-top:8px;border-top:1px solid var(--border);margin-top:8px">
            Êú¨Ê≠•È©üÔºö${agentKeys.length} ÂÄãAgent ¬∑ ${totalSkills} ÂÄãSkills
        </div>
    `;
    
    panel.innerHTML = html;
}

const THINKING_TEMPLATES = {
    concept: [
        'Ê≠£Âú®Èñ±ËÆÄÂ∞èË™™ÊñáÊú¨...',
        'ÊèêÂèñÊ†∏ÂøÉË°ùÁ™ÅÂíå‰∏ªÈ°å...',
        'ÂàÜÊûêÁõÆÊ®ôÂèóÁúæÂÆö‰Ωç...',
        'ÂèÉËÄÉ screenwriting_mcgee_story.skill ÁöÑÊïÖ‰∫ãÁµêÊßãÁêÜË´ñ...',
        'ÁîüÊàêÈ´òÊ¶ÇÂøµLogline...',
        'Á¢∫ÂÆöÈ°ûÂûãÂíåÊÉÖÊÑüÂü∫Ë™ø...'
    ],
    character: [
        'ÊéÉÊèèÂ∞èË™™‰∏≠ÁöÑËßíËâ≤Âá∫Â†¥...',
        'Ë≠òÂà•‰∏ªËßí„ÄÅÈÖçËßí„ÄÅÁæ§Êºî...',
        'Âä†Ëºâ character_bible.skillÔºàLajos Egri‰∏âÁ∂≠ËßíËâ≤ÁêÜË´ñÔºâ...',
        'ÂàÜÊûêËßíËâ≤ÁöÑÁîüÁêÜÁ∂≠Â∫¶ÔºöÂπ¥ÈΩ°„ÄÅÂ§ñË≤å„ÄÅÁøíÊÖ£...',
        'ÂàÜÊûêËßíËâ≤ÁöÑÁ§æÊúÉÁ∂≠Â∫¶ÔºöÂÆ∂Â∫≠„ÄÅÊïôËÇ≤„ÄÅÂú∞‰Ωç...',
        'ÂàÜÊûêËßíËâ≤ÁöÑÂøÉÁêÜÁ∂≠Â∫¶ÔºöÂñúÊÄíÂìÄÊáº„ÄÅWant/Need/Wound...',
        'Ë®≠Ë®àËßíËâ≤ÂºßÁ∑öÔºöËµ∑Èªû ‚Üí ÈåØË™§‰ø°Âøµ ‚Üí ËΩâËÆä ‚Üí ÁµÇÈªû...',
        'ÁîüÊàêËßíËâ≤Prompt...'
    ],
    scene: [
        'Ë≠òÂà•Â†¥ÊôØÂú∞ÈªûÂíåÊôÇÈñì...',
        'Âä†Ëºâ scene_description.skill...',
        'Ë®≠Ë®àÁ©∫ÈñìÁµêÊßãÂíåÊùêË≥™...',
        'Ë¶èÂäÉÂÖâÁ∑öÔºöÂÖâÊ∫ê„ÄÅÊñπÂêë„ÄÅÂº∑Â∫¶„ÄÅËâ≤Ê∫´...',
        'Á¢∫ÂÆöËâ≤Ë™øÂíåÊ∞õÂúç...',
        'ÂàóÂá∫Â§ß‰∏≠Â∞èÈÅìÂÖ∑Ê∏ÖÂñÆ...',
        'Ê∑ªÂä†ÂãïÊÖãÂÖÉÁ¥†...'
    ],
    camera: [
        'Âä†Ëºâ cinematography_master.skill...',
        'Ê†πÊìöÊÉÖÁ∑íÈÅ∏ÊìáÊôØÂà•ÔºöMS / CU / ECU...',
        'Á¢∫ÂÆöÊ©ü‰ΩçËßíÂ∫¶Ôºö‰øØÊãç / Âπ≥Ë¶ñ / ‰ª∞Êãç...',
        'Ë®≠Ë®àÈÅãÈè°ËªåË∑°ÔºöÊé® / Êãâ / Êêñ / Áßª / Áí∞Áπû...',
        'Ë®àÁÆóÈÅãÈè°ÈÄüÂ∫¶ÂíåÊôÇÈï∑...',
        'Ë¶èÂäÉÊßãÂúñÔºö‰∏âÂàÜÊ≥ï / Â∞çËßíÁ∑ö / Ê°Ü‰∏≠Ê°Ü...',
        'ÈÅ∏ÊìáÈè°È†≠ÂíåÊôØÊ∑±...',
        'Âª∫Ë≠∞ÊãçÊîùË®≠ÂÇô...'
    ],
    script: [
        'Âä†Ëºâ screenwriting_mcgee_story.skill...',
        'ÂàÜÊûêÂ†¥ÊôØÁöÑÊïò‰∫ãÂäüËÉΩ...',
        'Ë®≠Ë®àÊÉÖÊÑüÁØÄÊãçÔºöÈñãÂ†¥ ‚Üí ËΩâÊäò ‚Üí È´òÊΩÆ...',
        'Êí∞ÂØ´Â†¥ÊôØÊèèËø∞ÔºàAction LinesÔºâ...',
        'Á∑®ÂØ´Â∞çË©±ÂíåÊã¨ËôüÂãï‰Ωú...',
        'Ë®≠Ë®àËßíËâ≤ÂèçÊáâÂíåÊΩõÂè∞Ë©û...',
        'Á¢∫ÂÆöÂ†¥ÊôØËΩâÂ†¥ÊñπÂºè...'
    ],
    storyboard: [
        'Êï¥ÂêàÊâÄÊúâAgentËº∏Âá∫...',
        'Ë®àÁÆóÁ∏ΩÈè°È†≠Êï∏ÔºöÈ†êË®àÊôÇÈï∑ √∑ Âπ≥ÂùáÈè°È†≠ÊôÇÈï∑...',
        'ÂàÜÈÖçÈè°È†≠È°ûÂûãÊØî‰æãÔºöÊïò‰∫ã50-60% / Êà≤Âäá25-30% / ÊÉÖÊÑü15-20%...',
        'ÁîüÊàêÊØèÂÄãÈè°È†≠ÁöÑÂ†¥ÊôØÊï∏Êìö...',
        'ÁîüÊàêÊØèÂÄãÈè°È†≠ÁöÑ‰∏ªÈ´îÊï∏Êìö...',
        'ÁîüÊàêÊØèÂÄãÈè°È†≠ÁöÑÊîùÂΩ±Êï∏Êìö...',
        'ÁîüÊàêÊØèÂÄãÈè°È†≠ÁöÑÈü≥È†ªÊï∏Êìö...',
        'ÂêàÊàêAI Prompt...',
        'ÂÆåÊàêÔºÅ'
    ]
};

async function showAgentThinking(containerId, agentType, callback){
    const container = document.getElementById(containerId);
    const agent = AGENT_PROFILES[agentType] || AGENT_PROFILES.concept;
    const steps = THINKING_TEMPLATES[agentType] || THINKING_TEMPLATES.concept;
    
    container.innerHTML = `
        <div class="agent-thinking">
            <div class="agent-thinking-header">
                <div class="agent-avatar">${agent.avatar}</div>
                <div>
                    <div class="agent-name">${agent.name}</div>
                    <div class="agent-status">ÊÄùËÄÉ‰∏≠<span class="thinking-dots"><span></span><span></span><span></span></span></div>
                </div>
            </div>
            <div class="thinking-process" id="thinkingSteps"></div>
            <div class="chain-of-thought" id="chainOfThought" style="display:none"></div>
        </div>
    `;
    
    const stepsContainer = document.getElementById('thinkingSteps');
    const cotContainer = document.getElementById('chainOfThought');
    
    // ÈÄêÊ≠•È°ØÁ§∫ÊÄùËÄÉÈÅéÁ®ã
    for(let i = 0; i < steps.length; i++){
        await sleep(800 + Math.random() * 600); // Èö®Ê©üÂª∂ÈÅ≤ÔºåÊõ¥Ëá™ÁÑ∂
        
        const stepEl = document.createElement('div');
        stepEl.className = 'thinking-step current';
        stepEl.style.animationDelay = `${i * 0.1}s`;
        stepEl.innerHTML = steps[i];
        stepsContainer.appendChild(stepEl);
        
        // Ê®ôË®ò‰∏ä‰∏ÄÂÄãÊ≠•È©üÂÆåÊàê
        if(i > 0){
            stepsContainer.children[i-1].classList.remove('current');
            stepsContainer.children[i-1].classList.add('done');
        }
        
        // ÊªæÂãïÂà∞Â∫ïÈÉ®
        container.scrollTop = container.scrollHeight;
    }
    
    // ÊúÄÂæå‰∏ÄÊ≠•Ê®ôË®òÂÆåÊàê
    await sleep(500);
    stepsContainer.lastChild.classList.remove('current');
    stepsContainer.lastChild.classList.add('done');
    
    // È°ØÁ§∫ÊÄùÁ∂≠ÈèàÁ∏ΩÁµê
    await sleep(300);
    cotContainer.style.display = 'block';
    cotContainer.innerHTML = `
        <div class="step">ÂàÜÊûêËº∏ÂÖ•Êï∏Êìö...</div>
        <div class="step">ÊáâÁî®Â∞àÊ•≠Áü•Ë≠òÔºà${agent.skills.join(', ')}Ôºâ...</div>
        <div class="step">ÁîüÊàêÁµêÊßãÂåñËº∏Âá∫...</div>
        <div class="conclusion">‚úÖ ${agent.name} ÂàÜÊûêÂÆåÊàêÔºåÊ≠£Âú®Ê∏≤ÊüìÁµêÊûú...</div>
    `;
    
    await sleep(1000);
    
    // Âü∑Ë°åÂõûË™øÈ°ØÁ§∫ÁµêÊûú
    if(callback) callback();
}

function sleep(ms){
    return new Promise(resolve => setTimeout(resolve, ms));
}

function updateOutputPanel(){
    const files = [];
    
    if(state.concept.logline) files.push({name:'concept.json', size:'2KB'});
    if(state.chapters.length) files.push({name:'chapters.json', size:`${state.chapters.length}Á´†`});
    if(state.characters.main.length) files.push({name:'characters.json', size:`${state.characters.main.length + state.characters.supporting.length}ËßíËâ≤`});
    if(state.storyboard.length) files.push({name:'storyboard.json', size:`${state.storyboard.length}Èè°È†≠`});
    
    document.getElementById('outputFiles').innerHTML = files.map(f => `
        <div class="output-file">
            <span class="icon">üìÑ</span>
            <span class="name">${f.name}</span>
            <span class="size">${f.size}</span>
        </div>
    `).join('') || '<p style="color:var(--dim);font-size:12px">Â∞öÊú™ÁîüÊàê</p>';
}

// ==================== Á§∫‰æãÊï∏Êìö ====================
const DEMO_NOVEL = `„ÄäÊµ∑‰∏äÁµ≤Á∂¢‰πãË∑ØÂØÜÁ¢º„Äã

È°ûÂûãÔºöÊ≠∑Âè≤ÂÜíÈö™ / Êá∏Áñë / Êù±ÊñπÂ•áÂπª
ÊôÇ‰ª£ÔºöÂîê‰ª£
Âú∞ÈªûÔºöÂª£Â∑ûËïÉÂùä ‚Üí ÂçóÊ¥ãËà™Á∑ö ‚Üí Â©ÜÁæÖÊµÆÂ±†

„ÄêÊ•îÂ≠ê„Äë
ËåÖËçâÊ£öÂÖßÔºåÈ¶ôÁÖôÁπöÁπû„ÄÇÂç†Â§¢Â∏´ÊâãÊåÅÈäÄÈèàÔºåÁ≤âÁ¥ÖËâ≤ÁöÑÂÖâÂæûÊ≥¢ÊñØË≤¥Â©¶ÁöÑËÉ∏Âè£ÈÄèÂá∫„ÄÇ
Â∞èÁå¥Â≠êËóèÂú®ÊàøÊ¢Å‰∏äÔºåÁ≠âÂæÖÊôÇÊ©ü„ÄÇ‰ªñÊòØËïÉÂùäÊúÄÈùàÊ¥ªÁöÑÂ∞èÂÅ∑„ÄÇ
Áï∂‰ªñÁöÑÊâãÊåáËß∏Á¢∞ÈÇ£È°ÜÁ≤âÁ¥ÖÂØ∂Áü≥ÊôÇÔºåË©≠Áï∞ÁöÑÂπªË±°ÈñÉÈÅéËÖ¶Êµ∑‚Äî‚ÄîÈÆÆË°Ä„ÄÅÁÅ´ÁÑ∞„ÄÅÈÇÑÊúâ‰∏ÄÂÄãÂ∞ëÂ•≥ÁöÑËáâ...

„ÄêÁ¨¨‰∏ÄÁ´† Âª£Â∑ûËïÉÂùä„Äë
ÊÄÄÂú£ÂØ∫ÁöÑÂÖâÂ°îÈ´òËÅ≥ÔºåÈáëÈ†ÇÂú®Â§ïÈôΩ‰∏ãÈñÉËÄÄ„ÄÇÈÄôÊòØÂ§ßÂîêÊúÄÁπÅËèØÁöÑÊ∏ØÂè£ÔºåÂêÑÂúãÂïÜ‰∫∫Èõ≤ÈõÜÊñºÊ≠§„ÄÇ
Á¥ÖÈ´ÆÁõ≤ËÄÅ‰∫∫Âú®Ê¶ïÊ®π‰∏ãË¨õËø∞Êµ∑‰∏äÂÇ≥Ë™™ÔºåÂ≠©Â≠êÂÄëÂúçÂùêËÅÜËÅΩ„ÄÇ„ÄåÂú®Êµ∑ÁöÑÈÇ£‰∏ÄÈÇäÔºåÊúâ‰∏ÄÂ∫ßÂ±±ÔºåÂ±±‰∏äÊúâÂ∫ßÂ°îÔºåÂ°îË£°ËóèËëóÂçÉÂπ¥ÁöÑÁßòÂØÜ...„Äç
Â∞èÁå¥Â≠êÁ©øÊ¢≠Âú®ÁÜôÊîòÁöÑ‰∫∫Áæ§‰∏≠Ôºå‰ªñÁöÑÁõÆÊ®ôÊòØÈÇ£ÂÄãÊ≥¢ÊñØÂïÜ‰∫∫ÁöÑÈå¢Ë¢ã„ÄÇ‰ΩÜ‰ªäÂ§©ÁöÑÊî∂Á©´ÔºåÈÅ†ÊØîÈå¢Ë¢ãÈáçË¶Å‚Äî‚ÄîÈÇ£È°ÜÊúÉÁôºÂÖâÁöÑÁ≤âÁ¥ÖÂØ∂Áü≥„ÄÇ

„ÄêÁ¨¨‰∫åÁ´† Â§úÊµ∑ÂïüËà™„Äë
Â§ßËïÉËà∂Â¶ÇÂ∑®Áç∏ÔºåÂÅúÊ≥äÂú®Á¢ºÈ†≠„ÄÇÈÄôËâòËàπÂ∞áÈßõÂêëÂçóÊ¥ãÔºåËºâËëóÈ¶ôÊñô„ÄÅÁµ≤Á∂¢ÔºåÈÇÑÊúâÁÑ°Êï∏‰∫∫ÁöÑÂëΩÈÅã„ÄÇ
ËïÉÈï∑Á´ôÂú®ËàπÈ†≠ÔºåÁµ°ËÖÆÈ¨çÂú®Êµ∑È¢®‰∏≠È£ÑÂãï„ÄÇ„ÄåÈÄôË∂üËà™Ë°å...‰∏çÊúÉÂ§™Âπ≥„ÄÇ„Äç
Â∞èÁå¥Â≠êËøΩÂ∞ãÂ∞èËè©Ëñ©Ë†ªÁöÑË∫´ÂΩ±Ôºå‰ªñÂøÖÈ†àÁôª‰∏äÈÄôËâòËàπ„ÄÇÈÇ£È°ÜÂØ∂Áü≥‰ºº‰πéÂú®Âè¨Âñö‰ªñÔºåÂëäË®¥‰ªñÁúüÁõ∏Âú®ÈÅ†Êñπ...

„ÄêÁ¨¨‰∏âÁ´† ÈªëÂ∏ÜË≥äËàπ„Äë
ÊúàÂÖâ‰∏ãÁöÑÂ§ßÊµ∑ÔºåÈÅ†ËôïÂá∫ÁèæÈªëËâ≤Â∏ÜÂΩ±„ÄÇ
„ÄåÊµ∑ÁõúÔºÅ„ÄçÁû≠ÊúõÊâãÁöÑÈ©öÂè´ËÅ≤ÂäÉÁ†¥Â§úÁ©∫„ÄÇ
„ÄåÊòØÈ£ü‰∫∫È≠îÁöÑËàπÔºÅ„ÄçÊ∞¥ÊâãÂÄëÈ©öÊÅêËê¨ÂàÜ„ÄÇÂÇ≥Ë™™ÈÄôÊîØÊµ∑ÁõúÂæû‰∏çÁïôÊ¥ªÂè£ÔºåÂè™Âõ†‰ªñÂÄëÁöÑÈ¶ñÈ†òÂñúÊ≠°Êî∂ÈõÜ‰∫∫È†≠...

„ÄêÁ¨¨ÂõõÁ´† ÂØÜÂÆ§ÊÆ∫‰∫∫„Äë
Â§©‰∫ÆÊôÇÔºåËâôÊàøË£°ÁôºÁèæ‰∫ÜÁ¨¨‰∏ÄÂÖ∑Â±çÈ´î„ÄÇÊ≠ªËÄÖÊòØËàπ‰∏äÁöÑÂ§ßÈ£üÂïÜ‰∫∫ÔºåÂñâÂö®Ë¢´Ââ≤ÈñãÔºåÁúºÁùõÂçªÁúãËëóÊüêÂÄãÊñπÂêë‚Äî‚ÄîÂØ∂Áü≥Ê∂àÂ§±ÁöÑÊñπÂêë„ÄÇ
„ÄåÂÖáÊâãÂ∞±Âú®ÊàëÂÄë‰πã‰∏≠„ÄÇ„ÄçËïÉÈï∑Ê≤âËÅ≤Ë™™ÈÅì„ÄÇ
Â∞èÁå¥Â≠êÊè°Á∑äÊá∑‰∏≠ÁöÑÂØ∂Áü≥ÔºåÂÆÉÂèàÈñãÂßãÁôºÂÖâ‰∫Ü...

„ÄêÁ¨¨‰∫îÁ´† Ëº™Ëø¥‰πãË¨é„Äë
Áï∂Â∞èËè©Ëñ©Ë†ªÈñãÂè£Ë™™Ë©±ÊôÇÔºåÊâÄÊúâ‰∫∫ÈÉΩÈúáÈ©ö‰∫Ü„ÄÇÂ•πË™™ÁöÑ‰∏çÊòØÂîêË®ÄÔºåËÄåÊòØ‰∏ÄÁ®ÆÂè§ËÄÅÁöÑË™ûË®ÄÔºå‰∏ÄÁ®ÆÂçÉÂπ¥ÂâçÂ∞±Â∑≤Ê∂à‰∫°ÁöÑË™ûË®Ä„ÄÇ
„Äå‰∏ÄÂàáÈÉΩÂ∞áÈáçÊºî...„ÄçÂ•πÁöÑÁúºÁ•ûÁ©∫Ê¥ûËÄåÊ∑±ÈÇÉÔºå„ÄåÂ∞±ÂÉèÂçÉÂπ¥Ââç‰∏ÄÊ®£...„Äç
ÂçúÂ§¢Â∏´ÁöÑÈäÄÈèàÈñãÂßãÊêñÊôÉÔºö„ÄåËº™Ëø¥ÁöÑÈéñÈèàÔºåÂ∑≤Á∂ìÈñãÂßãÊñ∑Ë£Ç...„Äç`;

// ==================== ÂàùÂßãÂåñ ====================
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
