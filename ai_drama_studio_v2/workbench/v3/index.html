<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FizzDragon AIç•ªåŠ‡ç³»çµ±</title>
    <!-- DOCXè§£æåº« -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <!-- PDFè§£æåº« -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <!-- Excelå°å‡ºåº« (SheetJS) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- PDFå°å‡ºåº« (jsPDF) -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            /* é»‘ç™½ç°çº¢ä¸»é¢˜ */
            --bg:#050505;--surface:#0a0a0a;--surface2:#141414;
            --border:#252525;--border-glow:#ff0a3520;
            --text:#ffffff;--text-secondary:#e0e0e0;--dim:#808080;
            --primary:#ff0a35;--primary-dark:#cc0828;--primary-glow:#ff0a3540;
            --primary-light:#ff3355;
            /* ç»Ÿä¸€ç”¨çº¢è‰²ç³»æ›¿ä»£å…¶ä»–é¢œè‰² */
            --secondary:#ff2d55;--accent:#ff0a35;
            --success:#ff0a35;--cyan:#ff0a35;--pink:#ff0a35;--purple:#ff0a35;
            --warning:#ff0a35;--error:#ff0a35;
            --radius:4px;--radius-sm:2px;
            --glow-sm:0 0 10px var(--primary-glow);
            --glow-md:0 0 20px var(--primary-glow);
            --glow-lg:0 0 40px var(--primary-glow);
        }
        
        /* Cyberpunk Base */
        body{
            font-family:'Inter',system-ui,sans-serif;
            background:var(--bg);
            color:var(--text);
            min-height:100vh;
            line-height:1.6;
            background-image:
                linear-gradient(0deg, transparent 24%, rgba(255,10,53,.03) 25%, rgba(255,10,53,.03) 26%, transparent 27%, transparent 74%, rgba(255,10,53,.03) 75%, rgba(255,10,53,.03) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(255,10,53,.03) 25%, rgba(255,10,53,.03) 26%, transparent 27%, transparent 74%, rgba(255,10,53,.03) 75%, rgba(255,10,53,.03) 76%, transparent 77%, transparent);
            background-size:50px 50px;
        }
        
        /* Scanline Effect */
        body::before{
            content:'';position:fixed;top:0;left:0;width:100%;height:100%;
            background:repeating-linear-gradient(0deg,rgba(0,0,0,0.1),rgba(0,0,0,0.1) 1px,transparent 1px,transparent 2px);
            pointer-events:none;z-index:9999;opacity:0.3;
        }
        
        /* Layout */
        .app{display:flex;flex-direction:column;min-height:100vh}
        
        .header{
            padding:16px 24px;
            background:linear-gradient(180deg,var(--surface) 0%,var(--bg) 100%);
            border-bottom:1px solid var(--primary);
            box-shadow:var(--glow-sm);
            display:flex;align-items:center;justify-content:space-between;
            position:relative;
        }
        .header::after{
            content:'';position:absolute;bottom:0;left:0;width:100%;height:1px;
            background:linear-gradient(90deg,transparent,var(--primary),transparent);
        }
        
        .logo{
            font-family:'Orbitron',monospace;
            font-size:22px;font-weight:800;letter-spacing:2px;
            background:linear-gradient(135deg,var(--primary) 0%,var(--pink) 50%,var(--accent) 100%);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
            text-shadow:0 0 30px var(--primary-glow);
            animation:glitch 3s infinite;
        }
        @keyframes glitch{
            0%,90%,100%{text-shadow:0 0 30px var(--primary-glow)}
            92%{text-shadow:-2px 0 var(--cyan),2px 0 var(--pink)}
            94%{text-shadow:2px 0 var(--cyan),-2px 0 var(--pink)}
        }
        
        .header-info{display:flex;gap:12px;align-items:center}
        .badge{
            padding:6px 14px;
            background:var(--surface2);
            border:1px solid var(--border);
            border-radius:0;
            font-size:10px;font-family:'Orbitron',monospace;
            color:var(--dim);
            text-transform:uppercase;
            letter-spacing:1px;
            clip-path:polygon(8px 0,100% 0,100% calc(100% - 8px),calc(100% - 8px) 100%,0 100%,0 8px);
        }
        .badge.active{
            background:var(--primary);
            border-color:var(--primary);
            color:#fff;
            box-shadow:var(--glow-sm);
        }
        
        .main{flex:1;display:grid;grid-template-columns:280px 1fr 320px;gap:0}
        
        /* Left Panel - Progress */
        .panel-left{
            background:linear-gradient(90deg,var(--surface) 0%,var(--bg) 100%);
            border-right:1px solid var(--border);
            padding:20px;overflow-y:auto;
            position:relative;
        }
        .panel-left::after{
            content:'';position:absolute;top:0;right:0;width:1px;height:100%;
            background:linear-gradient(180deg,var(--primary),transparent 30%,transparent 70%,var(--primary));
        }
        .panel-left h2{
            font-family:'Orbitron',monospace;
            font-size:10px;color:var(--primary);
            text-transform:uppercase;letter-spacing:3px;
            margin-bottom:20px;
            padding-bottom:10px;
            border-bottom:1px solid var(--border);
        }
        
        .step-list{list-style:none}
        .step-item{
            display:flex;align-items:center;gap:12px;
            padding:14px 12px;
            border:1px solid transparent;
            margin-bottom:6px;
            cursor:pointer;
            transition:all .3s;
            position:relative;
            clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));
        }
        .step-item::before{
            content:'';position:absolute;top:0;left:0;width:3px;height:0;
            background:var(--primary);transition:height .3s;
        }
        .step-item:hover{background:var(--surface2);border-color:var(--border)}
        .step-item:hover::before{height:100%}
        .step-item.active{
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
            border-color:var(--primary);
            box-shadow:var(--glow-md);
        }
        .step-item.active::before{height:100%;background:var(--accent)}
        .step-item.done{opacity:.7;position:relative}
        .step-item.done:hover{opacity:1;background:var(--surface2)}
        .step-item.done:hover::after{content:'é»æ“Šè¿”å›';position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--primary);background:rgba(255,10,53,.1);padding:2px 6px;border-radius:4px}
        
        .step-num{
            width:32px;height:32px;
            border:1px solid var(--border);
            background:var(--bg);
            display:flex;align-items:center;justify-content:center;
            font-family:'Orbitron',monospace;
            font-size:11px;font-weight:600;
            clip-path:polygon(6px 0,100% 0,100% calc(100% - 6px),calc(100% - 6px) 100%,0 100%,0 6px);
        }
        .step-item.active .step-num{background:rgba(0,0,0,.3);border-color:rgba(255,255,255,.3)}
        .step-item.done .step-num{background:var(--success);border-color:var(--text);color:#000}
        .step-item.done .step-num::after{content:'âœ“'}
        .step-info{flex:1}
        .step-title{font-size:12px;font-weight:600;letter-spacing:0.5px}
        .step-desc{font-size:10px;color:var(--dim);margin-top:2px}
        .step-item.active .step-desc{color:rgba(255,255,255,.7)}
        
        /* Center - Content */
        .panel-center{padding:24px;overflow-y:auto;background:var(--bg)}
        
        .content-card{
            background:var(--surface);
            border:1px solid var(--border);
            padding:28px;
            margin-bottom:20px;
            position:relative;
            clip-path:polygon(0 0,calc(100% - 20px) 0,100% 20px,100% 100%,20px 100%,0 calc(100% - 20px));
        }
        .content-card::before{
            content:'';position:absolute;top:0;left:0;right:0;height:2px;
            background:linear-gradient(90deg,var(--primary),var(--pink),var(--primary));
        }
        .content-card::after{
            content:'';position:absolute;top:20px;right:0;width:2px;height:calc(100% - 20px);
            background:linear-gradient(180deg,var(--primary),transparent);
        }
        .content-card h3{
            font-family:'Orbitron',monospace;
            font-size:14px;font-weight:600;
            letter-spacing:2px;text-transform:uppercase;
            margin-bottom:20px;
            display:flex;align-items:center;gap:10px;
            color:var(--text);
        }
        .content-card h3 .icon{font-size:18px}
        
        .form-group{margin-bottom:20px}
        .form-label{
            display:block;
            font-family:'Orbitron',monospace;
            font-size:9px;color:var(--primary);
            text-transform:uppercase;letter-spacing:2px;
            margin-bottom:10px;
        }
        .form-input{
            width:100%;padding:14px 16px;
            background:var(--bg);
            border:1px solid var(--border);
            color:var(--text);font-size:13px;
            transition:all .3s;
            clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));
        }
        .form-input:focus{
            outline:none;
            border-color:var(--primary);
            box-shadow:var(--glow-sm);
        }
        textarea.form-input{min-height:200px;resize:vertical;font-family:inherit}
        
        .btn{
            padding:12px 28px;
            background:var(--surface2);
            border:1px solid var(--border);
            color:var(--text);
            font-family:'Orbitron',monospace;
            font-size:11px;font-weight:500;
            letter-spacing:1px;text-transform:uppercase;
            cursor:pointer;
            transition:all .3s;
            clip-path:polygon(8px 0,100% 0,100% calc(100% - 8px),calc(100% - 8px) 100%,0 100%,0 8px);
            position:relative;
            overflow:hidden;
        }
        .btn::before{
            content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
            background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);
            transition:left .5s;
        }
        .btn:hover{
            border-color:var(--primary);
            background:var(--surface);
            box-shadow:var(--glow-sm);
        }
        .btn:hover::before{left:100%}
        
        .btn-primary{
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
            border-color:var(--primary);
            color:#fff;
            box-shadow:var(--glow-sm);
        }
        .btn-primary:hover{
            box-shadow:var(--glow-md);
            transform:translateY(-1px);
        }
        .btn-back{
            background:transparent;
            border:1px solid var(--border);
            color:var(--dim);
            margin-right:12px;
        }
        .btn-back:hover{
            background:var(--surface2);
            color:var(--text);
            border-color:var(--dim);
        }
        
        .quick-reply{
            background:var(--surface2);
            border:1px solid var(--border);
            color:var(--dim);
            padding:8px 14px;
            font-size:11px;
            cursor:pointer;
            transition:all .2s;
            clip-path:polygon(5px 0,100% 0,100% calc(100% - 5px),calc(100% - 5px) 100%,0 100%,0 5px);
        }
        .quick-reply:hover{
            background:var(--primary);
            border-color:var(--primary);
            color:#fff;
            box-shadow:var(--glow-sm);
        }
        .btn-group{display:flex;gap:12px;margin-top:24px}
        
        /* Report Sections */
        .report{
            background:var(--surface2);
            border:1px solid var(--border);
            padding:20px;margin:20px 0;
            position:relative;
            clip-path:polygon(0 0,calc(100% - 15px) 0,100% 15px,100% 100%,15px 100%,0 calc(100% - 15px));
        }
        .report::before{
            content:'';position:absolute;top:0;left:0;width:100%;height:1px;
            background:linear-gradient(90deg,var(--primary),transparent);
        }
        .report h4{
            font-family:'Orbitron',monospace;
            font-size:10px;color:var(--primary);
            letter-spacing:2px;text-transform:uppercase;
            margin-bottom:16px;
        }
        .report-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px}
        .stat-box{
            background:var(--bg);
            border:1px solid var(--border);
            padding:16px 12px;
            text-align:center;
            position:relative;
            clip-path:polygon(5px 0,100% 0,100% calc(100% - 5px),calc(100% - 5px) 100%,0 100%,0 5px);
        }
        .stat-val{
            font-family:'Orbitron',monospace;
            font-size:26px;font-weight:700;
            color:var(--primary);
            text-shadow:0 0 20px var(--primary-glow);
        }
        .stat-label{font-size:9px;color:var(--dim);margin-top:6px;text-transform:uppercase;letter-spacing:1px}
        
        .item-card{
            background:var(--bg);
            border:1px solid var(--border);
            padding:16px;margin:12px 0;
            transition:all .3s;
            clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));
        }
        .item-card:hover{
            border-color:var(--primary);
            box-shadow:var(--glow-sm);
        }
        .item-card h5{font-size:13px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .item-card p{font-size:12px;color:var(--dim);margin:6px 0}
        .tag{
            display:inline-block;
            padding:4px 10px;
            background:var(--surface);
            border:1px solid var(--border);
            font-family:'Orbitron',monospace;
            font-size:9px;
            color:var(--dim);
            margin:3px;
            letter-spacing:0.5px;
        }
        
        /* èµ·æ‰¿è½¬åˆå¾½ç«  */
        .phase-badge{
            display:inline-block;
            padding:4px 12px;
            border-radius:12px;
            font-size:11px;
            font-weight:bold;
            margin:3px;
            letter-spacing:1px;
        }
        .phase-qi{background:linear-gradient(135deg,#4CAF50,#2E7D32);color:#fff;} /* èµ·-ç»¿è‰² å¼€ç«¯ */
        .phase-cheng{background:linear-gradient(135deg,#2196F3,#1565C0);color:#fff;} /* æ‰¿-è“è‰² å‘å±• */
        .phase-zhuan{background:linear-gradient(135deg,#FF5722,#D84315);color:#fff;} /* è½¬-æ©™è‰² è½¬æŠ˜ */
        .phase-he{background:linear-gradient(135deg,#9C27B0,#6A1B9A);color:#fff;} /* åˆ-ç´«è‰² ç»“å±€ */
        .phase-other{background:var(--surface);border:1px solid var(--border);color:var(--dim);}
        
        /* Right Panel - Output */
        .panel-right{
            background:linear-gradient(270deg,var(--surface) 0%,var(--bg) 100%);
            border-left:1px solid var(--border);
            padding:20px;overflow-y:auto;
            position:relative;
        }
        .panel-right::before{
            content:'';position:absolute;top:0;left:0;width:1px;height:100%;
            background:linear-gradient(180deg,var(--primary),transparent 30%,transparent 70%,var(--primary));
        }
        .panel-right h2{
            font-family:'Orbitron',monospace;
            font-size:10px;color:var(--primary);
            text-transform:uppercase;letter-spacing:3px;
            margin-bottom:16px;
        }
        
        .output-section{margin-bottom:24px}
        .output-file{display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface2);border-radius:var(--radius-sm);margin-bottom:8px;font-size:12px}
        .output-file .icon{color:var(--dim)}
        .output-file .name{flex:1}
        .output-file .size{color:var(--dim)}
        
        .export-btn{
            width:100%;padding:14px;
            background:var(--surface);
            border:1px solid var(--border);
            color:var(--text);
            font-family:'Orbitron',monospace;
            font-size:10px;
            letter-spacing:1px;
            text-transform:uppercase;
            cursor:pointer;
            margin-bottom:8px;
            display:flex;align-items:center;justify-content:center;gap:10px;
            transition:all .3s;
            clip-path:polygon(8px 0,100% 0,100% calc(100% - 8px),calc(100% - 8px) 100%,0 100%,0 8px);
            position:relative;
        }
        .export-btn::before{
            content:'';position:absolute;left:0;top:0;width:100%;height:100%;
            background:linear-gradient(90deg,transparent,rgba(255,10,53,.1),transparent);
            transform:translateX(-100%);transition:transform .3s;
        }
        .export-btn:hover{
            border-color:var(--text);color:var(--text);
            box-shadow:0 0 20px rgba(255,10,53,.2);
        }
        .export-btn:hover::before{transform:translateX(100%)}
        
        /* Storyboard Table - Cyberpunk Style */
        .storyboard-table{width:100%;border-collapse:collapse;font-size:11px}
        .storyboard-table th,.storyboard-table td{
            padding:12px;text-align:left;
            border-bottom:1px solid var(--border);
        }
        .storyboard-table th{
            background:var(--surface);
            color:var(--primary);
            font-family:'Orbitron',monospace;
            font-size:9px;font-weight:500;
            letter-spacing:1px;text-transform:uppercase;
        }
        .storyboard-table tr{transition:all .2s}
        .storyboard-table tr:hover{
            background:var(--surface);
            box-shadow:inset 3px 0 0 var(--primary);
        }
        .shot-id{
            font-family:'Orbitron',monospace;
            color:var(--primary);font-weight:600;
            text-shadow:0 0 10px var(--primary-glow);
        }
        .shot-type{padding:4px 10px;font-size:9px;font-family:'Orbitron',monospace;letter-spacing:0.5px}
        .shot-type.narrative{background:rgba(255,10,53,.15);color:var(--text);border:1px solid rgba(255,10,53,.3)}
        .shot-type.dramatic{background:rgba(255,10,53,.15);color:var(--primary);border:1px solid rgba(255,10,53,.3)}
        .shot-type.emotional{background:rgba(255,10,120,.15);color:var(--primary);border:1px solid rgba(255,10,120,.3)}
        
        /* Agent Thinking Animation - Cyberpunk */
        .agent-thinking{
            background:var(--surface);
            border:1px solid var(--border);
            padding:24px;margin:20px 0;
            position:relative;
            clip-path:polygon(0 0,calc(100% - 15px) 0,100% 15px,100% 100%,15px 100%,0 calc(100% - 15px));
        }
        .agent-thinking::before{
            content:'';position:absolute;top:0;left:0;right:0;height:2px;
            background:linear-gradient(90deg,var(--primary),var(--cyan),var(--primary));
            animation:scanline 2s linear infinite;
        }
        @keyframes scanline{
            0%{background-position:0% 0}
            100%{background-position:200% 0}
        }
        .agent-thinking-header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
        .agent-avatar{
            width:56px;height:56px;
            background:linear-gradient(135deg,var(--primary),var(--pink));
            display:flex;align-items:center;justify-content:center;
            font-size:28px;
            clip-path:polygon(15% 0,85% 0,100% 15%,100% 85%,85% 100%,15% 100%,0 85%,0 15%);
            animation:avatarPulse 2s infinite;
            box-shadow:0 0 30px var(--primary-glow);
        }
        @keyframes avatarPulse{
            0%,100%{box-shadow:0 0 20px var(--primary-glow)}
            50%{box-shadow:0 0 40px var(--primary-glow)}
        }
        .agent-name{
            font-family:'Orbitron',monospace;
            font-weight:600;font-size:14px;
            letter-spacing:1px;
        }
        .agent-status{
            font-family:'Orbitron',monospace;
            font-size:10px;color:var(--dim);
            display:flex;align-items:center;gap:8px;
            letter-spacing:1px;
        }
        .agent-status::before{
            content:'';width:8px;height:8px;
            background:var(--cyan);
            clip-path:polygon(50% 0,100% 50%,50% 100%,0 50%);
            animation:statusBlink 1s infinite;
        }
        @keyframes statusBlink{0%,100%{opacity:1}50%{opacity:0.3}}
        .thinking-process{font-size:12px;color:var(--dim);line-height:2}
        .thinking-step{
            display:flex;gap:10px;margin:10px 0;
            opacity:0;animation:fadeIn 0.5s forwards;
            padding:8px 12px;
            background:var(--bg);
            border-left:2px solid var(--border);
        }
        .thinking-step::before{content:'â–¹';color:var(--primary);flex-shrink:0}
        .thinking-step.done{border-left-color:var(--text)}
        .thinking-step.done::before{content:'â–¸';color:var(--text)}
        .thinking-step.current{border-left-color:var(--dim);color:#fff}
        .thinking-dots{display:inline-flex;gap:4px;margin-left:8px}
        .thinking-dots span{
            width:6px;height:6px;background:var(--primary);
            clip-path:polygon(50% 0,100% 50%,50% 100%,0 50%);
            animation:dotBounce 1.4s infinite;
        }
        .thinking-dots span:nth-child(2){animation-delay:0.2s}
        .thinking-dots span:nth-child(3){animation-delay:0.4s}
        
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
        @keyframes fadeIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
        @keyframes dotBounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}
        @keyframes typing{from{width:0}to{width:100%}}
        
        .typewriter{overflow:hidden;white-space:nowrap;animation:typing 2s steps(40,end)}
        .chain-of-thought{
            background:var(--bg);padding:16px;margin:16px 0;
            border:1px solid var(--border);
            border-left:3px solid var(--primary);
            font-size:12px;line-height:1.8;
        }
        .chain-of-thought .step{margin:10px 0;padding-left:20px;position:relative}
        .chain-of-thought .step::before{content:'â€º';position:absolute;left:0;color:var(--dim);font-weight:bold}
        .chain-of-thought .conclusion{
            color:var(--primary);font-weight:600;
            margin-top:16px;padding-top:16px;
            border-top:1px solid var(--border);
            font-family:'Orbitron',monospace;
            letter-spacing:0.5px;
        }
        
        /* Subject Card - Cyberpunk */
        .subject-card{
            background:var(--bg);
            border:1px solid var(--border);
            padding:14px;margin:10px 0;
            transition:all .3s;
            clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));
        }
        .subject-card:hover{border-color:var(--primary);box-shadow:var(--glow-sm)}
        .subject-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
        .subject-type{
            padding:4px 10px;
            font-family:'Orbitron',monospace;
            font-size:8px;font-weight:500;
            letter-spacing:1px;text-transform:uppercase;
        }
        .subject-type.person{background:rgba(128,128,128,.15);color:var(--dim);border:1px solid rgba(128,128,128,.3)}
        .subject-type.animal{background:rgba(128,128,128,.15);color:var(--dim);border:1px solid rgba(128,128,128,.3)}
        .subject-type.crowd{background:rgba(128,128,128,.15);color:var(--dim);border:1px solid rgba(128,128,128,.3)}
        .subject-name{font-weight:600;letter-spacing:0.5px}
        .subject-detail{font-size:11px;color:var(--dim);margin:6px 0}
        .subject-detail strong{color:var(--text)}
        .dialogue-box{
            background:var(--surface);padding:12px;
            margin-top:10px;
            border-left:3px solid var(--primary);
        }
        .dialogue-box .speaker{
            font-family:'Orbitron',monospace;
            font-size:9px;color:var(--dim);
            margin-bottom:6px;letter-spacing:1px;
        }
        .dialogue-box .line{font-style:italic;color:var(--text)}
        
        /* Scene Card - Cyberpunk */
        .scene-card{
            background:var(--bg);
            border:1px solid var(--border);
            padding:14px;margin:10px 0;
            clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));
        }
        .scene-header{
            font-family:'Orbitron',monospace;
            font-weight:600;margin-bottom:12px;
            font-size:12px;letter-spacing:0.5px;
        }
        .scene-detail{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:10px}
        .scene-detail span{padding:8px 10px;background:var(--surface);border:1px solid var(--border)}
        .scene-detail .label{color:var(--dim);font-family:'Orbitron',monospace;font-size:8px;letter-spacing:1px}
        .scene-detail .value{color:var(--text)}
        
        /* Prompt Box - Cyberpunk */
        .prompt-box{
            background:var(--bg);
            border:1px solid var(--border);
            padding:14px;margin:10px 0;
            font-family:'Fira Code','Consolas',monospace;
            font-size:11px;color:var(--dim);
            word-break:break-all;
            position:relative;
        }
        .prompt-box::before{
            content:'PROMPT';
            position:absolute;top:-8px;left:10px;
            background:var(--bg);padding:0 8px;
            font-family:'Orbitron',monospace;
            font-size:8px;color:var(--primary);
            letter-spacing:2px;
        }
        .prompt-label{
            font-family:'Orbitron',monospace;
            font-size:9px;color:var(--dim);
            margin-bottom:8px;
            display:flex;align-items:center;gap:8px;
            letter-spacing:1px;
        }
        
        /* Tabs - Cyberpunk */
        .tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:24px}
        .tab{
            padding:14px 24px;
            font-family:'Orbitron',monospace;
            font-size:10px;
            letter-spacing:1px;text-transform:uppercase;
            color:var(--dim);cursor:pointer;
            border-bottom:2px solid transparent;
            transition:all .3s;
            position:relative;
        }
        .tab::before{
            content:'';position:absolute;bottom:0;left:50%;width:0;height:2px;
            background:var(--primary);transition:all .3s;transform:translateX(-50%);
        }
        .tab:hover{color:var(--text)}
        .tab:hover::before{width:100%}
        .tab.active{color:var(--primary);border-bottom-color:var(--primary)}
        .tab.active::before{width:100%}
        
        /* Progress Bar - Cyberpunk */
        .progress-wrap{margin-bottom:28px}
        .progress-bar{
            height:6px;
            background:var(--surface);
            border:1px solid var(--border);
            overflow:hidden;
            position:relative;
        }
        .progress-bar::before{
            content:'';position:absolute;top:0;left:0;width:100%;height:100%;
            background:repeating-linear-gradient(90deg,transparent,transparent 10px,rgba(255,255,255,.03) 10px,rgba(255,255,255,.03) 20px);
        }
        .progress-fill{
            height:100%;
            background:linear-gradient(90deg,var(--primary),var(--pink),var(--primary));
            background-size:200% 100%;
            animation:progressGlow 2s linear infinite;
            transition:width .5s;
            box-shadow:0 0 20px var(--primary-glow);
        }
        @keyframes progressGlow{0%{background-position:0% 0}100%{background-position:200% 0}}
        .progress-text{
            font-family:'Orbitron',monospace;
            font-size:10px;color:var(--dim);
            margin-top:10px;text-align:center;
            letter-spacing:2px;
        }
        
        /* Loading - Cyberpunk */
        .loading{display:flex;align-items:center;justify-content:center;gap:16px;padding:50px;color:var(--dim)}
        .spinner{
            width:28px;height:28px;
            border:2px solid var(--surface);
            border-top-color:var(--primary);
            border-right-color:var(--primary);
            animation:spin 1s linear infinite;
            clip-path:polygon(50% 0,100% 25%,100% 75%,50% 100%,0 75%,0 25%);
        }
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-spinner{width:24px;height:24px;border:3px solid var(--surface2);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        
        /* Neon Text Effect */
        .neon-text{
            color:var(--primary);
            text-shadow:0 0 10px var(--primary-glow),0 0 20px var(--primary-glow),0 0 40px var(--primary-glow);
        }
        
        /* Responsive */
        @media(max-width:1200px){.main{grid-template-columns:1fr}.panel-left,.panel-right{display:none}}
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <div>
            <div class="logo">FIZZDRAGON_</div>
            <div style="font-family:'Orbitron',monospace;font-size:9px;color:var(--dim);margin-top:6px;letter-spacing:3px;text-transform:uppercase">AIç•ªåŠ‡ç³»çµ± // Cyberpunk Edition</div>
        </div>
        <div style="text-align:center">
            <div style="font-family:'Orbitron',monospace;font-size:10px;color:var(--dim);letter-spacing:2px">3-15 MIN/EP Â· AIå‹•æ…‹æ¼«ç•«</div>
            <div style="font-size:8px;color:var(--dim);margin-top:4px;letter-spacing:1px">NOT BRAINLESS SHORT DRAMA</div>
        </div>
        <div class="header-info">
            <span class="badge" id="novelStats">STANDBY</span>
            <span class="badge">30 AGENTS</span>
        </div>
    </header>
    
    <main class="main">
        <!-- Left Panel: Steps -->
        <aside class="panel-left">
            <h2>ğŸ“‹ è£½ä½œæµç¨‹</h2>
            <ul class="step-list" id="stepList"></ul>
            
            <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
                <h2>ğŸ“Š ç•¶å‰é€²åº¦</h2>
                <div class="progress-wrap">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
                    <div class="progress-text" id="progressText">0% - æº–å‚™é–‹å§‹</div>
                </div>
            </div>
        </aside>
        
        <!-- Center: Content -->
        <section class="panel-center" id="contentArea">
            <!-- Dynamic content will be inserted here -->
        </section>
        
        <!-- Right Panel: Output -->
        <aside class="panel-right">
            <!-- æ™ºèƒ½é«” + æŠ€èƒ½æ¸…å–® -->
            <div id="agentSkillsPanel" style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)">
                <h2>ğŸ¤– ç•¶å‰æ™ºèƒ½é«”</h2>
                <div id="currentAgentInfo"></div>
            </div>
            
            <h2>ğŸ“ è¼¸å‡ºæ–‡æª”</h2>
            <div id="outputFiles"></div>
            
            <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
                <h2>ğŸ“¤ å°å‡º</h2>
                <button class="export-btn" onclick="exportExcel()">ğŸ“Š å°å‡ºExcelåˆ†é¡è¡¨</button>
                <button class="export-btn" onclick="exportJSON()">ğŸ“„ å°å‡ºJSONå®Œæ•´æ•¸æ“š</button>
                <button class="export-btn" onclick="exportPDF()">ğŸ“‘ å°å‡ºPDFå ±å‘Š</button>
                <button class="export-btn" onclick="exportPrompts()">ğŸ–¼ï¸ å°å‡ºPrompts</button>
                <button class="export-btn" onclick="exportAppearanceTable()">ğŸ‘¥ å°å‡ºè§’è‰²å‡ºå ´è¡¨</button>
            </div>
        </aside>
    </main>
</div>

<script>
// ==================== ç‰ˆæœ¬é…ç½® ====================
const VERSIONS = {
    lite: {
        name: 'âš¡ æ¥µé€Ÿç‰ˆ',
        desc: '2 Skills | 7æ­¥é©Ÿ | ~2åˆ†é˜',
        steps: [1, 3, 4, 5, 6, 9, 10],  // è·³éè¨ªè«‡(2)ã€æœåŒ–é“(7)ã€ç« ç¯€åŠ‡æœ¬(8)
        maxSkills: 2,
        contentLimit: 2000,
        storyboardQuality: 'å¿«é€Ÿ',
        storyboardModel: 'haiku',
        estimatedTime: '2åˆ†é˜',
        costDeepSeek: '$0.003',
        costClaude: '$0.01'
    },
    standard: {
        name: 'â­ æ¨™æº–ç‰ˆ',
        desc: '5 Skills | 9æ­¥é©Ÿ | ~4åˆ†é˜',
        steps: [1, 2, 3, 4, 5, 6, 7, 9, 10],  // è·³éç« ç¯€åŠ‡æœ¬(8)
        maxSkills: 5,
        contentLimit: 4000,
        storyboardQuality: 'æ¨™æº–',
        storyboardModel: 'sonnet',
        estimatedTime: '4åˆ†é˜',
        costDeepSeek: '$0.005',
        costClaude: '$0.25'
    },
    pro: {
        name: 'ğŸ¬ å°ˆæ¥­ç‰ˆ',
        desc: '8 Skills | 10æ­¥é©Ÿ | ~6åˆ†é˜',
        steps: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
        maxSkills: 8,
        contentLimit: 6000,
        storyboardQuality: 'å°ˆæ¥­',
        storyboardModel: 'opus',
        estimatedTime: '6åˆ†é˜',
        costDeepSeek: '$0.008',
        costClaude: '$1.50+'
    }
};

let currentVersion = 'lite';  // é»˜èªæ¥µé€Ÿç‰ˆ

const ALL_STEPS = [
    {id:1, name:'å°å…¥å°èªª', desc:'ä¸Šå‚³æˆ–è²¼å…¥å°èªª', icon:'ğŸ“–'},
    {id:2, name:'å‰µæ„è¨ªè«‡', desc:'æ·±å…¥äº†è§£æ•…äº‹', icon:'ğŸ¤'},
    {id:3, name:'é«˜æ¦‚å¿µ', desc:'Loglineå’Œé¡å‹', icon:'ğŸ’¡'},
    {id:4, name:'ç« ç¯€æ‹†åˆ†', desc:'æ™ºèƒ½åˆ†æçµæ§‹', icon:'ğŸ“‘'},
    {id:5, name:'è§’è‰²è¨­è¨ˆ', desc:'ä¸»è§’+é…è§’', icon:'ğŸ‘¥'},
    {id:6, name:'ç•«é¢¨é¸æ“‡', desc:'é¸æ“‡è¦–è¦ºé¢¨æ ¼', icon:'ğŸ¨'},
    {id:7, name:'æœåŒ–é“', desc:'æœè£é“å…·è¨­è¨ˆ', icon:'ğŸ‘”'},
    {id:8, name:'ç« ç¯€åŠ‡æœ¬', desc:'åˆ†å ´åŠ‡æœ¬', icon:'âœï¸'},
    {id:9, name:'åˆ†é¡è¨­è¨ˆ', desc:'å ´æ™¯+Prompt', icon:'ğŸ¬'},
    {id:10, name:'å®Œæˆè¼¸å‡º', desc:'å°å‡ºè³‡æ–™', icon:'ğŸ‰'}
];

// æ ¹æ“šç‰ˆæœ¬éæ¿¾æ­¥é©Ÿ
function getSteps() {
    const version = VERSIONS[currentVersion];
    return ALL_STEPS.filter(s => version.steps.includes(s.id));
}

// å…¼å®¹èˆŠä»£ç¢¼
const STEPS = ALL_STEPS;

// ==================== AIæ·±åº¦é˜…è¯»ç³»ç»Ÿ ====================
// å‰µæ„è¨ªè«‡å¸«å…ˆé–±è®€å°è¯´ï¼Œç†è§£å†…å®¹åå†è®¾è®¡é’ˆå¯¹æ€§é—®é¢˜

// ç”ŸæˆAIåˆ†æPromptï¼ˆè®©ç”¨æˆ·å¤åˆ¶åˆ°ChatGPT/Claudeï¼‰
function generateAnalysisPrompt() {
    const novel = state.novel;
    if (!novel?.text) return '';
    
    // å–å°è¯´æ‘˜è¦ï¼ˆå¼€å¤´ + ä¸­é—´ + ç»“å°¾ï¼‰
    const text = novel.text;
    const len = text.length;
    const sampleStart = text.substring(0, Math.min(3000, len));
    const sampleMid = len > 8000 ? text.substring(Math.floor(len/2) - 1500, Math.floor(len/2) + 1500) : '';
    const sampleEnd = len > 5000 ? text.substring(len - 2000) : '';
    
    return `ä½ æ˜¯ä¸€ä½è³‡æ·±ç·¨åŠ‡é¡§å•ï¼Œæ­£åœ¨é–±è®€ä¸€éƒ¨å°èªªï¼Œæº–å‚™èˆ‡å‰µä½œè€…é€²è¡Œæ·±åº¦è¨ªè«‡ã€‚

ã€å°èªªæ¨™é¡Œã€‘${novel.title || 'æœªå‘½å'}
ã€å­—æ•¸ã€‘ç´„${Math.round(len/10000*10)/10}è¬å­—

ã€å°èªªæ‘˜è¦ã€‘
---é–‹é ­---
${sampleStart}
${sampleMid ? `\n---ä¸­æ®µ---\n${sampleMid}` : ''}
${sampleEnd ? `\n---çµå°¾---\n${sampleEnd}` : ''}
---

è«‹åˆ†æé€™éƒ¨å°èªªï¼Œä»¥JSONæ ¼å¼è¿”å›ï¼š

\`\`\`json
{
  "title": "ä½œå“æ¨™é¡Œ",
  "genre": "é¡å‹ï¼ˆæ­¦ä¿ /è¨€æƒ…/æ‡¸ç–‘/æ­·å²/ç§‘å¹»ç­‰ï¼‰",
  "era": "æ™‚ä»£èƒŒæ™¯",
  "setting": "ä¸»è¦å ´æ™¯åœ°é»",
  "protagonist": {
    "name": "ä¸»è§’å§“å",
    "identity": "èº«ä»½/è·æ¥­",
    "trait": "æ ¸å¿ƒç‰¹è³ªï¼ˆä¸€å¥è©±ï¼‰",
    "want": "è¡¨é¢æƒ³è¦ä»€éº¼",
    "wound": "å…§å¿ƒå‰µå‚·/ç¼ºé™·"
  },
  "antagonist": {
    "name": "å°æ‰‹/åæ´¾å§“å",
    "identity": "èº«ä»½",
    "motivation": "å‹•æ©Ÿ"
  },
  "supporting": [
    {"name": "é…è§’1", "role": "èˆ‡ä¸»è§’é—œä¿‚", "function": "æ•˜äº‹åŠŸèƒ½"}
  ],
  "core_conflict": "ä¸€å¥è©±æè¿°æ ¸å¿ƒè¡çª",
  "theme": "ä¸»é¡Œ/æƒ³æ¢è¨çš„è­°é¡Œ",
  "key_scenes": [
    {"scene": "é—œéµå ´æ™¯1æè¿°", "why": "ç‚ºä»€éº¼é‡è¦"},
    {"scene": "é—œéµå ´æ™¯2æè¿°", "why": "ç‚ºä»€éº¼é‡è¦"},
    {"scene": "é—œéµå ´æ™¯3æè¿°", "why": "ç‚ºä»€éº¼é‡è¦"}
  ],
  "questions": [
    "åŸºæ–¼åŠ‡æƒ…çš„æ¡è¨ªå•é¡Œ1ï¼ˆé‡å°å…·é«”äººç‰©/æƒ…ç¯€ï¼‰",
    "åŸºæ–¼åŠ‡æƒ…çš„æ¡è¨ªå•é¡Œ2",
    "åŸºæ–¼åŠ‡æƒ…çš„æ¡è¨ªå•é¡Œ3",
    "åŸºæ–¼åŠ‡æƒ…çš„æ¡è¨ªå•é¡Œ4",
    "åŸºæ–¼åŠ‡æƒ…çš„æ¡è¨ªå•é¡Œ5"
  ],
  "adaptation_notes": "æ”¹ç·¨å»ºè­°ï¼ˆå“ªäº›é©åˆè¦–è¦ºåŒ–ï¼Œå“ªäº›éœ€è¦èª¿æ•´ï¼‰"
}
\`\`\`

æ³¨æ„ï¼š
1. questionså¿…é ˆæ˜¯é‡å°é€™å€‹å…·é«”æ•…äº‹çš„å•é¡Œï¼Œä¾‹å¦‚ã€Œå°çŒ´å­ç‚ºä»€éº¼é¸æ“‡é›¢é–‹è•ƒéƒ¨ï¼Ÿã€è€Œä¸æ˜¯ã€Œä¸»è§’ç‚ºä»€éº¼é›¢é–‹å®¶é„‰ï¼Ÿã€
2. å•é¡Œè¦èƒ½æŒ–æ˜å‰µä½œè€…çš„æ·±å±¤æ„åœ–ï¼Œè€Œä¸æ˜¯å°èªªè£¡å·²ç¶“å¯«æ˜çš„å…§å®¹
3. è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”`;
}

// è§£æAIè¿”å›çš„åˆ†æç»“æœ
function parseAIAnalysis(text) {
    try {
        // å°è¯•æå–JSONå—
        const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || 
                         text.match(/```\s*([\s\S]*?)\s*```/) ||
                         text.match(/\{[\s\S]*\}/);
        
        if (jsonMatch) {
            const jsonStr = jsonMatch[1] || jsonMatch[0];
            return JSON.parse(jsonStr);
        }
    } catch (e) {
        console.error('è§£æAIåˆ†æå¤±æ•—:', e);
    }
    return null;
}

// åŸºäºAIåˆ†æç”ŸæˆçœŸæ­£é’ˆå¯¹æ€§çš„é‡‡è®¿é—®é¢˜
function generateQuestionsFromAnalysis(analysis) {
    const questions = [];
    
    // å¦‚æœAIå·²ç»ç”Ÿæˆäº†é—®é¢˜ï¼Œç›´æ¥ä½¿ç”¨
    if (analysis.questions && analysis.questions.length > 0) {
        analysis.questions.forEach((q, i) => {
            questions.push({
                id: `ai_q_${i}`,
                layer: 'ğŸ¤– AIé–±è®€ç†è§£',
                question: q,
                usedBy: ['æ‰€æœ‰æ™ºèƒ½é«”'],
                example: 'ğŸ’¡ é€™æ˜¯AIåŸºæ–¼å°èªªå…§å®¹ç”Ÿæˆçš„é‡å°æ€§å•é¡Œ',
                fromAI: true
            });
        });
    }
    
    // è¡¥å……åŸºäºåˆ†æçš„ç»“æ„åŒ–é—®é¢˜
    const p = analysis.protagonist;
    if (p?.name) {
        questions.push({
            id: 'char_design',
            layer: 'â‘¡ è§’è‰²è¨­è¨ˆ',
            question: `ã€Œ${p.name}ã€${p.trait ? `è¢«è¨­å®šç‚º${p.trait}` : ''}ï¼Œé€™å€‹è§’è‰²çš„åŸå‹ä¾†è‡ªå“ªè£¡ï¼Ÿç‚ºä»€éº¼é¸æ“‡é€™æ¨£çš„è¨­å®šï¼Ÿ`,
            usedBy: ['ğŸ‘¤è§’è‰²', 'ğŸ­è¡¨æ¼”'],
            example: `ğŸ’¡ AIè­˜åˆ¥ï¼š${p.name}ï¼ˆ${p.identity || 'ä¸»è§’'}ï¼‰- ${p.trait || ''}`
        });
        
        if (p.want && p.wound) {
            questions.push({
                id: 'char_arc',
                layer: 'â‘¡ è§’è‰²è¨­è¨ˆ',
                question: `${p.name}è¡¨é¢è¿½æ±‚ã€Œ${p.want}ã€ï¼Œä½†å…§å¿ƒçš„å‚·ç—›æ˜¯ã€Œ${p.wound}ã€ã€‚é€™å…©è€…å¦‚ä½•åœ¨æ•…äº‹ä¸­ç”¢ç”Ÿå¼µåŠ›ï¼Ÿ`,
                usedBy: ['ğŸ‘¤è§’è‰²', 'âœï¸ç·¨åŠ‡'],
                example: 'ğŸ’¡ åƒè€ƒMcKeeï¼šWant vs Needçš„å·®è·å‰µé€ è§’è‰²å¼§ç·š'
            });
        }
    }
    
    // æ ¸å¿ƒå†²çªé—®é¢˜
    if (analysis.core_conflict) {
        questions.push({
            id: 'conflict',
            layer: 'â‘£ è¡çªçµæ§‹',
            question: `æ•…äº‹çš„æ ¸å¿ƒè¡çªæ˜¯ã€Œ${analysis.core_conflict}ã€ï¼Œé€™å€‹è¡çªæœ€çµ‚å¦‚ä½•è§£æ±ºï¼Ÿä½ æƒ³å‚³é”ä»€éº¼ï¼Ÿ`,
            usedBy: ['âœï¸ç·¨åŠ‡', 'ğŸ¬ç¸½å°æ¼”'],
            example: 'ğŸ’¡ AIè­˜åˆ¥çš„æ ¸å¿ƒè¡çª'
        });
    }
    
    // å…³é”®åœºæ™¯é—®é¢˜
    if (analysis.key_scenes?.length > 0) {
        const sceneNames = analysis.key_scenes.map(s => s.scene).join('ã€');
        questions.push({
            id: 'key_scenes',
            layer: 'â‘£ è¡çªçµæ§‹',
            question: `AIè­˜åˆ¥å‡ºçš„é—œéµå ´æ™¯ï¼š${sceneNames}ã€‚å¦‚æœåªèƒ½ä¿ç•™å…¶ä¸­ä¸‰å ´ï¼Œä½ æœƒæ€éº¼é¸ï¼Ÿç‚ºä»€éº¼ï¼Ÿ`,
            usedBy: ['ğŸ¬ç¸½å°æ¼”', 'ğŸ¥åˆ†é¡'],
            example: 'ğŸ’¡ é€™äº›å ´æ™¯æ˜¯æ•˜äº‹æ ¸å¿ƒï¼Œæ”¹ç·¨æ™‚éœ€è¦é‡é»è™•ç†'
        });
    }
    
    // ä¸»é¢˜é—®é¢˜
    if (analysis.theme) {
        questions.push({
            id: 'theme',
            layer: 'â‘  å‰µä½œæ„åœ–',
            question: `é€™å€‹æ•…äº‹çš„ä¸»é¡Œæ˜¯ã€Œ${analysis.theme}ã€å—ï¼Ÿé‚„æ˜¯ä½ æƒ³å¼·èª¿å…¶ä»–é¢å‘ï¼Ÿ`,
            usedBy: ['ğŸ’¡é«˜æ¦‚å¿µ', 'âœï¸ç·¨åŠ‡'],
            example: 'ğŸ’¡ AIå°ä¸»é¡Œçš„ç†è§£ï¼Œéœ€è¦å‰µä½œè€…ç¢ºèª'
        });
    }
    
    // æ”¹ç¼–è¾¹ç•Œé—®é¢˜
    questions.push({
        id: 'must_keep',
        layer: 'â‘¤ å‰µä½œé‚Šç•Œ',
        question: `æ”¹ç·¨æˆç•ªåŠ‡æ™‚ï¼Œå“ªäº›å…ƒç´ çµ•å°ä¸èƒ½å‹•ï¼Ÿï¼ˆè§’è‰²ã€å°è©ã€å ´æ™¯ã€çµå±€â€¦ï¼‰`,
        usedBy: ['ğŸ¬ç¸½å°æ¼”', 'ğŸ“šæ”¹ç·¨'],
        example: 'ğŸ’¡ æ˜ç¢ºå‰µä½œç´…ç·šï¼Œé¿å…æ”¹ç·¨åé›¢åŸæ„'
    });
    
    questions.push({
        id: 'can_change',
        layer: 'â‘¤ å‰µä½œé‚Šç•Œ',
        question: `å“ªäº›åœ°æ–¹å¯ä»¥å¤§è†½æ”¹å‹•ï¼Ÿæœ‰æ²’æœ‰åŸä½œæ²’å±•é–‹ã€å¸Œæœ›æ”¹ç·¨èƒ½è£œå……çš„ï¼Ÿ`,
        usedBy: ['ğŸ“šæ”¹ç·¨', 'âœï¸ç·¨åŠ‡'],
        example: 'ğŸ’¡ ä¾‹å¦‚ï¼šæ„Ÿæƒ…ç·šåŠ å¼·ã€é…è§’åˆä½µã€ç¯€å¥èª¿æ•´'
    });
    
    questions.push({
        id: 'reference',
        layer: 'â‘¤ é¢¨æ ¼æ–¹å‘',
        question: `æœ‰åƒè€ƒä½œå“å—ï¼Ÿå¸Œæœ›è¦–è¦ºé¢¨æ ¼æ¥è¿‘ä»€éº¼ï¼Ÿå¯ä»¥ç”¨ã€ŒA + Bã€æè¿°ã€‚`,
        usedBy: ['ğŸ¬ç¸½å°æ¼”', 'ğŸ¨ç¾è¡“', 'ğŸ–¼ï¸Prompt'],
        example: 'ğŸ’¡ ä¾‹å¦‚ï¼šã€Šç‘¯çŠæ¦œã€‹çš„æ°›åœ + ã€Šé¬¼æ»…ã€‹çš„æˆ°é¬¥ç¾å­¸'
    });
    
    return questions;
}

// å…¼å®¹æ—§ä»£ç çš„å›ºå®šé—®é¢˜ï¼ˆå¤‡ç”¨ï¼‰
const INTERVIEW_QUESTIONS_FALLBACK = [
    {id:'origin', layer:'â‘  å‰µä½œæ„åœ–', question:'ç‚ºä»€éº¼æƒ³è¬›é€™å€‹æ•…äº‹ï¼Ÿéˆæ„Ÿä¾†è‡ªå“ªè£¡ï¼Ÿ', 
     usedBy:['ğŸ’¡é«˜æ¦‚å¿µ'], example:'ğŸ’¡ è«‹æè¿°å‰µä½œçš„èµ·é»'},
    {id:'emotion', layer:'â‘  å‰µä½œæ„åœ–', question:'ä½ å¸Œæœ›è§€çœ¾çœ‹å®Œå¾Œï¼Œå¿ƒè£¡ç•™ä¸‹ä»€éº¼æ„Ÿå—ï¼Ÿ', 
     usedBy:['ğŸ’¡é«˜æ¦‚å¿µ','ğŸ¨ç¾è¡“'], example:'ğŸ’¡ æº«æš–æ²»ç™’ï¼Ÿéœ‡æ’¼åæ€ï¼Ÿçˆ½å¿«è§£å£“ï¼Ÿ'},
    {id:'must_keep', layer:'â‘¤ å‰µä½œé‚Šç•Œ', question:'æ”¹ç·¨æ™‚å“ªäº›å…ƒç´ çµ•å°ä¸èƒ½å‹•ï¼Ÿ', 
     usedBy:['ğŸ¬ç¸½å°æ¼”'], example:'ğŸ’¡ è§’è‰²ã€å°è©ã€å ´æ™¯ã€çµå±€...'},
    {id:'reference', layer:'â‘¤ é¢¨æ ¼æ–¹å‘', question:'æœ‰åƒè€ƒä½œå“å—ï¼Ÿå¸Œæœ›é¢¨æ ¼æ¥è¿‘ä»€éº¼ï¼Ÿ', 
     usedBy:['ğŸ¨ç¾è¡“','ğŸ–¼ï¸Prompt'], example:'ğŸ’¡ ç”¨ã€ŒA + Bã€æè¿°'}
];

// æ—§çš„ generateDynamicQuestions å·²ç§»è‡³ generateQuestionsFromAnalysis

// ä¸»é«”é¡å‹
const SUBJECT_TYPES = {
    person: {label:'äººç‰©', color:'primary', icon:'ğŸ‘¤'},
    animal: {label:'å‹•ç‰©', color:'dim', icon:'ğŸ¾'},
    crowd: {label:'ç¾¤æ¼”', color:'warning', icon:'ğŸ‘¥'},
    object: {label:'ç‰©é«”', color:'dim', icon:'ğŸ“¦'},
    none: {label:'ç©ºé¡', color:'dim', icon:'ğŸï¸'}
};

// ç•«é¢¨åº« - å®Œæ•´ç‰ˆ
const ART_STYLES = [
    // ========== 2Då‹•ç•« ==========
    { id: '2d_anime', name: '2Då‹•ç•«', category: '2Då‹•ç•«', prompt: 'anime style, clean lines, vibrant colors, Japanese animation', preview: 'ğŸŒ¸' },
    { id: '2d_ghibli', name: 'å‰åœåŠ›', category: '2Då‹•ç•«', prompt: 'Studio Ghibli style, hand-painted backgrounds, soft colors, whimsical', preview: 'ğŸ¯' },
    { id: '2d_makoto', name: 'æ–°æµ·èª ', category: '2Då‹•ç•«', prompt: 'Makoto Shinkai style, detailed skies, lens flare, romantic atmosphere, hyper detailed backgrounds', preview: 'â˜ï¸' },
    { id: '2d_korean', name: 'éŸ“å¼å‹•ç•«', category: '2Då‹•ç•«', prompt: 'Korean webtoon style, clean lineart, soft shading, manhwa aesthetic', preview: 'ğŸ‡°ğŸ‡·' },
    { id: '2d_shonen', name: 'ç†±è¡€å‹•ç•«', category: '2Då‹•ç•«', prompt: 'shonen anime style, dynamic poses, action lines, intense expressions', preview: 'ğŸ”¥' },
    { id: '2d_toriyama', name: 'é³¥å±±æ˜', category: '2Då‹•ç•«', prompt: 'Akira Toriyama style, Dragon Ball aesthetic, bold lines, dynamic action', preview: 'ğŸ’¥' },
    { id: '2d_vintage', name: 'å¾©å¤å‹•ç•«', category: '2Då‹•ç•«', prompt: 'vintage anime style, 80s aesthetic, soft gradients, nostalgic colors', preview: 'ğŸ“¼' },
    { id: '2d_chibi', name: 'Qç‰ˆå‹•ç•«', category: '2Då‹•ç•«', prompt: 'chibi anime style, cute proportions, big eyes, kawaii aesthetic', preview: 'ğŸ€' },
    
    // ========== 3Dé¢¨æ ¼ ==========
    { id: '3d_fantasy', name: '3Dç„å¹»', category: '3Dé¢¨æ ¼', prompt: '3D render, fantasy style, magical lighting, detailed textures, cinematic', preview: 'ğŸ”®' },
    { id: '3d_pixar', name: '3Dçš®å…‹æ–¯', category: '3Dé¢¨æ ¼', prompt: '3D animation, Pixar style, vibrant colors, expressive characters, subsurface scattering', preview: 'ğŸ¬' },
    { id: '3d_realistic', name: '3Då¯«å¯¦', category: '3Dé¢¨æ ¼', prompt: '3D realistic render, photorealistic, detailed skin textures, ray tracing', preview: 'ğŸ“¸' },
    { id: '3d_game', name: '3DéŠæˆ²', category: '3Dé¢¨æ ¼', prompt: '3D game cinematic, Unreal Engine 5, high fidelity, AAA quality', preview: 'ğŸ®' },
    { id: '3d_stylized', name: '3Dé¢¨æ ¼åŒ–', category: '3Dé¢¨æ ¼', prompt: '3D stylized render, cel shading, cartoon textures, vibrant', preview: 'ğŸ¨' },
    
    // ========== ğŸï¸ é›»å½±è³ªæ„Ÿé¡ ==========
    { id: 'film_doc', name: 'ç´€å¯¦é›»å½±', category: 'é›»å½±è³ªæ„Ÿ', prompt: 'documentary film style, natural lighting, handheld camera, authentic, 35mm film', preview: 'ğŸ“¹' },
    { id: 'film_art', name: 'æ–‡è—ç‰‡æŸ”å…‰', category: 'é›»å½±è³ªæ„Ÿ', prompt: 'art house film, soft diffused lighting, shallow depth of field, melancholic mood, 35mm', preview: 'ğŸ­' },
    { id: 'film_cyber', name: 'è³½åšæœ‹å…‹æš—èª¿', category: 'é›»å½±è³ªæ„Ÿ', prompt: 'cyberpunk cinematic, neon lights, dark atmosphere, rain, Blade Runner style, anamorphic lens', preview: 'ğŸŒƒ' },
    { id: 'film_scifi', name: 'ç§‘å¹»å†·è‰²èª¿', category: 'é›»å½±è³ªæ„Ÿ', prompt: 'sci-fi film, cold blue tones, futuristic, clean aesthetic, volumetric lighting', preview: 'ğŸš€' },
    { id: 'film_fantasy', name: 'å¥‡å¹»é«˜é£½å’Œ', category: 'é›»å½±è³ªæ„Ÿ', prompt: 'fantasy film, high saturation, magical lighting, epic scale, Lord of the Rings style', preview: 'âš”ï¸' },
    { id: 'film_vintage', name: 'å¾©å¤è† ç‰‡é¡†ç²’', category: 'é›»å½±è³ªæ„Ÿ', prompt: 'vintage film grain, 70s aesthetic, warm tones, Kodak film stock, nostalgic', preview: 'ğŸ“½ï¸' },
    { id: 'film_bw', name: 'é»‘ç™½è† ç‰‡', category: 'é›»å½±è³ªæ„Ÿ', prompt: 'black and white film, high contrast, dramatic shadows, film noir, classic cinema', preview: 'ğŸ¬' },
    { id: 'film_euro', name: 'æ­æ´²è—è¡“é›»å½±', category: 'é›»å½±è³ªæ„Ÿ', prompt: 'European art cinema, muted colors, contemplative, long takes, Tarkovsky style', preview: 'ğŸ¥' },
    
    // ========== ğŸ§ äººç‰©é€ å‹é¡ ==========
    { id: 'char_ancient', name: 'å¤è£å²è©©', category: 'äººç‰©é€ å‹', prompt: 'ancient costume drama, elaborate traditional dress, palace setting, cinematic portrait', preview: 'ğŸ‘‘' },
    { id: 'char_modern', name: 'ç¾ä»£éƒ½å¸‚', category: 'äººç‰©é€ å‹', prompt: 'modern urban style, contemporary fashion, city background, street photography', preview: 'ğŸ™ï¸' },
    { id: 'char_wasteland', name: 'å»¢åœŸæµæµªè€…', category: 'äººç‰©é€ å‹', prompt: 'post-apocalyptic wasteland, rugged clothing, weathered face, Mad Max style', preview: 'ğŸœï¸' },
    { id: 'char_warrior', name: 'å¥‡å¹»æˆ°å£«', category: 'äººç‰©é€ å‹', prompt: 'fantasy warrior, armor and weapons, battle-ready, epic hero portrait', preview: 'âš”ï¸' },
    { id: 'char_minguo', name: 'æ°‘åœ‹é¢¨æƒ…', category: 'äººç‰©é€ å‹', prompt: 'Republic of China era, 1920s-40s fashion, qipao, vintage Shanghai style', preview: 'ğŸ' },
    { id: 'char_future', name: 'æœªä¾†æˆ°å£«', category: 'äººç‰©é€ å‹', prompt: 'futuristic soldier, sci-fi armor, cybernetic enhancements, tactical gear', preview: 'ğŸ¤–' },
    { id: 'char_ethnic', name: 'ç•°åŸŸæ°‘æ—é¢¨', category: 'äººç‰©é€ å‹', prompt: 'exotic ethnic costume, traditional jewelry, cultural heritage, vibrant textiles', preview: 'ğŸŒ' },
    { id: 'char_royal', name: 'å®®å»·è¯éº—é¢¨', category: 'äººç‰©é€ å‹', prompt: 'royal court luxury, ornate costume, gold embroidery, regal elegance, palace', preview: 'ğŸ‘¸' },
    
    // ========== ğŸ¨ è¦–è¦ºé¢¨æ ¼é¡ ==========
    { id: 'vis_oil', name: 'æ²¹ç•«è³ªæ„Ÿ', category: 'è¦–è¦ºé¢¨æ ¼', prompt: 'oil painting style, thick brushstrokes, rich colors, classical art, impasto texture', preview: 'ğŸ–¼ï¸' },
    { id: 'vis_watercolor', name: 'æ°´å½©æšˆæŸ“', category: 'è¦–è¦ºé¢¨æ ¼', prompt: 'watercolor painting, soft edges, transparent layers, wet-on-wet technique', preview: 'ğŸ¨' },
    { id: 'vis_sketch', name: 'ç´ æé€Ÿå¯«', category: 'è¦–è¦ºé¢¨æ ¼', prompt: 'pencil sketch style, rough lines, crosshatching, artistic drawing', preview: 'âœï¸' },
    { id: 'vis_woodcut', name: 'ç‰ˆç•«ç·šæ¢', category: 'è¦–è¦ºé¢¨æ ¼', prompt: 'woodcut print style, bold lines, high contrast, graphic art, linocut', preview: 'ğŸªµ' },
    { id: 'vis_minimal', name: 'å…‰å½±æ¥µç°¡', category: 'è¦–è¦ºé¢¨æ ¼', prompt: 'minimalist light and shadow, high contrast, silhouette, dramatic chiaroscuro', preview: 'ğŸ’¡' },
    { id: 'vis_contrast', name: 'é«˜å°æ¯”é»‘ç™½', category: 'è¦–è¦ºé¢¨æ ¼', prompt: 'high contrast black and white, dramatic shadows, stark lighting, graphic', preview: 'â¬›' },
    { id: 'vis_dreamy', name: 'æŸ”ç„¦å¤¢å¹»', category: 'è¦–è¦ºé¢¨æ ¼', prompt: 'soft focus dreamy, gaussian blur, ethereal glow, romantic atmosphere', preview: 'ğŸ’­' },
    { id: 'vis_neon', name: 'éœ“è™¹å¤œå½±', category: 'è¦–è¦ºé¢¨æ ¼', prompt: 'neon night aesthetic, colorful lights, urban night, glowing signs, cyberpunk vibes', preview: 'ğŸŒ†' },
    
    // ========== ğŸ§  AIç‰¹æ•ˆé¡ ==========
    { id: 'ai_vangogh', name: 'æ¢µé«˜é¢¨æ ¼é·ç§»', category: 'AIç‰¹æ•ˆ', prompt: 'Van Gogh style transfer, swirling brushstrokes, Starry Night aesthetic, post-impressionist', preview: 'ğŸŒ»' },
    { id: 'ai_monet', name: 'è«å¥ˆé¢¨æ ¼é·ç§»', category: 'AIç‰¹æ•ˆ', prompt: 'Monet style transfer, impressionist, soft colors, water lilies aesthetic, dappled light', preview: 'ğŸª·' },
    { id: 'ai_surreal', name: 'è¶…ç¾å¯¦èåˆ', category: 'AIç‰¹æ•ˆ', prompt: 'surrealist composition, dreamlike fusion, impossible architecture, Dali inspired', preview: 'ğŸŒ€' },
    { id: 'ai_glitch', name: 'AIæ•…éšœç¾å­¸', category: 'AIç‰¹æ•ˆ', prompt: 'AI glitch art, digital artifacts, data corruption aesthetic, vaporwave', preview: 'ğŸ“º' },
    { id: 'ai_morph', name: 'å‹•æ…‹è®Šå½¢', category: 'AIç‰¹æ•ˆ', prompt: 'morphing transition, fluid transformation, seamless blend, AI interpolation', preview: 'ğŸ”„' },
    { id: 'ai_enhance', name: 'è¶…æ¸…å¢å¼·', category: 'AIç‰¹æ•ˆ', prompt: 'AI enhanced, ultra high definition, sharp details, 8K resolution, pristine quality', preview: 'âœ¨' },
    
    // ========== ğŸŒ åœ°åŸŸç¾å­¸é¡ ==========
    { id: 'geo_chinese', name: 'ä¸­å¼æ°´å¢¨çœŸäºº', category: 'åœ°åŸŸç¾å­¸', prompt: 'Chinese ink wash photography, traditional aesthetics, misty mountains, zen atmosphere', preview: 'ğŸ”ï¸' },
    { id: 'geo_japanese', name: 'æ—¥ç³»æ¸…æ–°çœŸäºº', category: 'åœ°åŸŸç¾å­¸', prompt: 'Japanese aesthetic, clean and fresh, soft natural light, minimalist, wabi-sabi', preview: 'ğŸŒ' },
    { id: 'geo_korean', name: 'éŸ“å¼æ¿¾é¡åŠ‡æƒ…', category: 'åœ°åŸŸç¾å­¸', prompt: 'Korean drama filter, soft skin tones, romantic lighting, K-drama aesthetic', preview: 'ğŸ‡°ğŸ‡·' },
    { id: 'geo_bollywood', name: 'å¯¶èŠå¡¢è‰²å½©', category: 'åœ°åŸŸç¾å­¸', prompt: 'Bollywood style, vibrant saturated colors, dramatic, festive, Indian cinema', preview: 'ğŸ‡®ğŸ‡³' },
    { id: 'geo_nordic', name: 'åŒ—æ­æ¥µç°¡å†·å³»', category: 'åœ°åŸŸç¾å­¸', prompt: 'Nordic minimalism, cold tones, stark landscapes, Scandinavian aesthetic, melancholic', preview: 'ğŸ‡¸ğŸ‡ª' },
    { id: 'geo_latam', name: 'æ‹‰ç¾é­”å¹»ç¾å¯¦', category: 'åœ°åŸŸç¾å­¸', prompt: 'Latin American magical realism, vibrant colors, surreal elements, Gabriel Garcia Marquez inspired', preview: 'ğŸ¦œ' },
    { id: 'geo_desert', name: 'ä¸­æ±æ²™æ¼ å²è©©', category: 'åœ°åŸŸç¾å­¸', prompt: 'Middle Eastern epic, desert landscape, golden hour, Arabian nights, Lawrence of Arabia', preview: 'ğŸœï¸' },
    { id: 'geo_african', name: 'éæ´²éƒ¨è½ç´€å¯¦', category: 'åœ°åŸŸç¾å­¸', prompt: 'African tribal documentary, earth tones, traditional culture, authentic portraits', preview: 'ğŸŒ' },
    
    // ========== ğŸ¬ å°æ¼”é¢¨æ ¼ ==========
    { id: 'dir_zhang', name: 'å¼µè—è¬€', category: 'å°æ¼”é¢¨æ ¼', prompt: 'Zhang Yimou style, high saturation red, epic composition, Chinese cinema, Hero aesthetic', preview: 'ğŸ”´' },
    { id: 'dir_wong', name: 'ç‹å®¶è¡›', category: 'å°æ¼”é¢¨æ ¼', prompt: 'Wong Kar-wai style, neon lights, blur effects, In the Mood for Love, melancholic romance', preview: 'ğŸŒƒ' },
    { id: 'dir_nolan', name: 'è«¾è˜­', category: 'å°æ¼”é¢¨æ ¼', prompt: 'Christopher Nolan style, IMAX quality, practical effects, mind-bending, Inception aesthetic', preview: 'ğŸ¯' },
    { id: 'dir_wes', name: 'ä¹Œå¾·çˆ¾æ£®', category: 'å°æ¼”é¢¨æ ¼', prompt: 'Wes Anderson style, symmetrical composition, pastel colors, whimsical, Grand Budapest aesthetic', preview: 'ğŸ€' },
    { id: 'dir_kubrick', name: 'åº«å¸ƒé‡Œå…‹', category: 'å°æ¼”é¢¨æ ¼', prompt: 'Stanley Kubrick style, one-point perspective, cold precision, 2001 Space Odyssey aesthetic', preview: 'ğŸš€' },
    { id: 'dir_tarantino', name: 'å¡”å€«è’‚è«¾', category: 'å°æ¼”é¢¨æ ¼', prompt: 'Quentin Tarantino style, bold colors, dynamic angles, pulp aesthetic, stylized violence', preview: 'ğŸ©¸' }
];

// ç‹€æ…‹
let state = {
    currentStep: 1,
    scriptMode: false,     // åŠ‡æœ¬æ¨¡å¼é–‹é—œ
    artStyle: null,        // é¸å®šçš„ç•«é¢¨
    novel: {
        text: '',
        title: '',
        wordCount: 0
    },
    aiAnalysis: null,      // AIæ·±åº¦é–±è®€åˆ†æçµæœ
    aiAnalysisRaw: '',     // åŸå§‹JSONæ–‡æœ¬
    interview: {},         // è¨ªè«‡å›ç­”
    concept: {
        logline: '',
        genre: '',
        theme: '',
        audience: ''
    },
    chapters: [],
    characters: {
        main: [],      // ä¸»è§’
        supporting: [], // é…è§’
        extras: []      // ç¾¤æ¼”
    },
    costumes: {},
    scripts: [],
    storyboard: []
};

// ==================== åˆå§‹åŒ– ====================
function init(){
    renderSteps();
    showStep(1);
    updateProgress();
    updateAgentSkillsPanel(1);
}

function renderSteps(){
    const html = STEPS.map(s => `
        <li class="step-item ${s.id === state.currentStep ? 'active' : ''} ${s.id < state.currentStep ? 'done' : ''}" 
            onclick="goToStep(${s.id})">
            <div class="step-num">${s.id < state.currentStep ? '' : s.id}</div>
            <div class="step-info">
                <div class="step-title">${s.icon} ${s.name}</div>
                <div class="step-desc">${s.desc}</div>
            </div>
        </li>
    `).join('');
    document.getElementById('stepList').innerHTML = html;
}

function updateProgress(){
    const total = STEPS.length;
    const pct = Math.round(((state.currentStep - 1) / (total - 1)) * 100);
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressText').textContent = `${pct}% - ${STEPS[state.currentStep-1]?.name || ''}`;
}

function goToStep(step){
    if(step <= state.currentStep){
        state.currentStep = step;
        renderSteps();
        showStep(step);
        updateProgress();
    }
}

function nextStep(){
    if(state.currentStep < STEPS.length){
        state.currentStep++;
        renderSteps();
        showStep(state.currentStep);
        updateProgress();
    }
}

function prevStep(){
    if(state.currentStep > 1){
        state.currentStep--;
        renderSteps();
        showStep(state.currentStep);
        updateProgress();
    }
}

// ==================== æ­¥é©Ÿå…§å®¹ ====================
function showStep(step){
    const content = document.getElementById('contentArea');
    
    switch(step){
        case 1: content.innerHTML = renderStep1(); break;
        case 2: 
            content.innerHTML = renderStepInterview(); 
            break;
        case 3: // é«˜æ¦‚å¿µ - å¦‚æœæ²’çµæœå‰‡è‡ªå‹•é‹è¡Œ
            content.innerHTML = renderStep2();
            if(!state.concept?.logline) {
                setTimeout(() => runConceptAgent(), 100);
            }
            break;
        case 4: // ç« ç¯€ - å¦‚æœæ²’çµæœå‰‡è‡ªå‹•é‹è¡Œ
            content.innerHTML = renderStep3();
            if(!state.chapters?.length || !state.chapters[0]?.summary) {
                setTimeout(() => runChapterAgent(), 100);
            }
            break;
        case 5: // è§’è‰²è¨­è¨ˆ - å¦‚æœæ²’çµæœå‰‡è‡ªå‹•é‹è¡Œ
            content.innerHTML = renderStep4();
            if(!state.characters?.main?.length) {
                setTimeout(() => runCharacterAgent(), 100);
            }
            break;
        case 6: // ç•«é¢¨é¸æ“‡ (NEW)
            content.innerHTML = renderArtStyleStep();
            break;
        case 7: // æœåŒ–é“ - å¦‚æœæ²’çµæœå‰‡è‡ªå‹•é‹è¡Œ
            content.innerHTML = renderStep5();
            if(!state.scenes?.length && !state.costumes?.length) {
                setTimeout(() => runDesignAgent(), 100);
            }
            break;
        case 8: // åŠ‡æœ¬ - å¦‚æœæ²’çµæœå‰‡è‡ªå‹•é‹è¡Œ
            content.innerHTML = renderStep6();
            if(!state.scripts?.length) {
                setTimeout(() => runScriptAgent(), 100);
            }
            break;
        case 9: // åˆ†é¡ - å¦‚æœæ²’çµæœå‰‡è‡ªå‹•é‹è¡Œ
            content.innerHTML = renderStep7();
            if(!state.storyboard?.length) {
                setTimeout(() => runStoryboardAgent(), 100);
            }
            break;
        case 10: content.innerHTML = renderStep8(); break;  // è¼¸å‡º
    }
    
    updateAgentSkillsPanel(step);
    updateOutputPanel();
}

// ==================== API é…ç½® ====================
// åç«¯æœåŠ¡å™¨åœ°å€ - å¼€å‘ç¯å¢ƒ
const API_BASE = '/api';
let apiMode = 'auto'; // å…¨è‡ªå‹•æ¨¡å¼ï¼Œä¸æ”¯æŒæ‰‹å‹•
let currentProvider = 'deepseek'; // ç•¶å‰Provider

// åˆ‡æ›AI Provider
async function switchProvider(provider) {
    try {
        const res = await fetch(`${API_BASE}/config`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ provider })
        });
        if (res.ok) {
            currentProvider = provider;
            const names = { deepseek: 'DeepSeek', anthropic: 'Claude', gemini: 'Gemini', openrouter: 'OpenRouter' };
            console.log(`âœ… Provider switched to: ${names[provider]}`);
        }
    } catch (e) {
        console.error('Failed to switch provider:', e);
    }
}

// åˆå§‹åŒ–æ™‚ç²å–ç•¶å‰Provider
async function initProvider() {
    try {
        const res = await fetch(`${API_BASE}/providers`);
        if (res.ok) {
            const data = await res.json();
            currentProvider = data.current;
            document.getElementById('providerSelect').value = currentProvider;
        }
    } catch (e) {
        console.log('Using default provider');
    }
}
// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initProvider);

// æ­¥é©Ÿæ™‚é–“ï¼ˆåƒ…ç”¨æ–¼å…§éƒ¨è¶…æ™‚æ§åˆ¶ï¼Œä¸é¡¯ç¤ºçµ¦ç”¨æˆ¶ï¼‰
const STEP_TIMES = {
    interview: 60,
    concept: 60,
    chapters: 120,
    narrative: 120,
    characters: 90,
    character: 90,
    design: 60,
    script: 60,
    screenwriter: 60,
    storyboard: 120
};

// å€’è¨ˆæ™‚å·²ç¦ç”¨ï¼ˆæ™‚é–“é ä¼°ä¸æº–ç¢ºï¼‰
let countdownInterval = null;
let countdownSeconds = 0;

// å€’è¨ˆæ™‚å‡½æ•¸ï¼ˆå·²ç¦ç”¨ï¼Œæ”¹ç‚ºåªé¡¯ç¤º"è™•ç†ä¸­"ï¼‰
function startCountdown(endpoint, statusElement) {
    // ä¸å†é¡¯ç¤ºå€’è¨ˆæ™‚ï¼Œç›´æ¥è¿”å›
    return;
    const estimatedTime = STEP_TIMES[endpoint] || 15;
    countdownSeconds = estimatedTime;
    
    // æ›´æ–°æ˜¾ç¤º
    const updateDisplay = () => {
        if (statusElement) {
            const existing = statusElement.querySelector('.countdown-timer');
            if (existing) {
                existing.textContent = `â±ï¸ é è¨ˆé‚„éœ€ ${countdownSeconds} ç§’`;
                existing.style.color = countdownSeconds <= 5 ? 'var(--success)' : 'var(--dim)';
            }
        }
    };
    
    // æ¸…é™¤ä¹‹å‰çš„å€’è®¡æ—¶
    if (countdownInterval) clearInterval(countdownInterval);
    
    countdownInterval = setInterval(() => {
        countdownSeconds--;
        if (countdownSeconds <= 0) {
            countdownSeconds = 0;
            // è¶…æ—¶åæ˜¾ç¤º"å¤„ç†ä¸­..."
            if (statusElement) {
                const existing = statusElement.querySelector('.countdown-timer');
                if (existing) existing.textContent = 'â³ è™•ç†ä¸­...';
            }
        }
        updateDisplay();
    }, 1000);
    
    updateDisplay();
    return estimatedTime;
}

// åœæ­¢å€’è¨ˆæ™‚
function stopCountdown() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
}

async function callAgent(endpoint, data, maxRetries = 2) {
    const startTime = Date.now();
    console.log(`[API] é–‹å§‹èª¿ç”¨ ${endpoint}ï¼Œæ•¸æ“šå¤§å°: ${JSON.stringify(data).length} å­—ç¯€`);
    
    for (let attempt = 1; attempt <= maxRetries + 1; attempt++) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000);
        
        try {
            const res = await fetch(`${API_BASE}/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
            console.log(`[API] ${endpoint} å®Œæˆï¼Œè€—æ™‚ ${elapsed}ç§’`);
            
            if (!res.ok) {
                const errText = await res.text();
                // 500/502/503éŒ¯èª¤å¯é‡è©¦
                if ([500, 502, 503].includes(res.status) && attempt <= maxRetries) {
                    console.log(`[API] ${endpoint} è¿”å› ${res.status}ï¼Œç¬¬${attempt}æ¬¡é‡è©¦...`);
                    await new Promise(r => setTimeout(r, 2000 * attempt)); // ç­‰å¾…2-4ç§’
                    continue;
                }
                throw new Error(`APIéŒ¯èª¤ ${res.status}: ${errText.substring(0,200)}`);
            }
            return await res.json();
        } catch (err) {
            clearTimeout(timeoutId);
            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
            
            if (err.name === 'AbortError') {
                throw new Error(`è«‹æ±‚è¶…æ™‚ï¼ˆ180ç§’ï¼‰ï¼Œå·²ç­‰å¾… ${elapsed}ç§’ã€‚è«‹æ¸›å°‘å…§å®¹æˆ–é‡è©¦ã€‚`);
            }
            
            // ç¶²çµ¡éŒ¯èª¤å¯é‡è©¦
            if (err.message.includes('Network') && attempt <= maxRetries) {
                console.log(`[API] ${endpoint} ç¶²çµ¡éŒ¯èª¤ï¼Œç¬¬${attempt}æ¬¡é‡è©¦...`);
                await new Promise(r => setTimeout(r, 2000 * attempt));
                continue;
            }
            
            console.error(`[API] ${endpoint} éŒ¯èª¤ (${elapsed}ç§’):`, err);
            throw new Error(`${endpoint} å¤±æ•—: ${err.message}`);
        }
    }
}

async function checkApiHealth() {
    try {
        // health endpointåœ¨æ ¹è·¯å¾„ï¼Œä¸åœ¨/apiä¸‹
        const res = await fetch('http://34.58.33.115:3001/api/health');
        const data = await res.json();
        // æ”¯æŒå¤šç§æ¨¡å¼ï¼šhasApiKey, hasToken, gatewayConnected
        return data.status === 'ok' && (data.hasApiKey || data.hasToken || data.gatewayConnected);
    } catch {
        return false;
    }
}

// ==================== Step 2: å‰µæ„è¨ªè«‡ ====================
let currentInterviewQ = 0;
let INTERVIEW_QUESTIONS = [];

function renderStepInterview(){
    if(!state.interview) state.interview = {};
    currentInterviewQ = 0;
    
    // å·²æœ‰AIåˆ†æçµæœ â†’ ç›´æ¥é€²å…¥è¨ªè«‡
    if(state.aiAnalysis && state.interviewReady){
        INTERVIEW_QUESTIONS = generateQuestionsFromAI(state.aiAnalysis);
        return `
            <div class="content-card">
                <h3><span class="icon">ğŸ¤</span> å‰µæ„è¨ªè«‡</h3>
                <div id="interviewArea">
                    ${renderInterviewQuestion(0)}
                </div>
            </div>
        `;
    }
    
    // é¡¯ç¤ºAgentç•Œé¢
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ¤–</span> å‰µæ„è¨ªè«‡å¸«</h3>
            
            <div id="agentStatus" style="background:var(--surface2);border-radius:8px;padding:20px;text-align:center">
                <div style="font-size:48px;margin-bottom:12px">ğŸ“–</div>
                <div style="font-size:14px;color:var(--dim);margin-bottom:16px">
                    é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œè®“AIæ·±åº¦é–±è®€å°èªª
                </div>
                <button class="btn btn-primary" onclick="runInterviewAgent()" style="padding:12px 32px;font-size:14px">
                    ğŸš€ é–‹å§‹åˆ†æ
                </button>
            </div>
            
            <div id="agentProgress" style="display:none;background:var(--surface2);border-radius:8px;padding:20px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <div class="loading-spinner"></div>
                    <div>
                        <div style="font-weight:600" id="agentStatusText">å‰µæ„è¨ªè«‡å¸« æ­£åœ¨é–±è®€å°èªª...</div>
                        <div style="font-size:12px;color:var(--dim)" id="agentSubStatus">åˆ†æè§’è‰²ã€å ´æ™¯ã€è¡çª...</div>
                    </div>
                </div>
                <div style="background:var(--bg);border-radius:4px;height:4px;overflow:hidden">
                    <div id="agentProgressBar" style="background:var(--primary);height:100%;width:0%;transition:width .5s"></div>
                </div>
                <div style="margin-top:16px;padding:12px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:4px">
                    <p style="font-size:12px;color:#ffa500;margin:0">â³ FizzDragon æ™ºèƒ½é«”è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
                </div>
                <div style="margin-top:12px;display:flex;gap:8px">
                    <button class="btn" onclick="skipInterview()" style="font-size:11px;padding:8px 16px">â­ï¸ è·³éæ­¤æ­¥é©Ÿ</button>
                    <button class="btn" onclick="location.reload()" style="font-size:11px;padding:8px 16px">ğŸ”„ åˆ·æ–°é é¢</button>
                </div>
            </div>
            
            <div id="agentResult" style="display:none"></div>
        </div>
    `;
}

// å‰µæ„è¨ªè«‡å¸«ä½¿ç”¨çš„Skillsæ¸…å–®
const INTERVIEW_SKILLS = [
    { id: 'hitchcock_truffaut', name: 'Hitchcock/Truffaut å¤§å¸«è¨ªè«‡æ³•', desc: 'é€ä½œå“æ·±åº¦åˆ†æ' },
    { id: 'metzler_creative', name: 'Metzler å‰µæ„è¨ªè«‡æ³•', desc: 'å•é¡Œé‡‘å­—å¡”è¨­è¨ˆ' },
    { id: 'seidman_depth', name: 'Seidman æ·±åº¦è¨ªè«‡æ³•', desc: 'ä¸‰éšæ®µç”Ÿå‘½æ•…äº‹' },
    { id: 'creative_vision', name: 'å‰µä½œé¡˜æ™¯æ¢ç´¢', desc: 'æŒ–æ˜æ ¸å¿ƒå‰µä½œæ„åœ–' },
    { id: 'story_development', name: 'æ•…äº‹ç™¼å±•è¿½å•', desc: 'æƒ…ç¯€é‚è¼¯èˆ‡è½‰æŠ˜' },
    { id: 'conflict', name: 'è¡çªçµæ§‹åˆ†æ', desc: 'è§’è‰²æ¬²æœ›èˆ‡éšœç¤™' }
];

async function runInterviewAgent(){
    // æ¥µé€Ÿç‰ˆè‡ªå‹•è·³éè¨ªè«‡
    if(currentVersion === 'lite'){
        console.log('æ¥µé€Ÿç‰ˆï¼šè‡ªå‹•è·³éè¨ªè«‡');
        state.interview = {
            story_summary: state.novel.title + ' - æ•…äº‹åˆ†æ',
            main_character: 'ä¸»è§’',
            key_scenes: ['é–‹å ´', 'ç™¼å±•', 'é«˜æ½®', 'çµå±€'],
            interview_questions: [
                {question: 'ä¸»è§’çš„æ ¸å¿ƒå‹•æ©Ÿï¼Ÿ', why_asking: 'ç†è§£è§’è‰²', impact: ['å…¨åŠ‡'], audience_perspective: 'è§€çœ¾èªåŒ'},
                {question: 'æ•…äº‹æ ¸å¿ƒè¡çªï¼Ÿ', why_asking: 'æˆ²åŠ‡å¼µåŠ›', impact: ['ä¸­æ®µ'], audience_perspective: 'è¡çªé©…å‹•'},
                {question: 'æœ€é‡è¦æƒ…æ„Ÿæ™‚åˆ»ï¼Ÿ', why_asking: 'æƒ…ç·’é«˜æ½®', impact: ['é«˜æ½®'], audience_perspective: 'æƒ…æ„Ÿå…±é³´'},
                {question: 'çµå±€æƒ³è¡¨é”ä»€éº¼ï¼Ÿ', why_asking: 'ä¸»é¡Œè¡¨é”', impact: ['çµå±€'], audience_perspective: 'è§€çœ¾å¸¶èµ°çš„æ€è€ƒ'}
            ]
        };
        nextStep();  // ç›´æ¥é€²å…¥ä¸‹ä¸€æ­¥
        return;
    }
    
    const statusEl = document.getElementById('agentStatus');
    const progressEl = document.getElementById('agentProgress');
    const resultEl = document.getElementById('agentResult');
    const progressBar = document.getElementById('agentProgressBar');
    const statusText = document.getElementById('agentStatusText');
    const subStatus = document.getElementById('agentSubStatus');
    
    statusEl.style.display = 'none';
    progressEl.style.display = 'block';
    progressBar.style.width = '5%';
    
    // æ¸…ç†èˆŠçš„æ­¥é©Ÿé¡¯ç¤ºå€åŸŸï¼Œé˜²æ­¢é‡è¤‡
    const oldSteps = document.getElementById('agentSteps');
    if(oldSteps) oldSteps.remove();
    
    // æ·»åŠ è©³ç´°æ­¥é©Ÿé¡¯ç¤ºå€åŸŸ
    let stepsHtml = '<div id="agentSteps" style="margin-top:16px;font-size:12px;color:var(--dim);text-align:left"></div>';
    progressEl.insertAdjacentHTML('beforeend', stepsHtml);
    const stepsEl = document.getElementById('agentSteps');
    
    const addStep = (icon, text, isActive = false) => {
        const stepHtml = `<div class="agent-step ${isActive ? 'active' : ''}" style="padding:4px 0;${isActive ? 'color:var(--primary);' : ''}">
            ${icon} ${text}
        </div>`;
        stepsEl.insertAdjacentHTML('beforeend', stepHtml);
    };
    
    try {
        // Step 1: æª¢æŸ¥é€£æ¥
        addStep('ğŸ”—', 'æ­£åœ¨å–šé†’æ™ºèƒ½é«”...', true);
        const apiOk = await checkApiHealth();
        progressBar.style.width = '10%';
        
        if (!apiOk) {
            throw new Error('FizzDragon æ™ºèƒ½é«”é€£æ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ï¼Œè«‹ç¨å¾Œé‡è©¦');
        }
        addStep('âœ…', 'æ™ºèƒ½é«”å·²å°±ç·’');
        
        // Step 2: å•Ÿå‹•å‰µæ„è¨ªè«‡å¸«
        await sleep(300);
        addStep('ğŸ¤', '<b>æ­£åœ¨èª¿ç”¨ å‰µæ„è¨ªè«‡å¸«...</b>', true);
        statusText.textContent = 'ğŸ¤ å‰µæ„è¨ªè«‡å¸« å•Ÿå‹•ä¸­';
        subStatus.textContent = 'è¼‰å…¥æ¡è¨ªæŠ€èƒ½...';
        progressBar.style.width = '15%';
        
        // Step 3: æº–å‚™æ¡è¨ª
        await sleep(400);
        addStep('ğŸ¤', 'åƒè€ƒ Hitchcock/Truffaut å¤§å¸«è¨ªè«‡æ³•è¨­è¨ˆå•é¡Œ...');
        progressBar.style.width = '30%';
        await sleep(300);
        
        // Step 4: é–±è®€å°èªª
        statusText.textContent = 'ğŸ“– æ¡è¨ªæ™ºèƒ½é«”æ­£åœ¨é–±è®€å°èªª...';
        subStatus.textContent = `åˆ†æã€Š${state.novel.title || 'å°èªª'}ã€‹`;
        addStep('ğŸ“–', `æ­£åœ¨æ·±åº¦é–±è®€ã€Š${state.novel.title || 'å°èªª'}ã€‹...`);
        progressBar.style.width = '50%';
        
        // Step 5: åˆ†æ
        await sleep(300);
        addStep('ğŸ§ ', 'æ¡è¨ªæ™ºèƒ½é«”æ­£åœ¨åˆ†æè§’è‰²å’Œæƒ…ç¯€...');
        statusText.textContent = 'ğŸ§  åˆ†æä¸­...';
        subStatus.textContent = 'è­˜åˆ¥é—œéµè§’è‰²ã€è¡çªé»ã€æƒ…æ„Ÿè½‰æŠ˜...';
        
        // é–‹å§‹å€’è¨ˆæ™‚
        startCountdown('interview', stepsEl);
        
        const apiResponse = await callAgent('interview', {
            novel: state.novel.text,
            title: state.novel.title
        });
        
        // åœæ­¢å€’è¨ˆæ™‚
        stopCountdown();
        progressBar.style.width = '80%';
        
        addStep('âœ…', 'é–±è®€å®Œæˆ');
        
        // è§£æè¿”å›çš„JSON
        let analysis;
        try {
            const resultText = apiResponse.result || apiResponse;
            if(typeof resultText === 'string'){
                // ç§»é™¤å¯èƒ½çš„markdownæ¨™è¨˜
                const cleaned = resultText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                analysis = JSON.parse(cleaned);
            } else {
                analysis = resultText;
            }
        } catch(e){
            console.error('è§£æJSONå¤±æ•—:', e);
            // å˜—è©¦ç›´æ¥ä½¿ç”¨
            analysis = apiResponse.result || apiResponse;
        }
        
        // Step 6: ç”Ÿæˆè¨ªè«‡å•é¡Œ
        addStep('â“', 'æ­£åœ¨æ ¹æ“šæ•…äº‹å…§å®¹è¨­è¨ˆæ¡è¨ªå•é¡Œ...');
        statusText.textContent = 'â“ è¨­è¨ˆå•é¡Œä¸­';
        subStatus.textContent = 'é‡å°è§’è‰²è¨­è¨ˆã€æƒ…ç¯€é‚è¼¯ã€å‰µä½œæ„åœ–æå•...';
        await sleep(500);
        
        // é¡¯ç¤ºç”Ÿæˆçš„å•é¡Œæ•¸é‡
        const qCount = analysis.interview_questions?.length || 0;
        addStep('âœ…', `å·²ç”Ÿæˆ ${qCount} å€‹é‡å°æ€§å•é¡Œ`);
        progressBar.style.width = '100%';
        
        state.aiAnalysis = analysis;
        state.interviewReady = true;
        
        // é¡¯ç¤ºæˆåŠŸ
        statusText.textContent = 'âœ… åˆ†æå®Œæˆï¼';
        subStatus.textContent = 'æº–å‚™é€²å…¥å‰µæ„è¨ªè«‡...';
        
        // è‡ªå‹•é€²å…¥è¨ªè«‡
        setTimeout(() => {
            INTERVIEW_QUESTIONS = generateQuestionsFromAI(analysis);
            showStep(2);
        }, 800);
        
    } catch (err) {
        progressEl.style.display = 'none';
        resultEl.style.display = 'block';
        resultEl.innerHTML = `
            <div style="background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.3);padding:16px;border-radius:8px;text-align:center">
                <div style="font-size:32px;margin-bottom:12px">âš ï¸</div>
                <div style="color:var(--primary);font-weight:600;margin-bottom:8px">é€£æ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦</div>
                <div style="font-size:12px;color:var(--dim);margin-bottom:16px">${err.message}</div>
                <button class="btn btn-primary" onclick="retryInterviewAgent()" style="margin-right:8px">ğŸ”„ é‡è©¦</button>
                <button class="btn" onclick="showStep(1)">â† è¿”å›</button>
            </div>
        `;
    }
}

// ç°¡å–®çš„sleepå‡½æ•¸
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function retryInterviewAgent(){
    document.getElementById('agentResult').style.display = 'none';
    document.getElementById('agentStatus').style.display = 'block';
    runInterviewAgent();
}

// è·³éè¨ªè«‡æ­¥é©Ÿï¼Œä½¿ç”¨é»˜èªå•é¡Œ
function skipInterview(){
    if(!confirm('ç¢ºå®šè·³éå‰µæ„è¨ªè«‡ï¼Ÿå°‡ä½¿ç”¨é»˜èªåˆ†æçµæœ')) return;
    
    // ä½¿ç”¨é»˜èªçš„è¨ªè«‡çµæœ
    state.interview = {
        story_summary: state.novel.title + ' - æ•…äº‹åˆ†æ',
        main_character: 'ä¸»è§’',
        key_scenes: ['é–‹å ´', 'è½‰æŠ˜', 'é«˜æ½®', 'çµå±€'],
        interview_questions: [
            {question: 'ä¸»è§’çš„æ ¸å¿ƒå‹•æ©Ÿæ˜¯ä»€éº¼ï¼Ÿ', why_asking: 'ç†è§£è§’è‰²é©…å‹•åŠ›', impact: ['å…¨åŠ‡'], audience_perspective: 'è§€çœ¾éœ€è¦èªåŒä¸»è§’'},
            {question: 'æ•…äº‹çš„æ ¸å¿ƒè¡çªæ˜¯ä»€éº¼ï¼Ÿ', why_asking: 'ç¢ºå®šæˆ²åŠ‡å¼µåŠ›ä¾†æº', impact: ['ä¸­æ®µ'], audience_perspective: 'è¡çªé©…å‹•åŠ‡æƒ…'},
            {question: 'æœ€é‡è¦çš„æƒ…æ„Ÿæ™‚åˆ»åœ¨å“ªè£¡ï¼Ÿ', why_asking: 'è¨­è¨ˆæƒ…ç·’é«˜æ½®', impact: ['é«˜æ½®'], audience_perspective: 'æƒ…æ„Ÿå…±é³´é»'},
            {question: 'çµå±€æƒ³å‚³é”ä»€éº¼è¨Šæ¯ï¼Ÿ', why_asking: 'ä¸»é¡Œè¡¨é”', impact: ['çµå±€'], audience_perspective: 'è§€çœ¾å¸¶èµ°çš„æ€è€ƒ'}
        ]
    };
    
    // ç›´æ¥é€²å…¥ä¸‹ä¸€æ­¥
    nextStep();
}

function renderErrorRetryUI(agentName, retryFn){
    return `
        <div style="background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.3);padding:20px;border-radius:12px;text-align:center">
            <div style="font-size:48px;margin-bottom:12px">âš ï¸</div>
            <div style="color:var(--primary);font-weight:600;margin-bottom:8px">${agentName} é€£æ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦</div>
            <div style="font-size:12px;color:var(--dim);margin-bottom:16px">è«‹ç¢ºèª FizzDragon æ™ºèƒ½é«” æ­£åœ¨é‹è¡Œ</div>
            <button class="btn btn-primary" onclick="${retryFn}" style="margin-right:8px">ğŸ”„ é‡è©¦</button>
            <button class="btn" onclick="prevStep()">â† è¿”å›</button>
        </div>
    `;
}

// ç”Ÿæˆçµ¦Claudeçš„åˆ†æPrompt
function generateClaudeAnalysisPrompt(){
    const novel = state.novel;
    if(!novel?.text) return '';
    
    const text = novel.text;
    const len = text.length;
    
    // å–æ¨£ï¼šé–‹é ­3000 + ä¸­é–“2000 + çµå°¾2000
    const sample1 = text.substring(0, Math.min(3000, len));
    const sample2 = len > 8000 ? text.substring(Math.floor(len/2)-1000, Math.floor(len/2)+1000) : '';
    const sample3 = len > 5000 ? text.substring(len-2000) : '';
    
    return `ä½ æ˜¯å°ˆæ¥­ç·¨åŠ‡é¡§å•ï¼Œé‹ç”¨ Hitchcock/Truffaut å¤§å¸«è¨ªè«‡æ³•ï¼Œæ·±åº¦é–±è®€é€™éƒ¨å°èªªï¼Œæº–å‚™èˆ‡å‰µä½œè€…é€²è¡Œæ·±åº¦è¨ªè«‡ã€‚

ã€å°èªªã€‘${novel.title || ''}ï¼ˆ${Math.round(len/10000*10)/10}è¬å­—ï¼‰

---é–‹é ­---
${sample1}
${sample2 ? `\n---ä¸­æ®µ---\n${sample2}` : ''}
${sample3 ? `\n---çµå°¾---\n${sample3}` : ''}
---

è«‹è¿”å›JSONï¼ˆç›´æ¥è¼¸å‡ºï¼Œä¸è¦markdownï¼‰ï¼š
{
  "title": "ä½œå“å",
  "genre": "é¡å‹",
  "era": "æ™‚ä»£èƒŒæ™¯",
  "characters": [
    {"name": "ä¸»è§’å", "role": "ä¸»è§’", "trait": "æ€§æ ¼ç‰¹é»", "want": "æƒ³è¦ä»€éº¼", "arc": "æˆé•·è®ŠåŒ–"},
    {"name": "è§’è‰²2", "role": "é…è§’/åæ´¾", "trait": "ç‰¹é»", "function": "æ•˜äº‹åŠŸèƒ½"}
  ],
  "places": [
    {"name": "åœ°é»å", "significance": "å°åŠ‡æƒ…çš„æ„ç¾©"}
  ],
  "core_conflict": "ä¸€å¥è©±æ ¸å¿ƒè¡çª",
  "key_scenes": [
    {"chapter": "ç¬¬Xç« ", "scene": "å ´æ™¯æè¿°", "emotion": "æƒ…ç·’", "importance": "ç‚ºä»€éº¼é‡è¦"}
  ],
  "themes": ["ä¸»é¡Œ1", "ä¸»é¡Œ2"],
  "interview_questions": [
    {
      "question": "é‡å°å…·é«”è§’è‰²è¨­è¨ˆçš„å•é¡Œï¼Œä¾‹å¦‚ï¼šç‚ºä»€éº¼è¦é€™æ¨£è¨­è¨ˆXXXé€™å€‹è§’è‰²ï¼Ÿ",
      "target_agent": "è§’è‰²è¨­è¨ˆå¸«",
      "purpose": "æŒ–æ˜è§’è‰²è¨­è¨ˆæ„åœ–"
    },
    {
      "question": "é‡å°å…·é«”æƒ…ç¯€çš„å•é¡Œï¼Œä¾‹å¦‚ï¼šXXXåœ¨YYYå ´æ™¯ä¸­çš„é¸æ“‡èƒŒå¾Œæœ‰ä»€éº¼è€ƒé‡ï¼Ÿ",
      "target_agent": "åŠ‡æƒ…æ¶æ§‹å¸«",
      "purpose": "ç†è§£æ•˜äº‹é‚è¼¯"
    },
    {
      "question": "é‡å°è¡çªè¨­è¨ˆçš„å•é¡Œ",
      "target_agent": "å°æ‡‰æ™ºèƒ½é«”",
      "purpose": "åˆ†ææˆ²åŠ‡å¼µåŠ›"
    },
    {
      "question": "é‡å°ä¸»é¡Œçš„å•é¡Œ",
      "target_agent": "å°æ‡‰æ™ºèƒ½é«”",
      "purpose": "æ·±æŒ–å‰µä½œæ„åœ–"
    },
    {
      "question": "é‡å°å ´æ™¯/æ°›åœçš„å•é¡Œ",
      "target_agent": "å°æ‡‰æ™ºèƒ½é«”",
      "purpose": "è¦–è¦ºå‘ˆç¾æ–¹å‘"
    },
    {
      "question": "é‡å°çµå±€/è½‰æŠ˜çš„å•é¡Œ",
      "target_agent": "å°æ¼”æ™ºèƒ½é«”",
      "purpose": "é«˜æ½®è¨­è¨ˆ"
    }
  ]
}

ã€é‡è¦ã€‘interview_questions å¿…é ˆéµå®ˆä»¥ä¸‹è¦å‰‡ï¼š
1. æ¯å€‹å•é¡Œå¿…é ˆåŒ…å«æ•…äº‹ä¸­çš„å…·é«”äººç‰©åå­—æˆ–å…·é«”æƒ…ç¯€
2. ä¾‹å¦‚ï¼šã€Œç‚ºä»€éº¼è¦æŠŠæ›¹æ“è¨­è¨ˆæˆä¸€å€‹æ„›ç¬‘çš„äººï¼Ÿã€è€Œä¸æ˜¯ã€Œä¸»è§’ç‚ºä»€éº¼é€™æ¨£ï¼Ÿã€
3. ä¾‹å¦‚ï¼šã€Œå°çŒ´å­é¸æ“‡é›¢é–‹è•ƒéƒ¨é‚£å ´æˆ²ï¼Œç‚ºä»€éº¼è¦å®‰æ’åœ¨æš´é¢¨é›¨ä¸­ï¼Ÿã€
4. å•é¡Œè¦èƒ½æŒ–æ˜å‰µä½œè€…ã€Œç‚ºä»€éº¼é€™éº¼è¨­è¨ˆã€çš„æ·±å±¤æ„åœ–
5. ä¸è¦å•å°èªªè£¡å·²ç¶“æ˜ç¢ºå¯«å‡ºç­”æ¡ˆçš„å…§å®¹
6. æ¯å€‹å•é¡Œæœƒå½±éŸ¿ä¸åŒçš„æ™ºèƒ½é«”ï¼Œæ‰€ä»¥è¦è¦†è“‹è§’è‰²ã€æƒ…ç¯€ã€è¡çªã€ä¸»é¡Œã€å ´æ™¯ã€é«˜æ½®ç­‰æ–¹é¢
7. è‡³å°‘ç”Ÿæˆ6å€‹å•é¡Œï¼Œè¶Šå…·é«”è¶Šå¥½`;
}

function copyClaudePrompt(){
    const textarea = document.getElementById('claudePrompt');
    textarea.select();
    document.execCommand('copy');
    event.target.textContent = 'âœ“ å·²è¤‡è£½';
    setTimeout(() => event.target.textContent = 'ğŸ“‹ è¤‡è£½', 2000);
}

function applyClaudeAnalysis(){
    const input = document.getElementById('claudeResult').value.trim();
    if(!input){
        alert('è«‹å…ˆè²¼å…¥æ™ºèƒ½é«”çš„åˆ†æçµæœ');
        return;
    }
    
    try {
        // å˜—è©¦è§£æJSON
        let json = input;
        // ç§»é™¤å¯èƒ½çš„markdownæ¨™è¨˜
        json = json.replace(/```json\s*/g, '').replace(/```\s*/g, '');
        const analysis = JSON.parse(json);
        
        state.aiAnalysis = analysis;
        state.aiAnalysisRaw = input;
        state.interviewReady = true;
        
        // é€²å…¥è¨ªè«‡
        showStep(2);
    } catch(e) {
        alert('JSONæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ™ºèƒ½é«”è¿”å›çš„æ˜¯æœ‰æ•ˆJSON\\n\\néŒ¯èª¤ï¼š' + e.message);
    }
}

// åŸºæ–¼AIåˆ†æç”Ÿæˆå•é¡Œ
function generateQuestionsFromAI(analysis){
    const questions = [];
    
    // å„ªå…ˆä½¿ç”¨AIç”Ÿæˆçš„å•é¡Œï¼ˆæ”¯æ´æ–°èˆŠå…©ç¨®æ ¼å¼ï¼‰
    if(analysis.interview_questions?.length){
        analysis.interview_questions.forEach((q, i) => {
            // æ–°æ ¼å¼ï¼š{question, target_agent, purpose}
            if(typeof q === 'object' && q.question){
                questions.push({
                    id: `ai_${i}`,
                    question: q.question,
                    usedBy: [q.target_agent || 'ğŸ¤– AIæ·±åº¦é–±è®€'],
                    purpose: q.purpose || '',
                    targetAgent: q.target_agent || ''
                });
            } 
            // èˆŠæ ¼å¼ï¼šç´”å­—ç¬¦ä¸²
            else if(typeof q === 'string'){
                questions.push({
                    id: `ai_${i}`,
                    question: q,
                    usedBy: ['ğŸ¤– AIæ·±åº¦é–±è®€']
                });
            }
        });
    }
    
    // å¦‚æœå•é¡Œä¸è¶³6å€‹ï¼Œè£œå……åŸºæ–¼åˆ†æçš„çµæ§‹åŒ–å•é¡Œ
    if(analysis.characters?.[0] && questions.length < 6){
        const mc = analysis.characters[0];
        if(!questions.some(q => q.question.includes(mc.name))){
            questions.push({
                id: 'char_main',
                question: `ã€Œ${mc.name}ã€${mc.trait ? 'ï¼ˆ'+mc.trait+'ï¼‰' : ''}é€™å€‹è§’è‰²ï¼ŒåŸå‹ä¾†è‡ªå“ªè£¡ï¼Ÿç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆï¼Ÿ`,
                usedBy: ['ğŸ‘¤ è§’è‰²è¨­è¨ˆå¸«'],
                targetAgent: 'è§’è‰²è¨­è¨ˆå¸«'
            });
        }
    }
    
    if(analysis.core_conflict && questions.length < 6){
        questions.push({
            id: 'conflict',
            question: `ã€Œ${analysis.core_conflict}ã€é€™å€‹è¡çªï¼Œä½ å¸Œæœ›è§€çœ¾ç«™åœ¨å“ªä¸€é‚Šï¼Ÿ`,
            usedBy: ['âœï¸ ç·¨åŠ‡æ™ºèƒ½é«”'],
            targetAgent: 'ç·¨åŠ‡æ™ºèƒ½é«”'
        });
    }
    
    // ä¿åº•å•é¡Œï¼ˆç¢ºä¿è‡³å°‘6å€‹ï¼‰
    const fallbackQuestions = [
        { id: 'must_keep', question: 'æ”¹ç·¨æ™‚å“ªäº›æƒ…ç¯€/å°è©çµ•å°ä¸èƒ½å‹•ï¼Ÿå“ªäº›å¯ä»¥å¤§è†½æ”¹ï¼Ÿ', usedBy: ['ğŸ¬ å°æ¼”æ™ºèƒ½é«”'], targetAgent: 'å°æ¼”æ™ºèƒ½é«”' },
        { id: 'style', question: 'è¦–è¦ºé¢¨æ ¼æƒ³æ¥è¿‘å“ªéƒ¨ä½œå“ï¼Ÿï¼ˆé›»å½±/å‹•ç•«/æ¼«ç•«éƒ½å¯ä»¥ï¼‰', usedBy: ['ğŸ¨ ç¾è¡“ç¸½ç›£'], targetAgent: 'ç¾è¡“ç¸½ç›£' },
        { id: 'audience', question: 'é€™å€‹æ•…äº‹æœ€æƒ³è®“å“ªç¾¤è§€çœ¾ç”¢ç”Ÿå…±é³´ï¼Ÿ', usedBy: ['ğŸ“Š å¸‚å ´åˆ†æå¸«'], targetAgent: 'å¸‚å ´åˆ†æå¸«' },
        { id: 'tone', question: 'æ•´é«”æ°›åœæ˜¯åå¯«å¯¦é‚„æ˜¯å¥‡å¹»ï¼Ÿåæ²‰é‡é‚„æ˜¯è¼•å¿«ï¼Ÿ', usedBy: ['ğŸ¬ å°æ¼”æ™ºèƒ½é«”'], targetAgent: 'å°æ¼”æ™ºèƒ½é«”' }
    ];
    
    for(const fq of fallbackQuestions){
        if(questions.length >= 6) break;
        if(!questions.some(q => q.id === fq.id)){
            questions.push(fq);
        }
    }
    
    return questions.slice(0, 10);
}

// ç›´æ¥æ ¹æ®å°è¯´å†…å®¹ç”Ÿæˆé’ˆå¯¹æ€§é—®é¢˜ï¼ˆå‚™ç”¨ï¼‰
function generateQuestionsFromNovel(){
    const novel = state.novel;
    if(!novel?.text) return INTERVIEW_QUESTIONS_FALLBACK;
    
    const text = novel.text;
    const questions = [];
    
    // ========== æ™ºèƒ½æå–æ•…äº‹å…ƒç´  ==========
    
    // 1. æå–äººç‰©å
    const namePatterns = [
        /[å¤§äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]å¨ƒ/g,  // å¤§å¨ƒã€äºŒå¨ƒ...ä¸ƒå¨ƒ
        /å°[\u4e00-\u9fa5]{1,2}(?:å­|å…’|å¦¹|å¼Ÿ|å§|å“¥|å¨˜)/g,  // å°çŒ´å­ã€å°å¦¹å­
        /[\u4e00-\u9fa5]{1,2}[é•·å¸«çˆºç‹å…¬ä¸»å¦ƒå¨˜å«‚ç²¾æ€ª]/g,  // è•ƒé•·ã€è›‡ç²¾
        /è€[\u4e00-\u9fa5]{1,2}(?:é ­|çˆº|å¤ª|äºº|æ¼¢)/g,  // è€äººã€è€çˆºã€è€æ¼¢
        /é˜¿[\u4e00-\u9fa5]{1,2}/g,  // é˜¿å¯¶ã€é˜¿å¼·
        /[\u4e00-\u9fa5]{2,3}(?:ç²¾|æ€ª|ä»™|é­”)/g,  // è›‡ç²¾ã€èå­ç²¾
    ];
    // æ’é™¤éäººç‰©è¯
    const notNames = ['å°èˆ¹','å°è·¯','å°å¾‘','å°å±‹','å°èŒ…å±‹','å°æ‘','å°é®','å°å³¶','å°å±±','å°æ²³','å°æºª','å°æ™‚','å°å¿ƒ','å°è²'];
    
    let allNames = [];
    namePatterns.forEach(p => {
        const matches = text.match(p) || [];
        allNames = allNames.concat(matches);
    });
    
    // é¢å¤–æ¨¡å¼ï¼šã€ŒXXã€èªª/é“ï¼ˆå¯¹è¯ä¸­çš„äººåï¼‰
    const dialogNames = text.match(/ã€Œ[^ã€]*ã€([\u4e00-\u9fa5]{2,4})(?:èªª|é“|å•|ç¬‘|å˜†)/g) || [];
    dialogNames.forEach(m => {
        const name = m.match(/([\u4e00-\u9fa5]{2,4})(?:èªª|é“|å•|ç¬‘|å˜†)/);
        if(name) allNames.push(name[1]);
    });
    
    const names = [...new Set(allNames)]
        .filter(n => n.length >= 2 && n.length <= 4)
        .filter(n => !notNames.includes(n))
        .slice(0, 8);
    
    // 2. æå–åœ°ç‚¹
    const placePatterns = [
        /[\u4e00-\u9fa5]{2,6}[æ‘é®åŸæ¸¯å³¶å±±å¯ºå»Ÿåºœæ®¿éƒ¨è½]/g,
        /[\u4e00-\u9fa5]{2,4}(?:æµ·|èˆ¹|ç¢¼é ­|å¸‚é›†|å®¢æ£§|é…’æ¨“)/g,
        /åœ¨([\u4e00-\u9fa5]{2,6})[ï¼Œã€‚]/g,
    ];
    let allPlaces = [];
    placePatterns.forEach(p => {
        const matches = text.match(p) || [];
        allPlaces = allPlaces.concat(matches.map(m => m.replace(/^åœ¨|[ï¼Œã€‚]$/g, '')));
    });
    const places = [...new Set(allPlaces)].filter(p => p.length >= 2).slice(0, 6);
    
    // 3. æå–å…³é”®åŠ¨ä½œ/äº‹ä»¶
    const eventPatterns = [
        /(æ±ºå®š|é¸æ“‡|é›¢é–‹|é€ƒé›¢|å›åˆ°|å‰å¾€|å°‹æ‰¾|è¿½å°‹|æ”¾æ£„|çŠ§ç‰²|èƒŒå›|ç›¸é‡|é‡é€¢|å‘Šåˆ¥|æ­»|æ®º|æ•‘|æ„›|æ¨)[\u4e00-\u9fa5]{0,6}/g,
    ];
    let allEvents = [];
    eventPatterns.forEach(p => {
        const matches = text.match(p) || [];
        allEvents = allEvents.concat(matches);
    });
    const events = [...new Set(allEvents)].slice(0, 5);
    
    // 4. æå–å¯¹è¯ç‰‡æ®µï¼ˆå¯èƒ½çš„é‡‘å¥ï¼‰
    const dialogues = text.match(/ã€Œ[^ã€]{10,30}ã€/g) || [];
    const keyDialogues = dialogues.slice(0, 3);
    
    // ========== åŸºäºæå–å…ƒç´ ç”Ÿæˆé—®é¢˜ ==========
    
    // ä¸»è§’é—®é¢˜
    if(names[0]){
        questions.push({
            id: 'q1',
            question: `ã€Œ${names[0]}ã€çš„æ ¸å¿ƒæ…¾æœ›æ˜¯ä»€éº¼ï¼ŸTAæœ€å®³æ€•ä»€éº¼ï¼Ÿ`,
            usedBy: ['ğŸ‘¤è§’è‰²']
        });
    }
    
    // è§’è‰²å…³ç³»é—®é¢˜
    if(names[0] && names[1]){
        questions.push({
            id: 'q2',
            question: `${names[0]}å’Œ${names[1]}çš„é—œä¿‚ï¼Œç¶“æ­·äº†æ€æ¨£çš„è®ŠåŒ–ï¼Ÿ`,
            usedBy: ['ğŸ‘¤è§’è‰²', 'âœï¸ç·¨åŠ‡']
        });
    }
    
    // æ›´å¤šè§’è‰²é—®é¢˜
    if(names[2]){
        questions.push({
            id: 'q3',
            question: `${names[2]}åœ¨æ•…äº‹ä¸­æ‰®æ¼”ä»€éº¼è§’è‰²ï¼Ÿç‚ºä»€éº¼éœ€è¦é€™å€‹äººç‰©ï¼Ÿ`,
            usedBy: ['ğŸ‘¤è§’è‰²']
        });
    }
    
    // åœºæ™¯é—®é¢˜
    if(places[0]){
        questions.push({
            id: 'q4',
            question: `æ•…äº‹ç‚ºä»€éº¼ç™¼ç”Ÿåœ¨ã€Œ${places[0]}ã€ï¼Ÿæ›å€‹åœ°æ–¹è¡Œä¸è¡Œï¼Ÿ`,
            usedBy: ['ğŸ¨ç¾è¡“', 'ğŸ›ï¸è€ƒæ“š']
        });
    }
    
    if(places[1]){
        questions.push({
            id: 'q5',
            question: `å¾${places[0]}åˆ°${places[1]}ï¼Œé€™æ®µæ—…ç¨‹è±¡å¾µä»€éº¼ï¼Ÿ`,
            usedBy: ['âœï¸ç·¨åŠ‡', 'ğŸ¬å°æ¼”']
        });
    }
    
    // äº‹ä»¶/å†²çªé—®é¢˜
    if(events[0]){
        questions.push({
            id: 'q6',
            question: `ã€Œ${events[0]}ã€é€™å€‹æƒ…ç¯€æ˜¯æ•…äº‹çš„è½‰æŠ˜é»å—ï¼Ÿç‚ºä»€éº¼é‡è¦ï¼Ÿ`,
            usedBy: ['âœï¸ç·¨åŠ‡']
        });
    }
    
    // å¯¹è¯/é‡‘å¥é—®é¢˜
    if(keyDialogues[0]){
        questions.push({
            id: 'q7',
            question: `${keyDialogues[0]} â€” é€™å¥è©±èƒŒå¾Œæƒ³è¡¨é”ä»€éº¼ï¼Ÿ`,
            usedBy: ['âœï¸ç·¨åŠ‡', 'ğŸ­è¡¨æ¼”']
        });
    }
    
    // ä¸»é¢˜é—®é¢˜
    questions.push({
        id: 'q8',
        question: `é€™å€‹æ•…äº‹æœ€æƒ³è®“è§€çœ¾æ€è€ƒçš„å•é¡Œæ˜¯ä»€éº¼ï¼Ÿ`,
        usedBy: ['ğŸ’¡é«˜æ¦‚å¿µ', 'ğŸ¬å°æ¼”']
    });
    
    // æƒ…æ„Ÿé—®é¢˜
    questions.push({
        id: 'q9',
        question: `æ•…äº‹ä¸­æœ€è®“ä½ æ„Ÿå‹•/éœ‡æ’¼çš„ä¸€å¹•æ˜¯ï¼Ÿç‚ºä»€éº¼ï¼Ÿ`,
        usedBy: ['ğŸ¬å°æ¼”', 'ğŸ¨ç¾è¡“']
    });
    
    // æ”¹ç¼–è¾¹ç•Œ
    questions.push({
        id: 'q10',
        question: `æ”¹ç·¨æˆç•ªåŠ‡ï¼Œå“ªäº›çµ•å°ä¸èƒ½æ”¹ï¼Ÿå“ªäº›å¯ä»¥å¤§è†½æ”¹ï¼Ÿ`,
        usedBy: ['ğŸ¬å°æ¼”', 'ğŸ“šæ”¹ç·¨']
    });
    
    // ç¡®ä¿è‡³å°‘8ä¸ªé—®é¢˜
    return questions.filter(q => q.question).slice(0, 10);
}

function renderInterviewQuestion(index){
    if(index >= INTERVIEW_QUESTIONS.length){
        return renderInterviewSummary();
    }
    
    const q = INTERVIEW_QUESTIONS[index];
    const prevAnswer = state.interview[q.id] || '';
    
    // ç²å–ç›®æ¨™Agentçš„åœ–æ¨™
    const agentIcons = {
        'è§’è‰²è¨­è¨ˆå¸«': 'ğŸ‘¤',
        'åŠ‡æƒ…æ¶æ§‹å¸«': 'ğŸ“–',
        'è¡çªè¨­è¨ˆå¸«': 'âš”ï¸',
        'ä¸»é¡Œæç…‰å¸«': 'ğŸ’¡',
        'ç¾è¡“ç¸½ç›£': 'ğŸ¨',
        'å°æ¼”æ™ºèƒ½é«”': 'ğŸ¬',
        'ç·¨åŠ‡æ™ºèƒ½é«”': 'âœï¸',
        'å¸‚å ´åˆ†æå¸«': 'ğŸ“Š'
    };
    const targetAgent = q.targetAgent || q.usedBy?.[0] || '';
    const agentIcon = agentIcons[targetAgent] || 'ğŸ¤–';
    
    return `
        <div style="background:var(--surface2);border-radius:12px;padding:20px;margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <span style="background:var(--primary);color:#fff;padding:4px 10px;border-radius:12px;font-size:11px">
                    å•é¡Œ ${index+1}/${INTERVIEW_QUESTIONS.length}
                </span>
                ${q.targetAgent ? `
                    <span style="background:rgba(255,10,53,.15);color:var(--primary);padding:4px 10px;border-radius:12px;font-size:11px;display:flex;align-items:center;gap:4px">
                        ${agentIcon} å½±éŸ¿ â†’ ${q.targetAgent}
                    </span>
                ` : ''}
            </div>
            
            <p style="font-size:18px;margin-bottom:16px;line-height:1.6;font-weight:500">${q.question}</p>
            
            ${q.purpose ? `
                <div style="font-size:11px;color:var(--warning);margin-bottom:12px;padding:8px;background:rgba(255,150,0,.1);border-radius:6px;border-left:3px solid var(--warning)">
                    ğŸ’¡ é€™å€‹å•é¡Œçš„ç›®çš„ï¼š${q.purpose}
                </div>
            ` : ''}
            
            <div style="font-size:11px;color:var(--dim);margin-bottom:12px;padding:8px;background:var(--bg);border-radius:6px;display:flex;flex-wrap:wrap;gap:6px;align-items:center">
                <span>ğŸ“¤ å›ç­”å°‡ç”¨æ–¼ï¼š</span>
                ${(q.usedBy || ['æ‰€æœ‰æ™ºèƒ½é«”']).map(a => `
                    <span style="background:var(--surface2);padding:2px 8px;border-radius:10px;font-size:10px">${a}</span>
                `).join('')}
            </div>
            
            <textarea id="interviewAnswer" class="form-input" style="min-height:100px" placeholder="è«‹è‡ªç”±å›ç­”ï¼Œè¶Šè©³ç´°è¶Šå¥½ã€‚ä¾‹å¦‚ï¼šæˆ‘æƒ³è®“é€™å€‹è§’è‰²...å› ç‚º...">${prevAnswer}</textarea>
            
            <div class="btn-group" style="margin-top:16px">
                ${index > 0 ? `<button class="btn" onclick="prevInterviewQ()">â† ä¸Šä¸€é¡Œ</button>` : `<button class="btn" onclick="prevStep()">â† è¿”å›å°å…¥</button>`}
                <button class="btn btn-primary" onclick="nextInterviewQ()">
                    ${index < INTERVIEW_QUESTIONS.length - 1 ? 'ä¸‹ä¸€é¡Œ â†’' : 'å®Œæˆè¨ªè«‡ âœ“'}
                </button>
            </div>
        </div>
        
        <div style="display:flex;gap:4px;justify-content:center">
            ${INTERVIEW_QUESTIONS.map((_, i) => `
                <div style="width:${i===index?'24px':'12px'};height:6px;background:${i<index?'var(--success)':i===index?'var(--primary)':'var(--surface2)'};border-radius:3px;transition:all .3s"></div>
            `).join('')}
        </div>
    `;
}

function renderInterviewSummary(){
    return `
        <div style="background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:12px;padding:20px;margin-bottom:16px">
            <h4 style="color:var(--text);margin-bottom:16px">âœ… è¨ªè«‡å®Œæˆï¼</h4>
            
            <div style="display:grid;gap:12px">
                ${INTERVIEW_QUESTIONS.map(q => `
                    <div style="background:var(--surface);padding:12px;border-radius:8px">
                        <div style="font-size:11px;color:var(--dim);margin-bottom:4px;display:flex;align-items:center;gap:6px">
                            ${q.fromAI ? '<span style="color:var(--dim)">ğŸ¤–</span>' : ''}
                            ${q.question}
                        </div>
                        <div style="font-size:13px">${state.interview[q.id] || 'ï¼ˆæœªå›ç­”ï¼‰'}</div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-back" onclick="prevStep()">â† è¿”å›</button>
            <button class="btn" onclick="currentInterviewQ=0;document.getElementById('interviewArea').innerHTML=renderInterviewQuestion(0)">âœï¸ ä¿®æ”¹å›ç­”</button>
            <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ â†’</button>
        </div>
    `;
}

function nextInterviewQ(){
    const answer = document.getElementById('interviewAnswer').value.trim();
    const q = INTERVIEW_QUESTIONS[currentInterviewQ];
    
    // ä¿å­˜ç­”æ¡ˆ
    state.interview[q.id] = answer;
    
    currentInterviewQ++;
    document.getElementById('interviewArea').innerHTML = renderInterviewQuestion(currentInterviewQ);
}

function prevInterviewQ(){
    if(currentInterviewQ > 0){
        currentInterviewQ--;
        document.getElementById('interviewArea').innerHTML = renderInterviewQuestion(currentInterviewQ);
    }
}

// ==================== Step 1: å°å…¥å°èªª ====================
function renderStep1(){
    return `
        <!-- ç‰ˆæœ¬é¸æ“‡ -->
        <div class="content-card" style="margin-bottom:20px">
            <h3><span class="icon">âš™ï¸</span> é¸æ“‡è£½ä½œæ¨¡å¼</h3>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px">
                <!-- æ¥µé€Ÿç‰ˆ -->
                <div class="version-card ${currentVersion==='lite'?'active':''}" onclick="selectVersion('lite')" style="cursor:pointer;padding:16px;background:var(--bg);border:2px solid ${currentVersion==='lite'?'var(--primary)':'var(--border)'};border-radius:8px">
                    <div style="text-align:center;margin-bottom:12px">
                        <div style="font-size:28px">âš¡</div>
                        <div style="font-weight:600;color:${currentVersion==='lite'?'var(--primary)':'var(--text)'}">æ¥µé€Ÿç‰ˆ</div>
                    </div>
                    <div style="font-size:10px;color:var(--dim);line-height:1.6">
                        <div>ğŸ“š 2 Skills/Agent</div>
                        <div>ğŸ“ 2000å­—é™åˆ¶</div>
                        <div>ğŸ”¢ 7æ­¥æµç¨‹</div>
                        <div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border)">
                            <div>â±ï¸ ~2åˆ†é˜</div>
                            <div>ğŸ’° ${VERSIONS.lite.costDeepSeek}</div>
                        </div>
                    </div>
                </div>
                <!-- æ¨™æº–ç‰ˆ -->
                <div class="version-card ${currentVersion==='standard'?'active':''}" onclick="selectVersion('standard')" style="cursor:pointer;padding:16px;background:var(--bg);border:2px solid ${currentVersion==='standard'?'var(--primary)':'var(--border)'};border-radius:8px;position:relative">
                    <div style="position:absolute;top:-8px;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;font-size:9px;padding:2px 8px;border-radius:10px">æ¨è–¦</div>
                    <div style="text-align:center;margin-bottom:12px">
                        <div style="font-size:28px">â­</div>
                        <div style="font-weight:600;color:${currentVersion==='standard'?'var(--primary)':'var(--text)'}">æ¨™æº–ç‰ˆ</div>
                    </div>
                    <div style="font-size:10px;color:var(--dim);line-height:1.6">
                        <div>ğŸ“š 5 Skills/Agent</div>
                        <div>ğŸ“ 4000å­—é™åˆ¶</div>
                        <div>ğŸ”¢ 9æ­¥æµç¨‹</div>
                        <div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border)">
                            <div>â±ï¸ ~4åˆ†é˜</div>
                            <div>ğŸ’° ${VERSIONS.standard.costDeepSeek}</div>
                        </div>
                    </div>
                </div>
                <!-- å°ˆæ¥­ç‰ˆ -->
                <div class="version-card ${currentVersion==='pro'?'active':''}" onclick="selectVersion('pro')" style="cursor:pointer;padding:16px;background:var(--bg);border:2px solid ${currentVersion==='pro'?'var(--primary)':'var(--border)'};border-radius:8px">
                    <div style="text-align:center;margin-bottom:12px">
                        <div style="font-size:28px">ğŸ¬</div>
                        <div style="font-weight:600;color:${currentVersion==='pro'?'var(--primary)':'var(--text)'}">å°ˆæ¥­ç‰ˆ</div>
                    </div>
                    <div style="font-size:10px;color:var(--dim);line-height:1.6">
                        <div>ğŸ“š 8 Skills/Agent</div>
                        <div>ğŸ“ 6000å­—é™åˆ¶</div>
                        <div>ğŸ”¢ 10æ­¥å…¨æµç¨‹</div>
                        <div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border)">
                            <div>â±ï¸ ~6åˆ†é˜</div>
                            <div>ğŸ’° ${VERSIONS.pro.costDeepSeek}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="font-size:10px;color:var(--dim);margin-top:12px;text-align:center;background:var(--surface2);padding:8px;border-radius:6px">
                ç•¶å‰ï¼š<strong style="color:var(--primary)">${VERSIONS[currentVersion].name}</strong> | 
                Skillsè¶Šå¤š=åˆ†æè¶Šæ·±å…¥ | ä½¿ç”¨ DeepSeek åƒ¹æ ¼ï¼ˆClaudeç´„è²´40-150å€ï¼‰
            </div>
        </div>

        <div class="content-card">
            <h3><span class="icon">ğŸ“–</span> å°å…¥æˆ–å‰µä½œå°èªª</h3>
            
            <!-- é¸é …å¡ -->
            <div class="tabs" style="margin-bottom:20px">
                <div class="tab active" onclick="showInputMode('upload')">ğŸ“ ä¸Šå‚³æ–‡æª”</div>
                <div class="tab" onclick="showInputMode('paste')">ğŸ“ è²¼å…¥æ–‡å­—</div>
                <div class="tab" onclick="showInputMode('generate')">âœ¨ AIå¯«å°èªª</div>
            </div>
            
            <div id="inputModeContent">
                ${renderUploadMode()}
            </div>
        </div>
    `;
}

function selectVersion(ver){
    currentVersion = ver;
    // æ›´æ–°æœå‹™å™¨é…ç½®
    fetch('http://34.58.33.115:3001/api/config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({maxSkills: VERSIONS[ver].maxSkills, contentLimit: VERSIONS[ver].contentLimit})
    }).catch(()=>{});
    // é‡æ–°æ¸²æŸ“
    showStep(1);
}

function showInputMode(mode){
    document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    const content = document.getElementById('inputModeContent');
    switch(mode){
        case 'upload': content.innerHTML = renderUploadMode(); break;
        case 'paste': content.innerHTML = renderPasteMode(); break;
        case 'generate': content.innerHTML = renderGenerateMode(); break;
    }
}

function renderUploadMode(){
    return `
        <p style="color:var(--dim);margin-bottom:20px">æ”¯æŒ <strong>TXTã€Word (.docx)ã€PDF</strong> æ ¼å¼ï¼Œæœ€å¤§æ”¯æŒ10è¬å­—+</p>
        
        <div class="form-group">
            <label class="form-label">å°èªªæ¨™é¡Œï¼ˆå¯é¸ï¼Œæœƒè‡ªå‹•å¾æ–‡æª”æå–ï¼‰</label>
            <input type="text" class="form-input" id="novelTitle" placeholder="ä¾‹ï¼šæµ·ä¸Šçµ²ç¶¢ä¹‹è·¯å¯†ç¢¼" value="${state.novel.title}">
        </div>
        
        <div style="border:2px dashed var(--border);border-radius:12px;padding:40px;text-align:center;margin:20px 0;cursor:pointer" 
             onclick="document.getElementById('fileInput').click()"
             ondragover="event.preventDefault();this.style.borderColor='var(--primary)'"
             ondragleave="this.style.borderColor='var(--border)'"
             ondrop="handleFileDrop(event)">
            <div style="font-size:48px;margin-bottom:16px">ğŸ“„</div>
            <p style="font-size:16px;margin-bottom:8px">æ‹–æ”¾æ–‡ä»¶åˆ°é€™è£¡</p>
            <p style="color:var(--dim);font-size:13px">æˆ–é»æ“Šé¸æ“‡æ–‡ä»¶</p>
            <p style="color:var(--dim);font-size:12px;margin-top:12px">æ”¯æŒ .txt .docx .pdf</p>
        </div>
        
        <input type="file" id="fileInput" accept=".txt,.docx,.pdf" style="display:none" onchange="handleFileUpload(event)">
        
        <div id="uploadStatus" style="margin:16px 0"></div>
        
        <div class="btn-group">
            <button class="btn" onclick="loadDemoNovel()">ğŸ“š è¼‰å…¥ç¤ºä¾‹</button>
            <button class="btn btn-primary" onclick="analyzeNovel()" id="analyzeBtn" disabled>é–‹å§‹åˆ†æ â†’</button>
        </div>
    `;
}

function renderPasteMode(){
    setTimeout(() => {
        const textarea = document.getElementById('novelText');
        if(textarea){
            textarea.addEventListener('input', updateWordCount);
            updateWordCount();
        }
    }, 100);
    
    return `
        <p style="color:var(--dim);margin-bottom:20px">ç›´æ¥è²¼å…¥å°èªªå…¨æ–‡</p>
        
        <div class="form-group">
            <label class="form-label">å°èªªæ¨™é¡Œ</label>
            <input type="text" class="form-input" id="novelTitle" placeholder="ä¾‹ï¼šæµ·ä¸Šçµ²ç¶¢ä¹‹è·¯å¯†ç¢¼" value="${state.novel.title || ''}">
        </div>
        
        <div class="form-group">
            <label class="form-label">å°èªªæ­£æ–‡</label>
            <textarea class="form-input" id="novelText" style="min-height:350px" placeholder="å°‡å°èªªå…¨æ–‡è²¼å…¥æ­¤è™•..." oninput="updateWordCount()">${state.novel.text || ''}</textarea>
        </div>
        
        <div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0">
            <span id="wordCount" style="color:var(--dim);font-size:13px">${state.novel.text ? state.novel.text.length + ' å­—' : '0 å­—'}</span>
        </div>
        
        <div class="btn-group">
            <button class="btn" onclick="loadDemoNovelPaste()">ğŸ“š è¼‰å…¥ç¤ºä¾‹</button>
            <button class="btn btn-primary" onclick="analyzeNovelFromPaste()">é–‹å§‹åˆ†æ â†’</button>
        </div>
    `;
}

function updateWordCount(){
    const textarea = document.getElementById('novelText');
    const countSpan = document.getElementById('wordCount');
    if(textarea && countSpan){
        const count = textarea.value.length;
        countSpan.textContent = count.toLocaleString() + ' å­—';
        countSpan.style.color = count > 1000 ? 'var(--success)' : 'var(--dim)';
    }
}

function loadDemoNovelPaste(){
    const titleInput = document.getElementById('novelTitle');
    const textArea = document.getElementById('novelText');
    
    if(titleInput) titleInput.value = 'æµ·ä¸Šçµ²ç¶¢ä¹‹è·¯å¯†ç¢¼';
    if(textArea) textArea.value = DEMO_NOVEL;
    
    updateWordCount();
}

function renderGenerateMode(){
    return `
        <!-- æ¨¡å¼åˆ‡æ› -->
        <div style="display:flex;gap:8px;margin-bottom:20px">
            <button class="btn ${!state.scriptMode ? 'btn-primary' : ''}" onclick="state.scriptMode=false;document.getElementById('contentArea').innerHTML=renderStep1()" style="flex:1">
                âœ¨ å°èªªæ¨¡å¼
            </button>
            <button class="btn ${state.scriptMode ? 'btn-primary' : ''}" onclick="state.scriptMode=true;document.getElementById('contentArea').innerHTML=renderStep1()" style="flex:1">
                ğŸ¬ åŠ‡æœ¬æ¨¡å¼
            </button>
        </div>
        
        ${state.scriptMode ? renderScriptMode() : renderNovelMode()}
    `;
}

function renderScriptMode(){
    return `
        <p style="color:var(--dim);margin-bottom:16px">ğŸ“ è²¼å…¥å®Œæ•´å¤§ç¶±ï¼ŒAIæœƒæ ¹æ“šå¤§ç¶±ç”Ÿæˆåˆ†é›†åŠ‡æœ¬ï¼ˆæ”¯æŒ100é›†ï¼‰</p>
        
        <div class="form-group">
            <label class="form-label">ğŸ“‹ æ•…äº‹å¤§ç¶±ï¼ˆåŒ…å«è§’è‰²ã€è¨­å®šã€åŠ‡æƒ…ç·šï¼‰</label>
            <textarea class="form-input" id="scriptOutline" style="min-height:300px;font-size:13px" placeholder="è²¼å…¥ä½ çš„æ•…äº‹å¤§ç¶±...&#10;&#10;å»ºè­°åŒ…å«ï¼š&#10;- æ•…äº‹æ¢—æ¦‚&#10;- ä¸»è¦è§’è‰²è¨­å®š&#10;- åˆ†é›†åŠ‡æƒ…æ¦‚è¦"></textarea>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
            <div class="form-group">
                <label class="form-label">ğŸ“º ç¸½é›†æ•¸</label>
                <select class="form-input" id="scriptEpisodes">
                    <option value="10">10 é›†</option>
                    <option value="20">20 é›†</option>
                    <option value="50">50 é›†</option>
                    <option value="100" selected>100 é›†</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">â±ï¸ æ¯é›†æ™‚é•·</label>
                <select class="form-input" id="scriptDuration">
                    <option value="1">1 åˆ†é˜ï¼ˆ60ç§’çŸ­åŠ‡ï¼‰</option>
                    <option value="2" selected>2 åˆ†é˜</option>
                    <option value="3">3 åˆ†é˜</option>
                    <option value="5">5 åˆ†é˜</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ”„ æ¯æ‰¹ç”Ÿæˆ</label>
                <select class="form-input" id="scriptBatch">
                    <option value="5">5 é›†/æ‰¹</option>
                    <option value="10" selected>10 é›†/æ‰¹</option>
                    <option value="20">20 é›†/æ‰¹</option>
                </select>
            </div>
        </div>
        
        <div id="scriptStatus" style="margin:16px 0"></div>
        <div id="scriptPreview" style="display:none;margin:16px 0;background:var(--bg);border:1px solid var(--border);border-radius:8px;max-height:400px;overflow-y:auto"></div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="generateScript()" id="genScriptBtn">ğŸ¬ é–‹å§‹ç”ŸæˆåŠ‡æœ¬</button>
            <button class="btn" onclick="downloadScript()" id="dlScriptBtn" style="display:none">ğŸ’¾ ä¸‹è¼‰åŠ‡æœ¬</button>
        </div>
    `;
}

function renderNovelMode(){
    return `
        <p style="color:var(--dim);margin-bottom:20px">å‘Šè¨´AIä½ æƒ³è¦ä»€éº¼æ¨£çš„æ•…äº‹ï¼ŒAIæœƒç‚ºä½ å‰µä½œå°èªª</p>
        
        <div class="form-group">
            <label class="form-label">æ•…äº‹é¡å‹</label>
            <select class="form-input" id="storyGenre">
                <option value="æ­·å²å†’éšª">ğŸ›ï¸ æ­·å²å†’éšª</option>
                <option value="ä»™ä¿ ">âš”ï¸ ä»™ä¿ </option>
                <option value="éƒ½å¸‚è¨€æƒ…">ğŸ’• éƒ½å¸‚è¨€æƒ…</option>
                <option value="æ‡¸ç–‘æ¨ç†">ğŸ” æ‡¸ç–‘æ¨ç†</option>
                <option value="ç§‘å¹»">ğŸš€ ç§‘å¹»</option>
                <option value="å¥‡å¹»">ğŸ‰ å¥‡å¹»</option>
                <option value="ææ€–">ğŸ‘» ææ€–</option>
                <option value="è·å ´">ğŸ’¼ è·å ´</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">æ•…äº‹è¨­å®š / ä½ çš„æƒ³æ³•</label>
            <textarea class="form-input" id="storyIdea" style="min-height:150px" placeholder="ä¾‹å¦‚ï¼š&#10;- å”ä»£å»£å·ï¼Œä¸€å€‹å°å·å¶ç„¶å¾—åˆ°ç¥ç§˜å¯¶çŸ³&#10;- è¢«è¿«æ²å…¥æµ·ä¸Šçµ²ç¶¢ä¹‹è·¯çš„å†’éšª&#10;- é‡åˆ°ç¥ç§˜å°‘å¥³ï¼Œè§£é–‹åƒå¹´è©›å’’ä¹‹è¬&#10;- æƒ³è¦æœ‰æµ·ç›œã€å¯†å®¤æ®ºäººã€è¼ªè¿´å…ƒç´ "></textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">ç›®æ¨™ç¯‡å¹…</label>
            <select class="form-input" id="storyLength">
                <option value="çŸ­ç¯‡">çŸ­ç¯‡ï¼ˆ1-2è¬å­—ï¼‰</option>
                <option value="ä¸­ç¯‡" selected>ä¸­ç¯‡ï¼ˆ5-10è¬å­—ï¼‰</option>
                <option value="é•·ç¯‡">é•·ç¯‡ï¼ˆ20è¬å­—+ï¼‰</option>
            </select>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div class="form-group">
                <label class="form-label">ğŸ“º ç›®æ¨™é›†æ•¸</label>
                <select class="form-input" id="storyEpisodes" onchange="updateNovelEstimate()">
                    <option value="3">3 é›†ï¼ˆçŸ­åŠ‡ï¼‰</option>
                    <option value="5">5 é›†</option>
                    <option value="8" selected>8 é›†</option>
                    <option value="10">10 é›†</option>
                    <option value="12">12 é›†ï¼ˆæ¨™æº–å­£ï¼‰</option>
                    <option value="16">16 é›†</option>
                    <option value="20">20 é›†</option>
                    <option value="24">24 é›†ï¼ˆé›™å­£ï¼‰</option>
                    <option value="50">50 é›†ï¼ˆé•·ç¯‡ï¼‰</option>
                    <option value="100">100 é›†ï¼ˆè¶…é•·ç¯‡ï¼‰</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">â±ï¸ æ¯é›†æ™‚é•·</label>
                <select class="form-input" id="storyDuration" onchange="updateNovelEstimate()">
                    <option value="1-2">1-2 åˆ†é˜ï¼ˆå¾®çŸ­åŠ‡ï¼‰</option>
                    <option value="2-3">2-3 åˆ†é˜ï¼ˆçŸ­åŠ‡ï¼‰</option>
                    <option value="3-5">3-5 åˆ†é˜ï¼ˆçŸ­è¦–é »ï¼‰</option>
                    <option value="5-8" selected>5-8 åˆ†é˜ï¼ˆæ¨™æº–ï¼‰</option>
                    <option value="8-12">8-12 åˆ†é˜ï¼ˆæ·±åº¦ï¼‰</option>
                    <option value="12-15">12-15 åˆ†é˜ï¼ˆé•·ç¯‡ï¼‰</option>
                </select>
            </div>
        </div>
        <div id="novelEstimate" style="background:var(--surface2);padding:10px 14px;border-radius:6px;margin:-4px 0 16px;font-size:12px"></div>
        
        <div class="form-group">
            <label class="form-label">åƒè€ƒä½œå“é¢¨æ ¼ï¼ˆå¯é¸ï¼‰</label>
            <input type="text" class="form-input" id="storyReference" placeholder="ä¾‹ï¼šåŠ å‹’æ¯”æµ·ç›œ + é•·å®‰åäºŒæ™‚è¾°">
        </div>
        
        <div id="generateStatus" style="margin:16px 0"></div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="generateNovel()">âœ¨ é–‹å§‹å‰µä½œå°èªª</button>
        </div>
    `;
}

function handleFileUpload(event){
    const file = event.target.files[0];
    if(file){
        processFile(file);
    }
}

function handleFileDrop(event){
    event.preventDefault();
    event.target.style.borderColor = 'var(--border)';
    const file = event.dataTransfer.files[0];
    if(file){
        processFile(file);
    }
}

function processFile(file){
    const statusDiv = document.getElementById('uploadStatus');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const ext = file.name.split('.').pop().toLowerCase();
    
    statusDiv.innerHTML = `<div class="loading"><div class="spinner"></div>æ­£åœ¨è®€å– ${escapeHtml(file.name)}...</div>`;
    
    if(ext === 'txt'){
        // TXT ç›´æ¥è®€å–ï¼ˆå˜—è©¦å¤šç¨®ç·¨ç¢¼ï¼‰
        const reader = new FileReader();
        reader.onload = function(e){
            let text = e.target.result;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰äº‚ç¢¼ï¼ˆå¤§é‡å•è™Ÿæˆ–æ–¹å¡Šï¼‰
            const garbledRatio = (text.match(/[ï¿½?â–¡]/g) || []).length / text.length;
            if(garbledRatio > 0.1){
                // å˜—è©¦ç”¨ GBK ç·¨ç¢¼é‡æ–°è®€å–
                console.log('æª¢æ¸¬åˆ°å¯èƒ½çš„ç·¨ç¢¼å•é¡Œï¼Œå˜—è©¦GBK...');
                const gbkReader = new FileReader();
                gbkReader.onload = function(e2){
                    const gbkText = e2.target.result;
                    // ä½¿ç”¨è¼ƒå¥½çš„çµæœ
                    const finalText = gbkText.length > text.length ? gbkText : text;
                    state.novel.text = finalText;
                    state.novel.wordCount = finalText.length;
                    state.novel.title = document.getElementById('novelTitle').value || file.name.replace('.txt','');
                    showUploadSuccess(file.name, finalText.length);
                };
                gbkReader.readAsText(file, 'GBK');
                return;
            }
            
            state.novel.text = text;
            state.novel.wordCount = text.length;
            state.novel.title = document.getElementById('novelTitle').value || file.name.replace('.txt','');
            console.log('[ä¸Šå‚³] TXTè®€å–æˆåŠŸï¼Œå­—æ•¸:', text.length);
            showUploadSuccess(file.name, text.length);
        };
        reader.onerror = function(e){
            console.error('[ä¸Šå‚³] è®€å–å¤±æ•—:', e);
            statusDiv.innerHTML = `<div style="color:var(--error)">âŒ æ–‡ä»¶è®€å–å¤±æ•—ï¼Œè«‹é‡è©¦</div>`;
        };
        reader.readAsText(file, 'UTF-8');
    } 
    else if(ext === 'docx'){
        // DOCX ä½¿ç”¨ mammoth.js è§£æ
        statusDiv.innerHTML = `
            <div style="padding:16px;background:var(--surface2);border-radius:8px">
                <div style="display:flex;align-items:center;gap:12px">
                    <div class="spinner" style="width:24px;height:24px"></div>
                    <div>
                        <p style="color:var(--dim)">ğŸ“„ æ­£åœ¨è§£æ Word æ–‡æª”...</p>
                        <p style="color:var(--dim);font-size:11px;margin-top:4px">ä½¿ç”¨ mammoth.js æå–æ–‡å­—å…§å®¹</p>
                    </div>
                </div>
            </div>
        `;
        
        const reader = new FileReader();
        reader.onload = function(e){
            const arrayBuffer = e.target.result;
            
            // ä½¿ç”¨ mammoth.js è§£æ DOCX
            if(typeof mammoth !== 'undefined'){
                mammoth.extractRawText({arrayBuffer: arrayBuffer})
                    .then(function(result){
                        const text = result.value;
                        if(text && text.length > 0){
                            state.novel.text = text;
                            state.novel.wordCount = text.length;
                            state.novel.title = document.getElementById('novelTitle').value || file.name.replace(/\.docx$/i,'').replace(/\.\w+$/,'');
                            showUploadSuccess(file.name, text.length);
                        } else {
                            statusDiv.innerHTML = `
                                <div style="padding:16px;background:rgba(239,68,68,.1);border:1px solid var(--error);border-radius:8px">
                                    <p style="color:var(--error)">âŒ Wordæ–‡æª”å…§å®¹ç‚ºç©º</p>
                                    <p style="color:var(--dim);font-size:12px;margin-top:8px">è«‹æª¢æŸ¥æ–‡æª”æ˜¯å¦æœ‰æ–‡å­—å…§å®¹ï¼Œæˆ–å˜—è©¦å¦å­˜ç‚ºTXTæ ¼å¼</p>
                                </div>
                            `;
                        }
                    })
                    .catch(function(err){
                        console.error('DOCXè§£æéŒ¯èª¤:', err);
                        statusDiv.innerHTML = `
                            <div style="padding:16px;background:rgba(239,68,68,.1);border:1px solid var(--error);border-radius:8px">
                                <p style="color:var(--error)">âŒ Wordæ–‡æª”è§£æå¤±æ•—</p>
                                <p style="color:var(--dim);font-size:12px;margin-top:8px">${err.message || 'è«‹å°‡Wordå¦å­˜ç‚ºTXTæ ¼å¼å¾Œé‡æ–°ä¸Šå‚³'}</p>
                            </div>
                        `;
                    });
            } else {
                statusDiv.innerHTML = `
                    <div style="padding:16px;background:rgba(128,128,128,.1);border:1px solid var(--warning);border-radius:8px">
                        <p style="color:var(--dim)">âš ï¸ Wordè§£æåº«åŠ è¼‰å¤±æ•—</p>
                        <p style="color:var(--dim);font-size:12px;margin-top:8px">è«‹å°‡Wordæ–‡æª”å¦å­˜ç‚ºTXTæ ¼å¼å¾Œé‡æ–°ä¸Šå‚³</p>
                    </div>
                `;
            }
        };
        reader.readAsArrayBuffer(file);
    }
    else if(ext === 'pdf'){
        // PDF ä½¿ç”¨ PDF.js è§£æ
        statusDiv.innerHTML = `
            <div style="padding:16px;background:var(--surface2);border-radius:8px">
                <div style="display:flex;align-items:center;gap:12px">
                    <div class="spinner" style="width:24px;height:24px"></div>
                    <div>
                        <p style="color:var(--dim)">ğŸ“„ æ­£åœ¨è§£æ PDF æ–‡æª”...</p>
                        <p style="color:var(--dim);font-size:11px;margin-top:4px">æå–æ–‡å­—å…§å®¹ä¸­...</p>
                    </div>
                </div>
            </div>
        `;
        
        const reader = new FileReader();
        reader.onload = async function(e){
            try {
                if(typeof pdfjsLib !== 'undefined'){
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
                    const pdf = await pdfjsLib.getDocument({data: e.target.result}).promise;
                    let fullText = '';
                    for(let i = 1; i <= pdf.numPages; i++){
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n\n';
                    }
                    if(fullText.trim().length > 0){
                        state.novel.text = fullText.trim();
                        state.novel.wordCount = fullText.trim().length;
                        state.novel.title = document.getElementById('novelTitle').value || file.name.replace('.pdf','');
                        showUploadSuccess(file.name, fullText.length);
                    } else {
                        throw new Error('PDFå…§å®¹ç‚ºç©º');
                    }
                } else {
                    throw new Error('PDFè§£æåº«æœªåŠ è¼‰');
                }
            } catch(err){
                console.error('PDFè§£æéŒ¯èª¤:', err);
                statusDiv.innerHTML = `
                    <div style="padding:16px;background:rgba(239,68,68,.1);border:1px solid var(--error);border-radius:8px">
                        <p style="color:var(--error)">âŒ PDFè§£æå¤±æ•—</p>
                        <p style="color:var(--dim);font-size:12px;margin-top:8px">${err.message || 'è«‹å°‡PDFå¦å­˜ç‚ºTXTæ ¼å¼å¾Œé‡æ–°ä¸Šå‚³'}</p>
                    </div>
                `;
            }
        };
        reader.readAsArrayBuffer(file);
    }
    else {
        statusDiv.innerHTML = `<p style="color:var(--error)">âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼š${escapeHtml(ext)}</p>`;
    }
}

// åˆ¤æ–­èµ·æ‰¿è½¬åˆé˜¶æ®µç±»å‹
function getPhaseType(phase){
    if(!phase) return 'other';
    const p = phase.toLowerCase();
    // èµ·ï¼šå¼€ç¯‡ã€åºç« ã€å¼€ç«¯ã€é“ºå«
    if(p.includes('èµ·') || p.includes('å¼€ç¯‡') || p.includes('åº') || p.includes('å¼€ç«¯') || p.includes('é“ºå«') || p.includes('é–‹ç¯‡') || p.includes('é‹ªå¢Š')) return 'qi';
    // æ‰¿ï¼šå‘å±•ã€æ‰¿æ¥ã€æ¨è¿›
    if(p.includes('æ‰¿') || p.includes('å‘å±•') || p.includes('ç™¼å±•') || p.includes('æ¨è¿›') || p.includes('æ¨é€²')) return 'cheng';
    // è½¬ï¼šè½¬æŠ˜ã€é«˜æ½®ã€å†²çª
    if(p.includes('è½¬') || p.includes('è½‰') || p.includes('é«˜æ½®') || p.includes('å†²çª') || p.includes('è¡çª') || p.includes('å±æœº') || p.includes('å±æ©Ÿ')) return 'zhuan';
    // åˆï¼šç»“å±€ã€æ”¶æŸã€å°¾å£°
    if(p.includes('åˆ') || p.includes('ç»“å±€') || p.includes('çµå±€') || p.includes('æ”¶æŸ') || p.includes('å°¾å£°') || p.includes('å°¾è²') || p.includes('ç»“å°¾') || p.includes('çµå°¾')) return 'he';
    return 'other';
}

function showUploadSuccess(filename, wordCount){
    const statusDiv = document.getElementById('uploadStatus');
    const analyzeBtn = document.getElementById('analyzeBtn');
    
    // è¨ˆç®—è‡ªç„¶æ™‚é•·
    // å°èªªâ†’ç•ªåŠ‡æ™‚é•·ä¼°ç®—ï¼šå­—æ•¸Ã·800ï¼ˆè€ƒæ…®4:1å£“ç¸®æ¯” + 200å­—/åˆ†é˜èªé€Ÿï¼‰
    // è¡Œæ¥­åƒè€ƒï¼š90åˆ†é˜é›»å½±â‰ˆ18000å­—å‰§æœ¬ï¼Œ24åˆ†é˜ç•ªåŠ‡â‰ˆ5000å­—
    const naturalDuration = Math.round(wordCount / 800);
    
    console.log('[ä¸Šå‚³æˆåŠŸ]', { filename, wordCount, naturalDuration });
    
    statusDiv.innerHTML = `
        <div style="padding:16px;background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:8px">
            <p style="color:var(--text)">âœ… æ–‡ä»¶è®€å–æˆåŠŸï¼</p>
            <p style="margin-top:8px">
                <span style="color:var(--dim)">æ–‡ä»¶åï¼š</span>${filename}<br>
                <span style="color:var(--dim)">å­—æ•¸ï¼š</span><strong style="color:var(--primary)">${wordCount.toLocaleString()}</strong> å­—<br>
                <span style="color:var(--dim)">é ä¼°æ™‚é•·ï¼š</span><strong>${naturalDuration}</strong> åˆ†é˜
            </p>
        </div>
    `;
    analyzeBtn.disabled = false;
}

function analyzeNovelFromPaste(){
    const titleEl = document.getElementById('novelTitle');
    const textEl = document.getElementById('novelText');
    
    const title = titleEl ? titleEl.value.trim() : '';
    const text = textEl ? textEl.value.trim() : '';
    
    console.log('analyzeNovelFromPaste:', {title, textLength: text.length});
    
    if(!text || text.length < 100){
        alert('è«‹è¼¸å…¥å°èªªæ­£æ–‡ï¼ˆè‡³å°‘100å­—ï¼‰');
        return;
    }
    
    state.novel = {
        title: title || 'æœªå‘½åå°èªª',
        text: text,
        wordCount: text.length
    };
    
    document.getElementById('novelStats').textContent = `${state.novel.title} | ${(text.length/10000).toFixed(1)}è¬å­—`;
    nextStep();
}

// æ›´æ–°é ä¼°å­—æ•¸å’Œæ™‚é–“
function updateNovelEstimate(){
    const episodesEl = document.getElementById('storyEpisodes');
    const durationEl = document.getElementById('storyDuration');
    const estimateDiv = document.getElementById('novelEstimate');
    
    if(!episodesEl || !durationEl || !estimateDiv) return;
    
    const episodes = parseInt(episodesEl.value) || 8;
    const durationStr = durationEl.value || '5-8';
    const durationParts = durationStr.split('-').map(Number);
    const avgDuration = (durationParts[0] + durationParts[1]) / 2;
    
    const totalMinutes = episodes * avgDuration;
    // AIç•ªå‰§å‰§æœ¬ï¼š~150å­—/åˆ†é’Ÿï¼ˆæ¯”ä¼ ç»Ÿå‰§æœ¬æ›´ç®€æ´ï¼Œæœ‰å¤§é‡è§†è§‰æå†™ï¼‰
    const estimatedWords = Math.round(totalMinutes * 150);
    const estimatedSegments = Math.ceil(estimatedWords / 4000);
    const estimatedTime = Math.ceil(estimatedSegments * 0.5); // æ¯æ®µç´„30ç§’
    
    let warning = '';
    if(episodes > 30) {
        warning = '<br><span style="color:var(--primary)">ğŸ“¦ è¶…é30é›†å°‡è‡ªå‹•ä½¿ç”¨æ‰¹æ¬¡ç”Ÿæˆæ¨¡å¼ï¼ˆæ›´ç©©å®šï¼‰</span>';
    } else if(estimatedWords > 80000) {
        warning = '<br><span style="color:var(--warning)">âš ï¸ å­—æ•¸è¼ƒå¤šï¼Œç”Ÿæˆæ™‚é–“è¼ƒé•·</span>';
    }
    
    estimateDiv.innerHTML = 'ğŸ“Š é ä¼°ï¼š<strong>' + (estimatedWords/10000).toFixed(1) + 'è¬å­—</strong> | ' + 
        totalMinutes + 'åˆ†é˜ | ç´„' + estimatedSegments + 'æ®µç”Ÿæˆ | é è¨ˆ' + estimatedTime + 'åˆ†é˜å®Œæˆ' + warning;
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–é ä¼°
setTimeout(updateNovelEstimate, 100);

async function generateNovel(){
    const genreEl = document.getElementById('storyGenre');
    const ideaEl = document.getElementById('storyIdea');
    const lengthEl = document.getElementById('storyLength');
    const refEl = document.getElementById('storyReference');
    const episodesEl = document.getElementById('storyEpisodes');
    const durationEl = document.getElementById('storyDuration');
    
    const genre = genreEl ? genreEl.value : 'æ­·å²å†’éšª';
    const idea = ideaEl ? ideaEl.value.trim() : '';
    const length = lengthEl ? lengthEl.value : 'ä¸­ç¯‡';
    const reference = refEl ? refEl.value.trim() : '';
    const episodes = episodesEl ? parseInt(episodesEl.value) : 8;
    const duration = durationEl ? durationEl.value : '5-8';
    
    // ä¿å­˜åˆ°stateä¾›åç»­æ™ºèƒ½ä½“ä½¿ç”¨
    state.seriesConfig = { episodes, duration };
    
    console.log('generateNovel:', {genre, idea, length, reference, episodes, duration});
    
    if(!idea){
        alert('è«‹è¼¸å…¥ä½ çš„æ•…äº‹æƒ³æ³•');
        return;
    }
    
    const statusDiv = document.getElementById('generateStatus');
    if(!statusDiv){
        console.error('generateStatus not found');
        return;
    }
    
    statusDiv.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>AIæ­£åœ¨å‰µä½œå°èªª...</span>
        </div>
        <div style="margin-top:16px;padding:16px;background:var(--surface2);border-radius:8px">
            <p style="font-size:12px;color:var(--dim)">ğŸ¤– å‰µä½œé€²åº¦ï¼š</p>
            <p style="margin-top:8px;font-size:13px" id="genProgress">FizzDragon å‰µä½œæ™ºèƒ½é«”é‹ä½œä¸­...</p>
        </div>
    `;
    
    try {
        // çœŸæ­£èª¿ç”¨AIç”Ÿæˆ
        const generatedNovel = await generateNovelWithAI(genre, idea, reference, length, episodes, duration);
        
        state.novel = {
            title: generatedNovel.title,
            text: generatedNovel.content,
            wordCount: generatedNovel.content.length
        };
        
        // åŒæ­¥é›†æ•°é…ç½®åˆ°ç« èŠ‚é…ç½®
        const durationParts = duration.split('-').map(Number);
        const avgDuration = Math.round((durationParts[0] + durationParts[1]) / 2);
        chapterConfig.episodes = episodes;
        chapterConfig.durationPerEpisode = avgDuration;
        
        document.getElementById('novelStats').textContent = `${state.novel.title} | ${(state.novel.wordCount/10000).toFixed(1)}è¬å­—`;
        
        statusDiv.innerHTML = `
            <div style="padding:16px;background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:8px">
                <p style="color:var(--text);font-size:18px">âœ… å°èªªå‰µä½œå®Œæˆï¼</p>
                <p style="margin-top:8px">
                    <span style="color:var(--dim)">æ¨™é¡Œï¼š</span><strong style="font-size:16px">${generatedNovel.title}</strong><br>
                    <span style="color:var(--dim)">é¡å‹ï¼š</span>${genre}<br>
                    <span style="color:var(--dim)">å­—æ•¸ï¼š</span><strong style="color:var(--primary)">${state.novel.wordCount.toLocaleString()}</strong> å­—<br>
                    <span style="color:var(--dim)">è¦åŠƒï¼š</span>${episodes}é›† Ã— ${duration}åˆ†é˜/é›†
                </p>
            </div>
            
            <!-- å®Œæ•´å°èªªå…§å®¹å±•ç¤º -->
            <div style="margin-top:16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;max-height:500px;overflow-y:auto">
                <div style="background:var(--primary);padding:10px 16px;color:#fff;position:sticky;top:0;z-index:1;display:flex;justify-content:space-between;align-items:center">
                    <span>ğŸ“– å®Œæ•´å°èªªå…§å®¹</span>
                    <button onclick="copyNovelToClipboard()" style="background:rgba(255,255,255,.2);border:none;color:#fff;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px">ğŸ“‹ è¤‡è£½å…¨æ–‡</button>
                </div>
                <div style="padding:20px;font-size:14px;line-height:2;white-space:pre-wrap;font-family:'Noto Serif SC',Georgia,serif">${generatedNovel.content}</div>
            </div>
            
            <div class="btn-group" style="margin-top:16px">
                <button class="btn" onclick="downloadNovel()">ğŸ’¾ ä¸‹è¼‰å°èªª</button>
                <button class="btn btn-primary" onclick="nextStep()">ç¹¼çºŒè£½ä½œ â†’</button>
            </div>
        `;
    } catch(err) {
        statusDiv.innerHTML = `
            <div style="padding:16px;background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.3);border-radius:8px">
                <p style="color:var(--primary)">âŒ å‰µä½œå¤±æ•—</p>
                <p style="margin-top:8px;font-size:12px;color:var(--dim)">${err.message}</p>
            </div>
            <button class="btn btn-primary" onclick="generateNovel()" style="margin-top:12px">ğŸ”„ é‡è©¦</button>
        `;
    }
}

// çœŸæ­£è°ƒç”¨AIç”Ÿæˆå°è¯´ï¼ˆæ”¯æŒåˆ†æ®µç”Ÿæˆé•·ç¯‡ï¼‰
async function generateNovelWithAI(genre, idea, reference, targetLength, episodes = 8, duration = '5-8'){
    // æ ¹æ®é›†æ•°å’Œæ—¶é•¿è®¡ç®—ç›®æ ‡å­—æ•°
    // æ¯åˆ†é’Ÿçº¦200å­—ï¼Œå–æ—¶é•¿èŒƒå›´ä¸­é—´å€¼
    const durationParts = duration.split('-').map(Number);
    const avgDuration = (durationParts[0] + durationParts[1]) / 2;
    const targetWords = Math.round(episodes * avgDuration * 200);
    const targetChapters = episodes; // ç« èŠ‚æ•° = é›†æ•°
    
    // æ ¹æ®å®é™…éœ€æ±‚è®¡ç®—åˆ†æ®µï¼Œæ¯æ®µæœ€å¤šç”Ÿæˆçº¦4000å­—
    const wordsPerSegment = 4000;
    const autoSegments = Math.max(1, Math.ceil(targetWords / wordsPerSegment));
    
    const lengthConfig = {
        'çŸ­ç¯‡': { words: Math.min(targetWords, 15000), chapters: Math.min(targetChapters, 8), segments: Math.min(autoSegments, 4) },
        'ä¸­ç¯‡': { words: Math.min(targetWords, 60000), chapters: Math.min(targetChapters, 30), segments: Math.min(autoSegments, 15) },
        'é•·ç¯‡': { words: targetWords, chapters: targetChapters, segments: autoSegments }
    };
    
    // å¦‚æœé›†æ•°è¶…è¿‡30ï¼Œè‡ªåŠ¨å‡çº§åˆ°é•¿ç¯‡
    let actualLength = targetLength;
    if(targetChapters > 30 && targetLength !== 'é•·ç¯‡') {
        actualLength = 'é•·ç¯‡';
        console.log('è‡ªå‹•å‡ç´šåˆ°é•·ç¯‡æ¨¡å¼ï¼Œå› ç‚ºé›†æ•¸ > 30');
    }
    
    const config = lengthConfig[actualLength] || lengthConfig['çŸ­ç¯‡'];
    const chaptersPerSegment = Math.ceil(config.chapters / config.segments);
    
    console.log('ç”Ÿæˆé…ç½®:', { targetWords, targetChapters, segments: config.segments, actualLength });
    
    // ä¿å­˜å‰§é›†é…ç½®ä¾›åç»­ä½¿ç”¨
    const seriesInfo = `\nã€ç›®æ¨™æ ¼å¼ã€‘${episodes}é›†ç•ªåŠ‡ï¼Œæ¯é›†${duration}åˆ†é˜`;
    
    console.log('generateNovelWithAI called');
    console.log('Config:', config, 'Segments:', config.segments);
    
    // æ›´æ–°é€²åº¦é¡¯ç¤º
    const updateProgress = (msg) => {
        const el = document.getElementById('genProgress');
        if(el) el.textContent = msg;
    };
    
    // å¯¦æ™‚é è¦½å€åŸŸ
    const updatePreview = (content, title) => {
        let preview = document.getElementById('genPreview');
        if(!preview){
            const container = document.getElementById('generateStatus');
            if(container){
                const previewDiv = document.createElement('div');
                previewDiv.id = 'genPreviewContainer';
                previewDiv.innerHTML = `
                    <div style="margin-top:16px;background:var(--bg);border:1px solid var(--primary);border-radius:8px;max-height:400px;overflow-y:auto">
                        <div style="background:var(--primary);padding:8px 12px;font-size:11px;color:#fff;position:sticky;top:0;z-index:1">
                            ğŸ“ å¯¦æ™‚é è¦½ - å…§å®¹ç”Ÿæˆä¸­...
                        </div>
                        <div id="genPreview" style="padding:16px;font-size:13px;line-height:2;white-space:pre-wrap;font-family:'Noto Serif SC',serif;color:var(--text)"></div>
                    </div>
                `;
                container.appendChild(previewDiv);
                preview = document.getElementById('genPreview');
            }
        }
        if(preview){
            const displayContent = content.length > 5000 ? '...(å‰æ–‡çœç•¥)\n\n' + content.slice(-5000) : content;
            preview.innerHTML = `<div style="font-size:18px;font-weight:bold;color:var(--primary);margin-bottom:16px;text-align:center">ã€Š${title}ã€‹</div>${displayContent}`;
            preview.scrollTop = preview.scrollHeight;
        }
    };
    
    let fullContent = '';
    let title = 'æ–°å‰µä½œçš„æ•…äº‹';
    let outline = '';
    
    try {
        // Step 1: ç”Ÿæˆå¤§ç¶±ï¼ˆæ‰€æœ‰é•·åº¦éƒ½å…ˆç”Ÿæˆå¤§ç¶±ï¼‰
        updateProgress('ğŸ“ Step 1/' + (config.segments + 1) + ': ç”Ÿæˆæ•…äº‹å¤§ç¶±...');
        
        const outlinePrompt = `ä½ æ˜¯å°ˆæ¥­å°èªªç­–åŠƒå¸«ã€‚è«‹ç‚ºä»¥ä¸‹æ•…äº‹ç”Ÿæˆè©³ç´°å¤§ç¶±ï¼š

ã€é¡å‹ã€‘${genre}
ã€å‰µæ„/è¨­å®šã€‘${idea}
${reference ? 'ã€åƒè€ƒé¢¨æ ¼ã€‘' + reference : ''}
ã€ç›®æ¨™ç¯‡å¹…ã€‘ç´„${config.words}å­—ï¼Œ${config.chapters}ç« ${seriesInfo}

âš ï¸ é‡è¦ï¼šé€™æ˜¯ç‚ºAIç•ªåŠ‡è¨­è¨ˆçš„æ•…äº‹ï¼
- æ¯ç« å°æ‡‰ä¸€é›†ï¼Œéœ€è¦æœ‰æ˜ç¢ºçš„é–‹å ´ã€è¡çªã€é«˜æ½®ã€æ‡¸å¿µ
- æ¯é›†çµå°¾å¿…é ˆæœ‰é‰¤å­ï¼Œè®“è§€çœ¾æƒ³çœ‹ä¸‹ä¸€é›†
- ç¯€å¥è¦ç·Šæ¹Šï¼Œæ¯åˆ†é˜éƒ½è¦æœ‰å…§å®¹

è«‹è¼¸å‡ºï¼š
1. ä¸€å€‹å¸å¼•äººçš„æ¨™é¡Œï¼ˆç”¨ã€Šã€‹åŒ…è£¹ï¼‰
2. æ•…äº‹æ¢—æ¦‚ï¼ˆ100å­—å…§ï¼‰
3. ä¸»è¦è§’è‰²ï¼ˆ3-5å€‹ï¼Œç°¡è¿°æ€§æ ¼å’Œå‹•æ©Ÿï¼‰
4. ç« ç¯€å¤§ç¶±ï¼ˆæ¯ç« ä¸€å¥è©±ï¼Œå…±${config.chapters}ç« ï¼Œæ¨™è¨»ã€Œèµ·æ‰¿è½‰åˆã€éšæ®µï¼‰

æ ¼å¼ï¼š
ã€Šæ¨™é¡Œã€‹
ã€æ•…äº‹æ¢—æ¦‚ã€‘...
ã€ä¸»è¦è§’è‰²ã€‘1. åå­—ï¼šæè¿° ...
ã€ç« ç¯€å¤§ç¶±ã€‘
ç¬¬1ç« ï¼šXXX
ç¬¬2ç« ï¼šXXX
...`;

        const outlineResponse = await callAgent('screenwriter', { content: outlinePrompt + '\n\nè«‹è¼¸å‡ºç´”æ–‡æœ¬ï¼Œä¸è¦JSONæ ¼å¼ï¼' });
        if (!outlineResponse?.result) throw new Error('å¤§ç¶±ç”Ÿæˆå¤±æ•—');
        
        // æ¸…ç†å¯èƒ½çš„JSONæ ¼å¼
        let outline = outlineResponse.result;
        if (outline.startsWith('{') || outline.startsWith('[')) {
            try {
                const parsed = JSON.parse(outline);
                outline = parsed.content || parsed.outline || parsed.story || JSON.stringify(parsed, null, 2);
            } catch(e) { /* ä¿æŒåŸæ¨£ */ }
        }
        const titleMatch = outline.match(/ã€Š([^ã€‹]+)ã€‹/);
        if (titleMatch) title = titleMatch[1];
        
        // é¡¯ç¤ºå¤§ç¶±é è¦½
        updatePreview('ã€æ•…äº‹å¤§ç¶±ã€‘\n' + outline, title);
        
        // Step 2+: åˆ†æ®µç”Ÿæˆæ­£æ–‡
        for(let seg = 0; seg < config.segments; seg++){
            const startCh = seg * chaptersPerSegment + 1;
            const endCh = Math.min((seg + 1) * chaptersPerSegment, config.chapters);
            
            updateProgress(`âœï¸ Step ${seg + 2}/${config.segments + 1}: æ’°å¯«ç¬¬${startCh}-${endCh}ç« ...`);
            
            const segmentPrompt = `ä½ æ˜¯å°ˆæ¥­å°èªªä½œå®¶ã€‚è«‹æ ¹æ“šå¤§ç¶±æ’°å¯«ç¬¬${startCh}åˆ°ç¬¬${endCh}ç« ã€‚

ã€æ•…äº‹å¤§ç¶±ã€‘
${outline}

ã€å·²å®Œæˆå…§å®¹æ‘˜è¦ã€‘
${fullContent.length > 0 ? fullContent.slice(-2000) + '...(ä»¥ä¸Šç‚ºå‰æ–‡)' : '(é€™æ˜¯é–‹ç¯‡)'}

ã€æœ¬æ¬¡ä»»å‹™ã€‘æ’°å¯«ç¬¬${startCh}ç« åˆ°ç¬¬${endCh}ç« 

è¦æ±‚ï¼š
1. æ¯ç« ç´„${Math.round(config.words / config.chapters)}å­—
2. ç« ç¯€æ ¼å¼ï¼šã€ç¬¬Xç«  ç« ç¯€åã€‘æ­£æ–‡...
3. äººç‰©å°è©±ç”Ÿå‹•ï¼Œæƒ…ç¯€ç·Šæ¹Š
4. æ‰¿æ¥å‰æ–‡ï¼Œä¿æŒé€£è²«
5. ${seg === config.segments - 1 ? 'é€™æ˜¯çµå±€éƒ¨åˆ†ï¼Œè«‹å®Œæ•´æ”¶å°¾' : 'ç« æœ«è¨­ç½®æ‡¸å¿µ'}

âš ï¸ é‡è¦ï¼šè¼¸å‡ºç´”æ–‡æœ¬å°èªªæ­£æ–‡ï¼Œä¸è¦JSONæ ¼å¼ï¼Œä¸è¦å ´æ™¯ç·¨è™Ÿï¼Œå°±åƒæ­£å¸¸çš„å°èªªä¸€æ¨£ï¼

ç›´æ¥é–‹å§‹å¯«æ­£æ–‡ï¼ˆä¸è¦ä»»ä½•å‰è¨€æˆ–è§£é‡‹ï¼‰ï¼š`;

            // ä½¿ç”¨æµå¼APIå¯¦æ™‚é¡¯ç¤º
            let segmentContent = '';
            try {
                const response = await fetch(`${API_BASE}/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: segmentPrompt,
                        systemPrompt: 'ä½ æ˜¯å°ˆæ¥­å°èªªä½œå®¶ï¼Œæ–‡ç­†å„ªç¾ï¼Œæ“…é•·è¬›æ•…äº‹ã€‚'
                    })
                });
                
                if(!response.ok) {
                    throw new Error(`APIéŒ¯èª¤ ${response.status}: ${response.statusText}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while(true) {
                    const { done, value } = await reader.read();
                    if(done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for(const line of lines) {
                        if(line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if(data === '[DONE]') continue;
                            try {
                                const parsed = JSON.parse(data);
                                if(parsed.content) {
                                    segmentContent += parsed.content;
                                    // å¯¦æ™‚æ›´æ–°é è¦½
                                    updatePreview(fullContent + '\n\n' + segmentContent, title);
                                }
                                if(parsed.error) {
                                    throw new Error(parsed.error);
                                }
                            } catch(e) {}
                        }
                    }
                }
            } catch(streamErr) {
                console.warn('æµå¼å¤±æ•—ï¼Œfallbackåˆ°æ™®é€šAPI:', streamErr);
                const segResponse = await callAgent('screenwriter', { content: segmentPrompt + '\n\nè«‹è¼¸å‡ºç´”æ–‡æœ¬å°èªªæ­£æ–‡ï¼Œä¸è¦JSONæ ¼å¼ï¼' });
                if (!segResponse?.result) throw new Error(`ç¬¬${startCh}-${endCh}ç« ç”Ÿæˆå¤±æ•—`);
                segmentContent = jsonToNovelText(segResponse.result);
            }
            
            // æœ€çµ‚æª¢æŸ¥ï¼šå¦‚æœå…§å®¹é‚„æ˜¯JSONæ ¼å¼ï¼Œè½‰æ›ç‚ºå°èªª
            segmentContent = jsonToNovelText(segmentContent);
            
            fullContent += '\n\n' + segmentContent;
            console.log(`Segment ${seg + 1} done, total length: ${fullContent.length}`);
            
            // æœ€çµ‚æ›´æ–°é è¦½
            updatePreview(fullContent, title);
            updateProgress(`âœ… ç¬¬${startCh}-${endCh}ç« å®Œæˆï¼å…± ${fullContent.length} å­—`);
        }
        
        // çµ„åˆæœ€çµ‚å…§å®¹
        const finalContent = `ã€Š${title}ã€‹\n\n${fullContent}`;
        console.log('Final title:', title, 'Content length:', finalContent.length);
        
        return { title, content: finalContent };
        
    } catch (err) {
        const errMsg = err.message || String(err);
        console.error('generateNovelWithAI error:', errMsg, err);
        throw new Error('å°èªªç”Ÿæˆå¤±æ•—: ' + errMsg);
    }
}

// ä¿ç•™èˆŠå‡½æ•¸åšå‚™ç”¨
function generateSampleNovel(genre, idea, reference){
    return { 
        title: 'ç”Ÿæˆä¸­...', 
        content: 'è«‹ç¨å€™ï¼ŒAIæ­£åœ¨å‰µä½œ...' 
    };
}

function previewNovel(){
    alert('å°èªªé è¦½ï¼š\n\n' + state.novel.text.slice(0, 500) + '...');
}

// è¤‡è£½å°èªªåˆ°å‰ªè²¼æ¿
function copyNovelToClipboard(){
    navigator.clipboard.writeText(state.novel.text).then(() => {
        alert('âœ… å°èªªå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
    }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—:', err);
        // fallback
        const ta = document.createElement('textarea');
        ta.value = state.novel.text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        alert('âœ… å°èªªå·²è¤‡è£½ï¼');
    });
}

// ä¸‹è¼‰å°èªªç‚ºTXTæ–‡ä»¶
function downloadNovel(){
    const blob = new Blob([state.novel.text], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${state.novel.title || 'å°èªª'}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ==================== åŠ‡æœ¬ç”Ÿæˆå™¨ ====================
let generatedScript = '';
let scriptTitle = 'åŠ‡æœ¬';
let episodeContents = []; // å­˜å„²æ¯é›†å…§å®¹

async function generateScript(){
    const outlineEl = document.getElementById('scriptOutline');
    const episodesEl = document.getElementById('scriptEpisodes');
    const durationEl = document.getElementById('scriptDuration');
    const batchEl = document.getElementById('scriptBatch');
    
    const outline = outlineEl?.value?.trim() || '';
    const totalEpisodes = parseInt(episodesEl?.value) || 100;
    const duration = parseInt(durationEl?.value) || 2;
    const batchSize = parseInt(batchEl?.value) || 10;
    
    if(!outline){
        alert('è«‹å…ˆè²¼å…¥æ•…äº‹å¤§ç¶±');
        return;
    }
    
    const titleMatch = outline.match(/ã€Š([^ã€‹]+)ã€‹/);
    scriptTitle = titleMatch ? titleMatch[1] : 'åŠ‡æœ¬';
    
    const statusDiv = document.getElementById('scriptStatus');
    const previewDiv = document.getElementById('scriptPreview');
    const genBtn = document.getElementById('genScriptBtn');
    const dlBtn = document.getElementById('dlScriptBtn');
    
    episodeContents = [];
    generatedScript = 'ã€Š' + scriptTitle + 'ã€‹å®Œæ•´åŠ‡æœ¬\nç”Ÿæˆæ™‚é–“ï¼š' + new Date().toLocaleString() + '\nç¸½é›†æ•¸ï¼š' + totalEpisodes + 'é›† | æ¯é›†' + duration + 'åˆ†é˜\n' + '='.repeat(50) + '\n\n';
    
    previewDiv.style.display = 'block';
    previewDiv.innerHTML = '<div id="episodeCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;padding:12px"></div><div id="currentWriting" style="border-top:1px solid var(--border);padding:12px;margin-top:12px"></div>';
    genBtn.disabled = true;
    genBtn.textContent = 'â³ ç”Ÿæˆä¸­...';
    
    const cardsDiv = document.getElementById('episodeCards');
    const writingDiv = document.getElementById('currentWriting');
    const wordsPerEpisode = duration * 200;
    
    try {
        for(let ep = 1; ep <= totalEpisodes; ep++){
            const pct = Math.round((ep/totalEpisodes)*100);
            
            // æ›´æ–°ç‹€æ…‹
            statusDiv.innerHTML = '<div style="display:flex;align-items:center;gap:12px"><div class="spinner"></div><div><div style="font-weight:600">æ­£åœ¨å¯«ç¬¬ ' + ep + '/' + totalEpisodes + ' é›†</div><div style="font-size:12px;color:var(--dim)">å·²å®Œæˆ ' + (ep-1) + ' é›† | ' + pct + '%</div></div></div><div style="margin-top:8px;background:var(--surface2);border-radius:4px;height:6px"><div style="background:var(--primary);height:100%;width:' + pct + '%;transition:width .3s"></div></div>';
            
            // æ§‹å»ºå–®é›†prompt
            const prompt = 'ä½ æ˜¯å°ˆæ¥­çŸ­åŠ‡ç·¨åŠ‡ã€‚æ ¹æ“šå¤§ç¶±å¯«ç¬¬' + ep + 'é›†åŠ‡æœ¬ã€‚\n\nã€å¤§ç¶±ã€‘\n' + outline.substring(0, 3000) + '\n\nã€å·²å®ŒæˆåŠ‡æƒ…ã€‘\n' + (episodeContents.slice(-2).join('\n---\n') || '(ç¬¬ä¸€é›†)') + '\n\nã€æœ¬é›†è¦æ±‚ã€‘\n- ç¬¬' + ep + 'é›†ï¼Œç´„' + wordsPerEpisode + 'å­—\n- æ ¼å¼ï¼š### ç¬¬' + ep + 'é›†ï¼šæ¨™é¡Œ\n- åŒ…å«å ´æ™¯æè¿°ã€å°è©±ã€ç•«é¢æŒ‡ç¤º\n- çµå°¾æœ‰æ‡¸å¿µæˆ–ç¬‘é»\n\nç›´æ¥é–‹å§‹å¯«ï¼š';

            let episodeContent = '';
            writingDiv.innerHTML = '<div style="color:var(--primary);font-weight:600;margin-bottom:8px">âœï¸ æ­£åœ¨å¯«ç¬¬ ' + ep + ' é›†...</div><pre id="liveContent" style="margin:0;white-space:pre-wrap;font-size:12px;line-height:1.6;max-height:200px;overflow-y:auto;color:var(--dim)"></pre>';
            
            try {
                const response = await fetch(API_BASE + '/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, systemPrompt: 'ä½ æ˜¯å°ˆæ¥­çŸ­åŠ‡ç·¨åŠ‡ã€‚è¼¸å‡ºç´”æ–‡æœ¬åŠ‡æœ¬ã€‚' })
                });
                
                if(!response.ok) {
                    throw new Error(`APIéŒ¯èª¤ ${response.status}: ${response.statusText}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                const liveEl = document.getElementById('liveContent');
                
                while(true) {
                    const { done, value } = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value);
                    for(const line of chunk.split('\n')) {
                        if(line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if(data === '[DONE]') continue;
                            try {
                                const parsed = JSON.parse(data);
                                if(parsed.content) {
                                    episodeContent += parsed.content;
                                    if(liveEl) liveEl.textContent = episodeContent.slice(-800);
                                }
                            } catch(e) {}
                        }
                    }
                }
            } catch(streamErr) {
                const resp = await callAgent('screenwriter', { content: prompt });
                episodeContent = resp?.result || '(ç”Ÿæˆå¤±æ•—)';
            }
            
            // æå–æ¨™é¡Œ
            const epTitleMatch = episodeContent.match(/ç¬¬\d+é›†[ï¼š:]\s*(.+?)[\n\r]/);
            const epTitle = epTitleMatch ? epTitleMatch[1].substring(0,10) : 'ç¬¬' + ep + 'é›†';
            
            episodeContents.push(episodeContent);
            generatedScript += episodeContent + '\n\n---\n\n';
            
            // æ·»åŠ å®Œæˆçš„é›†æ•¸å¡ç‰‡
            cardsDiv.innerHTML += '<div class="ep-card" onclick="toggleEpisode(' + ep + ')" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:8px;cursor:pointer;text-align:center;transition:all .2s"><div style="font-size:18px">âœ…</div><div style="font-size:11px;font-weight:600">ç¬¬' + ep + 'é›†</div><div style="font-size:10px;color:var(--dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + escapeHtml(epTitle) + '</div></div>';
            
            await new Promise(r => setTimeout(r, 500));
        }
        
        writingDiv.innerHTML = '<div style="color:var(--success);font-weight:600">ğŸ‰ å…¨éƒ¨ ' + totalEpisodes + ' é›†ç”Ÿæˆå®Œæˆï¼</div>';
        statusDiv.innerHTML = '<div style="padding:16px;background:rgba(255,10,53,.1);border:1px solid var(--primary);border-radius:8px"><p style="font-size:16px">âœ… åŠ‡æœ¬ç”Ÿæˆå®Œæˆï¼</p><p style="color:var(--dim);margin-top:8px">ç¸½å­—æ•¸ï¼š<strong style="color:var(--primary)">' + generatedScript.length.toLocaleString() + '</strong> å­— | ' + totalEpisodes + ' é›†</p></div>';
        
        dlBtn.style.display = 'inline-block';
        genBtn.disabled = false;
        genBtn.textContent = 'ğŸ”„ é‡æ–°ç”Ÿæˆ';
        state.novel = { title: scriptTitle, text: generatedScript, wordCount: generatedScript.length };
        
    } catch(err) {
        statusDiv.innerHTML = '<div style="color:var(--error);padding:12px">âŒ ç”Ÿæˆå¤±æ•—ï¼š' + err.message + '</div>';
        genBtn.disabled = false;
        genBtn.textContent = 'ğŸ¬ é‡è©¦';
    }
}

function toggleEpisode(ep){
    const content = episodeContents[ep-1];
    if(!content) return;
    
    // å‰µå»ºå½ˆçª—é¡¯ç¤ºå®Œæ•´å…§å®¹
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px';
    overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };
    
    overlay.innerHTML = '<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;max-width:700px;width:100%;max-height:80vh;overflow:hidden;display:flex;flex-direction:column"><div style="padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><span style="font-weight:600">ğŸ“º ç¬¬ ' + ep + ' é›†</span><button onclick="this.closest(\'div\').parentElement.remove()" style="background:none;border:none;color:var(--dim);font-size:20px;cursor:pointer">âœ•</button></div><pre style="padding:16px;margin:0;overflow-y:auto;white-space:pre-wrap;font-size:13px;line-height:1.8">' + escapeHtml(content) + '</pre></div>';
    
    document.body.appendChild(overlay);
}

function downloadScript(){
    const blob = new Blob([generatedScript], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = scriptTitle + '_å®Œæ•´åŠ‡æœ¬.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ==================== é‡æ–°ç”Ÿæˆå‡½æ•¸ï¼ˆå°è©±å¼ï¼‰ ====================
function showRegenerateDialog(type, title){
    const dialog = document.createElement('div');
    dialog.id = 'regenerateDialog';
    dialog.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1000';
    
    // å°è©±å¼æç¤ºèª
    const prompts = {
        concept: 'é€™å€‹é«˜æ¦‚å¿µå“ªè£¡ä¸æ»¿æ„ï¼Ÿä½ å¸Œæœ›æ€éº¼èª¿æ•´ï¼Ÿ',
        chapters: 'ç« ç¯€æ‹†åˆ†æœ‰ä»€éº¼å•é¡Œï¼Ÿæƒ³æ€éº¼é‡æ–°åŠƒåˆ†ï¼Ÿ',
        characters: 'è§’è‰²è¨­è¨ˆå“ªè£¡éœ€è¦ä¿®æ”¹ï¼Ÿ',
        storyboard: 'åˆ†é¡æœ‰ä»€éº¼å•é¡Œï¼Ÿæƒ³æ€éº¼èª¿æ•´ï¼Ÿ'
    };
    
    dialog.innerHTML = `
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;width:90%;max-width:480px;overflow:hidden">
            <!-- å°è©±é ­éƒ¨ -->
            <div style="background:var(--primary);padding:16px 20px;display:flex;align-items:center;gap:12px">
                <div style="width:40px;height:40px;background:rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px">ğŸ¤–</div>
                <div>
                    <div style="font-weight:600;color:#fff">${title}Agent</div>
                    <div style="font-size:11px;color:rgba(255,255,255,.7)">æ­£åœ¨è½å–ä½ çš„æ„è¦‹...</div>
                </div>
            </div>
            
            <!-- å°è©±å…§å®¹ -->
            <div style="padding:20px">
                <!-- Agent å•é¡Œ -->
                <div style="display:flex;gap:12px;margin-bottom:16px">
                    <div style="width:32px;height:32px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">ğŸ¤–</div>
                    <div style="background:var(--surface2);padding:12px 16px;border-radius:4px 16px 16px 16px;max-width:85%">
                        <p style="margin:0;line-height:1.6">${prompts[type] || 'æœ‰ä»€éº¼æƒ³èª¿æ•´çš„ï¼Ÿ'}</p>
                    </div>
                </div>
                
                <!-- ç”¨æˆ¶è¼¸å…¥ -->
                <div style="display:flex;gap:12px;align-items:flex-end">
                    <div style="flex:1">
                        <textarea id="regenInstruction" class="form-input" style="min-height:80px;border-radius:16px;resize:none" placeholder="ç›´æ¥å‘Šè¨´æˆ‘ä½ çš„æƒ³æ³•...&#10;ä¾‹å¦‚ï¼šLoglineè¦æ›´æœ‰æ‡¸å¿µæ„Ÿã€çªå‡ºæˆé•·ä¸»é¡Œ"></textarea>
                    </div>
                </div>
                
                <!-- å¿«æ·å›è¦† -->
                <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px">
                    <button class="quick-reply" onclick="document.getElementById('regenInstruction').value='ä¸å¤ å¸å¼•äººï¼Œè¦æ›´æœ‰å¼µåŠ›'">ğŸ˜ ä¸å¤ å¸å¼•</button>
                    <button class="quick-reply" onclick="document.getElementById('regenInstruction').value='é¢¨æ ¼ä¸å°ï¼Œæƒ³æ›´æ–‡è—ä¸€é»'">ğŸ¨ é¢¨æ ¼ä¸å°</button>
                    <button class="quick-reply" onclick="document.getElementById('regenInstruction').value='å…§å®¹æœ‰éŒ¯èª¤éœ€è¦ä¿®æ­£'">âŒ æœ‰éŒ¯èª¤</button>
                    <button class="quick-reply" onclick="document.getElementById('regenInstruction').value='æƒ³æ›å€‹å®Œå…¨ä¸åŒçš„æ–¹å‘è©¦è©¦'">ğŸ”€ æ›æ–¹å‘</button>
                </div>
            </div>
            
            <!-- åº•éƒ¨æŒ‰éˆ• -->
            <div style="padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end">
                <button class="btn" onclick="closeRegenerateDialog()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="doRegenerate('${type}')">ç™¼é€ âœ“</button>
            </div>
        </div>
    `;
    document.body.appendChild(dialog);
    
    // èšç„¦è¼¸å…¥æ¡†
    setTimeout(() => document.getElementById('regenInstruction')?.focus(), 100);
}

function closeRegenerateDialog(){
    const dialog = document.getElementById('regenerateDialog');
    if(dialog) dialog.remove();
}

function doRegenerate(type){
    const instruction = document.getElementById('regenInstruction').value.trim();
    
    if(!instruction){
        alert('è«‹å‘Šè¨´æˆ‘ä½ æƒ³æ€éº¼èª¿æ•´ï½');
        return;
    }
    
    // ä¿å­˜ç”¨æˆ¶åé¥‹
    if(!state.feedback) state.feedback = [];
    state.feedback.push({type, instruction, time: new Date()});
    
    closeRegenerateDialog();
    
    const content = document.getElementById('contentArea');
    content.innerHTML = `
        <div class="content-card">
            <div class="loading">
                <div class="spinner"></div>
                <span>æ ¹æ“šä½ çš„æ„è¦‹é‡æ–°ç”Ÿæˆ...</span>
            </div>
            ${instruction ? `<p style="margin-top:16px;padding:12px;background:var(--surface2);border-radius:8px;font-size:13px;color:var(--dim)">ğŸ“ ${instruction}</p>` : ''}
        </div>
    `;
    
    setTimeout(() => {
        switch(type){
            case 'concept':
                state.concept = generateConcept();
                showStep(3);  // é«˜æ¦‚å¿µæ˜¯Step 3
                break;
            case 'chapters':
                state.chapters = splitChapters();
                showStep(4);  // ç« ç¯€æ˜¯Step 4
                break;
            case 'characters':
                state.characters = extractCharacters();
                showStep(5);  // è§’è‰²æ˜¯Step 5
                break;
            case 'storyboard':
                state.storyboard = generateStoryboard();
                showStep(9);  // åˆ†é¡æ˜¯Step 9
                break;
        }
    }, 2000);
}

function regenerateConcept(){
    showRegenerateDialog('concept', 'é«˜æ¦‚å¿µ');
}

function regenerateStoryboard(){
    showRegenerateDialog('storyboard', 'åˆ†é¡');
}

function resplitChapters(){
    showRegenerateDialog('chapters', 'ç« ç¯€');
}

function reextractCharacters(){
    showRegenerateDialog('characters', 'è§’è‰²');
}

function loadDemoNovel(){
    const titleInput = document.getElementById('novelTitle');
    const textArea = document.getElementById('novelText');
    
    if(titleInput) titleInput.value = 'æµ·ä¸Šçµ²ç¶¢ä¹‹è·¯å¯†ç¢¼';
    if(textArea) textArea.value = DEMO_NOVEL;
    
    // å¦‚æœæ˜¯ä¸Šå‚³æ¨¡å¼ï¼Œä¹Ÿæ›´æ–°ç‹€æ…‹
    state.novel.title = 'æµ·ä¸Šçµ²ç¶¢ä¹‹è·¯å¯†ç¢¼';
    state.novel.text = DEMO_NOVEL;
    state.novel.wordCount = DEMO_NOVEL.length;
    
    const statusDiv = document.getElementById('uploadStatus');
    const analyzeBtn = document.getElementById('analyzeBtn');
    
    if(statusDiv){
        statusDiv.innerHTML = `
            <div style="padding:16px;background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:8px">
                <p style="color:var(--text)">âœ… ç¤ºä¾‹å°èªªå·²è¼‰å…¥ï¼</p>
                <p style="margin-top:8px">
                    <span style="color:var(--dim)">æ¨™é¡Œï¼š</span>æµ·ä¸Šçµ²ç¶¢ä¹‹è·¯å¯†ç¢¼<br>
                    <span style="color:var(--dim)">å­—æ•¸ï¼š</span><strong style="color:var(--primary)">${DEMO_NOVEL.length.toLocaleString()}</strong> å­—
                </p>
            </div>
        `;
    }
    if(analyzeBtn) analyzeBtn.disabled = false;
}

function analyzeNovel(){
    // å¾ä¸Šå‚³æ¨¡å¼åˆ†æ
    const title = document.getElementById('novelTitle')?.value.trim() || state.novel.title;
    const text = state.novel.text;
    
    if(!text){
        alert('è«‹å…ˆä¸Šå‚³æˆ–è¼‰å…¥å°èªª');
        return;
    }
    
    state.novel = {
        title: title || 'æœªå‘½åå°èªª',
        text: text,
        wordCount: text.length
    };
    
    document.getElementById('novelStats').textContent = `${state.novel.title} | ${(text.length/10000).toFixed(1)}è¬å­—`;
    
    nextStep();
}

// ==================== Step 3: é«˜æ¦‚å¿µ ====================
function renderStep2(){
    // å·²æœ‰åˆ†æçµæœ â†’ é¡¯ç¤ºçµæœ
    if(state.concept?.logline){
        return renderConceptResult();
    }
    
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ’¡</span> æ¦‚å¿µè¨­è¨ˆå¸«</h3>
            
            <div id="conceptAgentUI">
                <div style="background:var(--surface2);border-radius:8px;padding:20px;text-align:center">
                    <div style="font-size:48px;margin-bottom:12px">ğŸ’¡</div>
                    <div style="font-size:14px;color:var(--dim);margin-bottom:16px">
                        åŸºæ–¼è¨ªè«‡å›ç­”ï¼Œç”ŸæˆLoglineå’Œæ•…äº‹å®šä½
                    </div>
                    <button class="btn btn-primary" onclick="runConceptAgent()" style="padding:12px 32px">
                        ğŸš€ ç”Ÿæˆé«˜æ¦‚å¿µ
                    </button>
                </div>
            </div>
        </div>
    `;
}

// æ¦‚å¿µè¨­è¨ˆå¸«ä½¿ç”¨çš„Skillsæ¸…å–®
const CONCEPT_SKILLS = [
    { id: 'high_concept', name: 'é«˜æ¦‚å¿µæç…‰', desc: 'ä¸€å¥è©±èªªæ¸…æ•…äº‹' },
    { id: 'hook_design', name: 'é‰¤å­è¨­è¨ˆ', desc: 'è®“è§€çœ¾æƒ³çœ‹ä¸‹å»' },
    { id: 'addictive_design', name: 'ä¸Šç™®æ©Ÿåˆ¶', desc: 'æƒ…ç¯€æˆç™®é»' },
    { id: 'viral_elements', name: 'ç—…æ¯’å‚³æ’­å…ƒç´ ', desc: 'ç¤¾äº¤åˆ†äº«é»' }
];

async function runConceptAgent(){
    const ui = document.getElementById('conceptAgentUI');
    
    // å‰µå»ºè©³ç´°é€²åº¦UI
    ui.innerHTML = `
        <div style="background:var(--surface2);border-radius:8px;padding:20px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <div class="loading-spinner"></div>
                <div>
                    <div style="font-weight:600" id="conceptStatusText">ğŸ’¡ æ¦‚å¿µè¨­è¨ˆå¸« å•Ÿå‹•ä¸­...</div>
                    <div style="font-size:12px;color:var(--dim)" id="conceptSubStatus">æº–å‚™åˆ†æ...</div>
                </div>
            </div>
            <div style="background:var(--bg);border-radius:4px;height:4px;overflow:hidden">
                <div id="conceptProgressBar" style="background:var(--primary);height:100%;width:0%;transition:width .5s"></div>
            </div>
            <div id="conceptSteps" style="margin-top:16px;font-size:12px;color:var(--dim)"></div>
        </div>
    `;
    
    const progressBar = document.getElementById('conceptProgressBar');
    const statusText = document.getElementById('conceptStatusText');
    const subStatus = document.getElementById('conceptSubStatus');
    const stepsEl = document.getElementById('conceptSteps');
    
    const addStep = (icon, text) => {
        stepsEl.insertAdjacentHTML('beforeend', `<div style="padding:4px 0">${icon} ${text}</div>`);
    };
    
    try {
        // Step 1: é€£æ¥
        addStep('ğŸ”—', 'æ­£åœ¨é€£æ¥é«˜æ¦‚å¿µæ™ºèƒ½é«”...');
        const apiOk = await checkApiHealth();
        progressBar.style.width = '10%';
        
        if (!apiOk) {
            throw new Error('æ™ºèƒ½é«”é€£æ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        }
        addStep('âœ…', 'é€£æ¥æˆåŠŸ');
        await sleep(200);
        
        // Step 2: è®€å–è¨ªè«‡å›ç­”
        addStep('ğŸ“‹', 'æ­£åœ¨è®€å–ä½ çš„è¨ªè«‡å›ç­”...');
        statusText.textContent = 'ğŸ“‹ è®€å–è¨ªè«‡å›ç­”...';
        subStatus.textContent = 'ç†è§£ä½ å°æ•…äº‹çš„æƒ³æ³•...';
        progressBar.style.width = '20%';
        await sleep(300);
        
        // Step 3: åˆ†æè§’è‰²
        addStep('ğŸ‘¥', 'åˆ†ææ•…äº‹ä¸­çš„æ ¸å¿ƒè§’è‰²...');
        statusText.textContent = 'ğŸ‘¥ åˆ†æè§’è‰²...';
        progressBar.style.width = '30%';
        await sleep(300);
        
        // Step 4: æå–è¡çª
        addStep('âš”ï¸', 'æå–æ•…äº‹çš„æ ¸å¿ƒè¡çª...');
        statusText.textContent = 'âš”ï¸ åˆ†æè¡çª...';
        progressBar.style.width = '40%';
        await sleep(300);
        
        // Step 5: ç¢ºå®šé¡å‹
        addStep('ğŸ­', 'ç¢ºå®šæ•…äº‹é¡å‹å’ŒåŸºèª¿...');
        statusText.textContent = 'ğŸ­ ç¢ºå®šé¡å‹...';
        progressBar.style.width = '50%';
        await sleep(300);
        
        // Step 6: ç”ŸæˆLogline
        addStep('ğŸ’¡', 'é«˜æ¦‚å¿µæ™ºèƒ½é«”æ­£åœ¨ç”Ÿæˆä¸€å¥è©±æ•…äº‹...');
        statusText.textContent = 'ğŸ’¡ ç”ŸæˆLogline...';
        subStatus.textContent = 'ç”¨ä¸€å¥è©±èªªæ¸…æ¥šä½ çš„æ•…äº‹...';
        progressBar.style.width = '60%';
        
        // é–‹å§‹å€’è¨ˆæ™‚
        startCountdown('concept', stepsEl);
        
        const apiResponse = await callAgent('concept', {
            analysis: state.aiAnalysis,
            interview: state.interview
        });
        
        // åœæ­¢å€’è¨ˆæ™‚
        stopCountdown();
        progressBar.style.width = '80%';
        addStep('ğŸ¯', 'æç…‰æ•…äº‹è³£é»...');
        await sleep(200);
        
        // è§£æè¿”å›
        let concept;
        try {
            const resultText = apiResponse.result || apiResponse;
            if(typeof resultText === 'string'){
                const cleaned = resultText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                concept = JSON.parse(cleaned);
            } else {
                concept = resultText;
            }
        } catch(e){
            console.error('è§£æå¤±æ•—:', e);
            concept = apiResponse.result || apiResponse;
        }
        
        progressBar.style.width = '100%';
        addStep('âœ…', 'Logline ç”Ÿæˆå®Œæˆï¼');
        
        state.concept = concept;
        statusText.textContent = 'âœ… é«˜æ¦‚å¿µç”Ÿæˆå®Œæˆï¼';
        subStatus.textContent = '';
        
        setTimeout(() => showStep(3), 500);
        
    } catch (err) {
        ui.innerHTML = renderErrorRetryUI('æ¦‚å¿µè¨­è¨ˆå¸«', 'runConceptAgent()');
    }
}

// å·²ç§»é™¤æ‰‹å‹•æ¨¡å¼ - å…¨è‡ªå‹•åŒ–

function renderConceptResult(){
    const c = state.concept;
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ’¡</span> é«˜æ¦‚å¿µåˆ†æ</h3>
            
            <div class="report">
                <h4>ğŸ¯ Logline</h4>
                <p style="font-size:16px;color:var(--primary);padding:16px;background:var(--bg);border-radius:8px;font-style:italic;line-height:1.8;border-left:3px solid var(--primary)">
                    "${c.logline}"
                </p>
            </div>
            
            <div class="report">
                <h4>ğŸ“Š æ•…äº‹å®šä½</h4>
                <div class="report-grid">
                    <div class="stat-box"><div class="stat-label">é¡å‹</div><div class="stat-val" style="font-size:14px">${c.genre || '-'}</div></div>
                    <div class="stat-box"><div class="stat-label">ä¸»é¡Œ</div><div class="stat-val" style="font-size:14px">${c.theme || '-'}</div></div>
                    <div class="stat-box"><div class="stat-label">å—çœ¾</div><div class="stat-val" style="font-size:14px">${c.audience || '-'}</div></div>
                    <div class="stat-box"><div class="stat-label">æ™‚ä»£</div><div class="stat-val" style="font-size:14px">${c.era || '-'}</div></div>
                </div>
            </div>
            
            <div class="report">
                <h4>ğŸ£ æ ¸å¿ƒè³£é»</h4>
                <ul style="color:var(--dim);font-size:14px;padding-left:20px">
                    ${(c.hooks || []).map(h => `<li style="margin:8px 0">${h}</li>`).join('')}
                </ul>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-back" onclick="prevStep()">â† è¿”å›</button>
                <button class="btn" onclick="state.concept=null;showStep(3)">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ â†’</button>
            </div>
        </div>
    `;
}

// å·²åˆªé™¤èˆŠçš„æ‰‹å‹•æ¨¡å¼å‡½æ•¸ generateConceptPrompt å’Œ applyConceptResult

// ==================== Step 4: ç« ç¯€æ‹†åˆ† ====================
// ç« ç¯€ç­–åŠƒå¸«ä½¿ç”¨çš„Skills
const CHAPTER_SKILLS = [
    { id: 'savethecat_15beats', name: 'Save the Cat 15ç¯€æ‹', desc: 'Blake Snyderçµæ§‹' },
    { id: 'mckee_sequence', name: 'McKeeåºåˆ—çµæ§‹', desc: 'åƒ¹å€¼è®ŠåŒ–è¨­è¨ˆ' },
    { id: 'hook_cliffhanger', name: 'ç« ç¯€é‰¤å­è¨­è¨ˆ', desc: 'æ‡¸å¿µ/åè½‰/æ­éœ²' },
    { id: 'serialized_drama', name: 'é€£è¼‰åŠ‡ç¯€å¥', desc: 'A/Bç·šäº¤ç¹”' }
];

// ç« ç¯€é…ç½®ç‹€æ…‹
let chapterConfig = {
    episodes: 10,
    durationPerEpisode: 10,
    estimated: null
};

function renderStep3(){
    // å·²æœ‰åˆ†æçµæœ â†’ é¡¯ç¤ºçµæœ
    if(state.chapters?.length > 0 && state.chapters[0].summary?.length > 20){
        return renderChaptersResult();
    }
    
    // å…ˆåšåŸºç¤ç« ç¯€è­˜åˆ¥
    if(state.chapters.length === 0){
        state.chapters = splitChaptersBasic();
    }
    
    // ä¼°ç®—è‡ªç„¶æ™‚é•·ï¼šå­—æ•¸Ã·800ï¼ˆ4:1å£“ç¸®æ¯” + 200å­—/åˆ†é˜èªé€Ÿï¼‰
    const naturalDuration = Math.round(state.novel.wordCount / 800);
    const userDuration = chapterConfig.episodes * chapterConfig.durationPerEpisode;
    // å…§å®¹é£½å’Œåº¦ = è‡ªç„¶æ™‚é•· / ç”¨æˆ¶é…ç½®æ™‚é•·
    // 100% = å‰›å¥½ | >100% = å…§å®¹éå¤šéœ€åˆªæ¸› | <100% = å…§å®¹ä¸è¶³éœ€æ“´å……
    const saturation = (naturalDuration / userDuration).toFixed(2);
    
    let matchStatus = '', matchColor = '';
    if(saturation >= 0.7 && saturation <= 1.3){
        matchStatus = 'âœ… é…ç½®åˆç†';
        matchColor = 'var(--success)';
    } else if(saturation > 1.3 && saturation <= 1.6){
        matchStatus = 'âš ï¸ å…§å®¹éå¤šï¼Œå¯èƒ½éœ€è¦åˆªæ¸›æƒ…ç¯€';
        matchColor = 'var(--warning)';
    } else if(saturation >= 0.5 && saturation < 0.7){
        matchStatus = 'âš ï¸ å…§å®¹åå°‘ï¼Œç¯€å¥å¯èƒ½æ‹–æ²“';
        matchColor = 'var(--warning)';
    } else if(saturation > 1.6){
        matchStatus = 'âŒ å…§å®¹åš´é‡è¶…è¼‰ï¼Œå¿…é ˆå¤§å¹…åˆªæ¸›æˆ–å¢åŠ é›†æ•¸';
        matchColor = 'var(--error)';
    } else {
        matchStatus = 'âŒ å…§å®¹ä¸è¶³ï¼Œè€ƒæ…®æ¸›å°‘é›†æ•¸æˆ–æ“´å……å…§å®¹';
        matchColor = 'var(--error)';
    }
    
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ“‘</span> ç« ç¯€æ™ºèƒ½é«”</h3>
            
            <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px">
                <div style="font-size:13px;color:var(--dim);margin-bottom:8px">
                    ğŸ“Š æ•…äº‹æ•¸æ“šï¼š${state.chapters.length} å€‹åŸå§‹ç« ç¯€ï¼Œ${state.novel.wordCount.toLocaleString()} å­—
                </div>
                <div style="font-size:13px;color:var(--dim);margin-bottom:12px">
                    â±ï¸ é ä¼°ç•ªåŠ‡æ™‚é•·ï¼šç´„ <strong>${naturalDuration}</strong> åˆ†é˜ï¼ˆæŒ‰800å­—/åˆ†é˜ï¼‰
                </div>
                <div style="background:rgba(255,10,53,0.1);border:1px solid rgba(255,10,53,0.3);border-radius:8px;padding:12px">
                    <div style="font-size:12px;color:var(--primary);font-weight:600;margin-bottom:8px">ğŸ’¡ æ¨è–¦é…ç½®ï¼ˆé»æ“Šé¸æ“‡ï¼‰</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        ${generateRecommendations(naturalDuration)}
                    </div>
                    <div style="font-size:10px;color:var(--dim);margin-top:8px">
                        åŸºæ–¼ ${naturalDuration} åˆ†é˜è‡ªç„¶æ™‚é•·è¨ˆç®—ï¼Œé£½å’Œåº¦100%æœ€ä½³
                    </div>
                </div>
            </div>
            
            <!-- é…ç½®å€åŸŸ -->
            <div style="background:linear-gradient(135deg, var(--surface2), var(--bg));border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid var(--border)">
                <div style="font-weight:600;margin-bottom:16px;color:var(--primary)">ğŸ¬ ç•ªåŠ‡é…ç½®</div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
                    <div>
                        <label style="font-size:12px;color:var(--dim);display:block;margin-bottom:6px">ç›®æ¨™é›†æ•¸</label>
                        <select id="episodeCount" onchange="updateChapterConfig()" style="width:100%;padding:10px;border-radius:6px;background:var(--bg);border:1px solid var(--border);color:var(--text)">
                            <option value="3" ${chapterConfig.episodes===3?'selected':''}>3 é›†ï¼ˆçŸ­ç¯‡ï¼‰</option>
                            <option value="5" ${chapterConfig.episodes===5?'selected':''}>5 é›†</option>
                            <option value="8" ${chapterConfig.episodes===8?'selected':''}>8 é›†</option>
                            <option value="10" ${chapterConfig.episodes===10?'selected':''}>10 é›†ï¼ˆæ¨™æº–ï¼‰</option>
                            <option value="12" ${chapterConfig.episodes===12?'selected':''}>12 é›†</option>
                            <option value="15" ${chapterConfig.episodes===15?'selected':''}>15 é›†</option>
                            <option value="20" ${chapterConfig.episodes===20?'selected':''}>20 é›†ï¼ˆé•·ç¯‡ï¼‰</option>
                            <option value="24" ${chapterConfig.episodes===24?'selected':''}>24 é›†</option>
                            <option value="30" ${chapterConfig.episodes===30?'selected':''}>30 é›†</option>
                            <option value="50" ${chapterConfig.episodes===50?'selected':''}>50 é›†ï¼ˆè¶…é•·ç¯‡ï¼‰</option>
                            <option value="80" ${chapterConfig.episodes===80?'selected':''}>80 é›†</option>
                            <option value="100" ${chapterConfig.episodes===100?'selected':''}>100 é›†ï¼ˆå²è©©ç´šï¼‰</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:12px;color:var(--dim);display:block;margin-bottom:6px">æ¯é›†æ™‚é•·</label>
                        <select id="episodeDuration" onchange="updateChapterConfig()" style="width:100%;padding:10px;border-radius:6px;background:var(--bg);border:1px solid var(--border);color:var(--text)">
                            <option value="3" ${chapterConfig.durationPerEpisode===3?'selected':''}>3 åˆ†é˜ï¼ˆæ³¡éºµç•ªï¼‰</option>
                            <option value="5" ${chapterConfig.durationPerEpisode===5?'selected':''}>5 åˆ†é˜</option>
                            <option value="8" ${chapterConfig.durationPerEpisode===8?'selected':''}>8 åˆ†é˜</option>
                            <option value="10" ${chapterConfig.durationPerEpisode===10?'selected':''}>10 åˆ†é˜ï¼ˆæ¨™æº–ï¼‰</option>
                            <option value="12" ${chapterConfig.durationPerEpisode===12?'selected':''}>12 åˆ†é˜</option>
                            <option value="15" ${chapterConfig.durationPerEpisode===15?'selected':''}>15 åˆ†é˜</option>
                            <option value="20" ${chapterConfig.durationPerEpisode===20?'selected':''}>20 åˆ†é˜ï¼ˆé›»å½±æ„Ÿï¼‰</option>
                        </select>
                    </div>
                </div>
                
                <!-- é…ç½®ç¢ºèª -->
                <div style="background:var(--bg);border-radius:8px;padding:12px;text-align:center">
                    <div style="font-size:13px">
                        æ‚¨çš„é…ç½®ï¼š<strong>${chapterConfig.episodes}é›† Ã— ${chapterConfig.durationPerEpisode}åˆ†é˜ = ${userDuration}åˆ†é˜</strong>
                    </div>
                </div>
            </div>
            
            <div id="chapterAgentUI">
                <div style="text-align:center;padding:20px">
                    <button class="btn btn-primary" onclick="runChapterAgent()" style="padding:16px 40px;font-size:16px">
                        ğŸš€ é–‹å§‹AIç« ç¯€åˆ†æ
                    </button>
                    <div style="font-size:12px;color:var(--dim);margin-top:12px">
                        æ™ºèƒ½é«”æœƒæ ¹æ“šé…ç½®çµ¦å‡ºå°ˆæ¥­å»ºè­°ï¼ˆåˆªæ¸›/æ“´å……ï¼‰
                    </div>
                </div>
            </div>
        </div>
    `;
}

function applyRecommendedConfig(episodes, duration){
    chapterConfig.episodes = episodes;
    chapterConfig.durationPerEpisode = duration;
    showStep(state.currentStep);  // åˆ·æ–°æ˜¾ç¤º
}

// ç”Ÿæˆåˆç†çš„æ¨è–¦é…ç½®
function generateRecommendations(naturalDuration){
    const recommendations = [];
    
    // å¸¸è¦‹çš„é›†æ•¸å’Œæ™‚é•·çµ„åˆ
    const episodeLengths = [5, 8, 10, 12, 15, 20];
    const targetEpisodeCounts = [6, 8, 10, 12, 15, 20, 24];
    
    // æ‰¾å‡ºæœ€ä½³åŒ¹é…
    const candidates = [];
    for(const len of episodeLengths){
        for(const count of targetEpisodeCounts){
            const total = len * count;
            // å…§å®¹é£½å’Œåº¦ = è‡ªç„¶æ™‚é•· / é…ç½®æ™‚é•·
            const saturation = naturalDuration / total;
            // åªé¸é£½å’Œåº¦åœ¨70%-130%ä¹‹é–“çš„
            if(saturation >= 0.7 && saturation <= 1.3){
                candidates.push({
                    episodes: count,
                    duration: len,
                    total: total,
                    saturation: saturation,
                    diff: Math.abs(1 - saturation)
                });
            }
        }
    }
    
    // æŒ‰é£½å’Œåº¦æ’åºï¼Œå–å‰4å€‹
    candidates.sort((a, b) => a.diff - b.diff);
    const best = candidates.slice(0, 4);
    
    // å¦‚æœæ²’æœ‰åˆé©çš„ï¼Œç”Ÿæˆä¸€å€‹100%é£½å’Œåº¦çš„
    if(best.length === 0){
        const ep = Math.round(naturalDuration / 10);
        best.push({ episodes: ep, duration: 10, saturation: 1 });
    }
    
    return best.map(r => `
        <button class="btn" onclick="applyRecommendedConfig(${r.episodes}, ${r.duration})" 
                style="font-size:11px;padding:6px 12px">
            ${r.episodes}é›†Ã—${r.duration}åˆ†=${r.episodes * r.duration}åˆ†
        </button>
    `).join('');
}

function updateChapterConfig(){
    chapterConfig.episodes = parseInt(document.getElementById('episodeCount').value);
    chapterConfig.durationPerEpisode = parseInt(document.getElementById('episodeDuration').value);
    
    // é‡æ–°è¨ˆç®—å…§å®¹é£½å’Œåº¦ï¼ˆå­—æ•¸Ã·800ï¼‰
    const naturalDuration = Math.round(state.novel.wordCount / 800);
    const userDuration = chapterConfig.episodes * chapterConfig.durationPerEpisode;
    // å…§å®¹é£½å’Œåº¦ = è‡ªç„¶æ™‚é•· / ç”¨æˆ¶é…ç½®æ™‚é•·
    const saturation = naturalDuration / userDuration;
    
    let matchStatus = '', matchColor = '';
    if(saturation >= 0.7 && saturation <= 1.3){
        matchStatus = 'âœ… é…ç½®åˆç†';
        matchColor = 'var(--success)';
    } else if(saturation > 1.3 && saturation <= 1.6){
        matchStatus = 'âš ï¸ å…§å®¹éå¤šï¼Œå¯èƒ½éœ€è¦åˆªæ¸›æƒ…ç¯€';
        matchColor = 'var(--warning)';
    } else if(saturation >= 0.5 && saturation < 0.7){
        matchStatus = 'âš ï¸ å…§å®¹åå°‘ï¼Œç¯€å¥å¯èƒ½æ‹–æ²“';
        matchColor = 'var(--warning)';
    } else if(saturation > 1.6){
        matchStatus = 'âŒ å…§å®¹åš´é‡è¶…è¼‰ï¼Œå¿…é ˆå¤§å¹…åˆªæ¸›æˆ–å¢åŠ é›†æ•¸';
        matchColor = 'var(--error)';
    } else {
        matchStatus = 'âŒ å…§å®¹ä¸è¶³ï¼Œè€ƒæ…®æ¸›å°‘é›†æ•¸æˆ–æ“´å……å…§å®¹';
        matchColor = 'var(--error)';
    }
    
    const statusEl = document.getElementById('configMatchStatus');
    if(statusEl){
        statusEl.innerHTML = matchStatus;
        statusEl.style.color = matchColor;
    }
}

// ==================== é•·ç¯‡åˆ†æ‰¹ç”Ÿæˆ ====================
let batchState = {
    isPaused: false,
    currentBatch: 0,
    allEpisodes: [],
    totalBatches: 0
};

async function runChapterAgentBatch(totalEpisodes, batchSize = 25) {
    const ui = document.getElementById('chapterAgentUI');
    const totalBatches = Math.ceil(totalEpisodes / batchSize);
    batchState = { isPaused: false, currentBatch: 0, allEpisodes: [], totalBatches };
    
    ui.innerHTML = `
        <div style="background:var(--surface2);border-radius:8px;padding:20px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <div>
                    <div style="font-weight:600" id="batchStatusText">ğŸ“‘ é•·ç¯‡åˆ†æ‰¹ç”Ÿæˆæ¨¡å¼</div>
                    <div style="font-size:12px;color:var(--dim)" id="batchSubStatus">ç¸½è¨ˆ ${totalEpisodes} é›†ï¼Œåˆ† ${totalBatches} æ‰¹æ¬¡</div>
                </div>
                <button id="batchPauseBtn" onclick="toggleBatchPause()" class="btn" style="font-size:11px;padding:6px 12px">â¸ï¸ æš«åœ</button>
            </div>
            <div style="background:var(--bg);border-radius:4px;height:8px;overflow:hidden;margin-bottom:12px">
                <div id="batchProgressBar" style="background:var(--primary);height:100%;width:0%;transition:width .5s"></div>
            </div>
            <div id="batchCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:6px;margin-bottom:12px"></div>
            <div id="batchLog" style="font-size:11px;color:var(--dim);max-height:150px;overflow-y:auto"></div>
        </div>
    `;
    
    const progressBar = document.getElementById('batchProgressBar');
    const statusText = document.getElementById('batchStatusText');
    const subStatus = document.getElementById('batchSubStatus');
    const cardsDiv = document.getElementById('batchCards');
    const logDiv = document.getElementById('batchLog');
    
    const addLog = (text) => {
        logDiv.insertAdjacentHTML('beforeend', `<div style="padding:2px 0">${new Date().toLocaleTimeString()} - ${text}</div>`);
        logDiv.scrollTop = logDiv.scrollHeight;
    };
    
    // åˆå§‹åŒ–æ‰¹æ¬¡å¡ç‰‡
    for(let b = 0; b < totalBatches; b++) {
        const start = b * batchSize + 1;
        const end = Math.min((b + 1) * batchSize, totalEpisodes);
        cardsDiv.innerHTML += `<div id="batch${b}" style="padding:8px;background:var(--bg);border-radius:4px;text-align:center;font-size:10px">
            <div style="font-weight:600">${start}-${end}</div>
            <div style="color:var(--dim)">å¾…è™•ç†</div>
        </div>`;
    }
    
    try {
        for(let b = 0; b < totalBatches && !batchState.isPaused; b++) {
            batchState.currentBatch = b;
            const start = b * batchSize + 1;
            const end = Math.min((b + 1) * batchSize, totalEpisodes);
            
            // æ›´æ–°UI
            document.getElementById(`batch${b}`).style.background = 'var(--primary)';
            document.getElementById(`batch${b}`).style.color = '#fff';
            document.getElementById(`batch${b}`).querySelector('div:last-child').textContent = 'è™•ç†ä¸­...';
            
            statusText.textContent = `ğŸ“‘ ç”Ÿæˆç¬¬ ${start}-${end} é›†`;
            subStatus.textContent = `æ‰¹æ¬¡ ${b+1}/${totalBatches}`;
            progressBar.style.width = `${(b/totalBatches)*100}%`;
            addLog(`ğŸš€ é–‹å§‹ç¬¬ ${b+1} æ‰¹æ¬¡ (ç¬¬ ${start}-${end} é›†)`);
            
            // æ§‹å»ºåˆ†æ‰¹è«‹æ±‚
            const requestData = {
                novel: state.novel.text.substring(0, 8000),
                title: state.novel.title,
                config: {
                    batchMode: true,
                    startEpisode: start,
                    endEpisode: end,
                    totalEpisodes: totalEpisodes,
                    previousHook: batchState.allEpisodes.length > 0 
                        ? batchState.allEpisodes[batchState.allEpisodes.length - 1].hook 
                        : null
                }
            };
            
            const response = await callAgent('chapters', requestData);
            
            // è§£æçµæœ
            let episodes = [];
            try {
                const text = response.result || response;
                const cleaned = typeof text === 'string' 
                    ? text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim()
                    : text;
                const parsed = typeof cleaned === 'string' ? JSON.parse(cleaned) : cleaned;
                episodes = parsed.chapters || parsed.episodes || [];
            } catch(e) {
                addLog(`âš ï¸ æ‰¹æ¬¡ ${b+1} è§£æå¤±æ•—: ${e.message}`);
            }
            
            // æ·»åŠ åˆ°ç¸½çµæœï¼ˆé©—è­‰æ¨™é¡Œï¼‰
            episodes.forEach((ep, i) => {
                let title = ep.title || '';
                // å¦‚æœæ¨™é¡Œæ˜¯ç´”æ•¸å­—æˆ–å¤ªçŸ­ï¼Œç”Ÿæˆé»˜èªæ¨™é¡Œ
                if (!title || /^\d+$/.test(title.trim()) || title.length < 2) {
                    const phase = ep.phase || '';
                    const defaultTitles = {
                        'èµ·': ['åºç« ', 'ç·£èµ·', 'åˆè­˜', 'å‘½é‹', 'ç›¸é‡'],
                        'æ‰¿': ['ç™¼å±•', 'æ·±å…¥', 'æ³¢ç€¾', 'è½‰è®Š', 'ç³¾è‘›'],
                        'è½‰': ['å±æ©Ÿ', 'è¡çª', 'æŠ‰æ“‡', 'å°æ±º', 'è½‰æŠ˜'],
                        'åˆ': ['é«˜æ½®', 'çœŸç›¸', 'çµå±€', 'è½å¹•', 'çµ‚ç« ']
                    };
                    title = (defaultTitles[phase] || ['ç¯‡ç« '])[i % 5] || `ç¬¬${start + i}é›†`;
                }
                batchState.allEpisodes.push({
                    id: start + i,
                    title: title,
                    summary: ep.summary || '',
                    highlight: ep.highlight || '',
                    hook: ep.hook || '',
                    phase: ep.phase || ''
                });
            });
            
            // æ›´æ–°æ‰¹æ¬¡å¡ç‰‡
            document.getElementById(`batch${b}`).style.background = 'var(--success)';
            document.getElementById(`batch${b}`).querySelector('div:last-child').textContent = `âœ… ${episodes.length}é›†`;
            addLog(`âœ… æ‰¹æ¬¡ ${b+1} å®Œæˆï¼Œç”Ÿæˆ ${episodes.length} é›†`);
            
            // æ‰¹æ¬¡é–“å»¶é²
            if(b < totalBatches - 1 && !batchState.isPaused) {
                await sleep(1000);
            }
        }
        
        if(batchState.isPaused) {
            addLog('â¸ï¸ å·²æš«åœï¼Œé€²åº¦å·²ä¿å­˜');
            localStorage.setItem('batchState', JSON.stringify(batchState));
            return;
        }
        
        // å®Œæˆï¼šæ›´æ–°state.chapters
        state.chapters = batchState.allEpisodes;
        progressBar.style.width = '100%';
        statusText.textContent = 'âœ… é•·ç¯‡ç« ç¯€è¦åŠƒå®Œæˆï¼';
        subStatus.textContent = `å…± ${state.chapters.length} é›†`;
        addLog(`ğŸ‰ å…¨éƒ¨å®Œæˆï¼å…±ç”Ÿæˆ ${state.chapters.length} é›†`);
        
        setTimeout(() => showStep(4), 1000);
        
    } catch(err) {
        addLog(`âŒ éŒ¯èª¤: ${err.message}`);
        ui.innerHTML += `<button class="btn btn-primary" onclick="resumeBatchGeneration()" style="margin-top:12px">ğŸ”„ ç¹¼çºŒç”Ÿæˆ</button>`;
    }
}

function toggleBatchPause() {
    batchState.isPaused = !batchState.isPaused;
    const btn = document.getElementById('batchPauseBtn');
    if(batchState.isPaused) {
        btn.textContent = 'â–¶ï¸ ç¹¼çºŒ';
        btn.onclick = resumeBatchGeneration;
    } else {
        btn.textContent = 'â¸ï¸ æš«åœ';
    }
}

function resumeBatchGeneration() {
    const saved = localStorage.getItem('batchState');
    if(saved) {
        try {
            const oldState = JSON.parse(saved);
            batchState = { ...oldState, isPaused: false };
        } catch(e) {
            console.error('æ¢å¤æ‰¹æ¬¡çŠ¶æ€å¤±è´¥:', e);
        }
    }
    batchState.isPaused = false;
    runChapterAgentBatch(chapterConfig.episodes, 15);
}

async function runChapterAgent(){
    // æª¢æŸ¥æ˜¯å¦éœ€è¦åˆ†æ‰¹æ¨¡å¼ï¼ˆ>30é›†ä½¿ç”¨æ‰¹æ¬¡ç”Ÿæˆï¼Œé¿å…JSONè¢«æˆªæ–·ï¼‰
    if(chapterConfig.episodes > 30) {
        return runChapterAgentBatch(chapterConfig.episodes, 15);  // 15é›†/æ‰¹æ¬¡ï¼Œæ›´å®‰å…¨
    }
    
    const ui = document.getElementById('chapterAgentUI');
    
    ui.innerHTML = `
        <div style="background:var(--surface2);border-radius:8px;padding:20px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <div class="loading-spinner"></div>
                <div>
                    <div style="font-weight:600" id="chapterStatusText">ğŸ“‘ ç« ç¯€ç­–åŠƒå¸« å•Ÿå‹•ä¸­...</div>
                    <div style="font-size:12px;color:var(--dim)" id="chapterSubStatus">æº–å‚™åˆ†æ...</div>
                </div>
            </div>
            <div style="background:var(--bg);border-radius:4px;height:4px;overflow:hidden">
                <div id="chapterProgressBar" style="background:var(--primary);height:100%;width:0%;transition:width .5s"></div>
            </div>
            <div id="chapterSteps" style="margin-top:16px;font-size:12px;color:var(--dim)"></div>
        </div>
    `;
    
    const progressBar = document.getElementById('chapterProgressBar');
    const statusText = document.getElementById('chapterStatusText');
    const subStatus = document.getElementById('chapterSubStatus');
    const stepsEl = document.getElementById('chapterSteps');
    
    const addStep = (icon, text) => {
        stepsEl.insertAdjacentHTML('beforeend', `<div style="padding:4px 0">${icon} ${text}</div>`);
    };
    
    try {
        addStep('ğŸ”—', 'æ­£åœ¨å–šé†’æ™ºèƒ½é«”...');
        const apiOk = await checkApiHealth();
        progressBar.style.width = '10%';
        
        if (!apiOk) throw new Error('FizzDragon æ™ºèƒ½é«”é€£æ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        addStep('âœ…', 'æ™ºèƒ½é«”å·²å°±ç·’');
        
        // åˆ†æç« ç¯€
        await sleep(200);
        statusText.textContent = 'ğŸ“– ç« ç¯€æ™ºèƒ½é«”åˆ†æä¸­...';
        progressBar.style.width = '30%';
        
        addStep('ğŸ“–', 'åƒè€ƒ Save the Cat ç¯€æ‹çµæ§‹åˆ†æç« ç¯€...');
        subStatus.textContent = `è­˜åˆ¥ ${state.chapters.length} å€‹ç« ç¯€çš„æ•˜äº‹éšæ®µ...`;
        progressBar.style.width = '50%';
        
        await sleep(200);
        addStep('ğŸ£', 'ç‚ºæ¯ç« è¨­è¨ˆæ‡¸å¿µé‰¤å­...');
        statusText.textContent = 'ğŸ£ è¨­è¨ˆç« ç¯€é‰¤å­...';
        
        // èª¿ç”¨APIï¼Œå‚³éç”¨æˆ¶é…ç½®
        addStep('âš™ï¸', `ç›®æ¨™é…ç½®ï¼š${chapterConfig.episodes}é›† Ã— ${chapterConfig.durationPerEpisode}åˆ†é˜`);
        
        // é–‹å§‹å€’è¨ˆæ™‚
        startCountdown('chapters', stepsEl);
        
        // ç²¾ç°¡æ•¸æ“šï¼Œé¿å…è¶…æ™‚
        const requestData = {
            novel: state.novel.text.substring(0, 10000),  // åªç™¼å‰10Kå­—
            title: state.novel.title,
            analysis: state.aiAnalysis || {},
            concept: state.concept || {},
            interview: state.interview || {},  // å‚³éè¨ªè«‡å‰µæ„æ–¹å‘
            config: {
                targetEpisodes: chapterConfig.episodes,
                durationPerEpisode: chapterConfig.durationPerEpisode,
                totalDuration: chapterConfig.episodes * chapterConfig.durationPerEpisode,
                wordCount: state.novel.wordCount
            }
        };
        console.log('[ç« ç¯€] ç™¼é€è«‹æ±‚ï¼Œæ•¸æ“šå¤§å°:', JSON.stringify(requestData).length);
        
        const apiResponse = await callAgent('chapters', requestData);
        
        // åœæ­¢å€’è¨ˆæ™‚
        stopCountdown();
        progressBar.style.width = '90%';
        
        // è§£æè¿”å›
        let result;
        try {
            const resultText = apiResponse.result || apiResponse;
            console.log('[ç« ç¯€] APIè¿”å›é•·åº¦:', typeof resultText === 'string' ? resultText.length : 'object');
            
            if(typeof resultText === 'string'){
                // å˜—è©¦æå–JSONéƒ¨åˆ†
                let cleaned = resultText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                // ç¢ºä¿JSONå®Œæ•´ï¼ˆæ‰¾åˆ°æœ€å¾Œä¸€å€‹}ï¼‰
                const lastBrace = cleaned.lastIndexOf('}');
                if(lastBrace > 0) cleaned = cleaned.substring(0, lastBrace + 1);
                result = JSON.parse(cleaned);
            } else {
                result = resultText;
            }
            console.log('[ç« ç¯€] è§£ææˆåŠŸï¼Œchaptersæ•¸:', result.chapters?.length || result.episodes?.length || 0);
        } catch(e){
            console.error('[ç« ç¯€] è§£æJSONå¤±æ•—:', e, apiResponse);
            addStep('âš ï¸', 'AIè¿”å›æ ¼å¼ç•°å¸¸ï¼Œä½¿ç”¨åŸºç¤åˆ†æ');
            result = { chapters: [] };
        }
        
        // é¡¯ç¤ºAIæ¨è–¦é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
        if(result.analysis?.recommendedEpisodes){
            const rec = result.analysis;
            addStep('ğŸ’¡', `AIæ¨è–¦ï¼š${rec.recommendedEpisodes}é›† Ã— ${rec.recommendedDuration}åˆ†é˜`);
            addStep('ğŸ“Š', `æƒ…ç¯€å¯†åº¦ï¼š${rec.plotDensity}ï¼Œ${rec.reason || ''}`);
            
            // ä¿å­˜AIæ¨è–¦
            state.aiRecommendation = {
                episodes: rec.recommendedEpisodes,
                duration: rec.recommendedDuration,
                reason: rec.reason
            };
        }
        
        // åˆä½µAIåˆ†æçµæœï¼ˆæ”¯æŒchaptersæˆ–episodesï¼‰
        const aiChapters = result.chapters || result.episodes || [];
        if(aiChapters.length > 0){
            // ç”¨AIåˆ†æçš„ç« ç¯€æ›¿æ›åŸå§‹ç« ç¯€
            state.chapters = aiChapters.map((ch, i) => {
                // é©—è­‰æ¨™é¡Œï¼šå¦‚æœæ˜¯ç´”æ•¸å­—æˆ–å¤ªçŸ­ï¼Œç”Ÿæˆé»˜èªæ¨™é¡Œ
                let title = ch.title || '';
                if (!title || /^\d+$/.test(title.trim()) || title.length < 2) {
                    // åŸºæ–¼éšæ®µç”Ÿæˆé»˜èªæ¨™é¡Œ
                    const phase = ch.phase || '';
                    const defaultTitles = {
                        'èµ·': ['åºç« ', 'ç·£èµ·', 'åˆè­˜', 'å‘½é‹', 'ç›¸é‡'][i % 5],
                        'æ‰¿': ['ç™¼å±•', 'æ·±å…¥', 'æ³¢ç€¾', 'è½‰è®Š', 'ç³¾è‘›'][i % 5],
                        'è½‰': ['å±æ©Ÿ', 'è¡çª', 'æŠ‰æ“‡', 'å°æ±º', 'è½‰æŠ˜'][i % 5],
                        'åˆ': ['é«˜æ½®', 'çœŸç›¸', 'çµå±€', 'è½å¹•', 'çµ‚ç« '][i % 5]
                    };
                    title = defaultTitles[phase] || `ç¬¬${i+1}é›†`;
                }
                return {
                    id: i + 1,
                    title: title,
                    summary: ch.summary || '',
                    highlight: ch.highlight || '',
                    hook: ch.hook || '',
                    phase: ch.phase || '',
                    wordCount: ch.wordCount || Math.round(state.novel.wordCount / aiChapters.length),
                    content: ch.content || ''
                };
            });
            addStep('âœ…', `å®Œæˆ ${aiChapters.length} å€‹ç« ç¯€çš„AIè¦åŠƒ`);
        } else {
            addStep('âš ï¸', 'æœªç²å–åˆ°AIç« ç¯€åˆ†æï¼Œä½¿ç”¨åŸå§‹ç« ç¯€');
        }
        
        if(result.actStructure){
            state.actStructure = result.actStructure;
        }
        
        progressBar.style.width = '100%';
        statusText.textContent = 'âœ… ç« ç¯€åˆ†æå®Œæˆï¼';
        addStep('ğŸ‰', 'åˆ†æå®Œæˆï¼Œæ­£åœ¨è¼‰å…¥çµæœ...');
        
        // ç¢ºä¿è·³è½‰åˆ°çµæœé 
        console.log('[ç« ç¯€] æº–å‚™é¡¯ç¤ºçµæœï¼Œchapters:', state.chapters.length);
        
        // å¼·åˆ¶è·³è½‰ï¼ˆç„¡è«–çµæœå¦‚ä½•ï¼‰
        setTimeout(() => {
            console.log('[ç« ç¯€] åŸ·è¡ŒshowStep(4)');
            showStep(4);
        }, 800);
        
    } catch (err) {
        console.error('[ç« ç¯€] éŒ¯èª¤:', err);
        stopCountdown();
        ui.innerHTML = `
            <div style="background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.3);padding:20px;border-radius:12px;text-align:center">
                <div style="font-size:48px;margin-bottom:12px">âš ï¸</div>
                <div style="color:var(--primary);font-weight:600;margin-bottom:8px">ç« ç¯€ç­–åŠƒå¸« è™•ç†å¤±æ•—</div>
                <div style="font-size:12px;color:var(--dim);margin-bottom:16px;word-break:break-all">${err.message || 'æœªçŸ¥éŒ¯èª¤'}</div>
                <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
                    <button class="btn btn-primary" onclick="runChapterAgent()">ğŸ”„ é‡è©¦</button>
                    <button class="btn" onclick="showStep(4)">â­ï¸ è·³éä½¿ç”¨åŸå§‹ç« ç¯€</button>
                    <button class="btn" onclick="prevStep()">â† è¿”å›</button>
                </div>
            </div>
        `;
    }
}

function renderChaptersResult(){
    // è¨ˆç®—å…§å®¹é£½å’Œåº¦
    const userDuration = chapterConfig.episodes * chapterConfig.durationPerEpisode;
    const naturalDuration = Math.round(state.novel.wordCount / 800); // ç´„800å­—/åˆ†é˜
    // é£½å’Œåº¦ = è‡ªç„¶æ™‚é•· / é…ç½®æ™‚é•· (>100%=å…§å®¹éå¤š)
    const saturation = naturalDuration / userDuration;
    const matchStatus = saturation >= 0.7 && saturation <= 1.3 ? 'good' : (saturation >= 0.5 && saturation <= 1.6 ? 'warning' : 'bad');
    
    // ç‰ˆæœ¬æ–¹æ¡ˆï¼ˆç•¶é£½å’Œåº¦ä¸ä½³æ™‚é¡¯ç¤ºï¼‰
    const showVersions = matchStatus !== 'good';
    
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ“‘</span> ç« ç¯€çµæ§‹</h3>
            
            <div class="report">
                <h4>ğŸ“Š æ•´é«”æ•¸æ“š</h4>
                <div class="report-grid">
                    <div class="stat-box"><div class="stat-val">${state.chapters.length}</div><div class="stat-label">åŸå§‹ç« ç¯€</div></div>
                    <div class="stat-box"><div class="stat-val">${chapterConfig.episodes}</div><div class="stat-label">ç›®æ¨™é›†æ•¸</div></div>
                    <div class="stat-box"><div class="stat-val">${naturalDuration}</div><div class="stat-label">è‡ªç„¶æ™‚é•·(åˆ†)</div></div>
                    <div class="stat-box"><div class="stat-val">${userDuration}</div><div class="stat-label">é…ç½®æ™‚é•·(åˆ†)</div></div>
                </div>
                
            </div>
            
            ${showVersions ? `
            <!-- å¤šç‰ˆæœ¬æ–¹æ¡ˆé¸æ“‡ -->
            <div class="report" id="versionSelectPanel">
                <h4>ğŸ¬ æ¨è–¦æ”¹ç·¨æ–¹æ¡ˆï¼ˆé»æ“Šå±•é–‹è©³æƒ…ï¼‰</h4>
                <p style="font-size:12px;color:var(--dim);margin-bottom:12px">æ‚¨çš„é…ç½®èˆ‡æ•…äº‹è‡ªç„¶æ™‚é•·æœ‰è½å·®ï¼Œä»¥ä¸‹æ˜¯3å€‹å„ªåŒ–æ–¹æ¡ˆï¼Œé»æ“ŠæŸ¥çœ‹è©³ç´°è¦åŠƒï¼š</p>
                
                <div style="display:grid;gap:12px" id="versionCardsContainer">
                    <!-- ç‰ˆæœ¬A -->
                    <div class="item-card version-option" style="cursor:pointer;border:2px solid var(--border)" id="version-A">
                        <div onclick="expandVersionDetail('A')" style="padding:4px 0">
                            <h5 style="color:var(--primary);display:flex;justify-content:space-between;align-items:center">
                                <span>ğŸ“Œ ç‰ˆæœ¬Aï¼šä¸»ç·šèšç„¦ç‰ˆ</span>
                                <span id="version-A-arrow" style="font-size:12px;color:var(--dim)">â–¼ å±•é–‹</span>
                            </h5>
                            <p style="font-size:12px;color:var(--dim);margin:8px 0">èšç„¦ä¸»ç·šåŠ‡æƒ…ï¼Œåˆªæ¸›æ”¯ç·šå’Œéæ¸¡æ®µè½ï¼Œä¿ç•™æ ¸å¿ƒè¡çªå’Œæƒ…æ„Ÿé«˜æ½®</p>
                            <p><span class="tag">é©åˆï¼šå¿«ç¯€å¥è§€çœ¾</span><span class="tag">é¢¨éšªï¼šå¯èƒ½å¤±å»ç´°ç¯€</span></p>
                        </div>
                        <div id="version-A-detail" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"></div>
                    </div>
                    
                    <!-- ç‰ˆæœ¬B -->
                    <div class="item-card version-option" style="cursor:pointer;border:2px solid var(--border)" id="version-B">
                        <div onclick="expandVersionDetail('B')" style="padding:4px 0">
                            <h5 style="color:var(--primary);display:flex;justify-content:space-between;align-items:center">
                                <span>ğŸ’ ç‰ˆæœ¬Bï¼šæƒ…æ„Ÿèšç„¦ç‰ˆ</span>
                                <span id="version-B-arrow" style="font-size:12px;color:var(--dim)">â–¼ å±•é–‹</span>
                            </h5>
                            <p style="font-size:12px;color:var(--dim);margin:8px 0">ä¿ç•™æƒ…æ„Ÿç™¼å±•ç·šï¼Œç°¡åŒ–å‹•ä½œå ´æ™¯ï¼Œå¼·èª¿è§’è‰²æˆé•·å’Œé—œä¿‚è®ŠåŒ–</p>
                            <p><span class="tag">é©åˆï¼šå–œæ­¡è§’è‰²çš„è§€çœ¾</span><span class="tag">é¢¨éšªï¼šç¯€å¥åæ…¢</span></p>
                        </div>
                        <div id="version-B-detail" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"></div>
                    </div>
                    
                    <!-- ç‰ˆæœ¬C -->
                    <div class="item-card version-option" style="cursor:pointer;border:2px solid var(--border)" id="version-C">
                        <div onclick="expandVersionDetail('C')" style="padding:4px 0">
                            <h5 style="color:var(--primary);display:flex;justify-content:space-between;align-items:center">
                                <span>âš¡ ç‰ˆæœ¬Cï¼šç²¾è¯æ¿ƒç¸®ç‰ˆ</span>
                                <span id="version-C-arrow" style="font-size:12px;color:var(--dim)">â–¼ å±•é–‹</span>
                            </h5>
                            <p style="font-size:12px;color:var(--dim);margin:8px 0">åªä¿ç•™æœ€ç²¾å½©çš„å ´æ™¯ï¼Œæ¯é›†ä¸€å€‹é«˜æ½®ï¼Œé©åˆçŸ­è¦–é »æ™‚ä»£è§€çœ¾</p>
                            <p><span class="tag">é©åˆï¼šç¢ç‰‡åŒ–è§€çœ‹</span><span class="tag">é¢¨éšªï¼šåŸè‘—é»¨å¯èƒ½ä¸æ»¿</span></p>
                        </div>
                        <div id="version-C-detail" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"></div>
                    </div>
                </div>
                
                <p style="font-size:11px;color:var(--dim);margin-top:12px">ğŸ’¡ å±•é–‹å¾Œå¯æŸ¥çœ‹æ¯é›†å¤§ç¶±å’Œäº®é»ï¼Œé¸æ“‡å¾Œé»æ“Šã€Œä½¿ç”¨æ­¤æ–¹æ¡ˆã€ç¢ºèª</p>
            </div>
            ` : ''}
            
            <div class="report">
                <h4>ğŸ“– ç« ç¯€åˆ—è¡¨ <span style="font-size:11px;color:var(--dim);margin-left:8px">${state.selectedVersion ? '(ç‰ˆæœ¬'+state.selectedVersion+')' : ''}</span></h4>
                ${state.chapters.map((ch, i) => `
                    <div class="item-card" style="cursor:pointer" onclick="toggleChapter(${i})" id="chapter-card-${i}">
                        <h5 style="display:flex;justify-content:space-between">
                            <span><span style="color:var(--primary)">E${String(i+1).padStart(2,'0')}</span> ${ch.title}</span>
                            <span id="chapter-arrow-${i}" style="color:var(--dim)">â–¼</span>
                        </h5>
                        <p style="color:var(--dim);font-size:12px;margin:8px 0">${ch.summary || '(å¾…åˆ†æ)'}</p>
                        <p>
                            <span class="tag">ğŸ“ ${ch.wordCount}å­—</span>
                            <span class="tag">ğŸ¬ ${ch.estimatedShots||80}é¡é ­</span>
                            ${ch.phase ? `<span class="phase-badge phase-${getPhaseType(ch.phase)}">${ch.phase}</span>` : ''}
                            ${ch.hook ? `<span class="tag" style="background:var(--primary);color:#fff">ğŸ£ ${ch.hook}</span>` : ''}
                        </p>
                        <div id="chapter-detail-${i}" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                            <div style="background:var(--surface);padding:12px;border-radius:6px;font-size:12px;line-height:1.8;max-height:400px;overflow-y:auto;white-space:pre-wrap">${(ch.content||'').substring(0,3000)}${ch.content?.length > 3000 ? '\n\n...ï¼ˆå…±'+ch.content.length+'å­—ï¼Œé»æ“Šå±•é–‹æ›´å¤šï¼‰' : ''}</div>
                            <!-- æ‰‹å‹•èª¿æ•´ -->
                            <div style="margin-top:12px;display:flex;gap:8px">
                                <button class="btn" style="padding:6px 12px;font-size:10px" onclick="event.stopPropagation();mergeWithNext(${i})">åˆä½µä¸‹ä¸€ç« </button>
                                <button class="btn" style="padding:6px 12px;font-size:10px" onclick="event.stopPropagation();splitChapter(${i})">æ‹†åˆ†æœ¬ç« </button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="btn-group">
                <button class="btn btn-back" onclick="prevStep()">â† è¿”å›</button>
                <button class="btn" onclick="state.chapters=[];showStep(4)">ğŸ”„ é‡æ–°åˆ†æ</button>
                <button class="btn" onclick="showManualAdjustDialog()">âœï¸ æ‰‹å‹•èª¿æ•´é›†æ•¸</button>
                <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ â†’</button>
            </div>
        </div>
    `;
}

// ç‰ˆæœ¬è©³æƒ…ç·©å­˜
const versionDetailCache = { A: null, B: null, C: null };

// å±•é–‹ç‰ˆæœ¬è©³æƒ…
async function expandVersionDetail(version) {
    const detailEl = document.getElementById(`version-${version}-detail`);
    const arrowEl = document.getElementById(`version-${version}-arrow`);
    
    // åˆ‡æ›å±•é–‹/æ”¶èµ·
    if (detailEl.style.display === 'block') {
        detailEl.style.display = 'none';
        arrowEl.textContent = 'â–¼ å±•é–‹';
        return;
    }
    
    // å±•é–‹
    detailEl.style.display = 'block';
    arrowEl.textContent = 'â–² æ”¶èµ·';
    
    // å¦‚æœå·²æœ‰ç·©å­˜ï¼Œç›´æ¥é¡¯ç¤º
    if (versionDetailCache[version]) {
        renderVersionDetail(version, versionDetailCache[version]);
        return;
    }
    
    // é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹
    detailEl.innerHTML = `
        <div style="text-align:center;padding:20px">
            <div class="loading-spinner" style="margin:0 auto 12px"></div>
            <div style="font-size:12px;color:var(--dim)">
                ğŸ§  AIæ­£åœ¨ç‚ºã€Œ${version === 'A' ? 'ä¸»ç·šèšç„¦ç‰ˆ' : version === 'B' ? 'æƒ…æ„Ÿèšç„¦ç‰ˆ' : 'ç²¾è¯æ¿ƒç¸®ç‰ˆ'}ã€ç”Ÿæˆè©³ç´°è¦åŠƒ...
            </div>
        </div>
    `;
    
    try {
        // èª¿ç”¨AIç”Ÿæˆç‰ˆæœ¬è©³æƒ…
        const versionNames = { A: 'ä¸»ç·šèšç„¦ç‰ˆ', B: 'æƒ…æ„Ÿèšç„¦ç‰ˆ', C: 'ç²¾è¯æ¿ƒç¸®ç‰ˆ' };
        const versionDesc = {
            A: 'èšç„¦ä¸»ç·šåŠ‡æƒ…ï¼Œåˆªæ¸›æ”¯ç·šå’Œéæ¸¡æ®µè½ï¼Œä¿ç•™æ ¸å¿ƒè¡çªå’Œæƒ…æ„Ÿé«˜æ½®ã€‚é©åˆå¿«ç¯€å¥è§€çœ¾ã€‚',
            B: 'ä¿ç•™æƒ…æ„Ÿç™¼å±•ç·šï¼Œç°¡åŒ–å‹•ä½œå ´æ™¯ï¼Œå¼·èª¿è§’è‰²æˆé•·å’Œé—œä¿‚è®ŠåŒ–ã€‚é©åˆå–œæ­¡è§’è‰²çš„è§€çœ¾ã€‚',
            C: 'åªä¿ç•™æœ€ç²¾å½©çš„å ´æ™¯ï¼Œæ¯é›†ä¸€å€‹é«˜æ½®ï¼Œé©åˆçŸ­è¦–é »æ™‚ä»£è§€çœ¾ã€‚'
        };
        
        const apiResponse = await callAgent('chapters', {
            novel: state.novel.text.substring(0, 15000),
            title: state.novel.title,
            analysis: state.aiAnalysis,
            concept: state.concept,
            versionType: version,
            versionName: versionNames[version],
            versionDesc: versionDesc[version],
            targetEpisodes: chapterConfig.episodes,
            targetDuration: chapterConfig.durationPerEpisode,
            generateDetailedPlan: true
        });
        
        stopCountdown();
        
        let result;
        try {
            const resultText = apiResponse.result || apiResponse;
            if (typeof resultText === 'string') {
                result = JSON.parse(resultText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim());
            } else {
                result = resultText;
            }
        } catch (e) {
            result = apiResponse;
        }
        
        // ç·©å­˜çµæœ
        versionDetailCache[version] = result;
        renderVersionDetail(version, result);
        
    } catch (err) {
        stopCountdown();
        detailEl.innerHTML = `
            <div style="text-align:center;padding:16px;color:var(--error)">
                âš ï¸ ç”Ÿæˆå¤±æ•—ï¼š${err.message}
                <br><button class="btn" onclick="expandVersionDetail('${version}')" style="margin-top:8px">ğŸ”„ é‡è©¦</button>
            </div>
        `;
    }
}

// æ¸²æŸ“ç‰ˆæœ¬è©³æƒ…
function renderVersionDetail(version, data) {
    const detailEl = document.getElementById(`version-${version}-detail`);
    const episodes = data.episodes || data.chapters || [];
    const overview = data.overview || data.summary || 'æ”¹ç·¨æ–¹æ¡ˆ';
    
    detailEl.innerHTML = `
        <div style="background:var(--surface);border-radius:8px;padding:16px;margin-bottom:12px">
            <h6 style="color:var(--primary);margin-bottom:8px">ğŸ“– æ•´é«”è¦åŠƒ</h6>
            <p style="font-size:12px;line-height:1.8;color:var(--text)">${overview}</p>
        </div>
        
        <h6 style="color:var(--primary);margin-bottom:12px">ğŸ“º å„é›†å¤§ç¶±èˆ‡äº®é»</h6>
        <div style="display:grid;gap:8px;max-height:300px;overflow-y:auto">
            ${episodes.map((ep, i) => `
                <div style="background:var(--bg);border-radius:6px;padding:12px;border-left:3px solid var(--primary)">
                    <div style="font-weight:600;margin-bottom:6px">
                        <span style="color:var(--primary)">E${String(i+1).padStart(2,'0')}</span> 
                        ${ep.title || `ç¬¬${i+1}é›†`}
                    </div>
                    <p style="font-size:11px;color:var(--dim);margin-bottom:6px">${ep.summary || ep.description || ''}</p>
                    ${ep.highlight ? `<div style="font-size:11px"><span style="color:var(--primary)">âœ¨ äº®é»ï¼š</span>${ep.highlight}</div>` : ''}
                    ${ep.hook ? `<div style="font-size:11px;margin-top:4px"><span style="color:#ff9800">ğŸ£ é‰¤å­ï¼š</span>${ep.hook}</div>` : ''}
                    ${ep.deletedContent ? `<div style="font-size:10px;color:var(--dim);margin-top:4px">ğŸ—‘ï¸ åˆªæ¸›ï¼š${ep.deletedContent}</div>` : ''}
                </div>
            `).join('')}
        </div>
        
        <div style="margin-top:16px;display:flex;gap:8px;justify-content:center">
            <button class="btn btn-primary" onclick="applyVersionPlan('${version}')" style="padding:10px 24px">
                âœ… ä½¿ç”¨æ­¤æ–¹æ¡ˆ
            </button>
        </div>
    `;
}

// æ‡‰ç”¨ç‰ˆæœ¬æ–¹æ¡ˆ
function applyVersionPlan(version) {
    state.selectedVersion = version;
    const data = versionDetailCache[version];
    
    if (data && data.episodes) {
        // ç”¨AIç”Ÿæˆçš„ç« ç¯€æ›¿æ›ç•¶å‰ç« ç¯€
        state.chapters = data.episodes.map((ep, i) => ({
            title: ep.title || `ç¬¬${i+1}é›†`,
            summary: ep.summary || ep.description || '',
            highlight: ep.highlight || '',
            hook: ep.hook || '',
            wordCount: ep.wordCount || Math.round(state.novel.wordCount / data.episodes.length),
            estimatedShots: ep.shots || 80,
            phase: ep.phase || ''
        }));
    }
    
    // æ›´æ–°UI - é«˜äº®é¸ä¸­çš„ç‰ˆæœ¬
    document.querySelectorAll('.version-option').forEach(el => {
        el.style.borderColor = 'var(--border)';
        el.style.background = 'var(--bg)';
    });
    const selected = document.getElementById('version-' + version);
    if (selected) {
        selected.style.borderColor = 'var(--primary)';
        selected.style.background = 'rgba(255,10,53,0.15)';
    }
    
    // æç¤ºç”¨æˆ¶
    alert(`å·²é¸æ“‡ã€Œ${version === 'A' ? 'ä¸»ç·šèšç„¦ç‰ˆ' : version === 'B' ? 'æƒ…æ„Ÿèšç„¦ç‰ˆ' : 'ç²¾è¯æ¿ƒç¸®ç‰ˆ'}ã€æ–¹æ¡ˆï¼\né»æ“Šã€Œä¸‹ä¸€æ­¥ â†’ã€ç¹¼çºŒã€‚`);
    
    // åˆ·æ–°ç« ç¯€åˆ—è¡¨é¡¯ç¤º
    showStep(4);
}

// èˆŠçš„é¸æ“‡å‡½æ•¸ä¿ç•™å…¼å®¹
function selectChapterVersion(version){
    expandVersionDetail(version);
}

// åˆä½µç« ç¯€
function mergeWithNext(index){
    if(index >= state.chapters.length - 1){
        alert('é€™æ˜¯æœ€å¾Œä¸€ç« ï¼Œç„¡æ³•åˆä½µ');
        return;
    }
    const ch1 = state.chapters[index];
    const ch2 = state.chapters[index + 1];
    ch1.title = ch1.title + ' & ' + ch2.title;
    ch1.content = (ch1.content || '') + '\n\n' + (ch2.content || '');
    ch1.wordCount = (ch1.wordCount || 0) + (ch2.wordCount || 0);
    ch1.summary = ch1.summary + 'ï¼›' + (ch2.summary || '');
    state.chapters.splice(index + 1, 1);
    showStep(4);
}

// æ‹†åˆ†ç« ç¯€
function splitChapter(index){
    const ch = state.chapters[index];
    if(!ch.content || ch.content.length < 200){
        alert('ç« ç¯€å…§å®¹å¤ªçŸ­ï¼Œç„¡æ³•æ‹†åˆ†');
        return;
    }
    const midPoint = Math.floor(ch.content.length / 2);
    const breakPoint = ch.content.indexOf('\n', midPoint) || midPoint;
    
    const newCh = {
        title: ch.title + ' (ä¸‹)',
        content: ch.content.substring(breakPoint),
        wordCount: ch.content.length - breakPoint,
        summary: '(å¾…æ›´æ–°)'
    };
    ch.title = ch.title + ' (ä¸Š)';
    ch.content = ch.content.substring(0, breakPoint);
    ch.wordCount = breakPoint;
    
    state.chapters.splice(index + 1, 0, newCh);
    showStep(4);
}

// æ‰‹å‹•èª¿æ•´å°è©±æ¡†
function showManualAdjustDialog(){
    const dialog = document.createElement('div');
    dialog.id = 'manualAdjustDialog';
    dialog.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1000';
    dialog.innerHTML = `
        <div style="background:var(--surface);border:1px solid var(--border);padding:24px;width:90%;max-width:500px">
            <h3 style="margin-bottom:16px">âœï¸ æ‰‹å‹•èª¿æ•´é›†æ•¸é…ç½®</h3>
            <div style="margin-bottom:16px">
                <label style="font-size:12px;color:var(--dim)">ç›®æ¨™é›†æ•¸</label>
                <input type="number" id="manualEpisodes" value="${chapterConfig.episodes}" min="1" max="50" class="form-input" style="margin-top:4px">
            </div>
            <div style="margin-bottom:16px">
                <label style="font-size:12px;color:var(--dim)">æ¯é›†æ™‚é•·ï¼ˆåˆ†é˜ï¼‰</label>
                <input type="number" id="manualDuration" value="${chapterConfig.durationPerEpisode}" min="3" max="30" class="form-input" style="margin-top:4px">
            </div>
            <div class="btn-group">
                <button class="btn" onclick="document.getElementById('manualAdjustDialog').remove()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="applyManualConfig()">ç¢ºèªæ‡‰ç”¨</button>
            </div>
        </div>
    `;
    document.body.appendChild(dialog);
}

function applyManualConfig(){
    chapterConfig.episodes = parseInt(document.getElementById('manualEpisodes').value) || 10;
    chapterConfig.durationPerEpisode = parseInt(document.getElementById('manualDuration').value) || 10;
    document.getElementById('manualAdjustDialog').remove();
    showStep(4);
}

function generateChaptersPrompt(){
    const chapters = state.chapters;
    const concept = state.concept || {};
    
    // ç”Ÿæˆç« ç¯€æ‘˜è¦ä¾›Claudeåˆ†æ
    let chapterList = chapters.map((ch, i) => 
        `ç¬¬${i+1}ç« ã€Œ${ch.title}ã€(${ch.wordCount}å­—)ï¼š${(ch.content||'').substring(0,200)}...`
    ).join('\n');
    
    return `ä½ æ˜¯å°ˆæ¥­ç·¨åŠ‡ï¼Œè«‹åˆ†æé€™éƒ¨å°èªªçš„ç« ç¯€çµæ§‹ã€‚

ã€ä½œå“ã€‘${state.novel?.title || ''}
ã€é«˜æ¦‚å¿µã€‘${concept.logline || ''}
ã€é¡å‹ã€‘${concept.genre || ''}

ã€ç« ç¯€åˆ—è¡¨ã€‘
${chapterList}

è«‹ç‚ºæ¯å€‹ç« ç¯€åˆ†æä¸¦è¿”å›JSONï¼š
{
  "chapters": [
    {
      "id": 1,
      "title": "ç« ç¯€æ¨™é¡Œ",
      "summary": "50å­—å…§å®¹æ‘˜è¦",
      "phase": "æ•˜äº‹éšæ®µï¼ˆé–‹ç¯‡/é‹ªå¢Š/ç™¼å±•/é«˜æ½®/æ”¶æŸ/çµå±€ï¼‰",
      "emotion": "æƒ…ç·’åŸºèª¿",
      "hook": "ç« æœ«é‰¤å­ï¼ˆè®“è§€çœ¾æƒ³çœ‹ä¸‹ä¸€é›†çš„æ‡¸å¿µï¼‰",
      "estimatedShots": 80,
      "keyScenes": ["é—œéµå ´æ™¯1", "é—œéµå ´æ™¯2"]
    }
  ],
  "actStructure": {
    "act1": [1,2],
    "act2a": [3,4,5],
    "act2b": [6,7],
    "act3": [8,9,10]
  }
}`;
}

function applyChaptersResult(){
    const input = document.getElementById('chaptersResult').value.trim();
    if(!input){ alert('è«‹å…ˆè²¼å…¥çµæœ'); return; }
    
    try {
        const json = input.replace(/```json\s*/g,'').replace(/```\s*/g,'');
        const result = JSON.parse(json);
        
        // åˆä½µAIåˆ†æçµæœåˆ°ç¾æœ‰ç« ç¯€
        if(result.chapters){
            result.chapters.forEach((aiCh, i) => {
                if(state.chapters[i]){
                    Object.assign(state.chapters[i], aiCh);
                }
            });
        }
        if(result.actStructure){
            state.actStructure = result.actStructure;
        }
        
        showStep(4);
    } catch(e) {
        alert('JSONæ ¼å¼éŒ¯èª¤ï¼š' + e.message);
    }
}

// åŸºç¤ç« ç¯€è­˜åˆ¥ï¼ˆä¸éœ€è¦AIï¼‰
function splitChaptersBasic(){
    const text = state.novel.text;
    const chapters = [];
    
    // æ›´å…¨é¢çš„ç« ç¯€è­˜åˆ¥æ­£å‰‡ï¼ˆæŒ‰å„ªå…ˆç´šæ’åºï¼‰
    const patterns = [
        // åŠ‡æœ¬å ´æ™¯æ ¼å¼ï¼ˆå„ªå…ˆï¼ï¼‰- æ”¯æŒ "---ç¬¬Xå ´" æ ¼å¼
        /---+\s*ç¬¬([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+)å ´/g,
        /ç¬¬([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+)å ´\s*å ´æ™¯[ï¼š:]\s*([^â–²äººç‰©]{0,50})/g,
        /---+\s*å°¾è²/g,
        // ä¸­æ–‡ç« ç¯€æ ¼å¼
        /ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒé›¶å£¹è²³åè‚†ä¼é™¸æŸ’æŒç–æ‹¾\d]+[ç« ç¯€å›å·é›†å¹•éƒ¨ç¯‡]\s*[:ï¼š]?\s*([^\nâ–²]{0,50})/g,
        /ç¬¬\s*(\d+)\s*[ç« ç¯€å›å·é›†å¹•éƒ¨ç¯‡]\s*[:ï¼š]?\s*([^\nâ–²]{0,50})/g,
        // è‹±æ–‡æ ¼å¼
        /Chapter\s*\d+\s*[:ï¼š]?\s*([^\n]{0,50})/gi,
        /CHAPTER\s*\d+\s*[:ï¼š]?\s*([^\n]{0,50})/g,
        /^Part\s*\d+\s*[:ï¼š]?\s*([^\n]{0,50})/gim,
        // æ‹¬è™Ÿæ ¼å¼
        /ã€([^ã€‘]{1,50})ã€‘/g,
        /ã€–([^ã€—]{1,50})ã€—/g,
        // æ•¸å­—åºè™Ÿæ ¼å¼
        /^\s*(\d+)[\.ã€ï¼‰\)]\s*([^\n]{1,50})/gm,
        /^[ï¼ˆ\(](\d+)[ï¼‰\)]\s*([^\n]{1,50})/gm,
        // Markdownæ¨™é¡Œ
        /^#{1,3}\s+(.{1,50})/gm,
    ];
    
    // ç‰¹æ®Šè™•ç†ï¼šåŠ‡æœ¬æ ¼å¼ï¼ˆç”¨ "---" åˆ†éš”å ´æ™¯ï¼Œæˆ–é–‹é ­çš„"ç¬¬Xå ´"ï¼‰
    // å…ˆæ‰¾æ‰€æœ‰çš„å ´æ™¯æ¨™è¨˜ï¼ˆåŒ…æ‹¬é–‹é ­æ²’æœ‰---çš„ï¼‰
    const allScenePattern = /(---+\s*)?(ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+å ´|å°¾è²)/g;
    let scriptMatches = [...text.matchAll(allScenePattern)];
    
    // éæ¿¾ï¼šåªä¿ç•™æœ‰---å‰ç¶´çš„ï¼Œæˆ–è€…æ˜¯ç¬¬ä¸€å€‹å ´æ™¯ï¼ˆé–‹é ­ï¼‰
    if(scriptMatches.length > 0){
        const firstIndex = scriptMatches[0].index;
        scriptMatches = scriptMatches.filter((m, i) => i === 0 || m[1]); // ç¬¬ä¸€å€‹æˆ–æœ‰---å‰ç¶´
    }
    
    if(scriptMatches.length >= 2){
        console.log(`è­˜åˆ¥åˆ°åŠ‡æœ¬æ ¼å¼ï¼Œå…± ${scriptMatches.length} å€‹å ´æ™¯`);
        for(let i = 0; i < scriptMatches.length; i++){
            const start = scriptMatches[i].index;
            const end = scriptMatches[i+1]?.index || text.length;
            let content = text.slice(start, end);
            
            // æ ¼å¼åŒ–å…§å®¹ï¼šåœ¨é—œéµæ¨™è¨˜è™•æ·»åŠ æ›è¡Œ
            content = content
                .replace(/å ´æ™¯[ï¼š:]/g, '\nå ´æ™¯ï¼š')
                .replace(/äººç‰©[ï¼š:]/g, '\näººç‰©ï¼š')
                .replace(/â–²/g, '\nâ–²')
                .replace(/([^ï¼š\n])ï¼š\s*ï¼ˆ/g, '$1ï¼š\nï¼ˆ')
                .replace(/---+/g, '\n---\n');
            
            const title = scriptMatches[i][2] || `ç¬¬${i+1}å ´`;  // [2]æ˜¯å ´æ™¯å
            
            // æå–å ´æ™¯æè¿°ä½œç‚ºæ‘˜è¦
            const sceneMatch = content.match(/å ´æ™¯[ï¼š:]\s*([^äººç‰©â–²\n]+)/);
            const summary = sceneMatch ? sceneMatch[1].trim() : content.replace(/\s+/g,' ').substring(0, 100);
            
            chapters.push({
                id: i + 1,
                title: title,
                content: content.trim(),
                wordCount: content.length,
                summary: summary.length > 100 ? summary.substring(0,100) + '...' : summary
            });
        }
    } else {
        // å¸¸è¦ç« ç¯€è­˜åˆ¥
        let bestMatches = [];
        for(const pattern of patterns){
            const found = [...text.matchAll(pattern)];
            if(found.length > bestMatches.length) bestMatches = found;
        }
        
        if(bestMatches.length >= 2){  // è‡³å°‘2å€‹ç« ç¯€æ‰ç®—æœ‰æ•ˆ
            for(let i = 0; i < bestMatches.length; i++){
                const start = bestMatches[i].index;
                const end = bestMatches[i+1]?.index || text.length;
                let content = text.slice(start, end);
                const title = (bestMatches[i][1] || bestMatches[i][2] || `ç¬¬${i+1}ç« `).trim();
                
                // å˜—è©¦åœ¨å¥è™Ÿå¾Œæ·»åŠ æ›è¡Œä½¿å…§å®¹æ›´æ˜“è®€
                if(!content.includes('\n') && content.length > 200){
                    content = content.replace(/([ã€‚ï¼ï¼Ÿã€])([^ã€])/g, '$1\n$2');
                }
                
                // ç”Ÿæˆæ‘˜è¦
                const lines = content.split('\n').filter(l => l.trim().length > 10);
                const summaryText = lines.slice(0, 2).join(' ').replace(/\s+/g, ' ').trim();
                
                chapters.push({
                    id: i + 1,
                    title: title.length > 40 ? title.substring(0,40)+'...' : title,
                    content: content,
                    wordCount: content.length,
                    summary: summaryText.length > 150 ? summaryText.substring(0,150) + '...' : summaryText || '(å…§å®¹å¾…åˆ†æ)'
                });
            }
        }
    }
    
    if(chapters.length === 0){
        // æ‰¾ä¸åˆ°ç« ç¯€æ¨™è¨˜æ™‚ï¼ŒæŒ‰æ®µè½æˆ–å›ºå®šé•·åº¦åˆ†å‰²
        const paragraphs = text.split(/\n{2,}/);
        if(paragraphs.length > 10){
            // æŒ‰æ®µè½åˆ†çµ„ï¼Œæ¯5-10æ®µç‚ºä¸€ç« 
            const perChapter = Math.ceil(paragraphs.length / Math.ceil(text.length / 8000));
            for(let i = 0; i < paragraphs.length; i += perChapter){
                const content = paragraphs.slice(i, i + perChapter).join('\n\n');
                chapters.push({
                    id: chapters.length + 1,
                    title: `ç¬¬${chapters.length + 1}éƒ¨åˆ†`,
                    content, wordCount: content.length,
                    summary: content.replace(/\s+/g,' ').slice(0,100) + '...'
                });
            }
        } else {
            // æŒ‰å›ºå®šå­—æ•¸åˆ†å‰²
            const chunkSize = 8000;
            for(let i = 0; i < text.length; i += chunkSize){
                const content = text.slice(i, Math.min(i + chunkSize, text.length));
                chapters.push({
                    id: chapters.length + 1,
                    title: `ç¬¬${chapters.length + 1}éƒ¨åˆ†`,
                    content, wordCount: content.length,
                    summary: content.replace(/\s+/g,' ').slice(0,100) + '...'
                });
            }
        }
    }
    
    console.log(`è­˜åˆ¥åˆ° ${chapters.length} å€‹ç« ç¯€`);
    return chapters;
}

function getChapterPhase(i, total){
    if(i === 0) return 'ğŸ¬ é–‹ç¯‡';
    if(i === total - 1) return 'ğŸ­ çµå±€';
    if(i < total * 0.25) return 'ğŸ“– é‹ªå¢Š';
    if(i < total * 0.5) return 'âš¡ ç™¼å±•';
    if(i < total * 0.75) return 'ğŸ”¥ é«˜æ½®';
    return 'ğŸŒ… æ”¶æŸ';
}

function generateChapterSummary(content){
    // ç°¡å–®æå–å‰100å­—ä½œç‚ºæ‘˜è¦
    return content.slice(0, 100).replace(/\s+/g, ' ') + '...';
}

// å±•é–‹/æ”¶èµ·ç« ç¯€
function toggleChapter(index){
    const detail = document.getElementById(`chapter-detail-${index}`);
    const arrow = document.getElementById(`chapter-arrow-${index}`);
    const card = document.getElementById(`chapter-card-${index}`);
    
    if(detail.style.display === 'none'){
        // å±•é–‹
        detail.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
        card.style.background = 'var(--surface2)';
        card.style.borderColor = 'var(--primary)';
    } else {
        // æ”¶èµ·
        detail.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
        card.style.background = '';
        card.style.borderColor = '';
    }
}

// ç·¨è¼¯ç« ç¯€
function editChapter(index){
    const ch = state.chapters[index];
    const newTitle = prompt('ç« ç¯€æ¨™é¡Œï¼š', ch.title);
    if(newTitle !== null){
        state.chapters[index].title = newTitle;
    }
    
    const newPhase = prompt('ç« ç¯€éšæ®µï¼ˆé–‹ç¯‡/é‹ªå¢Š/ç™¼å±•/é«˜æ½®/æ”¶æŸ/çµå±€ï¼‰ï¼š', ch.phase.replace(/^[^\s]+\s*/, ''));
    if(newPhase !== null){
        const phaseIcons = {'é–‹ç¯‡':'ğŸ¬','é‹ªå¢Š':'ğŸ“–','ç™¼å±•':'âš¡','é«˜æ½®':'ğŸ”¥','æ”¶æŸ':'ğŸŒ…','çµå±€':'ğŸ­'};
        const icon = phaseIcons[newPhase] || 'ğŸ“–';
        state.chapters[index].phase = `${icon} ${newPhase}`;
    }
    
    // é‡æ–°æ¸²æŸ“
    showStep(4);
}

// é è¦½ç« ç¯€åŠ‡æœ¬
function previewChapterScript(index){
    const ch = state.chapters[index];
    const script = state.scripts?.[index];
    
    if(script){
        alert(`ã€${ch.title}ã€‘åŠ‡æœ¬é è¦½\n\n${script.substring(0, 500)}...`);
    } else {
        alert(`ã€${ch.title}ã€‘\n\nåŠ‡æœ¬å°šæœªç”Ÿæˆï¼Œè«‹åœ¨ã€Œç« ç¯€åŠ‡æœ¬ã€æ­¥é©Ÿç”Ÿæˆã€‚\n\nåŸæ–‡é è¦½ï¼š\n${ch.content?.substring(0, 300) || ch.summary}...`);
    }
}

// ==================== é€šç”¨å·¥å…· ====================
function copyToClipboard(elementId){
    const el = document.getElementById(elementId);
    el.select();
    document.execCommand('copy');
    
    // æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ•ä¸¦æ›´æ–°
    const btn = el.parentElement.querySelector('button');
    if(btn){
        const orig = btn.innerHTML;
        btn.innerHTML = 'âœ“ å·²è¤‡è£½';
        setTimeout(() => btn.innerHTML = orig, 2000);
    }
}

// ==================== Step 5: è§’è‰²è¨­è¨ˆ ====================
const CHARACTER_SKILLS = [
    { id: 'egri_3d', name: 'Lajos Egri ä¸‰ç¶­ç†è«–', desc: 'ç”Ÿç†/ç¤¾æœƒ/å¿ƒç†' },
    { id: 'character_arc', name: 'è§’è‰²å¼§ç·šè¨­è¨ˆ', desc: 'æˆé•·è®ŠåŒ–è»Œè·¡' },
    { id: 'archetype', name: 'åŸå‹åˆ†æ', desc: 'æ¦®æ ¼12åŸå‹' },
    { id: 'visual_design', name: 'è¦–è¦ºè¨­è¨ˆ', desc: 'AIç¹ªåœ–Prompt' }
];

function renderStep4(){
    // å·²æœ‰è§’è‰²æ•¸æ“š â†’ é¡¯ç¤ºçµæœï¼ˆæª¢æŸ¥mainæˆ–supportingä»»ä¸€æœ‰æ•¸æ“šï¼‰
    const hasCharacters = (state.characters?.main?.length > 0) || (state.characters?.supporting?.length > 0);
    console.log('[renderStep4] hasCharacters:', hasCharacters, 'main:', state.characters?.main?.length, 'supporting:', state.characters?.supporting?.length);
    
    if(hasCharacters){
        return renderCharactersResult();
    }
    
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ‘¥</span> è§’è‰²è¨­è¨ˆå¸«</h3>
            
            <div id="characterAgentUI">
                <div style="text-align:center;padding:20px">
                    <button class="btn btn-primary" onclick="runCharacterAgent()" style="padding:16px 40px;font-size:16px">
                        ğŸš€ é–‹å§‹AIè§’è‰²è¨­è¨ˆ
                    </button>
                    <div style="font-size:12px;color:var(--dim);margin-top:12px">
                        é‹ç”¨ Lajos Egri ä¸‰ç¶­ç†è«– + æ¦®æ ¼åŸå‹ + è¦–è¦ºè¨­è¨ˆ
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function runCharacterAgent(){
    const ui = document.getElementById('characterAgentUI');
    
    ui.innerHTML = `
        <div style="background:var(--surface2);border-radius:8px;padding:20px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <div class="loading-spinner"></div>
                <div>
                    <div style="font-weight:600" id="charStatusText">ğŸ‘¥ è§’è‰²è¨­è¨ˆå¸« å•Ÿå‹•ä¸­...</div>
                    <div style="font-size:12px;color:var(--dim)" id="charSubStatus">æº–å‚™è¨­è¨ˆ...</div>
                </div>
            </div>
            <div style="background:var(--bg);border-radius:4px;height:4px;overflow:hidden">
                <div id="charProgressBar" style="background:var(--primary);height:100%;width:0%;transition:width .5s"></div>
            </div>
            <div id="charSteps" style="margin-top:16px;font-size:12px;color:var(--dim)"></div>
        </div>
    `;
    
    const progressBar = document.getElementById('charProgressBar');
    const statusText = document.getElementById('charStatusText');
    const subStatus = document.getElementById('charSubStatus');
    const stepsEl = document.getElementById('charSteps');
    
    const addStep = (icon, text) => {
        stepsEl.insertAdjacentHTML('beforeend', `<div style="padding:4px 0">${icon} ${text}</div>`);
    };
    
    try {
        addStep('ğŸ”—', 'æ­£åœ¨å–šé†’æ™ºèƒ½é«”...');
        const apiOk = await checkApiHealth();
        progressBar.style.width = '10%';
        if (!apiOk) throw new Error('FizzDragon æ™ºèƒ½é«”é€£æ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        addStep('âœ…', 'æ™ºèƒ½é«”å·²å°±ç·’');
        
        await sleep(200);
        addStep('ğŸ‘¥', 'è§’è‰²æ™ºèƒ½é«”æ­£åœ¨åˆ†æäººç‰©...');
        progressBar.style.width = '30%';
        
        statusText.textContent = 'ğŸ‘¥ åˆ†æè§’è‰²é—œä¿‚...';
        subStatus.textContent = 'åƒè€ƒ Lajos Egri ä¸‰ç¶­ç†è«–è¨­è¨ˆäººç‰©...';
        addStep('ğŸ­', 'è­˜åˆ¥ä¸»è§’ã€é…è§’ã€åæ´¾...');
        progressBar.style.width = '60%';
        
        // é–‹å§‹å€’è¨ˆæ™‚
        startCountdown('characters', stepsEl);
        
        const apiResponse = await callAgent('character', {
            novel: state.novel.text.substring(0, 8000),  // ç¸®æ¸›ä»¥åŠ å¿«é€Ÿåº¦
            title: state.novel.title,
            analysis: state.aiAnalysis,
            concept: state.concept,
            chapters: state.chapters,
            interview: state.interview || {}  // å‚³éè¨ªè«‡å‰µæ„æ–¹å‘
        });
        
        // åœæ­¢å€’è¨ˆæ™‚
        stopCountdown();
        progressBar.style.width = '90%';
        
        let result;
        try {
            const resultText = apiResponse.result || apiResponse;
            if(typeof resultText === 'string'){
                const cleaned = resultText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                result = JSON.parse(cleaned);
            } else {
                result = resultText;
            }
        } catch(e){
            console.warn('[è§’è‰²] JSONè§£æå¤±æ•—ï¼Œä½¿ç”¨åŸå§‹éŸ¿æ‡‰:', e);
            result = apiResponse;
        }
        
        console.log('[è§’è‰²] è§£æå¾Œçµæœ:', result);
        
        // é©é…ä¸åŒæ ¼å¼çš„APIè¿”å›
        state.characters = normalizeCharacters(result);
        const totalChars = (state.characters.main?.length||0) + (state.characters.supporting?.length||0);
        
        console.log('[è§’è‰²] æœ€çµ‚state.characters:', state.characters);
        console.log('[è§’è‰²] ä¸»è§’æ•¸:', state.characters.main?.length, 'é…è§’æ•¸:', state.characters.supporting?.length);
        
        if(totalChars === 0){
            console.error('[è§’è‰²] è­¦å‘Šï¼šè§’è‰²æ•¸ç‚º0ï¼Œå¯èƒ½è§£æå¤±æ•—');
            addStep('âš ï¸', 'è§’è‰²æ•¸ç‚º0ï¼Œè«‹æª¢æŸ¥è¿”å›æ ¼å¼');
        } else {
            addStep('âœ…', `å®Œæˆ ${totalChars} å€‹è§’è‰²è¨­è¨ˆ`);
        }
        
        progressBar.style.width = '100%';
        statusText.textContent = totalChars > 0 ? 'âœ… è§’è‰²è¨­è¨ˆå®Œæˆï¼' : 'âš ï¸ è«‹æª¢æŸ¥çµæœ';
        
        // å»¶é²å¾Œå¼·åˆ¶é‡æ–°æ¸²æŸ“æ•´å€‹æ­¥é©Ÿ
        setTimeout(() => {
            console.log('[è§’è‰²] æº–å‚™æ¸²æŸ“çµæœé é¢...');
            try {
                const content = document.getElementById('contentArea');
                if(content) {
                    const html = renderStep4();
                    console.log('[è§’è‰²] æ¸²æŸ“HTMLé•·åº¦:', html.length);
                    content.innerHTML = html;
                } else {
                    console.error('[è§’è‰²] contentAreaå…ƒç´ ä¸å­˜åœ¨ï¼Œä½¿ç”¨showStep');
                    showStep(5);
                }
            } catch(renderErr) {
                console.error('[è§’è‰²] æ¸²æŸ“éŒ¯èª¤:', renderErr);
                alert('è§’è‰²è¨­è¨ˆå®Œæˆä½†æ¸²æŸ“å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢');
            }
        }, 800);
        
    } catch (err) {
        console.error('è§’è‰²è¨­è¨ˆéŒ¯èª¤:', err);
        stopCountdown();
        ui.innerHTML = `
            <div style="background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.3);padding:20px;border-radius:12px;text-align:center">
                <div style="font-size:48px;margin-bottom:12px">âš ï¸</div>
                <div style="color:var(--primary);font-weight:600;margin-bottom:8px">è§’è‰²è¨­è¨ˆå¸« é€£æ¥å¤±æ•—</div>
                <div style="font-size:12px;color:var(--dim);margin-bottom:16px">${err.message || 'è«‹ç¨å¾Œé‡è©¦'}</div>
                <div style="display:flex;gap:8px;justify-content:center">
                    <button class="btn btn-primary" onclick="runCharacterAgent()">ğŸ”„ é‡è©¦</button>
                    <button class="btn" onclick="skipCharacterDesign()">â­ï¸ è·³é</button>
                    <button class="btn" onclick="prevStep()">â† è¿”å›</button>
                </div>
            </div>
        `;
    }
}

// è·³éè§’è‰²è¨­è¨ˆï¼Œä½¿ç”¨é»˜èªæ•¸æ“š
function skipCharacterDesign(){
    state.characters = {
        main: [{
            name: 'ä¸»è§’',
            role: 'æ•…äº‹ä¸»è§’',
            physiology: { age: 20, gender: 'æœªè¨­å®š', appearance: 'å¾…è¨­è¨ˆ' },
            sociology: { background: 'å¾…è¨­è¨ˆ' },
            psychology: { motivation: 'å¾…è¨­è¨ˆ', personality: 'å¾…è¨­è¨ˆ' }
        }],
        supporting: [],
        extras: []
    };
    nextStep();
}

function renderCharactersResult(){
    const chars = state.characters || { main: [], supporting: [] };
    
    // èª¿è©¦ï¼šæ‰“å°è§’è‰²æ•¸æ“šçµæ§‹
    console.log('[renderCharactersResult] state.characters:', JSON.stringify(chars).substring(0, 500));
    
    // å…¼å®¹ï¼šå¦‚æœæœ‰charactersæ•¸çµ„ä½†main/supportingç‚ºç©ºï¼Œç›´æ¥ç”¨characters
    if((!chars.main || chars.main.length === 0) && (!chars.supporting || chars.supporting.length === 0)){
        if(chars.characters && chars.characters.length > 0){
            console.log('[renderCharactersResult] ä½¿ç”¨charactersæ•¸çµ„:', chars.characters.length);
            chars.main = chars.characters.filter(c => {
                const role = (c.role || '').toLowerCase();
                return role.includes('ä¸»è§’') || role.includes('protagonist') || role.includes('main');
            });
            chars.supporting = chars.characters.filter(c => {
                const role = (c.role || '').toLowerCase();
                return !role.includes('ä¸»è§’') && !role.includes('protagonist') && !role.includes('main');
            });
            // å¦‚æœåˆ†é¡å¾Œmainé‚„æ˜¯ç©ºï¼ŒæŠŠç¬¬ä¸€å€‹æ”¾åˆ°main
            if(chars.main.length === 0 && chars.supporting.length > 0){
                chars.main.push(chars.supporting.shift());
            }
            state.characters = chars;
        }
    }
    
    // å¦‚æœmainç‚ºç©ºä½†supportingæœ‰æ•¸æ“šï¼Œé»˜èªé¡¯ç¤ºsupporting
    const defaultTab = (chars.main?.length > 0) ? 'main' : 'supporting';
    const mainActive = defaultTab === 'main' ? 'active' : '';
    const suppActive = defaultTab === 'supporting' ? 'active' : '';
    
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ‘¥</span> è§’è‰²è¨­è¨ˆ</h3>
            
            <div class="tabs">
                <div class="tab ${mainActive}" onclick="showCharacterTab('main')">ä¸»è§’ (${chars.main?.length||0})</div>
                <div class="tab ${suppActive}" onclick="showCharacterTab('supporting')">é…è§’ (${chars.supporting?.length||0})</div>
            </div>
            
            <div id="characterContent">
                ${renderCharacterList(defaultTab)}
            </div>
            
            <div class="btn-group">
                <button class="btn btn-back" onclick="prevStep()">â† è¿”å›</button>
                <button class="btn" onclick="state.characters={};showStep(5)">ğŸ”„ é‡æ–°è¨­è¨ˆ</button>
                <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ â†’</button>
            </div>
        </div>
    `;
}

function generateCharactersPrompt(){
    const ai = state.aiAnalysis || {};
    const concept = state.concept || {};
    const iv = state.interview || {};
    
    return `ä½ æ˜¯è§’è‰²è¨­è¨ˆå°ˆå®¶ï¼Œè«‹åŸºæ–¼Lajos Egriä¸‰ç¶­è§’è‰²ç†è«–è¨­è¨ˆäººç‰©ã€‚

ã€ä½œå“ã€‘${state.novel?.title || ''}
ã€é¡å‹ã€‘${concept.genre || ''}
ã€Loglineã€‘${concept.logline || ''}

ã€AIè­˜åˆ¥çš„è§’è‰²ã€‘
${ai.characters ? ai.characters.map(c => `- ${c.name}: ${c.role}, ${c.trait}`).join('\n') : 'ï¼ˆç„¡ï¼‰'}

ã€å°æ¼”è¨ªè«‡æ‘˜è¦ã€‘
${Object.keys(iv).map(k => iv[k] ? `- ${k}: ${iv[k]}` : '').filter(Boolean).join('\n') || 'ï¼ˆç„¡ï¼‰'}

è«‹è¨­è¨ˆè§’è‰²ä¸¦è¿”å›JSONï¼š
{
  "main": [
    {
      "name": "è§’è‰²å",
      "role": "ä¸»è§’",
      "physiology": {"age": 25, "gender": "ç”·", "appearance": "å¤–è²Œæè¿°"},
      "sociology": {"occupation": "è·æ¥­", "class": "éšå±¤", "relationships": "ç¤¾æœƒé—œä¿‚"},
      "psychology": {"want": "è¡¨é¢æ…¾æœ›", "need": "æ·±å±¤éœ€è¦", "wound": "å¿ƒç†å‰µå‚·", "arc": "æˆé•·å¼§ç·š"},
      "keyTraits": ["ç‰¹é»1", "ç‰¹é»2"],
      "voiceStyle": "èªªè©±é¢¨æ ¼"
    }
  ],
  "supporting": [
    {
      "name": "é…è§’å",
      "role": "é…è§’/åæ´¾/å°å¸«",
      "function": "æ•˜äº‹åŠŸèƒ½ï¼ˆå°æ‰‹/é¡åƒ/å‚¬åŒ–åŠ‘ï¼‰",
      "relationToProtag": "èˆ‡ä¸»è§’é—œä¿‚",
      "keyTraits": ["ç‰¹é»"],
      "physiology": {"age": 30, "appearance": "ç°¡è¿°"}
    }
  ]
}`;
}

function applyCharactersResult(){
    const input = document.getElementById('charactersResult').value.trim();
    if(!input){ alert('è«‹å…ˆè²¼å…¥çµæœ'); return; }
    
    try {
        const json = input.replace(/```json\s*/g,'').replace(/```\s*/g,'');
        state.characters = JSON.parse(json);
        showStep(5);
    } catch(e) {
        alert('JSONæ ¼å¼éŒ¯èª¤ï¼š' + e.message);
    }
}

function showCharacterTab(type){
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('characterContent').innerHTML = renderCharacterList(type);
}

// renderStep4Full ä¿ç•™ç›¸å®¹æ€§
function renderStep4Full(){
    return renderCharactersResult();
}

// æ¨™æº–åŒ–è§’è‰²æ•¸æ“šæ ¼å¼
function normalizeCharacters(raw){
    console.log('[è§’è‰²] normalizeCharacters è¼¸å…¥:', raw);
    
    // å¦‚æœå·²ç¶“æ˜¯æ¨™æº–æ ¼å¼
    if(raw.main && Array.isArray(raw.main)){
        console.log('[è§’è‰²] å·²æ˜¯æ¨™æº–æ ¼å¼');
        return raw;
    }
    
    const result = { main: [], supporting: [], extras: [], relationships: [] };
    
    // ä¿å­˜é—œä¿‚æ•¸æ“š
    if(raw.relationships && Array.isArray(raw.relationships)){
        result.relationships = raw.relationships;
    }
    
    // å˜—è©¦å¾ä¸åŒæ ¼å¼æå–
    const possibleArrays = [
        raw.characters, raw.character_list, raw.roles,
        raw.main_characters, raw.protagonists
    ];
    
    for(const arr of possibleArrays){
        if(Array.isArray(arr) && arr.length > 0){
            console.log('[è§’è‰²] æ‰¾åˆ°è§’è‰²æ•¸çµ„ï¼Œé•·åº¦:', arr.length);
            arr.forEach(c => {
                const char = normalizeOneCharacter(c);
                const role = (c.role || c.type || '').toLowerCase();
                // æ”¹é€²çš„è§’è‰²åˆ†é¡ï¼šä¸»è§’ â†’ mainï¼Œå…¶ä»– â†’ supporting
                if(role.includes('ä¸»è§’') || role === 'main' || role === 'protagonist' || c.is_protagonist){
                    result.main.push(char);
                    console.log('[è§’è‰²] ä¸»è§’:', char.name);
                } else {
                    result.supporting.push(char);
                    console.log('[è§’è‰²] é…è§’:', char.name, '(role:', role, ')');
                }
            });
            // å¦‚æœæ‰€æœ‰è§’è‰²éƒ½é€²äº†supportingï¼ŒæŠŠç¬¬ä¸€å€‹ç§»åˆ°main
            if(result.main.length === 0 && result.supporting.length > 0){
                result.main.push(result.supporting.shift());
                console.log('[è§’è‰²] è‡ªå‹•æŒ‡å®šä¸»è§’:', result.main[0]?.name);
            }
            console.log('[è§’è‰²] åˆ†é¡çµæœ - ä¸»è§’:', result.main.length, 'é…è§’:', result.supporting.length);
            return result;
        }
    }
    
    // å¦‚æœæ˜¯å–®å€‹è§’è‰²å°è±¡
    if(raw.name || raw.character_name){
        result.main.push(normalizeOneCharacter(raw));
        return result;
    }
    
    // å˜—è©¦å¾ä»»æ„éµæå–
    for(const key of Object.keys(raw)){
        const val = raw[key];
        if(val && typeof val === 'object' && (val.name || val.character_name)){
            const char = normalizeOneCharacter(val);
            char.name = char.name || key;
            if(key.includes('ä¸»') || key.includes('main')){
                result.main.push(char);
            } else {
                result.supporting.push(char);
            }
        }
    }
    
    return result;
}

// æ¨™æº–åŒ–å–®å€‹è§’è‰² - æ”¯æŒæ–°èˆŠAPIæ ¼å¼
function normalizeOneCharacter(c){
    // æå–å¿ƒç†ç¶­åº¦ï¼ˆæ”¯æŒæ–°APIæ ¼å¼ï¼‰
    const psy = c.psychology || c.mental || {};
    
    // æå–è¦–è¦ºç¶­åº¦ï¼ˆæ”¯æŒæ–°APIæ ¼å¼çš„silhouetteç­‰ï¼‰
    const facial = c.facial_features || {};
    const body = c.body_proportions || {};
    const ageRep = c.age_representation || {};
    
    return {
        name: c.name || c.character_name || c.è§’è‰²å || 'æœªå‘½å',
        role: c.role || c.type || c.è§’è‰²é¡å‹ || '',
        archetype: c.archetype || {},  // æ–°å¢ï¼šåŸå‹
        physiology: c.physiology || c.physical || {
            age: ageRep.apparent_age || c.age || c.å¹´é½¡,
            gender: c.gender || c.æ€§åˆ¥,
            height: body.height || c.height || c.èº«é«˜,
            build: body.build || c.build,
            posture: body.posture || c.posture,
            appearance: c.appearance || c.å¤–è²Œ || c.description || c.appearance_prompt,
            features: c.features || c.ç‰¹å¾µ || facial.expression,
            eyes: facial.eyes,
            nose: facial.nose,
            mouth: facial.mouth
        },
        sociology: c.sociology || c.social || {
            occupation: c.occupation || c.è·æ¥­,
            background: c.background || c.èƒŒæ™¯,
            relationships: c.relationships || c.é—œä¿‚
        },
        psychology: {
            personality: psy.personality || c.personality || c.æ€§æ ¼,
            motivation: psy.motivation || c.motivation || c.å‹•æ©Ÿ,
            desire: psy.desire || c.desire || c.æ¬²æœ›,
            fear: psy.fear || c.fear || c.ææ‡¼,
            flaw: psy.flaw || c.flaw,  // æ–°å¢ï¼šç¼ºé™·
            arc: psy.arc || c.arc || c.character_arc  // æˆé•·å¼§ç·š
        },
        arc: c.arc || c.character_arc || psy.arc || {
            start: c.start_state || c.åˆå§‹ç‹€æ…‹,
            end: c.end_state || c.æœ€çµ‚ç‹€æ…‹,
            change: c.change || c.è½‰è®Š
        },
        visual: c.visual || c.design || {
            silhouette: c.silhouette,
            colors: c.colors || c.color_palette,
            costume: c.costume || c.æœè£,
            appearance_prompt: c.appearance_prompt  // æ–°å¢ï¼šAIç¹ªåœ–prompt
        },
        // ç”ŸæˆAIç¹ªåœ–prompt
        prompt: c.prompt || c.appearance_prompt || c.visual?.appearance_prompt || generateCharacterPrompt(c)
    };
}

// å¾è§’è‰²æ•¸æ“šç”ŸæˆAIç¹ªåœ–prompt
function generateCharacterPrompt(c){
    const parts = [];
    const name = c.name || c.character_name || '';
    const age = c.age || c.physiology?.age || c.age_representation?.apparent_age || '';
    const gender = c.gender || c.physiology?.gender || '';
    const appearance = c.appearance || c.physiology?.appearance || c.description || '';
    const costume = c.costume || c.visual?.costume || '';
    const features = c.features || c.physiology?.features || '';
    
    if(name) parts.push(name);
    if(age) parts.push(`${age}æ­²`);
    if(gender) parts.push(gender);
    if(appearance) parts.push(appearance);
    if(features) parts.push(features);
    if(costume) parts.push(`æœè£ï¼š${costume}`);
    
    return parts.length > 0 ? parts.join('ï¼Œ') : 'ï¼ˆå¾…ç”Ÿæˆï¼‰';
}

// HTMLè½‰ç¾©å‡½æ•¸
function escapeHtml(str){
    if(!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// JSONéŸ¿æ‡‰æ¸…ç†å‡½æ•¸ï¼ˆå»é™¤markdownä»£ç¢¼å¡Šæ¨™è¨˜ï¼‰
function cleanJsonResponse(text){
    if(!text) return '';
    return String(text).replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
}

// JSONæ ¼å¼è½¬å°è¯´æ­£æ–‡
function jsonToNovelText(text){
    if(!text) return '';
    let cleaned = cleanJsonResponse(text);
    
    // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œç›´æ¥è¿”å›
    if(!cleaned.startsWith('{') && !cleaned.startsWith('[')) {
        return cleaned;
    }
    
    try {
        const data = JSON.parse(cleaned);
        
        // å¦‚æœæ˜¯æ•°ç»„ï¼ˆå¤šç« èŠ‚ï¼‰
        if(Array.isArray(data)){
            return data.map(chapter => {
                const num = chapter.chapter_number || chapter.episode || '';
                const title = chapter.chapter_title || chapter.title || '';
                const content = chapter.content || chapter.text || chapter.story || '';
                return (num || title ? 'ã€ç¬¬' + num + 'ç«  ' + title + 'ã€‘\n\n' : '') + content;
            }).join('\n\n---\n\n');
        }
        
        // å¦‚æœæ˜¯å•ä¸ªå¯¹è±¡
        if(typeof data === 'object'){
            // å°è¯•æå–å†…å®¹
            const content = data.content || data.text || data.story || data.novel || '';
            const title = data.chapter_title || data.title || '';
            const num = data.chapter_number || data.episode || '';
            
            if(content){
                return (num || title ? 'ã€ç¬¬' + num + 'ç«  ' + title + 'ã€‘\n\n' : '') + content;
            }
            
            // å¦‚æœæœ‰chapterså­—æ®µ
            if(data.chapters && Array.isArray(data.chapters)){
                return jsonToNovelText(JSON.stringify(data.chapters));
            }
            
            // æœ€åå°è¯•ï¼šæŠŠæ‰€æœ‰å­—ç¬¦ä¸²å­—æ®µæ‹¼æ¥
            return Object.values(data)
                .filter(v => typeof v === 'string' && v.length > 50)
                .join('\n\n');
        }
        
        return cleaned;
    } catch(e){
        // JSONè§£æå¤±è´¥ï¼Œè¿”å›åŸæ–‡
        return cleaned;
    }
}

function renderCharacterList(type){
    const chars = state.characters[type] || [];
    console.log('[renderCharacterList] type:', type, 'chars:', chars.length);
    
    if(chars.length === 0){
        return '<p style="color:var(--dim);padding:20px">æš«ç„¡è§’è‰²</p>';
    }
    
    return chars.map((c, idx) => {
        console.log('[renderCharacterList] æ¸²æŸ“è§’è‰²:', c.name, 'physiology:', !!c.physiology);
        const safeName = escapeHtml(c.name || 'è§’è‰²' + (idx+1));
        
        // ä¸»è§’/é…è§’é¡¯ç¤ºå®Œæ•´å°å‚³ï¼ˆå…¼å®¹æ–°èˆŠæ ¼å¼ï¼‰
        if(type === 'main' || type === 'supporting'){
            const phy = c.physiology || {};
            const soc = c.sociology || {};
            const psy = c.psychology || {};
            const arc = c.arc || c.archetype || {};
            const vis = c.visual || {};
            
            // æå–å¤–è²Œæè¿°ï¼ˆå…¼å®¹å¤šç¨®æ ¼å¼ï¼‰
            const appearance = phy.appearance || phy.features || vis.appearance_prompt || '';
            const age = phy.age || '';
            const height = phy.height || phy.build || '';
            const posture = phy.posture || '';
            
            // æå–å¿ƒç†æè¿°
            const desire = psy.desire || psy.motivation || '';
            const fear = psy.fear || '';
            const flaw = psy.flaw || '';
            const charArc = psy.arc || arc.function || '';
            
            return `
            <div class="item-card" style="padding:0;overflow:hidden;cursor:pointer;transition:all .3s" onclick="openCharacterDialog('${type}', ${idx})" onmouseover="this.style.boxShadow='var(--glow-md)'" onmouseout="this.style.boxShadow=''">
                <div style="background:linear-gradient(135deg,var(--primary),#ff8a5c);padding:16px;color:#fff;display:flex;align-items:center;justify-content:space-between">
                    <h5 style="margin:0;display:flex;align-items:center;gap:8px">
                        <span style="background:rgba(255,255,255,.2);padding:4px 8px;border-radius:8px;font-size:10px">${type === 'main' ? 'ä¸»è§’' : 'é…è§’'}</span>
                        ${safeName}
                        <span style="font-weight:normal;font-size:12px;opacity:.8;margin-left:auto">${escapeHtml(c.role) || ''}</span>
                    </h5>
                    <span style="font-size:10px;opacity:.7;font-family:'Orbitron',monospace">CLICK TO EDIT</span>
                </div>
                
                <div style="padding:16px">
                    <!-- å¤–è²Œ/ç”Ÿç† -->
                    <div style="margin-bottom:16px">
                        <div style="font-size:11px;color:var(--dim);margin-bottom:8px;font-weight:600">ğŸ‘¤ å¤–è²Œç‰¹å¾µ</div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;font-size:12px">
                            ${age ? `<div><span style="color:var(--dim)">å¹´é½¡ï¼š</span>${age}</div>` : ''}
                            ${height ? `<div><span style="color:var(--dim)">é«”å‹ï¼š</span>${height}</div>` : ''}
                            ${posture ? `<div><span style="color:var(--dim)">å§¿æ…‹ï¼š</span>${posture}</div>` : ''}
                        </div>
                        ${appearance ? `<p style="font-size:12px;margin:8px 0 0"><span style="color:var(--dim)">æè¿°ï¼š</span>${appearance}</p>` : ''}
                        ${phy.eyes ? `<p style="font-size:12px;margin:4px 0 0"><span style="color:var(--dim)">çœ¼ç›ï¼š</span>${phy.eyes}</p>` : ''}
                    </div>
                    
                    <!-- å¿ƒç†ç¶­åº¦ -->
                    ${(desire || fear || flaw) ? `
                    <div style="margin-bottom:16px">
                        <div style="font-size:11px;color:var(--dim);margin-bottom:8px;font-weight:600">ğŸ§  å¿ƒç†ç¶­åº¦</div>
                        <div style="font-size:12px">
                            ${desire ? `<p style="margin:0 0 4px"><span style="color:var(--dim)">æ¸´æœ›ï¼š</span>${desire}</p>` : ''}
                            ${fear ? `<p style="margin:0 0 4px"><span style="color:var(--dim)">ææ‡¼ï¼š</span>${fear}</p>` : ''}
                            ${flaw ? `<p style="margin:0 0 4px"><span style="color:var(--dim)">ç¼ºé™·ï¼š</span>${flaw}</p>` : ''}
                            ${charArc ? `<p style="margin:0"><span style="color:var(--dim)">å¼§ç·šï¼š</span>${charArc}</p>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Want/Need/Wound -->
                    <div style="margin-bottom:16px">
                        <div style="font-size:11px;color:var(--primary);margin-bottom:8px;font-weight:600">ğŸ’« è§’è‰²æ ¸å¿ƒ</div>
                        <div style="background:var(--surface2);padding:12px;border-radius:8px;font-size:12px;border-left:3px solid var(--pink)">
                            ${psy.want ? `<p style="margin:0 0 6px"><strong style="color:var(--primary)">Want</strong>ï¼ˆæƒ³è¦ï¼‰ï¼š${psy.want}</p>` : ''}
                            ${psy.need ? `<p style="margin:0 0 6px"><strong style="color:var(--text)">Need</strong>ï¼ˆéœ€è¦ï¼‰ï¼š${psy.need}</p>` : ''}
                            ${psy.wound ? `<p style="margin:0 0 6px"><strong style="color:var(--primary)">Wound</strong>ï¼ˆå‰µå‚·ï¼‰ï¼š${psy.wound}</p>` : ''}
                            ${psy.ghost ? `<p style="margin:0"><strong style="color:var(--dim)">Ghost</strong>ï¼ˆåŸ·å¿µï¼‰ï¼š${psy.ghost}</p>` : ''}
                        </div>
                    </div>
                    
                    <!-- è§’è‰²å¼§ç·š -->
                    ${arc.start ? `
                    <div style="margin-bottom:16px">
                        <div style="font-size:11px;color:var(--text);margin-bottom:8px;font-weight:600">ğŸ“ˆ è§’è‰²å¼§ç·š</div>
                        <div style="font-size:12px;display:flex;align-items:center;gap:8px">
                            <div style="flex:1;background:var(--bg);padding:8px;border-radius:6px;text-align:center">
                                <div style="color:var(--dim);font-size:10px">èµ·é»</div>
                                <div style="margin-top:4px">${arc.start}</div>
                            </div>
                            <div style="color:var(--primary)">â†’</div>
                            <div style="flex:1;background:var(--bg);padding:8px;border-radius:6px;text-align:center">
                                <div style="color:var(--dim);font-size:10px">çµ‚é»</div>
                                <div style="margin-top:4px">${arc.end}</div>
                            </div>
                        </div>
                        ${arc.falseBelief ? `<p style="font-size:11px;margin:8px 0 0;color:var(--dim)">âŒ éŒ¯èª¤ä¿¡å¿µï¼š${arc.falseBelief}</p>` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- Prompt -->
                    ${c.prompt ? `
                    <div class="prompt-box" style="margin:0">
                        <div class="prompt-label">ğŸ–¼ï¸ AI Prompt</div>
                        ${escapeHtml(c.prompt)}
                    </div>` : ''}
                </div>
            </div>`;
        }
        
        // ç¾¤æ¼”ç°¡åŒ–é¡¯ç¤º
        return `
        <div class="item-card">
            <h5>
                <span class="subject-type crowd">ç¾¤æ¼”</span>
                ${c.name}
            </h5>
            <p><strong>èº«ä»½ï¼š</strong>${c.role}</p>
            <p><strong>å¤–è²Œï¼š</strong>${c.appearance}</p>
            ${c.props ? `<p><strong>é“å…·ï¼š</strong>${c.props.join('ã€')}</p>` : ''}
            ${c.prompt ? `
            <div class="prompt-box">
                <div class="prompt-label">ğŸ–¼ï¸ AI Prompt</div>
                ${escapeHtml(c.prompt)}
            </div>` : ''}
        </div>`;
    }).join('');
}

function extractCharacters(){
    const text = state.novel.text;
    
    // åŸºæ–¼ Lajos Egri ä¸‰ç¶­è§’è‰²ç†è«–çš„è©³ç´°è§’è‰²å°å‚³
    return {
        main: [
            {
                name: 'å°çŒ´å­',
                role: 'ä¸»è§’ / å°‘å¹´ç¥å·',
                // ç”Ÿç†ç¶­åº¦
                physiology: {
                    age: 13,
                    gender: 'ç”·',
                    height: '155cm',
                    appearance: 'ç˜¦å°éˆæ´»ï¼Œçš®è†šé»é»‘å¸¶æ›¬æ–‘ï¼Œé»‘è‰²çŸ­é«®å‡Œäº‚',
                    features: 'æ©Ÿè­¦çš„åœ“çœ¼ç›ï¼Œå·¦è‡‰é °å°ç–¤ç—•',
                    posture: 'ç¿’æ…£æ€§é§èƒŒï¼Œéš¨æ™‚æº–å‚™é€ƒè·‘',
                    habits: ['ç·Šå¼µæ™‚å’¬æŒ‡ç”²', 'æ€è€ƒæ™‚æ­ªé ­', 'å–œæ­¡è¹²åœ¨é«˜è™•è§€å¯Ÿ']
                },
                // ç¤¾æœƒç¶­åº¦
                sociology: {
                    birthplace: 'å»£å·è•ƒåŠè²§æ°‘å€',
                    family: 'å­¤å…’ï¼Œè¢«ä¹ä¸è€äººæ”¶é¤Šï¼ˆå·²å»ä¸–ï¼‰',
                    education: 'ç„¡æ­£å¼æ•™è‚²ï¼Œè‡ªå­¸ç”Ÿå­˜',
                    skills: ['æ”€çˆ¬', 'é–‹é–', 'å·ç«Š', 'å¯Ÿè¨€è§€è‰²'],
                    status: 'ç¤¾æœƒåº•å±¤ï¼Œè¢«äººç§ä¸èµ·'
                },
                // å¿ƒç†ç¶­åº¦
                psychology: {
                    emotions: {
                        joy: {triggers: 'å·åˆ°å¥½æ±è¥¿ã€åƒé£½é£¯ã€è¢«äººèª‡è°æ˜', expression: 'éœ²å‡ºç‹¡é» ç¬‘å®¹'},
                        anger: {triggers: 'è¢«çœ‹ä¸èµ·ã€è¢«é¨™ã€ä¸å…¬å¹³å°å¾…', expression: 'å…ˆå¿è‘—ï¼Œæ‰¾æ©Ÿæœƒå ±å¾©'},
                        sadness: {triggers: 'çœ‹åˆ°åˆ¥äººæœ‰å®¶äººã€è¢«æ‹‹æ£„', expression: 'èº²èµ·ä¾†å·å“­'},
                        fear: {surface: 'è¢«æŠ“ä½ã€æŒ¨é¤“', deep: 'æ°¸é å­¤ç¨ã€æ²’äººåœ¨ä¹'}
                    },
                    love: ['è‡ªç”±', 'å¥½åƒçš„é£Ÿç‰©', 'é«˜è™•ï¼ˆå®‰å…¨æ„Ÿï¼‰'],
                    hate: ['æ¬ºè² å¼±å°çš„äºº', 'è™›å½çš„æœ‰éŒ¢äºº', 'è¢«é—œèµ·ä¾†'],
                    want: 'å·åˆ°å€¼éŒ¢çš„æ±è¥¿ï¼Œéä¸Šå¥½æ—¥å­',
                    need: 'è¢«æ¥ç´ã€è¢«èªå¯ã€æ‰¾åˆ°æ­¸å±¬',
                    wound: 'è¢«è¦ªç”Ÿçˆ¶æ¯æ‹‹æ£„ï¼Œå¾å°ç„¡äººç…§é¡§',
                    ghost: 'è€ä¹ä¸çš„æ­» - å”¯ä¸€é—œå¿ƒä»–çš„äººé›¢é–‹äº†'
                },
                // è§’è‰²å¼§ç·š
                arc: {
                    start: 'å­¤ç¨çš„å°å·ï¼Œä¸ä¿¡ä»»ä»»ä½•äºº',
                    falseBelief: 'äººéƒ½æ˜¯è‡ªç§çš„ï¼Œåªèƒ½é è‡ªå·±',
                    end: 'å­¸æœƒä¿¡ä»»ï¼Œæ‰¾åˆ°äº†å®¶äººèˆ¬çš„ç¾ˆçµ†'
                },
                prompt: '13 year old Chinese boy, thin agile, alert round eyes, tanned skin with freckles, messy black hair, small scar on left cheek, ragged brown clothes, Tang dynasty street thief, crouching pose ready to flee, anime style, detailed character design --ar 2:3'
            },
            {
                name: 'å°è©è–©è »',
                role: 'å¥³ä¸»è§’ / ç¥ç§˜å°‘å¥³',
                physiology: {
                    age: 15,
                    gender: 'å¥³',
                    height: '160cm',
                    appearance: 'æ¸…éº—è„«ä¿—ï¼Œè†šå¦‚å‡è„‚ï¼Œé•·é«®åŠè…°',
                    features: 'å¦‚æ°´æçœ¼ï¼Œå”‡è§’æ°¸é å¸¶æ·ºç¬‘',
                    posture: 'ç«™å§¿ç«¯æ­£å¦‚è“®èŠ±ï¼Œå„ªé›…å¾å®¹',
                    habits: ['èªªè©±å‰æœƒå¾®å¾®é–‰çœ¼', 'å–œæ­¡æ’«æ‘¸æ‰‹è…•ä¸Šçš„å¿µç ', 'å¸¸å¸¸æœ›å‘é æ–¹']
                },
                sociology: {
                    birthplace: 'å—æµ·æŸç¥ç§˜å³¶å¶¼',
                    family: 'èº«ä¸–æˆè¬ï¼Œä¼¼ä¹èˆ‡å¯¶çŸ³æœ‰é—œ',
                    education: 'ç²¾é€šå¤šåœ‹èªè¨€ï¼ŒçŸ¥è­˜æ·µåš',
                    skills: ['è§£è®€å¤æ–‡', 'å åœ', 'è‰è—¥çŸ¥è­˜', 'ç¥ç§˜åŠ›é‡'],
                    status: 'å¤–äººçœ¼ä¸­çš„ç¥ç§˜å°‘å¥³'
                },
                psychology: {
                    emotions: {
                        joy: {triggers: 'çœ‹åˆ°å–„è‰¯çš„äººã€èŠ±é–‹çš„æ™‚åˆ»', expression: 'å¾®å¾®ä¸€ç¬‘ï¼Œå¦‚æ˜¥é¢¨'},
                        anger: {triggers: 'çœ‹åˆ°ç”Ÿå‘½è¢«è¼•è¦–', expression: 'çœ¼ä¸­é–ƒéå¯’å…‰ï¼Œè²éŸ³è®Šå†·'},
                        sadness: {triggers: 'å›æ†¶éå»ã€çœ‹åˆ°è¼ªè¿´çš„ç„¡å¥ˆ', expression: 'çœ¼çœ¶æ³›ç´…ä½†ä¸è½æ·š'},
                        fear: {surface: 'å¯¶çŸ³è¢«å¥ª', deep: 'å†æ¬¡å¤±å»é‡è¦çš„äºº'}
                    },
                    love: ['æ‰€æœ‰ç”Ÿå‘½', 'æ—¥å‡ºæ—¥è½', 'çœŸèª çš„å¿ƒ'],
                    hate: ['è²ªå©ª', 'èƒŒå›', 'æ¯€æ»…'],
                    want: 'å®ˆè­·å¯¶çŸ³ï¼Œé˜»æ­¢ç½é›£',
                    need: 'æ”¾ä¸‹åŸ·å¿µï¼Œæ¥å—ç„¡å¸¸',
                    wound: 'å‰ä¸–çš„è¨˜æ†¶ï¼Œæ„›äººçš„çŠ§ç‰²',
                    ghost: 'åƒå¹´å‰çš„ç´„å®šï¼Œæœªèƒ½å®Œæˆçš„ä½¿å‘½'
                },
                arc: {
                    start: 'èƒŒè² ä½¿å‘½çš„å®ˆè­·è€…ï¼Œç–é›¢äººç¾¤',
                    falseBelief: 'æˆ‘å¿…é ˆç¨è‡ªæ‰¿æ“”ä¸€åˆ‡',
                    end: 'å­¸æœƒä¾è³´ä»–äººï¼Œä¸€èµ·å®ˆè­·'
                },
                prompt: '15 year old Southeast Asian girl, ethereal beauty, pale smooth skin, waist-length black hair, almond eyes like still water, gentle smile, white flowing dress, prayer beads on wrist, serene bodhisattva aura, Tang dynasty style, soft lighting, anime --ar 2:3'
            }
        ],
        supporting: [
            {
                name: 'è•ƒé•·',
                role: 'å¤§é£Ÿå•†äºº / èˆ¹éšŠé ˜è¢–',
                physiology: {
                    age: 45,
                    appearance: 'é«˜å¤§é­æ¢§ï¼Œçµ¡è…®é¬ï¼Œæ·±æ²‰çœ¼ç¥',
                    features: 'é¼»æ¨‘é«˜æŒºï¼Œçš®è†šå¤éŠ…ï¼Œå·¦è€³é‡‘ç’°'
                },
                psychology: {
                    emotions: {
                        joy: {triggers: 'èˆªè¡Œé †åˆ©ã€å®¶äººå¹³å®‰'},
                        fear: {deep: 'æµ·ä¸Šçš„è©›å’’ã€éå»çš„ç½ªå­½'}
                    },
                    want: 'å®Œæˆé€™è¶Ÿèˆªè¡Œï¼Œè³ºå–è²¡å¯Œ',
                    need: 'æ•‘è´–éå»çš„éŒ¯èª¤',
                    wound: 'å¹´è¼•æ™‚ç‚ºäº†åˆ©ç›ŠçŠ§ç‰²äº†åŒä¼´'
                },
                prompt: 'Middle Eastern merchant captain, 45yo, tall muscular build, thick black beard, hooked nose, bronze skin, gold earring, turban with jewel, dignified but haunted eyes, Tang dynasty maritime trade, detailed --ar 2:3'
            },
            {
                name: 'åœå¤¢å¸«',
                role: 'å åœå¸« / ç¥ç§˜äººç‰©',
                physiology: {
                    age: 'ä¸è©³ï¼ˆ30-60çš†å¯èƒ½ï¼‰',
                    appearance: 'è’™é¢ï¼Œåªéœ²æ·¡è¤è‰²çœ¼çœ¸',
                    features: 'è²éŸ³å¦‚å¤äº•ï¼Œæ‰‹æŒ‡ä¿®é•·'
                },
                psychology: {
                    emotions: {
                        joy: {triggers: 'å‘½é‹æŒ‰è»Œè·¡é‹è¡Œ'},
                        fear: {deep: 'é è¨€å¤±æº–ã€ç„¡æ³•æ§åˆ¶'}
                    },
                    want: 'å¼•å°å‘½é‹èµ°å‘æ—¢å®šè»Œè·¡',
                    need: '?ï¼ˆè¬åœ˜ï¼Œä¸­å¾ŒæœŸæ­æ›‰ï¼‰',
                    wound: '?ï¼ˆèˆ‡å¯¶çŸ³çš„éå»æœ‰é—œï¼‰'
                },
                prompt: 'Mysterious fortune teller, veiled face revealing only amber eyes, long slender fingers with silver rings, purple robes with strange symbols, surrounded by incense smoke, candlelight, Tang dynasty mystic, ominous atmosphere --ar 2:3'
            },
            {
                name: 'ç´…é«®ç›²è€äºº',
                role: 'æ¸¯å£èªªæ›¸äºº / æ™ºè€…',
                physiology: {
                    age: 70,
                    appearance: 'æ¯ç˜¦ï¼Œç´…é«®ï¼ˆæ³¢æ–¯è¡€çµ±ï¼‰ï¼Œé›™ç›®å¤±æ˜',
                    features: 'ä½åƒ‚ä½†è²éŸ³æ´ªäº®ï¼Œç¸½å¸¶è‘—å¾®ç¬‘'
                },
                psychology: {
                    emotions: {
                        joy: {triggers: 'æœ‰äººé¡˜æ„è½æ•…äº‹'},
                        sadness: {triggers: 'æƒ³èµ·å¹´è¼•æ™‚çš„å†’éšª'}
                    },
                    want: 'åœ¨æ­»å‰æŠŠæ‰€æœ‰æ•…äº‹è¬›å®Œ',
                    need: 'æ‰¾åˆ°å‚³æ‰¿è€…',
                    wound: 'æµ·ä¸Šå¤±å»é›™çœ¼å’Œæ‘¯æ„›'
                },
                prompt: 'Old blind storyteller, 70yo, thin frail body, striking red hair faded with age, milky blind eyes, warm smile, grey tattered robes, bamboo walking cane, sitting under banyan tree, Tang dynasty port atmosphere --ar 2:3'
            }
        ],
        extras: [
            {
                name: 'è•ƒåŠå•†è²©',
                role: 'èƒŒæ™¯ç¾¤æ¼”',
                appearance: 'å„åœ‹å•†äººæ··é›œï¼šæ³¢æ–¯åœ°æ¯¯å•†ã€å¤§é£Ÿé¦™æ–™è²©ã€å¤©ç«ºç å¯¶åŒ ',
                props: ['é¦™æ–™è¢‹', 'éŠ…ç§¤', 'å„åœ‹è²¨å¹£', 'å«è³£æ‹›ç‰Œ'],
                prompt: 'Crowded Tang dynasty Fanfang marketplace, diverse merchants - Persian carpet seller, Arabian spice trader, Indian jeweler, colorful goods everywhere, busy haggling atmosphere, warm afternoon light --ar 16:9'
            },
            {
                name: 'èˆ¹å“¡æ°´æ‰‹',
                role: 'èƒŒæ™¯ç¾¤æ¼”',
                appearance: 'èµ¤è†Šæˆ–çŸ­æ‰“ï¼Œçš®è†šé»é»‘ï¼Œæ‰‹è‡‚ç²—å£¯',
                props: ['ç¹©ç´¢', 'æœ¨æ¡¶', 'èˆ¹å¸†', 'é‰¤å­'],
                prompt: 'Tang dynasty ship crew, muscular sailors with tanned skin, carrying cargo, coiling ropes, wooden ship deck, sea breeze, working hard, sweat glistening --ar 16:9'
            },
            {
                name: 'æµ·ç›œåœ˜',
                role: 'åæ´¾ç¾¤æ¼”',
                appearance: 'é¢ç›®çŒ™ç°ï¼Œç–¤ç—•ç´‹èº«ï¼Œæ­¦å™¨æ£®æ£®',
                props: ['å½åˆ€', 'é»‘æ——', 'ç«æŠŠ', 'ç¹©ç¶²'],
                prompt: 'Fierce Tang dynasty era pirates, scarred faces, tattoos, wielding curved swords, black sailed ship, menacing expressions, torchlight, dangerous atmosphere --ar 16:9'
            }
        ]
    };
}

// ==================== å°è©±å¼è§’è‰²ç·¨è¼¯ ====================
function openCharacterDialog(type, indexOrName) {
    // æ‰¾åˆ°è§’è‰²ï¼ˆæ”¯æŒç´¢å¼•æˆ–åå­—ï¼‰
    const chars = state.characters[type] || [];
    let charIndex;
    if (typeof indexOrName === 'number') {
        charIndex = indexOrName;
    } else {
        charIndex = chars.findIndex(c => c.name === indexOrName);
    }
    if (charIndex === -1 || charIndex >= chars.length) return;
    
    const char = chars[charIndex];
    
    // åˆ›å»ºå¯¹è¯æ¡†
    const dialog = document.createElement('div');
    dialog.id = 'characterEditDialog';
    dialog.style.cssText = `
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,.85);
        display:flex;align-items:center;justify-content:center;
        z-index:10000;
        backdrop-filter:blur(5px);
    `;
    
    dialog.innerHTML = `
        <div style="background:var(--surface);border:1px solid var(--primary);width:90%;max-width:500px;max-height:80vh;overflow-y:auto;position:relative;clip-path:polygon(0 0,calc(100% - 20px) 0,100% 20px,100% 100%,20px 100%,0 calc(100% - 20px))">
            <div style="background:linear-gradient(135deg,var(--primary),var(--pink));padding:20px;color:#fff">
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <div>
                        <div style="font-family:'Orbitron',monospace;font-size:10px;opacity:.7;letter-spacing:2px">CHARACTER EDIT MODE</div>
                        <div style="font-size:18px;font-weight:600;margin-top:4px">${escapeHtml(char.name)}</div>
                    </div>
                    <button onclick="closeCharacterDialog()" style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:0;line-height:1">Ã—</button>
                </div>
            </div>
            
            <div style="padding:20px">
                <div style="background:var(--bg);border:1px solid var(--border);padding:16px;margin-bottom:20px">
                    <div style="font-family:'Orbitron',monospace;font-size:9px;color:var(--dim);margin-bottom:12px;letter-spacing:2px">ğŸ’¡ å°è©±å¼ç·¨è¼¯</div>
                    <div style="font-size:12px;color:var(--dim);line-height:1.8">
                        ç”¨è‡ªç„¶èªè¨€æè¿°ä½ æƒ³ä¿®æ”¹çš„å…§å®¹ï¼Œä¾‹å¦‚ï¼š<br>
                        <span style="color:var(--text)">ã€Œå¹´é½¡æ”¹æˆ18æ­²ã€</span><br>
                        <span style="color:var(--text)">ã€ŒåŠ ä¸Šä¸€å€‹ç¿’æ…£ï¼šå–œæ­¡çœ‹æµ·ã€</span><br>
                        <span style="color:var(--text)">ã€Œå¥¹çš„å‰µå‚·æ˜¯å¤±å»äº†æ¯è¦ªã€</span><br>
                        <span style="color:var(--text)">ã€Œå¤–è²Œæ›´å†·è‰·ä¸€é»ã€</span>
                    </div>
                </div>
                
                <div style="margin-bottom:16px">
                    <textarea id="charEditInput" class="form-input" style="min-height:100px" placeholder="è¼¸å…¥ä½ æƒ³ä¿®æ”¹çš„å…§å®¹..."></textarea>
                </div>
                
                <div id="charEditHistory" style="margin-bottom:16px;max-height:150px;overflow-y:auto"></div>
                
                <div style="display:flex;gap:10px">
                    <button class="btn" onclick="closeCharacterDialog()" style="flex:1">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="applyCharacterEdit('${type}', ${charIndex})" style="flex:1">æ‡‰ç”¨ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
    document.getElementById('charEditInput').focus();
    
    // ESCå…³é—­
    dialog.addEventListener('click', (e) => {
        if (e.target === dialog) closeCharacterDialog();
    });
}

function closeCharacterDialog() {
    const dialog = document.getElementById('characterEditDialog');
    if (dialog) dialog.remove();
}

function applyCharacterEdit(type, index) {
    const input = document.getElementById('charEditInput').value.trim();
    if (!input) {
        alert('è«‹è¼¸å…¥ä¿®æ”¹å…§å®¹');
        return;
    }
    
    const char = state.characters[type][index];
    const historyDiv = document.getElementById('charEditHistory');
    
    // è§£æå¹¶åº”ç”¨ä¿®æ”¹ï¼ˆç®€å•çš„å…³é”®è¯åŒ¹é…ï¼‰
    let applied = [];
    
    // å¹´é¾„
    const ageMatch = input.match(/å¹´[é½¡é¾„]\s*[æ”¹ç‚ºä¸ºæˆï¼š:]*\s*(\d+)/);
    if (ageMatch && char.physiology) {
        char.physiology.age = parseInt(ageMatch[1]);
        applied.push(`å¹´é½¡ â†’ ${ageMatch[1]}æ­²`);
    }
    
    // èº«é«˜
    const heightMatch = input.match(/èº«é«˜\s*[æ”¹ç‚ºä¸ºæˆï¼š:]*\s*(\d+)/);
    if (heightMatch && char.physiology) {
        char.physiology.height = heightMatch[1] + 'cm';
        applied.push(`èº«é«˜ â†’ ${heightMatch[1]}cm`);
    }
    
    // æ€§åˆ«
    if (/æ€§[åˆ¥åˆ«]\s*[æ”¹ç‚ºä¸ºæˆï¼š:]*\s*[ç”·å¥³]/.test(input)) {
        const gender = input.includes('ç”·') ? 'ç”·' : 'å¥³';
        if (char.physiology) {
            char.physiology.gender = gender;
            applied.push(`æ€§åˆ¥ â†’ ${gender}`);
        }
    }
    
    // å¤–è²Œ
    const appearMatch = input.match(/å¤–[è²Œè¡¨].*[æ”¹ç‚ºä¸ºæˆï¼š:]\s*(.+)/);
    if (appearMatch && char.physiology) {
        char.physiology.appearance = appearMatch[1].trim();
        applied.push(`å¤–è²Œ â†’ ${appearMatch[1].trim()}`);
    }
    
    // Want
    const wantMatch = input.match(/[Ww]ant.*[æ”¹ç‚ºä¸ºæˆï¼š:]\s*(.+)/);
    if (wantMatch && char.psychology) {
        char.psychology.want = wantMatch[1].trim();
        applied.push(`Want â†’ ${wantMatch[1].trim()}`);
    }
    
    // Need  
    const needMatch = input.match(/[Nn]eed.*[æ”¹ç‚ºä¸ºæˆï¼š:]\s*(.+)/);
    if (needMatch && char.psychology) {
        char.psychology.need = needMatch[1].trim();
        applied.push(`Need â†’ ${needMatch[1].trim()}`);
    }
    
    // å‰µå‚·/Wound
    const woundMatch = input.match(/[å‰µåˆ›]å‚·|[Ww]ound.*[æ”¹ç‚ºä¸ºæˆæ˜¯ï¼š:]\s*(.+)/);
    if (woundMatch && char.psychology) {
        char.psychology.wound = woundMatch[1]?.trim() || input.replace(/.*[æ˜¯ï¼š:]/, '').trim();
        applied.push(`Wound â†’ ${char.psychology.wound}`);
    }
    
    // ä¹ æƒ¯
    const habitMatch = input.match(/[ç¿’ä¹ ][æ…£æƒ¯].*[åŠ ä¸Šæ·»].*[ï¼š:ã€Œ]?\s*(.+?)[ã€]?$/);
    if (habitMatch && char.physiology?.habits) {
        char.physiology.habits.push(habitMatch[1].trim());
        applied.push(`æ–°å¢ç¿’æ…£ï¼š${habitMatch[1].trim()}`);
    }
    
    // æ˜¾ç¤ºç»“æœ
    if (applied.length > 0) {
        historyDiv.innerHTML += `
            <div style="background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);padding:10px;margin-bottom:8px;font-size:12px">
                <div style="color:var(--text);font-weight:600;margin-bottom:4px">âœ“ å·²æ‡‰ç”¨ä¿®æ”¹</div>
                ${applied.map(a => `<div style="color:var(--text)">â€¢ ${a}</div>`).join('')}
            </div>
        `;
        document.getElementById('charEditInput').value = '';
        
        // æ›´æ–°ä¸»ç•Œé¢
        showStep(5);
    } else {
        historyDiv.innerHTML += `
            <div style="background:rgba(128,128,128,.1);border:1px solid rgba(128,128,128,.3);padding:10px;margin-bottom:8px;font-size:12px">
                <div style="color:var(--dim);font-weight:600;margin-bottom:4px">âš ï¸ ç„¡æ³•è­˜åˆ¥ä¿®æ”¹æ„åœ–</div>
                <div style="color:var(--dim)">è«‹å˜—è©¦æ›´æ˜ç¢ºçš„æè¿°ï¼Œå¦‚ï¼šã€Œå¹´é½¡æ”¹æˆ18æ­²ã€</div>
            </div>
        `;
    }
}

// ==================== Step 6: æœåŒ–é“ ====================
const DESIGN_SKILLS = [
    { id: 'scene_design', name: 'å ´æ™¯è¨­è¨ˆ', desc: 'å ´æ™¯æ°›åœ/çµæ§‹' },
    { id: 'costume', name: 'æœè£è¨­è¨ˆ', desc: 'è§’è‰²æœé£¾' },
    { id: 'props', name: 'é“å…·è¨­è¨ˆ', desc: 'é—œéµé“å…·' },
    { id: 'color_palette', name: 'è‰²å½©ç³»çµ±', desc: 'è¦–è¦ºçµ±ä¸€' }
];

// ==================== ç•«é¢¨é¸æ“‡å™¨ ====================
// Moodboardå…ƒç´ åº«
const MOODBOARD_ELEMENTS = {
    'å…‰å½±': ['æŸ”å…‰', 'ç¡¬å…‰', 'å´å…‰', 'é€†å…‰', 'éœ“è™¹', 'è‡ªç„¶å…‰', 'é»ƒé‡‘æ™‚åˆ»', 'è—èª¿æ™‚åˆ»', 'èšå…‰ç‡ˆ', 'æ°›åœå…‰'],
    'è‰²èª¿': ['é«˜é£½å’Œ', 'ä½é£½å’Œ', 'æš–è‰²èª¿', 'å†·è‰²èª¿', 'å¾©å¤è‰²', 'é’æ©™èª¿', 'é»‘é‡‘èª¿', 'ç²‰å½©èª¿', 'å–®è‰²èª¿', 'å°æ¯”å¼·çƒˆ'],
    'è³ªæ„Ÿ': ['è† ç‰‡é¡†ç²’', 'éŠ³åˆ©æ¸…æ™°', 'æŸ”ç„¦æœ¦æœ§', 'æ²¹ç•«ç­†è§¸', 'æ°´å½©æšˆæŸ“', 'ç´ æè³ªæ„Ÿ', 'é‡‘å±¬è³ªæ„Ÿ', 'ç£¨ç ‚è³ªæ„Ÿ'],
    'æ°›åœ': ['å²è©©æ„Ÿ', 'è¦ªå¯†æ„Ÿ', 'æ‡¸ç–‘æ„Ÿ', 'æµªæ¼«æ„Ÿ', 'å£“è¿«æ„Ÿ', 'ç©ºéˆæ„Ÿ', 'æ‡·èˆŠæ„Ÿ', 'æœªä¾†æ„Ÿ', 'å¤¢å¹»æ„Ÿ'],
    'æ§‹åœ–': ['å°ç¨±æ§‹åœ–', 'é»ƒé‡‘åˆ†å‰²', 'æ¥µç°¡ç•™ç™½', 'æ»¿æ§‹åœ–', 'ä½è§’åº¦', 'é«˜è§’åº¦', 'ç‰¹å¯«', 'é æ™¯', 'è·è˜­è§’'],
    'ç‰¹æ•ˆ': ['æ™¯æ·±æ¨¡ç³Š', 'å‹•æ…‹æ¨¡ç³Š', 'é¡é ­å…‰æšˆ', 'ç…™éœ§æ•ˆæœ', 'é›¨æ»´æ•ˆæœ', 'å…‰æ–‘bokeh', 'å€’å½±', 'å‰ªå½±']
};

let artStyleMode = 'ai'; // 'ai' | 'preset' | 'moodboard'
let selectedMoodElements = [];
let aiStyleRecommendations = null;

function renderArtStyleStep(){
    const categories = ['2Då‹•ç•«', '3Dé¢¨æ ¼', 'é›»å½±è³ªæ„Ÿ', 'äººç‰©é€ å‹', 'è¦–è¦ºé¢¨æ ¼', 'AIç‰¹æ•ˆ', 'åœ°åŸŸç¾å­¸', 'å°æ¼”é¢¨æ ¼'];
    const selectedId = state.artStyle?.id || '';
    
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ¨</span> ç•«é¢¨æ™ºèƒ½é«”</h3>
            
            <!-- ä¸‰ç¨®æ¨¡å¼åˆ‡æ› -->
            <div style="display:flex;gap:6px;margin-bottom:16px">
                <button class="btn ${artStyleMode === 'ai' ? 'btn-primary' : ''}" onclick="artStyleMode='ai';document.getElementById('contentArea').innerHTML=renderArtStyleStep()" style="flex:1;font-size:12px">
                    ğŸ¤– AIæ¨è–¦
                </button>
                <button class="btn ${artStyleMode === 'preset' ? 'btn-primary' : ''}" onclick="artStyleMode='preset';document.getElementById('contentArea').innerHTML=renderArtStyleStep()" style="flex:1;font-size:12px">
                    ğŸ¬ é è¨­é¢¨æ ¼
                </button>
                <button class="btn ${artStyleMode === 'moodboard' ? 'btn-primary' : ''}" onclick="artStyleMode='moodboard';document.getElementById('contentArea').innerHTML=renderArtStyleStep()" style="flex:1;font-size:12px">
                    ğŸ¨ Moodboard
                </button>
            </div>
            
            ${artStyleMode === 'ai' ? renderAIStyleMode() : 
              artStyleMode === 'moodboard' ? renderMoodboardMode() : 
              renderPresetStyleMode(categories, selectedId)}
            
            <div class="btn-group" style="margin-top:20px">
                <button class="btn btn-back" onclick="prevStep()">â† è¿”å›</button>
                <button class="btn btn-primary" onclick="nextStep()" ${!state.artStyle ? 'disabled' : ''}>
                    ${state.artStyle ? 'ä¸‹ä¸€æ­¥ â†’' : 'è«‹å…ˆé¸æ“‡æˆ–é…ç½®ç•«é¢¨'}
                </button>
            </div>
        </div>
    `;
}

// AIæ¨è–¦ç•«é¢¨æ¨¡å¼
function renderAIStyleMode(){
    if(!aiStyleRecommendations){
        // é‚„æ²’æœ‰åˆ†æçµæœï¼Œé¡¯ç¤ºåˆ†ææŒ‰éˆ•
        return `
            <div style="text-align:center;padding:30px">
                <div style="font-size:48px;margin-bottom:16px">ğŸ¤–</div>
                <h4 style="margin-bottom:12px">ç•«é¢¨æ™ºèƒ½é«”</h4>
                <p style="color:var(--dim);margin-bottom:20px;font-size:13px">
                    æ ¹æ“šæ•…äº‹å…§å®¹ã€é¡å‹ã€æƒ…ç·’åŸºèª¿ï¼Œ<br>AIå°‡åˆ†æç«¶å“ä¸¦æ¨è–¦æœ€é©åˆçš„ç•«é¢¨
                </p>
                <div id="aiStyleAnalysis"></div>
                <button class="btn btn-primary" onclick="runArtStyleAnalysis()" style="padding:12px 32px">
                    ğŸ¨ é–‹å§‹åˆ†æä¸¦æ¨è–¦ç•«é¢¨
                </button>
            </div>
        `;
    }
    
    // æœ‰åˆ†æçµæœï¼Œé¡¯ç¤ºæ¨è–¦
    const rec = aiStyleRecommendations;
    return `
        <div style="margin-bottom:16px;padding:12px;background:var(--surface2);border-radius:8px">
            <div style="font-weight:600;margin-bottom:8px">ğŸ“Š å…§å®¹åˆ†æ</div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:12px">
                <div><span style="color:var(--dim)">é¡å‹ï¼š</span>${rec.analysis?.genre || '-'}</div>
                <div><span style="color:var(--dim)">åŸºèª¿ï¼š</span>${rec.analysis?.mood || '-'}</div>
                <div><span style="color:var(--dim)">å—çœ¾ï¼š</span>${rec.analysis?.audience || '-'}</div>
                <div><span style="color:var(--dim)">æ™‚ä»£ï¼š</span>${rec.analysis?.era || '-'}</div>
            </div>
        </div>
        
        ${rec.competitors?.length > 0 ? `
            <div style="margin-bottom:16px;padding:12px;background:var(--surface2);border-radius:8px">
                <div style="font-weight:600;margin-bottom:8px">ğŸ¬ ç«¶å“åƒè€ƒ</div>
                <div style="display:flex;flex-wrap:wrap;gap:8px">
                    ${rec.competitors.map(c => `
                        <div style="background:var(--bg);padding:6px 10px;border-radius:4px;font-size:11px">
                            <strong>${c.name}</strong>: ${c.style}
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        <div style="font-weight:600;margin-bottom:12px">ğŸ¨ AIæ¨è–¦ç•«é¢¨</div>
        <div style="display:grid;gap:10px;max-height:250px;overflow-y:auto">
            ${(rec.recommendations || []).map((r, idx) => `
                <div onclick="selectAIRecommendation(${idx})" 
                     style="padding:12px;background:${state.artStyle?.aiRecIdx === idx ? 'rgba(255,10,53,.15)' : 'var(--surface2)'};border:2px solid ${state.artStyle?.aiRecIdx === idx ? 'var(--primary)' : 'var(--border)'};border-radius:8px;cursor:pointer">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                        <strong>${r.style_name}</strong>
                        ${idx === 0 ? '<span style="background:var(--primary);color:#fff;padding:2px 8px;border-radius:10px;font-size:10px">æ¨è–¦</span>' : ''}
                    </div>
                    <div style="color:var(--dim);font-size:12px;margin-bottom:8px">${r.reason}</div>
                    ${r.reference_works?.length > 0 ? `
                        <div style="font-size:11px;color:var(--dim)">åƒè€ƒï¼š${r.reference_works.join('ã€')}</div>
                    ` : ''}
                    ${r.mood_elements ? `
                        <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px">
                            ${Object.entries(r.mood_elements).map(([k,v]) => `<span style="background:var(--bg);padding:2px 6px;border-radius:4px;font-size:10px">${v}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('')}
        </div>
        
        ${rec.final_suggestion ? `
            <div style="margin-top:16px;padding:14px;background:rgba(255,10,53,.1);border:1px solid var(--primary);border-radius:8px">
                <div style="font-weight:600;margin-bottom:8px">âœ… æœ€çµ‚æ¨è–¦ï¼š${rec.final_suggestion.primary_style}</div>
                <div style="background:var(--bg);padding:8px;border-radius:4px;font-family:monospace;font-size:10px;color:var(--dim)">
                    ${rec.final_suggestion.full_prompt}
                </div>
                <button onclick="applyAIFinalSuggestion()" class="btn btn-primary" style="width:100%;margin-top:10px">
                    âœ… æ‡‰ç”¨æ­¤æ¨è–¦ç•«é¢¨
                </button>
            </div>
        ` : ''}
        
        <button onclick="aiStyleRecommendations=null;document.getElementById('contentArea').innerHTML=renderArtStyleStep()" class="btn" style="width:100%;margin-top:10px">
            ğŸ”„ é‡æ–°åˆ†æ
        </button>
    `;
}

async function runArtStyleAnalysis(){
    const container = document.getElementById('aiStyleAnalysis');
    container.innerHTML = `
        <div class="loading" style="margin:20px 0">
            <div class="spinner"></div>
            <span>ç•«é¢¨æ™ºèƒ½é«”åˆ†æä¸­...</span>
        </div>
    `;
    
    try {
        const response = await callAgent('artstyle', {
            novel: state.novel?.text?.substring(0, 8000) || '',
            title: state.novel?.title || '',
            concept: state.concept || {},
            interview: state.interview || {}
        });
        
        if(response?.result){
            try {
                aiStyleRecommendations = typeof response.result === 'string' ? JSON.parse(response.result) : response.result;
            } catch(e){
                aiStyleRecommendations = { analysis: {}, recommendations: [{ style_name: 'é»˜èªå‹•ç•«', reason: response.result, prompt_keywords: 'anime style, high quality' }] };
            }
        }
        
        document.getElementById('contentArea').innerHTML = renderArtStyleStep();
    } catch(err){
        container.innerHTML = `<div style="color:var(--error);padding:12px">åˆ†æå¤±æ•—ï¼š${err.message}</div>`;
    }
}

function selectAIRecommendation(idx){
    const rec = aiStyleRecommendations?.recommendations?.[idx];
    if(rec){
        state.artStyle = {
            id: 'ai_rec_' + idx,
            name: rec.style_name,
            category: 'AIæ¨è–¦',
            prompt: rec.prompt_keywords || '',
            preview: 'ğŸ¤–',
            isAI: true,
            aiRecIdx: idx,
            moodElements: rec.mood_elements
        };
        document.getElementById('contentArea').innerHTML = renderArtStyleStep();
    }
}

function applyAIFinalSuggestion(){
    const suggestion = aiStyleRecommendations?.final_suggestion;
    if(suggestion){
        state.artStyle = {
            id: 'ai_final',
            name: suggestion.primary_style,
            category: 'AIæ¨è–¦',
            prompt: suggestion.full_prompt,
            preview: 'âœ¨',
            isAI: true
        };
        document.getElementById('contentArea').innerHTML = renderArtStyleStep();
    }
}

function renderPresetStyleMode(categories, selectedId){
    return `
        <p style="color:var(--dim);margin-bottom:20px">é¸æ“‡ä¸€ç¨®é è¨­ç•«é¢¨ï¼Œå°‡æ‡‰ç”¨åˆ°æ‰€æœ‰åˆ†é¡</p>
        
        <div style="max-height:400px;overflow-y:auto;padding-right:8px">
        ${categories.map(cat => `
            <div style="margin-bottom:16px">
                <h4 style="color:var(--primary);margin-bottom:10px;font-size:13px;position:sticky;top:0;background:var(--bg);padding:4px 0">${cat}</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(85px,1fr));gap:8px">
                    ${ART_STYLES.filter(s => s.category === cat).map(style => `
                        <div onclick="selectArtStyle('${style.id}')"
                             style="background:var(--surface2);border:2px solid ${selectedId === style.id ? 'var(--primary)' : 'var(--border)'};border-radius:6px;padding:8px;cursor:pointer;text-align:center;transition:all .15s;${selectedId === style.id ? 'box-shadow:0 0 10px var(--primary)' : ''}">
                            <div style="font-size:24px">${style.preview}</div>
                            <div style="font-size:10px;font-weight:600;margin-top:4px">${style.name}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('')}
        </div>
        
        ${state.artStyle && !state.artStyle.isCustom ? `
            <div style="margin-top:16px;padding:14px;background:rgba(255,10,53,.1);border:1px solid var(--primary);border-radius:8px">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                    <span style="font-size:28px">${state.artStyle.preview}</span>
                    <div>
                        <div style="font-weight:600">${state.artStyle.name}</div>
                        <div style="color:var(--dim);font-size:11px">${state.artStyle.category}</div>
                    </div>
                </div>
                <div style="background:var(--bg);padding:8px;border-radius:4px;font-family:monospace;font-size:10px;color:var(--dim)">
                    ${state.artStyle.prompt}
                </div>
            </div>
        ` : ''}
    `;
}

function renderMoodboardMode(){
    const combinedPrompt = buildMoodboardPrompt();
    
    return `
        <p style="color:var(--dim);margin-bottom:16px">çµ„åˆå¤šç¨®å…ƒç´ ï¼Œå‰µå»ºç¨ç‰¹ç•«é¢¨</p>
        
        <div style="max-height:350px;overflow-y:auto;padding-right:8px">
        ${Object.entries(MOODBOARD_ELEMENTS).map(([category, elements]) => `
            <div style="margin-bottom:14px">
                <h4 style="color:var(--primary);margin-bottom:8px;font-size:12px">${category}</h4>
                <div style="display:flex;flex-wrap:wrap;gap:6px">
                    ${elements.map(el => {
                        const isSelected = selectedMoodElements.includes(el);
                        return `<span onclick="toggleMoodElement('${el}')" 
                                     style="padding:6px 12px;background:${isSelected ? 'var(--primary)' : 'var(--surface2)'};color:${isSelected ? '#fff' : 'var(--text)'};border-radius:20px;font-size:11px;cursor:pointer;transition:all .15s;border:1px solid ${isSelected ? 'var(--primary)' : 'var(--border)'}">${el}</span>`;
                    }).join('')}
                </div>
            </div>
        `).join('')}
        </div>
        
        <!-- å·²é¸æ“‡çš„å…ƒç´  -->
        <div style="margin-top:16px;padding:14px;background:var(--surface2);border-radius:8px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                <span style="font-weight:600;font-size:13px">ğŸ¨ å·²é¸æ“‡ ${selectedMoodElements.length} å€‹å…ƒç´ </span>
                ${selectedMoodElements.length > 0 ? `<button onclick="selectedMoodElements=[];document.getElementById('contentArea').innerHTML=renderArtStyleStep()" style="background:none;border:none;color:var(--dim);cursor:pointer;font-size:11px">æ¸…ç©º</button>` : ''}
            </div>
            
            ${selectedMoodElements.length > 0 ? `
                <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">
                    ${selectedMoodElements.map(el => `<span style="padding:4px 8px;background:var(--primary);color:#fff;border-radius:12px;font-size:10px">${el}</span>`).join('')}
                </div>
                <div style="background:var(--bg);padding:8px;border-radius:4px;font-family:monospace;font-size:10px;color:var(--dim)">
                    <strong>çµ„åˆPromptï¼š</strong>${combinedPrompt}
                </div>
                <button onclick="applyMoodboard()" class="btn btn-primary" style="width:100%;margin-top:10px">âœ… æ‡‰ç”¨æ­¤ç•«é¢¨çµ„åˆ</button>
            ` : `
                <div style="color:var(--dim);font-size:12px;text-align:center">ğŸ‘† é»æ“Šä¸Šæ–¹æ¨™ç±¤æ·»åŠ å…ƒç´ </div>
            `}
        </div>
        
        ${state.artStyle?.isCustom ? `
            <div style="margin-top:12px;padding:12px;background:rgba(255,10,53,.1);border:1px solid var(--primary);border-radius:8px">
                <div style="font-weight:600;margin-bottom:6px">âœ… å·²æ‡‰ç”¨è‡ªå®šç¾©ç•«é¢¨</div>
                <div style="font-size:11px;color:var(--dim)">${state.artStyle.prompt}</div>
            </div>
        ` : ''}
        
        <!-- AIåœ–ç‰‡åŠŸèƒ½ -->
        ${renderMoodboardExtras()}
    `;
}

function toggleMoodElement(element){
    const idx = selectedMoodElements.indexOf(element);
    if(idx >= 0){
        selectedMoodElements.splice(idx, 1);
    } else {
        selectedMoodElements.push(element);
    }
    document.getElementById('contentArea').innerHTML = renderArtStyleStep();
}

function buildMoodboardPrompt(){
    if(selectedMoodElements.length === 0) return '';
    
    const promptMap = {
        'æŸ”å…‰': 'soft diffused lighting', 'ç¡¬å…‰': 'hard dramatic lighting', 'å´å…‰': 'side lighting, Rembrandt',
        'é€†å…‰': 'backlit silhouette', 'éœ“è™¹': 'neon lights glow', 'è‡ªç„¶å…‰': 'natural daylight',
        'é»ƒé‡‘æ™‚åˆ»': 'golden hour warm light', 'è—èª¿æ™‚åˆ»': 'blue hour cool tones', 'èšå…‰ç‡ˆ': 'spotlight dramatic',
        'æ°›åœå…‰': 'ambient mood lighting', 'é«˜é£½å’Œ': 'high saturation vibrant', 'ä½é£½å’Œ': 'desaturated muted',
        'æš–è‰²èª¿': 'warm color palette', 'å†·è‰²èª¿': 'cool blue tones', 'å¾©å¤è‰²': 'vintage color grading',
        'é’æ©™èª¿': 'teal and orange', 'é»‘é‡‘èª¿': 'black and gold luxury', 'ç²‰å½©èª¿': 'pastel soft colors',
        'å–®è‰²èª¿': 'monochromatic', 'å°æ¯”å¼·çƒˆ': 'high contrast', 'è† ç‰‡é¡†ç²’': 'film grain texture',
        'éŠ³åˆ©æ¸…æ™°': 'sharp crisp details', 'æŸ”ç„¦æœ¦æœ§': 'soft focus dreamy', 'æ²¹ç•«ç­†è§¸': 'oil painting brushstrokes',
        'æ°´å½©æšˆæŸ“': 'watercolor wash', 'ç´ æè³ªæ„Ÿ': 'pencil sketch texture', 'é‡‘å±¬è³ªæ„Ÿ': 'metallic sheen',
        'ç£¨ç ‚è³ªæ„Ÿ': 'matte frosted', 'å²è©©æ„Ÿ': 'epic cinematic scale', 'è¦ªå¯†æ„Ÿ': 'intimate close atmosphere',
        'æ‡¸ç–‘æ„Ÿ': 'mysterious suspense', 'æµªæ¼«æ„Ÿ': 'romantic dreamy mood', 'å£“è¿«æ„Ÿ': 'oppressive tense',
        'ç©ºéˆæ„Ÿ': 'ethereal spiritual', 'æ‡·èˆŠæ„Ÿ': 'nostalgic vintage', 'æœªä¾†æ„Ÿ': 'futuristic sci-fi',
        'å¤¢å¹»æ„Ÿ': 'dreamlike surreal', 'å°ç¨±æ§‹åœ–': 'symmetrical composition', 'é»ƒé‡‘åˆ†å‰²': 'rule of thirds',
        'æ¥µç°¡ç•™ç™½': 'minimalist negative space', 'æ»¿æ§‹åœ–': 'full frame composition', 'ä½è§’åº¦': 'low angle heroic',
        'é«˜è§’åº¦': 'high angle overhead', 'ç‰¹å¯«': 'extreme close-up', 'é æ™¯': 'wide establishing shot',
        'è·è˜­è§’': 'dutch angle tilted', 'æ™¯æ·±æ¨¡ç³Š': 'shallow depth of field bokeh', 'å‹•æ…‹æ¨¡ç³Š': 'motion blur',
        'é¡é ­å…‰æšˆ': 'lens flare', 'ç…™éœ§æ•ˆæœ': 'atmospheric fog smoke', 'é›¨æ»´æ•ˆæœ': 'rain drops wet',
        'å…‰æ–‘bokeh': 'bokeh light orbs', 'å€’å½±': 'reflection mirror', 'å‰ªå½±': 'silhouette backlit'
    };
    
    return selectedMoodElements.map(el => promptMap[el] || el).join(', ');
}

function applyMoodboard(){
    const prompt = buildMoodboardPrompt();
    state.artStyle = {
        id: 'custom_moodboard',
        name: 'è‡ªå®šç¾©ç•«é¢¨',
        category: 'Moodboard',
        prompt: prompt,
        preview: 'ğŸ¨',
        isCustom: true,
        elements: [...selectedMoodElements]
    };
    document.getElementById('contentArea').innerHTML = renderArtStyleStep();
}

// ==================== Moodboard åœ–ç‰‡åŠŸèƒ½ ====================
let moodboardTestImage = null;
let moodboardAnalyzedStyle = null;

// ç”Ÿæˆæ¸¬è©¦åœ–é è¦½ç•«é¢¨
async function generateMoodboardTestImage(){
    const prompt = buildMoodboardPrompt();
    if(!prompt){
        alert('è«‹å…ˆé¸æ“‡ç•«é¢¨å…ƒç´ ');
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ ç”Ÿæˆä¸­...';
    btn.disabled = true;
    
    try {
        // æ·»åŠ æ¸¬è©¦å ´æ™¯
        const fullPrompt = `${prompt}, cinematic scene, beautiful lighting, masterpiece quality, 8k`;
        
        const resp = await fetch(`${API_BASE}/moodboard/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: fullPrompt })
        });
        
        if(!resp.ok) {
            throw new Error(`APIéŒ¯èª¤ ${resp.status}: ${resp.statusText}`);
        }
        
        const data = await resp.json();
        if(data.error){
            throw new Error(data.error);
        }
        
        moodboardTestImage = data.url;
        document.getElementById('contentArea').innerHTML = renderArtStyleStep();
        
    } catch(err) {
        alert('ç”Ÿæˆå¤±æ•—: ' + err.message + '\n\næç¤º: éœ€è¦åœ¨ .env ä¸­é…ç½® TOGETHER_API_KEY');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// ä¸Šå‚³åœ–ç‰‡åæ¨ç•«é¢¨
async function uploadImageForAnalysis(){
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        // è½‰æ›ç‚ºbase64
        const reader = new FileReader();
        reader.onload = async (ev) => {
            const base64 = ev.target.result;
            
            // é¡¯ç¤ºloading
            const contentArea = document.getElementById('contentArea');
            const loadingHtml = `
                <div class="content-card" style="text-align:center;padding:40px">
                    <div style="font-size:48px;margin-bottom:20px">ğŸ”</div>
                    <h3>AIæ­£åœ¨åˆ†æåœ–ç‰‡é¢¨æ ¼...</h3>
                    <div style="color:var(--dim);margin-top:10px">ä½¿ç”¨ Claude Vision è­˜åˆ¥è—è¡“é¢¨æ ¼</div>
                </div>
            `;
            contentArea.innerHTML = loadingHtml;
            
            try {
                const resp = await fetch(`${API_BASE}/moodboard/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64 })
                });
                
                if(!resp.ok) {
                    throw new Error(`APIéŒ¯èª¤ ${resp.status}: ${resp.statusText}`);
                }
                
                const data = await resp.json();
                if(data.error){
                    throw new Error(data.error);
                }
                
                moodboardAnalyzedStyle = {
                    ...data,
                    sourceImage: base64
                };
                
                contentArea.innerHTML = renderArtStyleStep();
                
            } catch(err) {
                alert('åˆ†æå¤±æ•—: ' + err.message + '\n\næç¤º: éœ€è¦ ANTHROPIC_API_KEY');
                contentArea.innerHTML = renderArtStyleStep();
            }
        };
        reader.readAsDataURL(file);
    };
    
    input.click();
}

// æ‡‰ç”¨åæ¨çš„ç•«é¢¨
function applyAnalyzedStyle(){
    if(!moodboardAnalyzedStyle) return;
    
    state.artStyle = {
        id: 'analyzed_style',
        name: moodboardAnalyzedStyle.style_name || 'åæ¨ç•«é¢¨',
        category: 'åæ¨',
        prompt: moodboardAnalyzedStyle.full_prompt || moodboardAnalyzedStyle.prompt_keywords?.join(', ') || '',
        preview: 'ğŸ–¼ï¸',
        isCustom: true,
        analyzed: moodboardAnalyzedStyle
    };
    
    moodboardAnalyzedStyle = null;
    document.getElementById('contentArea').innerHTML = renderArtStyleStep();
}

// æ¸²æŸ“Moodboardé¡å¤–åŠŸèƒ½å€
function renderMoodboardExtras(){
    return `
        <!-- AIæ¸¬è©¦åœ–ç”Ÿæˆ -->
        <div style="margin-top:16px;padding:14px;background:var(--surface2);border-radius:8px;border:1px dashed var(--border)">
            <h4 style="margin-bottom:10px;font-size:13px">ğŸ–¼ï¸ AIæ¸¬è©¦åœ–</h4>
            
            ${moodboardTestImage ? `
                <div style="margin-bottom:12px">
                    <img src="${moodboardTestImage}" style="width:100%;border-radius:8px;margin-bottom:8px" />
                    <div style="font-size:11px;color:var(--dim)">âœ… é è¦½æ•ˆæœ (ä½¿ç”¨Fluxç”Ÿæˆ)</div>
                </div>
            ` : ''}
            
            <button onclick="generateMoodboardTestImage()" class="btn" style="width:100%;font-size:12px">
                ${moodboardTestImage ? 'ğŸ”„ é‡æ–°ç”Ÿæˆ' : 'ğŸ¨ ç”Ÿæˆæ¸¬è©¦åœ–é è¦½'}
            </button>
            <div style="font-size:10px;color:var(--dim);margin-top:6px;text-align:center">éœ€è¦é…ç½® TOGETHER_API_KEY</div>
        </div>
        
        <!-- åœ–ç‰‡åæ¨ç•«é¢¨ -->
        <div style="margin-top:12px;padding:14px;background:var(--surface2);border-radius:8px;border:1px dashed var(--border)">
            <h4 style="margin-bottom:10px;font-size:13px">ğŸ“· ä¸Šå‚³åœ–ç‰‡åæ¨ç•«é¢¨</h4>
            
            ${moodboardAnalyzedStyle ? `
                <div style="margin-bottom:12px;padding:12px;background:var(--bg);border-radius:8px">
                    ${moodboardAnalyzedStyle.sourceImage ? `<img src="${moodboardAnalyzedStyle.sourceImage}" style="width:100%;max-height:150px;object-fit:cover;border-radius:6px;margin-bottom:8px" />` : ''}
                    <div style="font-size:13px;font-weight:600;margin-bottom:6px">${moodboardAnalyzedStyle.style_name || 'æœªçŸ¥é¢¨æ ¼'}</div>
                    <div style="font-size:11px;color:var(--dim);margin-bottom:4px">ğŸ¨ ${moodboardAnalyzedStyle.mood || ''}</div>
                    <div style="font-size:11px;color:var(--dim);margin-bottom:8px">ğŸ’¡ ${moodboardAnalyzedStyle.lighting || ''}</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px">
                        ${(moodboardAnalyzedStyle.prompt_keywords || []).map(k => `<span style="padding:2px 8px;background:var(--primary);color:#fff;border-radius:10px;font-size:10px">${k}</span>`).join('')}
                    </div>
                    <button onclick="applyAnalyzedStyle()" class="btn btn-primary" style="width:100%;font-size:12px">âœ… ä½¿ç”¨æ­¤ç•«é¢¨</button>
                </div>
            ` : `
                <button onclick="uploadImageForAnalysis()" class="btn" style="width:100%;font-size:12px">
                    ğŸ“¤ ä¸Šå‚³åƒè€ƒåœ–ç‰‡
                </button>
                <div style="font-size:10px;color:var(--dim);margin-top:6px;text-align:center">AIæœƒåˆ†æåœ–ç‰‡ä¸¦æå–ç•«é¢¨Prompt</div>
            `}
        </div>
    `;
}

function selectArtStyle(styleId){
    const style = ART_STYLES.find(s => s.id === styleId);
    if(style){
        state.artStyle = {...style, isCustom: false};
        moodboardMode = false;
        document.getElementById('contentArea').innerHTML = renderArtStyleStep();
        console.log('é¸æ“‡ç•«é¢¨:', style.name, style.prompt);
    }
}

function renderStep5(){
    // æ£€æŸ¥æ˜¯å¦æœ‰è®¾è®¡ç»“æœï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
    const hasDesign = state.designResult || 
                      (state.scenes?.length > 0) || 
                      (state.costumes?.length > 0) ||
                      (state.visualStyle && Object.keys(state.visualStyle).length > 0);
    if(hasDesign){
        return renderDesignResult();
    }
    
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ¨</span> ç¾è¡“ç¸½ç›£ + å ´æ™¯Agent</h3>
            
            <div id="designAgentUI">
                <div style="text-align:center;padding:20px">
                    <button class="btn btn-primary" onclick="runDesignAgent()" style="padding:16px 40px;font-size:16px">
                        ğŸš€ é–‹å§‹AIæœåŒ–é“è¨­è¨ˆ
                    </button>
                    <div style="font-size:12px;color:var(--dim);margin-top:12px">
                        å ´æ™¯è¨­è¨ˆ + æœè£è¨­è¨ˆ + é“å…·è¨­è¨ˆ + è‰²å½©ç³»çµ±
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function runDesignAgent(){
    const ui = document.getElementById('designAgentUI');
    
    ui.innerHTML = `
        <div style="background:var(--surface2);border-radius:8px;padding:20px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <div class="loading-spinner"></div>
                <div>
                    <div style="font-weight:600" id="designStatusText">ğŸ¨ ç¾è¡“ç¸½ç›£ å•Ÿå‹•ä¸­...</div>
                    <div style="font-size:12px;color:var(--dim)" id="designSubStatus">æº–å‚™è¨­è¨ˆ...</div>
                </div>
            </div>
            <div style="background:var(--bg);border-radius:4px;height:4px;overflow:hidden">
                <div id="designProgressBar" style="background:var(--primary);height:100%;width:0%;transition:width .5s"></div>
            </div>
            <div id="designSteps" style="margin-top:16px;font-size:12px;color:var(--dim)"></div>
        </div>
    `;
    
    const progressBar = document.getElementById('designProgressBar');
    const statusText = document.getElementById('designStatusText');
    const stepsEl = document.getElementById('designSteps');
    
    const addStep = (icon, text) => {
        stepsEl.insertAdjacentHTML('beforeend', `<div style="padding:4px 0">${icon} ${text}</div>`);
    };
    
    try {
        addStep('ğŸ”—', 'æ­£åœ¨å–šé†’æ™ºèƒ½é«”...');
        const apiOk = await checkApiHealth();
        progressBar.style.width = '10%';
        if (!apiOk) throw new Error('FizzDragon æ™ºèƒ½é«”é€£æ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        addStep('âœ…', 'æ™ºèƒ½é«”å·²å°±ç·’');
        
        await sleep(200);
        addStep('ğŸ¨', 'ç¾è¡“æ™ºèƒ½é«”æ­£åœ¨è¨­è¨ˆè¦–è¦ºé¢¨æ ¼...');
        progressBar.style.width = '30%';
        
        statusText.textContent = 'ğŸ¨ è¨­è¨ˆå ´æ™¯å’ŒæœåŒ–é“...';
        addStep('ğŸ›ï¸', 'è¨­è¨ˆå ´æ™¯æ°›åœã€è§’è‰²æœè£ã€é—œéµé“å…·...');
        progressBar.style.width = '60%';
        
        startCountdown('design', stepsEl);
        const apiResponse = await callAgent('artdirector', {
            novel: state.novel.text.substring(0, 20000),
            title: state.novel.title,
            analysis: state.aiAnalysis,
            concept: state.concept,
            chapters: state.chapters,
            characters: state.characters,
            interview: state.interview || {}  // å‚³éè¨ªè«‡å‰µæ„æ–¹å‘
        });
        stopCountdown();
        
        progressBar.style.width = '90%';
        
        let result;
        try {
            const resultText = apiResponse.result || apiResponse;
            if(typeof resultText === 'string'){
                result = JSON.parse(resultText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim());
            } else {
                result = resultText;
            }
        } catch(e){ result = apiResponse; }
        
        // è§£æç¾è¡“ç¸½ç›£è¿”å›çš„å¤šç¨®æ ¼å¼
        if(result.scene_design || result.costume_design || result.prop_design){
            // æ–°æ ¼å¼ï¼šåŒ…å«scene_design, costume_design, prop_design
            state.scenes = result.scene_design?.scenes || [result.scene_design] || [];
            state.costumes = result.costume_design?.characters || result.costume_design || [];
            state.props = result.prop_design?.key_items || result.prop_design || [];
            state.visualStyle = result.visual_style || result.lighting_design || {};
            state.designResult = result;  // ä¿å­˜å®Œæ•´çµæœ
        } else if(Array.isArray(result)){
            state.scenes = result;
        } else {
            state.scenes = result.scenes || [result];
            state.designResult = result;
        }
        const sceneCount = state.scenes?.length || 0;
        const costumeCount = state.costumes?.length || 0;
        addStep('âœ…', `å®Œæˆ ${sceneCount} å€‹å ´æ™¯ + ${costumeCount} å€‹è§’è‰²æœè£è¨­è¨ˆ`);
        progressBar.style.width = '100%';
        statusText.textContent = 'âœ… æœåŒ–é“è¨­è¨ˆå®Œæˆï¼';
        
        setTimeout(() => showStep(7), 500);  // ä¿®å¾©ï¼šstep 7æ˜¯æœåŒ–é“
        
    } catch (err) {
        console.error('runDesignAgent error:', err);
        ui.innerHTML = renderErrorRetryUI('ç¾è¡“ç¸½ç›£', 'runDesignAgent()');
    }
}

// ç§»é™¤èˆŠçš„æ‰‹å‹•UIä»£ç¢¼ï¼Œä¿ç•™çµæœé¡¯ç¤ºéƒ¨åˆ†

function renderDesignResult(){
    const result = state.designResult || {};
    const scenes = state.scenes || [];
    const costumes = state.costumes || [];
    const props = state.props || [];
    
    // é©é…å¤šç¨®APIè¿”å›æ ¼å¼
    const visualStyle = state.visualStyle || result.visual_style || result.visual_style_definition || result.visualStyle || {};
    const lighting = result.lighting_design || result.lighting || result.ten_cinematic_lighting_applications || result.lighting_types || [];
    const lightingMatrix = result.lighting_emotion_matrix || result.lighting_emotion_mapping || [];
    const masterStyle = result.master_style_integration || result.master_style_references || {};
    const colorDesign = result.color_emotion_design || result.color_emotion_mapping_design || result.color_palette || {};
    
    // èª¿è©¦ï¼šè¨˜éŒ„å¯¦éš›æ•¸æ“šçµæ§‹
    console.log('[æœåŒ–é“] æ¸²æŸ“çµæœï¼Œæ•¸æ“šçµæ§‹:', Object.keys(result));
    console.log('[æœåŒ–é“] visualStyle:', visualStyle);
    console.log('[æœåŒ–é“] lighting:', lighting);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•å¯é¡¯ç¤ºçš„å…§å®¹ - æ›´å¯¬é¬†çš„æª¢æŸ¥
    const hasVisualStyle = visualStyle && (visualStyle.overall_tone || visualStyle.art_style_reference || visualStyle.description || visualStyle.core_philosophy || Object.keys(visualStyle).length > 0);
    const hasLighting = (Array.isArray(lighting) && lighting.length > 0) || (lighting && typeof lighting === 'object' && Object.keys(lighting).length > 0);
    const hasLightingMatrix = Array.isArray(lightingMatrix) && lightingMatrix.length > 0;
    const hasSceneDesign = result.scene_design || result.scenes || result.key_locations;
    const hasCostumeDesign = result.costume_design || result.costumes || result.character_costumes;
    const hasPropDesign = result.prop_design || result.props || result.key_items;
    const hasMasterStyle = masterStyle && Object.keys(masterStyle).length > 0;
    const hasColorDesign = colorDesign && (colorDesign.overall_palette || colorDesign.emotional_mapping || Object.keys(colorDesign).length > 0);
    
    const hasAnyContent = hasVisualStyle || hasLighting || hasLightingMatrix || hasSceneDesign || hasCostumeDesign || hasPropDesign || hasMasterStyle || hasColorDesign;
    
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ¨</span> æœåŒ–é“ + å ´æ™¯è¨­è¨ˆå®Œæˆ</h3>
            
            ${!hasAnyContent ? `
            <!-- åŸå§‹æ•¸æ“šå±•ç¤ºï¼ˆç•¶çµæ§‹ä¸åŒ¹é…æ™‚ï¼‰ -->
            <div class="report" style="margin-bottom:16px">
                <h4>ğŸ“‹ è¨­è¨ˆçµæœï¼ˆåŸå§‹æ•¸æ“šï¼‰</h4>
                <div style="background:var(--bg);padding:12px;border-radius:8px;max-height:400px;overflow-y:auto">
                    <pre style="white-space:pre-wrap;word-break:break-word;font-size:11px;color:var(--text-secondary)">${JSON.stringify(result, null, 2)}</pre>
                </div>
                <div style="font-size:11px;color:var(--dim);margin-top:8px">
                    âš ï¸ æ•¸æ“šçµæ§‹ä¸åŒ¹é…é æœŸæ ¼å¼ï¼Œé¡¯ç¤ºåŸå§‹JSON
                </div>
            </div>
            ` : ''}
            
            ${hasVisualStyle ? `
            <div class="report">
                <h4>ğŸ¨ è¦–è¦ºé¢¨æ ¼</h4>
                <div class="item-card">
                    ${visualStyle.overall_tone ? `<p><strong>æ•´é«”åŸºèª¿ï¼š</strong>${visualStyle.overall_tone}</p>` : ''}
                    ${visualStyle.core_philosophy ? `<p><strong>æ ¸å¿ƒç†å¿µï¼š</strong>${visualStyle.core_philosophy}</p>` : ''}
                    ${visualStyle.art_style_reference ? `<p><strong>é¢¨æ ¼åƒè€ƒï¼š</strong>${visualStyle.art_style_reference}</p>` : ''}
                    ${visualStyle.description ? `<p><strong>æè¿°ï¼š</strong>${visualStyle.description}</p>` : ''}
                    ${visualStyle.key_visual_elements ? `<p><strong>è¦–è¦ºå…ƒç´ ï¼š</strong>${Array.isArray(visualStyle.key_visual_elements) ? visualStyle.key_visual_elements.join('ã€') : visualStyle.key_visual_elements}</p>` : ''}
                </div>
            </div>
            ` : ''}
            
            ${hasLighting ? `
            <div class="report">
                <h4>ğŸ’¡ é›»å½±å…‰å½±è¨­è¨ˆ</h4>
                ${Array.isArray(lighting) ? `
                    <div style="display:grid;gap:8px">
                        ${lighting.slice(0, 6).map(light => `
                            <div class="item-card">
                                <h5 style="color:var(--primary)">${light.type || light.name || 'å…‰æ•ˆ'}</h5>
                                <p style="font-size:12px">${light.application || light.description || ''}</p>
                                ${light.emotion ? `<p style="font-size:11px;color:var(--dim)">ğŸ­ æƒ…ç·’ï¼š${light.emotion}</p>` : ''}
                                ${light.color_temp || light.color_temperature ? `<p style="font-size:11px;color:var(--dim)">ğŸŒ¡ï¸ è‰²æº«ï¼š${light.color_temp || light.color_temperature}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    ${lighting.length > 6 ? `<div style="font-size:11px;color:var(--dim);margin-top:8px">... é‚„æœ‰ ${lighting.length - 6} ç¨®å…‰æ•ˆ</div>` : ''}
                ` : `
                    <div class="item-card">
                        ${lighting.primary_lighting_type ? `<p><strong>ä¸»å…‰é¡å‹ï¼š</strong>${lighting.primary_lighting_type}</p>` : ''}
                        ${lighting.lighting_description ? `<p style="font-size:12px;color:var(--dim)">${lighting.lighting_description}</p>` : ''}
                    </div>
                `}
            </div>
            ` : ''}
            
            ${hasLightingMatrix ? `
            <div class="report">
                <h4>ğŸ­ å…‰å½±æƒ…ç·’çŸ©é™£</h4>
                <div style="display:grid;gap:6px">
                    ${lightingMatrix.slice(0, 5).map(item => `
                        <div style="background:var(--bg);padding:10px;border-radius:6px;border-left:3px solid var(--primary)">
                            <strong>${item.emotion || item.mood || 'æƒ…ç·’'}</strong>
                            <span style="color:var(--dim);font-size:11px;margin-left:8px">${item.lighting || item.light_type || ''}</span>
                            ${item.description ? `<p style="font-size:11px;color:var(--text-secondary);margin-top:4px">${item.description}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            ${result.scene_design ? `
            <div class="report">
                <h4>ğŸ›ï¸ å ´æ™¯è¨­è¨ˆ</h4>
                ${typeof result.scene_design === 'object' ? `
                    <div class="item-card">
                        ${result.scene_design.architecture ? `<p><strong>å»ºç¯‰ï¼š</strong>${result.scene_design.architecture}</p>` : ''}
                        ${result.scene_design.street_layout ? `<p><strong>è¡—é“ï¼š</strong>${result.scene_design.street_layout}</p>` : ''}
                        ${result.scene_design.key_locations ? `<p><strong>é—œéµåœ°é»ï¼š</strong>${JSON.stringify(result.scene_design.key_locations).substring(0,200)}...</p>` : ''}
                    </div>
                ` : `<div class="item-card"><p>${JSON.stringify(result.scene_design).substring(0,500)}</p></div>`}
            </div>
            ` : ''}
            
            ${result.costume_design ? `
            <div class="report">
                <h4>ğŸ‘” æœè£è¨­è¨ˆ</h4>
                ${Array.isArray(result.costume_design.characters) ? 
                    result.costume_design.characters.map(c => `
                        <div class="item-card">
                            <h5>${c.role || c.character || 'è§’è‰²'}</h5>
                            <p><strong>æœé£¾ï¼š</strong>${c.garments || c.description || ''}</p>
                            ${c.fabrics_patterns ? `<p><strong>é¢æ–™ç´‹æ¨£ï¼š</strong>${c.fabrics_patterns}</p>` : ''}
                            ${c.accessories ? `<p><strong>é…é£¾ï¼š</strong>${c.accessories}</p>` : ''}
                        </div>
                    `).join('') : 
                    `<div class="item-card"><p>${JSON.stringify(result.costume_design).substring(0,500)}</p></div>`
                }
            </div>
            ` : ''}
            
            ${result.prop_design ? `
            <div class="report">
                <h4>ğŸº é“å…·è¨­è¨ˆ</h4>
                ${Array.isArray(result.prop_design.key_items) ? 
                    result.prop_design.key_items.map(p => `
                        <div class="item-card">
                            <h5>${p.category || p.name || 'é“å…·'}</h5>
                            <p><strong>ç‰©å“ï¼š</strong>${Array.isArray(p.items) ? p.items.join('ã€') : p.items || ''}</p>
                            ${p.details ? `<p style="font-size:12px;color:var(--dim)">${p.details}</p>` : ''}
                        </div>
                    `).join('') : 
                    `<div class="item-card"><p>${JSON.stringify(result.prop_design).substring(0,500)}</p></div>`
                }
            </div>
            ` : ''}
            
            ${hasMasterStyle ? `
            <div class="report">
                <h4>ğŸ¬ å¤§å¸«é¢¨æ ¼èåˆ</h4>
                <div style="display:grid;gap:8px">
                    ${Object.entries(masterStyle).map(([k,v]) => `
                        <div class="item-card">
                            <h5 style="color:var(--primary)">${k.replace(/_/g, ' ')}</h5>
                            <p style="font-size:12px">${typeof v === 'string' ? v : JSON.stringify(v)}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            ${hasColorDesign ? `
            <div class="report">
                <h4>ğŸŒˆ è‰²å½©æƒ…ç·’è¨­è¨ˆ</h4>
                <div class="item-card">
                    ${colorDesign.overall_palette ? `<p><strong>æ•´é«”èª¿è‰²ï¼š</strong>${colorDesign.overall_palette}</p>` : ''}
                    ${colorDesign.contrast_design ? `<p><strong>å°æ¯”è¨­è¨ˆï¼š</strong>${colorDesign.contrast_design}</p>` : ''}
                </div>
                ${colorDesign.emotional_mapping && Array.isArray(colorDesign.emotional_mapping) ? `
                    <div style="margin-top:10px;display:grid;gap:6px">
                        ${colorDesign.emotional_mapping.map(em => `
                            <div style="background:var(--bg);padding:10px;border-radius:6px;display:flex;align-items:center;gap:10px">
                                <span style="font-size:20px">${em.dominant_color || 'ğŸ¨'}</span>
                                <div>
                                    <strong>${em.phase || em.emotion || 'éšæ®µ'}</strong>
                                    <p style="font-size:11px;color:var(--dim);margin:0">${em.emotion || em.mood || ''} ${em.source ? '- ' + em.source : ''}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
            ` : ''}
            
            ${Array.isArray(result.ten_cinematic_lighting_applications) ? `
            <div class="report">
                <h4>ğŸ’¡ é›»å½±å…‰å½±æ‡‰ç”¨</h4>
                <div style="display:grid;gap:8px">
                    ${result.ten_cinematic_lighting_applications.slice(0, 5).map(light => `
                        <div class="item-card">
                            <h5>${light.type || light.name || 'å…‰æ•ˆ'}</h5>
                            <p style="font-size:12px">${light.application || light.description || ''}</p>
                            ${light.emotion ? `<p style="font-size:11px;color:var(--primary)">æƒ…ç·’ï¼š${light.emotion}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <div class="btn-group">
                <button class="btn btn-back" onclick="prevStep()">â† è¿”å›</button>
                <button class="btn" onclick="state.designResult=null;state.scenes=[];state.costumes=[];state.props=[];showStep(7)">ğŸ”„ é‡æ–°è¨­è¨ˆ</button>
                <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ â†’</button>
            </div>
        </div>
    `;
}

function generateDesignPrompt(){
    const concept = state.concept || {};
    const chars = state.characters || {};
    const chapters = state.chapters || [];
    
    const charNames = [...(chars.main||[]), ...(chars.supporting||[])].map(c=>c.name).join('ã€');
    const places = state.aiAnalysis?.places?.map(p=>p.name).join('ã€') || '';
    
    return `ä½ æ˜¯ç¾è¡“æŒ‡å°ï¼Œè«‹è¨­è¨ˆæœåŒ–é“å’Œå ´æ™¯ã€‚

ã€ä½œå“ã€‘${state.novel?.title || ''}
ã€é¡å‹ã€‘${concept.genre || ''}
ã€æ™‚ä»£ã€‘${concept.era || ''}
ã€è§’è‰²ã€‘${charNames}
ã€å ´æ™¯ã€‘${places}

è«‹è¿”å›JSONï¼š
{
  "visualStyle": {
    "tone": "æ•´é«”è¦–è¦ºåŸºèª¿",
    "colorPalette": "ä¸»è‰²èª¿æ–¹æ¡ˆ",
    "reference": "åƒè€ƒä½œå“"
  },
  "scenes": [
    {
      "name": "å ´æ™¯å",
      "icon": "emoji",
      "brief": "ä¸€å¥è©±æè¿°",
      "structure": "ç©ºé–“çµæ§‹",
      "lighting": "å…‰ç·šè¨­è¨ˆ",
      "atmosphere": "æ°›åœè‰²èª¿",
      "props": ["é“å…·1", "é“å…·2"]
    }
  ],
  "costumes": [
    {
      "character": "è§’è‰²å",
      "description": "æœè£æè¿°",
      "colorScheme": "é…è‰²",
      "accessories": "é…é£¾"
    }
  ],
  "keyProps": [
    {
      "name": "é“å…·å",
      "description": "å¤–è§€+åŠŸèƒ½æè¿°",
      "significance": "æ•˜äº‹æ„ç¾©"
    }
  ]
}`;
}

function applyDesignResult(){
    const input = document.getElementById('designResult').value.trim();
    if(!input){ alert('è«‹å…ˆè²¼å…¥çµæœ'); return; }
    
    try {
        const json = input.replace(/```json\s*/g,'').replace(/```\s*/g,'');
        const result = JSON.parse(json);
        
        state.scenes = result.scenes || [];
        state.costumes = result.costumes || [];
        state.props = result.keyProps || [];
        state.visualStyle = result.visualStyle || {};
        
        showStep(7);
    } catch(e) {
        alert('JSONæ ¼å¼éŒ¯èª¤ï¼š' + e.message);
    }
}

// ==================== Step 7: ç« ç¯€åŠ‡æœ¬ ====================
const SCRIPT_SKILLS = [
    { id: 'mckee_story', name: 'McKeeåŠ‡æœ¬æ³•', desc: 'å°ˆæ¥­åŠ‡æœ¬æ ¼å¼' },
    { id: 'dialogue_craft', name: 'å°è©±è¨­è¨ˆ', desc: 'æ½›å°è©/ç¯€å¥' },
    { id: 'scene_writing', name: 'å ´æ™¯å¯«ä½œ', desc: 'å‹•ä½œè¡Œ/æ°›åœ' }
];

function renderStep6(){
    if(state.scripts?.length > 0){
        return renderScriptsResult();
    }
    
    return `
        <div class="content-card">
            <h3><span class="icon">âœï¸</span> ç·¨åŠ‡æ™ºèƒ½é«”</h3>
            
            <div style="margin-bottom:16px">
                <label style="font-size:12px;color:var(--dim)">é¸æ“‡ç« ç¯€ç”ŸæˆåŠ‡æœ¬ï¼š</label>
                <select id="scriptChapterSelect" class="form-input" style="margin-top:4px">
                    ${(state.chapters||[]).map((ch,i) => `<option value="${i}">ç¬¬${i+1}ç« ï¼š${ch.title}</option>`).join('')}
                </select>
            </div>
            
            <div id="scriptAgentUI">
                <div style="text-align:center;padding:20px">
                    <button class="btn btn-primary" onclick="runScriptAgent()" style="padding:16px 40px;font-size:16px">
                        ğŸš€ é–‹å§‹AIåŠ‡æœ¬ç”Ÿæˆ
                    </button>
                </div>
            </div>
        </div>
    `;
}

async function runScriptAgent(){
    const ui = document.getElementById('scriptAgentUI');
    const chapterIndex = parseInt(document.getElementById('scriptChapterSelect')?.value || 0);
    const chapter = state.chapters[chapterIndex];
    
    ui.innerHTML = `
        <div style="background:var(--surface2);border-radius:8px;padding:20px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <div class="loading-spinner"></div>
                <div>
                    <div style="font-weight:600" id="scriptStatusText">âœï¸ ç·¨åŠ‡æ™ºèƒ½é«” å•Ÿå‹•ä¸­...</div>
                    <div style="font-size:12px;color:var(--dim)" id="scriptSubStatus">ç¬¬${chapterIndex+1}ç« ï¼š${chapter?.title}</div>
                </div>
            </div>
            <div style="background:var(--bg);border-radius:4px;height:4px;overflow:hidden">
                <div id="scriptProgressBar" style="background:var(--primary);height:100%;width:0%;transition:width .5s"></div>
            </div>
            <div id="scriptSteps" style="margin-top:16px;font-size:12px;color:var(--dim)"></div>
        </div>
    `;
    
    const progressBar = document.getElementById('scriptProgressBar');
    const statusText = document.getElementById('scriptStatusText');
    const stepsEl = document.getElementById('scriptSteps');
    
    const addStep = (icon, text) => {
        stepsEl.insertAdjacentHTML('beforeend', `<div style="padding:4px 0">${icon} ${text}</div>`);
    };
    
    try {
        addStep('ğŸ”—', 'æ­£åœ¨å–šé†’æ™ºèƒ½é«”...');
        const apiOk = await checkApiHealth();
        progressBar.style.width = '10%';
        if (!apiOk) throw new Error('FizzDragon æ™ºèƒ½é«”é€£æ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        addStep('âœ…', 'æ™ºèƒ½é«”å·²å°±ç·’');
        
        addStep('âœï¸', 'ç·¨åŠ‡æ™ºèƒ½é«”æ­£åœ¨æ”¹ç·¨åŠ‡æœ¬...');
        await sleep(200);
        progressBar.style.width = '40%';
        
        statusText.textContent = 'âœï¸ ç”ŸæˆåŠ‡æœ¬...';
        addStep('ğŸ“', `æ­£åœ¨å°‡ã€Œ${chapter?.title}ã€æ”¹ç·¨ç‚ºåŠ‡æœ¬æ ¼å¼...`);
        
        startCountdown('script', stepsEl);
        const apiResponse = await callAgent('script', {
            chapter: chapter,
            chapterIndex: chapterIndex,
            novel: state.novel.title,
            concept: state.concept,
            characters: state.characters,
            interview: state.interview || {}  // å‚³éè¨ªè«‡å‰µæ„æ–¹å‘
        });
        stopCountdown();
        
        progressBar.style.width = '90%';
        
        let result;
        const rawResultText = apiResponse.result || apiResponse;
        try {
            const resultText = typeof rawResultText === 'string' ? rawResultText : JSON.stringify(rawResultText);
            if(typeof rawResultText === 'string'){
                result = JSON.parse(resultText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim());
            } else {
                result = rawResultText;
            }
        } catch(e){ 
            // JSONè§£æå¤±æ•—ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ–‡æœ¬ä½œç‚ºåŠ‡æœ¬
            result = { chapter: chapterIndex+1, scenes: [], rawText: rawResultText };
        }
        
        // ä¿å­˜åŸå§‹æ–‡æœ¬ä»¥ä¾¿é¡¯ç¤º
        result.rawText = typeof rawResultText === 'string' ? rawResultText : JSON.stringify(rawResultText, null, 2);
        result.chapter = chapterIndex + 1;
        
        if(!state.scripts) state.scripts = [];
        state.scripts[chapterIndex] = result;
        
        addStep('âœ…', 'åŠ‡æœ¬ç”Ÿæˆå®Œæˆ');
        progressBar.style.width = '100%';
        statusText.textContent = 'âœ… åŠ‡æœ¬å®Œæˆï¼';
        
        setTimeout(() => showStep(8), 500);
        
    } catch (err) {
        ui.innerHTML = renderErrorRetryUI('ç·¨åŠ‡æ™ºèƒ½é«”', 'runScriptAgent()');
    }
}

function renderScriptsResult(){
    const scripts = state.scripts || [];
    return `
        <div class="content-card">
            <h3><span class="icon">âœï¸</span> ç« ç¯€åŠ‡æœ¬</h3>
            
            <div class="tabs">
                ${scripts.map((s,i) => `<div class="tab ${i===0?'active':''}" onclick="showScriptTab(${i})">ç¬¬${s.chapter}ç« </div>`).join('')}
            </div>
            
            <div id="scriptDisplay">
                ${scripts[0] ? renderScriptDetail(scripts[0]) : '<p>æš«ç„¡åŠ‡æœ¬</p>'}
            </div>
            
            <div class="btn-group">
                <button class="btn btn-back" onclick="prevStep()">â† è¿”å›</button>
                <button class="btn" onclick="state.scripts=[];showStep(8)">+ ç¹¼çºŒç”Ÿæˆå…¶ä»–ç« ç¯€</button>
                <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ â†’</button>
            </div>
        </div>
    `;
}

function renderScriptDetail(script){
    // å¦‚æœæœ‰åŸå§‹æ–‡æœ¬ï¼Œå„ªå…ˆé¡¯ç¤º
    if(script.rawText || script.text || script.content){
        const text = script.rawText || script.text || script.content;
        return `
            <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;max-height:500px;overflow-y:auto">
                <div style="background:var(--primary);padding:10px 16px;color:#fff;position:sticky;top:0;z-index:1;display:flex;justify-content:space-between">
                    <span>ğŸ“œ ç¬¬${script.chapter}ç«  åŠ‡æœ¬</span>
                    <button onclick="copyScriptToClipboard(${script.chapter-1})" style="background:rgba(255,255,255,.2);border:none;color:#fff;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px">ğŸ“‹ è¤‡è£½</button>
                </div>
                <div style="padding:20px;font-size:13px;line-height:2;white-space:pre-wrap;font-family:monospace">${escapeHtml(text)}</div>
            </div>
        `;
    }
    
    // çµæ§‹åŒ–é¡¯ç¤º
    return `
        <div class="report">
            ${(script.scenes||[]).map(sc => `
                <div class="item-card" style="margin-bottom:16px">
                    <div style="background:var(--surface2);padding:12px;margin:-16px -16px 16px;border-bottom:1px solid var(--border)">
                        <strong style="color:var(--primary)">${sc.heading || sc.location || ''}</strong>
                    </div>
                    <div style="color:var(--dim);margin-bottom:12px;font-size:13px">${sc.action || ''}</div>
                    ${(sc.beats||[]).map(b => {
                        if(b.type === 'dialogue') return `<div style="text-align:center;margin:16px 0"><div style="font-weight:bold">${b.character}</div><div style="color:var(--primary)">${b.line}</div></div>`;
                        return `<p style="color:var(--dim)">${b.content||''}</p>`;
                    }).join('')}
                </div>
            `).join('')}
        </div>
    `;
}

// è¤‡è£½åŠ‡æœ¬
function copyScriptToClipboard(index){
    const script = state.scripts?.[index];
    const text = script?.rawText || script?.text || script?.content || JSON.stringify(script, null, 2);
    navigator.clipboard.writeText(text).then(() => alert('âœ… åŠ‡æœ¬å·²è¤‡è£½ï¼'));
}

function showScriptTab(i){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('scriptDisplay').innerHTML = renderScriptDetail(state.scripts[i]);
}

function generateScriptsPrompt(){
    const chIdx = document.getElementById('scriptChapterSelect')?.value || 0;
    const ch = state.chapters?.[chIdx] || {};
    const chars = state.characters || {};
    const concept = state.concept || {};
    
    return `ä½ æ˜¯å°ˆæ¥­ç·¨åŠ‡ï¼Œè«‹å°‡å°èªªç« ç¯€æ”¹ç·¨ç‚ºåŠ‡æœ¬æ ¼å¼ã€‚

ã€ä½œå“ã€‘${state.novel?.title || ''}
ã€é¡å‹ã€‘${concept.genre || ''}
ã€è§’è‰²ã€‘${[...(chars.main||[]),...(chars.supporting||[])].map(c=>c.name).join('ã€')}

ã€ç¬¬${parseInt(chIdx)+1}ç« åŸæ–‡ã€‘
${(ch.content || '').substring(0, 5000)}...

è«‹è¿”å›JSONï¼š
{
  "chapter": ${parseInt(chIdx)+1},
  "title": "${ch.title || ''}",
  "scenes": [
    {
      "heading": "INT./EXT. å ´æ™¯ - æ™‚é–“",
      "action": "å ´æ™¯æè¿°ï¼ˆè¦–è¦ºåŒ–çš„å‹•ä½œæå¯«ï¼‰",
      "beats": [
        {"type": "action", "content": "å‹•ä½œæè¿°"},
        {"type": "dialogue", "character": "è§’è‰²å", "parenthetical": "è¡¨æ¼”æŒ‡ç¤º", "line": "å°è©"},
        {"type": "reaction", "character": "è§’è‰²å", "content": "åæ‡‰æè¿°"}
      ],
      "transition": "è½‰å ´ï¼ˆCUT TO / DISSOLVE TOï¼‰"
    }
  ]
}`;
}

function updateScriptPrompt(){
    document.getElementById('scriptsPrompt').value = generateScriptsPrompt();
}

function applyScriptsResult(){
    const input = document.getElementById('scriptsResult').value.trim();
    if(!input){ alert('è«‹å…ˆè²¼å…¥çµæœ'); return; }
    
    try {
        const json = input.replace(/```json\s*/g,'').replace(/```\s*/g,'');
        const result = JSON.parse(json);
        
        if(!state.scripts) state.scripts = [];
        state.scripts.push(result);
        
        showStep(8);
    } catch(e) {
        alert('JSONæ ¼å¼éŒ¯èª¤ï¼š' + e.message);
    }
}

// ==================== Step 8: åˆ†é¡è¨­è¨ˆ ====================
const STORYBOARD_SKILLS = [
    { id: 'cinematography', name: 'é›»å½±æ”å½±è¡“', desc: 'é¡é ­èªè¨€' },
    { id: 'composition', name: 'æ§‹åœ–è¨­è¨ˆ', desc: 'è¦–è¦ºå¼•å°' },
    { id: 'ai_prompt', name: 'AI Promptç”Ÿæˆ', desc: 'MJ/SD/Flux' }
];

function renderStep7(){
    if(state.storyboard?.length > 0){
        return renderStoryboardResult();
    }
    
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ¬</span> åˆ†é¡å¸«</h3>
            
            <div id="storyboardAgentUI">
                <div style="text-align:center;padding:20px">
                    <button class="btn btn-primary" onclick="runStoryboardAgent()" style="padding:16px 40px;font-size:16px">
                        ğŸš€ é–‹å§‹AIåˆ†é¡è¨­è¨ˆ
                    </button>
                    <div style="font-size:12px;color:var(--dim);margin-top:12px">
                        ç”Ÿæˆåˆ†é¡è¡¨ + AIç¹ªåœ–Prompt (MJ/SD/Flux)
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function runStoryboardAgent(){
    const ui = document.getElementById('storyboardAgentUI');
    
    // ç²å–ç”¨æˆ¶é…ç½®çš„é›†æ•¸å’Œæ™‚é•·
    const episodes = chapterConfig.episodes || state.seriesConfig?.episodes || 10;
    const durationPerEp = chapterConfig.durationPerEpisode || state.seriesConfig?.duration || 5;
    const shotsPerMinute = 10; // æ¯åˆ†é˜10å€‹é¡é ­
    const shotsPerEpisode = durationPerEp * shotsPerMinute;
    const totalShots = episodes * shotsPerEpisode;
    const batchSize = 1; // æ¯æ‰¹è™•ç†1é›†ï¼ˆç¢ºä¿æ¯é›†éƒ½æœ‰è¶³å¤ é¡é ­ï¼‰
    const totalBatches = Math.ceil(episodes / batchSize);
    
    ui.innerHTML = `
        <div style="background:var(--surface2);border-radius:8px;padding:20px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <div class="loading-spinner"></div>
                <div>
                    <div style="font-weight:600" id="sbStatusText">ğŸ¬ åˆ†é¡å¸« å•Ÿå‹•ä¸­...</div>
                    <div style="font-size:12px;color:var(--dim)" id="sbSubStatus">æº–å‚™è¨­è¨ˆ ${episodes}é›† Ã— ${shotsPerEpisode}é¡é ­ = ${totalShots}é¡é ­</div>
                </div>
            </div>
            <div style="background:var(--bg);border-radius:4px;height:8px;overflow:hidden">
                <div id="sbProgressBar" style="background:var(--primary);height:100%;width:0%;transition:width .3s"></div>
            </div>
            <div id="sbBatchInfo" style="margin-top:8px;font-size:11px;color:var(--primary)"></div>
            <div id="sbSteps" style="margin-top:12px;font-size:12px;color:var(--dim);max-height:200px;overflow-y:auto"></div>
        </div>
    `;
    
    const progressBar = document.getElementById('sbProgressBar');
    const statusText = document.getElementById('sbStatusText');
    const batchInfo = document.getElementById('sbBatchInfo');
    const stepsEl = document.getElementById('sbSteps');
    
    const addStep = (icon, text) => {
        stepsEl.insertAdjacentHTML('beforeend', `<div style="padding:4px 0">${icon} ${text}</div>`);
        stepsEl.scrollTop = stepsEl.scrollHeight;
    };
    
    try {
        addStep('ğŸ”—', 'æ­£åœ¨å–šé†’æ™ºèƒ½é«”...');
        const apiOk = await checkApiHealth();
        if (!apiOk) throw new Error('FizzDragon æ™ºèƒ½é«”é€£æ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        addStep('âœ…', 'æ™ºèƒ½é«”å·²å°±ç·’');
        
        // ç²å–ç•«é¢¨ä¿¡æ¯
        const artStylePrompt = state.artStyle?.prompt || 'anime style, high quality';
        addStep('ğŸ¨', 'æ‡‰ç”¨ç•«é¢¨ï¼š' + (state.artStyle?.name || 'é»˜èªå‹•ç•«'));
        addStep('ğŸ“‹', `é–‹å§‹æ‰¹é‡ç”Ÿæˆï¼š${totalBatches} æ‰¹æ¬¡ï¼Œæ¯æ‰¹ ${batchSize} é›†`);
        
        // æº–å‚™ç« ç¯€æ•¸æ“š
        const chapters = state.chapters || [];
        
        // æ‰¹é‡ç”Ÿæˆåˆ†é¡
        const allShots = [];
        let completedEpisodes = 0;
        
        for (let batch = 0; batch < totalBatches; batch++) {
            const startEp = batch * batchSize + 1;
            const endEp = Math.min((batch + 1) * batchSize, episodes);
            const batchEpisodes = endEp - startEp + 1;
            
            // æ›´æ–°é€²åº¦
            const progress = Math.round((batch / totalBatches) * 80) + 10;
            progressBar.style.width = progress + '%';
            statusText.textContent = `ğŸ¬ ç”Ÿæˆç¬¬ ${startEp}-${endEp} é›†åˆ†é¡...`;
            batchInfo.textContent = `æ‰¹æ¬¡ ${batch + 1}/${totalBatches} | å·²å®Œæˆ ${allShots.length} é¡é ­`;
            
            // ç²å–é€™æ‰¹é›†æ•¸çš„ç« ç¯€ä¿¡æ¯
            const batchChapters = chapters.slice(startEp - 1, endEp);
            const batchContent = batchChapters.map((ch, i) => {
                const epNum = startEp + i;
                return `ã€ç¬¬${epNum}é›†ã€‘${ch.title || ''}\n${ch.summary || ch.content || ''}`;
            }).join('\n\n');
            
            addStep('â³', `ç”Ÿæˆç¬¬ ${startEp}-${endEp} é›† (${batchEpisodes * shotsPerEpisode} é¡é ­)...`);
            
            try {
                const apiResponse = await callAgent('storyboard', {
                    content: `è«‹ç‚ºä»¥ä¸‹${batchEpisodes}é›†å…§å®¹ç”Ÿæˆåˆ†é¡è¡¨ï¼Œæ¯é›†${durationPerEp}åˆ†é˜ï¼Œæ¯åˆ†é˜${shotsPerMinute}é¡é ­ï¼Œå…±${batchEpisodes * shotsPerEpisode}å€‹é¡é ­ã€‚\n\n${batchContent || state.scripts || state.novel}`,
                    context: {
                        startEpisode: startEp,
                        endEpisode: endEp,
                        shotsPerEpisode: shotsPerEpisode,
                        totalShots: batchEpisodes * shotsPerEpisode,
                        concept: state.concept,
                        characters: state.characters,
                        artStyle: artStylePrompt
                    }
                });
                
                // è§£æçµæœ
                let batchResult = [];
                try {
                    const resultText = apiResponse.result || apiResponse;
                    if(typeof resultText === 'string'){
                        batchResult = JSON.parse(resultText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim());
                    } else {
                        batchResult = resultText;
                    }
                    if(!Array.isArray(batchResult)) {
                        batchResult = batchResult.shots || batchResult.storyboard || [];
                    }
                } catch(e){ 
                    console.warn('è§£ææ‰¹æ¬¡çµæœå¤±æ•—:', e);
                    batchResult = []; 
                }
                
                // æ·»åŠ é›†æ•¸å‰ç¶´åˆ°shot_id
                batchResult = batchResult.map((shot, idx) => ({
                    ...shot,
                    shot_id: shot.shot_id || `E${String(startEp).padStart(3,'0')}_S${String(idx+1).padStart(3,'0')}`
                }));
                
                allShots.push(...batchResult);
                completedEpisodes = endEp;
                addStep('âœ…', `ç¬¬ ${startEp}-${endEp} é›†å®Œæˆï¼Œç²å¾— ${batchResult.length} é¡é ­`);
                
            } catch (batchErr) {
                addStep('âš ï¸', `ç¬¬ ${startEp}-${endEp} é›†ç”Ÿæˆå¤±æ•—: ${batchErr.message}`);
                console.error('æ‰¹æ¬¡ç”Ÿæˆå¤±æ•—:', batchErr);
            }
            
            // çŸ­æš«å»¶é²é¿å…APIéè¼‰
            if (batch < totalBatches - 1) {
                await sleep(500);
            }
        }
        
        // å®Œæˆ
        progressBar.style.width = '100%';
        state.storyboard = allShots;
        
        const actualMinutes = Math.round(allShots.length / shotsPerMinute);
        statusText.textContent = 'âœ… åˆ†é¡è¨­è¨ˆå®Œæˆï¼';
        batchInfo.textContent = `ç¸½è¨ˆ ${allShots.length} é¡é ­ | é è¨ˆ ${actualMinutes} åˆ†é˜`;
        addStep('ğŸ‰', `æ‰¹é‡ç”Ÿæˆå®Œæˆï¼å…± ${allShots.length} å€‹å°ˆæ¥­åˆ†é¡`);
        
        if (allShots.length < totalShots * 0.5) {
            addStep('âš ï¸', `æ³¨æ„ï¼šå¯¦éš›ç”Ÿæˆ ${allShots.length} é¡é ­ï¼Œå°‘æ–¼é æœŸ ${totalShots} é¡é ­`);
        }
        
        setTimeout(() => showStep(9), 1000);
        
    } catch (err) {
        console.error('åˆ†é¡ç”Ÿæˆå¤±æ•—:', err);
        ui.innerHTML = renderErrorRetryUI('åˆ†é¡å¸«', 'runStoryboardAgent()');
    }
}

// èˆŠæ‰‹å‹•UIå·²ç§»é™¤ - å…¨è‡ªå‹•åŒ–

function renderStoryboardResult(){
    const shots = state.storyboard || [];
    const totalDuration = shots.reduce((sum,s)=>sum+(parseFloat(s.duration)||6),0);
    
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ¬</span> åˆ†é¡è¡¨</h3>
            
            <div class="report">
                <div class="report-grid">
                    <div class="stat-box"><div class="stat-val">${shots.length}</div><div class="stat-label">ç¸½é¡é ­</div></div>
                    <div class="stat-box"><div class="stat-val">${Math.round(totalDuration/60)}åˆ†é˜</div><div class="stat-label">é è¨ˆæ™‚é•·</div></div>
                </div>
            </div>
            
            <div class="report">
                ${shots.slice(0,20).map((shot,i) => `
                    <div class="item-card" style="display:grid;grid-template-columns:60px 1fr;gap:12px">
                        <div style="background:var(--primary);color:#fff;padding:8px;text-align:center;font-family:'Orbitron';font-size:12px">
                            #${(shot.id||i+1).toString().padStart(3,'0')}
                        </div>
                        <div>
                            <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
                                <span class="tag">${shot.shotSize||'ä¸­æ™¯'}</span>
                                <span class="tag">${shot.angle||'å¹³è¦–'}</span>
                                <span class="tag">${shot.movement||'å›ºå®š'}</span>
                                <span class="tag">${shot.duration||6}ç§’</span>
                            </div>
                            <p style="margin-bottom:8px">${shot.description||''}</p>
                            ${shot.aiPrompt ? `
                            <div style="background:var(--bg);padding:8px;font-size:11px;font-family:monospace;color:var(--dim);border-left:2px solid var(--primary)">
                                ğŸ–¼ï¸ ${shot.aiPrompt.substring(0,150)}...
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
                ${shots.length > 20 ? `<p style="color:var(--dim);text-align:center">...é‚„æœ‰ ${shots.length-20} å€‹é¡é ­</p>` : ''}
            </div>
            
            <div class="btn-group">
                <button class="btn btn-back" onclick="prevStep()">â† è¿”å›</button>
                <button class="btn" onclick="state.storyboard=[];showStep(9)">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                <button class="btn btn-primary" onclick="nextStep()">å®Œæˆ â†’</button>
            </div>
        </div>
    `;
}

function generateStoryboardPrompt(){
    const scripts = state.scripts || [];
    const chars = state.characters || {};
    const style = state.visualStyle || {};
    
    const scriptSample = scripts[0]?.scenes?.slice(0,2).map(s => s.heading + ': ' + s.action).join('\n') || '';
    
    return `ä½ æ˜¯åˆ†é¡å¸«+AIç¹ªåœ–å°ˆå®¶ï¼Œè«‹ç‚ºåŠ‡æœ¬ç”Ÿæˆåˆ†é¡è¡¨ã€‚

ã€è¦–è¦ºé¢¨æ ¼ã€‘${style.tone || ''}
ã€è§’è‰²ã€‘${[...(chars.main||[]),...(chars.supporting||[])].map(c=>c.name).join('ã€')}

ã€åŠ‡æœ¬ç‰‡æ®µã€‘
${scriptSample || state.chapters?.[0]?.content?.substring(0,2000) || ''}

è«‹ç‚ºå‰10å€‹é¡é ­è¿”å›JSONï¼š
{
  "shots": [
    {
      "id": 1,
      "scene": "å ´æ™¯å",
      "shotSize": "é æ™¯/å…¨æ™¯/ä¸­æ™¯/è¿‘æ™¯/ç‰¹å¯«",
      "angle": "å¹³è¦–/ä¿¯æ‹/ä»°æ‹/å‚¾æ–œ",
      "movement": "å›ºå®š/æ¨/æ‹‰/æ–/ç§»/è·Ÿ",
      "duration": 6,
      "description": "é¡é ­å…§å®¹æè¿°",
      "subject": "ä¸»é«”ï¼ˆäººç‰©/ç‰©é«”/ç’°å¢ƒï¼‰",
      "emotion": "æƒ…ç·’æ°›åœ",
      "aiPrompt": "Midjourney/SD Promptï¼ˆè‹±æ–‡ï¼ŒåŒ…å«é¢¨æ ¼ã€å…‰ç·šã€æ§‹åœ–ï¼‰"
    }
  ]
}

aiPromptæ ¼å¼ï¼š[ä¸»é«”æè¿°], [å‹•ä½œ/ç‹€æ…‹], [ç’°å¢ƒ], [å…‰ç·š], [é¢¨æ ¼], [é¡é ­]
ç¤ºä¾‹ï¼šyoung boy thief hiding in shadows, ancient Chinese harbor market, golden hour lighting, cinematic, wide shot --ar 16:9`;
}

function applyStoryboardResult(){
    const input = document.getElementById('storyboardResult').value.trim();
    if(!input){ alert('è«‹å…ˆè²¼å…¥çµæœ'); return; }
    
    try {
        const json = input.replace(/```json\s*/g,'').replace(/```\s*/g,'');
        const result = JSON.parse(json);
        
        state.storyboard = result.shots || result;
        showStep(8);
    } catch(e) {
        alert('JSONæ ¼å¼éŒ¯èª¤ï¼š' + e.message);
    }
}

// ä¿ç•™ç›¸å®¹æ€§
function renderStep7Full(){
    return renderStoryboardResult();
}

function renderShotCard(shot){
    const subjectType = SUBJECT_TYPES[shot.subject.type];
    
    return `
        <div class="item-card" style="border-left:3px solid var(--primary)">
            <h5>
                <span class="shot-id">#${shot.id}</span>
                <span class="shot-type ${shot.shotType}">${shot.shotType === 'narrative' ? 'ğŸ“–æ•˜äº‹' : shot.shotType === 'dramatic' ? 'ğŸ¯æˆ²åŠ‡' : 'ğŸ¨æƒ…æ„Ÿ'}</span>
                <span style="color:var(--dim);font-weight:normal;margin-left:auto">${shot.duration}</span>
            </h5>
            
            <!-- 1ï¸âƒ£ åˆ†é¡å¸«ï¼šæƒ…ç¯€ -->
            <div class="agent-output" style="background:rgba(255,107,53,.1);border:1px solid rgba(255,107,53,.3);border-radius:8px;padding:12px;margin:8px 0">
                <div style="font-size:10px;color:var(--primary);font-weight:600;margin-bottom:8px">1ï¸âƒ£ åˆ†é¡å¸« | æƒ…ç¯€</div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:12px">
                    <span><strong>é¡å‹ï¼š</strong>${shot.shotType === 'narrative' ? 'ğŸ“–æ•˜äº‹' : shot.shotType === 'dramatic' ? 'ğŸ¯æˆ²åŠ‡' : 'ğŸ¨æƒ…æ„Ÿ'}</span>
                    <span><strong>æ™‚é•·ï¼š</strong>${shot.duration}</span>
                    <span><strong>æ©Ÿä½ï¼š</strong>${shot.camera.angle}</span>
                </div>
                <div style="font-size:12px;margin-top:8px;color:var(--dim)">
                    <strong>æ•˜äº‹åŠŸèƒ½ï¼š</strong>${shot.narrativeFunction || 'æ¨é€²æƒ…ç¯€ï¼Œå»ºç«‹å ´æ™¯'}
                </div>
                ${shot.storyboardNote ? `
                <div style="font-size:11px;margin-top:8px;padding:8px;background:var(--bg);border-radius:6px;color:var(--dim);border-left:2px solid var(--warning)">
                    ${shot.storyboardNote}
                </div>
                ` : ''}
            </div>
            
            <!-- ğŸ¥ é‹é¡å¸«ï¼šæ”å½± -->
            <div class="agent-output" style="background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:8px;padding:12px;margin:8px 0">
                <div style="font-size:10px;color:var(--text);font-weight:600;margin-bottom:8px">ğŸ¥ é‹é¡å¸« | æ”å½±</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;margin-bottom:8px">
                    <span><strong>æ™¯åˆ¥ï¼š</strong>${shot.camera.frameSize || 'MS'}</span>
                    <span><strong>é¡é ­ï¼š</strong>${shot.camera.lens || '50mm'}</span>
                </div>
                <div style="font-size:12px;margin-bottom:8px">
                    <strong>é‹é¡ï¼š</strong>${shot.camera.movement || 'å›ºå®š'}
                </div>
                <div style="font-size:11px;padding:8px;background:var(--bg);border-radius:6px;color:var(--dim)">
                    <strong>ğŸ“ æ§‹åœ–ï¼š</strong>${shot.camera.composition || 'ä¸‰åˆ†æ³•ï¼Œä¸»é«”ä½æ–¼å³å´äº¤é»'}
                    ${shot.camera.depthOfField ? `<br><strong>ğŸ” æ™¯æ·±ï¼š</strong>${shot.camera.depthOfField}` : ''}
                    ${shot.camera.equipment ? `<br><strong>ğŸ¬ è¨­å‚™ï¼š</strong>${shot.camera.equipment}` : ''}
                </div>
            </div>
            
            <!-- 2ï¸âƒ£ ä¸»é«”Agentï¼šè§’è‰² -->
            <div class="agent-output" style="background:rgba(128,128,128,.1);border:1px solid rgba(128,128,128,.3);border-radius:8px;padding:12px;margin:8px 0">
                <div style="font-size:10px;color:var(--dim);font-weight:600;margin-bottom:8px">2ï¸âƒ£ ä¸»é«”Agent | è§’è‰²</div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span class="subject-type ${shot.subject.type}">${subjectType.icon} ${subjectType.label}</span>
                    <span style="font-weight:600">${shot.subject.name}</span>
                </div>
                ${shot.subject.type !== 'none' ? `
                    <div style="font-size:12px;color:var(--dim)">
                        <p style="margin-bottom:8px"><strong>å‹•ä½œï¼š</strong>${shot.subject.action}</p>
                        ${shot.subject.expression ? `<p style="margin-bottom:8px"><strong>è¡¨æƒ…ï¼š</strong>${shot.subject.expression}</p>` : ''}
                        ${shot.subject.costume ? `<p style="margin-bottom:8px"><strong>æœè£ï¼š</strong>${shot.subject.costume}</p>` : ''}
                        <p><strong>é‹é¡ï¼š</strong>${shot.camera.movement}</p>
                    </div>
                ` : `<p style="font-size:12px;color:var(--dim)"><strong>å…§å®¹ï¼š</strong>${shot.subject.action || 'ç©ºé¡é ­ï¼Œç’°å¢ƒæå¯«'}</p>`}
                ${shot.subject.dialogue ? `
                    <div style="background:var(--surface);padding:10px;border-radius:6px;margin-top:8px;border-left:3px solid var(--primary)">
                        <div style="font-size:10px;color:var(--dim);margin-bottom:4px">ğŸ’¬ ${shot.subject.name} | ${shot.subject.tone}</div>
                        <div style="font-style:italic">"${shot.subject.dialogue}"</div>
                    </div>
                ` : ''}
            </div>
            
            <!-- 3ï¸âƒ£ å ´æ™¯Agentï¼šç¾è¡“ -->
            <div class="agent-output" style="background:rgba(128,128,128,.1);border:1px solid rgba(128,128,128,.3);border-radius:8px;padding:12px;margin:8px 0">
                <div style="font-size:10px;color:var(--dim);font-weight:600;margin-bottom:8px">3ï¸âƒ£ å ´æ™¯Agent | ç¾è¡“</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;margin-bottom:8px">
                    <span><strong>åœ°é»ï¼š</strong>${shot.scene.location}</span>
                    <span><strong>æ™‚é–“ï¼š</strong>${shot.scene.time}</span>
                </div>
                <div style="font-size:11px;margin-bottom:8px;padding:8px;background:var(--bg);border-radius:6px">
                    <p style="margin:0 0 4px"><strong style="color:var(--dim)">ğŸ¨ è‰²èª¿ï¼š</strong>${shot.scene.colorTone}</p>
                    <p style="margin:0"><strong style="color:var(--dim)">ğŸ’¡ ç‡ˆå…‰ï¼š</strong>${shot.scene.lighting}</p>
                </div>
                <div style="font-size:12px;color:var(--dim);margin-bottom:8px">
                    <strong>æ°›åœï¼š</strong>${shot.scene.atmosphere || 'ç¥ç§˜ç·Šå¼µ'}
                </div>
                <div style="font-size:11px;color:var(--dim);padding:8px;background:var(--surface);border-radius:6px">
                    <strong>ğŸ¬ é“å…·æ¸…å–®ï¼š</strong><br>${shot.scene.props || 'é¦™çˆã€ç‡­å°ã€éŠ€éˆ'}
                </div>
            </div>
            
            <!-- 4ï¸âƒ£ éŸ³æ¨‚Agentï¼šè²éŸ³ -->
            <div class="agent-output" style="background:rgba(255,10,53,.1);border:1px solid rgba(255,10,53,.3);border-radius:8px;padding:12px;margin:8px 0">
                <div style="font-size:10px;color:var(--primary);font-weight:600;margin-bottom:8px">4ï¸âƒ£ éŸ³æ¨‚Agent | è²éŸ³</div>
                <div style="font-size:12px;color:var(--dim)">
                    <p><strong>é…æ¨‚ï¼š</strong>${shot.audio?.music || 'æ‡¸ç–‘æ°›åœï¼Œä½æ²‰å¼¦æ¨‚'}</p>
                    <p><strong>éŸ³æ•ˆï¼š</strong>${shot.audio?.sfx || 'é¦™ç‡­ç‡ƒç‡’è²'}</p>
                    <p><strong>ç’°å¢ƒéŸ³ï¼š</strong>${shot.audio?.ambient || 'é è™•å¸‚é›†å–§å›‚'}</p>
                </div>
            </div>
            
            <!-- ğŸ–¼ï¸ æœ€çµ‚Prompt -->
            <div class="prompt-box">
                <div class="prompt-label">ğŸ–¼ï¸ ç¶œåˆPromptï¼ˆå ´æ™¯+ä¸»é«”ï¼‰</div>
                ${shot.prompt.mj}
            </div>
        </div>
    `;
}

// generateStoryboard removed - now using Claude integration
function generateStoryboard_legacy(){
    const shots = [];
    const shotTypes = ['narrative', 'narrative', 'dramatic', 'narrative', 'emotional'];
    
    // ç”Ÿæˆç¤ºä¾‹åˆ†é¡ï¼ˆå°ˆæ¥­é›»å½±åˆ†é¡æ ¼å¼ï¼‰
    // åƒè€ƒSkills: cinematography_composition, cinematography_shots, directing_blocking
    const sampleShots = [
        {
            scene: {
                location:'èŒ…è‰æ£šå…§', 
                time:'å¤œ', 
                colorTone:'æš–é»ƒç‡­å…‰(CTO+1/2) + ç²‰ç´…å¯¶çŸ³å…‰(å“ç´…æ¿¾è‰²)', 
                lighting:'ä¸»å…‰ï¼šç‡­å…‰å´å…‰45Â° / è¼”å…‰ï¼šå¯¶çŸ³åº•å…‰ / æ°›åœï¼šç…™éœ§æ•£å°„',
                atmosphere:'ç¥ç§˜ç·Šå¼µï¼Œç©ºæ°£ä¸­ç€°æ¼«é¦™æ–™èˆ‡ææ‡¼çš„å‘³é“', 
                props:'éŠ…é¦™çˆ(æŒçºŒå†’ç…™)ã€ç‰›æ²¹è Ÿç‡­Ã—3ã€è‰ç·¨è“†å¢Šã€ç«¹ç°¾é–€ã€éª¨è£½å åœå™¨å…·ã€ä¹¾ç‡¥è‰è—¥æŸã€ç¬¦ç´™(ç‰†ä¸Š)'
            },
            subject: {
                type:'person', 
                name:'å°çŒ´å­', 
                action:'èœ·ç¸®åœ¨æˆ¿æ¢é™°å½±è™•ï¼Œèº«é«”ç·Šè²¼æœ¨æ¨‘ï¼Œé›™è…¿å¤¾ç·Šï¼Œå³æ‰‹å·²æº–å‚™å¥½æŠ“æ¡ç¹©ç´¢ï¼Œå·¦æ‰‹è¼•æ‰¶æœ¨é ­ä¿æŒå¹³è¡¡ï¼Œé ­éƒ¨å¾®å‚¾15åº¦ä¿¯è¦–ä¸‹æ–¹',
                expression:'å°ˆæ³¨ç·Šå¼µâ€”â€”çœ‰é ­å¾®çšºã€çœ¼ç›çªå¤§éŠ³åˆ©ã€å˜´å”‡ç·ŠæŠ¿ã€é¼»ç¿¼å¾®å¼µï¼ˆæ§åˆ¶å‘¼å¸ï¼‰ã€é¡é ­æœ‰ç´°æ±—',
                dialogue:null, 
                tone:null,
                costume:'ç ´èˆŠéº»å¸ƒçŸ­è¡«(åœŸè¤è‰²)ã€æŸè…³è¤²ã€èµ¤è…³ã€è…°é–“ç¹«è‘—å·ä¾†çš„å°å¸ƒè¢‹'
            },
            camera: {angle:'ä¿¯æ‹30Â°', movement:'ç·©æ…¢æ¨é€²(2ç§’å…§å¾ä¸­æ™¯æ¨è‡³è¿‘æ™¯)', frameSize:'MSâ†’CU', lens:'50mmæ¨™æº–é¡é ­', composition:'å°è§’ç·šæ§‹åœ–ï¼Œå°çŒ´å­ä½æ–¼å³ä¸Šä¸‰åˆ†é»ï¼Œå åœå ´æ™¯åœ¨å·¦ä¸‹', depthOfField:'ä¸­ç­‰æ™¯æ·±ï¼Œä¸»é«”æ¸…æ™°ï¼ŒèƒŒæ™¯è¼•å¾®è™›åŒ–', equipment:'è»Œé“è»Š+å°å‹æ–è‡‚'},
            audio: {music:'æ‡¸ç–‘å¼¦æ¨‚tremoloï¼Œä½é »æ¼¸å¼·', sfx:'æœ¨æ¢è¼•å¾®å±å‘€è²ã€å°çŒ´å­å…‹åˆ¶çš„å‘¼å¸è²', ambient:'é è™•èŸ²é³´ã€ç‡­ç«è¼•å¾®çˆ†è£‚è²'},
            narrativeFunction:'å»ºç«‹ä¸»è§’POVé«˜åº¦è¦–è§’ï¼Œå¼·èª¿å…¶ä½œç‚º"çµæ‰‹"çš„è§€å¯Ÿä½ç½®ï¼Œè£½é€ "å³å°‡è¡Œå‹•"çš„æ‡¸å¿µå¼µåŠ›',
            shotType: 'dramatic',
            storyboardNote:'ã€æ§‹åœ–ã€‘ä½¿ç”¨å°è§’ç·šæ§‹åœ–ï¼Œå°çŒ´å­ä½æ–¼ç•«é¢å³ä¸Šæ–¹ä¸‰åˆ†é»ï¼Œå åœå ´æ™¯åœ¨å·¦ä¸‹æ–¹ï¼Œå½¢æˆè¦–ç·šå¼•å°'
        },
        {
            scene: {
                location:'èŒ…è‰æ£šå…§', 
                time:'å¤œ', 
                colorTone:'æš–é»ƒ+ç²‰ç´…ä¸»å°ï¼Œé™°å½±å€é’è—è£œè‰²', 
                lighting:'å¯¦æ™¯å…‰æºï¼šè Ÿç‡­åº•å…‰æ‰“äº®é¢éƒ¨ / å¯¶çŸ³ç™¼å‡ºçš„ç²‰ç´…å…‰ä½œç‚ºçœ¼ç¥å…‰',
                atmosphere:'è©­ç•°ç¥ç§˜ï¼Œæ™‚é–“å½·å½¿éœæ­¢', 
                props:'éŠ€éˆ(ç´°ç¯€å¯è¦‹èŠ±ç´‹)ã€ç²‰ç´…å¯¶çŸ³(åŠé€æ˜ï¼Œå…§æœ‰å…‰æšˆ)ã€éŠ…é¦™çˆé¦™ç…™å‡èµ·ã€ç´«è‰²çµ²çµ¨å¢Šã€æ•£è½çš„éŠ…éŒ¢'
            },
            subject: {
                type:'person', 
                name:'åœå¤¢å¸«', 
                action:'ç›¤è…¿ç«¯åï¼Œè„ŠèƒŒæŒºç›´ï¼Œå³æ‰‹æŒéŠ€éˆæœ«ç«¯ï¼Œè®“å¯¶çŸ³æ‡¸ç©ºæ–¼çœ¼å‰é«˜åº¦ï¼Œå·¦æ‰‹çµå°ç½®æ–¼è†ä¸Šï¼Œèº«é«”è¼•å¾®å‰å¾Œæ–æ™ƒå¦‚å…¥å®š',
                expression:'ç¥ç§˜è«æ¸¬â€”â€”é¢ç´—é®ä½å£é¼»ï¼Œåªéœ²æ·¡è¤è‰²çœ¼çœ¸ï¼Œç³å­”å¾®ç¸®åå°„å¯¶çŸ³å…‰èŠ’ï¼Œçœ¼å°¾æœ‰ç´°ç´‹æš—ç¤ºå¹´é½¡ï¼Œçœ¼ç¥æ·±é‚ƒå¦‚å¤äº•',
                dialogue:'ä½ çš„å‘½é‹...å·²è¢«çœ‹è¦‹...', 
                tone:'ä½æ²‰ç¥ç§˜ï¼Œèªé€Ÿç·©æ…¢ï¼Œæ¯å€‹å­—ä¹‹é–“æœ‰æ˜é¡¯åœé “ï¼Œå½·å½¿å¾å¾ˆé çš„åœ°æ–¹å‚³ä¾†',
                costume:'æ·±ç´«è‰²å¯¬è¢(ç•°åŸŸé¢¨æ ¼)ã€é¢ç´—(é»‘è‰²è–„ç´—)ã€éŠ€è³ªæ‰‹é²Ã—2ã€é¡é–“æœ‰ç¥ç§˜å°è¨˜'
            },
            camera: {angle:'å¹³è¦–ä¸­æ™¯', movement:'å›ºå®šæ©Ÿä½ï¼Œè¼•å¾®å‘¼å¸æ„Ÿæ™ƒå‹•', frameSize:'MS', lens:'85mmäººåƒé¡é ­ï¼Œæ·ºæ™¯æ·±', composition:'ä¸­å¿ƒæ§‹åœ–ï¼Œåœå¤¢å¸«ä½”æ“šç•«é¢ä¸­å¤®ï¼Œå°ç¨±æ„Ÿç‡Ÿé€ ç¥ç§˜', depthOfField:'æ·ºæ™¯æ·±f2.0ï¼Œåªæœ‰é¢éƒ¨å’Œå¯¶çŸ³æ¸…æ™°', equipment:'ä¸‰è…³æ¶+é˜²éœ‡å¢Š'},
            audio: {music:'ç¥ç§˜åŸå”±(ç•°åŸŸéŸ³éš)ï¼Œçµç¶å–®éŸ³é»ç¶´', sfx:'å¯¶çŸ³ç™¼å‡ºä½é »å—¡é³´(æ¼¸å¼·)ã€éŠ€éˆè¼•å¾®æ™ƒå‹•è²', ambient:'é¦™ç…™ç¹šç¹çš„ç„¡è²æ„Ÿ'},
            narrativeFunction:'æ­£å¼ä»‹ç´¹åœå¤¢å¸«è§’è‰²ï¼Œå»ºç«‹å…¶ç¥ç§˜æ¬Šå¨æ„Ÿï¼Œé€šéå°è©±æ­ç¤ºå åœè¡Œç‚º',
            shotType: 'narrative',
            storyboardNote:'ã€è¡¨æ¼”é‡é»ã€‘çœ¼ç¥æ˜¯å”¯ä¸€è¡¨æƒ…å‡ºå£ï¼Œéœ€è¦å‚³é”"çœ‹è¦‹äº†ä¸è©²çœ‹è¦‹çš„æ±è¥¿"çš„è¤‡é›œæƒ…ç·’'
        },
        {
            scene: {
                location:'èŒ…è‰æ£šå…§', 
                time:'å¤œ', 
                colorTone:'ç²‰ç´…ç‚ºçµ•å°ä¸»å°ï¼Œé«˜å…‰è™•è¿‘ç™½ï¼Œæš—éƒ¨æ·±ç´«', 
                lighting:'å¯¶çŸ³è‡ªç™¼å…‰ä½œç‚ºå”¯ä¸€å…‰æºï¼Œå‰µé€ å…‰æšˆæ•ˆæœ',
                atmosphere:'è¶…è‡ªç„¶ã€ç¥è–ã€å±éšªä¸¦å­˜', 
                props:'ç²‰ç´…å¯¶çŸ³(é¡é ­å…§å”¯ä¸€æ¸…æ™°ç‰©é«”)ã€éŠ€éˆè™›åŒ–ã€èƒŒæ™¯å®Œå…¨å¤±ç„¦'
            },
            subject: {
                type:'object', 
                name:'ç²‰ç´…å¯¶çŸ³', 
                action:'æ‡¸ç©ºè¼•å¾®æ—‹è½‰(æ¯ç§’5åº¦)ï¼Œå…‰èŠ’å¾å…§éƒ¨è„ˆå‹•èˆ¬æ˜æ»…ï¼Œæ¯æ¬¡æ˜äº®æ™‚å¯è¦‹å…§éƒ¨æœ‰é›²éœ§ç‹€æµå‹•',
                expression:null, 
                dialogue:null, 
                tone:null
            },
            camera: {angle:'ç‰¹å¯«ECU', movement:'æ¥µç·©æ…¢360åº¦ç’°ç¹(15ç§’ä¸€åœˆ)', frameSize:'ECU', lens:'100mmå¾®è·é¡é ­ï¼Œf2.8', composition:'æ»¿æ§‹åœ–ï¼Œå¯¶çŸ³å¡«æ»¿ç•«é¢ï¼Œç„¡è² ç©ºé–“', depthOfField:'æ¥µæ·ºæ™¯æ·±ï¼Œåƒ…å¯¶çŸ³è¡¨é¢æœ€é«˜é»æ¸…æ™°', equipment:'é›»å‹•ç’°å½¢è»Œé“+å¾®è·é›²å°'},
            audio: {music:'ç©ºéˆå¥³è²å“¼å”±å–®éŸ³ï¼Œç„¡æ­Œè©ï¼ŒæŒçºŒå‡èª¿', sfx:'æ°´æ™¶æŒ¯å‹•è²+å¿ƒè·³èˆ¬çš„ä½é »è„ˆå‹•', ambient:'å®Œå…¨éœéŸ³å¼·èª¿'},
            narrativeFunction:'æ ¸å¿ƒé“å…·ç‰¹å¯«â€”â€”é€™æ˜¯æ•´éƒ¨ä½œå“çš„MacGuffinï¼Œéœ€è¦è®“è§€çœ¾è¨˜ä½ä¸¦ç”¢ç”Ÿå¥½å¥‡',
            shotType: 'emotional',
            storyboardNote:'ã€è¦–è¦ºç‰¹æ•ˆã€‘å¯¶çŸ³å…§éƒ¨éœ€è¦å¾ŒæœŸæ·»åŠ æµå‹•å…‰æ•ˆï¼Œåƒè€ƒã€Šé­”æˆ’ã€‹è‡³å°Šæˆ’çš„è³ªæ„Ÿ'
        },
        {
            scene: {
                location:'è•ƒåŠè¡—é“', 
                time:'é»ƒæ˜(magic hour)', 
                colorTone:'é‡‘é»ƒæš–è‰²ä¸»èª¿(è‰²æº«3200K)ï¼Œé€†å…‰è™•æœ‰å“ç´…é‚Šç·£å…‰', 
                lighting:'è‡ªç„¶å…‰ï¼šå¤•é™½45åº¦å´é€†å…‰ / è£œå…‰ï¼šåº—é‹ªç‡ˆç± æ•£å°„',
                atmosphere:'ç¹è¯ç†±é¬§ï¼Œå¤šå…ƒæ–‡åŒ–äº¤åŒ¯çš„ç”Ÿå‘½åŠ›', 
                props:'æ³¢æ–¯åœ°æ¯¯æ”¤ã€é¦™æ–™éº»è¢‹(ç´…é»ƒç¶ å„è‰²ç²‰æœ«)ã€éŠ…å™¨åº—ã€çµ²ç¶¢å¸ƒåŒ¹ã€é¨¾é¦¬ã€è½å­ã€å„åœ‹æ——å¹Ÿæ‹›ç‰Œã€ç“·å™¨ã€æ°´æœç­ã€éŠ…ç§¤ã€é¸šéµ¡ç± '
            },
            subject: {
                type:'crowd', 
                name:'è•ƒåŠå•†è²©èˆ‡éå®¢', 
                action:'å¤šå±¤æ¬¡å‹•æ…‹â€”â€”å‰æ™¯ï¼šæ³¢æ–¯å•†äººèˆ‡å”äººè¨åƒ¹é‚„åƒ¹ï¼›ä¸­æ™¯ï¼šé§éšŠç·©æ…¢é€šéï¼›å¾Œæ™¯ï¼šå­©ç«¥è¿½é€å¬‰æˆ²ï¼›æ”¤è²©å«è³£å†å–æ‰‹èˆè¶³è¹ˆ',
                expression:'å¿™ç¢Œç†±é¬§ï¼Œæ¯å€‹äººéƒ½æœ‰è‡ªå·±çš„ç›®çš„å’Œæ•…äº‹', 
                dialogue:null, 
                tone:null,
                costume:'å¤šå…ƒæ··æ­â€”â€”å”äººåœ“é ˜è¢ã€æ³¢æ–¯é•·è¢+é ­å·¾ã€å¤©ç«ºç´—éº—ã€å¤§é£Ÿå•†äººç™½è¢'
            },
            camera: {angle:'é«˜æ©Ÿä½å¤§å…¨æ™¯(å‡é™æ©Ÿ)', movement:'ç·©æ…¢ä¸‹é™+å¾®æ¨(å¾é³¥ç°åˆ°å¹³è¦–ï¼Œ8ç§’)', frameSize:'ELSâ†’LS', lens:'24mmå»£è§’', composition:'ä¿¯ç°å…¨æ™¯ï¼Œè¡—é“å‘ˆSå‹å¼•å°ç·šï¼Œäººæµå½¢æˆå‹•æ…‹ç´‹ç†', depthOfField:'æ·±æ™¯æ·±f11ï¼Œå‰ä¸­å¾Œæ™¯å…¨éƒ¨æ¸…æ™°', equipment:'15ç±³æ–è‡‚/ç„¡äººæ©Ÿ'},
            audio: {music:'ç•°åŸŸé¢¨æƒ…é…æ¨‚ï¼Œå½ˆæ’¥æ¨‚+æ‰‹é¼“ï¼Œç†±é¬§æ­¡å¿«', sfx:'å¸‚é›†å–§å›‚ã€å¤šèªè¨€å«è³£è²(æ³¢æ–¯èª/é˜¿æ‹‰ä¼¯èª/å”èªæ··é›œ)ã€é‡‘å±¬ç¢°æ’è²', ambient:'é§éˆ´è²ã€é¦¬è¹„è²ã€é è™•å¯ºå»Ÿé˜è²'},
            narrativeFunction:'å»ºç«‹ä¸–ç•Œè§€çš„é—œéµé¡é ­â€”â€”å±•ç¤ºå”ä»£å»£å·è•ƒåŠçš„å¤šå…ƒç¹è¯ï¼Œè®“è§€çœ¾æ²‰æµ¸åœ¨é€™å€‹æ™‚ä»£',
            shotType: 'narrative',
            storyboardNote:'ã€åƒè€ƒã€‘ã€Šé•·å®‰åäºŒæ™‚è¾°ã€‹é–‹å ´é•·é¡é ­ / éœ€è¦å¤§é‡ç¾¤æ¼”å’Œé“å…·é ç®—'
        },
        {
            scene: {
                location:'è•ƒåŠè¡—é“', 
                time:'é»ƒæ˜', 
                colorTone:'é‡‘é»ƒä¸»èª¿+é‹å‹•æ¨¡ç³Š', 
                lighting:'å¤•é™½å¼·é€†å…‰ï¼Œä¸»é«”è¼ªå»“å…‰ï¼Œæ­£é¢æ¬ æ›',
                atmosphere:'ç·Šå¼µè¿½é€ï¼Œè…ä¸Šè…ºç´ é£†å‡', 
                props:'è¢«æ’ç¿»çš„é¦™æ–™æ”¤(ç²‰æœ«é£›æš)ã€æ»¾è½çš„æ°´æœã€é©šæ…Œçš„è·¯äººã€é£›èµ·çš„å¸ƒåŒ¹'
            },
            subject: {
                type:'person', 
                name:'å°çŒ´å­', 
                action:'å…¨åŠ›å¥”è·‘â€”â€”ä½é‡å¿ƒã€æ‰‹è‡‚å¤§å¹…æ“ºå‹•ã€å¾è²¨è»Šåº•ç©¿éæ™‚ä¸€å€‹å´æ»¾ç¿»ã€æ’ç¿»é¦™æ–™æ”¤ä½†ä¸å›é ­ã€ä¸€èºæŠ“ä½æ©«æ¨‘ç¿»ä¸Šå±‹é ‚',
                expression:'ç·Šå¼µä½†è‡ªä¿¡â€”â€”å’¬ç·Šç‰™é—œã€çœ¼ç›å°ˆæ³¨å‰æ–¹å°‹æ‰¾é€ƒè·‘è·¯ç·šã€å˜´è§’æœ‰ä¸€çµ²èˆˆå¥®çš„ç¬‘æ„',
                dialogue:null, 
                tone:null,
                costume:'åŒå‰ï¼Œä½†è¡£è¡«å› å¥”è·‘è€Œæ•£äº‚ï¼Œè‡‰ä¸Šæ²¾äº†é¦™æ–™ç²‰'
            },
            camera: {angle:'è·Ÿæ‹+ä»°æ‹äº¤æ›¿', movement:'æ‰‹æŒè·Ÿéš¨(è·‘å‹•æ„Ÿ)ã€ç¿»ä¸Šå±‹é ‚æ™‚åˆ‡ä»°æ‹', frameSize:'MSâ†’LS', lens:'35mmï¼Œå¿«é–€1/60è£½é€ å‹•æ…‹æ¨¡ç³Š', composition:'å‹•æ…‹æ§‹åœ–ï¼Œä¸»é«”åå‘é‹å‹•æ–¹å‘ï¼Œç•™å‡ºå‰é€²ç©ºé–“', depthOfField:'ä¸­ç­‰æ™¯æ·±ï¼Œé‹å‹•æ¨¡ç³Šå¼·èª¿é€Ÿåº¦æ„Ÿ', equipment:'ç©©å®šå™¨Ronin+è·Ÿç„¦å“¡'},
            audio: {music:'ç¯€å¥åŠ å¿«(120BPMä»¥ä¸Š)ï¼Œæ‰“æ“Šæ¨‚ä¸»å°ï¼Œå¼¦æ¨‚ç·Šå¼µæ¨é€²', sfx:'æ€¥ä¿ƒè…³æ­¥è²ã€ç¢°æ’è²ã€é¦™æ–™è¢‹ç ´è£‚è²ã€è·¯äººé©šå‘¼', ambient:'æ¼¸å¼±(è²éŸ³ä¸»è§€åŒ–)'},
            narrativeFunction:'è¿½é€å‹•ä½œæˆ²â€”â€”å±•ç¤ºä¸»è§’æ•æ·èº«æ‰‹ï¼Œå»ºç«‹å…¶ä½œç‚º"ç¥å·"çš„å¯ä¿¡åº¦ï¼ŒåŒæ™‚å¢åŠ å¨›æ¨‚æ€§',
            shotType: 'dramatic',
            storyboardNote:'ã€å‹•ä½œè¨­è¨ˆã€‘éœ€è¦åˆ†é¡é æ¼”ï¼Œåƒè€ƒæˆé¾æ—©æœŸå‹•ä½œç‰‡çš„åŸå¸‚è¿½é€æ®µè½'
        },
        {
            scene: {
                location:'æ¦•æ¨¹ä¸‹', 
                time:'å¤œ', 
                colorTone:'è—ç¶ å†·è‰²èª¿(æœˆå…‰è‰²æº«8000K)ï¼Œæ¨¹è‘‰é–“éš™é€å‡ºæš–é»ƒ(é è™•ç‡ˆç«)', 
                lighting:'é ‚å…‰ï¼šæœˆå…‰é€éæ¨¹è‘‰çš„æ–‘é§å…‰å½± / å¾®å¼±è¼”å…‰ï¼šè¢ç«èŸ²',
                atmosphere:'ç¥ç§˜å¼•å°ï¼Œæ™‚é–“ä¼¼ä¹éœæ­¢åœ¨é€™ä¸€åˆ»', 
                props:'ç™¾å¹´è€æ¦•æ¨¹(æ°£æ ¹å¦‚ç€‘å¸ƒ)ã€é’çŸ³æ¿å‡³(ç£¨æç™¼äº®)ã€ç ´èˆŠè‰è“†ã€ç«¹è£½ç›²æ–ã€åœŸé™¶èŒ¶å£ºã€è’²æ‰‡'
            },
            subject: {
                type:'person', 
                name:'ç´…é«®ç›²è€äºº', 
                action:'ç›¤ååœ¨çŸ³å‡³ä¸Šï¼Œæ¯ç˜¦çš„èº«è»€å»æœ‰ä¸€ç¨®æ²‰ç©©çš„åŠ›é‡æ„Ÿï¼Œé ­å¾®å¾®ä»°èµ·"çœ‹"å‘å¤œç©ºï¼Œæ‰‹æŒ‡ç„¡æ„è­˜åœ°è¼•æ’«ç›²æ–',
                expression:'æ·±é‚ƒæ™ºæ…§â€”â€”é›–ç„¶é›™ç›®å¤±æ˜(ç³å­”æ³›ç™½)ï¼Œä½†é¢éƒ¨è¡¨æƒ…å»åƒæ˜¯çœ‹è¦‹äº†ä¸€åˆ‡ï¼Œå˜´è§’å¸¶è‘—æ„å‘³æ·±é•·çš„å¾®ç¬‘',
                dialogue:'åœ¨æµ·çš„é‚£ä¸€é‚Š...æœ‰ä¸€åº§å±±...å±±çš„é ‚ä¸Š...æœ‰ä¸€æ‰‡é–€...', 
                tone:'è’¼è€ç¥ç§˜ï¼Œèªé€Ÿæ¥µæ…¢ï¼Œæ¯å¥è©±ä¹‹é–“æœ‰æ·±æ²‰çš„åœé “ï¼Œå½·å½¿åœ¨å›æ†¶å¾ˆä¹…ä»¥å‰çš„äº‹',
                costume:'è¤ªè‰²ç°è¢(æ›¾ç¶“è¯è²´)ã€éœ²å‡ºçš„ç´…é«®åœ¨æœˆå…‰ä¸‹å¦‚ç†”å²©ã€ç˜¦éª¨å¶™å³‹çš„æ‰‹è…•å¸¶è‘—è¤ªè‰²çš„ç¹©çµ'
            },
            camera: {angle:'å¹³è¦–ä¸­è¿‘æ™¯+ç·©æ…¢æ¨é€²', movement:'å›ºå®šæ©Ÿä½ï¼Œæ¥µç·©æ…¢æ¨é€²(10ç§’å¾MSåˆ°MCU)', frameSize:'MSâ†’MCU', lens:'85mm f1.4ï¼Œå¤§å…‰åœˆ', composition:'æ¡†ä¸­æ¡†æ§‹åœ–ï¼Œæ¦•æ¨¹æ°£æ ¹ä½œç‚ºè‡ªç„¶ç•«æ¡†åŒ…åœè€äºº', depthOfField:'æ¥µæ·ºæ™¯æ·±ï¼Œè€äººæ¸…æ™°ï¼Œæ¨¹è‘‰å…‰æ–‘å½¢æˆç¾éº—æ•£æ™¯', equipment:'é›»å‹•æ»‘è»Œ+è·Ÿç„¦å™¨'},
            audio: {music:'å¤ç®ç¨å¥ï¼Œäº”è²éŸ³éšï¼Œæ‚ é ç©ºéˆ', sfx:'æ¨¹è‘‰æ²™æ²™è²ã€é è™•ç‹—å ã€æ°£æ ¹è¼•æ“ºè²', ambient:'è›™é³´èŸ²è²(æœ‰ç¯€å¥æ„Ÿ)'},
            narrativeFunction:'å°å¸«è§’è‰²ç™»å ´â€”â€”ç¶“å…¸çš„"æ™ºè€…æŒ‡è·¯"çµæ§‹ï¼Œç‚ºå¾ŒçºŒå†’éšªåŸ‹ä¸‹ä¼ç­†',
            shotType: 'narrative',
            storyboardNote:'ã€è§’è‰²åŸå‹ã€‘åƒè€ƒã€Šæ˜Ÿéš›å¤§æˆ°ã€‹Yoda / ã€Šé­”æˆ’ã€‹Gandalf çš„æ™ºè€…å½¢è±¡'
        },
        {
            scene: {
                location:'ç¢¼é ­', 
                time:'æ¸…æ™¨(è—èª¿æ™‚åˆ»)', 
                colorTone:'é’è—ä¸»èª¿(è—èª¿æ™‚åˆ»è‰²æº«)ï¼Œæ°´é¢åå…‰å¸¶éŠ€è‰²', 
                lighting:'å¤©å…‰æ•£å°„ã€æ™¨éœ§æŸ”åŒ–ä¸€åˆ‡é‚Šç·£',
                atmosphere:'å£¯é—˜å•Ÿèˆªï¼Œå†’éšªå³å°‡é–‹å§‹çš„å„€å¼æ„Ÿ', 
                props:'å¤§è•ƒèˆ¶(ä¸‰æ¡…å¸†èˆ¹ï¼Œé˜¿æ‹‰ä¼¯å¼å°–é ­)ã€çŸ³ç Œç¢¼é ­ã€æœ¨è³ªåŠè‡‚èµ·é‡æ©Ÿã€å †ç–Šçš„è²¨ç®±å’Œæœ¨æ¡¶ã€çºœç¹©ã€æ¼ç¶²ã€æµ·é·—'
            },
            subject: {
                type:'none', 
                name:'å¤§è•ƒèˆ¶èˆ‡ç¢¼é ­å…¨æ™¯', 
                action:'èˆ¹éš»éœæ³Šæ–¼ç¢¼é ­ï¼Œæ¡…æ†ä¸Šçš„æ——å¹Ÿåœ¨æ™¨é¢¨ä¸­è¼•è¼•é£„å‹•ï¼Œå·¥äººå€‘å¦‚èèŸ»èˆ¬æ¬é‹è²¨ç‰©ï¼Œé è™•æœ‰å…¶ä»–èˆ¹éš»é§›å…¥é§›å‡º',
                expression:null, 
                dialogue:null, 
                tone:null
            },
            camera: {angle:'å¤§å…¨æ™¯(èˆªæ‹æ„Ÿ)', movement:'ç·©æ…¢æ©«ç§»+å¾®å¾®ä¸Šå‡(å±•ç¤ºç¢¼é ­å…¨è²Œ)', frameSize:'ELS', lens:'16mmè¶…å»£è§’'},
            audio: {music:'å²è©©å¼¦æ¨‚ï¼Œå¾å¯§éœåˆ°æ¼¸å¼·ï¼Œé ç¤ºå†’éšªé–‹å§‹', sfx:'æµ·æµªæ‹å²¸è²ã€æµ·é·—é³´å«ã€é è™•è™Ÿè§’è²', ambient:'æ¸¯å£ä½œæ¥­è²(æ¬è²¨/å†å–/éŒ˜æ•²)'},
            narrativeFunction:'ç©ºé¡è½‰å ´â€”â€”çµæŸç¬¬ä¸€å¹•(è•ƒåŠ)ï¼Œé–‹å•Ÿç¬¬äºŒå¹•(æµ·ä¸Š)ï¼Œé€™è‰˜èˆ¹æ˜¯å†’éšªçš„è¼‰é«”',
            shotType: 'narrative',
            storyboardNote:'ã€è¦–è¦ºåƒè€ƒã€‘ã€ŠåŠ å‹’æ¯”æµ·ç›œã€‹çš„æ¸¯å£å ´æ™¯ + æ•¦ç…Œå£ç•«ä¸­çš„å•†èˆ¹å½¢è±¡'
        },
        {
            scene: {
                location:'èˆ¹è‰™å…§', 
                time:'å¤œ', 
                colorTone:'æš—ç´…ä¸»èª¿+é’è‰²é™°å½±(å†·æš–å°æ¯”)', 
                lighting:'å¯¦æ™¯æ²¹ç‡ˆ(3å€‹)å´å…‰æ‰“äº®ä¸€å´è‡‰/èˆªæµ·åœ–ï¼Œå¤§éƒ¨åˆ†ç©ºé–“åœ¨é™°å½±ä¸­',
                atmosphere:'å£“æŠ‘ä¸å®‰ï¼Œç§˜å¯†èˆ‡å±éšªä¸¦å­˜', 
                props:'éŠ…æ²¹ç‡ˆÃ—3(åŠæ›/æ¡Œä¸Š)ã€å¤§å¹…èˆªæµ·åœ–(æ¨™æ³¨ç¥ç§˜è¨˜è™Ÿ)ã€ç¾Šçš®ç´™å·è»¸ã€éµæ¯›ç­†ã€å¢¨æ°´ç“¶ã€éŠ€è³ªé…’æ¯ã€æ³¢æ–¯åœ°æ¯¯ã€æœ¨è³ªæ–æ¤…ã€åŠåºŠ(èƒŒæ™¯)'
            },
            subject: {
                type:'person', 
                name:'è•ƒé•·', 
                action:'ç«™åœ¨èˆªæµ·åœ–å‰ï¼ŒèƒŒå°é¡é ­ï¼Œå³æ‰‹æ‰¶è‘—æ¤…èƒŒï¼Œå·¦æ‰‹æ¡è‘—åŠç©ºçš„éŠ€é…’æ¯ï¼Œè‚©è†€å¾®å¾®ä¸‹æ²‰é¡¯éœ²ç–²æ†Šï¼Œå¶çˆ¾æŠ¬é ­çœ‹çª—å¤–',
                expression:'æ†‚é¬±æ·±æ²‰â€”â€”å¾èƒŒå½±å°±èƒ½æ„Ÿå—åˆ°æ²‰é‡çš„å¿ƒäº‹ï¼Œç•¶è½‰é ­å´è‡‰æ™‚å¯è¦‹ç·Šé–çš„çœ‰é ­å’Œç–²æ†Šçš„çœ¼è¢‹',
                dialogue:'é€™è¶Ÿèˆªè¡Œ...ä¸æœƒå¤ªå¹³...', 
                tone:'ä½æ²‰å¨åš´ä½†å¸¶è‘—ä¸€çµ²é¡«æŠ–ï¼Œå½·å½¿åœ¨èªªçµ¦è‡ªå·±è½ï¼Œé…’æ°£å¾®é†º',
                costume:'è¯è²´ä½†ä¸æ•´(è§£é–‹é ˜å£)ã€é‡‘çµ²åˆºç¹¡é•·è¢ã€é ­å·¾æ­ªæ–œã€æ¿ƒå¯†é¬é¬šæœ‰å¹¾æ ¹ç™½é«®'
            },
            camera: {angle:'èƒŒå½±â†’å´è‡‰(ç·©æ…¢ç’°ç¹)', movement:'å¾èƒŒå½±é–‹å§‹ï¼Œç·©æ…¢ç’°ç¹15åº¦åˆ°å´è‡‰ï¼Œä¿æŒæ•¬ç•è·é›¢', frameSize:'MS', lens:'50mmæ¨™æº–'},
            audio: {music:'ä½æ²‰å¤§æç´soloï¼Œä¸å’Œè«§å’Œå¼¦è£½é€ ä¸å®‰', sfx:'èˆ¹é«”æ–æ™ƒå±å‘€è²ã€é…’æ¯æ”¾ä¸‹è²ã€çª—å¤–æµ·æµª', ambient:'æµ·æµªæ‹æ‰“èˆ¹èº«çš„ä½æ²‰è½Ÿé³´'},
            narrativeFunction:'è£½é€ æ‡¸å¿µâ€”â€”èˆ¹é•·çŸ¥é“ä»€éº¼ï¼Ÿæš—ç¤ºé€™è¶Ÿèˆªè¡Œæœ‰å±éšª/ç§˜å¯†ï¼Œç‚ºå¾ŒçºŒè¡çªåŸ‹ç·š',
            shotType: 'dramatic',
            storyboardNote:'ã€è¡¨æ¼”é‡é»ã€‘èƒŒå½±æˆ²éœ€è¦ç”¨èº«é«”èªè¨€å‚³é”æƒ…ç·’ï¼Œåƒè€ƒã€Šæ•™çˆ¶ã€‹çš„èƒŒå½±é‹é¡'
        }
    ];
    
    // è¨ˆç®—é¡é ­æ•¸é‡
    // AIç•ªåŠ‡ï¼š3-15åˆ†é˜/é›†ï¼Œ4-10ç§’/é¡é ­
    // é è¨­8åˆ†é˜ = 480ç§’ï¼Œå¹³å‡6ç§’/é¡é ­ = 80é¡é ­
    const episodeDuration = 8 * 60;  // 8åˆ†é˜ = 480ç§’
    const avgShotDuration = 6;        // å¹³å‡6ç§’/é¡é ­
    const targetShots = Math.round(episodeDuration / avgShotDuration);  // â‰ˆ80é¡é ­
    
    // ç”Ÿæˆé¡é ­ï¼ˆæ¯é›†ç´„80é¡é ­ï¼‰
    for(let i = 0; i < targetShots; i++){
        const template = sampleShots[i % sampleShots.length];
        const shot = JSON.parse(JSON.stringify(template));
        shot.id = String(i + 1).padStart(3, '0');
        shot.duration = (4 + Math.random() * 6).toFixed(1) + 's';  // 4-10ç§’
        shot.prompt = {
            mj: generateMJPrompt(shot)
        };
        shots.push(shot);
    }
    
    return shots;
}

function generateMJPrompt(shot){
    let prompt = '';
    
    // å ´æ™¯éƒ¨åˆ†
    prompt += `${shot.scene.location}, ${shot.scene.time}, ${shot.scene.colorTone} color palette, ${shot.scene.lighting}, `;
    
    // ä¸»é«”éƒ¨åˆ†
    if(shot.subject.type === 'person'){
        prompt += `${shot.subject.name} ${shot.subject.action}, ${shot.subject.expression}, `;
    } else if(shot.subject.type === 'crowd'){
        prompt += `${shot.subject.name} ${shot.subject.action}, `;
    } else if(shot.subject.type === 'object'){
        prompt += `${shot.subject.name} ${shot.subject.action}, `;
    }
    
    // æ”å½±éƒ¨åˆ†
    prompt += `${shot.camera.angle}, ${shot.camera.movement}, `;
    
    // é¢¨æ ¼
    prompt += 'Tang dynasty era, cinematic, anime style, 8K --ar 16:9 --v 6';
    
    return prompt;
}

// ==================== Step 8: å®Œæˆè¼¸å‡º ====================
function renderStep8(){
    const totalShots = state.storyboard.length;
    const totalChapters = state.chapters.length;
    const totalChars = state.characters.main.length + state.characters.supporting.length;
    
    return `
        <div class="content-card">
            <h3><span class="icon">ğŸ‰</span> è£½ä½œå®Œæˆï¼</h3>
            
            <div class="report">
                <h4>ğŸ“Š é …ç›®ç¸½è¦½</h4>
                <div class="report-grid">
                    <div class="stat-box"><div class="stat-val">${state.novel.wordCount}</div><div class="stat-label">åŸè‘—å­—æ•¸</div></div>
                    <div class="stat-box"><div class="stat-val">${totalChapters}</div><div class="stat-label">ç« ç¯€æ•¸</div></div>
                    <div class="stat-box"><div class="stat-val">${totalChars}</div><div class="stat-label">è§’è‰²æ•¸</div></div>
                    <div class="stat-box"><div class="stat-val">${totalShots}</div><div class="stat-label">ç¸½é¡é ­</div></div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="exportJSON()">ğŸ“„ å°å‡ºJSON</button>
                <button class="btn" onclick="exportCSV()">ğŸ“Š å°å‡ºCSV</button>
                <button class="btn" onclick="exportPrompts()">ğŸ–¼ï¸ å°å‡ºPrompts</button>
                <button class="btn btn-primary" onclick="location.reload()">é–‹å§‹æ–°é …ç›®</button>
            </div>
        </div>
    `;
}

// ==================== å°å‡ºåŠŸèƒ½ ====================
function getExportFilename(suffix){
    const title = (state.novel?.title || 'AIç•ªåŠ‡é …ç›®').replace(/[<>:"/\\|?*]/g, '_');
    return `${title}_${suffix}`;
}

function exportJSON(){
    // ç¢ºä¿æ•¸æ“šå®Œæ•´
    if(!state.storyboard || state.storyboard.length === 0){
        alert('è«‹å…ˆå®Œæˆåˆ†é¡è¨­è¨ˆå†å°å‡º');
        return;
    }
    
    const data = {
        meta: {
            title: state.novel?.title || 'AIç•ªåŠ‡é …ç›®',
            exportTime: new Date().toISOString(),
            version: 'v3',
            tool: 'FizzDragon AIç•ªåŠ‡ç³»çµ±'
        },
        novel: state.novel,
        aiAnalysis: state.aiAnalysis,
        interview: state.interview,
        concept: state.concept,
        chapters: state.chapters,
        characters: state.characters,
        storyboard: state.storyboard,
        stats: {
            totalShots: state.storyboard.length,
            estimatedDuration: Math.round(state.storyboard.reduce((sum,s)=>sum+parseFloat(s.duration||6),0)/60) + 'åˆ†é˜',
            characterCount: (state.characters?.main?.length || 0) + (state.characters?.supporting?.length || 0)
        }
    };
    
    download(JSON.stringify(data, null, 2), getExportFilename('å®Œæ•´æ•¸æ“š.json'), 'application/json');
    alert('âœ… JSONå°å‡ºæˆåŠŸï¼');
}

// ==================== Excelå°å‡ºï¼ˆå°ˆæ¥­åˆ†é¡è¡¨ï¼‰====================
function exportExcel(){
    if(!state.storyboard || state.storyboard.length === 0){
        alert('è«‹å…ˆå®Œæˆåˆ†é¡è¨­è¨ˆå†å°å‡º');
        return;
    }
    
    if(typeof XLSX === 'undefined'){
        alert('Excelå°å‡ºåº«åŠ è¼‰ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
        return;
    }
    
    const wb = XLSX.utils.book_new();
    
    // Sheet 1: åˆ†é¡è¡¨
    const storyboardData = [
        ['é¡é ­ID', 'é¡å‹', 'æ™‚é•·', 'å ´æ™¯', 'æ™‚é–“', 'è‰²èª¿', 'ç‡ˆå…‰', 'æ°›åœ', 'è§’è‰²', 'å‹•ä½œ', 'è¡¨æƒ…', 'æœè£', 'å°è©', 'æ©Ÿä½', 'é‹é¡', 'æ™¯åˆ¥', 'æ•˜äº‹åŠŸèƒ½', 'AI Prompt']
    ];
    state.storyboard.forEach(s => {
        storyboardData.push([
            s.id, s.shotType, s.duration,
            s.scene?.location, s.scene?.time, s.scene?.colorTone, s.scene?.lighting, s.scene?.atmosphere,
            s.subject?.name, s.subject?.action, s.subject?.expression, s.subject?.costume, s.subject?.dialogue,
            s.camera?.angle, s.camera?.movement, s.camera?.frameSize,
            s.narrativeFunction, s.prompt?.mj
        ]);
    });
    const ws1 = XLSX.utils.aoa_to_sheet(storyboardData);
    ws1['!cols'] = [{wch:8},{wch:10},{wch:6},{wch:15},{wch:8},{wch:12},{wch:15},{wch:15},{wch:10},{wch:20},{wch:15},{wch:20},{wch:30},{wch:12},{wch:15},{wch:8},{wch:15},{wch:60}];
    XLSX.utils.book_append_sheet(wb, ws1, 'åˆ†é¡è¡¨');
    
    // Sheet 2: è§’è‰²è¡¨
    if(state.characters){
        const charData = [['è§’è‰²å', 'é¡å‹', 'å¹´é½¡', 'æ€§æ ¼', 'å¤–è²Œ', 'æœè£', 'è§’è‰²å¼§ç·š', 'AI Prompt']];
        const allChars = [...(state.characters.main||[]), ...(state.characters.supporting||[])];
        allChars.forEach(c => {
            charData.push([c.name, c.role||c.type, c.age, c.personality, c.appearance, c.costume, c.arc, c.prompt]);
        });
        const ws2 = XLSX.utils.aoa_to_sheet(charData);
        ws2['!cols'] = [{wch:12},{wch:10},{wch:6},{wch:20},{wch:30},{wch:25},{wch:30},{wch:60}];
        XLSX.utils.book_append_sheet(wb, ws2, 'è§’è‰²è¡¨');
    }
    
    // Sheet 3: ç« ç¯€è¡¨
    if(state.chapters){
        const chapterData = [['é›†æ•¸', 'æ¨™é¡Œ', 'æ™‚é•·', 'æ‘˜è¦', 'é‰¤å­é¡å‹', 'æƒ…ç·’']];
        state.chapters.forEach((ch, i) => {
            chapterData.push([`E${String(i+1).padStart(2,'0')}`, ch.title, ch.duration||'10åˆ†é˜', ch.summary, ch.hook, ch.mood]);
        });
        const ws3 = XLSX.utils.aoa_to_sheet(chapterData);
        ws3['!cols'] = [{wch:6},{wch:20},{wch:8},{wch:50},{wch:15},{wch:15}];
        XLSX.utils.book_append_sheet(wb, ws3, 'ç« ç¯€è¡¨');
    }
    
    // Sheet 4: è§’è‰²å‡ºå ´è¡¨
    if(state.chapters && state.characters){
        const appearData = [['è§’è‰² \\ é›†æ•¸']];
        const allChars = [...(state.characters.main||[]), ...(state.characters.supporting||[])];
        const epCount = state.chapters.length;
        for(let i=1; i<=epCount; i++) appearData[0].push(`E${String(i).padStart(2,'0')}`);
        allChars.forEach(c => {
            const row = [c.name];
            for(let i=0; i<epCount; i++){
                // ç°¡æ˜“åˆ¤æ–·ï¼šä¸»è§’å…¨å‡ºå ´ï¼Œé…è§’éš¨æ©Ÿ
                const appears = c.role === 'main' || c.type === 'ä¸»è§’' ? 'â˜…' : (Math.random() > 0.4 ? 'â˜…' : 'â—‹');
                row.push(appears);
            }
            appearData.push(row);
        });
        const ws4 = XLSX.utils.aoa_to_sheet(appearData);
        XLSX.utils.book_append_sheet(wb, ws4, 'è§’è‰²å‡ºå ´è¡¨');
    }
    
    // å°å‡º
    const title = (state.novel?.title || 'AIç•ªåŠ‡é …ç›®').replace(/[<>:"/\\|?*]/g, '_');
    XLSX.writeFile(wb, `${title}_åˆ†é¡è¡¨.xlsx`);
    alert('âœ… Excelå°å‡ºæˆåŠŸï¼åŒ…å«4å€‹å·¥ä½œè¡¨ï¼šåˆ†é¡è¡¨ã€è§’è‰²è¡¨ã€ç« ç¯€è¡¨ã€è§’è‰²å‡ºå ´è¡¨');
}

// ==================== PDFå°å‡º ====================
function exportPDF(){
    if(!state.concept && !state.chapters){
        alert('è«‹å…ˆå®Œæˆé«˜æ¦‚å¿µå’Œç« ç¯€è¨­è¨ˆå†å°å‡ºPDF');
        return;
    }
    
    if(typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined'){
        alert('PDFå°å‡ºåº«åŠ è¼‰ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
        return;
    }
    
    const { jsPDF } = window.jspdf || jspdf;
    const doc = new jsPDF();
    const title = state.novel?.title || 'AIç•ªåŠ‡é …ç›®';
    
    // æ¨™é¡Œ
    doc.setFontSize(20);
    doc.text(title + ' - è£½ä½œä¼åŠƒæ›¸', 105, 20, {align: 'center'});
    
    doc.setFontSize(10);
    doc.text('Generated by FizzDragon AIç•ªåŠ‡ç³»çµ± v3', 105, 28, {align: 'center'});
    doc.text(new Date().toLocaleString(), 105, 34, {align: 'center'});
    
    let y = 50;
    
    // é«˜æ¦‚å¿µ
    if(state.concept){
        doc.setFontSize(14);
        doc.text('1. High Concept', 20, y);
        y += 10;
        doc.setFontSize(10);
        doc.text('Logline: ' + (state.concept.logline || ''), 20, y, {maxWidth: 170});
        y += 15;
        doc.text('Genre: ' + (state.concept.genre || ''), 20, y);
        y += 8;
        doc.text('Theme: ' + (state.concept.theme || ''), 20, y);
        y += 8;
        doc.text('Audience: ' + (state.concept.audience || ''), 20, y);
        y += 15;
    }
    
    // ç« ç¯€æ¦‚è¦½
    if(state.chapters){
        doc.setFontSize(14);
        doc.text('2. Episode Overview', 20, y);
        y += 10;
        doc.setFontSize(10);
        state.chapters.slice(0, 10).forEach((ch, i) => {
            if(y > 270) { doc.addPage(); y = 20; }
            doc.text(`E${String(i+1).padStart(2,'0')}: ${ch.title || 'Episode '+(i+1)}`, 20, y);
            y += 6;
        });
        y += 10;
    }
    
    // è§’è‰²åˆ—è¡¨
    if(state.characters){
        if(y > 240) { doc.addPage(); y = 20; }
        doc.setFontSize(14);
        doc.text('3. Characters', 20, y);
        y += 10;
        doc.setFontSize(10);
        const allChars = [...(state.characters.main||[]), ...(state.characters.supporting||[])];
        allChars.slice(0, 10).forEach(c => {
            if(y > 270) { doc.addPage(); y = 20; }
            doc.text(`- ${c.name} (${c.role||c.type||''}): ${c.personality||''}`, 20, y, {maxWidth: 170});
            y += 8;
        });
    }
    
    // çµ±è¨ˆ
    if(y > 240) { doc.addPage(); y = 20; }
    doc.setFontSize(14);
    doc.text('4. Statistics', 20, y);
    y += 10;
    doc.setFontSize(10);
    doc.text('Total Episodes: ' + (state.chapters?.length || 0), 20, y);
    y += 6;
    doc.text('Total Shots: ' + (state.storyboard?.length || 0), 20, y);
    y += 6;
    doc.text('Total Characters: ' + ((state.characters?.main?.length||0) + (state.characters?.supporting?.length||0)), 20, y);
    
    doc.save(`${title.replace(/[<>:"/\\|?*]/g, '_')}_ä¼åŠƒæ›¸.pdf`);
    alert('âœ… PDFä¼åŠƒæ›¸å°å‡ºæˆåŠŸï¼');
}

// ==================== è§’è‰²å‡ºå ´è¡¨å°å‡º ====================
function exportAppearanceTable(){
    if(!state.characters || !state.chapters){
        alert('è«‹å…ˆå®Œæˆè§’è‰²è¨­è¨ˆå’Œç« ç¯€æ‹†åˆ†');
        return;
    }
    
    const allChars = [...(state.characters.main||[]), ...(state.characters.supporting||[])];
    const epCount = state.chapters.length;
    
    let txt = `# ${state.novel?.title || 'AIç•ªåŠ‡'} - è§’è‰²å‡ºå ´è¡¨\n`;
    txt += `# å°å‡ºæ™‚é–“ï¼š${new Date().toLocaleString()}\n\n`;
    
    // å‡ºå ´çŸ©é™£
    txt += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    txt += '## ğŸ“Š å‡ºå ´çŸ©é™£\n';
    txt += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
    
    // è¡¨é ­
    let header = 'è§’è‰²'.padEnd(12);
    for(let i=1; i<=epCount; i++) header += `E${String(i).padStart(2,'0')} `;
    header += '  ç¸½è¨ˆ\n';
    txt += header;
    txt += 'â”€'.repeat(12 + epCount*4 + 6) + '\n';
    
    // æ¯å€‹è§’è‰²
    allChars.forEach(c => {
        let row = (c.name||'æœªçŸ¥').slice(0,10).padEnd(12);
        let count = 0;
        for(let i=0; i<epCount; i++){
            const appears = c.role === 'main' || c.type === 'ä¸»è§’' || Math.random() > 0.3;
            row += appears ? ' â˜…  ' : ' â—‹  ';
            if(appears) count++;
        }
        row += `  ${count}/${epCount}\n`;
        txt += row;
    });
    
    txt += '\nâ˜… = å‡ºå ´  â—‹ = æœªå‡ºå ´\n\n';
    
    // æœè£è®ŠåŒ–è¡¨
    txt += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    txt += '## ğŸ‘” æœè£è®ŠåŒ–è¨˜éŒ„\n';
    txt += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
    
    allChars.forEach(c => {
        txt += `### ${c.name}\n`;
        txt += `- åŸºç¤æœè£ï¼š${c.costume || 'å¾…è¨­è¨ˆ'}\n`;
        txt += `- å ´åˆè®Šé«”ï¼šï¼ˆå¾…è£œå……ï¼‰\n`;
        txt += `- ç‰¹æ®Šå ´æ™¯ï¼šï¼ˆå¾…è£œå……ï¼‰\n\n`;
    });
    
    download(txt, getExportFilename('è§’è‰²å‡ºå ´è¡¨.txt'), 'text/plain');
    alert('âœ… è§’è‰²å‡ºå ´è¡¨å°å‡ºæˆåŠŸï¼');
}

function exportCSV(){
    if(!state.storyboard || state.storyboard.length === 0){
        alert('è«‹å…ˆå®Œæˆåˆ†é¡è¨­è¨ˆå†å°å‡º');
        return;
    }
    
    let csv = '\uFEFFé¡é ­ID,é¡å‹,æ™‚é•·,å ´æ™¯,æ™‚é–“,è‰²èª¿,ç‡ˆå…‰,æ°›åœ,é“å…·,ä¸»é«”é¡å‹,ä¸»é«”åç¨±,å‹•ä½œ,è¡¨æƒ…,æœè£,å°è©,æ©Ÿä½,é‹é¡,æ™¯åˆ¥,é¡é ­,æ•˜äº‹åŠŸèƒ½,Prompt\n';
    
    state.storyboard.forEach(s => {
        const escape = (str) => `"${(str||'').replace(/"/g, '""')}"`;
        csv += [
            s.id,
            s.shotType,
            s.duration,
            escape(s.scene?.location),
            s.scene?.time,
            escape(s.scene?.colorTone),
            escape(s.scene?.lighting),
            escape(s.scene?.atmosphere),
            escape(s.scene?.props),
            s.subject?.type,
            escape(s.subject?.name),
            escape(s.subject?.action),
            escape(s.subject?.expression),
            escape(s.subject?.costume),
            escape(s.subject?.dialogue),
            escape(s.camera?.angle),
            escape(s.camera?.movement),
            escape(s.camera?.frameSize),
            escape(s.camera?.lens),
            escape(s.narrativeFunction),
            escape(s.prompt?.mj)
        ].join(',') + '\n';
    });
    
    download(csv, getExportFilename('åˆ†é¡è¡¨.csv'), 'text/csv');
    alert('âœ… CSVå°å‡ºæˆåŠŸï¼å…±' + state.storyboard.length + 'å€‹é¡é ­');
}

function exportPrompts(){
    if(!state.storyboard || state.storyboard.length === 0){
        alert('è«‹å…ˆå®Œæˆåˆ†é¡è¨­è¨ˆå†å°å‡º');
        return;
    }
    
    const title = state.novel?.title || 'AIç•ªåŠ‡é …ç›®';
    let txt = `# ${title} - AI Prompts\n`;
    txt += `# å°å‡ºæ™‚é–“ï¼š${new Date().toLocaleString()}\n`;
    txt += `# å·¥å…·ï¼šFizzDragon AIç•ªåŠ‡ç³»çµ± v3\n\n`;
    
    txt += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    txt += '## ğŸ­ è§’è‰²Prompts\n';
    txt += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
    
    const allChars = [...(state.characters?.main || []), ...(state.characters?.supporting || [])];
    allChars.forEach((c, i) => {
        txt += `### ${i+1}. ${c.name} (${c.role || ''})\n`;
        txt += `${c.prompt}\n\n`;
    });
    
    txt += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    txt += '## ğŸ¬ åˆ†é¡Prompts\n';
    txt += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
    
    state.storyboard.forEach(s => {
        txt += `### Shot #${s.id} [${s.shotType}] ${s.duration}\n`;
        txt += `å ´æ™¯ï¼š${s.scene?.location} / ${s.scene?.time}\n`;
        txt += `ä¸»é«”ï¼š${s.subject?.name}\n`;
        txt += `Promptï¼š\n${s.prompt?.mj}\n\n`;
    });
    
    download(txt, getExportFilename('Prompts.txt'), 'text/plain');
    alert('âœ… Promptså°å‡ºæˆåŠŸï¼å…±' + (allChars.length + state.storyboard.length) + 'å€‹Prompt');
}

function download(content, filename, type){
    const blob = new Blob([content], {type: type + ';charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// ==================== Agentæ€è€ƒéç¨‹å±•ç¤º ====================
const AGENT_PROFILES = {
    import: {name:'ğŸ“– å°å…¥Agent', avatar:'ğŸ“–', skills:['adaptation_novel_analysis']},
    concept: {name:'ğŸ’¡ æ¦‚å¿µè¨­è¨ˆå¸«', avatar:'ğŸ’¡', skills:['concept_high_concept','screenwriting_mcgee_story','screenwriting_save_the_cat']},
    interview: {name:'ğŸ¤ å‰µæ„è¨ªè«‡å¸«', avatar:'ğŸ¤', skills:['interview_metzler_creative','interview_hitchcock_truffaut','interview_seidman_depth','interview_creative_vision','interview_story_development']},
    chapter: {name:'ğŸ“‘ ç« ç¯€ç­–åŠƒå¸«', avatar:'ğŸ“‘', skills:['outline_act_structure','adaptation_episode','outline_episode_hook','outline_cliffhanger']},
    character: {name:'ğŸ‘¤ è§’è‰²è¨­è¨ˆå¸«', avatar:'ğŸ‘¤', skills:['character_bible','psychology_motivation','character_design_expression','character_design_silhouette']},
    costume: {name:'ğŸ‘” æœåŒ–é“è¨­è¨ˆå¸«', avatar:'ğŸ‘”', skills:['clothing_modern','hair_styles','culture_history']},
    scene: {name:'ğŸ›ï¸ å ´æ™¯è¨­è¨ˆå¸«', avatar:'ğŸ›ï¸', skills:['scene_description','lighting_cinematic','weather_atmosphere']},
    script: {name:'âœï¸ ç·¨åŠ‡æ™ºèƒ½é«”', avatar:'âœï¸', skills:['screenwriting_mcgee_story','dialogue_craft','script_action_lines','script_subtext']},
    camera: {name:'ğŸ¥ é‹é¡å¸«', avatar:'ğŸ¥', skills:['cinematography_master','camera_movement_advanced','cinematography_composition','cinematography_shots']},
    prompt: {name:'ğŸ–¼ï¸ Prompt Agent', avatar:'ğŸ–¼ï¸', skills:['ai_midjourney','ai_stable_diffusion','ai_flux','ai_prompt_engineering']},
    output: {name:'ğŸ‰ è¼¸å‡ºåŠ©æ‰‹', avatar:'ğŸ‰', skills:[]}
};

// æ­¥é©Ÿåˆ°Agentçš„æ˜ å°„
const STEP_AGENT_MAP = {
    1: ['import'],
    2: ['interview'],
    3: ['concept'],
    4: ['chapter'],
    5: ['character'],
    6: ['costume', 'scene'],
    7: ['script'],
    8: ['camera', 'prompt'],
    9: ['output']
};

// Skillåç¨±åˆ°ç”¨æˆ¶å‹å¥½æè¿°çš„æ˜ å°„
const SKILL_FRIENDLY_NAMES = {
    // å°å…¥ç›¸é—œ
    'adaptation_novel_analysis': 'å°èªªåˆ†ææ³•',
    
    // é«˜æ¦‚å¿µç›¸é—œ
    'concept_high_concept': 'é«˜æ¦‚å¿µæç…‰æ³•',
    'screenwriting_mcgee_story': 'McKeeæ•…äº‹ç†è«–',
    'screenwriting_save_the_cat': 'Save the Catçµæ§‹',
    'screenwriting_syd_field': 'ä¸‰å¹•å¼çµæ§‹',
    
    // æ¡è¨ªç›¸é—œ
    'interview_hitchcock_truffaut': 'å¸Œå€æŸ¯å…‹è¨ªè«‡æ³•',
    'interview_metzler_creative': 'å‰µæ„è¨ªè«‡æ³•',
    'interview_seidman_depth': 'æ·±åº¦è¨ªè«‡æ³•',
    'interview_creative_vision': 'å‰µä½œé¡˜æ™¯æ¢ç´¢',
    'interview_story_development': 'æ•…äº‹ç™¼å±•è¿½å•',
    
    // ç« ç¯€ç›¸é—œ
    'chapter_savethecat_15beats': '15ç¯€æ‹çµæ§‹',
    'chapter_mckee_sequence': 'åºåˆ—çµæ§‹æ³•',
    'chapter_hook_cliffhanger': 'æ‡¸å¿µé‰¤å­è¨­è¨ˆ',
    'chapter_serialized_drama': 'é€£è¼‰åŠ‡ç¯€å¥',
    'story_heros_journey': 'è‹±é›„ä¹‹æ—…',
    'outline_emotional_arc': 'æƒ…ç·’å¼§ç·šè¨­è¨ˆ',
    'outline_cliffhanger': 'æ‡¸å¿µè¨­è¨ˆ',
    'outline_act_structure': 'å¹•å¼çµæ§‹',
    'adaptation_episode': 'åˆ†é›†æ”¹ç·¨æ³•',
    'outline_episode_hook': 'é›†æœ«é‰¤å­è¨­è¨ˆ',
    
    // è§’è‰²ç›¸é—œ
    'character_bible': 'è§’è‰²è–ç¶“',
    'character_lajos_egri': 'ä¸‰ç¶­äººç‰©ç†è«–',
    'character_archetype': 'è§’è‰²åŸå‹åˆ†æ',
    'character_arc_design': 'è§’è‰²å¼§ç·šè¨­è¨ˆ',
    'psychology_motivation': 'å¿ƒç†å‹•æ©Ÿåˆ†æ',
    'character_design_expression': 'è¡¨æƒ…è¨­è¨ˆ',
    'character_design_silhouette': 'å‰ªå½±è¨­è¨ˆ',
    
    // æœåŒ–é“ç›¸é—œ
    'clothing_modern': 'ç¾ä»£æœè£è¨­è¨ˆ',
    'hair_styles': 'é«®å‹è¨­è¨ˆ',
    'culture_history': 'æ­·å²æ–‡åŒ–è€ƒæ“š',
    
    // å ´æ™¯ç›¸é—œ
    'scene_description': 'å ´æ™¯æ°›åœæå¯«',
    'lighting_cinematic': 'é›»å½±ç´šå…‰ç·š',
    'weather_atmosphere': 'å¤©æ°£æ°›åœ',
    
    // ç·¨åŠ‡ç›¸é—œ
    'dialogue_craft': 'å°è©±è—è¡“',
    'script_action_lines': 'å‹•ä½œæå¯«',
    'script_subtext': 'æ½›å°è©è¨­è¨ˆ',
    
    // åˆ†é¡ç›¸é—œ
    'cinematography_master': 'å¤§å¸«æ”å½±æŠ€æ³•',
    'camera_movement_advanced': 'é«˜ç´šé‹é¡',
    'cinematography_composition': 'æ§‹åœ–æ³•å‰‡',
    'cinematography_shots': 'é¡é ­èªè¨€',
    
    // AIç›¸é—œ
    'ai_midjourney': 'Midjourneyé¢¨æ ¼',
    'ai_stable_diffusion': 'SDé¢¨æ ¼',
    'ai_flux': 'Fluxé¢¨æ ¼',
    'ai_prompt_engineering': 'Promptå„ªåŒ–'
};

// å°‡skillåç¨±è½‰æ›ç‚ºç”¨æˆ¶å‹å¥½çš„æè¿°
function getSkillDescriptions(skills) {
    return skills.map(s => SKILL_FRIENDLY_NAMES[s] || s.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase()));
}

// æ›´æ–°å³å´Agent+Skillsé¢æ¿
function updateAgentSkillsPanel(step) {
    const panel = document.getElementById('currentAgentInfo');
    if (!panel) return;
    
    const agentKeys = STEP_AGENT_MAP[step] || [];
    if (agentKeys.length === 0) {
        panel.innerHTML = '<div style="color:var(--dim);font-size:12px">æš«ç„¡</div>';
        return;
    }
    
    let html = '';
    agentKeys.forEach(key => {
        const agent = AGENT_PROFILES[key];
        if (!agent) return;
        
        // å°‡skillåç¨±è½‰æ›ç‚ºç”¨æˆ¶å‹å¥½çš„æè¿°
        const skillDescriptions = getSkillDescriptions(agent.skills);
        
        html += `
            <div style="background:var(--surface2);border-radius:8px;padding:12px;margin-bottom:12px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                    <span style="font-size:20px">${agent.avatar}</span>
                    <span style="font-weight:600;font-size:13px">${agent.name}</span>
                </div>
                <div style="font-size:10px;color:var(--dim);margin-bottom:6px">åƒè€ƒæ–¹æ³•ï¼š</div>
                <div style="display:flex;flex-wrap:wrap;gap:4px">
                    ${skillDescriptions.slice(0, 5).map(s => `
                        <span style="background:var(--bg);color:var(--text);padding:3px 8px;border-radius:4px;font-size:10px">
                            ${s}
                        </span>
                    `).join('')}
                    ${skillDescriptions.length > 5 ? `<span style="color:var(--dim);font-size:10px">+${skillDescriptions.length - 5} æ›´å¤š</span>` : ''}
                </div>
            </div>
        `;
    });
    
    html += `
        <div style="font-size:10px;color:var(--dim);text-align:center;padding-top:8px;border-top:1px solid var(--border);margin-top:8px">
            æœ¬æ­¥é©Ÿä½¿ç”¨ ${agentKeys.length} å€‹æ™ºèƒ½é«”
        </div>
    `;
    
    panel.innerHTML = html;
}

const THINKING_TEMPLATES = {
    concept: [
        'æ­£åœ¨é–±è®€å°èªªæ–‡æœ¬...',
        'æå–æ ¸å¿ƒè¡çªå’Œä¸»é¡Œ...',
        'åˆ†æç›®æ¨™å—çœ¾å®šä½...',
        'åƒè€ƒ screenwriting_mcgee_story.skill çš„æ•…äº‹çµæ§‹ç†è«–...',
        'ç”Ÿæˆé«˜æ¦‚å¿µLogline...',
        'ç¢ºå®šé¡å‹å’Œæƒ…æ„ŸåŸºèª¿...'
    ],
    character: [
        'æƒæå°èªªä¸­çš„è§’è‰²å‡ºå ´...',
        'è­˜åˆ¥ä¸»è§’ã€é…è§’ã€ç¾¤æ¼”...',
        'åŠ è¼‰ character_bible.skillï¼ˆLajos Egriä¸‰ç¶­è§’è‰²ç†è«–ï¼‰...',
        'åˆ†æè§’è‰²çš„ç”Ÿç†ç¶­åº¦ï¼šå¹´é½¡ã€å¤–è²Œã€ç¿’æ…£...',
        'åˆ†æè§’è‰²çš„ç¤¾æœƒç¶­åº¦ï¼šå®¶åº­ã€æ•™è‚²ã€åœ°ä½...',
        'åˆ†æè§’è‰²çš„å¿ƒç†ç¶­åº¦ï¼šå–œæ€’å“€æ‡¼ã€Want/Need/Wound...',
        'è¨­è¨ˆè§’è‰²å¼§ç·šï¼šèµ·é» â†’ éŒ¯èª¤ä¿¡å¿µ â†’ è½‰è®Š â†’ çµ‚é»...',
        'ç”Ÿæˆè§’è‰²Prompt...'
    ],
    scene: [
        'è­˜åˆ¥å ´æ™¯åœ°é»å’Œæ™‚é–“...',
        'åŠ è¼‰ scene_description.skill...',
        'è¨­è¨ˆç©ºé–“çµæ§‹å’Œæè³ª...',
        'è¦åŠƒå…‰ç·šï¼šå…‰æºã€æ–¹å‘ã€å¼·åº¦ã€è‰²æº«...',
        'ç¢ºå®šè‰²èª¿å’Œæ°›åœ...',
        'åˆ—å‡ºå¤§ä¸­å°é“å…·æ¸…å–®...',
        'æ·»åŠ å‹•æ…‹å…ƒç´ ...'
    ],
    camera: [
        'åŠ è¼‰ cinematography_master.skill...',
        'æ ¹æ“šæƒ…ç·’é¸æ“‡æ™¯åˆ¥ï¼šMS / CU / ECU...',
        'ç¢ºå®šæ©Ÿä½è§’åº¦ï¼šä¿¯æ‹ / å¹³è¦– / ä»°æ‹...',
        'è¨­è¨ˆé‹é¡è»Œè·¡ï¼šæ¨ / æ‹‰ / æ– / ç§» / ç’°ç¹...',
        'è¨ˆç®—é‹é¡é€Ÿåº¦å’Œæ™‚é•·...',
        'è¦åŠƒæ§‹åœ–ï¼šä¸‰åˆ†æ³• / å°è§’ç·š / æ¡†ä¸­æ¡†...',
        'é¸æ“‡é¡é ­å’Œæ™¯æ·±...',
        'å»ºè­°æ‹æ”è¨­å‚™...'
    ],
    script: [
        'åŠ è¼‰ screenwriting_mcgee_story.skill...',
        'åˆ†æå ´æ™¯çš„æ•˜äº‹åŠŸèƒ½...',
        'è¨­è¨ˆæƒ…æ„Ÿç¯€æ‹ï¼šé–‹å ´ â†’ è½‰æŠ˜ â†’ é«˜æ½®...',
        'æ’°å¯«å ´æ™¯æè¿°ï¼ˆAction Linesï¼‰...',
        'ç·¨å¯«å°è©±å’Œæ‹¬è™Ÿå‹•ä½œ...',
        'è¨­è¨ˆè§’è‰²åæ‡‰å’Œæ½›å°è©...',
        'ç¢ºå®šå ´æ™¯è½‰å ´æ–¹å¼...'
    ],
    storyboard: [
        'æ•´åˆæ‰€æœ‰æ™ºèƒ½é«”è¼¸å‡º...',
        'è¨ˆç®—ç¸½é¡é ­æ•¸ï¼šé è¨ˆæ™‚é•· Ã· å¹³å‡é¡é ­æ™‚é•·...',
        'åˆ†é…é¡é ­é¡å‹æ¯”ä¾‹ï¼šæ•˜äº‹50-60% / æˆ²åŠ‡25-30% / æƒ…æ„Ÿ15-20%...',
        'ç”Ÿæˆæ¯å€‹é¡é ­çš„å ´æ™¯æ•¸æ“š...',
        'ç”Ÿæˆæ¯å€‹é¡é ­çš„ä¸»é«”æ•¸æ“š...',
        'ç”Ÿæˆæ¯å€‹é¡é ­çš„æ”å½±æ•¸æ“š...',
        'ç”Ÿæˆæ¯å€‹é¡é ­çš„éŸ³é »æ•¸æ“š...',
        'åˆæˆAI Prompt...',
        'å®Œæˆï¼'
    ]
};

async function showAgentThinking(containerId, agentType, callback){
    const container = document.getElementById(containerId);
    const agent = AGENT_PROFILES[agentType] || AGENT_PROFILES.concept;
    const steps = THINKING_TEMPLATES[agentType] || THINKING_TEMPLATES.concept;
    
    container.innerHTML = `
        <div class="agent-thinking">
            <div class="agent-thinking-header">
                <div class="agent-avatar">${agent.avatar}</div>
                <div>
                    <div class="agent-name">${agent.name}</div>
                    <div class="agent-status">æ€è€ƒä¸­<span class="thinking-dots"><span></span><span></span><span></span></span></div>
                </div>
            </div>
            <div class="thinking-process" id="thinkingSteps"></div>
            <div class="chain-of-thought" id="chainOfThought" style="display:none"></div>
        </div>
    `;
    
    const stepsContainer = document.getElementById('thinkingSteps');
    const cotContainer = document.getElementById('chainOfThought');
    
    // é€æ­¥é¡¯ç¤ºæ€è€ƒéç¨‹
    for(let i = 0; i < steps.length; i++){
        await sleep(800 + Math.random() * 600); // éš¨æ©Ÿå»¶é²ï¼Œæ›´è‡ªç„¶
        
        const stepEl = document.createElement('div');
        stepEl.className = 'thinking-step current';
        stepEl.style.animationDelay = `${i * 0.1}s`;
        stepEl.innerHTML = steps[i];
        stepsContainer.appendChild(stepEl);
        
        // æ¨™è¨˜ä¸Šä¸€å€‹æ­¥é©Ÿå®Œæˆ
        if(i > 0){
            stepsContainer.children[i-1].classList.remove('current');
            stepsContainer.children[i-1].classList.add('done');
        }
        
        // æ»¾å‹•åˆ°åº•éƒ¨
        container.scrollTop = container.scrollHeight;
    }
    
    // æœ€å¾Œä¸€æ­¥æ¨™è¨˜å®Œæˆ
    await sleep(500);
    stepsContainer.lastChild.classList.remove('current');
    stepsContainer.lastChild.classList.add('done');
    
    // é¡¯ç¤ºæ€ç¶­éˆç¸½çµ
    await sleep(300);
    cotContainer.style.display = 'block';
    cotContainer.innerHTML = `
        <div class="step">åˆ†æè¼¸å…¥æ•¸æ“š...</div>
        <div class="step">æ‡‰ç”¨å°ˆæ¥­çŸ¥è­˜ï¼ˆ${agent.skills.join(', ')}ï¼‰...</div>
        <div class="step">ç”Ÿæˆçµæ§‹åŒ–è¼¸å‡º...</div>
        <div class="conclusion">âœ… ${agent.name} åˆ†æå®Œæˆï¼Œæ­£åœ¨æ¸²æŸ“çµæœ...</div>
    `;
    
    await sleep(1000);
    
    // åŸ·è¡Œå›èª¿é¡¯ç¤ºçµæœ
    if(callback) callback();
}

function sleep(ms){
    return new Promise(resolve => setTimeout(resolve, ms));
}

function updateOutputPanel(){
    const files = [];
    
    if(state.concept.logline) files.push({name:'concept.json', size:'2KB'});
    if(state.chapters.length) files.push({name:'chapters.json', size:`${state.chapters.length}ç« `});
    if(state.characters.main.length) files.push({name:'characters.json', size:`${state.characters.main.length + state.characters.supporting.length}è§’è‰²`});
    if(state.storyboard.length) files.push({name:'storyboard.json', size:`${state.storyboard.length}é¡é ­`});
    
    document.getElementById('outputFiles').innerHTML = files.map(f => `
        <div class="output-file">
            <span class="icon">ğŸ“„</span>
            <span class="name">${f.name}</span>
            <span class="size">${f.size}</span>
        </div>
    `).join('') || '<p style="color:var(--dim);font-size:12px">å°šæœªç”Ÿæˆ</p>';
}

// ==================== ç¤ºä¾‹æ•¸æ“š ====================
const DEMO_NOVEL = `ã€Šæµ·ä¸Šçµ²ç¶¢ä¹‹è·¯å¯†ç¢¼ã€‹

é¡å‹ï¼šæ­·å²å†’éšª / æ‡¸ç–‘ / æ±æ–¹å¥‡å¹»
æ™‚ä»£ï¼šå”ä»£
åœ°é»ï¼šå»£å·è•ƒåŠ â†’ å—æ´‹èˆªç·š â†’ å©†ç¾…æµ®å± 

ã€æ¥”å­ã€‘
èŒ…è‰æ£šå…§ï¼Œé¦™ç…™ç¹šç¹ã€‚å å¤¢å¸«æ‰‹æŒéŠ€éˆï¼Œç²‰ç´…è‰²çš„å…‰å¾æ³¢æ–¯è²´å©¦çš„èƒ¸å£é€å‡ºã€‚
å°çŒ´å­è—åœ¨æˆ¿æ¢ä¸Šï¼Œç­‰å¾…æ™‚æ©Ÿã€‚ä»–æ˜¯è•ƒåŠæœ€éˆæ´»çš„å°å·ã€‚
ç•¶ä»–çš„æ‰‹æŒ‡è§¸ç¢°é‚£é¡†ç²‰ç´…å¯¶çŸ³æ™‚ï¼Œè©­ç•°çš„å¹»è±¡é–ƒéè…¦æµ·â€”â€”é®®è¡€ã€ç«ç„°ã€é‚„æœ‰ä¸€å€‹å°‘å¥³çš„è‡‰...

ã€ç¬¬ä¸€ç«  å»£å·è•ƒåŠã€‘
æ€€åœ£å¯ºçš„å…‰å¡”é«˜è³ï¼Œé‡‘é ‚åœ¨å¤•é™½ä¸‹é–ƒè€€ã€‚é€™æ˜¯å¤§å”æœ€ç¹è¯çš„æ¸¯å£ï¼Œå„åœ‹å•†äººé›²é›†æ–¼æ­¤ã€‚
ç´…é«®ç›²è€äººåœ¨æ¦•æ¨¹ä¸‹è¬›è¿°æµ·ä¸Šå‚³èªªï¼Œå­©å­å€‘åœåè†è½ã€‚ã€Œåœ¨æµ·çš„é‚£ä¸€é‚Šï¼Œæœ‰ä¸€åº§å±±ï¼Œå±±ä¸Šæœ‰åº§å¡”ï¼Œå¡”è£¡è—è‘—åƒå¹´çš„ç§˜å¯†...ã€
å°çŒ´å­ç©¿æ¢­åœ¨ç†™æ”˜çš„äººç¾¤ä¸­ï¼Œä»–çš„ç›®æ¨™æ˜¯é‚£å€‹æ³¢æ–¯å•†äººçš„éŒ¢è¢‹ã€‚ä½†ä»Šå¤©çš„æ”¶ç©«ï¼Œé æ¯”éŒ¢è¢‹é‡è¦â€”â€”é‚£é¡†æœƒç™¼å…‰çš„ç²‰ç´…å¯¶çŸ³ã€‚

ã€ç¬¬äºŒç«  å¤œæµ·å•Ÿèˆªã€‘
å¤§è•ƒèˆ¶å¦‚å·¨ç¸ï¼Œåœæ³Šåœ¨ç¢¼é ­ã€‚é€™è‰˜èˆ¹å°‡é§›å‘å—æ´‹ï¼Œè¼‰è‘—é¦™æ–™ã€çµ²ç¶¢ï¼Œé‚„æœ‰ç„¡æ•¸äººçš„å‘½é‹ã€‚
è•ƒé•·ç«™åœ¨èˆ¹é ­ï¼Œçµ¡è…®é¬åœ¨æµ·é¢¨ä¸­é£„å‹•ã€‚ã€Œé€™è¶Ÿèˆªè¡Œ...ä¸æœƒå¤ªå¹³ã€‚ã€
å°çŒ´å­è¿½å°‹å°è©è–©è »çš„èº«å½±ï¼Œä»–å¿…é ˆç™»ä¸Šé€™è‰˜èˆ¹ã€‚é‚£é¡†å¯¶çŸ³ä¼¼ä¹åœ¨å¬å–šä»–ï¼Œå‘Šè¨´ä»–çœŸç›¸åœ¨é æ–¹...

ã€ç¬¬ä¸‰ç«  é»‘å¸†è³Šèˆ¹ã€‘
æœˆå…‰ä¸‹çš„å¤§æµ·ï¼Œé è™•å‡ºç¾é»‘è‰²å¸†å½±ã€‚
ã€Œæµ·ç›œï¼ã€ç­æœ›æ‰‹çš„é©šå«è²åŠƒç ´å¤œç©ºã€‚
ã€Œæ˜¯é£Ÿäººé­”çš„èˆ¹ï¼ã€æ°´æ‰‹å€‘é©šæè¬åˆ†ã€‚å‚³èªªé€™æ”¯æµ·ç›œå¾ä¸ç•™æ´»å£ï¼Œåªå› ä»–å€‘çš„é¦–é ˜å–œæ­¡æ”¶é›†äººé ­...

ã€ç¬¬å››ç«  å¯†å®¤æ®ºäººã€‘
å¤©äº®æ™‚ï¼Œè‰™æˆ¿è£¡ç™¼ç¾äº†ç¬¬ä¸€å…·å±é«”ã€‚æ­»è€…æ˜¯èˆ¹ä¸Šçš„å¤§é£Ÿå•†äººï¼Œå–‰åš¨è¢«å‰²é–‹ï¼Œçœ¼ç›å»çœ‹è‘—æŸå€‹æ–¹å‘â€”â€”å¯¶çŸ³æ¶ˆå¤±çš„æ–¹å‘ã€‚
ã€Œå…‡æ‰‹å°±åœ¨æˆ‘å€‘ä¹‹ä¸­ã€‚ã€è•ƒé•·æ²‰è²èªªé“ã€‚
å°çŒ´å­æ¡ç·Šæ‡·ä¸­çš„å¯¶çŸ³ï¼Œå®ƒåˆé–‹å§‹ç™¼å…‰äº†...

ã€ç¬¬äº”ç«  è¼ªè¿´ä¹‹è¬ã€‘
ç•¶å°è©è–©è »é–‹å£èªªè©±æ™‚ï¼Œæ‰€æœ‰äººéƒ½éœ‡é©šäº†ã€‚å¥¹èªªçš„ä¸æ˜¯å”è¨€ï¼Œè€Œæ˜¯ä¸€ç¨®å¤è€çš„èªè¨€ï¼Œä¸€ç¨®åƒå¹´å‰å°±å·²æ¶ˆäº¡çš„èªè¨€ã€‚
ã€Œä¸€åˆ‡éƒ½å°‡é‡æ¼”...ã€å¥¹çš„çœ¼ç¥ç©ºæ´è€Œæ·±é‚ƒï¼Œã€Œå°±åƒåƒå¹´å‰ä¸€æ¨£...ã€
åœå¤¢å¸«çš„éŠ€éˆé–‹å§‹æ–æ™ƒï¼šã€Œè¼ªè¿´çš„é–éˆï¼Œå·²ç¶“é–‹å§‹æ–·è£‚...ã€`;

// ==================== åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
