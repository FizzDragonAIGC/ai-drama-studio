<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FizzDragon AIGCç•ªåŠ‡ç³»çµ±</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            /* FizzDragon å®˜ç½‘é…è‰² */
            --bg: #14141a;
            --surface: #1a1a22;
            --surface2: #22222c;
            --border: #2d2d3a;
            --text: #f0f0f5;
            --text2: #8a8a9a;
            --accent: #E31B23;      /* FizzDragon Logoçº¢ */
            --accent2: #E31B23;     /* ä¿æŒä¸€è‡´ */
            --accent-gradient: linear-gradient(135deg, #E31B23, #C41920);
            --user-bg: #1c1c24;
            --ai-bg: transparent;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }
        
        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 260px;
            height: 100vh;
            background: #0d0d12;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }
        
        .sidebar.hidden {
            transform: translateX(-100%);
            position: absolute;
        }
        
        .sidebar-header {
            padding: 20px 16px;
            border-bottom: 1px solid var(--border);
            background: #000;
        }
        
        .sidebar-logo {
            width: 100%;
            max-width: 200px;
            height: auto;
            margin-bottom: 8px;
            display: block;
        }
        
        .sidebar-tagline {
            font-size: 11px;
            color: var(--text2);
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        
        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: rgba(232, 48, 48, 0.1);
            border: none;
            border-radius: 8px;
            color: #E31B23;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .new-chat-btn:hover {
            background: rgba(232, 48, 48, 0.2);
            color: #E31B23;
        }
        
        .sidebar-section {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .sidebar-section-title {
            font-size: 11px;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 12px;
        }
        
        .project-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .project-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .project-item:hover {
            background: var(--surface);
        }
        
        .project-item.active {
            background: var(--surface2);
        }
        
        .project-item .icon {
            font-size: 16px;
        }
        
        .project-item .info {
            flex: 1;
            min-width: 0;
        }
        
        .project-item .title {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .project-item .meta {
            font-size: 11px;
            color: var(--text2);
        }
        
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
        }
        
        .beta-badge {
            text-align: center;
            padding: 10px;
            background: rgba(227, 27, 35, 0.1);
            border-radius: 8px;
            color: #E31B23;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .menu-toggle {
            background: none;
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            display: none;
        }
        
        .header-title {
            font-size: 14px;
            color: var(--text2);
        }
        
        /* 768px åª’ä½“æŸ¥è¯¢ç§»è‡³åº•éƒ¨ç»Ÿä¸€ç®¡ç† */
        
        /* é¡¶éƒ¨æ  - FizzDragoné£æ ¼ */
        .header {
            padding: 16px 24px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .header img {
            height: 24px;
            filter: brightness(1.1);
        }
        
        .logo {
            font-size: 14px;
            font-weight: 500;
            color: var(--text2);
            letter-spacing: 0.5px;
        }
        
        .status {
            margin-left: auto;
            font-size: 12px;
            color: var(--text2);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        
        .status-dot.offline { background: #ef4444; }
        .status-dot.loading { background: #E31B23; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* èŠå¤©åŒºåŸŸ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .message {
            max-width: 100%;
            padding: 8px 0;
            line-height: 1.7;
            font-size: 14px;
            border: none;
            background: transparent;
        }
        
        .message.user {
            padding-left: 20px;
            border-left: 2px solid var(--accent);
            margin-left: 20px;
        }
        
        .message.ai {
            padding-left: 0;
        }
        
        .message .role {
            font-size: 12px;
            color: var(--text2);
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .message.user .role { color: var(--accent); }
        .message.ai .role { color: #888; }
        
        .message .content { white-space: pre-wrap; }
        
        .message .content h3 {
            font-size: 14px;
            margin: 12px 0 8px;
            color: var(--accent);
        }
        
        .message .content ul {
            margin-left: 20px;
            margin-top: 8px;
        }
        
        .message .content li { margin: 4px 0; }
        
        /* å¿«æ·å›å¤ - FizzDragoné£æ ¼ */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 16px;
        }
        
        .quick-reply {
            padding: 10px 18px;
            background: rgba(232, 48, 48, 0.08);
            border: none;
            border-radius: 20px;
            color: #E31B23;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-reply:hover, .quick-reply:active {
            background: rgba(232, 48, 48, 0.2);
            color: #E31B23;
        }
        
        .quick-reply:active {
            transform: scale(0.97);
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 16px 20px;
            background: var(--bg);
            border-top: none;
        }
        
        .input-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        #userInput {
            width: 100%;
            padding: 14px 16px;
            padding-right: 100px;
            background: #1a1a1a;
            border: none;
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            resize: none;
            min-height: 48px;
            max-height: 150px;
            font-family: inherit;
        }
        
        #userInput:focus {
            outline: none;
            box-shadow: 0 0 0 1px #E31B23;
        }
        
        .input-actions {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            border: none;
        }
        
        .btn-primary:hover { 
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-upload {
            background: transparent;
            color: var(--text2);
            border: none;
        }
        
        .btn-upload:hover { color: var(--accent); }
        
        #fileInput { display: none; }
        
        /* æ‰“å­—åŠ¨ç”» */
        .typing {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }
        
        .typing span {
            width: 6px;
            height: 6px;
            background: #E31B23;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        
        /* è¿›åº¦å¡ç‰‡ */
        .progress-card {
            background: transparent;
            border: none;
            border-left: 2px solid #E31B23;
            border-radius: 0;
            padding: 12px 16px;
            margin-top: 12px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: #E31B23;
        }
        
        .progress-bar {
            height: 3px;
            background: #2d2d3a;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #E31B23;
            transition: width 0.3s;
        }
        
        /* ç»“æœå¡ç‰‡ */
        .result-card {
            background: transparent;
            border: none;
            border-left: 2px solid #333;
            border-radius: 0;
            overflow: hidden;
            margin-top: 12px;
            padding-left: 16px;
        }
        
        .result-header {
            padding: 8px 0;
            background: transparent;
            border-bottom: none;
            font-size: 13px;
            font-weight: 600;
            color: var(--text2);
        }
        
        .result-content {
            padding: 8px 0;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* ç”¨æˆ·åŠ©æ‰‹æµ®åŠ¨æŒ‰é’® */
        .help-fab {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E31B23, #B51820);
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(232, 48, 48, 0.4);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .help-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(232, 48, 48, 0.6);
        }
        
        .help-fab:active {
            transform: scale(0.95);
        }
        
        .help-fab.loading {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ==================== ç§»åŠ¨ç«¯é€‚é… ==================== */
        
        /* å¹³æ¿é€‚é… */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                z-index: 1000;
                transform: translateX(-100%);
                box-shadow: 4px 0 20px rgba(0,0,0,0.5);
            }
            .sidebar.show {
                transform: translateX(0);
            }
            .menu-toggle {
                display: flex !important;
            }
            .header-title {
                font-size: 14px;
            }
        }
        
        /* æ‰‹æœºé€‚é… */
        @media (max-width: 600px) {
            body {
                font-size: 15px;
            }
            
            /* å¤´éƒ¨ */
            .header {
                padding: 12px 16px;
                position: sticky;
                top: 0;
                z-index: 50;
            }
            .header-title {
                font-size: 13px;
                flex: 1;
                text-align: center;
            }
            .status {
                font-size: 11px;
            }
            
            /* ä¾§è¾¹æ  */
            .sidebar {
                width: 85vw;
                max-width: 300px;
            }
            .sidebar-header {
                padding: 16px;
            }
            .sidebar-logo {
                max-width: 160px;
            }
            .sidebar-tagline {
                font-size: 10px;
            }
            .new-chat-btn {
                padding: 14px;
                font-size: 15px;
            }
            
            /* èŠå¤©åŒºåŸŸ */
            .chat-container {
                padding: 12px;
                gap: 12px;
            }
            .message {
                max-width: 100%;
                padding: 12px;
                font-size: 14px;
                border-radius: 16px;
            }
            .message .role {
                font-size: 12px;
                margin-bottom: 6px;
            }
            .message .content {
                line-height: 1.7;
            }
            
            /* å¿«æ·å›å¤æŒ‰é’® */
            .quick-replies {
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 12px;
            }
            .quick-reply {
                padding: 10px 14px;
                font-size: 13px;
                border-radius: 20px;
                flex: 1 1 auto;
                min-width: 45%;
                text-align: center;
            }
            
            /* è¾“å…¥åŒºåŸŸ */
            .input-area {
                padding: 12px;
                position: sticky;
                bottom: 0;
                background: var(--bg);
                border-top: 1px solid var(--border);
            }
            .input-wrapper {
                flex-direction: column;
                gap: 10px;
            }
            #userInput {
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
                padding: 14px;
                border-radius: 12px;
                min-height: 48px;
            }
            .input-actions {
                display: flex;
                gap: 8px;
                width: 100%;
            }
            .input-actions .btn {
                flex: 1;
                padding: 12px;
                font-size: 14px;
                border-radius: 10px;
            }
            .btn-primary {
                flex: 2;
            }
            
            /* å¸®åŠ©æŒ‰é’® */
            .help-fab {
                bottom: 90px;
                right: 16px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            /* è¿›åº¦å¡ç‰‡ */
            .progress-card {
                padding: 12px;
            }
            
            /* AgentçŠ¶æ€æ  */
            #agentStatusBar {
                top: auto !important;
                bottom: 140px !important;
                left: 16px !important;
                right: 16px !important;
                transform: none !important;
                font-size: 12px;
                padding: 8px 12px;
            }
            
            /* ä¾§è¾¹æ é®ç½© */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }
            .sidebar-overlay.show {
                display: block;
            }
        }
        
        /* è¶…å°å±å¹• */
        @media (max-width: 380px) {
            .quick-reply {
                min-width: 100%;
                padding: 12px;
            }
            .header-title {
                font-size: 12px;
            }
            .sidebar {
                width: 100vw;
                max-width: none;
            }
        }
        
        /* æ¨ªå±æ‰‹æœº */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 8px 16px;
            }
            .chat-container {
                padding: 8px 16px;
            }
            .input-area {
                padding: 8px 16px;
            }
            .help-fab {
                bottom: 70px;
                width: 44px;
                height: 44px;
            }
        }
        
        /* iOSå®‰å…¨åŒºåŸŸ */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .input-area {
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ é®ç½©ï¼ˆæ‰‹æœºç«¯ç‚¹å‡»å…³é—­ï¼‰ -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    
    <!-- å·¦ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="logo.jpg" alt="FizzDragon" class="sidebar-logo">
            <div class="sidebar-tagline">è®“æ¯å€‹äººéƒ½èƒ½æ‹è‡ªå·±çš„é›»å½±</div>
            <button class="new-chat-btn" onclick="startNewProject()">+ æ–°å»ºé …ç›®</button>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-section-title">æˆ‘çš„é …ç›®</div>
            <div class="project-list" id="projectList">
                <!-- é¡¹ç›®åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div class="beta-badge">ğŸš€ å‰µä½œé©å‘½ Â· å…§æ¸¬ä¸­</div>
        </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <div class="header">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <div class="header-title" id="headerTitle">FizzDragon AIGCç•ªåŠ‡ç³»çµ±</div>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">é€£æ¥ä¸­...</span>
            </div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
        </div>
    
        <div class="input-area">
            <div class="input-row">
                <div class="input-wrapper">
                    <textarea id="userInput" placeholder="è¼¸å…¥æ¶ˆæ¯..." rows="1"></textarea>
                    <div class="input-actions">
                        <input type="file" id="fileInput" accept=".txt,.docx,.pdf">
                        <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">ğŸ“„ å°å…¥</button>
                        <button class="btn btn-primary" id="sendBtn" onclick="sendMessage()">ç™¼é€</button>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- å…³é—­ main-content -->

    <!-- ç”¨æˆ·åŠ©æ‰‹æµ®åŠ¨æŒ‰é’® -->
    <button class="help-fab" onclick="callHelpAgent()" title="é‡åˆ°å•é¡Œï¼Ÿé»æˆ‘æ±‚åŠ©">
        ğŸ†˜
    </button>

    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    
    <script>
// ==================== é…ç½® ====================
const API_ENDPOINTS = [
    '/api',
    'https://dvds-hoping-consultancy-site.trycloudflare.com/api',
    'http://34.58.33.115:3001/api'
];
let API_BASE = '/api';

// ==================== çŠ¶æ€ ====================
const state = {
    novel: null,
    novelTitle: '',
    step: 0,  // 0=ç­‰å¾…å¯¼å…¥, 1=æ¦‚å¿µ, 2=è®¿è°ˆ, 3=ç« èŠ‚, 4=è§’è‰², 5=åˆ†é•œ...
    concept: null,
    interview: {},
    interviewQuestions: [],
    currentQuestion: 0,
    chapters: null,
    characters: null,
    storyboard: null
};

// å†™ä½œçŠ¶æ€
const writeState = {
    idea: null,
    interview: {},
    outline: null,
    chapters: [],
    currentChapter: 0,
    currentQuestion: null,  // null=æœªå¼€å§‹, -1=ç­‰å¾…è¾“å…¥æ•…äº‹çµæ„Ÿ, 0+=è®¿è°ˆé—®é¢˜ç¼–å·
    storyboard: null
};

// ==================== JSONè§£æï¼ˆå¸¦è‡ªåŠ¨ä¿®å¤ï¼‰====================
function safeJSONParse(text, context = 'unknown') {
    if (!text || typeof text !== 'string') {
        console.warn(`safeJSONParse [${context}]: ç©ºè¾“å…¥`);
        return {};
    }
    
    // æ¸…ç†å¸¸è§é—®é¢˜
    let cleaned = text
        .replace(/```json\n?/g, '')
        .replace(/```\n?/g, '')
        .trim();
    
    // å°è¯•ç›´æ¥è§£æ
    try {
        return JSON.parse(cleaned);
    } catch (e) {
        console.warn(`safeJSONParse [${context}]: é¦–æ¬¡è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤...`);
    }
    
    // ä¿®å¤1: æå–JSONå¯¹è±¡/æ•°ç»„
    const jsonMatch = cleaned.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
    if (jsonMatch) {
        try {
            return JSON.parse(jsonMatch[1]);
        } catch (e) {}
    }
    
    // ä¿®å¤2: ç§»é™¤å°¾éƒ¨é€—å·
    try {
        const noTrailing = cleaned.replace(/,(\s*[\}\]])/g, '$1');
        return JSON.parse(noTrailing);
    } catch (e) {}
    
    // ä¿®å¤3: ä¿®å¤å•å¼•å·
    try {
        const doubleQuotes = cleaned.replace(/'/g, '"');
        return JSON.parse(doubleQuotes);
    } catch (e) {}
    
    console.error(`safeJSONParse [${context}]: æ‰€æœ‰ä¿®å¤å°è¯•å¤±è´¥`);
    return {};
}

// ==================== æµç¨‹å®šä¹‰ ====================
const STEPS = [
    { id: 0, name: 'å°å…¥å°èªª', agent: null },
    { id: 1, name: 'æ¦‚å¿µæå–', agent: 'concept' },
    { id: 2, name: 'å‰µæ„è¨ªè«‡', agent: 'interview' },
    { id: 3, name: 'ç« ç¯€è¦åŠƒ', agent: 'narrative' },
    { id: 4, name: 'è§’è‰²è¨­è¨ˆ', agent: 'character' },
    { id: 5, name: 'åˆ†é¡ç”Ÿæˆ', agent: 'storyboard' }
];

// ==================== å†…æµ‹æ¨¡å¼ï¼ˆæ— ç§¯åˆ†ç³»ç»Ÿï¼‰====================
const MEMBERSHIP = {
    free: { name: 'å…§æ¸¬ç‰ˆ', maxProjects: 999, icon: 'ğŸ‰' }
};

let currentUser = {
    id: localStorage.getItem('user_id') || 'guest_' + Date.now(),
    plan: 'free'
};

function initUser() {
    localStorage.setItem('user_id', currentUser.id);
}

function updateUserUI() {
    // å†…æµ‹ç‰ˆä¸éœ€è¦æ›´æ–°UI
}

// ==================== ä¾§è¾¹æ  ====================
let currentProjectId = null;

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.toggle('show');
    overlay.classList.toggle('show');
}

function renderProjectList() {
    const projects = getProjects();
    const list = Object.values(projects).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    const container = document.getElementById('projectList');
    
    if (list.length === 0) {
        container.innerHTML = '<div style="padding:12px;color:var(--text2);font-size:12px;">é‚„æ²’æœ‰é …ç›®</div>';
        return;
    }
    
    container.innerHTML = list.map((p) => {
        const isActive = p.id === currentProjectId;
        const chapters = p.chapters?.length || 0;
        const icon = p.stage === 'write' ? 'âœï¸' : 'ğŸ“„';
        
        return `
            <div class="project-item ${isActive ? 'active' : ''}" 
                 onclick="openProject('${p.id}')">
                <div class="icon">${icon}</div>
                <div class="info">
                    <div class="title">${p.name || 'æœªå‘½å'}</div>
                    <div class="meta">${chapters}ç«  Â· ${new Date(p.timestamp).toLocaleDateString()}</div>
                </div>
            </div>
        `;
    }).join('');
}

function openProject(projectId) {
    currentProjectId = projectId;
    renderProjectList();
    loadProject(projectId);
    
    // æ›´æ–°æ ‡é¢˜
    const projects = getProjects();
    const p = projects[projectId];
    if (p) {
        document.getElementById('headerTitle').textContent = p.name || 'FizzDragon AIGCç•ªåŠ‡ç³»çµ±';
    }
    
    // ç§»åŠ¨ç«¯å…³é—­ä¾§è¾¹æ 
    if (window.innerWidth <= 768) {
        toggleSidebar();
    }
}

function startNewProject() {
    console.log('startNewProject called');
    
    // æ¸…ç©ºå½“å‰çŠ¶æ€
    currentProjectId = null;
    state.novel = null;
    state.novelTitle = '';
    state.step = 0;
    state.mode = null;
    writeState.idea = null;
    writeState.outline = null;
    writeState.chapters = [];
    writeState.currentQuestion = null;
    
    // æ¸…ç©ºèŠå¤©
    document.getElementById('chatContainer').innerHTML = '';
    document.getElementById('headerTitle').textContent = 'FizzDragon AIGCç•ªåŠ‡ç³»çµ±';
    
    // æ˜¾ç¤ºæ¬¢è¿
    showStartOptions();
    renderProjectList();
    
    // ç§»åŠ¨ç«¯å…³é—­ä¾§è¾¹æ 
    if (window.innerWidth <= 768) {
        toggleSidebar();
    }
}

// ==================== åˆå§‹åŒ– ====================
async function init() {
    // åˆå§‹åŒ–ç”¨æˆ·å’Œä¾§è¾¹æ 
    initUser();
    renderProjectList();
    
    await detectAPI();
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„è¿›åº¦
    const saved = loadProgress();
    if (saved && saved.outline) {
        addAIMessage(`ğŸ‘‹ æ­¡è¿å›ä¾†ï¼

ç™¼ç¾ä¸Šæ¬¡çš„å‰µä½œé€²åº¦ï¼š
**ã€Š${saved.outline?.title || 'æœªå‘½å'}ã€‹**
- éšæ®µï¼š${saved.stage}
- æ™‚é–“ï¼š${new Date(saved.timestamp).toLocaleString()}
- å·²å®Œæˆï¼š${saved.chapters?.length || 0} ç« 

è¦ç¹¼çºŒå—ï¼Ÿ`, [
            { text: 'â–¶ï¸ ç¹¼çºŒå‰µä½œ', action: () => resumeProgress(saved) },
            { text: 'ğŸ†• é–‹å§‹æ–°é …ç›®', action: () => showStartOptions() }
        ]);
        return;
    }
    
    showStartOptions();
}

function showStartOptions() {
    console.log('ğŸ  showStartOptions called, current state:', { mode: state.mode, step: state.step });
    const projects = getProjects();
    const projectCount = Object.keys(projects).length;
    
    let buttons = [
        { text: 'ğŸ“„ å°å…¥å°èªª', action: () => document.getElementById('fileInput').click() },
        { text: 'âœï¸ å‰µä½œå°èªª', action: () => startWriteMode() }
    ];
    
    if (projectCount > 0) {
        buttons.push({ text: `ğŸ“‚ é …ç›®åˆ—è¡¨ (${projectCount})`, action: () => showProjectList() });
    }
    
    buttons.push({ text: 'ğŸ“š æŸ¥çœ‹å­¸ç¿’è³‡æº', action: () => showLearningResources() });
    
    addAIMessage(`âœ¨ **æ­¡è¿ä¾†åˆ° FizzDragon AIGCç•ªåŠ‡ç³»çµ±**

**è®“æ¯å€‹äººéƒ½èƒ½æ‹å‡ºè‡ªå·±çš„é›»å½±ã€‚**

å¥½èŠå¡¢ç”¨1å„„ç¾å…ƒæ‹ä¸€éƒ¨é›»å½±ï¼Œ
æˆ‘å€‘è®“ä½ ç”¨ä¸€å°é›»è…¦å®ŒæˆåŒæ¨£çš„å‰µä½œã€‚

> ğŸ¬ 100+æœ¬å¤§å¸«è‘—ä½œ | é›»å½±ç´šåˆ†é¡ | ä¸€éµAIç”Ÿåœ–
> ğŸŒŸ McKeeÃ—CampbellÃ—Hitchcock æ™ºæ…§æ³¨å…¥
> ğŸš€ å¾æ•…äº‹åˆ°åˆ†é¡ï¼Œ30åˆ†é˜å®Œæˆ

**é€™ä¸æ˜¯å·¥å…·ï¼Œé€™æ˜¯å‰µä½œé©å‘½ã€‚**

${projectCount > 0 ? `\nğŸ“‚ å·²ä¿å­˜ **${projectCount}** å€‹é …ç›®` : ''}`, buttons);
}

function showLearningResources() {
    addAIMessage(`ğŸ“š **FizzDragon å­¸ç¿’è³‡æºåº«**

**æ•˜äº‹çµæ§‹å¤§å¸«**
â€¢ Robert McKeeã€Šæ•…äº‹ã€‹- åƒ¹å€¼è½‰æ›ç†è«–
â€¢ John Trubyã€ŠThe Anatomy of Storyã€‹- 22æ­¥çµæ§‹
â€¢ Joseph Campbellã€Šåƒé¢è‹±é›„ã€‹- è‹±é›„ä¹‹æ—…
â€¢ Christopher Voglerã€Šä½œå®¶ä¹‹è·¯ã€‹- 12éšæ®µæ—…ç¨‹
â€¢ Blake Snyderã€ŠSave the Catã€‹- 15ç¯€æ‹è¡¨
â€¢ Syd Fieldã€ŠScreenplayã€‹- ä¸‰å¹•åŠ‡çµæ§‹

**è§’è‰²è¨­è¨ˆç†è«–**
â€¢ K.M. Weilandã€ŠCreating Character Arcsã€‹
â€¢ Tom Bancroftã€ŠCreating Characters with Personalityã€‹
â€¢ å¿ƒç†å­¸å‹•æ©Ÿç†è«– - æ¬²æœ›/å‰µå‚·/å¼§ç·š

**è¦–è¦ºæ•˜äº‹**
â€¢ Steven D. Katzã€ŠFilm Directing Shot by Shotã€‹
â€¢ Gustavo Mercadoã€ŠThe Filmmaker's Eyeã€‹
â€¢ Francis Glebasã€ŠDirecting the Storyã€‹

**å¤§å¸«è¨ªè«‡**
â€¢ Hitchcock/Truffaut é›»å½±è¨ªè«‡éŒ„
â€¢ Aaron Sorkin MasterClass
â€¢ å®®å´é§¿å‰µä½œç­†è¨˜

**æ–‡åŒ–é¢¨æ ¼**
â€¢ ä¸­åœ‹é›»å½±ç¾å­¸ - ç‹å®¶è¡›ã€æå®‰ã€ä¾¯å­è³¢
â€¢ æ—¥æœ¬å‹•ç•« - å®®å´é§¿ã€æ–°æµ·èª 
â€¢ å¥½èŠå¡¢ç¶“å…¸ - Spielbergã€Nolan
â€¢ æ­æ´²è—è¡“é›»å½± - Felliniã€Bergman

å…± **100+** æœ¬å°ˆæ¥­æ›¸ç±èå…¥ç³»çµ±ã€‚`, [
        { text: 'ğŸ”™ è¿”å›', action: () => showStartOptions() }
    ]);
}

function resumeProgress(saved) {
    // æ¢å¤çŠ¶æ€
    writeState.idea = saved.idea;
    writeState.interview = saved.interview;
    writeState.outline = saved.outline;
    writeState.chapters = saved.chapters || [];
    writeState.storyboard = saved.storyboard;
    state.mode = 'write';
    
    const chs = saved.outline?.chapters || [];
    const completed = saved.chapters?.length || 0;
    
    if (completed >= chs.length) {
        addAIMessage(`âœ… å°èªªå·²å…¨éƒ¨å®Œæˆï¼

**ã€Š${saved.outline?.title}ã€‹** - ${completed} ç« 

æ¥ä¸‹ä¾†ï¼š`, [
            { text: 'ğŸ¬ è½‰æ›åˆ†é¡', action: () => convertToStoryboard() },
            { text: 'ğŸ“¥ å°å‡ºå°èªª', action: () => exportNovel() },
            { text: 'ğŸ“¥ å°å‡ºExcel', action: () => exportExcel() }
        ]);
    } else {
        writeState.currentChapter = completed;
        addAIMessage(`â–¶ï¸ ç¹¼çºŒå‰µä½œã€Š${saved.outline?.title}ã€‹

**é€²åº¦**: ${completed}/${chs.length} ç« 
**ä¸‹ä¸€ç« **: ç¬¬${completed + 1}ç«  ${chs[completed]?.title || ''}`, [
            { text: `ğŸ“ ç¹¼çºŒå¯«ç¬¬${completed + 1}ç« `, action: () => writeNextChapter() },
            { text: 'ğŸ“– æŸ¥çœ‹å¤§ç¶±', action: () => showOutline() },
            { text: 'ğŸ“¥ å°å‡ºå·²å®Œæˆ', action: () => exportNovel() }
        ]);
    }
}

function showOutline() {
    const o = writeState.outline;
    const chs = o?.chapters || [];
    
    addAIMessage(`ğŸ“ **æ•…äº‹å¤§ç¶±**

**ã€Š${o?.title || 'æœªå‘½å'}ã€‹**
${o?.logline || ''}

---

${chs.map((c, i) => {
    const done = writeState.chapters[i] ? 'âœ…' : 'â¬œ';
    return `${done} ç¬¬${c.number}ç«  ${c.title}`;
}).join('\n')}`);
}

// ==================== APIæ£€æµ‹ ====================
async function detectAPI() {
    setStatus('loading', 'é€£æ¥ä¸­...');
    
    for (const endpoint of API_ENDPOINTS) {
        try {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 3000);
            const res = await fetch(`${endpoint}/health`, { signal: controller.signal });
            if (res.ok) {
                API_BASE = endpoint;
                setStatus('online', 'DeepSeek å·²é€£æ¥');
                console.log('API:', endpoint);
                return;
            }
        } catch (e) {}
    }
    setStatus('offline', 'é€£æ¥å¤±æ•—');
}

function setStatus(status, text) {
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    dot.className = 'status-dot ' + (status === 'online' ? '' : status === 'loading' ? 'loading' : 'offline');
    txt.textContent = text;
}

// ==================== å‰µä½œæ¨¡å¼ ====================
// å†™ä½œè®¿è°ˆé—®é¢˜
const WRITE_QUESTIONS = [
    'é€™å€‹æ•…äº‹æƒ³å‚³é”ä»€éº¼æ ¸å¿ƒä¸»é¡Œæˆ–æƒ…æ„Ÿï¼Ÿ',
    'ä¸»è§’æ˜¯ä»€éº¼æ¨£çš„äººï¼Ÿæœ‰ä»€éº¼ç‰¹é»å’Œå¼±é»ï¼Ÿ',
    'ä¸»è§’é¢è‡¨çš„æœ€å¤§æŒ‘æˆ°æˆ–è¡çªæ˜¯ä»€éº¼ï¼Ÿ',
    'æ•…äº‹ç™¼ç”Ÿåœ¨ä»€éº¼æ™‚ä»£å’Œåœ°é»ï¼Ÿæœ‰ä»€éº¼ç¨ç‰¹æ°›åœï¼Ÿ',
    'ä½ å¸Œæœ›è§€çœ¾çœ‹å®Œå¾Œæœ‰ä»€éº¼æ„Ÿå—ï¼Ÿ',
    'æ•…äº‹å¤§æ¦‚è¦å¤šé•·ï¼Ÿï¼ˆçŸ­ç¯‡10ç« /ä¸­ç¯‡30ç« /é•·ç¯‡50-100ç« ï¼‰',
    'æœ‰åƒè€ƒçš„ä½œå“é¢¨æ ¼å—ï¼Ÿï¼ˆé›»å½±ã€åŠ‡é›†ã€å°èªªï¼‰',
    'æœ‰ç‰¹åˆ¥æƒ³åŠ å…¥çš„å ´æ™¯æˆ–æƒ…ç¯€å—ï¼Ÿ',
    'ä¸»è¦é…è§’æœ‰å“ªäº›ï¼Ÿå’Œä¸»è§’æ˜¯ä»€éº¼é—œä¿‚ï¼Ÿ',
    'æ•…äº‹æœ‰ä»€éº¼ç¨ç‰¹çš„ä¸–ç•Œè§€è¨­å®šå—ï¼Ÿ'
];

function startWriteMode() {
    // æ£€æŸ¥æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„å·¥ä½œ
    if (hasActiveWork()) {
        confirmResetAndImport(() => {
            document.getElementById('chatContainer').innerHTML = '';
            doStartWriteMode();
        });
        return;
    }
    doStartWriteMode();
}

function doStartWriteMode() {
    state.mode = 'write';
    writeState.currentQuestion = -1;
    
    addAIMessage(`âœï¸ **å‰µä½œæ¨¡å¼**

è®“æˆ‘å€‘ä¸€èµ·å‰µä½œä½ çš„æ•…äº‹ï¼

é¦–å…ˆï¼Œç°¡å–®æè¿°ä½ çš„**æ•…äº‹éˆæ„Ÿ**ï¼š
- å¯ä»¥æ˜¯ä¸€å¥è©±æ¦‚å¿µ
- å¯ä»¥æ˜¯ä¸€å€‹å ´æ™¯
- å¯ä»¥æ˜¯ä¸€å€‹è§’è‰²

æ¯”å¦‚ï¼šã€Œä¸€å€‹é¦™æ¸¯ç´…Vanå¸æ©Ÿï¼Œå‡Œæ™¨è¼‰å®¢æ™‚é‡åˆ°å¥‡æ€ªçš„ä¹˜å®¢ã€`, [
        { text: 'ğŸ² å¹«æˆ‘éš¨æ©Ÿç”Ÿæˆ', action: () => randomIdea() },
        { text: 'ğŸ“š çœ‹ç¯„ä¾‹', action: () => showExamples() }
    ]);
}

async function randomIdea() {
    addTypingIndicator();
    
    try {
        const result = await callAgent('concept', 'è«‹éš¨æ©Ÿç”Ÿæˆä¸€å€‹æœ‰è¶£çš„çŸ­åŠ‡æ•…äº‹éˆæ„Ÿï¼Œé¡å‹å¯ä»¥æ˜¯éˆç•°ã€æ„›æƒ…ã€æ‡¸ç–‘ã€å¥‡å¹»ç­‰ï¼ŒèƒŒæ™¯è¨­å®šåœ¨é¦™æ¸¯ã€‚è¼¸å‡ºJSONæ ¼å¼ï¼š{genre, setting, premise, hook}');
        removeTypingIndicator();
        
        const idea = safeJSONParse(result.replace(/```json\n?/g, '').replace(/```/g, ''), 'randomIdea');
        writeState.idea = idea;
        
        addAIMessage(`ğŸ² **éš¨æ©Ÿéˆæ„Ÿ**

**é¡å‹**: ${idea.genre || 'å¾…å®š'}
**èƒŒæ™¯**: ${idea.setting || 'å¾…å®š'}  
**æ•…äº‹**: ${idea.premise || idea.logline || 'å¾…å®š'}
**äº®é»**: ${idea.hook || 'å¾…å®š'}

å–œæ­¡é€™å€‹æ–¹å‘å—ï¼Ÿ`, [
            { text: 'ğŸ‘ å°±é€™å€‹ï¼', action: () => startWriteInterview() },
            { text: 'ğŸ² æ›ä¸€å€‹', action: () => randomIdea() },
            { text: 'âœï¸ æˆ‘ä¾†æ”¹', action: () => {} }
        ]);
    } catch (err) {
        removeTypingIndicator();
        recordError(err, 'éš¨æ©Ÿéˆæ„Ÿ');
        showFriendlyError(err, 'éš¨æ©Ÿéˆæ„Ÿ', () => randomIdea());
    }
}

function showExamples() {
    addAIMessage(`ğŸ“š **æ•…äº‹ç¯„ä¾‹**

**éˆç•°é¡** ğŸ”®
ã€Œæ·±å¤œé£Ÿå ‚çš„è€é—†ä¸ƒå”ï¼Œå°ˆé–€æ‹›å¾…é‚£äº›...å·²ç¶“ä¸åœ¨äººä¸–çš„å®¢äººã€

**æ„›æƒ…é¡** ğŸ’•
ã€Œå¥¹æ¯å¤©æ­åŒä¸€ç­æ¸¯éµï¼Œæš—æˆ€è»Šå»‚è£¡çœ‹æ›¸çš„ç”·ç”Ÿï¼Œç›´åˆ°æœ‰ä¸€å¤©ç™¼ç¾ä»–çœ‹çš„æ˜¯å¥¹å¯«çš„å°èªªã€

**æ‡¸ç–‘é¡** ğŸ”
ã€Œå»ºç¯‰å¸«ç™¼ç¾è‡ªå·±è¨­è¨ˆçš„å¤§æ¨“è£¡ï¼Œæœ‰ä¸€å±¤ä¸å­˜åœ¨æ–¼åœ–ç´™ä¸Šçš„æ¨“å±¤ã€

**å¥‡å¹»é¡** âœ¨
ã€Œé¦™æ¸¯æœ€å¾Œä¸€å€‹é¢¨æ°´å¸«çš„å­«å¥³ï¼Œæ„å¤–ç¹¼æ‰¿äº†èƒ½çœ‹è¦‹åŸå¸‚é¾è„ˆçš„èƒ½åŠ›ã€

é¸ä¸€å€‹é–‹å§‹ï¼Œæˆ–è¼¸å…¥ä½ è‡ªå·±çš„æƒ³æ³•ï¼š`, [
        { text: 'ğŸ”® æ·±å¤œé£Ÿå ‚', action: () => useExample('æ·±å¤œé£Ÿå ‚çš„è€é—†ä¸ƒå”ï¼Œå°ˆé–€æ‹›å¾…é‚£äº›å·²ç¶“ä¸åœ¨äººä¸–çš„å®¢äºº', 'éˆç•°') },
        { text: 'ğŸ’• æ¸¯éµæ„›æƒ…', action: () => useExample('å¥¹æ¯å¤©æ­åŒä¸€ç­æ¸¯éµï¼Œæš—æˆ€è»Šå»‚è£¡çœ‹æ›¸çš„ç”·ç”Ÿ', 'æ„›æƒ…') },
        { text: 'ğŸ” ç¥ç§˜æ¨“å±¤', action: () => useExample('å»ºç¯‰å¸«ç™¼ç¾è‡ªå·±è¨­è¨ˆçš„å¤§æ¨“è£¡ï¼Œæœ‰ä¸€å±¤ä¸å­˜åœ¨æ–¼åœ–ç´™ä¸Šçš„æ¨“å±¤', 'æ‡¸ç–‘') }
    ]);
}

function useExample(premise, genre) {
    addUserMessage(premise);
    writeState.idea = { premise, genre };
    startWriteInterview();
}

// ==================== å†™ä½œè®¿è°ˆ ====================
function startWriteInterview() {
    writeState.currentQuestion = 0;
    writeState.interview = {};
    
    addAIMessage(`å¥½çš„ï¼ç¾åœ¨è®“æˆ‘äº†è§£æ›´å¤šç´°ç¯€ï¼Œé€™æœƒå¹«åŠ©æˆ‘å¯«å‡ºæ›´ç¬¦åˆä½ æƒ³æ³•çš„æ•…äº‹ã€‚

ğŸ¤ **å‰µä½œè¨ªè«‡** (${WRITE_QUESTIONS.length} å€‹å•é¡Œ)

æ¯å€‹å•é¡Œå¯ä»¥è©³ç´°å›ç­”ï¼Œä¹Ÿå¯ä»¥è¼¸å…¥ã€Œè·³éã€ã€‚`);
    
    setTimeout(() => askWriteQuestion(), 500);
}

function askWriteQuestion() {
    if (writeState.currentQuestion >= WRITE_QUESTIONS.length) {
        finishWriteInterview();
        return;
    }
    
    const q = WRITE_QUESTIONS[writeState.currentQuestion];
    const num = writeState.currentQuestion + 1;
    
    addAIMessage(`ğŸ¤ **å•é¡Œ ${num}/${WRITE_QUESTIONS.length}**

${q}`, [
        { text: 'è·³éé€™é¡Œ', action: () => { writeState.interview[writeState.currentQuestion] = '(è·³é)'; writeState.currentQuestion++; askWriteQuestion(); } },
        { text: 'çµæŸè¨ªè«‡ï¼Œé–‹å§‹å¯«', action: () => finishWriteInterview() }
    ]);
}

async function finishWriteInterview() {
    addAIMessage(`âœ… è¨ªè«‡å®Œæˆï¼

ç¾åœ¨æˆ‘ä¾†ç”Ÿæˆ**æ•…äº‹å¤§ç¶±**å’Œ**ç« ç¯€è¦åŠƒ**...`);
    
    await generateOutline();
}

// ==================== ç”Ÿæˆå¤§çº² ====================
async function generateOutline() {
    addProgressCard('ç”Ÿæˆæ•…äº‹å¤§ç¶±', 0);
    
    try {
        const context = {
            idea: writeState.idea,
            interview: writeState.interview
        };
        
        const prompt = `æ ¹æ“šä»¥ä¸‹å‰µä½œè€…è¨ªè«‡ï¼Œç”Ÿæˆä¸€å€‹å®Œæ•´çš„æ•…äº‹å¤§ç¶±ã€‚

æ•…äº‹éˆæ„Ÿï¼š${JSON.stringify(writeState.idea)}
å‰µä½œè€…å›ç­”ï¼š${JSON.stringify(writeState.interview)}

è«‹è¼¸å‡ºJSONæ ¼å¼ï¼š
{
  "title": "æ•…äº‹æ¨™é¡Œ",
  "logline": "ä¸€å¥è©±æ¦‚æ‹¬",
  "genre": "é¡å‹",
  "setting": "èƒŒæ™¯è¨­å®š",
  "theme": "æ ¸å¿ƒä¸»é¡Œ",
  "chapters": [
    {"number": 1, "title": "ç« ç¯€æ¨™é¡Œ", "summary": "åŠ‡æƒ…æ¦‚è¦ï¼ˆ50å­—ï¼‰", "hook": "ç« ç¯€äº®é»"}
  ]
}

è¦æ±‚ï¼š
- æ ¹æ“šæ•…äº‹è¤‡é›œåº¦ï¼Œå¯ä»¥10-100ç« 
- æ¯ç« æœ‰æ˜ç¢ºçš„åŠ‡æƒ…æ¨é€²
- æ¯5-10ç« ä¸€å€‹å°é«˜æ½®
- çµå°¾è¦æœ‰å¤§é«˜æ½®å’Œæ”¶å°¾
- å¦‚æœæ˜¯é•·ç¯‡ï¼Œå…ˆè¦åŠƒå¤§ç¶±çµæ§‹ï¼ˆåºå¹•/é–‹ç«¯/ç™¼å±•/é«˜æ½®/çµå±€ï¼‰`;
        
        updateProgress(30);
        const result = await callAgent('narrative', prompt, context);
        updateProgress(100);
        
        writeState.outline = safeJSONParse(result.replace(/```json\n?/g, '').replace(/```/g, ''), 'outline');
        
        removeProgressCard();
        
        const o = writeState.outline;
        const chs = o.chapters || [];
        
        addAIMessage(`ğŸ“ **æ•…äº‹å¤§ç¶±**

**ã€Š${o.title || 'æœªå‘½å'}ã€‹**
${o.logline || ''}

**é¡å‹**: ${o.genre || 'å¾…å®š'}
**èƒŒæ™¯**: ${o.setting || 'å¾…å®š'}
**ä¸»é¡Œ**: ${o.theme || 'å¾…å®š'}

---

**ç« ç¯€è¦åŠƒ** (å…±${chs.length}ç« )ï¼š

${chs.slice(0, 5).map(c => `**ç¬¬${c.number}ç«  ${c.title}**\n${c.summary}`).join('\n\n')}
${chs.length > 5 ? `\n\n...é‚„æœ‰ ${chs.length - 5} ç« ` : ''}

---

ç¢ºèªå¤§ç¶±å¾Œï¼Œæˆ‘æœƒ**é€ç« å¯«ä½œ**ã€‚`, [
            { text: 'âœ… é–‹å§‹å¯«ç¬¬1ç« ', action: () => startWritingChapters() },
            { text: 'ğŸ“ èª¿æ•´å¤§ç¶±', action: () => showAdjustWarning('outline', 3) },
            { text: 'ğŸ’¾ ä¿å­˜å¤§ç¶±', action: () => saveProgress('outline') }
        ]);
        
    } catch (err) {
        removeProgressCard();
        recordError(err, 'å¤§ç¶±ç”Ÿæˆ');
        showFriendlyError(err, 'å¤§ç¶±ç”Ÿæˆ', () => generateOutline());
    }
}

// ==================== é€ç« å†™ä½œ ====================
async function startWritingChapters() {
    writeState.currentChapter = 0;
    writeState.chapters = [];
    await writeNextChapter();
}

async function writeNextChapter() {
    const outline = writeState.outline;
    const chs = outline.chapters || [];
    
    if (writeState.currentChapter >= chs.length) {
        finishWriting();
        return;
    }
    
    const ch = chs[writeState.currentChapter];
    const num = writeState.currentChapter + 1;
    const total = chs.length;
    
    addProgressCard(`å¯«ä½œç¬¬${num}ç« ï¼š${ch.title}`, 0);
    
    try {
        // ========== æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»º ==========
        
        // 1. æ•…äº‹å¤§çº²ï¼ˆç²¾ç®€ç‰ˆï¼‰
        const outlineContext = `ã€æ•…äº‹å¤§ç¶±ã€‘
æ¨™é¡Œï¼š${outline.title}
é¡å‹ï¼š${outline.genre || ''}
ä¸»é¡Œï¼š${outline.theme || ''}
ä¸€å¥è©±ï¼š${outline.logline || ''}`;
        
        // 2. äººç‰©å°ä¼ ï¼ˆå¦‚æœæœ‰ï¼‰
        let characterContext = '';
        if (state.characters?.characters) {
            const mainChars = state.characters.characters.slice(0, 3);
            characterContext = `\nã€ä¸»è¦äººç‰©ã€‘\n` + mainChars.map(c => 
                `${c.name}(${c.role || 'è§’è‰²'}): ${c.psychology?.want || ''} / ${c.psychology?.wound || ''}`
            ).join('\n');
        }
        
        // 3. å‰æ–‡å›é¡¾ï¼ˆæœ€è¿‘2-3ç« çš„ç»“å°¾ï¼‰
        let prevContext = '';
        if (writeState.chapters.length > 0) {
            const recentChapters = writeState.chapters.slice(-3);
            prevContext = `\nã€å‰æƒ…å›é¡§ã€‘\n` + recentChapters.map(c => {
                const ending = c.content.slice(-800);  // å–æ¯ç« æœ€å800å­—
                return `ç¬¬${c.number}ç« ã€Š${c.title}ã€‹çµå°¾ï¼š\n${ending}`;
            }).join('\n---\n');
        }
        
        // 4. å‰åç« èŠ‚é¢„è§ˆ
        let surroundingContext = '\nã€ç« ç¯€è„ˆçµ¡ã€‘\n';
        if (num > 1) {
            const prevCh = chs[num - 2];
            surroundingContext += `ä¸Šä¸€ç« (${num-1})ï¼š${prevCh.title} - ${prevCh.summary}\n`;
        }
        surroundingContext += `â–¶ æœ¬ç« (${num})ï¼š${ch.title} - ${ch.summary}\n`;
        if (num < total) {
            const nextCh = chs[num];
            surroundingContext += `ä¸‹ä¸€ç« (${num+1})ï¼š${nextCh.title} - ${nextCh.summary}\n`;
        }
        surroundingContext += `ç« ç¯€äº®é»ï¼š${ch.hook || 'ç„¡'}`;
        
        // 5. æ„å»ºå®Œæ•´prompt
        const prompt = `ä½ æ˜¯å°ˆæ¥­å°èªªä½œå®¶ã€‚è«‹æ’°å¯«ç¬¬${num}ç« ï¼ˆå…±${total}ç« ï¼‰ã€‚

${outlineContext}
${characterContext}
${surroundingContext}
${prevContext ? prevContext.substring(0, 2000) : ''}

ã€å¯«ä½œè¦æ±‚ã€‘
- å­—æ•¸ï¼š1500-2500å­—
- åŒ…å«å ´æ™¯æå¯«ã€å°è©±ã€å¿ƒç†æ´»å‹•
- ä¿æŒäººç‰©æ€§æ ¼ä¸€è‡´
- æ‰¿æ¥ä¸Šæ–‡ï¼Œé‹ªå¢Šä¸‹æ–‡
- ç« ç¯€çµå°¾ç•™æ‡¸å¿µæˆ–æƒ…æ„Ÿé«˜æ½®
- ç›´æ¥è¼¸å‡ºæ­£æ–‡ï¼Œä¸è¦æ¨™é¡Œå’Œè§£é‡‹`;

        updateProgress(50);
        const result = await callAgent('screenwriter', prompt);
        updateProgress(100);
        
        // ä¿å­˜ç« èŠ‚
        writeState.chapters.push({
            number: num,
            title: ch.title,
            content: result,
            timestamp: new Date().toISOString()
        });
        
        // ========== è‡ªåŠ¨ä¿å­˜ ==========
        autoSaveProject();
        
        removeProgressCard();
        
        const wordsWritten = result.length;
        const totalWords = writeState.chapters.reduce((sum, c) => sum + c.content.length, 0);
        
        addAIMessage(`âœ… **ç¬¬${num}ç« ã€Š${ch.title}ã€‹** å®Œæˆï¼

${result.substring(0, 400)}...

---
ğŸ“Š æœ¬ç«  ${wordsWritten} å­— | ç¸½è¨ˆ ${totalWords.toLocaleString()} å­—
ğŸ“ˆ é€²åº¦ ${num}/${total} ç«  (${Math.round(num/total*100)}%)`, [
            { text: `â–¶ï¸ ç¹¼çºŒç¬¬${num + 1}ç« `, action: () => { writeState.currentChapter++; writeNextChapter(); } },
            { text: 'ğŸ“– é–±è®€å…¨æ–‡', action: () => showChapterContent(num) },
            { text: 'âœï¸ ä¿®æ”¹æœ¬ç« ', action: () => editChapter(num) },
            { text: 'â¸ï¸ æš«åœ', action: () => pauseWriting() }
        ]);
        
    } catch (err) {
        removeProgressCard();
        // ä¿å­˜å·²æœ‰è¿›åº¦
        autoSaveProject();
        const info = friendlyError(err, 'ç« ç¯€å¯«ä½œ');
        addAIMessage(`${info.title} - ç¬¬${num}ç« 

**å¯èƒ½åŸå› **: ${info.reason}

âœ… **å¥½æ¶ˆæ¯**: å·²è‡ªå‹•ä¿å­˜å‰${num-1}ç« çš„é€²åº¦ï¼

**å»ºè­°**:
${info.solutions.slice(0, 2).map(s => `â€¢ ${s}`).join('\n')}`, [
            { text: 'ğŸ”„ é‡è©¦æœ¬ç« ', action: () => writeNextChapter() },
            { text: 'ğŸ“‚ æŸ¥çœ‹å·²ä¿å­˜é …ç›®', action: () => showProjectList() }
        ]);
    }
}

// è‡ªåŠ¨ä¿å­˜ï¼ˆé™é»˜ï¼‰
function autoSaveProject() {
    const projects = getProjects();
    const projectName = writeState.outline?.title || `é …ç›®_${Date.now()}`;
    const projectId = projectName.replace(/\s+/g, '_').toLowerCase();
    
    projects[projectId] = {
        id: projectId,
        name: projectName,
        stage: 'write',
        timestamp: new Date().toISOString(),
        idea: writeState.idea,
        interview: writeState.interview,
        outline: writeState.outline,
        chapters: writeState.chapters,
        writeStoryboard: writeState.storyboard,
        novel: state.novel,
        novelTitle: state.novelTitle,
        concept: state.concept,
        characters: state.characters
    };
    
    localStorage.setItem(PROJECTS_KEY, JSON.stringify(projects));
    console.log(`ğŸ’¾ è‡ªå‹•ä¿å­˜: ${projectName} (${writeState.chapters.length}ç« )`);
}

// æ˜¾ç¤ºç« èŠ‚å†…å®¹
function showChapterContent(num) {
    const ch = writeState.chapters.find(c => c.number === num);
    if (!ch) return;
    
    addAIMessage(`ğŸ“– **ç¬¬${num}ç« ã€Š${ch.title}ã€‹**

${ch.content}

---
å­—æ•¸ï¼š${ch.content.length}`, [
        { text: 'âœï¸ ä¿®æ”¹', action: () => editChapter(num) },
        { text: 'ğŸ”™ è¿”å›', action: () => {} }
    ]);
}

// ç¼–è¾‘ç« èŠ‚
function editChapter(num) {
    const ch = writeState.chapters.find(c => c.number === num);
    if (!ch) return;
    
    addAIMessage(`âœï¸ **ç·¨è¼¯ç¬¬${num}ç« **

è«‹ç›´æ¥è¼¸å…¥ä¿®æ”¹æ„è¦‹æˆ–æ–°çš„å…§å®¹ï¼š
- è¼¸å…¥ã€Œé‡å¯«ã€- é‡æ–°ç”Ÿæˆæ•´ç« 
- è¼¸å…¥ä¿®æ”¹æ„è¦‹ - AIå¹«ä½ ä¿®æ”¹
- ç›´æ¥è²¼ä¸Šæ–°å…§å®¹ - æ›¿æ›æ•´ç« `, [
        { text: 'ğŸ”„ é‡å¯«æ•´ç« ', action: () => rewriteChapter(num) },
        { text: 'ğŸ”™ å–æ¶ˆ', action: () => {} }
    ]);
    
    // è®¾ç½®ç¼–è¾‘çŠ¶æ€
    state.editingChapter = num;
}

async function rewriteChapter(num) {
    // åˆ é™¤è¿™ç« ï¼Œé‡æ–°å†™
    writeState.chapters = writeState.chapters.filter(c => c.number !== num);
    writeState.currentChapter = num - 1;
    await writeNextChapter();
}

function pauseWriting() {
    saveProgress('chapters');
    addAIMessage(`â¸ï¸ å·²æš«åœå¯«ä½œ

**é€²åº¦**: ${writeState.chapters.length}/${writeState.outline?.chapters?.length || 0} ç« å·²å®Œæˆ

éš¨æ™‚å¯ä»¥ç¹¼çºŒï¼š`, [
        { text: 'â–¶ï¸ ç¹¼çºŒå¯«ä½œ', action: () => { writeState.currentChapter++; writeNextChapter(); } },
        { text: 'ğŸ¬ å…ˆç”Ÿæˆåˆ†é¡', action: () => convertToStoryboard() },
        { text: 'ğŸ“¥ å°å‡ºå·²å®Œæˆç« ç¯€', action: () => exportNovel() }
    ]);
}

function finishWriting() {
    const totalWords = writeState.chapters.reduce((sum, c) => sum + c.content.length, 0);
    
    addAIMessage(`ğŸ‰ **å°èªªå¯«ä½œå®Œæˆï¼**

**ã€Š${writeState.outline?.title || 'æœªå‘½å'}ã€‹**
- å…± ${writeState.chapters.length} ç« 
- ç´„ ${totalWords.toLocaleString()} å­—

æ¥ä¸‹ä¾†å¯ä»¥ï¼š`, [
        { text: 'ğŸ¬ è½‰æ›æˆåˆ†é¡', action: () => convertToStoryboard() },
        { text: 'ğŸ“¥ å°å‡ºå°èªª', action: () => exportNovel() },
        { text: 'ğŸ’¾ ä¿å­˜å…¨éƒ¨', action: () => saveProgress('complete') }
    ]);
}

// ==================== è½¬åˆ†é•œ ====================
async function convertToStoryboard() {
    addProgressCard('è½‰æ›ç‚ºåˆ†é¡è¡¨', 0);
    
    try {
        const novelText = writeState.chapters.map(c => `ã€ç¬¬${c.number}ç«  ${c.title}ã€‘\n${c.content}`).join('\n\n');
        
        state.novel = novelText;
        state.novelTitle = writeState.outline?.title || 'æœªå‘½å';
        state.concept = writeState.outline;
        
        updateProgress(30);
        
        // å…ˆç”Ÿæˆè§’è‰²
        const charResult = await callAgent('character', novelText.substring(0, 4000));
        state.characters = safeJSONParse(charResult.replace(/```json\n?/g, '').replace(/```/g, ''), 'characters');
        
        updateProgress(60);
        
        // ç”Ÿæˆåˆ†é•œ
        const sbResult = await callAgent('storyboard', novelText.substring(0, 3000), {
            concept: state.concept,
            characters: state.characters
        });
        
        writeState.storyboard = sbResult;
        state.storyboard = sbResult;
        
        updateProgress(100);
        removeProgressCard();
        
        addAIMessage(`ğŸ¬ **åˆ†é¡è¡¨ç”Ÿæˆå®Œæˆï¼**

è§’è‰²ï¼š${(state.characters?.characters || []).length} å€‹
åˆ†é¡ï¼šå·²ç”Ÿæˆ

å…¨éƒ¨è³‡æ–™æº–å‚™å°±ç·’ï¼`, [
            { text: 'ğŸ“¥ å°å‡ºExcel', action: () => exportExcel() },
            { text: 'ğŸ“¥ å°å‡ºJSON', action: () => exportAll() },
            { text: 'ğŸ’¾ ä¿å­˜é …ç›®', action: () => saveProgress('complete') }
        ]);
        
    } catch (err) {
        removeProgressCard();
        recordError(err, 'åˆ†é¡è½‰æ›');
        showFriendlyError(err, 'åˆ†é¡è½‰æ›', () => convertToStoryboard());
    }
}

// ==================== é¡¹ç›®ç®¡ç† ====================
const PROJECTS_KEY = 'fizzdragon_projects';

function getProjects() {
    try {
        return JSON.parse(localStorage.getItem(PROJECTS_KEY) || '{}');
    } catch {
        return {};
    }
}

function saveProject(name = null) {
    const projects = getProjects();
    const projectName = name || writeState.outline?.title || `é …ç›®_${Date.now()}`;
    const projectId = projectName.replace(/\s+/g, '_').toLowerCase();
    
    projects[projectId] = {
        id: projectId,
        name: projectName,
        stage: state.mode === 'write' ? 'write' : 'import',
        timestamp: new Date().toISOString(),
        // å†™ä½œæ¨¡å¼æ•°æ®
        idea: writeState.idea,
        interview: writeState.interview,
        outline: writeState.outline,
        chapters: writeState.chapters,
        writeStoryboard: writeState.storyboard,
        // å¯¼å…¥æ¨¡å¼æ•°æ®
        novel: state.novel,
        novelTitle: state.novelTitle,
        concept: state.concept,
        importInterview: state.interview,
        characters: state.characters,
        storyboard: state.storyboard
    };
    
    localStorage.setItem(PROJECTS_KEY, JSON.stringify(projects));
    
    addAIMessage(`ğŸ’¾ **é …ç›®å·²ä¿å­˜ï¼**

**åç¨±**: ${projectName}
**æ™‚é–“**: ${new Date().toLocaleString()}
**ç« ç¯€**: ${writeState.chapters?.length || 0} ç« 

å¯åœ¨ã€Œé …ç›®åˆ—è¡¨ã€ä¸­æŸ¥çœ‹æ‰€æœ‰é …ç›®ã€‚`, [
        { text: 'ğŸ“‚ æŸ¥çœ‹æ‰€æœ‰é …ç›®', action: () => showProjectList() }
    ]);
    
    return projectId;
}

function showProjectList() {
    const projects = getProjects();
    const list = Object.values(projects);
    
    if (list.length === 0) {
        addAIMessage(`ğŸ“‚ **é …ç›®åˆ—è¡¨**

é‚„æ²’æœ‰ä¿å­˜çš„é …ç›®ã€‚

é–‹å§‹å‰µä½œå¾Œé»æ“Šã€ŒğŸ’¾ ä¿å­˜ã€å³å¯ä¿å­˜é …ç›®ã€‚`, [
            { text: 'âœï¸ å‰µä½œå°èªª', action: () => startWriteMode() },
            { text: 'ğŸ“„ å°å…¥å°èªª', action: () => document.getElementById('fileInput').click() }
        ]);
        return;
    }
    
    const projectList = list
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 10)
        .map(p => {
            const date = new Date(p.timestamp).toLocaleDateString();
            const chapters = p.chapters?.length || 0;
            return `**${p.name}** (${date})\n   ${chapters}ç«  | ${p.stage === 'write' ? 'å‰µä½œ' : 'å°å…¥'}`;
        })
        .join('\n\n');
    
    addAIMessage(`ğŸ“‚ **é …ç›®åˆ—è¡¨** (${list.length}å€‹)

${projectList}

é¸æ“‡è¦æ‰“é–‹çš„é …ç›®ï¼š`, list.slice(0, 5).map(p => ({
        text: `ğŸ“– ${p.name}`,
        action: () => loadProject(p.id)
    })).concat([
        { text: 'ğŸ†• æ–°å»ºé …ç›®', action: () => showStartOptions() },
        { text: 'ğŸ—‘ï¸ ç®¡ç†é …ç›®', action: () => manageProjects() }
    ]));
}

function loadProject(projectId) {
    const projects = getProjects();
    const p = projects[projectId];
    
    if (!p) {
        addAIMessage(`âŒ é …ç›®ä¸å­˜åœ¨`);
        return;
    }
    
    // æ¢å¤å†™ä½œæ¨¡å¼çŠ¶æ€
    writeState.idea = p.idea;
    writeState.interview = p.interview;
    writeState.outline = p.outline;
    writeState.chapters = p.chapters || [];
    writeState.storyboard = p.writeStoryboard;
    
    // æ¢å¤å¯¼å…¥æ¨¡å¼çŠ¶æ€
    state.novel = p.novel;
    state.novelTitle = p.novelTitle;
    state.concept = p.concept;
    state.interview = p.importInterview;
    state.characters = p.characters;
    state.storyboard = p.storyboard;
    state.mode = p.stage;
    
    const chs = p.outline?.chapters || [];
    const completed = p.chapters?.length || 0;
    
    addAIMessage(`ğŸ“– **å·²è¼‰å…¥é …ç›®**

**ã€Š${p.name}ã€‹**
- æ¨¡å¼ï¼š${p.stage === 'write' ? 'å‰µä½œ' : 'å°å…¥'}
- é€²åº¦ï¼š${completed}/${chs.length || '?'} ç« 
- ä¸Šæ¬¡ç·¨è¼¯ï¼š${new Date(p.timestamp).toLocaleString()}`, [
        { text: 'â–¶ï¸ ç¹¼çºŒ', action: () => p.stage === 'write' ? continueWriteProject() : continueImportProject() },
        { text: 'ğŸ¬ ç”Ÿæˆåˆ†é¡', action: () => convertToStoryboard() },
        { text: 'ğŸ“¥ å°å‡º', action: () => showExportOptions() }
    ]);
}

function continueWriteProject() {
    const chs = writeState.outline?.chapters || [];
    const completed = writeState.chapters?.length || 0;
    const total = chs.length;
    const totalWords = writeState.chapters.reduce((sum, c) => sum + (c.content?.length || 0), 0);
    
    if (completed >= total) {
        addAIMessage(`âœ… **å°èªªå·²å®Œæˆï¼**

**ã€Š${writeState.outline?.title}ã€‹**
- å…± ${total} ç« 
- ç´„ ${totalWords.toLocaleString()} å­—

å¯ä»¥è½‰æ›åˆ†é¡æˆ–å°å‡ºï¼š`, [
            { text: 'ğŸ¬ è½‰æ›åˆ†é¡', action: () => convertToStoryboard() },
            { text: 'ğŸ“¥ å°å‡ºå°èªª', action: () => exportNovel() },
            { text: 'ğŸ“Š å°å‡ºExcel', action: () => exportExcel() }
        ]);
    } else {
        writeState.currentChapter = completed;
        const nextCh = chs[completed];
        
        addAIMessage(`â–¶ï¸ **ç¹¼çºŒå¯«ä½œ**

**ã€Š${writeState.outline?.title}ã€‹**

ğŸ“Š é€²åº¦ï¼š${completed}/${total} ç«  (${Math.round(completed/total*100)}%)
ğŸ“ å·²å¯«ï¼š${totalWords.toLocaleString()} å­—
ğŸ“– ä¸‹ä¸€ç« ï¼šç¬¬${completed + 1}ç« ã€Š${nextCh?.title || ''}ã€‹

æˆ‘æœƒè‡ªå‹•åŠ è¼‰ï¼š
1. âœ… æ•…äº‹å¤§ç¶±
2. âœ… äººç‰©å°å‚³
3. âœ… å‰æ–‡å›é¡§
4. âœ… ç« ç¯€è„ˆçµ¡

æº–å‚™å¥½ç¹¼çºŒäº†å—ï¼Ÿ`, [
            { text: `â–¶ï¸ é–‹å§‹å¯«ç¬¬${completed + 1}ç« `, action: () => writeNextChapter() },
            { text: 'ğŸ“– æŸ¥çœ‹å¤§ç¶±', action: () => showOutline() },
            { text: 'ğŸ“š æŸ¥çœ‹å·²å¯«ç« ç¯€', action: () => showWrittenChapters() }
        ]);
    }
}

function showWrittenChapters() {
    const chapters = writeState.chapters || [];
    
    if (chapters.length === 0) {
        addAIMessage(`é‚„æ²’æœ‰å¯«ä»»ä½•ç« ç¯€ã€‚`);
        return;
    }
    
    const list = chapters.map(c => 
        `**ç¬¬${c.number}ç« ã€Š${c.title}ã€‹** (${c.content?.length || 0}å­—)`
    ).join('\n');
    
    addAIMessage(`ğŸ“š **å·²å®Œæˆç« ç¯€**

${list}

é»æ“ŠæŸ¥çœ‹è©³æƒ…ï¼š`, chapters.slice(-5).map(c => ({
        text: `ğŸ“– ç¬¬${c.number}ç« `,
        action: () => showChapterContent(c.number)
    })));
}

function continueImportProject() {
    console.log('continueImportProject:', { step: state.step, novel: !!state.novel, concept: !!state.concept, chapters: !!state.chapters, characters: !!state.characters, storyboard: !!state.storyboard });
    
    // ä¿å­˜å½“å‰è¿›åº¦
    saveProject();
    
    // ğŸ”§ æ ¹æ®å½“å‰çŠ¶æ€è‡ªåŠ¨ç»§ç»­ä¸‹ä¸€æ­¥
    if (state.storyboard && state.storyboard.shots?.length > 0) {
        const shotCount = state.storyboard.shots?.length || 0;
        addAIMessage(`âœ… **åˆ†é¡è¡¨å·²å®Œæˆï¼** å…± ${shotCount} å€‹é¡é ­

å¯ä»¥å°å‡ºæˆ–é‡æ–°ç”Ÿæˆï¼š`, [
            { text: 'ğŸ“¥ å°å‡ºExcel', action: () => exportExcel() },
            { text: 'ğŸ“¥ å°å‡ºJSON', action: () => exportAll() },
            { text: 'ğŸ”„ é‡æ–°ç”Ÿæˆåˆ†é¡', action: () => runStoryboardStep() }
        ]);
    } else if (state.characters?.characters?.length > 0) {
        const charCount = state.characters.characters.length;
        addAIMessage(`ğŸ‘¤ å·²è¨­è¨ˆ ${charCount} å€‹è§’è‰²ï¼Œæ­£åœ¨ç”Ÿæˆåˆ†é¡...`);
        setTimeout(() => runStoryboardStep(), 500);
    } else if (state.chapters?.chapters?.length > 0) {
        const chapterCount = state.chapters.chapters.length;
        addAIMessage(`ğŸ“ å·²è¦åŠƒ ${chapterCount} ç« ï¼Œæ­£åœ¨è¨­è¨ˆè§’è‰²...`);
        setTimeout(() => runCharacterStep(), 500);
    } else if (state.concept?.genre || state.concept?.theme) {
        addAIMessage(`ğŸ“– æ¦‚å¿µåˆ†æå®Œæˆï¼Œæ­£åœ¨è¦åŠƒç« ç¯€...`);
        setTimeout(() => runChaptersStep(), 500);
    } else if (state.novel) {
        addAIMessage(`ğŸ“„ å°èªªå·²å°å…¥ï¼ˆ${state.novel.length}å­—ï¼‰ï¼Œæ­£åœ¨åˆ†ææ¦‚å¿µ...`);
        setTimeout(() => runConceptStep(), 500);
    } else {
        addAIMessage(`ğŸ“ è«‹å…ˆå°å…¥å°èªªæˆ–è¼¸å…¥æ•…äº‹å…§å®¹ï¼š`, [
            { text: 'ğŸ“„ å°å…¥å°èªªæ–‡ä»¶', action: () => document.getElementById('fileInput').click() },
            { text: 'ğŸ“ ç›´æ¥è¼¸å…¥æ•…äº‹', action: () => addAIMessage('è«‹ç›´æ¥è¼¸å…¥æˆ–ç²˜è²¼ä½ çš„æ•…äº‹å…§å®¹ï¼ˆ100å­—ä»¥ä¸Šï¼‰') }
        ]);
    }
}

function manageProjects() {
    const projects = getProjects();
    const list = Object.values(projects);
    
    addAIMessage(`ğŸ—‘ï¸ **ç®¡ç†é …ç›®**

é¸æ“‡è¦åˆªé™¤çš„é …ç›®ï¼š`, list.map(p => ({
        text: `âŒ åˆªé™¤ ${p.name}`,
        action: () => deleteProject(p.id)
    })).concat([
        { text: 'ğŸ”™ è¿”å›åˆ—è¡¨', action: () => showProjectList() }
    ]));
}

function deleteProject(projectId) {
    const projects = getProjects();
    const name = projects[projectId]?.name;
    delete projects[projectId];
    localStorage.setItem(PROJECTS_KEY, JSON.stringify(projects));
    
    addAIMessage(`ğŸ—‘ï¸ å·²åˆªé™¤é …ç›®ã€Œ${name}ã€`, [
        { text: 'ğŸ“‚ è¿”å›åˆ—è¡¨', action: () => showProjectList() }
    ]);
}

function showExportOptions() {
    addAIMessage(`ğŸ“¥ **å°å‡ºé¸é …**`, [
        { text: 'ğŸ“„ å°å‡ºå°èªª (TXT)', action: () => exportNovel() },
        { text: 'ğŸ“Š å°å‡ºExcel', action: () => exportExcel() },
        { text: 'ğŸ“¦ å°å‡ºå…¨éƒ¨ (JSON)', action: () => exportAll() }
    ]);
}

// å…¼å®¹æ—§çš„ä¿å­˜å‡½æ•°
function saveProgress(stage) {
    saveProject();
}

function loadProgress() {
    // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šæ£€æŸ¥å•ä¸€ä¿å­˜
    const oldSave = localStorage.getItem('ai_drama_write_progress');
    if (oldSave) {
        try {
            const data = JSON.parse(oldSave);
            // è¿ç§»åˆ°æ–°ç³»ç»Ÿ
            if (data.outline) {
                const projects = getProjects();
                const id = (data.outline.title || 'migrated').replace(/\s+/g, '_').toLowerCase();
                projects[id] = {
                    id,
                    name: data.outline?.title || 'é·ç§»é …ç›®',
                    ...data
                };
                localStorage.setItem(PROJECTS_KEY, JSON.stringify(projects));
                localStorage.removeItem('ai_drama_write_progress');
                return projects[id];
            }
        } catch {}
    }
    
    // è¿”å›æœ€è¿‘çš„é¡¹ç›®
    const projects = getProjects();
    const list = Object.values(projects);
    if (list.length > 0) {
        return list.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
    }
    return null;
}

function exportNovel() {
    const content = writeState.chapters.map(c => 
        `# ç¬¬${c.number}ç«  ${c.title}\n\n${c.content}`
    ).join('\n\n---\n\n');
    
    const blob = new Blob([`# ${writeState.outline?.title || 'æœªå‘½å'}\n\n${content}`], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${writeState.outline?.title || 'å°èªª'}.txt`;
    a.click();
    
    addAIMessage(`ğŸ“¥ å·²å°å‡ºå°èªªï¼š${writeState.outline?.title || 'å°èªª'}.txt`);
}

function exportExcel() {
    // å‡†å¤‡æ•°æ®
    const rows = [];
    
    // æ·»åŠ ç« èŠ‚ä¿¡æ¯
    rows.push(['ç« ç¯€', 'æ¨™é¡Œ', 'æ¦‚è¦']);
    (writeState.outline?.chapters || []).forEach(ch => {
        rows.push([`ç¬¬${ch.number}ç« `, ch.title, ch.summary]);
    });
    
    rows.push([]);
    rows.push(['è§’è‰²', 'é¡å‹', 'æè¿°', 'AI Prompt']);
    (state.characters?.characters || []).forEach(c => {
        rows.push([c.name, c.role || '', c.psychology?.want || '', c.ai_prompt || '']);
    });
    
    // ä½¿ç”¨SheetJSå¯¼å‡º
    if (typeof XLSX !== 'undefined') {
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'æ•…äº‹è³‡æ–™');
        XLSX.writeFile(wb, `${writeState.outline?.title || 'æ•…äº‹'}_åˆ†é¡è¡¨.xlsx`);
        addAIMessage(`ğŸ“¥ å·²å°å‡ºExcelï¼š${writeState.outline?.title || 'æ•…äº‹'}_åˆ†é¡è¡¨.xlsx`);
    } else {
        // é™çº§ä¸ºCSV
        const csv = rows.map(r => r.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${writeState.outline?.title || 'æ•…äº‹'}_åˆ†é¡è¡¨.csv`;
        a.click();
        addAIMessage(`ğŸ“¥ å·²å°å‡ºCSVï¼š${writeState.outline?.title || 'æ•…äº‹'}_åˆ†é¡è¡¨.csv`);
    }
}

// ==================== æ¶ˆæ¯UI ====================
function addUserMessage(text) {
    const container = document.getElementById('chatContainer');
    const msg = document.createElement('div');
    msg.className = 'message user';
    msg.innerHTML = `<div class="role">ä½ </div><div class="content">${escapeHtml(text)}</div>`;
    container.appendChild(msg);
    scrollToBottom();
}

function addAIMessage(text, quickReplies = []) {
    const container = document.getElementById('chatContainer');
    const msg = document.createElement('div');
    msg.className = 'message ai';
    
    let html = `<div class="role">ğŸ¬ AIGCç•ªåŠ‡åŠ©æ‰‹</div><div class="content">${formatMessage(text)}</div>`;
    
    if (quickReplies.length > 0) {
        html += '<div class="quick-replies">';
        quickReplies.forEach((r, i) => {
            html += `<button class="quick-reply" onclick="handleQuickReply(${i})">${r.text}</button>`;
        });
        html += '</div>';
        window._quickReplies = quickReplies;
    }
    
    msg.innerHTML = html;
    container.appendChild(msg);
    scrollToBottom();
    return msg;
}

function addTypingIndicator() {
    const container = document.getElementById('chatContainer');
    const msg = document.createElement('div');
    msg.className = 'message ai';
    msg.id = 'typingIndicator';
    msg.innerHTML = `<div class="role">ğŸ¬ AIGCç•ªåŠ‡åŠ©æ‰‹</div><div class="typing"><span></span><span></span><span></span></div>`;
    container.appendChild(msg);
    scrollToBottom();
}

function removeTypingIndicator() {
    const el = document.getElementById('typingIndicator');
    if (el) el.remove();
}

function addProgressCard(title, progress = 0) {
    const container = document.getElementById('chatContainer');
    const card = document.createElement('div');
    card.className = 'message ai';
    card.id = 'progressCard';
    card.innerHTML = `
        <div class="role">ğŸ¬ AIGCç•ªåŠ‡åŠ©æ‰‹</div>
        <div class="progress-card">
            <div class="progress-header">
                <span>${title}</span>
                <span id="progressPercent">${progress}%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: ${progress}%"></div>
            </div>
        </div>
    `;
    container.appendChild(card);
    scrollToBottom();
}

function updateProgress(progress) {
    const fill = document.getElementById('progressFill');
    const percent = document.getElementById('progressPercent');
    if (fill) fill.style.width = progress + '%';
    if (percent) percent.textContent = progress + '%';
}

function removeProgressCard() {
    const el = document.getElementById('progressCard');
    if (el) el.remove();
}

function formatMessage(text) {
    // ç®€å•çš„markdownæ”¯æŒ
    return text
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// å‹å¥½çš„é”™è¯¯æç¤ºï¼ˆå‘Šè¯‰ç”¨æˆ·åŸå› å’Œè§£å†³æ–¹æ³•ï¼‰
function friendlyError(err, step) {
    const msg = err.message || String(err);
    
    // åˆ†æé”™è¯¯ç±»å‹
    if (msg.includes('timeout') || msg.includes('Timeout') || msg.includes('è¶…æ™‚')) {
        return {
            title: 'â±ï¸ è™•ç†æ™‚é–“è¼ƒé•·',
            reason: 'AIæ­£åœ¨æ·±åº¦æ€è€ƒï¼Œä½†èŠ±äº†æ¯”é æœŸæ›´é•·çš„æ™‚é–“',
            solutions: [
                'ç¨ç­‰ç‰‡åˆ»å¾Œé‡è©¦',
                'å¦‚æœå…§å®¹è¼ƒé•·ï¼Œå¯ä»¥å˜—è©¦ç¸®çŸ­è¼¸å…¥',
                'ç¶²çµ¡å¯èƒ½è¼ƒæ…¢ï¼Œæ›å€‹æ™‚é–“è©¦è©¦'
            ]
        };
    }
    
    if (msg.includes('JSON') || msg.includes('parse') || msg.includes('Unexpected')) {
        return {
            title: 'ğŸ“‹ æ ¼å¼è§£æå•é¡Œ',
            reason: 'AIå›è¦†çš„æ ¼å¼ä¸å¤ªæ¨™æº–ï¼Œç³»çµ±æ­£åœ¨å­¸ç¿’è™•ç†',
            solutions: [
                'ç›´æ¥é‡è©¦é€šå¸¸å°±èƒ½è§£æ±º',
                'é€™æ˜¯AIå¶çˆ¾çš„å°è„¾æ°£ï¼Œä¸å½±éŸ¿å¾ŒçºŒ'
            ]
        };
    }
    
    if (msg.includes('network') || msg.includes('fetch') || msg.includes('é€£æ¥')) {
        return {
            title: 'ğŸŒ ç¶²çµ¡é€£æ¥å•é¡Œ',
            reason: 'èˆ‡AIæœå‹™çš„é€£æ¥æš«æ™‚ä¸­æ–·',
            solutions: [
                'æª¢æŸ¥ç¶²çµ¡é€£æ¥',
                'ç¨å¾Œé‡è©¦',
                'å¦‚æŒçºŒå¤±æ•—ï¼Œå¯èƒ½æ˜¯æœå‹™ç¶­è­·ä¸­'
            ]
        };
    }
    
    if (msg.includes('API') || msg.includes('401') || msg.includes('403')) {
        return {
            title: 'ğŸ”‘ æœå‹™é©—è­‰å•é¡Œ',
            reason: 'APIå¯†é‘°å¯èƒ½éœ€è¦æ›´æ–°',
            solutions: [
                'è¯ç¹«ç®¡ç†å“¡æª¢æŸ¥é…ç½®',
                'ç¨å¾Œé‡è©¦'
            ]
        };
    }
    
    if (msg.includes('500') || msg.includes('502') || msg.includes('503')) {
        return {
            title: 'ğŸ”§ æœå‹™æš«æ™‚ç¹å¿™',
            reason: 'AIæœå‹™æ­£åœ¨è™•ç†å¤§é‡è«‹æ±‚',
            solutions: [
                'ç­‰å¾…1-2åˆ†é˜å¾Œé‡è©¦',
                'é«˜å³°æœŸå¯èƒ½éœ€è¦å¤šè©¦å¹¾æ¬¡'
            ]
        };
    }
    
    // é»˜è®¤é”™è¯¯
    return {
        title: 'âš ï¸ é‡åˆ°äº†å°å•é¡Œ',
        reason: msg.length > 100 ? msg.substring(0, 100) + '...' : msg,
        solutions: [
            'é‡è©¦ä¸€æ¬¡é€šå¸¸èƒ½è§£æ±º',
            'å¦‚æœæŒçºŒå¤±æ•—ï¼Œå˜—è©¦ç°¡åŒ–è¼¸å…¥å…§å®¹',
            'æˆ–è€…å…ˆä¿å­˜é€²åº¦ï¼Œç¨å¾Œç¹¼çºŒ'
        ]
    };
}

function showFriendlyError(err, step, retryAction) {
    const info = friendlyError(err, step);
    
    addAIMessage(`${info.title}

**å¯èƒ½åŸå› **: ${info.reason}

**å»ºè­°**:
${info.solutions.map(s => `â€¢ ${s}`).join('\n')}`, [
        { text: 'ğŸ”„ é‡è©¦', action: retryAction },
        { text: 'ğŸ’¾ ä¿å­˜é€²åº¦', action: () => saveProject() },
        { text: 'ğŸ†˜ æ±‚åŠ©å°åŠ©æ‰‹', action: () => callHelpAgent() }
    ]);
}

// ==================== ç”¨æˆ·åŠ©æ‰‹æ™ºèƒ½ä½“ ====================
let lastError = null;  // è®°å½•æœ€åçš„é”™è¯¯

// è®°å½•é”™è¯¯ï¼ˆåœ¨å„ä¸ªcatchå—ä¸­è°ƒç”¨ï¼‰
function recordError(err, context) {
    lastError = {
        message: err.message || String(err),
        context: context,
        timestamp: new Date().toISOString(),
        state: {
            mode: state.mode,
            step: state.step,
            hasNovel: !!state.novel,
            hasConcept: !!state.concept,
            hasChapters: !!state.chapters,
            hasCharacters: !!state.characters,
            writeChapters: writeState.chapters?.length || 0
        }
    };
}

// ç”¨æˆ·åŠ©æ‰‹æ™ºèƒ½ä½“
async function callHelpAgent() {
    const helpBtn = document.querySelector('.help-fab');
    helpBtn.classList.add('loading');
    helpBtn.textContent = 'ğŸ”';
    
    addAIMessage(`ğŸ†˜ **ç”¨æˆ¶åŠ©æ‰‹ä¾†å¹«å¿™äº†ï¼**

æ­£åœ¨è¨ºæ–·ç³»çµ±ç‹€æ…‹...`);
    
    // æ”¶é›†è¯Šæ–­ä¿¡æ¯
    const diagnosis = {
        // å½“å‰çŠ¶æ€
        mode: state.mode || 'æœªé–‹å§‹',
        step: state.step || 0,
        
        // æ•°æ®çŠ¶æ€
        hasNovel: !!state.novel,
        novelLength: state.novel?.length || 0,
        hasConcept: !!state.concept,
        hasChapters: !!state.chapters || !!writeState.outline,
        chapterCount: (state.chapters?.chapters || state.chapters?.episodes || writeState.outline?.chapters || []).length,
        hasCharacters: !!state.characters,
        characterCount: (state.characters?.characters || []).length,
        writtenChapters: writeState.chapters?.length || 0,
        hasStoryboard: !!state.storyboard,
        
        // APIçŠ¶æ€
        apiConnected: API_BASE !== null,
        apiEndpoint: API_BASE,
        
        // æœ€è¿‘é”™è¯¯
        lastError: lastError
    };
    
    // åˆ†æé—®é¢˜å¹¶æä¾›è§£å†³æ–¹æ¡ˆ
    const issues = [];
    const fixes = [];
    
    // æ£€æŸ¥APIè¿æ¥
    if (!diagnosis.apiConnected) {
        issues.push('âŒ APIæœªé€£æ¥');
        fixes.push({ text: 'ğŸ”„ é‡æ–°é€£æ¥API', action: async () => {
            await detectAPI();
            addAIMessage(API_BASE ? 'âœ… APIå·²é‡æ–°é€£æ¥ï¼å¯ä»¥ç¹¼çºŒäº†ã€‚' : 'âŒ é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡');
        }});
    }
    
    // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
    if (diagnosis.mode === 'write' && diagnosis.hasNovel === false && !writeState.idea) {
        issues.push('âš ï¸ é‚„æ²’æœ‰é–‹å§‹å‰µä½œ');
        fixes.push({ text: 'âœï¸ é–‹å§‹å‰µä½œ', action: () => doStartWriteMode() });
    }
    
    if (diagnosis.mode === 'import' && diagnosis.hasNovel && !diagnosis.hasConcept) {
        issues.push('âš ï¸ å°èªªå·²å°å…¥ä½†æœªåˆ†æ');
        fixes.push({ text: 'ğŸ“– é‡æ–°åˆ†æå°èªª', action: () => runConceptStep() });
    }
    
    if (diagnosis.hasConcept && !diagnosis.hasChapters && diagnosis.step >= 2) {
        issues.push('âš ï¸ ç« ç¯€è¦åŠƒæœªå®Œæˆ');
        fixes.push({ text: 'ğŸ“ ç”Ÿæˆç« ç¯€è¦åŠƒ', action: () => state.mode === 'write' ? generateOutline() : runChaptersStep() });
    }
    
    if (diagnosis.hasChapters && !diagnosis.hasCharacters && diagnosis.step >= 4) {
        issues.push('âš ï¸ è§’è‰²è¨­è¨ˆæœªå®Œæˆ');
        fixes.push({ text: 'ğŸ‘¤ ç”Ÿæˆè§’è‰²è¨­è¨ˆ', action: () => runCharacterStep() });
    }
    
    // æ£€æŸ¥æœ€è¿‘é”™è¯¯
    if (lastError) {
        issues.push(`âš ï¸ æœ€è¿‘éŒ¯èª¤: ${lastError.context}`);
        
        if (lastError.message.includes('timeout') || lastError.message.includes('Timeout')) {
            fixes.push({ text: 'â±ï¸ å»¶é•·è¶…æ™‚é‡è©¦', action: () => {
                addAIMessage('å·²èª¿æ•´è¶…æ™‚è¨­ç½®ï¼Œè«‹é‡è©¦ä¸Šä¸€æ­¥æ“ä½œã€‚');
            }});
        }
        
        if (lastError.message.includes('JSON') || lastError.message.includes('parse')) {
            fixes.push({ text: 'ğŸ”„ æ¸…é™¤ç·©å­˜é‡è©¦', action: () => {
                lastError = null;
                addAIMessage('å·²æ¸…é™¤éŒ¯èª¤è¨˜éŒ„ï¼Œè«‹é‡è©¦ä¸Šä¸€æ­¥æ“ä½œã€‚');
            }});
        }
    }
    
    // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
    helpBtn.classList.remove('loading');
    helpBtn.textContent = 'ğŸ†˜';
    
    if (issues.length === 0) {
        // æ²¡æœ‰å‘ç°é—®é¢˜
        addAIMessage(`âœ… **è¨ºæ–·å®Œæˆ - ç³»çµ±æ­£å¸¸ï¼**

**ç•¶å‰ç‹€æ…‹**:
â€¢ æ¨¡å¼: ${diagnosis.mode === 'write' ? 'å‰µä½œæ¨¡å¼' : diagnosis.mode === 'import' ? 'å°å…¥æ¨¡å¼' : 'æœªé–‹å§‹'}
â€¢ æ­¥é©Ÿ: ${diagnosis.step}/5
${diagnosis.hasNovel ? `â€¢ å°èªª: ${diagnosis.novelLength.toLocaleString()} å­—` : ''}
${diagnosis.chapterCount > 0 ? `â€¢ ç« ç¯€: ${diagnosis.chapterCount} ç« ` : ''}
${diagnosis.characterCount > 0 ? `â€¢ è§’è‰²: ${diagnosis.characterCount} å€‹` : ''}
${diagnosis.writtenChapters > 0 ? `â€¢ å·²å¯«: ${diagnosis.writtenChapters} ç« ` : ''}
â€¢ API: ${diagnosis.apiConnected ? 'å·²é€£æ¥ âœ…' : 'æœªé€£æ¥ âŒ'}

**æ²’æœ‰ç™¼ç¾å•é¡Œï¼** å¦‚æœé‡åˆ°å›°é›£ï¼Œè«‹æè¿°å…·é«”æƒ…æ³ã€‚`, [
            { text: 'â–¶ï¸ ç¹¼çºŒå‰µä½œ', action: () => state.mode === 'write' ? continueWriteProject() : continueImportProject() },
            { text: 'ğŸ  è¿”å›ä¸»é ', action: () => showStartOptions() }
        ]);
    } else {
        // å‘ç°é—®é¢˜ï¼Œæä¾›ä¿®å¤é€‰é¡¹
        addAIMessage(`ğŸ” **è¨ºæ–·å®Œæˆ - ç™¼ç¾ ${issues.length} å€‹å•é¡Œ**

**å•é¡Œåˆ—è¡¨**:
${issues.map(i => `${i}`).join('\n')}

**ç•¶å‰ç‹€æ…‹**:
â€¢ æ¨¡å¼: ${diagnosis.mode === 'write' ? 'å‰µä½œæ¨¡å¼' : diagnosis.mode === 'import' ? 'å°å…¥æ¨¡å¼' : 'æœªé–‹å§‹'}
â€¢ é€²åº¦: ${diagnosis.step}/5
â€¢ API: ${diagnosis.apiConnected ? 'å·²é€£æ¥ âœ…' : 'æœªé€£æ¥ âŒ'}

é»æ“Šä¸‹æ–¹æŒ‰éˆ•è‡ªå‹•ä¿®å¾©ï¼š`, fixes.concat([
            { text: 'ğŸ  è¿”å›ä¸»é é‡æ–°é–‹å§‹', action: () => {
                resetWorkflowFromStep(0);
                document.getElementById('chatContainer').innerHTML = '';
                showStartOptions();
            }}
        ]));
    }
}

function scrollToBottom() {
    const container = document.getElementById('chatContainer');
    setTimeout(() => container.scrollTop = container.scrollHeight, 100);
}

// ==================== å¿«æ·å›å¤ ====================
function handleQuickReply(index) {
    if (window._quickReplies && window._quickReplies[index]) {
        const reply = window._quickReplies[index];
        if (reply.action) {
            reply.action();
        } else if (reply.text) {
            document.getElementById('userInput').value = reply.text;
            sendMessage();
        }
    }
}

// ==================== å·¥ä½œæµé‡ç½® (DeepSeeké£æ ¼) ====================
// æ£€æŸ¥æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„å·¥ä½œ
function hasActiveWork() {
    // æ£€æŸ¥å¯¹è±¡æ˜¯å¦æœ‰å®é™…å†…å®¹
    const hasContent = (obj) => obj && Object.keys(obj).length > 0;
    
    const result = !!(
        state.novel || 
        state.concept || 
        hasContent(state.interview) ||  // æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å›ç­”
        state.chapters || 
        state.characters || 
        state.storyboard ||
        writeState.idea ||
        writeState.outline ||
        hasContent(writeState.interview) ||  // æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å›ç­”
        (writeState.chapters && writeState.chapters.length > 0)
    );
    
    console.log('hasActiveWork:', result, { 
        novel: !!state.novel, 
        concept: !!state.concept, 
        interview: hasContent(state.interview),
        chapters: !!state.chapters,
        idea: !!writeState.idea,
        outline: !!writeState.outline
    });
    
    return result;
}

// é‡ç½®å·¥ä½œæµåˆ°æŒ‡å®šæ­¥éª¤ï¼ˆæ¸…é™¤è¯¥æ­¥éª¤åŠä¹‹åçš„æ‰€æœ‰æ•°æ®ï¼‰
function resetWorkflowFromStep(stepNumber) {
    console.log('resetWorkflowFromStep:', stepNumber);
    // æ­¥éª¤å®šä¹‰:
    // 0: åˆå§‹çŠ¶æ€ï¼ˆæ¸…ç©ºä¸€åˆ‡ï¼‰
    // 1: å¯¼å…¥/åˆ›æ„ å®Œæˆï¼Œæ¸…é™¤ concept åŠä¹‹å
    // 2: concept å®Œæˆï¼Œæ¸…é™¤ interview åŠä¹‹å  
    // 3: interview å®Œæˆï¼Œæ¸…é™¤ chapters åŠä¹‹å
    // 4: chapters å®Œæˆï¼Œæ¸…é™¤ characters åŠä¹‹å
    // 5: characters å®Œæˆï¼Œæ¸…é™¤ storyboard åŠä¹‹å
    
    if (stepNumber <= 0) {
        // å®Œå…¨é‡ç½®
        state.novel = null;
        state.novelTitle = '';
        state.mode = null;
        state.step = 0;
        writeState.idea = null;
        writeState.currentQuestion = null;
    }
    if (stepNumber <= 1) {
        state.concept = null;
        writeState.interview = {};
    }
    if (stepNumber <= 2) {
        state.interview = {};
        state.interviewQuestions = [];
        state.currentQuestion = 0;
    }
    if (stepNumber <= 3) {
        state.chapters = null;
        writeState.outline = null;
    }
    if (stepNumber <= 4) {
        state.characters = null;
        writeState.chapters = [];
        writeState.currentChapter = 0;
    }
    if (stepNumber <= 5) {
        state.storyboard = null;
        writeState.storyboard = null;
    }
    
    state.step = stepNumber;
    console.log(`å·¥ä½œæµé‡ç½®åˆ°æ­¥éª¤ ${stepNumber}`);
}

// ç¡®è®¤é‡ç½®å¯¹è¯æ¡†
function confirmResetAndImport(callback) {
    if (!hasActiveWork()) {
        callback();
        return;
    }
    
    // æœ‰è¿›è¡Œä¸­çš„å·¥ä½œï¼Œéœ€è¦ç¡®è®¤
    addAIMessage(`âš ï¸ **ç™¼ç¾é€²è¡Œä¸­çš„é …ç›®**

ç•¶å‰æœ‰æœªä¿å­˜çš„å·¥ä½œï¼š
${state.novelTitle || writeState.outline?.title || 'æœªå‘½åé …ç›®'}

å°å…¥æ–°å°èªªæœƒ**æ¸…ç©ºç•¶å‰æ‰€æœ‰é€²åº¦**ã€‚

ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`, [
        { text: 'ğŸ’¾ å…ˆä¿å­˜ç•¶å‰é …ç›®', action: () => saveProject() },
        { text: 'ğŸ—‘ï¸ æ”¾æ£„ç•¶å‰ï¼Œå°å…¥æ–°çš„', action: () => {
            resetWorkflowFromStep(0);
            document.getElementById('chatContainer').innerHTML = '';
            callback();
        }},
        { text: 'âŒ å–æ¶ˆ', action: () => showCurrentProgress() }
    ]);
}

// æ˜¾ç¤ºè°ƒæ•´è­¦å‘Šï¼ˆä¿®æ”¹å‰é¢çš„æ­¥éª¤ä¼šæ¸…ç©ºåç»­ï¼‰
function showAdjustWarning(stepName, stepNumber) {
    const stepNames = {
        'outline': 'å¤§ç¶±',
        'chapters': 'ç« ç¯€è¦åŠƒ', 
        'characters': 'è§’è‰²è¨­è¨ˆ',
        'interview': 'è¨ªè«‡'
    };
    
    const affectedSteps = [];
    if (stepNumber <= 3) affectedSteps.push('ç« ç¯€è¦åŠƒ');
    if (stepNumber <= 4) {
        affectedSteps.push('è§’è‰²è¨­è¨ˆ');
        if (writeState.chapters?.length > 0) {
            affectedSteps.push(`å·²å¯«çš„ ${writeState.chapters.length} ç« å…§å®¹`);
        }
    }
    if (stepNumber <= 5) affectedSteps.push('åˆ†é¡è¡¨');
    
    addAIMessage(`âš ï¸ **èª¿æ•´${stepNames[stepName] || stepName}**

ä¿®æ”¹æ­¤æ­¥é©Ÿæœƒ**æ¸…ç©ºå¾ŒçºŒæ‰€æœ‰å…§å®¹**ï¼š
${affectedSteps.map(s => `â€¢ ${s}`).join('\n')}

ç¢ºå®šè¦èª¿æ•´å—ï¼Ÿ`, [
        { text: `âœï¸ ç¢ºå®šèª¿æ•´${stepNames[stepName] || stepName}`, action: () => {
            resetWorkflowFromStep(stepNumber);
            // æ ¹æ®æ­¥éª¤ç±»å‹ï¼Œæ˜¾ç¤ºç›¸åº”çš„è°ƒæ•´ç•Œé¢
            if (stepName === 'outline') {
                addAIMessage(`ğŸ“ è«‹æè¿°ä½ æƒ³å¦‚ä½•èª¿æ•´å¤§ç¶±ï¼š
- æ•´é«”çµæ§‹
- ç« ç¯€æ•¸é‡
- æ•…äº‹èµ°å‘
- å…¶ä»–è¦æ±‚`);
            } else if (stepName === 'chapters') {
                runChaptersStep();
            } else if (stepName === 'characters') {
                runCharacterStep();
            }
        }},
        { text: 'âŒ å–æ¶ˆ', action: () => showCurrentProgress() }
    ]);
}

// æ˜¾ç¤ºå½“å‰è¿›åº¦
function showCurrentProgress() {
    const title = state.novelTitle || writeState.outline?.title || 'æœªå‘½å';
    const mode = state.mode === 'write' ? 'å‰µä½œæ¨¡å¼' : 'å°å…¥æ¨¡å¼';
    const chaptersCount = writeState.chapters?.length || 0;
    
    let progress = [];
    if (state.novel || writeState.idea) progress.push('âœ… æ•…äº‹éˆæ„Ÿ');
    if (state.concept) progress.push('âœ… æ¦‚å¿µåˆ†æ');
    if (Object.keys(state.interview || {}).length > 0 || Object.keys(writeState.interview || {}).length > 0) progress.push('âœ… è¨ªè«‡');
    if (state.chapters || writeState.outline) progress.push('âœ… ç« ç¯€è¦åŠƒ');
    if (state.characters) progress.push('âœ… è§’è‰²è¨­è¨ˆ');
    if (chaptersCount > 0) progress.push(`âœ… å·²å¯« ${chaptersCount} ç« `);
    if (state.storyboard) progress.push('âœ… åˆ†é¡è¡¨');
    
    addAIMessage(`ğŸ“Š **ç•¶å‰é€²åº¦**

**ã€Š${title}ã€‹** - ${mode}

${progress.join('\n') || 'å‰›é–‹å§‹'}

ç¹¼çºŒç•¶å‰å·¥ä½œï¼š`, [
        { text: 'â–¶ï¸ ç¹¼çºŒ', action: () => state.mode === 'write' ? continueWriteProject() : continueImportProject() },
        { text: 'ğŸ’¾ ä¿å­˜é …ç›®', action: () => saveProject() }
    ]);
}

// ==================== æ–‡ä»¶å¯¼å…¥ ====================
document.getElementById('fileInput').addEventListener('change', async (e) => {
    console.log('ğŸ“ æ–‡ä»¶é€‰æ‹©è§¦å‘');
    const file = e.target.files[0];
    if (!file) {
        console.log('ğŸ“ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
        return;
    }
    console.log('ğŸ“ æ–‡ä»¶:', file.name, file.size, 'bytes');
    
    // æ£€æŸ¥æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„å·¥ä½œ
    if (hasActiveWork()) {
        e.target.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
        confirmResetAndImport(() => {
            // é‡æ–°è§¦å‘æ–‡ä»¶é€‰æ‹©
            document.getElementById('fileInput').click();
        });
        return;
    }
    
    addUserMessage(`ğŸ“„ å°å…¥æ–‡ä»¶: ${file.name}`);
    addTypingIndicator();
    
    try {
        let text = '';
        const ext = file.name.split('.').pop().toLowerCase();
        
        if (ext === 'txt') {
            text = await file.text();
        } else if (ext === 'docx') {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            text = result.value;
        } else if (ext === 'pdf') {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
        }
        
        state.novel = text;
        state.novelTitle = file.name.replace(/\.[^/.]+$/, '');
        state.step = 1;
        state.mode = 'import';  // ğŸ”§ ä¿®å¤Bug#1: è®¾ç½®å¯¼å…¥æ¨¡å¼
        console.log('ğŸ“ çŠ¶æ€å·²è®¾ç½®:', { mode: state.mode, step: state.step, title: state.novelTitle, novelLen: text.length });
        
        removeTypingIndicator();
        
        const preview = text.substring(0, 200) + (text.length > 200 ? '...' : '');
        addAIMessage(`âœ… æˆåŠŸå°å…¥ã€Š${state.novelTitle}ã€‹

**å­—æ•¸**: ${text.length.toLocaleString()} å­—
**é è¦½**: ${preview}

æˆ‘æ­£åœ¨é–±è®€å’Œåˆ†æé€™éƒ¨ä½œå“ï¼Œè«‹ç¨ç­‰...`);
        
        // è‡ªåŠ¨å¼€å§‹æ¦‚å¿µæå–
        await runConceptStep();
        
    } catch (err) {
        removeTypingIndicator();
        addAIMessage(`ğŸ“„ **æ–‡ä»¶è®€å–é‡åˆ°å•é¡Œ**

**å¯èƒ½åŸå› **: 
â€¢ æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼ˆç›®å‰æ”¯æŒ .txt, .docx, .pdfï¼‰
â€¢ æ–‡ä»¶å¯èƒ½å·²æå£æˆ–åŠ å¯†
â€¢ æ–‡ä»¶å¤ªå¤§ï¼ˆå»ºè­° < 5MBï¼‰

**å»ºè­°**:
â€¢ å˜—è©¦å¦å­˜ç‚º .txt æ ¼å¼å¾Œé‡æ–°å°å…¥
â€¢ ç¢ºèªæ–‡ä»¶å¯ä»¥æ­£å¸¸æ‰“é–‹`, [
            { text: 'ğŸ“„ é‡æ–°é¸æ“‡æ–‡ä»¶', action: () => document.getElementById('fileInput').click() },
            { text: 'âœï¸ æ”¹ç”¨å‰µä½œæ¨¡å¼', action: () => startWriteMode() }
        ]);
    }
});

// ==================== å¿«é€Ÿç”Ÿæˆï¼ˆè·³è¿‡è®¿è°ˆï¼‰====================
async function quickGenerate() {
    addAIMessage(`âš¡ **å¿«é€Ÿç”Ÿæˆæ¨¡å¼**

æ­£åœ¨è‡ªå‹•å®Œæˆæ‰€æœ‰æ­¥é©Ÿ...`);
    
    addProgressCard('å¿«é€Ÿç”Ÿæˆåˆ†é¡', 0);
    
    try {
        // æ­¥éª¤1: ç« èŠ‚è§„åˆ’
        updateProgress(20);
        showAgentStatus('ğŸ“ ç« ç¯€è¦åŠƒå¸«', 'è¦åŠƒæ•…äº‹çµæ§‹...');
        const chaptersResult = await callAgent('narrative', state.novel.substring(0, 5000), { concept: state.concept });
        state.chapters = safeJSONParse(chaptersResult, 'chapters');
        state.step = 4;
        
        // æ­¥éª¤2: è§’è‰²è®¾è®¡
        updateProgress(50);
        showAgentStatus('ğŸ‘¤ è§’è‰²è¨­è¨ˆå¸«', 'è¨­è¨ˆè§’è‰²...');
        const charactersResult = await callAgent('character', state.novel.substring(0, 4000), { concept: state.concept, chapters: state.chapters });
        state.characters = safeJSONParse(charactersResult, 'characters');
        state.step = 5;
        
        // æ­¥éª¤3: åˆ†é•œç”Ÿæˆ
        updateProgress(80);
        showAgentStatus('ğŸ¬ åˆ†é¡å°æ¼”', 'ç”Ÿæˆåˆ†é¡è¡¨...');
        const storyboardResult = await callAgent('storyboard', state.novel.substring(0, 3000), { concept: state.concept, chapters: state.chapters, characters: state.characters });
        state.storyboard = storyboardResult;
        
        updateProgress(100);
        removeProgressCard();
        hideAgentStatus();
        
        const eps = state.chapters?.chapters || state.chapters?.episodes || [];
        const chars = state.characters?.characters || [];
        
        addAIMessage(`âœ… **å¿«é€Ÿç”Ÿæˆå®Œæˆï¼**

ğŸ“Š **ç”Ÿæˆçµæœ**ï¼š
â€¢ ç« ç¯€ï¼š${eps.length} é›†
â€¢ è§’è‰²ï¼š${chars.length} å€‹
â€¢ åˆ†é¡ï¼šå·²ç”Ÿæˆ

æ¥ä¸‹ä¾†ï¼š`, [
            { text: 'ğŸ“¥ å°å‡ºExcel', action: () => exportExcel() },
            { text: 'ğŸ“¥ å°å‡ºJSON', action: () => exportAll() },
            { text: 'ğŸ‘€ æŸ¥çœ‹è©³æƒ…', action: () => showGeneratedDetails() }
        ]);
        
    } catch (err) {
        removeProgressCard();
        hideAgentStatus();
        recordError(err, 'å¿«é€Ÿç”Ÿæˆ');
        showFriendlyError(err, 'å¿«é€Ÿç”Ÿæˆ', () => quickGenerate());
    }
}

function showGeneratedDetails() {
    const eps = state.chapters?.chapters || state.chapters?.episodes || [];
    const chars = state.characters?.characters || [];
    
    let details = `ğŸ“‹ **ç”Ÿæˆè©³æƒ…**\n\n**ç« ç¯€åˆ—è¡¨**ï¼š\n`;
    eps.slice(0, 5).forEach((ep, i) => {
        details += `â€¢ ç¬¬${i+1}é›†ï¼š${ep.title || ep.name || 'æœªå‘½å'}\n`;
    });
    if (eps.length > 5) details += `â€¢ ...é‚„æœ‰ ${eps.length - 5} é›†\n`;
    
    details += `\n**è§’è‰²åˆ—è¡¨**ï¼š\n`;
    chars.slice(0, 5).forEach(c => {
        details += `â€¢ ${c.name}ï¼ˆ${c.role || 'è§’è‰²'}ï¼‰\n`;
    });
    if (chars.length > 5) details += `â€¢ ...é‚„æœ‰ ${chars.length - 5} å€‹è§’è‰²\n`;
    
    addAIMessage(details, [
        { text: 'ğŸ“¥ å°å‡º', action: () => exportAll() },
        { text: 'ğŸ”„ é‡æ–°ç”Ÿæˆ', action: () => quickGenerate() }
    ]);
}

// ==================== æ­¥éª¤æ‰§è¡Œ ====================
async function runConceptStep() {
    addTypingIndicator();
    
    try {
        const result = await callAgent('concept', state.novel.substring(0, 4000));
        state.concept = safeJSONParse(result, 'concept');
        state.step = 1;  // æ ‡è®°æ¦‚å¿µåˆ†æå®Œæˆ
        
        removeTypingIndicator();
        
        const c = state.concept;
        addAIMessage(`ğŸ“– **åˆ†æå®Œæˆï¼**ã€Š${state.novelTitle}ã€‹

**é¡å‹**: ${c.genre || 'å¾…å®š'}
**ä¸»é¡Œ**: ${c.theme || 'å¾…å®š'}
**æƒ…æ„ŸåŸºèª¿**: ${c.tone || 'å¾…å®š'}
**æ¦‚æ‹¬**: ${c.logline || 'å¾…å®š'}

â³ è‡ªå‹•é€²å…¥ä¸‹ä¸€æ­¥ï¼šè¦åŠƒç« ç¯€...`);
        
        // ğŸ”§ ä¿®å¤Bug#2: è‡ªåŠ¨ç»§ç»­ä¸‹ä¸€æ­¥ï¼Œä¸å†ç­‰å¾…ç”¨æˆ·é€‰æ‹©
        saveProject();
        setTimeout(() => runChaptersStep(), 1000);
        
    } catch (err) {
        removeTypingIndicator();
        recordError(err, 'æ¦‚å¿µåˆ†æ');
        showFriendlyError(err, 'æ¦‚å¿µåˆ†æ', () => runConceptStep());
    }
}

async function startInterview() {
    // ç”Ÿæˆè®¿è°ˆé—®é¢˜ - è°ƒç”¨è®¿è°ˆæ™ºèƒ½ä½“
    addTypingIndicator();
    showAgentStatus('ğŸ¤ è¨ªè«‡å¸«', 'åˆ†ææ•…äº‹ï¼Œè¨­è¨ˆå•é¡Œ...');
    
    try {
        const result = await callAgent('interview', state.novel.substring(0, 3000), {
            concept: state.concept
        });
        
        console.log('è¨ªè«‡Agentè¿”å›:', result?.substring(0, 200));
        
        // è§£æé—®é¢˜
        const questions = extractQuestions(result);
        console.log('æå–åˆ°å•é¡Œ:', questions);
        
        if (questions.length > 0) {
            state.interviewQuestions = questions;
            state.currentQuestion = 0;
            
            removeTypingIndicator();
            hideAgentStatus();
            
            addAIMessage(`ğŸ¤ **è¨ªè«‡å¸«** æ ¹æ“šä½ çš„æ•…äº‹è¨­è¨ˆäº† ${questions.length} å€‹é‡å°æ€§å•é¡Œï¼š`);
            
            // é—®ç¬¬ä¸€ä¸ªé—®é¢˜
            setTimeout(() => askNextQuestion(), 500);
        } else {
            throw new Error('æœªèƒ½æå–åˆ°å•é¡Œ');
        }
        
    } catch (err) {
        console.error('è¨ªè«‡ç”Ÿæˆå¤±æ•—:', err);
        removeTypingIndicator();
        hideAgentStatus();
        
        // ä½¿ç”¨é»˜è®¤é—®é¢˜
        state.interviewQuestions = [
            'ä½ å‰µä½œé€™å€‹æ•…äº‹çš„åˆè¡·æ˜¯ä»€éº¼ï¼Ÿæƒ³å‚³é”ä»€éº¼æ ¸å¿ƒä¿¡æ¯ï¼Ÿ',
            'æ•…äº‹ä¸­å“ªå€‹è§’è‰²æœ€æ‰“å‹•ä½ ï¼Ÿç‚ºä»€éº¼ï¼Ÿ',
            'ä½ å¸Œæœ›è§€çœ¾çœ‹å®Œå¾Œæœ‰ä»€éº¼æ„Ÿå—ï¼Ÿ',
            'æœ‰åƒè€ƒéå…¶ä»–ä½œå“çš„é¢¨æ ¼å—ï¼Ÿ',
            'å°è¦–è¦ºå‘ˆç¾æœ‰ä»€éº¼æƒ³æ³•ï¼Ÿ'
        ];
        state.currentQuestion = 0;
        
        addAIMessage(`âš ï¸ è¨ªè«‡å¸«æš«æ™‚é›¢ç·šï¼Œä½¿ç”¨é€šç”¨å•é¡Œï¼š

æˆ‘æœƒå•ä½  5 å€‹å•é¡Œï¼Œå¹«åŠ©æˆ‘æ›´å¥½åœ°ç†è§£ä½ çš„å‰µä½œæ„åœ–ã€‚`);
        
        setTimeout(() => askNextQuestion(), 500);
    }
}

function extractQuestions(text) {
    // æå–é—®é¢˜åˆ—è¡¨ - æ”¯æŒå¤šç§æ ¼å¼
    const questions = [];
    
    // æ–¹æ³•1: ä¼˜å…ˆæå–ã€Œã€å¼•å·å†…çš„é—®é¢˜
    const quoted = text.match(/ã€Œ([^ã€]+[ï¼Ÿ?])ã€/g);
    if (quoted) {
        quoted.forEach(q => {
            const clean = q.replace(/[ã€Œã€]/g, '').trim();
            if (clean.length > 5 && !questions.includes(clean)) {
                questions.push(clean);
            }
        });
    }
    
    // å¦‚æœå·²ç»æå–åˆ°è¶³å¤Ÿçš„é—®é¢˜ï¼Œç›´æ¥è¿”å›
    if (questions.length >= 5) {
        return questions.slice(0, 5);
    }
    
    // æ–¹æ³•2: æå–å…¶ä»–åŒ…å«é—®å·çš„å¥å­ï¼ˆå»é‡ï¼‰
    const lines = text.split('\n');
    for (const line of lines) {
        if ((line.includes('?') || line.includes('ï¼Ÿ')) && line.length > 10) {
            // æ¸…ç†æ ¼å¼
            let clean = line.replace(/^[\d\.\)ã€\-\*\s]+/, '').trim();
            clean = clean.replace(/^\*\*[^*]+\*\*\s*/, ''); // ç§»é™¤**æ ‡é¢˜**
            clean = clean.replace(/^ã€Œ|ã€$/g, '').trim();
            
            if (clean.length > 10 && clean.length < 150) {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼é—®é¢˜
                const isDuplicate = questions.some(q => 
                    q.includes(clean.substring(0, 15)) || clean.includes(q.substring(0, 15))
                );
                if (!isDuplicate) {
                    questions.push(clean);
                }
            }
        }
    }
    
    // è¿”å›å‰5ä¸ªé—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰æå–åˆ°åˆ™ç”¨é»˜è®¤é—®é¢˜
    return questions.length > 0 ? questions.slice(0, 5) : [
        'ä½ å‰µä½œé€™å€‹æ•…äº‹çš„åˆè¡·æ˜¯ä»€éº¼ï¼Ÿæƒ³å‚³é”ä»€éº¼æ ¸å¿ƒä¿¡æ¯ï¼Ÿ',
        'æ•…äº‹ä¸­å“ªå€‹è§’è‰²æœ€æ‰“å‹•ä½ ï¼Ÿç‚ºä»€éº¼ï¼Ÿ',
        'ä½ å¸Œæœ›è§€çœ¾çœ‹å®Œå¾Œæœ‰ä»€éº¼æ„Ÿå—ï¼Ÿ',
        'æœ‰æ²’æœ‰åƒè€ƒéå…¶ä»–ä½œå“çš„é¢¨æ ¼ï¼Ÿ',
        'å°è¦–è¦ºé¢¨æ ¼æœ‰ä»€éº¼æƒ³æ³•ï¼Ÿï¼ˆæ¯”å¦‚è‰²èª¿ã€æ°›åœï¼‰'
    ];
}

function askNextQuestion() {
    if (state.currentQuestion >= state.interviewQuestions.length) {
        // è®¿è°ˆç»“æŸ
        finishInterview();
        return;
    }
    
    const q = state.interviewQuestions[state.currentQuestion];
    const num = state.currentQuestion + 1;
    const total = state.interviewQuestions.length;
    
    addAIMessage(`ğŸ¤ **è¨ªè«‡å•é¡Œ ${num}/${total}**

${q}`, [
        { text: 'è·³éé€™é¡Œ', action: () => skipQuestion() },
        { text: 'çµæŸè¨ªè«‡', action: () => finishInterview() }
    ]);
}

function skipQuestion() {
    state.interview[state.currentQuestion] = '(è·³é)';
    state.currentQuestion++;
    askNextQuestion();
}

async function finishInterview() {
    state.step = 3;
    addAIMessage(`âœ… è¨ªè«‡å®Œæˆï¼æ„Ÿè¬ä½ çš„åˆ†äº«ã€‚

ç¾åœ¨æˆ‘ä¾†è¦åŠƒ**ç« ç¯€åˆ†é›†**...`);
    
    await runChaptersStep();
}

async function runChaptersStep() {
    addProgressCard('ç”Ÿæˆç« ç¯€è¦åŠƒ', 0);
    
    try {
        const context = {
            concept: state.concept,
            interview: state.interview
        };
        
        // ğŸ”§ ä¿®å¤Bug#3: é˜²æ­¢null.substring()é”™è¯¯
        const novelText = state.novel || writeState.idea?.premise || writeState.outline?.synopsis || '';
        
        updateProgress(30);
        const result = await callAgent('narrative', novelText.substring(0, 5000), context);
        updateProgress(100);
        
        state.chapters = safeJSONParse(result, 'chapters');
        state.step = 3;  // æ ‡è®°ç« èŠ‚è§„åˆ’å®Œæˆ
        
        removeProgressCard();
        
        const eps = state.chapters.chapters || state.chapters.episodes || [];
        addAIMessage(`ğŸ“ **ç« ç¯€è¦åŠƒå®Œæˆï¼** å…± ${eps.length} é›†

${eps.slice(0, 3).map((ep, i) => `â€¢ ç¬¬${i+1}é›†: ${ep.title || ep.name || 'æœªå‘½å'}`).join('\n')}
${eps.length > 3 ? `â€¢ ...é‚„æœ‰ ${eps.length - 3} é›†` : ''}

â³ æ­£åœ¨è¨­è¨ˆè§’è‰²...`);
        
        // ğŸ”§ è‡ªåŠ¨ç»§ç»­ä¸‹ä¸€æ­¥
        saveProject();
        setTimeout(() => runCharacterStep(), 1000);
        
    } catch (err) {
        removeProgressCard();
        recordError(err, 'ç« ç¯€è¦åŠƒ');
        showFriendlyError(err, 'ç« ç¯€è¦åŠƒ', () => runChaptersStep());
    }
}

async function runCharacterStep() {
    addProgressCard('ç”Ÿæˆè§’è‰²è¨­è¨ˆ', 0);
    
    try {
        const context = {
            concept: state.concept,
            chapters: state.chapters
        };
        
        // ğŸ”§ ä¿®å¤Bug#3: é˜²æ­¢null.substring()é”™è¯¯
        const novelText = state.novel || writeState.outline?.synopsis || JSON.stringify(state.chapters) || '';
        
        updateProgress(30);
        const result = await callAgent('character', novelText.substring(0, 4000), context);
        updateProgress(100);
        
        state.characters = safeJSONParse(result, 'characters');
        state.step = 4;  // æ ‡è®°è§’è‰²è®¾è®¡å®Œæˆ
        
        removeProgressCard();
        
        const chars = state.characters.characters || [];
        addAIMessage(`ğŸ‘¤ **è§’è‰²è¨­è¨ˆå®Œæˆï¼** å…± ${chars.length} å€‹è§’è‰²

${chars.slice(0, 3).map(c => `â€¢ **${c.name}** (${c.role || 'è§’è‰²'})`).join('\n')}

â³ æ­£åœ¨ç”Ÿæˆåˆ†é¡è¡¨...`);
        
        // ğŸ”§ è‡ªåŠ¨ç»§ç»­ä¸‹ä¸€æ­¥
        saveProject();
        setTimeout(() => runStoryboardStep(), 1000);
        
    } catch (err) {
        removeProgressCard();
        recordError(err, 'è§’è‰²è¨­è¨ˆ');
        showFriendlyError(err, 'è§’è‰²è¨­è¨ˆ', () => runCharacterStep());
    }
}

async function runStoryboardStep() {
    addProgressCard('ç”Ÿæˆåˆ†é¡è¡¨', 0);
    
    try {
        const context = {
            concept: state.concept,
            chapters: state.chapters,
            characters: state.characters
        };
        
        // ğŸ”§ ä¿®å¤Bug#3: é˜²æ­¢null.substring()é”™è¯¯
        const novelText = state.novel || writeState.outline?.synopsis || JSON.stringify(state.chapters) || '';
        
        updateProgress(30);
        const result = await callAgent('storyboard', novelText.substring(0, 3000), context);
        updateProgress(100);
        
        // è§£æåˆ†é•œç»“æœ
        const storyboardData = safeJSONParse(result, 'storyboard');
        state.storyboard = storyboardData;
        state.step = 5;  // æ ‡è®°åˆ†é•œå®Œæˆ
        
        removeProgressCard();
        saveProject();
        
        // ç»Ÿè®¡åˆ†é•œæ•°é‡
        const shots = storyboardData?.shots || storyboardData?.storyboard || [];
        const shotCount = Array.isArray(shots) ? shots.length : 0;
        const epCount = (state.chapters?.chapters || state.chapters?.episodes || []).length;
        const charCount = (state.characters?.characters || []).length;
        
        addAIMessage(`ğŸ¬ **åˆ†é¡è¡¨ç”Ÿæˆå®Œæˆï¼**

ğŸ“Š **è£½ä½œè³‡æ–™çµ±è¨ˆ**:
â€¢ æ•…äº‹æ¦‚å¿µ: âœ…
â€¢ ç« ç¯€è¦åŠƒ: ${epCount} é›†
â€¢ è§’è‰²è¨­è¨ˆ: ${charCount} å€‹
â€¢ åˆ†é¡é¡é ­: ${shotCount} å€‹

ğŸ‰ æ­å–œï¼ä½ çš„AIç•ªåŠ‡è£½ä½œè³‡æ–™å·²å®Œæˆï¼`, [
            { text: 'ğŸ“¥ å°å‡ºExcel', action: () => exportExcel() },
            { text: 'ğŸ“¥ å°å‡ºJSON', action: () => exportAll() },
            { text: 'ğŸ”„ é‡æ–°ç”Ÿæˆ', action: () => runStoryboardStep() },
            { text: 'ğŸ  æ–°é …ç›®', action: () => location.reload() }
        ]);
        
    } catch (err) {
        removeProgressCard();
        recordError(err, 'åˆ†é¡ç”Ÿæˆ');
        showFriendlyError(err, 'åˆ†é¡ç”Ÿæˆ', () => runStoryboardStep());
    }
}

// ==================== æ™ºèƒ½ä½“åç§°æ˜ å°„ ====================
const AGENT_NAMES = {
    concept: 'ğŸ’¡ æ¦‚å¿µç”Ÿæˆå™¨',
    interview: 'ğŸ¤ è¨ªè«‡å¸«',
    narrative: 'ğŸ“ ç« ç¯€è¦åŠƒå¸«',
    character: 'ğŸ‘¤ è§’è‰²è¨­è¨ˆå¸«',
    storyboard: 'ğŸ¬ åˆ†é¡å°æ¼”',
    artstyle: 'ğŸ¨ ç¾è¡“æŒ‡å°',
    screenwriter: 'âœï¸ ç·¨åŠ‡'
};

// ==================== APIè°ƒç”¨ï¼ˆå¸¦çŠ¶æ€æ˜¾ç¤ºï¼‰====================
async function callAgent(agentId, content, context = {}) {
    const agentName = AGENT_NAMES[agentId] || agentId;
    
    // æ˜¾ç¤ºè°ƒç”¨çŠ¶æ€
    showAgentStatus(agentName, 'æº–å‚™ä¸­...');
    
    try {
        const response = await fetch(`${API_BASE}/agent/${agentId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content, ...context })
        });
        
        if (!response.ok) {
            hideAgentStatus();
            throw new Error(`APIéŒ¯èª¤: ${response.status}`);
        }
        
        const data = await response.json();
        
        // æ˜¾ç¤ºtokenæ¶ˆè€—
        if (data.tokens) {
            updateAgentStatus(agentName, `å®Œæˆ âœ… (${data.tokens.input + data.tokens.output} tokens)`);
        }
        
        // å¦‚æœæœ‰æ€è€ƒè¿‡ç¨‹ï¼ˆreasonerï¼‰ï¼Œæ˜¾ç¤ºå‡ºæ¥
        if (data.reasoning || data.thinking) {
            showThinkingProcess(data.reasoning || data.thinking);
        }
        
        setTimeout(hideAgentStatus, 2000);
        return data.result;
        
    } catch (err) {
        hideAgentStatus();
        throw err;
    }
}

// ==================== æ™ºèƒ½ä½“çŠ¶æ€æ˜¾ç¤º ====================
function showAgentStatus(agentName, status) {
    let statusBar = document.getElementById('agentStatusBar');
    if (!statusBar) {
        statusBar = document.createElement('div');
        statusBar.id = 'agentStatusBar';
        statusBar.style.cssText = `
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1a1a1a, #0d0d0d);
            border: 1px solid #E31B23;
            border-radius: 8px;
            padding: 10px 20px;
            color: #fff;
            font-size: 13px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(232,48,48,0.3);
        `;
        document.body.appendChild(statusBar);
    }
    
    statusBar.innerHTML = `
        <div class="agent-spinner"></div>
        <span><strong>${agentName}</strong> ${status}</span>
    `;
    statusBar.style.display = 'flex';
    
    // æ·»åŠ spinneræ ·å¼
    if (!document.getElementById('spinnerStyle')) {
        const style = document.createElement('style');
        style.id = 'spinnerStyle';
        style.textContent = `
            .agent-spinner {
                width: 16px;
                height: 16px;
                border: 2px solid #E31B2333;
                border-top-color: #E31B23;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            .thinking-box {
                background: transparent;
                border: none;
                border-left: 2px solid #333;
                border-radius: 0;
                padding: 8px 12px;
                margin-top: 8px;
                font-size: 12px;
                color: #666;
                max-height: 150px;
                overflow-y: auto;
                white-space: pre-wrap;
            }
            .thinking-box::before {
                content: 'ğŸ’­ æ€è€ƒéç¨‹';
                display: block;
                color: #E31B23;
                font-weight: 500;
                margin-bottom: 8px;
            }
        `;
        document.head.appendChild(style);
    }
}

function updateAgentStatus(agentName, status) {
    const statusBar = document.getElementById('agentStatusBar');
    if (statusBar) {
        statusBar.innerHTML = `<span>âœ… <strong>${agentName}</strong> ${status}</span>`;
    }
}

function hideAgentStatus() {
    const statusBar = document.getElementById('agentStatusBar');
    if (statusBar) {
        statusBar.style.display = 'none';
    }
}

function showThinkingProcess(thinking) {
    if (!thinking || thinking.length < 10) return;
    
    const container = document.getElementById('chatContainer');
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'message ai';
    thinkingDiv.innerHTML = `
        <div class="role">ğŸ§  AIæ€è€ƒéç¨‹</div>
        <div class="thinking-box">${escapeHtml(thinking.substring(0, 500))}${thinking.length > 500 ? '...' : ''}</div>
    `;
    container.appendChild(thinkingDiv);
    scrollToBottom();
}

// ==================== ç”¨æˆ·è¾“å…¥ ====================
function sendMessage() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (!text) return;
    
    addUserMessage(text);
    input.value = '';
    
    // å¤„ç†ç”¨æˆ·å›å¤
    handleUserInput(text);
}

function handleUserInput(text) {
    console.log('ğŸ”” handleUserInput:', { 
        mode: state.mode, 
        step: state.step, 
        writeQ: writeState.currentQuestion,
        novelTitle: state.novelTitle,
        textLen: text.length
    });
    
    // å†™ä½œæ¨¡å¼ - å¤„ç†åˆå§‹æƒ³æ³•è¾“å…¥ï¼ˆç­‰å¾…æ•…äº‹çµæ„Ÿï¼‰
    if (state.mode === 'write' && writeState.currentQuestion === -1) {
        console.log('å†™ä½œæ¨¡å¼: æ¥æ”¶æ•…äº‹çµæ„Ÿ');
        writeState.idea = { premise: text };
        startWriteInterview();
        return;
    }
    
    // å†™ä½œæ¨¡å¼ - è®¿è°ˆé—®é¢˜
    if (state.mode === 'write' && typeof writeState.currentQuestion === 'number' && writeState.currentQuestion >= 0 && writeState.currentQuestion < WRITE_QUESTIONS.length) {
        console.log('å†™ä½œæ¨¡å¼: å›ç­”è®¿è°ˆé—®é¢˜', writeState.currentQuestion);
        if (text.toLowerCase() === 'è·³é' || text.toLowerCase() === 'è·³è¿‡') {
            writeState.interview[writeState.currentQuestion] = '(è·³é)';
        } else {
            writeState.interview[writeState.currentQuestion] = text;
        }
        writeState.currentQuestion++;
        setTimeout(() => askWriteQuestion(), 500);
        return;
    }
    
    // å¯¼å…¥æ¨¡å¼ - è®¿è°ˆé—®é¢˜
    if (state.step === 2 && state.currentQuestion < (state.interviewQuestions?.length || 0)) {
        state.interview[state.currentQuestion] = text;
        state.currentQuestion++;
        setTimeout(() => askNextQuestion(), 500);
        return;
    }
    
    // ğŸ”§ ä¿®å¤Bug#1: å¯¼å…¥æ¨¡å¼ - ç”¨æˆ·å‘é€æ–‡æœ¬æ—¶ï¼Œæ˜¾ç¤ºå½“å‰çŠ¶æ€
    if (state.mode === 'import' && state.step >= 1) {
        const stepNames = ['ç­‰å¾…å°å…¥', 'æ¦‚å¿µåˆ†æ', 'è¨ªè«‡ä¸­', 'ç« ç¯€è¦åŠƒ', 'è§’è‰²è¨­è¨ˆ', 'åˆ†é¡ç”Ÿæˆ'];
        addAIMessage(`ğŸ“Š **ç•¶å‰ç‹€æ…‹**: ${stepNames[state.step] || 'è™•ç†ä¸­'}

æ­£åœ¨è™•ç†ã€Š${state.novelTitle || 'æœªå‘½å'}ã€‹...`, [
            { text: 'â–¶ï¸ ç¹¼çºŒä¸‹ä¸€æ­¥', action: () => continueImportProject() },
            { text: 'ğŸ†˜ æ±‚åŠ©', action: () => callHelpAgent() }
        ]);
        return;
    }
    
    // åˆå§‹çŠ¶æ€ - ç”¨æˆ·ç›´æ¥å‘é€æ–‡å­—
    if (state.step === 0 && !state.mode) {
        // æ£€æµ‹æ˜¯å¦åƒæ˜¯æ•…äº‹å†…å®¹ï¼ˆè¶…è¿‡100å­—ï¼‰
        if (text.length > 100) {
            addAIMessage(`ğŸ“– æ”¶åˆ°ä½ çš„å…§å®¹ï¼ˆ${text.length}å­—ï¼‰ï¼

é€™çœ‹èµ·ä¾†åƒæ˜¯æ•…äº‹å…§å®¹ï¼Œè«‹é¸æ“‡è™•ç†æ–¹å¼ï¼š`, [
                { text: 'ğŸ“ ä½œç‚ºå‰µä½œéˆæ„Ÿ', action: () => {
                    state.mode = 'write';
                    writeState.currentQuestion = -1;
                    writeState.idea = { premise: text };
                    startWriteInterview();
                }},
                { text: 'ğŸ“„ ç›´æ¥åˆ†æç”Ÿæˆåˆ†é¡', action: async () => {
                    state.novel = text;
                    state.novelTitle = 'ç›´æ¥è¼¸å…¥';
                    state.step = 1;
                    state.mode = 'import';
                    await runConceptStep();
                }}
            ]);
        } else {
            addAIMessage(`ğŸ‘‹ è«‹é¸æ“‡é–‹å§‹æ–¹å¼ï¼š`, [
                { text: 'ğŸ“„ å°å…¥å°èªªæ–‡ä»¶', action: () => document.getElementById('fileInput').click() },
                { text: 'âœï¸ å¾é›¶å‰µä½œæ•…äº‹', action: () => startWriteMode() },
                { text: 'ğŸ“ ç›´æ¥è¼¸å…¥æ•…äº‹', action: () => addAIMessage('è«‹ç›´æ¥è¼¸å…¥æˆ–ç²˜è²¼ä½ çš„æ•…äº‹å…§å®¹ï¼ˆ100å­—ä»¥ä¸Šï¼‰ï¼Œæˆ‘æœƒè‡ªå‹•è­˜åˆ¥ä¸¦è™•ç†ã€‚') }
            ]);
        }
        return;
    }
    
    // å…¶ä»–æƒ…å†µ - æ˜¾ç¤ºå¸®åŠ©é€‰é¡¹
    addAIMessage(`ğŸ“Š **ç•¶å‰ç‹€æ…‹**
â€¢ æ¨¡å¼: ${state.mode === 'write' ? 'å‰µä½œ' : state.mode === 'import' ? 'å°å…¥' : 'æœªé–‹å§‹'}
â€¢ æ­¥é©Ÿ: ${state.step}/5

éœ€è¦ä»€éº¼å¹«åŠ©ï¼Ÿ`, [
        { text: 'â–¶ï¸ ç¹¼çºŒ', action: () => state.mode === 'write' ? continueWriteProject() : continueImportProject() },
        { text: 'ğŸ†˜ è¨ºæ–·å•é¡Œ', action: () => callHelpAgent() },
        { text: 'ğŸ  é‡æ–°é–‹å§‹', action: () => { resetWorkflowFromStep(0); document.getElementById('chatContainer').innerHTML = ''; showStartOptions(); }}
    ]);
}

// å›è½¦å‘é€
document.getElementById('userInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// è‡ªåŠ¨è°ƒæ•´é«˜åº¦
document.getElementById('userInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
});

// ==================== å¯¼å‡º ====================
function exportAll() {
    const data = {
        title: state.novelTitle,
        concept: state.concept,
        interview: state.interview,
        chapters: state.chapters,
        characters: state.characters,
        storyboard: state.storyboard,
        exportTime: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${state.novelTitle}_AIç•ªåŠ‡.json`;
    a.click();
    
    addAIMessage(`âœ… å·²å°å‡º **${state.novelTitle}_AIç•ªåŠ‡.json**`);
}

// ==================== å¯åŠ¨ ====================
init();
    </script>
</body>
</html>
