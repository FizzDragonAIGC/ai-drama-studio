# 2026-02-17 工作日志

## Pipeline V3 架构完成

### 核心改变
从自动批量生成改为**手动控制模式**：
1. **Step 1**: 创建项目 + 生成所有剧本大纲
2. **Step 2**: 用户查看/修改剧本
3. **Step 3**: 用户选择生成某一集的分镜（手动触发）

### 新API（V3）
```
POST /api/project/create                      - 创建项目
POST /api/project/:id/scripts/generate        - 生成所有剧本
GET  /api/project/:id/scripts                 - 获取剧本（可修改）
PUT  /api/project/:id/scripts/:ep             - 修改单集剧本
POST /api/project/:id/storyboard/:ep/generate - 生成指定集分镜
GET  /api/project/:id/storyboard/:ep          - 获取指定集分镜
GET  /api/project/:id                         - 获取项目状态
GET  /api/project/:id/storyboard              - 导出所有分镜
```

### 测试结果
- 千与千寻 3集×5分钟 项目测试
- 剧本生成：~30秒，质量高（每集有title/summary/scenes）
- 分镜生成：5分钟/集 = 50镜头 = 5次API调用
- 每次调用~50秒生成10个详细镜头

### 发现问题
- DeepSeek偶尔返回无效JSON（调用2/5失败）
- 系统容错：跳过失败批次继续执行
- 中间状态不实时更新（完成后才返回结果）

### 文件修改
- `pipeline.js` - 重写为V3架构
- `proxy-server.js` - 新API端点

### 待优化
- [x] JSON解析失败时自动重试 ✅
- [x] 中间结果实时保存 ✅
- [ ] 添加实时进度推送（WebSocket）

## Bug修复（重要！）

### 1. JSON解析 `parseStoryboardJSON()`
新增鲁棒解析函数，多层fallback：
- 清理markdown代码块
- 正则提取JSON数组 `/\[[\s\S]*\]/`
- 修复中文引号 `"` → `"`
- 清理控制字符
- 修复trailing comma
- Rescue extraction兜底

### 2. 实时进度更新
修改为每批次完成后立即保存到 `pipeline.storyboards[episode]`
进度从 0→10→20→30 实时更新

### 3. 连续shot_id
从 `startShot + idx` 改为 `currentTotal + idx + 1`
确保跨批次ID连续

### 4. 重试机制
API调用失败自动重试，最多2次

## 压力测试
- 项目ID: `project_1771314680910`
- 规模: 5集×3分钟 = 150镜头
- 状态: 第1集生成中（0/30）
- 监控session: `glow-gulf`

## 关键路径
- 后端: `ai_drama_studio_v2/workbench/v3/server/`
- 测试项目:
  - `project_1771313678757` (千与千寻3集测试)
  - `project_1771314332952` (3集快速测试)
  - `project_1771314680910` (5集压力测试)

---

## 50集大规模测试成功！

### 关键优化
1. **shotsPerCall: 100→25** - 100个镜头会导致输出截断（只返回~8个），25个稳定
2. **max_tokens配置**:
   - deepseek-reasoner: 64000 (用户要求最大)
   - deepseek-chat: 8000 (API硬限8192)
3. **批量剧本生成**: 10集/批次，避免8K token溢出
4. **rescueExtractScripts()**: 正则兜底提取剧本

### 50集测试结果
- 项目: `project_1771320333871` (session: `lucky-slug`)
- 50集剧本: ~5分钟全部完成，cost ~$0.002
- 状态: ✅ 全部成功

### Auto-Continuous模式
新函数 `generateAllStoryboards(pipelineId, callAgentFn, onProgress)`:
- 顺序生成所有集数分镜
- 新API: `POST /api/project/:id/storyboard/generate-all`

### 当前测试
- 项目: `project_1771320913730` ("千与千寻-小测试")
- 规模: 3集×3分钟
- 状态: 第1集分镜生成中（24 shots累计，第2次API调用进行中）
- 首次调用: 24 shots, out=7953 tokens, cost=$0.001144

### 性能基准
- 剧本: ~5 min / 50集
- 分镜: ~1-2 min / 集 (25 shots/call × ~4 calls)

---

## Shot Density Planning System

### 新Agent: `shot_density`
创建 `shot_density_planner.skill.md`，用于预规划镜头密度：
- **公式**: `min=duration×10, recommended=duration×15, max=duration×25`
- **HERO镜头分配**: S级5%, A级15%, B级30%, C级50%
- **场景类型密度**: 动作20-30/min, 对话12-15/min, 情感8-12/min

### Storyboard Agent升级
更新分镜Agent支持密度计算和HERO镜头标记：
- 必须达到指定镜头数量
- 每个镜头标注重要性等级 (S/A/B/C)
- 根据场景类型调整密度

### 千与千寻测试对比

| 版本 | 模型 | 镜头数 | HERO镜 | 耗时 | 成本 |
|------|------|--------|--------|------|------|
| v1 | deepseek-chat | 30 | 7 | ~90s | $0.0006 |
| v2 | deepseek-reasoner | 50 | ~10 | ~4min | $0.0014 |

### DeepSeek模型策略
- **deepseek-chat**: 快速、稳定，适合大规模生成
- **deepseek-reasoner**: 更高质量但慢，适合精品项目
- **max_tokens**: reasoner=64000, chat=8192

### 关键文件
- `skills/shot_density_planner.skill.md` - 密度规划Skill
- `projects/spirited_away/ep01_storyboard_v1.json` - 第一版分镜
- `agents-config.js` line ~275 - shot_density agent配置

### 系统规模
- **42 Agents** (新增shot_density)
- **291 Skills** (新增shot_density_planner)

---

## 霸王别姬 4000镜头 Prompt扩展

### 问题
原有CSV只有tag片段式描述，如 `"CU, 情绪"` - 无法直接用于AI生成

### 解决方案
用DeepSeek扩展每个镜头为完整Prompt：
- **画面描述**: 完整场景描写（100-150字）
- **Image_Prompt**: 结构化图片生成Prompt（英文）
- **Video_Prompt**: Subject + Action + Camera + Scene + Style + Duration

### 批量扩展测试
- 首批400镜头测试: $0.02, ~25分钟
- 输出: `ai_drama_studio_v2/exports/bwbj_400shots_v2.csv`
- 质量优秀，场景细节丰富

### Skill更新 `storyboard_professional_complete.skill.md`
新增Seedance 2.0 Video Prompt格式：
```
Video_Prompt = Subject + Action + Camera Movement + Scene + Style + Constraints + "4 seconds"
```

新增Nano Banana Pro Image Prompt结构：
```
Subject Details + Environment + Lighting + Camera Angle + Style Reference + Negative Prompt
```

新增Negative Prompt标准：
```
--no distorted face, extra fingers, mutated hands, blurry, low quality, watermark, text, deformed limbs
```

新增相机参数快查表（ASL对应镜头+光圈）

---

## GitHub Pages + Vercel部署

### 问题
- GitHub Pages (HTTPS) 无法调用 HTTP 后端 (mixed content policy)
- 原后端 `http://34.58.33.115:3001` 无SSL

### 解决方案：Vercel Proxy
1. Vercel提供免费HTTPS
2. 创建 `vercel.json` + `api/proxy.js` serverless函数
3. 前端改调用 `https://xxx.vercel.app/api/proxy`

### GitHub Pages设置
- Source: `master` branch, `/docs` path
- 构建状态: Build 892781208 building → 需要检查

### 待完成
1. 调查GitHub Pages构建失败原因
2. 用户在Vercel dashboard设置 `DEEPSEEK_API_KEY`
3. 更新前端API_BASE指向Vercel URL
4. 测试完整工作流

### 关键文件
- `docs/` - GitHub Pages静态文件
- `vercel.json` - Vercel配置
- `api/proxy.js` - Serverless代理函数

---

## 技术决策记录

### deepseek-chat vs deepseek-reasoner
**选择 deepseek-chat**：
- reasoner经常返回 "Unexpected end of JSON input" 错误
- chat更稳定，适合批量生成
- 已在 `proxy-server.js` line 30 改为 deepseek-chat

### 镜头密度公式
- 最低: duration × 10 shots/min
- 推荐: duration × 15 shots/min  
- 高质量: duration × 20-25 shots/min

### HERO镜头分配
- S级（视觉震撼）: 5%
- A级（关键转折）: 15%
- B级（情感高潮）: 30%
- C级（常规镜头）: 50%
