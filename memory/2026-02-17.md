# 2026-02-17 工作日志

## Pipeline V3 架构完成

### 核心改变
从自动批量生成改为**手动控制模式**：
1. **Step 1**: 创建项目 + 生成所有剧本大纲
2. **Step 2**: 用户查看/修改剧本
3. **Step 3**: 用户选择生成某一集的分镜（手动触发）

### 新API（V3）
```
POST /api/project/create                      - 创建项目
POST /api/project/:id/scripts/generate        - 生成所有剧本
GET  /api/project/:id/scripts                 - 获取剧本（可修改）
PUT  /api/project/:id/scripts/:ep             - 修改单集剧本
POST /api/project/:id/storyboard/:ep/generate - 生成指定集分镜
GET  /api/project/:id/storyboard/:ep          - 获取指定集分镜
GET  /api/project/:id                         - 获取项目状态
GET  /api/project/:id/storyboard              - 导出所有分镜
```

### 测试结果
- 千与千寻 3集×5分钟 项目测试
- 剧本生成：~30秒，质量高（每集有title/summary/scenes）
- 分镜生成：5分钟/集 = 50镜头 = 5次API调用
- 每次调用~50秒生成10个详细镜头

### 发现问题
- DeepSeek偶尔返回无效JSON（调用2/5失败）
- 系统容错：跳过失败批次继续执行
- 中间状态不实时更新（完成后才返回结果）

### 文件修改
- `pipeline.js` - 重写为V3架构
- `proxy-server.js` - 新API端点

### 待优化
- [x] JSON解析失败时自动重试 ✅
- [x] 中间结果实时保存 ✅
- [ ] 添加实时进度推送（WebSocket）

## Bug修复（重要！）

### 1. JSON解析 `parseStoryboardJSON()`
新增鲁棒解析函数，多层fallback：
- 清理markdown代码块
- 正则提取JSON数组 `/\[[\s\S]*\]/`
- 修复中文引号 `"` → `"`
- 清理控制字符
- 修复trailing comma
- Rescue extraction兜底

### 2. 实时进度更新
修改为每批次完成后立即保存到 `pipeline.storyboards[episode]`
进度从 0→10→20→30 实时更新

### 3. 连续shot_id
从 `startShot + idx` 改为 `currentTotal + idx + 1`
确保跨批次ID连续

### 4. 重试机制
API调用失败自动重试，最多2次

## 压力测试
- 项目ID: `project_1771314680910`
- 规模: 5集×3分钟 = 150镜头
- 状态: 第1集生成中（0/30）
- 监控session: `glow-gulf`

## 关键路径
- 后端: `ai_drama_studio_v2/workbench/v3/server/`
- 测试项目:
  - `project_1771313678757` (千与千寻3集测试)
  - `project_1771314332952` (3集快速测试)
  - `project_1771314680910` (5集压力测试)

---

## 50集大规模测试成功！

### 关键优化
1. **shotsPerCall: 100→25** - 100个镜头会导致输出截断（只返回~8个），25个稳定
2. **max_tokens配置**:
   - deepseek-reasoner: 64000 (用户要求最大)
   - deepseek-chat: 8000 (API硬限8192)
3. **批量剧本生成**: 10集/批次，避免8K token溢出
4. **rescueExtractScripts()**: 正则兜底提取剧本

### 50集测试结果
- 项目: `project_1771320333871` (session: `lucky-slug`)
- 50集剧本: ~5分钟全部完成，cost ~$0.002
- 状态: ✅ 全部成功

### Auto-Continuous模式
新函数 `generateAllStoryboards(pipelineId, callAgentFn, onProgress)`:
- 顺序生成所有集数分镜
- 新API: `POST /api/project/:id/storyboard/generate-all`

### 当前测试
- 项目: `project_1771320913730` ("千与千寻-小测试")
- 规模: 3集×3分钟
- 状态: 第1集分镜生成中（24 shots累计，第2次API调用进行中）
- 首次调用: 24 shots, out=7953 tokens, cost=$0.001144

### 性能基准
- 剧本: ~5 min / 50集
- 分镜: ~1-2 min / 集 (25 shots/call × ~4 calls)

---

## Shot Density Planning System

### 新Agent: `shot_density`
创建 `shot_density_planner.skill.md`，用于预规划镜头密度：
- **公式**: `min=duration×10, recommended=duration×15, max=duration×25`
- **HERO镜头分配**: S级5%, A级15%, B级30%, C级50%
- **场景类型密度**: 动作20-30/min, 对话12-15/min, 情感8-12/min

### Storyboard Agent升级
更新分镜Agent支持密度计算和HERO镜头标记：
- 必须达到指定镜头数量
- 每个镜头标注重要性等级 (S/A/B/C)
- 根据场景类型调整密度

### 千与千寻测试对比

| 版本 | 模型 | 镜头数 | HERO镜 | 耗时 | 成本 |
|------|------|--------|--------|------|------|
| v1 | deepseek-chat | 30 | 7 | ~90s | $0.0006 |
| v2 | deepseek-reasoner | 50 | ~10 | ~4min | $0.0014 |

### DeepSeek模型策略
- **deepseek-chat**: 快速、稳定，适合大规模生成
- **deepseek-reasoner**: 更高质量但慢，适合精品项目
- **max_tokens**: reasoner=64000, chat=8192

### 关键文件
- `skills/shot_density_planner.skill.md` - 密度规划Skill
- `projects/spirited_away/ep01_storyboard_v1.json` - 第一版分镜
- `agents-config.js` line ~275 - shot_density agent配置

### 系统规模
- **42 Agents** (新增shot_density)
- **291 Skills** (新增shot_density_planner)

---

## 霸王别姬 4000镜头 Prompt扩展

### 问题
原有CSV只有tag片段式描述，如 `"CU, 情绪"` - 无法直接用于AI生成

### 解决方案
用DeepSeek扩展每个镜头为完整Prompt：
- **画面描述**: 完整场景描写（100-150字）
- **Image_Prompt**: 结构化图片生成Prompt（英文）
- **Video_Prompt**: Subject + Action + Camera + Scene + Style + Duration

### 批量扩展测试
- 首批400镜头测试: $0.02, ~25分钟
- 输出: `ai_drama_studio_v2/exports/bwbj_400shots_v2.csv`
- 质量优秀，场景细节丰富

### Skill更新 `storyboard_professional_complete.skill.md`
新增Seedance 2.0 Video Prompt格式：
```
Video_Prompt = Subject + Action + Camera Movement + Scene + Style + Constraints + "4 seconds"
```

新增Nano Banana Pro Image Prompt结构：
```
Subject Details + Environment + Lighting + Camera Angle + Style Reference + Negative Prompt
```

新增Negative Prompt标准：
```
--no distorted face, extra fingers, mutated hands, blurry, low quality, watermark, text, deformed limbs
```

新增相机参数快查表（ASL对应镜头+光圈）

---

## GitHub Pages + Vercel部署

### 问题
- GitHub Pages (HTTPS) 无法调用 HTTP 后端 (mixed content policy)
- 原后端 `http://34.58.33.115:3001` 无SSL

### 解决方案：Vercel Proxy
1. Vercel提供免费HTTPS
2. 创建 `vercel.json` + `api/proxy.js` serverless函数
3. 前端改调用 `https://xxx.vercel.app/api/proxy`

### GitHub Pages设置
- Source: `master` branch, `/docs` path
- 构建状态: Build 892781208 building → 需要检查

### 待完成
1. 调查GitHub Pages构建失败原因
2. 用户在Vercel dashboard设置 `DEEPSEEK_API_KEY`
3. 更新前端API_BASE指向Vercel URL
4. 测试完整工作流

### 关键文件
- `docs/` - GitHub Pages静态文件
- `vercel.json` - Vercel配置
- `api/proxy.js` - Serverless代理函数

---

## 技术决策记录

### deepseek-chat vs deepseek-reasoner
**选择 deepseek-chat**：
- reasoner经常返回 "Unexpected end of JSON input" 错误
- chat更稳定，适合批量生成
- 已在 `proxy-server.js` line 30 改为 deepseek-chat

### 镜头密度公式
- 最低: duration × 10 shots/min
- 推荐: duration × 15 shots/min  
- 高质量: duration × 20-25 shots/min

### HERO镜头分配
- S级（视觉震撼）: 5%
- A级（关键转折）: 15%
- B级（情感高潮）: 30%
- C级（常规镜头）: 50%

---

## Vercel部署问题诊断与修复

### 问题诊断
Vercel前端加载正常，但API返回404：
- 根因：远程仓库有 `[agentId].js` 而非 `[...path].js` catch-all
- `[agentId].js` 的 `fixedRoutes` 数组缺少 `tokens`, `projects`, `pipelines`

### 修复方案
创建 `api/[...path].js` catch-all代理：
```javascript
// 代理所有请求到 GCP 后端
const BACKEND = 'http://34.58.33.115:3001';
// 路由: /api/* → http://34.58.33.115:3001/api/*
```

### Git推送阻塞
**GitHub Secret Scanning 检测到 Anthropic API Key**：
- 文件: `workbench/v3/server/.env`
- 需要用 `git filter-branch` 清理历史记录

### 临时解决方案
创建 HTTP 代理服务器 `/tmp/proxy.js`：
- 端口 8080 提供前端静态文件
- 代理 `/api/*` 到后端 3001
- 用 `nohup` 后台运行

### 验证结果
- HTTP fallback: `http://34.58.33.115:8080` ✅ 工作
- Backend direct: `http://34.58.33.115:3001` ✅ 所有端点正常
- Vercel: 等待git历史清理后推送修复

---

## 24集专业项目测试（星城觉醒）

### 测试规模
- 项目名: 星城觉醒
- 集数: 24集
- 每集: 10分钟
- 预估镜头: 24 × 10 × 15 = 3600 镜头

### 测试结果
- 总耗时: ~6分钟
- API响应: 全部成功
- 前端加载: HTTP 200, 0.22秒

### API健康检查
```json
{
  "agents": 42,
  "skills": 291,
  "groups": 10
}
```

---

## 待办事项

### 紧急
- [ ] 完成 `git filter-branch` 清理历史
- [ ] Force push 到 GitHub
- [ ] 验证 Vercel 自动部署新 catch-all 代理

### 后续
- [ ] 霸王别姬剩余3600镜头扩展
- [ ] Moodboard多画风组合功能
- [ ] 清理死代码（7个SKILLS数组重复）
- [ ] 配置 TOGETHER_API_KEY

---

## 角色设计增强

### 新建Skills
1. **`character_image_prompt.skill.md`**: 完整角色Prompt公式（150-200字英文）
   - Face/Hair/Build/Expression/Costume/Silhouette/Mood
   - 参考: Tom Bancroft《Creating Characters with Personality》

2. **`character_design_books.skill.md`**: 10+专业参考书
   - Bancroft角色设计
   - Richard Williams动画技法
   - Mattesi动态力学
   - Framed Ink视觉叙事

3. **`psychology_motivation.skill.md`**: Want/Need/Wound框架
   - 外在欲望(Want) vs 内在需求(Need)
   - 心理创伤(Wound)如何驱动行为

4. **`director_visual_styles.skill.md`**: 20+导演视觉风格Prompt
   - 王家卫、陈凯歌、是枝裕和等

### Agent更新
- `character` agent: 新增 image_prompt + books skills
- `artstyle` agent: 新增 director_visual_styles skill

---

## 服化道 Agent 修复

### 问题
原 `artdirector` agent 输出视觉风格分析，不是实际的服装/场景/道具设计

### 解决方案
创建专门的 `production_design` agent：
- **输出**: JSON格式（服装+场景+道具）
- **Skills**: costume_design, set_design, prop_design
- **Step 7**: 改为调用 `production_design` 而非 `artdirector`

---

## UI改进

### CSS渐变替代Emoji
画风预览从emoji改为CSS渐变色块：
- 更可靠跨平台显示
- 视觉更专业统一

### Pollinations.ai集成
免费测试图片生成（无需API key）：
- 模型: Flux
- 尺寸: 768x512
- URL: `https://image.pollinations.ai/prompt/{prompt}`

### Google Gemini
新增图片分析功能（反推画风）

---

## 系统最终规模

| 指标 | 数量 |
|------|------|
| Agents | 43 |
| Skills | 291 |
| Groups | 10 |
| 专业书籍 | 10+ |

### 专业书籍清单
1. McKee《故事》- 编剧理论
2. Save the Cat《救猫咪》- 15拍结构
3. Hero's Journey 英雄之旅
4. Tom Bancroft《Creating Characters with Personality》
5. Richard Williams《The Animator's Survival Kit》
6. Michael D. Mattesi《Force: Dynamic Life Drawing》
7. Marcos Mateu-Mestre《Framed Ink》
8. James Gurney《Color and Light》
9. 《Film Directing Shot by Shot》- Katz
10. 《Cinematic Storytelling》- Van Sijll

---

## Fizziks 信用系统

### 定价策略
- **100 Fizziks = $1.00 USD**
- 实际API成本 ~$0.07 / 10集项目
- 收费 650⚡ ($6.50) → **99%毛利**

### 每步定价
| 步骤 | Fizziks |
|------|---------|
| 项目结构 | 10⚡ |
| 章节大纲 | 15⚡ |
| 角色设定 | 10⚡ |
| 场景设计 | 10⚡ |
| 正文写作 | 20⚡ |
| **总计** | **65⚡** |

### 工作流改变
- **移除自动运行**: 用户必须手动点击生成每步
- **可编辑**: 每步完成后可修改，再继续下一步
- **确认扣费**: 每次生成前显示价格，用户确认后扣除

---

## 小说向导 (Novel Wizard)

### 5步流程
1. **结构设计** (10⚡) - 整体框架
2. **章节规划** (15⚡) - 分章大纲
3. **角色设定** (10⚡) - 人物卡
4. **场景设计** (10⚡) - 视觉描述
5. **正文写作** (20⚡) - 实际内容

### Skill选择功能
每步可选不同写作技巧：
- 三幕剧结构 / 15拍节奏
- 情感弧线 / 冲突升级
- 感官细节 / 环境氛围

---

## 服化道UI问题

### Bug描述
`renderDesignResult()` 显示原始JSON而非格式化UI

### 数据格式
```json
{
  "costumes": [{
    "character": "角色名",
    "outfits": [{
      "occasion": "场合",
      "description": "描述",
      "colors": ["颜色"],
      "materials": ["材质"],
      "accessories": ["配饰"],
      "ai_prompt": "生成Prompt"
    }]
  }]
}
```

### 修复方向
检测 `result.costumes` 数组，遍历渲染：
- 角色名标题
- 每套服装卡片（场合、描述、配色、材质）
- AI Prompt复制按钮

---

## 待创建：Homepage

### 需求
展示系统专业性的首页：
- 专业书籍列表
- Skills数量（291）
- Agents数量（43）
- 3版本广告文案

### 状态
进行中 - 收集素材阶段

---

## Concept Designer Bug (待修复)

### 错误信息
```json
{"error":"body is not defined"}
```

### 位置
`proxy-server.js` line 322

### 根因
`callOpenAICompatible()` 函数内部访问 `body.useReasoner`，但函数签名只有：
```javascript
function callOpenAICompatible(systemPrompt, userMessage, agentId)
```
`body` 变量未定义。

### 修复方向
1. 传入 `useReasoner` 作为第四个参数
2. 或在调用处传入完整的 `body` 对象
3. 或设置默认值 `const useReasoner = body?.useReasoner ?? false`
